Attribute VB_Name = "Calculs"
Option Explicit
Global DadesExportaCp As String, nomFileTemp As String, JaMirats, FormatExportacio
Sub ActualitzaDependentesClientsFinals()
    Dim sql As String
    Dim codiCFinal As String
    Dim rs As rdoResultset
    Dim rsCCF As rdoResultset
On Error GoTo nor
    'Asocia un id de Cliente final a los trabajadores que no lo tienen
    sql = "Select d.codi "
    sql = sql & "From dependentes d "
    sql = sql & "left join dependentesExtes de on d.codi=de.id and de.nom='CODICFINAL' "
    sql = sql & "where de.valor is null"
    Set rs = Db.OpenResultset(sql)
    codiCFinal = ""
    While Not rs.EOF
        Set rsCCF = Db.OpenResultset("select newid() as id")
    
        codiCFinal = "CliBoti_000_" & rsCCF("id")
        ExecutaComandaSql "insert into dependentesExtes (id, nom, valor) values ('" & rs("codi") & "', 'CODICFINAL', '" & codiCFinal & "')"
    
        rs.MoveNext
    Wend
    
    'Crea los clientes finales
    sql = "select de.valor, d.nom "
    sql = sql & "from dependentes d "
    sql = sql & "left join dependentesExtes de on d.codi=de.id and de.nom='CODICFINAL'"
    sql = sql & "where de.valor not in (select id from clientsfinals)"
    Set rs = Db.OpenResultset(sql)
    While Not rs.EOF
        ExecutaComandaSql "insert into clientsFinals (id, nom) values ('" & rs("valor") & "', '" & rs("nom") & "')"
        ExecutaComandaSql "insert into missatgesAEnviar (tipus, param) values ('ClientsFinals', '" & rs("valor") & "')"
        rs.MoveNext
    Wend
nor:
End Sub

Sub AlertaProducto(email As String, productos As String)
    Dim sql As String
    Dim rs As rdoResultset
    Dim msg As String, producto As String
    Dim emailArr() As String
    Dim e As Integer
    
    msg = "<H2>ALERTA PEDIDO PRODUCTOS</H2>"
    
    '5386 Caja Croissant Ultra (84u)
    sql = "select a.nom ProdNom, c.nom BotNom, quantitatdemanada "
    sql = sql & "from [" & DonamNomTaulaServit(Now) & "] s "
    sql = sql & "left join clients c on s.client=c.codi "
    sql = sql & "left join articles a on s.codiarticle=a.codi "
    sql = sql & "Where codiArticle in (" & productos & ") And quantitatdemanada > 0 "
    sql = sql & "order by a.nom, c.nom"
    Set rs = Db.OpenResultset(sql)
    While Not rs.EOF
        If producto <> rs("ProdNom") Then
            If producto <> "" Then msg = msg & "</TABLE>"
            msg = msg & "<H3>" & rs("ProdNom") & "</H3>"
            msg = msg & "<TABLE BORDER='1' CELLPADDING='0' CELLSPACING='0'>"
            msg = msg & "<TR><TD><B>TIENDA</B></TD><TD><B>CANTIDAD PEDIDA</B></TD></TR>"
            producto = rs("ProdNom")
        End If
        
        msg = msg & "<TR><TD>" & rs("BotNom") & "</TD><TD align='right'>" & rs("quantitatDemanada") & "</TD></TR>"
                    
        rs.MoveNext
    Wend
                    
    msg = msg & "</TABLE>"
    
    emailArr = Split(email, ";")
    For e = 0 To UBound(emailArr)
        sf_enviarMail "", emailArr(e), "Alerta pedido productos " & Format(Now(), "hh:nn dd/mm/yy"), msg, "", ""
    Next
End Sub

Sub AsignacionTurnosDeTrabajo(fecha As Date)
    Dim sql As String
    Dim rsBotigues As rdoResultset, rsEntradas As rdoResultset, rsSalidas As rdoResultset, rsTurnoLibre As rdoResultset, rsTurnoOcupado As rdoResultset, rsEmpleado As rdoResultset, rsOpcionTurnos As rdoResultset
    Dim dia As Integer, mes As Integer, anyo As Integer
    Dim botigaCodi As String, BotigaNom As String, idEmpleado As String, nomEmpleado As String, tipoEmpleado As String
    Dim entrada As Date, salida As Date, periode As String, horaFichaje As Integer
    Dim horasEmp As Integer, horasTurno As Integer, turnosExtra As Integer
    Dim cuerpoEmail As String, msgTurnos As String
    Dim rsContrato As rdoResultset, fContrato As Date, turnoAsignado As Boolean
    
    Dim rsCdA As rdoResultset
    Dim codigoAccion As String
    Dim hayTurnos As Boolean
    
    Dim rsEmail As rdoResultset
    Dim emailCoord As String
    
On Error GoTo nor:

    Informa "AsignacionTurnosDeTrabajo " & Format(fecha, "dd/mm/yyyy"), True
    
    'fecha = Now()
    'fecha = DateAdd("d", -1, fecha)
    dia = Day(fecha)
    mes = Month(fecha)
    anyo = Year(fecha)
    
    '--BOTIGUES PROPIES
    sql = "select c.nom botigaNom, c.Codi as botiga, w.codi as llicencia "
    sql = sql & "from clients c "
    sql = sql & "join paramshw w on c.Codi = w.Valor1 "
    sql = sql & "where c.nif in (select valor from constantsempresa where camp like '%CampNif%' and isnull(valor, '')<>'') "
    sql = sql & "order by nom"
    Set rsBotigues = Db.OpenResultset(sql)
    While Not rsBotigues.EOF
        botigaCodi = rsBotigues("botiga")
        BotigaNom = rsBotigues("botigaNom")
        If UCase(BotigaNom) = "T--109xx" Then 'PROBANDO DE ENVIAR A LA COORDINADORA DE LA TIENDA
            sql = "select df.*, isnull(de2.valor, '') email "
            sql = sql & "from cdpdadesfichador df "
            sql = sql & "left join dependentesExtes de on de.id=df.usuari and de.nom = 'TIPUSTREBALLADOR' "
            sql = sql & "left join dependentesExtes de2 on de2.id=df.usuari and de2.nom = 'EMAIL' "
            sql = sql & "where df.lloc = " & botigaCodi & " and day(tmst)=" & dia & " and month(tmst)=" & mes & " and year(tmst)=" & anyo & " and de.valor='RESPONSABLE' "
            sql = sql & "order by tmst"
            Set rsEmail = Db.OpenResultset(sql)
            emailCoord = ""
            While (Not rsEmail.EOF) And (emailCoord = "")
                emailCoord = rsEmail("email")
                rsEmail.MoveNext
            Wend
            If emailCoord = "" Then emailCoord = "nominas@silemabcn.com"
        ElseIf UCase(EmpresaActual) = UCase("Hitrs") Or UCase(EmpresaActual) = UCase("Pa Natural") Then
            emailCoord = ""
            'emailCoord = "jordi@hit.cat"
            'emailCoord = "ana@hit.cat"
            emailCoord = "administracio@hitsystems.es"
            sql = "select isnull(d.Valor, '') email "
            sql = sql & "from constantsclient cc "
            sql = sql & "left join dependentesextes d on d.nom='EMAIL' and cc.valor=d.id "
            sql = sql & "where cc.codi=" & botigaCodi & " and cc.variable='SupervisoraCodi' "
            Set rsEmail = Db.OpenResultset(sql)
            If Not rsEmail.EOF Then emailCoord = rsEmail("email")

        ElseIf UCase(EmpresaActual) = UCase("Tena") Then
            emailCoord = "nominas@silemabcn.com"
        End If
    'ENTRADAS --------------------------------------------------------------------------------------------------------------
        'FICHADAS DE HOY NO ASIGNADAS A NINGÚN TURNO
        'sql = "select df.*, d.nom depNom, de.valor tipoEmpleado, datepart(hour, tmst)*60+datepart(minute, tmst) horaFichaje "
        'sql = sql & "from cdpdadesfichador df "
        'sql = sql & "left join dependentesExtes de on de.id=df.usuari and de.nom = 'TIPUSTREBALLADOR' "
        'sql = sql & "left join dependentes d on d.codi=df.usuari "
        'sql = sql & "where year(tmst)=" & anyo & " and month(tmst)=" & mes & " and day(tmst)=" & Dia & " and accio=1 and (lloc = " & botigaCodi & " or comentari like '%" & botigaNom & "%') "
        'sql = sql & "and df.usuari not in (select idEmpleado from " & taulaCdpPlanificacion(FECHA) & " p where botiga='" & botigaCodi & "' and day(fecha)=" & Dia & " and idEmpleado is not null and activo=1) "
        'sql = sql & "order by tmst"
        
        sql = "select df.*, p.*, isnull(d.nom, '') depNom, isnull(de.valor, 'DEPENDENTA') tipoEmpleado, datepart(hour, tmst)*60+datepart(minute, tmst) horaFichaje "
        sql = sql & "from cdpdadesfichador df "
        'sql = sql & "left join " & taulaCdpPlanificacion(fecha) & " p on df.usuari=p.idEmpleado and df.tmst=p.fecha "
        sql = sql & "left join " & taulaCdpPlanificacion(fecha) & " p on df.usuari collate Modern_Spanish_CI_AS = p.idEmpleado collate Modern_Spanish_CI_AS and DATEADD(MILLISECOND, -DATEPART(MILLISECOND , df.tmst ) , df.tmst )=p.fecha "
        sql = sql & "left join dependentesExtes de on de.id collate Modern_Spanish_CI_AS = df.usuari collate Modern_Spanish_CI_AS and de.nom = 'TIPUSTREBALLADOR' "
        sql = sql & "left join dependentes d on d.codi=df.usuari "
        sql = sql & "where year(tmst)=" & anyo & " and month(tmst)=" & mes & " and day(tmst)=" & dia & " and accio=1 and (lloc = " & botigaCodi & " or comentari like '%" & BotigaNom & "%') and p.idPlan is null "
        sql = sql & "order by tmst"

        Set rsEntradas = Db.OpenResultset(sql)
        While Not rsEntradas.EOF
            entrada = rsEntradas("tmst")
            idEmpleado = rsEntradas("usuari")
            nomEmpleado = rsEntradas("depNom")
            horaFichaje = rsEntradas("horaFichaje")
            tipoEmpleado = rsEntradas("tipoEmpleado")
            
            'BUSCAMOS UN TURNO LIBRE QUE SE INICIE A +-45 MINUTOS DE LA HORA DE ENTRADA Y QUE SE CORRESPONDA CON EL TIPO DE EMPLEADO
            sql = "select p.idPlan, p.fecha, p.idEmpleado, p.idturno, p.periode, t.nombre Turno, t.horaInicio Hi, t.horaFin, t.idturno Id, t.tipoEmpleado, "
            sql = sql & "cast(substring(t.horaInicio, 1, 2) as int)*60 + cast(substring(t.horaInicio, 4, 2) as int) - " & horaFichaje & " difMins "
            sql = sql & "from " & taulaCdpPlanificacion(fecha) & " p "
            sql = sql & "left join cdpTurnos t on p.idTurno collate Modern_Spanish_CI_AS = t.idTurno collate Modern_Spanish_CI_AS "
            sql = sql & "where p.botiga='" & botigaCodi & "' and p.activo=1 and day(fecha) = " & dia & " and tipoEmpleado like '%" & tipoEmpleado & "%' and idEmpleado is null and "
            sql = sql & "abs(cast(substring(t.horaInicio, 1, 2) as int)*60 + cast(substring(t.horaInicio, 4, 2) as int) - " & horaFichaje & ") <= 45 "
            sql = sql & "order by p.fecha, t.horaInicio, t.nombre"
            Set rsTurnoLibre = Db.OpenResultset(sql)
            If Not rsTurnoLibre.EOF Then
                'LE ASIGNAMOS EL PRIMER TURNO LIBRE QUE ENCONTREMOS
                sql = "update  " & taulaCdpPlanificacion(fecha) & "  Set fecha = convert(datetime, '" & Format(entrada, "dd/mm/yyyy hh:nn:ss") & "', 103), IdEmpleado = " & idEmpleado & ", usuarioModif='SINCRO', fechaModif=getdate() where botiga='" & botigaCodi & "' and  idPlan = '" & rsTurnoLibre("IdPlan") & "' and day(fecha) =  " & Day(fecha)
                ExecutaComandaSql sql
                
                If rsTurnoLibre("difMins") < -5 Then 'ENTRA MÁS DE 5 MINUTOS TARDE
                    'ENVIAMOS EMAIL DE RETRASO
                    cuerpoEmail = "<H2>INCIDENCIA FICHAJE TIENDA " & UCase(BotigaNom) & "<H2>"
                    cuerpoEmail = cuerpoEmail & "<H3>A el trabajador " & UCase(nomEmpleado) & " se le ha asignado el turno " & rsTurnoLibre("Turno") & " (" & rsTurnoLibre("Hi") & " a " & rsTurnoLibre("horaFin") & ")</H2></DD>"
                    cuerpoEmail = cuerpoEmail & "<H3>Tipo de empleado: " & tipoEmpleado & "</H3>"
                    cuerpoEmail = cuerpoEmail & "<H3>Entrada: " & entrada & "</H3>"
                    cuerpoEmail = cuerpoEmail & "<H3>RETRASO: " & Abs(rsTurnoLibre("difMins")) & " m</H3>"
        
                    If emailCoord <> "" Then sf_enviarMail "secrehit@hit.cat", emailCoord, "AVISO RETRASO TIENDA " & UCase(BotigaNom), cuerpoEmail, "", ""
                    'If UCase(EmpresaActual) <> UCase("tena") Then sf_enviarMail "secrehit@hit.cat", "ana@solucionesit365.com", "AVISO RETRASO TIENDA " & UCase(BotigaNom), cuerpoEmail, "", ""
                
                End If
            Else
                'SI NO HAY TURNO LIBRE REVISAMOS QUE NO LO HAYA OCUPADO UN APRENDIZ
                Set rsContrato = Db.OpenResultset("select top 1 * From dependentesextes where nom like 'DATACONTRACTEINI%' and id=" & idEmpleado & " order by nom desc")
                If Not rsContrato.EOF Then
                    fContrato = CDate(rsContrato("valor"))
                
                    If DateDiff("d", fContrato, Now()) <= 10 Then
                        sql = "select p.idPlan, p.fecha, p.idEmpleado, p.idturno, p.periode, t.nombre Turno, t.horaInicio Hi, t.horaFin, t.idturno Id, t.tipoEmpleado, "
                        sql = sql & "cast(substring(t.horaInicio, 1, 2) as int)*60 + cast(substring(t.horaInicio, 4, 2) as int) - " & horaFichaje & " difMins "
                        sql = sql & "from " & taulaCdpPlanificacion(fecha) & " p "
                        sql = sql & "left join cdpTurnos t on p.idTurno = t.idTurno "
                        sql = sql & "where p.botiga='" & botigaCodi & "' and p.activo=1 and day(fecha) = " & dia & " and tipoEmpleado like '%" & tipoEmpleado & "%' and idEmpleado is not null and "
                        sql = sql & "abs(cast(substring(t.horaInicio, 1, 2) as int)*60 + cast(substring(t.horaInicio, 4, 2) as int) - " & horaFichaje & ") <= 45 "
                        sql = sql & "order by p.fecha, t.horaInicio, t.nombre"
                        Set rsTurnoOcupado = Db.OpenResultset(sql)
                        If Not rsTurnoOcupado.EOF Then
                            turnoAsignado = False
                            While Not rsTurnoOcupado.EOF And Not turnoAsignado
                                Set rsContrato = Db.OpenResultset("select top 1 * From dependentesExtes where nom like 'DATACONTRACTEINI%' and id=" & rsTurnoOcupado("idEmpleado") & " order by nom desc")
                                If Not rsContrato.EOF Then
                                    If fContrato < CDate(rsContrato("valor")) Then 'EL EMPLEADO QUE ESTÁ FICHANDO TIENE MÁS ANTIGUEDAD QUE EL QUE TIENE EL TURNO ASIGNADO
                                        'LE PONEMOS UN TURNO INVENTADO AL SUPUESTO "APRENDIZ"
                                        AsignaTurnoInventado fecha, botigaCodi, CDate(rsTurnoOcupado("fecha")), rsTurnoOcupado("idEmpleado")
                                    
                                        'LE ASIGNAMOS EL TURNO AL EMPLEADO CON MÁS ANTIGUEDAD
                                        sql = "update " & taulaCdpPlanificacion(fecha) & " set idEmpleado=" & idEmpleado & ", fecha=convert(datetime, '" & Format(entrada, "dd/mm/yyyy hh:nn:ss") & "', 103), fechaModif=getdate(), usuarioModif='SINCRO_CT' where IdPlan='" & rsTurnoOcupado("IdPlan") & "'"
                                        ExecutaComandaSql sql
                                        
                                        'sf_enviarMail "secrehit@hit.cat", "ana@solucionesit365.com", "TURNOS INTERCAMBIADOS " & botigaNom, "FECHA :" & fecha & "<br>Empleado" & idEmpleado & " Aprendiz " & rsTurnoOcupado("idEmpleado"), "", ""
                                        turnoAsignado = True
                                        
                                    End If
                                End If
                                
                                rsTurnoOcupado.MoveNext
                            Wend
                            rsTurnoOcupado.Close
                            
                            If Not turnoAsignado Then 'SI NO LE HEMOS ENCONTRADO NINGÚN TURNO LE AÑADIMOS UNO INVENTADO
                                AsignaTurnoInventado fecha, botigaCodi, entrada, idEmpleado
                            End If
                        Else 'NO HAY TURNOS QUE ENCAJEN CON EL FICHAJE
                            AsignaTurnoInventado fecha, botigaCodi, entrada, idEmpleado
                        End If
                    Else 'EL CONTRATO ES DE MÁS DE 10 DIAS
                        AsignaTurnoInventado fecha, botigaCodi, entrada, idEmpleado
                    End If
                        
                Else 'NO HAY FECHA DE CONTRATO
                    AsignaTurnoInventado fecha, botigaCodi, entrada, idEmpleado
                    
                    'sf_enviarMail "secrehit@hit.cat", "ana@solucionesit365.com", "EMPLEADO SIN CONTRATO", "EMPLEADO SIN CONTRATO " & idEmpleado, "", ""
                End If
            End If
            rsEntradas.MoveNext
        Wend
        rsEntradas.Close
        
    'SALIDAS ---------------------------------------------------------------------------------------------------------------
        sql = "select df.idr, df.tmst, df.usuari, datepart(hour, tmst)*60+datepart(minute, tmst) horaFichaje, cast(substring(t.horaFin, 1, 2) as int)*60 + cast(substring(t.horaFin, 4, 2) as int) horaFin, "
        sql = sql & "(datepart(hour, tmst)*60+datepart(minute, tmst))-( cast(substring(t.horaFin, 1, 2) as int)*60 + cast(substring(t.horaFin, 4, 2) as int)) difHoras, p.idPlan,  isnull(p.idTurno, '') idTurno, "
        sql = sql & "isnull(de.valor, '') tipoEmpleado, t.horaInicio, t.horaFin as hFin, isnull(d.nom, isnull(dz.nom, '')) depNom, t.nombre nombreTurno "
        sql = sql & "from cdpdadesfichador df "
        sql = sql & "left join " & taulaCdpPlanificacion(fecha) & " p on df.usuari collate Modern_Spanish_CI_AS = p.idEmpleado collate Modern_Spanish_CI_AS " ' and df.tmst=p.fecha "
        sql = sql & "left join cdpTurnos t on p.idTurno collate Modern_Spanish_CI_AS = t.idTurno collate Modern_Spanish_CI_AS "
        sql = sql & "left join dependentes d on d.codi = df.usuari "
        sql = sql & "left join dependentes_zombis dz on dz.codi = df.usuari "
        sql = sql & "left join dependentesExtes de on de.id collate Modern_Spanish_CI_AS = df.usuari collate Modern_Spanish_CI_AS and de.nom = 'TIPUSTREBALLADOR' "
        sql = sql & "Where p.activo=1 and Df.Id = 0 And Year(Df.tmst) = " & anyo & " And Month(Df.tmst) = " & mes & " And Day(Df.tmst) = " & dia & " And Df.Accio = 2 And (Df.Lloc = " & botigaCodi & " or comentari like '%" & BotigaNom & "%') And Day(p.fecha) = " & dia & " And p.botiga = " & botigaCodi & " "
        sql = sql & "and p.fecha < df.tmst and datediff(hour, p.fecha, df.tmst)<12 "
        sql = sql & "order by tmst"
'        If botigaCodi = 660 Then
'        sql = sql
'        End If
        Set rsSalidas = Db.OpenResultset(sql)
        While Not rsSalidas.EOF
            nomEmpleado = rsSalidas("depNom")
            idEmpleado = rsSalidas("usuari")
            salida = rsSalidas("tmst")
            tipoEmpleado = rsSalidas("tipoEmpleado")
        
            Set rsEntradas = Db.OpenResultset("select top 1 * from cdpdadesfichador where usuari=" & idEmpleado & " and tmst< '" & rsSalidas("tmst") & "' and accio=1 order by tmst desc")
            If Not rsEntradas.EOF Then entrada = rsEntradas("tmst")
            
            'TIENE TURNO ASIGNADO A LA ENTRADA PERO NO CUADRA CON LA SALIDA     O  NO TIENE TURNO ASIGNADO
            'SI SALE HASTA 45 MINUTOS MÁS TARDE, LO DEJAMOS COMO ESTÁ
            'QUE HACEMOS SI SALE HASTA 15 MINUTOS ANTES?????? --> ENVIAMOS EMAIL
            If (rsSalidas("idTurno") <> "" And (rsSalidas("difHoras") > 45 Or rsSalidas("difHoras") < -15)) Or rsSalidas("idTurno") = "" Then
            
                periode = "M"
                If Hour(entrada) > 12 Then periode = "T"
                
                horasEmp = DateDiff("n", entrada, salida) \ 60
                If DateDiff("n", entrada, salida) Mod 60 > 40 Then horasEmp = horasEmp + 1
                
                If horasEmp < 12 Then
                    If horasEmp < 1 Then 'A VECES ENTRAN Y SALEN EN MINUTOS Y OCUPAN UN TURNO EN LA ENTRADA QUE NO LES CORRESPONDE
                        'LIBERAMOS EL TURNO
                        If rsSalidas("idTurno") <> "" Then
                            ExecutaComandaSql "update " & taulaCdpPlanificacion(fecha) & " set fecha = convert(datetime, '" & Format(entrada, "dd/mm/yyyy hh:nn:ss") & "', 103), idEmpleado = null, fechaModif=getdate(), usuarioModif='SINCRO' where idPlan = '" & rsSalidas("idPlan") & "'"
                            'LE ASIGNAMOS UN TURNO NULO
                            ExecutaComandaSql "insert into " & taulaCdpPlanificacion(fecha) & " (IdPlan, fecha, botiga, periode, idTurno, idEmpleado, usuarioModif, fechaModif, activo) values (newid(), convert(datetime, '" & Format(entrada, "dd/mm/yyyy hh:nn:ss") & "', 103), '" & botigaCodi & "', '" & periode & "', null, '" & idEmpleado & "', 'SINCRO', getdate(), 1)"
                        End If
                    Else
                        
                        If rsSalidas("idTurno") <> "" Then 'SI NO ENCAJA CON EL TURNO ASIGNADO A LA ENTRADA, LIBERAMOS EL TURNO Y ENVIAMOS EMAIL
                            ExecutaComandaSql "update " & taulaCdpPlanificacion(fecha) & " set fecha = convert(datetime, '" & Format(entrada, "dd/mm/yyyy hh:nn:ss") & "', 103), idEmpleado = null, fechaModif=getdate(), usuarioModif='SINCRO' where idPlan = '" & rsSalidas("idPlan") & "'"
                            'LE ASIGNAMOS UN TURNO NULO
                            ExecutaComandaSql "insert into " & taulaCdpPlanificacion(fecha) & " (IdPlan, fecha, botiga, periode, idTurno, idEmpleado, usuarioModif, fechaModif, activo) values (newid(), convert(datetime, '" & Format(entrada, "dd/mm/yyyy hh:nn:ss") & "', 103), '" & botigaCodi & "', '" & periode & "', null, '" & idEmpleado & "', 'SINCRO', getdate(), 1)"
                        Else 'SI NO TIENE TURNO ASIGNADO MIRAMOS SI ES APRENDIZ
                            Set rsContrato = Db.OpenResultset("select top 1 * From dependentesextes where nom like 'DATACONTRACTEINI%' and id=" & idEmpleado & " order by nom desc")
                            If Not rsContrato.EOF Then
                                fContrato = CDate(rsContrato("valor"))
                            
                                If DateDiff("d", fContrato, Now()) <= 7 Then 'ES APRENDIZ
                                    'BORRAMOS EL TURNO "SIN CONFIGURAR" QUE TIENE ASIGNADO
                                    ExecutaComandaSql "delete from " & taulaCdpPlanificacion(entrada) & " where idTurno is null and idEmpleado='" & idEmpleado & "' and botiga=" & botigaCodi & " and day(fecha)=" & Day(entrada)
                                
                                    'LE ASIGNAMOS TURNO DE APRENDIZ
                                    ExecutaComandaSql "insert into " & taulaCdpPlanificacion(fecha) & " (IdPlan, fecha, botiga, periode, idTurno, idEmpleado, usuarioModif, fechaModif, activo) values (newid(), convert(datetime, '" & Format(entrada, "dd/mm/yyyy hh:nn:ss") & "', 103), '" & botigaCodi & "', '" & periode & "', '" & horasEmp & "_Aprendiz', '" & idEmpleado & "', 'SINCRO', getdate(), 1)"
                                    
                                    GoTo salidaRevisada
                                End If
                            End If
                        End If
                    
                        msgTurnos = ""
            
                        hayTurnos = False
                        msgTurnos = msgTurnos & "<H4>Escribe OK en la casilla del turno que le correponde al empleado</H4>"
                        sql = "SELECT isnull(d.nom, '') turnoOcupado, t.*, p.* "
                        sql = sql & "FROM " & taulaCdpPlanificacion(fecha) & " p "
                        sql = sql & "left join cdpTurnos t on p.idTurno collate Modern_Spanish_CI_AS = t.idTurno collate Modern_Spanish_CI_AS "
                        sql = sql & "left join dependentes d on p.idEmpleado = d.codi "
                        sql = sql & "where p.activo=1 and p.botiga=" & botigaCodi & " and day(p.fecha)=" & dia & " and tipoEmpleado like '%" & tipoEmpleado & "%' and t.idturno is not null "
                        sql = sql & "and p.periode='" & periode & "' "
                        'sql = sql & "and abs(cast(substring(t.horaFin, 1, 2) as int)*60 + cast(substring(t.horaFin, 4, 2) as int)-" & rsSalidas("horaFichaje") & ") <= 30 "
                        'sql = sql & "and t.horaInicio = '" & rsSalidas("horaInicio") & "' "
                        sql = sql & "order by t.horaInicio "
                        Set rsOpcionTurnos = Db.OpenResultset(sql)
                        
                        If rsOpcionTurnos.EOF Then
                            msgTurnos = msgTurnos & "<DD>NO HAY TURNOS CONFIGURADOS PARA " & UCase(tipoEmpleado) & "</DD><BR>"
                        Else
                            hayTurnos = True
                            msgTurnos = msgTurnos & "<DD><TABLE name='Turnos_Plan' BORDER='0'>"
                        End If
            
                        While Not rsOpcionTurnos.EOF
                            horasTurno = DateDiff("n", rsOpcionTurnos("horaInicio"), rsOpcionTurnos("horaFin")) \ 60
                            turnosExtra = horasEmp - horasTurno
                            'If turnosExtra < 0 Then turnosExtra = 0
                            msgTurnos = msgTurnos & "<TR>"
                            If rsOpcionTurnos("turnoOcupado") <> "" Then 'TURNO OCUPADO
                                msgTurnos = msgTurnos & "<TD COLSPAN='2' nowrap>" & rsOpcionTurnos("nombre") & " (" & rsOpcionTurnos("horaInicio") & " a " & rsOpcionTurnos("horaFin") & ") " & rsOpcionTurnos("turnoOcupado") & " </TD>"
                            Else 'TURNO LIBRE
                                msgTurnos = msgTurnos & "<TD width='250' nowrap><B>" & rsOpcionTurnos("nombre") & " (" & rsOpcionTurnos("horaInicio") & " a " & rsOpcionTurnos("horaFin") & ") </B></TD><TD><TABLE border='0'><TR><TD style='border: 1px solid black;' width='30'></TD><INPUT type='HIDDEN' name='T_" & rsOpcionTurnos("idTurno") & "'><TD style='border: 1px solid black;' width='30' name='T_Extra'>" & turnosExtra & "</TD></TR></TABLE></TD>"
                                'SI NO LE HEMOS PODIDO ASIGNAR TURNO O NO ENCAJA EN SU TURNO DE ENTRADA, MIRAMOS A VER SI ENCAJA EN ALGUNO POR NÚMERO DE HORAS CON UN MARGEN DE ENTRADA DE +- 2 HORAS
                                'If rsSalidas("idTurno") = "" And turnosExtra = 0 Then
                                If turnosExtra = 0 Then
                                    'MIRAMOS SI LA HORA DE ENTRADA DEL USUARIO SE ACERCA A LA HORA DE INICIO DEL TURNO EN +-2 HORAS
                                    If Abs(DateDiff("h", entrada, CDate(Day(entrada) & "/" & Month(entrada) & "/" & Year(entrada) & " " & rsOpcionTurnos("horaInicio")))) <= 2 Then
                                        sql = "update  " & taulaCdpPlanificacion(fecha) & "  Set fecha = convert(datetime, '" & Format(entrada, "dd/mm/yyyy hh:nn:ss") & "', 103), IdEmpleado = " & idEmpleado & ", usuarioModif='SINCRO', fechaModif=getdate() where botiga='" & botigaCodi & "' and  idPlan = '" & rsOpcionTurnos("IdPlan") & "' and day(fecha) =  " & Day(fecha)
                                        ExecutaComandaSql sql
                                        'ELIMINAR EL TURNO NULO
                                        sql = "delete from  " & taulaCdpPlanificacion(fecha) & " where fecha = convert(datetime, '" & Format(entrada, "dd/mm/yyyy hh:nn:ss") & "', 103) and IdEmpleado = " & idEmpleado & " and botiga='" & botigaCodi & "' and idTurno is null"
                                        ExecutaComandaSql sql
                                        
                                        If emailCoord <> "" Then sf_enviarMail "", emailCoord, "TURNO ENCAJADO TIENDA " & BotigaNom, "<H3>Tienda " & BotigaNom & "</H3><H3>" & nomEmpleado & "</H3><H3>Entrada: " & Format(entrada, "dd/mm/yyyy hh:nn:ss") & "</H3><H3>Salida: " & Format(salida, "dd/mm/yyyy hh:nn:ss") & "</H3><H3>Turno asignado: " & rsOpcionTurnos("nombre") & " (" & rsOpcionTurnos("horaInicio") & " a " & rsOpcionTurnos("horaFin") & ") ", "", ""
                                        'If UCase(EmpresaActual) <> UCase("tena") Then sf_enviarMail "", "ana@solucionesit365.com", "TURNO ENCAJADO TIENDA " & BotigaNom, "<H3>Tienda " & BotigaNom & "</H3><H3>" & nomEmpleado & "</H3><H3>Entrada: " & Format(entrada, "dd/mm/yyyy hh:nn:ss") & "</H3><H3>Salida: " & Format(salida, "dd/mm/yyyy hh:nn:ss") & "</H3><H3>Turno asignado: " & rsOpcionTurnos("nombre") & " (" & rsOpcionTurnos("horaInicio") & " a " & rsOpcionTurnos("horaFin") & ") ", "", ""
                                        
                                        GoTo salidaRevisada
                                    End If
                                End If
                            End If
                            msgTurnos = msgTurnos & "</TR>"
                            
                            rsOpcionTurnos.MoveNext
                        Wend
                        If hayTurnos Then msgTurnos = msgTurnos & "</TABLE></DD><BR>"
                        rsOpcionTurnos.Close
                                                
                        'OTRO TURNO
                        If UCase(EmpresaActual) <> "TENA" Then
                            msgTurnos = msgTurnos & "<H4>OTRO TURNO</H4>"
                            msgTurnos = msgTurnos & "<DD><TABLE BORDER='0'><TR><TD>Hora de entrada</TD><TD style='border: 1px solid black;' width='30' name='EntradaNuevo'></TD><TD>Hora de salida</TD><TD style='border: 1px solid black;' width='30' name='SalidaNuevo'></TD></TR></TABLE></DD>"
                        End If
                        
                        'TURNOS EXTRA
                        'If rsSalidas("difHoras") > 0 Then 'SALE MÁS TARDE DE LO QUE LE CORRESPONDE AL TURNO ASIGNADO, PUEDE SER HORA EXTRA
                        msgTurnos = msgTurnos & "<H4>EXTRA</H4>"
                        msgTurnos = msgTurnos & "<DD><TABLE BORDER='0'><TR><TD>Escribe aquí el número de horas extra</TD><TD style='border: 1px solid black;' width='30' name='HorasExtra'></TD></TR></TABLE></DD>"
                        'End If
                        
                        'TURNOS APRENDIZ
                        msgTurnos = msgTurnos & "<H4>APRENDIZ</H4>"
                        msgTurnos = msgTurnos & "<DD><TABLE BORDER='0'><TR><TD>Escribe aquí el número de horas de aprendiz</TD><TD style='border: 1px solid black;' width='30' name='HorasAprendiz'></TD></TR></TABLE></DD>"
                        
                        'TURNOS COORDINACION
                        msgTurnos = msgTurnos & "<H4>COORDINACIÓN</H4>"
                        msgTurnos = msgTurnos & "<DD><TABLE BORDER='0'><TR><TD>Escribe aquí el número de horas de coordinación</TD><TD style='border: 1px solid black;' width='30' name='HorasCoordinacion'></TD></TR></TABLE></DD>"
                        
                        
                        'ENVIAR EMAIL DE INCIDENCIA
                        Set rsCdA = Db.OpenResultset("select newid() id")
                        codigoAccion = rsCdA("id")
                        
                        ExecutaComandaSql "Insert into " & taulaCodigosDeAccion() & " (IdCodigo, TipoCodigo, TmStmp, Param1, Param2, Param3, Param4) values ('" & codigoAccion & "', 'FICHAJE', getdate(), '" & botigaCodi & "', '" & idEmpleado & "', '" & entrada & "', '" & salida & "')"
                        
                        cuerpoEmail = "<font size=1>CODIGO_ACCION:[" & codigoAccion & "]</font><br>"
                        cuerpoEmail = cuerpoEmail & "<H2>INCIDENCIA FICHAJE TIENDA " & UCase(BotigaNom) & "<H2>"
                        If rsSalidas("idTurno") <> "" Then
                            cuerpoEmail = cuerpoEmail & "<H3>El trabajador " & UCase(nomEmpleado) & " no encaja en el turno asignado en la entrada:</H3><H2><DD>" & rsSalidas("nombreTurno") & " (" & rsSalidas("horaInicio") & " a " & rsSalidas("hFin") & ")</H2></DD>"
                        Else
                            cuerpoEmail = cuerpoEmail & "<H3>El trabajador " & UCase(nomEmpleado) & " no tiene turno de entrada asignado</H3>"
                        End If
                        cuerpoEmail = cuerpoEmail & "<H3>Tipo de empleado: " & tipoEmpleado & "</H3>"
                        cuerpoEmail = cuerpoEmail & "<H3>Entrada: " & entrada & "</H3>"
                        cuerpoEmail = cuerpoEmail & "<H3>Salida: " & salida & "</H3>"
                        cuerpoEmail = cuerpoEmail & "<H3>Horas: " & DateDiff("n", entrada, salida) \ 60 & " h " & DateDiff("n", entrada, salida) Mod 60 & " min</H3>"
                        cuerpoEmail = cuerpoEmail & "<BR>"
                        cuerpoEmail = cuerpoEmail & msgTurnos
                        
                        Dim rsTmp As rdoResultset
                        If UCase(EmpresaActual) = UCase("tena") Then
                            Set rsTmp = Db.OpenResultset("select * from " & taulaCdpPlanificacion(fecha) & " where idturno is not null and botiga=" & botigaCodi)
                            If Not rsTmp.EOF Then
                                If emailCoord <> "" Then sf_enviarMail "secrehit@hit.cat", emailCoord, "INCIDENCIA FICHAJE TIENDA " & UCase(BotigaNom) & "   " & codigoAccion, cuerpoEmail, "", ""
                            End If
                        Else
                            If emailCoord <> "" Then sf_enviarMail "secrehit@hit.cat", emailCoord, "INCIDENCIA FICHAJE TIENDA " & UCase(BotigaNom) & "   " & codigoAccion, cuerpoEmail, "", ""
                            'sf_enviarMail "secrehit@hit.cat", "ana@solucionesit365.com", "INCIDENCIA FICHAJE TIENDA " & UCase(BotigaNom) & "   " & entrada, cuerpoEmail, "", ""
                        End If
                    End If
                End If
            Else 'TIENE TURNO BIEN ASIGNADO
                Set rsContrato = Db.OpenResultset("select top 1 * From dependentesextes where nom like 'DATACONTRACTEINI%' and id=" & idEmpleado & " order by nom desc")
                If Not rsContrato.EOF Then
                    fContrato = CDate(rsContrato("valor"))
                            
                    If DateDiff("d", fContrato, Now()) <= 7 Then 'ES APRENDIZ
                        cuerpoEmail = "<H2>TURNO ASIGNADO A APRENDIZ " & UCase(BotigaNom) & "<H2>"
                        cuerpoEmail = cuerpoEmail & "<H3>A el trabajador " & UCase(nomEmpleado) & " se le ha asignado el turno:</H3><H2><DD>" & rsSalidas("nombreTurno") & " (" & rsSalidas("horaInicio") & " a " & rsSalidas("hFin") & ")</H2></DD>"
                        cuerpoEmail = cuerpoEmail & "<H3>Tipo de empleado: " & tipoEmpleado & "</H3>"
                        cuerpoEmail = cuerpoEmail & "<H3>Entrada: " & entrada & "</H3>"
                        cuerpoEmail = cuerpoEmail & "<H3>Salida: " & salida & "</H3>"
                        cuerpoEmail = cuerpoEmail & "<H3>Horas: " & DateDiff("n", entrada, salida) \ 60 & " h " & DateDiff("n", entrada, salida) Mod 60 & " min</H3>"
                    
                        If emailCoord <> "" Then sf_enviarMail "secrehit@hit.cat", emailCoord, "TURNO ASIGNADO A APRENDIZ " & BotigaNom, cuerpoEmail, "", ""
                        'If UCase(EmpresaActual) <> UCase("tena") Then sf_enviarMail "secrehit@hit.cat", "ana@solucionesit365.com", "TURNO ASIGNADO A APRENDIZ " & BotigaNom, cuerpoEmail, "", ""
                    End If
                End If
            End If
            
salidaRevisada:
            'SALIDA REVISADA
            ExecutaComandaSql "Update cdpDadesFichador set id=1 where idr='" & rsSalidas("idr") & "'"
            rsSalidas.MoveNext
        Wend
        rsSalidas.Close
    
        rsBotigues.MoveNext
    Wend
    rsBotigues.Close
    
    Exit Sub
    
nor:

    sf_enviarMail "", "ana@solucionesit365.com", "ERROR AsignacionTurnosDeTrabajo: ", sql & err.Description, "", ""
End Sub

Sub AsignaTurnoInventado(fecha As Date, botigaCodi As String, entrada As Date, idEmpleado As String)
    Dim periode As String
    
    periode = "M"
    If Hour(entrada) > 12 Then periode = "T"
    ExecutaComandaSql "insert into " & taulaCdpPlanificacion(fecha) & " (IdPlan, fecha, botiga, periode, idTurno, idEmpleado, usuarioModif, fechaModif, activo) values (newid(), convert(datetime, '" & Format(entrada, "dd/mm/yyyy hh:nn:ss") & "', 103), '" & botigaCodi & "', '" & periode & "', null, '" & idEmpleado & "', 'SINCRO', getdate(), 1)"

End Sub


Sub AutorizaFactura(codigoDeAccion As String)
    Dim rsCdA As rdoResultset
    Dim idFactura As String, dataFactura As Date
    Dim email As String
    
On Error GoTo nor
    Set rsCdA = Db.OpenResultset("select isnull(param1, '') param1, isnull(param2, '') param2, isnull(param10, '') param10 from  " & taulaCodigosDeAccion() & " where idCodigo = '" & codigoDeAccion & "'")
    If Not rsCdA.EOF Then
        idFactura = rsCdA("param1")
        dataFactura = CDate(rsCdA("param2"))
        email = rsCdA("param10")
        
        ExecutaComandaSql "insert into " & tablaFacturaProformaAuto(dataFactura) & " (IdFactura, Data, Usuari, Comentari, Autorizada) values ('" & idFactura & "', '" & dataFactura & "', '" & email & "', '', 1)"

    End If
    Exit Sub
nor:
    sf_enviarMail "secrehit@hit.cat", "ana@solucionesit365.com", "ERROR AutorizaFactura", err.Description, "", ""

End Sub

Sub AvisosTelegram()
    Dim rsAvisos As rdoResultset, rsInc As rdoResultset, rsInc3 As rdoResultset
    Dim URL As String, sql As String, r
    Dim resposta As String, Min
    Dim nAvisos As Integer
    
    InformaMiss "AVISOS TELEGRAM", True
    
On Error GoTo err:
    
    nAvisos = 0
    
    'Si el tipo es incidencies y LLiure3 = Totes, me mandas todas las incidencias de la tabla para una fecha mas reciente a LLiure5.
    'Si lliure5 esta vacio lo pones a getdate y mandas un mensaje con el texto : A partir de ahora te avisare de las incidencias
    Set rsAvisos = Db.OpenResultset("select * from SecreAvisos where tipus='Incidencies' and lliure3='Totes'")
    While Not rsAvisos.EOF
        If rsAvisos("LLiure5") = "" Then
            URL = "https://api.telegram.org/bot" & rsAvisos("lliure1") & "/sendMessage?chat_id=" & rsAvisos("lliure2") & "&text=A partir de ahora te avisare de las incidencias"
            r = llegeigHtml(URL)
            ExecutaComandaSql "update SecreAvisos set lliure5=getdate() where id='" & rsAvisos("id") & "'"
        Else
            Set rsInc = Db.OpenResultset("select * from incidencias i where tecnico=" & rsAvisos("usuari") & " and estado in ('Pendiente', 'Curso') and (select max(timestamp) from inc_historico where id=i.id)>='" & Format(rsAvisos("LLiure5"), "dd/mm/yyyy hh:nn:ss") & "'")
            While Not rsInc.EOF
                nAvisos = nAvisos + 1
                URL = "https://api.telegram.org/bot" & rsAvisos("lliure1") & "/sendMessage?chat_id=" & rsAvisos("lliure2") & "&text=Incidencia (" & Left(rsInc("incidencia"), 15) & ")"
                r = llegeigHtml(URL)
                rsInc.MoveNext
            Wend
            If nAvisos > 0 Then ExecutaComandaSql "update SecreAvisos set lliure5=getdate() where id='" & rsAvisos("id") & "'"
        End If
        rsAvisos.MoveNext
    Wend
    
    Set rsAvisos = Db.OpenResultset("select * from SecreAvisos where tipus='Impresoras' and lliure3='LesMeves'")
    While Not rsAvisos.EOF
        If rsAvisos("LLiure5") = "" Then
            URL = "https://api.telegram.org/bot" & rsAvisos("lliure1") & "/sendMessage?chat_id=" & rsAvisos("lliure2") & "&text=A partir de ahora te avisare de las incidencias"
            r = llegeigHtml(URL)
            ExecutaComandaSql "update SecreAvisos set lliure5=getdate() where id='" & rsAvisos("id") & "'"
        Else
            ExecutaComandaSql "delete SecreAvisosTxt  where not day([TimeStamp]) = day(getdate()) "
            sql = "Insert into SecreAvisosTxt  (id,avisat,Tipus,[TimeStamp],Usuari,Lliure1,Lliure2) "
            sql = sql + "select cast(r.TimeStamp as nvarchar) + r.Concepte,'No','ImpresoraBotoNoApretat' ,  getdate() ,usuari,c.codi ,r.[Timestamp] "
            sql = sql + "from  (Select * from SecreAvisos s where tipus='Impresoras' and lliure3='LesMeves' and usuari = " & rsAvisos("Usuari") & ") s join (Select valor,cast(codi as nvarchar) Codi from constantsclient where variable = 'SupervisoraCodi' ) c on c.valor = s.usuari join records r on r.Concepte = 'ImpresionBocadillosBotoPulsat' + c.codi "
            sql = sql + "Where cast(r.TimeStamp as nvarchar) + r.Concepte not in(select id from SecreAvisosTxt)  and DateDiff(Minute, r.[TimeStamp], GetDate()) > 90 "
            ExecutaComandaSql sql
            
            sql = "update SecreAvisosTxt set avisat='No' , Tipus='ImpresoraBotoPerFiApretat' "
            sql = sql + "from SecreAvisosTxt t join records r  on r.Concepte = 'ImpresionBocadillosBotoPulsat' + t.lliure1 and datediff(minute,r.[Timestamp],t.TimeStamp) <0 "
            ExecutaComandaSql sql
            
            Set rsInc = Db.OpenResultset("Select * from SecreAvisosTxt Where Usuari = " & rsAvisos("Usuari") & " And avisat='No' ")
            While Not rsInc.EOF
                nAvisos = nAvisos + 1
                resposta = "Bocadillos " & BotigaCodiNom(rsInc("lliure1")) & " "
                If rsInc("Tipus") = "ImpresoraBotoNoApretat" Then resposta = resposta & "No apreta Boto desde  " & Format(CVDate(rsInc("lliure2")), "hh:nn")
                If rsInc("Tipus") = "ImpresoraBotoPerFiApretat" Then
                    Set rsInc3 = Db.OpenResultset("select isnull(datediff(minute, rr.timestamp,r.timestamp ),0)  from records r left join Records rr on rr.concepte = 'ImpresionBocadillosBotoPenultimPulsat' + cast(338 as nvarchar) where r.concepte = 'ImpresionBocadillosBotoPulsat' + cast(338 as nvarchar)")
                    Min = 0
                    If Not rsInc3.EOF Then Min = rsInc3(0)
                    resposta = resposta & " Boto Apretat ! ha trigat " & Min & " Minuts"
                End If
                    
                resposta = resposta & "Ok !!"
                
                URL = "https://api.telegram.org/bot" & rsAvisos("lliure1") & "/sendMessage?chat_id=" & rsAvisos("lliure2") & "&text=" & resposta
                r = llegeigHtml(URL)
                If (rsAvisos("lliure2") <> "911219941") Then
                    URL = "https://api.telegram.org/bot1099392088:AAHAIotx7-7xwDSulYCCWVAByBI6r907Irg/sendMessage?chat_id=911219941&text=Avisat a " & DependentaCodiNom(rsAvisos("Usuari")) & " " & resposta
                    resposta = llegeigHtml(URL)
                End If
                
                If rsInc("Tipus") = "ImpresoraBotoPerFiApretat" Then
                    ExecutaComandaSql "Delete SecreAvisosTxt Where id='" & rsInc("id") & "'"
                Else
                    ExecutaComandaSql "update SecreAvisosTxt set Avisat = 'Si' where id='" & rsInc("id") & "'"
                End If
                rsInc.MoveNext
            Wend
            If nAvisos > 0 Then ExecutaComandaSql "update SecreAvisos set lliure5=getdate() where id='" & rsAvisos("id") & "'"
        End If
        rsAvisos.MoveNext
    Wend
            
            
    Set rsInc = Db.OpenResultset("Select top 5 * from SecreAvisosTxt Where Tipus = 'TelegramJordi' And avisat='No' ")
    While Not rsInc.EOF
        resposta = "En " & BotigaCodiNom(rsInc("lliure2")) & " De " & ArticleCodiNom(rsInc("lliure3")) & " " & rsInc("Lliure1") & " " & (-1 * rsInc("lliure4")) & " Unitats"
        URL = "https://api.telegram.org/bot1099392088:AAHAIotx7-7xwDSulYCCWVAByBI6r907Irg/sendMessage?chat_id=911219941&text=" & resposta
        resposta = llegeigHtml(URL)
        ExecutaComandaSql "Delete SecreAvisosTxt Where id='" & rsInc("id") & "'"
        rsInc.MoveNext
    Wend
    ExecutaComandaSql "Delete SecreAvisosTxt Where Tipus = 'TelegramJordi' "
    
    
    
    InformaMiss "", True
    
    
    
err:

End Sub

Sub BuscarAlertasFacturacion()
    Dim sql As String, sqlUnion As String, m As Integer
    Dim rsSeries As rdoResultset, rsFacturas As rdoResultset, rsFacturasNum As rdoResultset
    Dim nFactura As Integer
    Dim serie As String
    
    On Error GoTo err
    
    ExecutaComandaSql "delete from " & NomTaulaAlertas & " where tipo='HUECO_FACTURACION' and year(fecha)=" & Year(Now())
    
    sqlUnion = ""
    For m = 1 To Month(Now())
        If m > 1 Then sqlUnion = sqlUnion & " union all "
        sqlUnion = sqlUnion & "SELECT numFactura, serie collate Modern_Spanish_CI_AS serie from [facturacio_" & Year(Now()) & "-" & Right("00" & m, 2) & "_iva] "
    Next
    
    sql = "select distinct serie from (" & sqlUnion & ") f"
    Set rsSeries = Db.OpenResultset(sql)
    
    While Not rsSeries.EOF
        serie = rsSeries("serie")
        
        sql = "select count(distinct numfactura) nFacturasDistintas, max(numfactura)-min(numfactura)+1 nFacturas, min(numfactura) minimo, max(numfactura) maximo "
        sql = sql & "from (" & sqlUnion & ") f "
        sql = sql & "where serie='" & serie & "'"
        Set rsFacturas = Db.OpenResultset(sql)
        If Not rsFacturas.EOF Then
            If rsFacturas("nFacturasDistintas") <> rsFacturas("nFacturas") Then 'FALTA ALGUNA FACTURA
                Set rsFacturasNum = Db.OpenResultset("select numfactura from (" & sqlUnion & ") f where serie='" & serie & "' order by numfactura")
                nFactura = 0
                While Not rsFacturasNum.EOF
                    If nFactura > 0 Then
                        If nFactura + 1 < rsFacturasNum("numFactura") Then
                            ExecutaComandaSql "insert into " & NomTaulaAlertas & " (Tipo, Texto) values ('HUECO_FACTURACION', 'Falta la factura " & nFactura + 1 & " de la serie " & serie & "')"
                            nFactura = nFactura + 1
                        Else
                            nFactura = rsFacturasNum("numFactura")
                            rsFacturasNum.MoveNext
                        End If
                    Else
                        nFactura = rsFacturasNum("numFactura")
                        rsFacturasNum.MoveNext
                    End If
                Wend
            End If
        End If

        rsSeries.MoveNext
    Wend
    
err:

End Sub

Function CaixaMati(botiga As Double, dia As Date)
    Dim rs As rdoResultset
    CaixaMati = -1 ' indica no tenim Cuadre de caixa , es podria murar els tickets per futures millores
    
    Set rs = Db.OpenResultset("select Import from [" & NomTaulaMovi(dia) & "] Where botiga='" & botiga & "' and day(data)=" & Day(dia) & " and tipus_moviment = 'Z'  and datepart(HOUR ,data) < 16 ")
    
    If Not rs.EOF Then If Not IsNull(rs(0)) Then CaixaMati = Round(rs(0), 2)
    

End Function

Function CaixaTarda(botiga As Double, dia As Date)
    Dim rs As rdoResultset
    CaixaTarda = -1 ' indica no tenim Cuadre de caixa , es podria murar els tickets per futures millores
    
    Set rs = Db.OpenResultset("select Import from [" & NomTaulaMovi(dia) & "] Where botiga='" & botiga & "' and day(data)=" & Day(dia) & " and tipus_moviment = 'Z'  and datepart(HOUR ,data) > 16 ")
    
    If Not rs.EOF Then If Not IsNull(rs(0)) Then CaixaTarda = Round(rs(0), 2)
    

End Function

Sub CalculaDadesFichador()
    Dim rs As rdoResultset, sql As String
    Dim rsDep As rdoResultset, dep As String
    Dim rsHBase As rdoResultset, rsSortida As rdoResultset
    Dim hBase As Double, hBase_L As Double, hBase_M As Double, hBase_X As Double, hBase_J As Double, hBase_V As Double, hBase_S As Double, hBase_D As Double
    Dim hEntra As String, hEntra_L As String, hEntra_M As String, hEntra_X As String, hEntra_J As String, hEntra_V As String, hEntra_S As String, hEntra_D As String
    Dim fecha As Date, entrada As Date, entradaAux As Date, sortida As Date
    Dim nRnd As Integer, nSgn As Integer, diaSemana As Integer
    Dim totalMinutsDia As Double
    Dim rsDepExist As rdoResultset

    If Not ExisteixTaula("Ajustes_Fichajes") Then
        ExecutaComandaSql "select * into Ajustes_Fichajes From cdpDadesFichador where accio=10"  'solo sirve para crear la tabla, no hay accio=10
    End If
    
    'Initialize the random-number generator.
    Randomize
                        
    Set rsDep = Db.OpenResultset("select distinct(usuari) from cdpDadesFichador order by usuari")
    'Set rsDep = Db.OpenResultset("select distinct(usuari) from cdpDadesFichador where usuari in (2414)   order by usuari")
    While Not rsDep.EOF
        dep = rsDep("usuari")

        If dep <> "" Then
            Set rsDepExist = Db.OpenResultset("select * from dependentes where codi=" & dep)
            If Not rsDepExist.EOF Then
                Set rsHBase = Db.OpenResultset("select * from dependentesExtes where id='" & dep & "' and nom like 'hBase%'")
            'If Not rsHBase.EOF Then
                hBase_L = 0
                hBase_M = 0
                hBase_X = 0
                hBase_J = 0
                hBase_V = 0
                hBase_S = 0
                hBase_D = 0
            
                While Not rsHBase.EOF
                    If IsNumeric(rsHBase("valor")) Then
                        Select Case rsHBase("nom")
                            Case "hBase_L"
                                hBase_L = rsHBase("valor")
                            Case "hBase_M"
                                hBase_M = rsHBase("valor")
                            Case "hBase_X"
                                hBase_X = rsHBase("valor")
                            Case "hBase_J"
                                hBase_J = rsHBase("valor")
                            Case "hBase_V"
                                hBase_V = rsHBase("valor")
                            Case "hBase_S"
                                hBase_S = rsHBase("valor")
                            Case "hBase_D"
                                hBase_D = rsHBase("valor")
                        End Select
                    End If
                    rsHBase.MoveNext
                Wend
        
               Set rsHBase = Db.OpenResultset("select * from dependentesExtes where id='" & dep & "' and nom like 'hEntra_%'")
               'If Not rsHBase.EOF Then
                   hEntra_L = 0
                   hEntra_M = 0
                   hEntra_X = 0
                   hEntra_J = 0
                   hEntra_V = 0
                   hEntra_S = 0
                   hEntra_D = 0
               
                   While Not rsHBase.EOF
        '               If IsNumeric(rsHBase("valor")) Then
                           Select Case rsHBase("nom")
                               Case "hEntra_L"
                                   hEntra_L = rsHBase("valor")
                               Case "hBase_M"
                                   hEntra_M = rsHBase("valor")
                               Case "hEntra_X"
                                   hEntra_X = rsHBase("valor")
                               Case "hEntra_J"
                                   hEntra_J = rsHBase("valor")
                               Case "hEntra_V"
                                   hEntra_V = rsHBase("valor")
                               Case "hEntra_S"
                                   hEntra_S = rsHBase("valor")
                               Case "hEntra_D"
                                   hEntra_D = rsHBase("valor")
                           End Select
        '               End If
                       rsHBase.MoveNext
                   Wend
            
                sql = "select * "
                sql = sql & "From cdpDadesFichador "
                sql = sql & "where usuari='" & dep & "' and accio=1 and idr not in (select distinct idr from Ajustes_Fichajes where usuari='" & dep & "' and accio=1) "
                sql = sql & "order by tmst"
                Set rs = Db.OpenResultset(sql)
    
                entrada = DateSerial(1850, 1, 1)
                totalMinutsDia = 0
                While Not rs.EOF
                    entradaAux = CDate(rs("tmst"))
                    If Year(entrada) > 1850 And (Year(entrada) <> Year(entradaAux) Or Month(entrada) <> Month(entradaAux) Or Day(entrada) <> Day(entradaAux)) Then 'Cambiamos de dia
                       Do  ' busquem quin es el seguent dia que havia de treballar
                            entrada = DateAdd("d", 1, entrada)
                            hBase = Hb(entrada, hBase_L, hBase_M, hBase_X, hBase_J, hBase_V, hBase_S, hBase_D)
                       Loop While hBase = 0 And DateSerial(Year(entrada), Month(entrada), Day(entrada)) < DateSerial(Year(entradaAux), Month(entradaAux), Day(entradaAux))
                       If hBase = 0 Then entrada = CDate(rs("tmst"))
                       totalMinutsDia = 0
                    Else
                        entrada = CDate(rs("tmst"))
                    End If
                    
                    'If Not dep = "" Then InformaMiss "Dades fichatge de  " & depNom & " Data : " & entrada, True
                    hBase = Hb(entrada, hBase_L, hBase_M, hBase_X, hBase_J, hBase_V, hBase_S, hBase_D)
                    
                    If Not entrada = CDate(rs("tmst")) Then
                        entrada = DateSerial(Year(entrada), Month(entrada), Day(entrada)) + HiS(entrada, hEntra_L, hEntra_M, hEntra_X, hEntra_J, hEntra_V, hEntra_S, hEntra_D)
                        ExecutaComandaSql "insert into Ajustes_Fichajes  select id, " & SqlDataMinute(entrada) & " tmst, 1 accio,usuari,idr,editor,historial,lloc,comentari from cdpdadesfichador where idr='" & rs("idr") & "' "
                    Else
                        'LAS HORAS DE ENTRADA LAS DEJAMOS IGUAL
                        ExecutaComandaSql "insert into Ajustes_Fichajes select * from cdpdadesfichador where idr='" & rs("idr") & "'"
                    End If
                    
                    'Busco salida real
                    Set rsSortida = Db.OpenResultset("select top 1 * from cdpDadesFichador where usuari='" & dep & "' and tmst>'" & rs("tmst") & "' and accio=2 order by tmst")
                    If Not rsSortida.EOF Then
                        sortida = CDate(rsSortida("tmst"))
                    Else
                        sortida = entrada
                    End If
                                   
                
                    If DateDiff("n", entrada, sortida) > hBase Then
                        If hBase <> 0 Then
                            nRnd = CInt(Int((12 * Rnd()) + 1)) 'Entre 1 y 12
                            nSgn = CInt(Int((2 * Rnd()) + 1)) 'Entre 1 y 2 para el signo
                            If nSgn = 2 Then nRnd = nRnd * -1
                            
                            fecha = DateAdd("n", hBase - totalMinutsDia + nRnd, entrada)
                            ExecutaComandaSql "insert into Ajustes_Fichajes values (0, '" & fecha & "', 2, '" & dep & "', NEWID(), '', '', '" & rs("lloc") & "', '" & rs("comentari") & "')"
                            totalMinutsDia = totalMinutsDia + DateDiff("n", entrada, fecha)
                        Else
                            If Not rsSortida.EOF Then
                                If DateDiff("H", CDate(rs("tmst")), sortida) < 20 Then
                                    ExecutaComandaSql "insert into Ajustes_Fichajes select * from cdpdadesfichador where idr='" & rsSortida("idr") & "'"
                                    totalMinutsDia = totalMinutsDia + DateDiff("n", entrada, CDate(rsSortida("tmst")))
                                End If
                            End If
                        End If
                    Else
                        If Not rsSortida.EOF Then
                            If totalMinutsDia + DateDiff("n", entrada, CDate(rsSortida("tmst"))) > hBase Then
                                nRnd = CInt(Int((9 * Rnd()) + 1)) 'Entre 1 y 9
                                nSgn = CInt(Int((2 * Rnd()) + 1)) 'Entre 1 y 2 para el signo
                                If nSgn = 2 Then nRnd = nRnd * -1
                                
                                fecha = DateAdd("n", hBase - totalMinutsDia + nRnd, CDate(rs("tmst")))
                                ExecutaComandaSql "insert into Ajustes_Fichajes values (0, '" & fecha & "', 2, '" & dep & "', NEWID(), '', '', '" & rs("lloc") & "', '" & rs("comentari") & "')"
                                totalMinutsDia = totalMinutsDia + DateDiff("n", entrada, fecha)
                            Else
                                ExecutaComandaSql "insert into Ajustes_Fichajes select * from cdpdadesfichador where idr='" & rsSortida("idr") & "'"
                                totalMinutsDia = totalMinutsDia + DateDiff("n", entrada, CDate(rsSortida("tmst")))
                            End If
                        End If
                    End If
                    If entrada = CDate(rs("tmst")) Then rs.MoveNext
                Wend
            End If
        End If
        rsDep.MoveNext
    Wend
End Sub

Sub CalculEstimacio()
    
  Debug.Print DonamNomTaulaEstimacio(Now())
        
End Sub


Sub EnviaEmailPicking()
    Dim para As String, asunto As String, cuerpo As String
    Dim repartidor As String, cliente As String, reparto As String
    Dim rsEmail As rdoResultset
    Dim rsPick As rdoResultset
    Dim sql As String
    Dim iniRep As Date, finRep As Date
    
    InformaMiss "enviaEmailPicking", True

    sql = "select p.quan, p.caja, d.nom Repartidor, c.nom Client, a.nom Article, p.nAlbara, p.Lote+p.Apodo NLot, p.viatge, p.equip, isnull(p.Qtat, 0) Qtat "
    sql = sql & "from [" & nomTaulaPicking(Now()) & "] p "
    sql = sql & "left join clients c on p.client=c.codi "
    sql = sql & "left join dependentes d on p.qui=d.codi "
    sql = sql & "left join articles a on p.article=a.codi "
    sql = sql & "where day(DataServit)=" & Day(Now()) & " "
    sql = sql & "order by d.nom, p.quan"
        
    'sql = "select p.quan, p.caja, d.nom Repartidor, c.nom Client, a.nom Article, p.nAlbara, p.Lote+p.Apodo NLot, p.viatge, p.equip, isnull(p.qtat, 0) Qtat "
    'sql = sql & "from [Picking_2016-02] p "
    'sql = sql & "left join clients c on p.client=c.codi "
    'sql = sql & "left join dependentes d on p.qui=d.codi "
    'sql = sql & "left join articles a on p.article=a.codi "
    'sql = sql & "where day(quan)=27 "
    'sql = sql & "order by d.nom, p.quan"
    
    Set rsPick = Db.OpenResultset(sql)
    
    If Not rsPick.EOF Then
        asunto = "PICKING DIA " & Now()
        
        While Not rsPick.EOF
        
            If repartidor <> rsPick("Repartidor") Then
                If repartidor <> "" Then
                    cuerpo = cuerpo & "</TABLE>"
                    cuerpo = Replace(cuerpo, "<DURADA>", DateDiff("n", iniRep, finRep))
                End If
                
                repartidor = rsPick("Repartidor")
                cliente = rsPick("Client")
                reparto = rsPick("viatge")
                
                cuerpo = cuerpo & "<H1>" & repartidor & "</H1>"
                
                iniRep = rsPick("quan")
                cuerpo = cuerpo & "<DD><H2>" & cliente & ". " & reparto & " (<DURADA> minuts)</H2>"
        
                cuerpo = cuerpo & "<TABLE BORDER='1' CELLPADDING='3'>"
                cuerpo = cuerpo & "<TR><TD><B>ARTICLE</B></TD><TD><B>CAIXA</B></TD><TD><B>ALBARÀ</B></TD><TD><B>LOT</B></TD><TD><B>QTAT</B></TD><TD><B>DATA</B></TD></TR>"
            Else
                If cliente <> rsPick("client") Or reparto <> rsPick("viatge") Then
                    cuerpo = cuerpo & "</TABLE>"
                    cuerpo = Replace(cuerpo, "<DURADA>", DateDiff("n", iniRep, finRep))
                    
                    cliente = rsPick("Client")
                    reparto = rsPick("viatge")

                    iniRep = rsPick("quan")
                    cuerpo = cuerpo & "<DD><H2>" & cliente & ". " & reparto & " (<DURADA> minuts)</H2>"
            
                    cuerpo = cuerpo & "<TABLE BORDER='1' CELLPADDING='3'>"
                    cuerpo = cuerpo & "<TR><TD><B>ARTICLE</B></TD><TD><B>CAIXA</B></TD><TD><B>ALBARÀ</B></TD><TD><B>LOT</B></TD><TD><B>QTAT</B></TD><TD><B>DATA</B></TD></TR>"
                End If
            End If
        
            cuerpo = cuerpo & "<TR><TD>" & rsPick("Article") & "</TD><TD ALIGN='Right'>" & rsPick("caja") & "</TD><TD ALIGN='Right'>" & rsPick("nAlbara") & "</TD><TD ALIGN='Right'>" & rsPick("nLot") & "</TD><TD ALIGN='Right'>" & rsPick("Qtat") & "</TD><TD>" & rsPick("quan") & "</TD></TR>"
        
            repartidor = rsPick("Repartidor")
            cliente = rsPick("Client")
            reparto = rsPick("viatge")
            finRep = rsPick("quan")
        
            rsPick.MoveNext
        Wend
        cuerpo = cuerpo & "</TABLE>"
        cuerpo = Replace(cuerpo, "<DURADA>", DateDiff("n", iniRep, finRep))
        
        Set rsEmail = Db.OpenResultset("select valor as Email from dependentesExtes where id in (select id from dependentesextes where nom='PICKING' and valor=1) and nom='EMAIL'")
        While Not rsEmail.EOF
            para = rsEmail("Email")
        
            If para <> "" Then sf_enviarMail "", para, asunto, cuerpo, "", ""
        
            rsEmail.MoveNext
        Wend
'        sf_enviarMail "", "jordi@hit.cat", Asunto, cuerpo, "", ""
        'sf_enviarMail "", "ana@solucionesit365.com", Asunto, cuerpo, "", ""
    End If

    cuerpo = ""
End Sub


Function EnviaEmailDemanatServit() As String
    Dim sql As String
    Dim MsExcel As Excel.Application
    Dim Libro As Excel.Workbook
    Dim rs As ADODB.Recordset
    Dim rsId As rdoResultset
    Dim a As New Stream, s() As Byte
    Dim iD As String
    

    On Error Resume Next
    db2.Close
    On Error GoTo ERR_
    
    Set db2 = New ADODB.Connection
    db2.Open "WSID=" & db2MyId & ";UID=" & db2User & ";PWD=" & db2Psw & ";Database=" & db2NomDb & ";Server=" & db2Server & ";Driver={SQL Server};DSN='';"
    
    Set MsExcel = CreateObject("Excel.Application")
    Set Libro = MsExcel.Workbooks.Add
    
    MsExcel.DisplayAlerts = False
    MsExcel.Visible = frmSplash.Debugant
    
    Set rsId = Db.OpenResultset("select newid() i")
    iD = rsId("i")

    While Libro.Sheets.Count > 1
      Libro.Sheets(1).Delete
    Wend
    
    InformaMiss "EnviaEmailDemanatServit", True

    sql = "select Client, isnull(f1, ' No Classificat') Familia, Article, Demanat, Servit, Tornat, Servit - Demanat [Servit-Demanat] "
    sql = sql & "from ( "
    sql = sql & "select isnull(c.codi,cz.codi) codiClient, "
    sql = sql & "a.codi codiArticle, isnull(c.nom,cz.nom) Client, a.familia f3, "
    sql = sql & "f.pare f2, f2.pare f1,a.nom Article,CAST (sum(s.quantitatDemanada) AS FLOAT)Demanat, "
    sql = sql & "CAST(sum(s.quantitatServida) AS FLOAT) Servit,CAST(sum(s.quantitatTornada) AS FLOAT) Tornat "
    sql = sql & "from [Servit-" & Format(DateAdd("d", -1, Now()), "yy-mm-dd") & "] s "
    sql = sql & "left join clients c on c.codi = s.client "
    sql = sql & "left join clients_zombis cz on cz.codi = s.client "
    sql = sql & "left join Articles a on a.codi = s.codiarticle "
    sql = sql & "left join families f on a.familia = f.nom "
    sql = sql & "left join families f2 on f.pare=f2.nom "
    sql = sql & "where a.nom not like '%@' "
    sql = sql & "group by c.nom,c.codi,cz.nom,cz.codi,f2.pare,f.pare,a.familia,a.nom,a.codi "
    sql = sql & "having SUM(s.quantitatServida)>0 or SUM(s.quantitatDemanada)>0) t "
    sql = sql & "order by client,f1,Article"

    rellenaHojaSql "Demanat - Servit - Tornat (" & Now() & ")", sql, Libro.Sheets(1), 0
    
    
    If Excel.Application.Version >= 12 Then
        Libro.SaveAs Excel.Application.DefaultFilePath & "\" & iD & ".xls", xlExcel8
    Else
        Libro.SaveAs Excel.Application.DefaultFilePath & "\" & iD & ".xls"
    End If
    
    Libro.Close

    Set Libro = Nothing
    Set MsExcel = Nothing

    a.Open
    a.LoadFromFile Excel.Application.DefaultFilePath & "\" & iD & ".xls"
    s = a.ReadText()

On Error GoTo ERR_
        
    Set rs = rec("SET LANGUAGE Español ;   select * from " & tablaArchivo() & " where fecha=(select max(fecha) from " & tablaArchivo() & ")", True)
    
    rs.AddNew
    rs("id").Value = iD
    rs("nombre").Value = "Demanat-Servit"
    rs("descripcion").Value = "Demanat-Servit"
    rs("extension").Value = "XLS"
    rs("mime").Value = "application/vnd.ms-excel"
    rs("propietario").Value = ""
    rs("archivo").Value = s
    rs("fecha").Value = Now
    rs("tmp").Value = 0
    rs("down").Value = 1
    rs.Update
    rs.Close
    a.Close

    EnviaEmailDemanatServit = iD
    
    MyKill Excel.Application.DefaultFilePath & "\" & iD & ".xls"
    
    'sf_enviarMail "", "sgomez@silemabcn.com", "Demanat - Servit - Tornat (" & Now() & ")", cuerpo, "", ""
    'sf_enviarMail "", "ana@solucionesit365.com", "Demanat - Servit - Tornat (" & Now() & ")", "", "", ""
    

ERR_:

    TancaExcel MsExcel, Libro
    db2.Close
    
End Function


Sub ExportaANALITICA_CaixaBotigaOnLine(numAsiento As String, dataCaixa As Date, botiga As String)
    Dim rsFac As rdoResultset, rsHist As rdoResultset, rsSage As rdoResultset
    Dim sql As String, ordMovimiento As String, familia As String
    Dim Semana As Integer
    
    On Error GoTo noExportat
    
    Informa "ANALITICA Caixa " & dataCaixa & " Botiga " & botiga
    
    Semana = DatePart("WW", dataCaixa, vbMonday, vbFirstJan1)

    'Buscamos el asiento en la tabla intermedia de exportación A_IMPORTACIO_ASSENTAMENTS
    Set rsSage = Db.OpenResultset("select * from " & dbSage & ".dbo.A_IMPORTACIO_ASSENTAMENTS where Asiento = " & numAsiento & " and CodigoEmpresa=" & EmpresaMurano & " and (CodigoCuenta like '7%' or CodigoCuenta like '6%') and ejercicio=" & Year(dataCaixa))
    While Not rsSage.EOF
        ordMovimiento = rsSage("OrdenMovimientos")
           
'familia????
        'POR FAMILIAS
        'SqlData = "select ISNULL(fe1.valor, '" & Left("7000000000000", nDigitos) & "') CC, sum(import) BASE_FAM "
        'SqlData = SqlData & "from [" & NomTaulaFacturaData(dataFactura) & "] fd "
        'SqlData = SqlData & "left join articles a on fd.producte=a.codi "
        'SqlData = SqlData & "left join families F3 on a.familia = F3.nom "
        'SqlData = SqlData & "left join families F2 on F2.nom = F3.pare "
        'SqlData = SqlData & "left join families F1 on F1.nom = F2.Pare "
        'SqlData = SqlData & "left join familiesExtes fe1 on F1.nom=fe1.familia and fe1.variable='CUENTA_CONTABLE' "
        'SqlData = SqlData & "where fd.idfactura='" & idFactura & "' "
        'SqlData = SqlData & "group by ISNULL(fe1.valor, '" & Left("7000000000000", nDigitos) & "')"
        familia = ""

        ExecutaComandaSql "delete from " & dbSage & ".dbo.A_IMPORTACIO_ANALITICA where codigoEmpresa=" & EmpresaMurano & " and Asiento=" & numAsiento & " and OrdenMovimientos_= " & ordMovimiento & " and Ejercicio= " & Year(dataCaixa)

        sql = "insert into " & dbSage & ".dbo.A_IMPORTACIO_ANALITICA (CodigoEmpresa, Asiento, OrdenMovimientos_, Ejercicio, CodigoDepartamento, CodigoSeccion, CodigoProyecto, importe) "
        sql = sql & " values (" & EmpresaMurano & ", " & numAsiento & ", " & ordMovimiento & ", " & Year(dataCaixa) & ", '" & botiga & "', '" & familia & "', 'S" & Right("0" & Semana, 2) & "', " & rsSage("ImporteAsiento") & ")"
        ExecutaComandaSql sql
        
        rsSage.MoveNext
   Wend

    
noExportat:

End Sub

Sub ExportaContabilitatFacturacio(numAsiento, Di As Date, Df As Date, empresa, EsB)
    Dim D As Date
    Dim TaulaIva As String, sql As String, clientCodi As String
    Dim rsCtb As rdoResultset, rsTot As rdoResultset
    Dim ArrMesos(12)
    
    ArrMesos(0) = "GENER"
    ArrMesos(1) = "FEBRER"
    ArrMesos(2) = "MARÇ"
    ArrMesos(3) = "ABRIL"
    ArrMesos(4) = "MAIG"
    ArrMesos(5) = "JUNY"
    ArrMesos(6) = "JULIOL"
    ArrMesos(7) = "AGOST"
    ArrMesos(8) = "SETEMBRE"
    ArrMesos(9) = "OCTUBRE"
    ArrMesos(10) = "NOVEMBRE"
    ArrMesos(11) = "DESEMBRE"
    
    InformaMiss "Facturacio", True

    D = Di
    TaulaIva = NomTaulaFacturaIva(D)

    
    'LINEA EJEMPLO FORMATO SP
    '1200220140831570000000                           0.00COBRAMENTS AGOST                     0.00       0            0.00 0.00 0.00                         00     0        0.000000            0.00            0.00                       0.002        19220.64            0.00            0.00F                  0            0.00            0.00F        EF                   F                                0.00 0.00     0            0.00                                                                                                                                                                                                                1                                                                                0                                                                F          FF            0.00            0
    sql = "select SUM(Total) Total "
    sql = sql & "From [" & TaulaIva & "] f "
    sql = sql & "left join constantsclient cc on f.ClientCodi = cc.codi and cc.Variable ='FormaPagoLlista' "
    sql = sql & "where f.IdFactura in (select IdFactura from FacturacioComentaris where Cobrat='S') and f.EmpresaCodi='" & empresa & "' "
    sql = sql & "and f.NumFactura > 0 and cc.Valor='3'"
    Set rsTot = Db.OpenResultset(sql)
    
    If Not rsTot.EOF Then
        AsientoAdd numAsiento, Di, "570000000", "", "", Left("COBRAMENTS " & ArrMesos(Month(Di) - 1) & Space(25), 25), rsTot("Total"), 0, 0, 0, 0, ""
        numAsiento = numAsiento + 1
    
        sql = "select isnull(cc.valor, f.ClientCodi) ClientCodi, SUM(f.total) Total "
        sql = sql & "From [" & TaulaIva & "] f "
        sql = sql & "left join ConstantsClient cc on f.ClientCodi = cc.Codi and cc.Variable = 'CodiContable' "
        sql = sql & "left join constantsclient cc2 on f.ClientCodi = cc2.codi and cc2.Variable ='FormaPagoLlista' "
        sql = sql & "where f.IdFactura in (select IdFactura from FacturacioComentaris where Cobrat='S') "
        sql = sql & "and f.EmpresaCodi='" & empresa & "' and f.NumFactura > 0 and cc2.Valor='3' "
        sql = sql & "group by isnull(cc.valor, f.ClientCodi)"
        Set rsCtb = Db.OpenResultset(sql)
            
        While Not rsCtb.EOF
            clientCodi = Trim(rsCtb("clientCodi"))
    
            AsientoAdd numAsiento, Di, "43" & Right("000000000000" & clientCodi, nDigitos - 2), "", "", Left("COBRAMENTS " & ArrMesos(Month(Di) - 1) & Space(25), 25), 0, rsCtb("Total"), 0, 0, 0, ""
    
            numAsiento = numAsiento + 1
            DoEvents
            rsCtb.MoveNext
            DadesExportaCpFlush
        Wend
        rsCtb.Close
    End If
End Sub

Sub fesCopiaQuadrantsTorns()
    Dim sql As String
    Dim RsBot As rdoResultset
    Dim rsPlan As rdoResultset
    Dim codiBot As String
    Dim hoy As Date, proximaSemana As Date
        
    hoy = Now()
    proximaSemana = DateAdd("d", 7, hoy)
    
    Set RsBot = Db.OpenResultset("select distinct botiga from " & taulaCdpPlanificacion(hoy) & " where day(fecha)=" & Day(hoy))
    
    While Not RsBot.EOF
        codiBot = RsBot("botiga")
        
        Set rsPlan = Db.OpenResultset("select * from " & taulaCdpPlanificacion(proximaSemana) & " where botiga = " & codiBot & " and day(fecha)=" & Day(proximaSemana))
        If rsPlan.EOF Then
            sql = "insert into " & taulaCdpPlanificacion(proximaSemana) & " (idPlan, fecha, botiga, periode, idTurno, idEmpleado, usuarioModif, fechaModif, activo) "
            sql = sql & "select newid(), dateadd(d, 7, convert(datetime, concat(day(fecha), '/', month(fecha), '/', year(fecha)),103)), botiga, periode, idTurno, null, 'SINCRO_COPIA', getdate(), 1 "
            sql = sql & "from " & taulaCdpPlanificacion(hoy) & " "
            sql = sql & "where botiga=" & codiBot & " and activo=1 and isnull(idTurno, '') <>'' and idTurno not like '%Extra%' and idTurno not like '%Coord%' and idTurno not like '%Aprendiz%'"
            sql = sql & "and day(fecha)=" & Day(hoy)
            ExecutaComandaSql sql
        End If

        RsBot.MoveNext
    Wend
    
    RsBot.Close


    hoy = DateAdd("d", 1, Now())
    proximaSemana = DateAdd("d", 7, hoy)
    
    Set RsBot = Db.OpenResultset("select distinct botiga from " & taulaCdpPlanificacion(hoy) & " where day(fecha)=" & Day(hoy))
    
    While Not RsBot.EOF
        codiBot = RsBot("botiga")
        
        Set rsPlan = Db.OpenResultset("select * from " & taulaCdpPlanificacion(proximaSemana) & " where botiga = " & codiBot & " and day(fecha)=" & Day(proximaSemana))
        If rsPlan.EOF Then
            sql = "insert into " & taulaCdpPlanificacion(proximaSemana) & " (idPlan, fecha, botiga, periode, idTurno, idEmpleado, usuarioModif, fechaModif, activo) "
            sql = sql & "select newid(), dateadd(d, 7, convert(datetime, concat(day(fecha), '/', month(fecha), '/', year(fecha)),103)), botiga, periode, idTurno, null, 'SINCRO_COPIA', getdate(), 1 "
            sql = sql & "from " & taulaCdpPlanificacion(hoy) & " "
            sql = sql & "where botiga=" & codiBot & " and activo=1 and isnull(idTurno, '') <>'' and idTurno not like '%Extra%' and idTurno not like '%Coord%' and idTurno not like '%Aprendiz%'"
            sql = sql & "and day(fecha)=" & Day(hoy)
            ExecutaComandaSql sql
        End If

        RsBot.MoveNext
    Wend
    
    RsBot.Close


End Sub

Sub FesFeinesPerFerAles12()
    Dim rs As rdoResultset
    Dim botiga As String, tablaRepo As String, sql As String, tServits As String
    
    tServits = "[Servit-" & Format(DateAdd("d", 1, Now()), "yy-mm-dd") & "]"
    
    Set rs = Db.OpenResultset("select * from sys.tables where name like '%repo%tienda%'")
    While Not rs.EOF
        tablaRepo = rs("name")
        botiga = Split(tablaRepo, "_")(2)
        Debug.Print BotigaCodiNom(botiga)
    
        sql = "insert into " & tServits & " "
        sql = sql & "(Id, TimeStamp, QuiStamp, Client, CodiArticle, Viatge, Equip, QuantitatDemanada, QuantitatTornada, QuantitatServida, Hora, TipusComanda, Comentari) "
        sql = sql & "select newid(), getdate(), 'Botiga " & BotigaCodiNom(botiga) & "', " & botiga & ", codiArticle, viatge, equip, quantitatDemanada, 0, quantitatDemanada, 11, 1, '[Reposicio:' + cast(quantitatDemanada as varchar) + ']' "
        sql = sql & "From " & tablaRepo & " "
        sql = sql & "Where Day(TimeStamp) = " & Day(Now()) & " And Month(TimeStamp) = " & Month(Now()) & " And Year(TimeStamp) = " & Year(Now())
        ExecutaComandaSql sql
        
        rs.MoveNext
    Wend
    
End Sub

Sub FesNetejaBD()
    Dim sql As String, BakDatabase As String, rs As rdoResultset, rsH As rdoResultset, dataLimit As Date, Y, m As String, OK As Boolean, Path As String, rs2 As rdoResultset, TempsPerNeteja As Date

    TempsPerNeteja = DateAdd("n", 30, Now())
    Path = "D:\Base de Dades\"
    
    InformaMiss "Fent neteja " & LastDatabase
    
    BakDatabase = LastDatabase & "_bak"
    
    Set rs = Db.OpenResultset("Select * From sys.databases where name = '" & BakDatabase & "'")
    If rs.EOF Then
        ExecutaComandaSql "Use Master"
        ExecutaComandaSql "CREATE DATABASE [" & BakDatabase & "]  ON (NAME = N'" & BakDatabase & "_dat', FILENAME = N'" & Path & "" & BakDatabase & ".mdf', FILEGROWTH = 10%) LOG ON (NAME = N'" & BakDatabase & "_log', FILENAME = N'" & Path & "" & BakDatabase & ".ldf' , SIZE = 1, FILEGROWTH = 10%)"
        
        ExecutaComandaSql "exec sp_dboption N'" & BakDatabase & "', N'autoclose', N'false'"
        ExecutaComandaSql "exec sp_dboption N'" & BakDatabase & "', N'bulkcopy', N'true'"
        ExecutaComandaSql "exec sp_dboption N'" & BakDatabase & "', N'trunc. log', N'true'"
        ExecutaComandaSql "exec sp_dboption N'" & BakDatabase & "', N'torn page detection', N'true'"
        ExecutaComandaSql "exec sp_dboption N'" & BakDatabase & "', N'read only', N'false'"
        ExecutaComandaSql "exec sp_dboption N'" & BakDatabase & "', N'dbo use', N'false'"
        ExecutaComandaSql "exec sp_dboption N'" & BakDatabase & "', N'single', N'false'"
        ExecutaComandaSql "exec sp_dboption N'" & BakDatabase & "', N'autoshrink', N'true'"
        ExecutaComandaSql "exec sp_dboption N'" & BakDatabase & "', N'ANSI null default', N'true'"
        ExecutaComandaSql "exec sp_dboption N'" & BakDatabase & "', N'recursive triggers', N'false'"
        ExecutaComandaSql "exec sp_dboption N'" & BakDatabase & "', N'ANSI nulls', N'false'"
        ExecutaComandaSql "exec sp_dboption N'" & BakDatabase & "', N'concat null yields null', N'false'"
        ExecutaComandaSql "exec sp_dboption N'" & BakDatabase & "', N'cursor close on commit', N'false'"
        ExecutaComandaSql "exec sp_dboption N'" & BakDatabase & "', N'default to local cursor', N'false'"
        ExecutaComandaSql "exec sp_dboption N'" & BakDatabase & "', N'quoted identifier', N'false'"
        ExecutaComandaSql "exec sp_dboption N'" & BakDatabase & "', N'ANSI warnings', N'false'"
        ExecutaComandaSql "exec sp_dboption N'" & BakDatabase & "', N'auto create statistics', N'true'"
        ExecutaComandaSql "exec sp_dboption N'" & BakDatabase & "', N'auto update statistics', N'true'"
        ExecutaComandaSql "if( ( (@@microsoftversion / power(2, 24) = 8) and (@@microsoftversion & 0xffff >= 724) ) or ( (@@microsoftversion / power(2, 24) = 7) and (@@microsoftversion & 0xffff >= 1082) ) )  exec sp_dboption N'" & BakDatabase & "', N'db chaining', N'false' "
        ExecutaComandaSql "Use " & LastDatabase
    End If
            
    'Facturacio_yyyy-mm_Data
    'Dejamos en la BD original 24 meses
    InformaMiss "Fent neteja Facturacio_yyyy_mm_Data"
    FesNetejaTaulaBD "Facturacio%-%data%", DateAdd("M", -24, Now()), BakDatabase, 1, TempsPerNeteja
    
    'Facturacio_yyyy-mm_Iva
    'Dejamos en la BD original 24 meses
    InformaMiss "Fent neteja Facturacio_yyyy_mm_Iva"
    FesNetejaTaulaBD "Facturacio%-%iva%", DateAdd("M", -24, Now()), BakDatabase, 1, TempsPerNeteja

    'Facturacio_yyyy-mm_Reb
    'Dejamos en la BD original 24 meses
    InformaMiss "Fent neteja Facturacio_yyyy_mm_Reb"
    FesNetejaTaulaBD "Facturacio%-%reb%", DateAdd("M", -24, Now()), BakDatabase, 1, TempsPerNeteja
    
    'Pressupost_yyyy-mm_Data
    'Dejamos en la BD original 24 meses
    InformaMiss "Fent neteja Pressupost_yyyy-mm_Data"
    FesNetejaTaulaBD "Pressupost%-%data%", DateAdd("M", -24, Now()), BakDatabase, 1, TempsPerNeteja
    
    'Pressupost_yyyy-mm_Iva
    'Dejamos en la BD original 24 meses
    InformaMiss "Fent neteja Pressupost_yyyy-mm_Iva"
    FesNetejaTaulaBD "Pressupost%-%iva%", DateAdd("M", -24, Now()), BakDatabase, 1, TempsPerNeteja
    
    'Pressupost_yyyy-mm_Reb
    'Dejamos en la BD original 24 meses
    InformaMiss "Fent neteja Pressupost_yyyy-mm_Reb"
    FesNetejaTaulaBD "Pressupost%-%reb%", DateAdd("M", -24, Now()), BakDatabase, 1, TempsPerNeteja
    
    'Comptabilitzats_yyyy-mm
    'Dejamos en la BD original 24 meses
    InformaMiss "Fent neteja Comptabilitzats_yyyy-mm"
    FesNetejaTaulaBD "Comptabilitzats_%", DateAdd("M", -24, Now()), BakDatabase, 1, TempsPerNeteja
    
    'V_Venut_yyyy-mm
    'Dejamos en la BD original 24 meses
    InformaMiss "Fent neteja V_Venut_yyyy-mm"
    FesNetejaTaulaBD "V_Venut_%' and name not like '%Previsio%'  and name not like '%Promo%", DateAdd("M", -24, Now()), BakDatabase, 2, TempsPerNeteja
    
    'V_Venut_Previsio_yyyy-mm
    'Dejamos en la BD original 24 meses
    InformaMiss "Fent neteja V_Venut_Previsio_yyyy-mm"
    FesNetejaTaulaBD "V_venut_Previsio%", DateAdd("M", -24, Now()), BakDatabase, 3, TempsPerNeteja
            
    'V_Moviments_yyyy-mm
    'Dejamos en la BD original 24 meses
    InformaMiss "Fent neteja V_Moviments_yyyy-mm"
    FesNetejaTaulaBD "V_Moviments_%", DateAdd("M", -24, Now()), BakDatabase, 2, TempsPerNeteja
           
    'V_Albarans_yyyy-mm
    'Dejamos en la BD original 24 meses
    InformaMiss "Fent neteja V_Albarans_yyyy-mm"
    FesNetejaTaulaBD "V_Albarans_%", DateAdd("M", -24, Now()), BakDatabase, 2, TempsPerNeteja
    
    'V_Log_yyyy-mm
    'Dejamos en la BD original 24 meses
    InformaMiss "Fent neteja V_Log_yyyy-mm"
    FesNetejaTaulaBD "V_Log_%", DateAdd("M", -24, Now()), BakDatabase, 2, TempsPerNeteja
    
    'V_Inventaris_yyyy-mm
    'Dejamos en la BD original 24 meses
    InformaMiss "Fent neteja V_Inventaris_yyyy-mm"
    FesNetejaTaulaBD "V_Inventaris_%", DateAdd("M", -24, Now()), BakDatabase, 2, TempsPerNeteja

    'V_Tornat_yyyy-mm
    'Dejamos en la BD original 24 meses
    InformaMiss "Fent neteja V_Tornat_yyyy-mm"
    FesNetejaTaulaBD "V_Tornat_%", DateAdd("M", -24, Now()), BakDatabase, 2, TempsPerNeteja

    'V_Alertes_yyyy-mm
    'Dejamos en la BD original 24 meses
    InformaMiss "Fent neteja V_Alertes_yyyy-mm"
    FesNetejaTaulaBD "V_Alertes_%", DateAdd("M", -24, Now()), BakDatabase, 2, TempsPerNeteja
    
    'V_Anulats_yyyy-mm
    'Dejamos en la BD original 24 meses
    InformaMiss "Fent neteja V_Anulats_yyyy-mm"
    FesNetejaTaulaBD "V_Anulats_%", DateAdd("M", -24, Now()), BakDatabase, 2, TempsPerNeteja

    'V_Encarre_yyyy-mm
    'Dejamos en la BD original 24 meses
    InformaMiss "Fent neteja V_Encarre_yyyy-mm"
    FesNetejaTaulaBD "V_Encarre_%", DateAdd("M", -24, Now()), BakDatabase, 2, TempsPerNeteja

    'V_Estadis_yyyy-mm
    'Dejamos en la BD original 24 meses
    InformaMiss "Fent neteja V_Estadis_yyyy-mm"
    FesNetejaTaulaBD "V_Estadis_%", DateAdd("M", -24, Now()), BakDatabase, 2, TempsPerNeteja
    
    'V_Horaris_yyyy-mm
    'Dejamos en la BD original 24 meses
    InformaMiss "Fent neteja V_Horaris_yyyy-mm"
    FesNetejaTaulaBD "V_Horaris_%", DateAdd("M", -24, Now()), BakDatabase, 2, TempsPerNeteja
    
    'V_Revisat_yyyy-mm
    'Dejamos en la BD original 24 meses
    InformaMiss "Fent neteja V_Revisat_yyyy-mm"
    FesNetejaTaulaBD "V_Revisat_%", DateAdd("M", -24, Now()), BakDatabase, 2, TempsPerNeteja
    
           
    'HistoricComunicacionsReposicio_yyyy_mm
    'Dejamos en la BD original los 3 últimos dias
    'Borramos directamente, sin guardar en Bak
    InformaMiss "Fent neteja HistoricComunicacionsReposicio_yyyy_mm"
    sql = "SELECT * "
    sql = sql & "From sys.Tables "
    sql = sql & "WHERE name like 'HistoricComunicacionsReposicio%' "
    sql = sql & "order by name "
    
    Set rs = Db.OpenResultset(sql)
    While Not rs.EOF And Now < TempsPerNeteja
        InformaMiss rs("name"), True
        ExecutaComandaSql "Delete from " & rs("name") & " where datediff(day, timestamp, getdate())>3"
        Set rsH = Db.OpenResultset("select * from " & rs("name"))
        If rsH.EOF Then
            ExecutaComandaSql "drop table [" & rs("name") & "]"
        End If
        rs.MoveNext
    Wend
    
    'HistoricComunicacions_yyyy_mm
    'Dejamos en la BD original los 10 últimos dias
    'Borramos directamente, sin guardar en Bak
    InformaMiss "Fent neteja HistoricComunicacions_yyyy_mm"
    sql = "SELECT * "
    sql = sql & "From sys.Tables "
    sql = sql & "WHERE name like 'HistoricComunicacions_%' and name not like '%Reposicio%' "
    sql = sql & "order by name "
    
    Set rs = Db.OpenResultset(sql)
    While Not rs.EOF And Now < TempsPerNeteja
        InformaMiss rs("name"), True
        ExecutaComandaSql "Delete from " & rs("name") & " where datediff(day, timestamp, getdate())>10"
        Set rsH = Db.OpenResultset("select * from " & rs("name"))
        If rsH.EOF Then
            ExecutaComandaSql "drop table [" & rs("name") & "]"
        End If
        rs.MoveNext
    Wend
    
    'Servit-yy-mm-dd
    'M_Servit-yy-mm-dd Triggers
    'Dejamos en la BD original 24 meses
    InformaMiss "Fent neteja Servit-yy-mm-dd"
    dataLimit = DateAdd("M", -24, Now())
    
    sql = "SELECT * "
    sql = sql & "From sys.Tables "
    sql = sql & "WHERE name like 'Servit%-%-%' and name not like '%Reg%' and name not like '%Trace%' "
    sql = sql & "order by name "
    
    Set rs = Db.OpenResultset(sql)
    While Not rs.EOF And Now < TempsPerNeteja
        Y = Split(rs("name"), "-")(1)
        If CInt(Y) > 80 Then
            Y = "19" & Y
        Else
            Y = "20" & Y
        End If
        InformaMiss rs("name"), True
        m = Split(rs("name"), "-")(2)
        If IsNumeric(Y) And IsNumeric(m) Then
            If (CInt(Y) < Year(dataLimit)) Or (CInt(Y) = Year(dataLimit) And CInt(m) < Month(dataLimit)) Then
                OK = ExecutaComandaSql("select * into " & BakDatabase & ".dbo.[" & rs("name") & "] from [" & rs("name") & "]")
                If OK Then
                    ExecutaComandaSql "drop table [" & rs("name") & "]"
                    ExecutaComandaSql "drop trigger [M_" & rs("name") & "]"
                End If
            ElseIf Y <= 2000 Or CInt(Y) > Year(Now()) + 1 Then
                Set rs2 = Db.OpenResultset("Select Count(*) n from [" & rs("name") & "] ")
                If rs2.EOF Then ExecutaComandaSql "drop table [" & rs("name") & "]"
                If Not rs2.EOF And rs2(0) = 0 Then ExecutaComandaSql "drop table [" & rs("name") & "]"
            End If

        End If
        rs.MoveNext
    Wend

    'Servit-yy-mm-ddReg
    'Dejamos en la BD original 24 meses
    InformaMiss "Fent neteja Servit-yy-mm-ddReg"
    dataLimit = DateAdd("M", -24, Now())
    
    sql = "SELECT * "
    sql = sql & "From sys.Tables "
    sql = sql & "WHERE name like 'Servit%-%-%Reg' "
    sql = sql & "order by name "
    
    Set rs = Db.OpenResultset(sql)
    While Not rs.EOF And Now < TempsPerNeteja
        Y = Split(rs("name"), "-")(1)
        If CInt(Y) > 80 Then
            Y = "19" & Y
        Else
            Y = "20" & Y
        End If
        InformaMiss rs("name"), True
        m = Split(rs("name"), "-")(2)
        If IsNumeric(Y) And IsNumeric(m) Then
            If DateDiff("D", DateSerial(Y, m, 15), Now) < 0 Or DateDiff("D", DateSerial(Y, m, 15), Now) > 60 Then
                ExecutaComandaSql "drop table [" & rs("name") & "]"
            End If
'            If (CInt(Y) < Year(dataLimit)) Or (CInt(Y) = Year(dataLimit) And CInt(M) < Month(dataLimit)) Then
'                ExecutaComandaSql "drop table [" & rs("name") & "]"
'            ElseIf Y <= 2000 Or CInt(Y) > Year(Now()) + 1 Then
'                Set Rs2 = Db.OpenResultset("Select Count(*) n from [" & rs("name") & "] ")
'                If Rs2.EOF Then ExecutaComandaSql "drop table [" & rs("name") & "]"
'                If Not Rs2.EOF And Rs2(0) = 0 Then ExecutaComandaSql "drop table [" & rs("name") & "]"
'            End If
        End If
        
        rs.MoveNext
    Wend

    'Servit-yy-mm-ddTrace
    'Dejamos en la BD original 24 meses
    InformaMiss "Fent neteja Servit-yy-mm-dd Del Futur"
    dataLimit = DateAdd("M", -24, Now())
    
    sql = "SELECT * "
    sql = sql & "From sys.Tables "
    sql = sql & "WHERE name like 'Servit%-%-%' "
    sql = sql & "order by name "
    
    Set rs = Db.OpenResultset(sql)
    While Not rs.EOF And Now < TempsPerNeteja
        Y = Split(rs("name"), "-")(1)
        If CInt(Y) > 80 Then
            Y = "19" & Y
        Else
            Y = "20" & Y
        End If
        InformaMiss rs("name"), True
        m = Split(rs("name"), "-")(2)
        If IsNumeric(Y) And IsNumeric(m) Then
            If CDbl(Y) > (Year(Now) + 1) Then
                ExecutaComandaSql "drop table [" & rs("name") & "]"
            End If
        End If
        rs.MoveNext
    Wend
            
    InformaMiss "Fent neteja Servit-yy-mm-ddTrace"
    dataLimit = DateAdd("M", -24, Now())
    
    sql = "SELECT * "
    sql = sql & "From sys.Tables "
    sql = sql & "WHERE name like 'Servit%-%-%Trace' "
    sql = sql & "order by name "
    
    Set rs = Db.OpenResultset(sql)
    While Not rs.EOF And Now < TempsPerNeteja
        Y = Split(rs("name"), "-")(1)
        If CInt(Y) > 80 Then
            Y = "19" & Y
        Else
            Y = "20" & Y
        End If
        InformaMiss rs("name"), True
        m = Split(rs("name"), "-")(2)
        If IsNumeric(Y) And IsNumeric(m) Then
            If DateDiff("D", DateSerial(Y, m, 15), Now) < 0 Or DateDiff("D", DateSerial(Y, m, 15), Now) > 60 Then
                ExecutaComandaSql "drop table [" & rs("name") & "]"
            End If
        End If
        rs.MoveNext
    Wend
            
    'AsientosContables_yyyy
    'Dejamos en la BD original 24 meses
    'InformaMiss "Fent neteja AsientosContables_yyyy"
    'dataLimit = DateAdd("M", -24, Now())
    
    'sql = "SELECT * "
    'sql = sql & "From sys.Tables "
    'sql = sql & "WHERE name like 'AsientosContables_%' "
    'sql = sql & "order by name "
    
    'Set Rs = Db.OpenResultset(sql)
    'While Not Rs.EOF And Now < TempsPerNeteja
    '    Y = Split(Rs("name"), "_")(1)
    '    InformaMiss Rs("name"), True
    '    If IsNumeric(Y) Then
    '        If (CInt(Y) < Year(dataLimit)) Then
    '            If CInt(Y) < 2000 Then
    '                ExecutaComandaSql "drop table [" & Rs("name") & "]"
    '            Else
    '                'Set Rs2 = Db.OpenResultset("select count(*) c from " & BakDatabase & ".dbo.[" & rs("name") & "]")
    '                'If Not Rs2.EOF Then
    '                '    If Rs2("C") = 0 Then ExecutaComandaSql "drop table " & BakDatabase & ".dbo.[" & rs("name") & "]"
    '                'End If
    '                OK = ExecutaComandaSql("select * into " & BakDatabase & ".dbo.[" & Rs("name") & "] from [" & Rs("name") & "]")
    '                If OK Then
    '                    ExecutaComandaSql "drop table [" & Rs("name") & "]"
    '                Else
    '                    ExecutaComandaSql "drop table " & BakDatabase & ".dbo.[" & Rs("name") & "]"
    '                End If
     '           End If
     '       End If
     '   End If
        
     '   Rs.MoveNext
    'Wend
            
            
    'ccFacturas_yyyy_iva
    'Dejamos en la BD original 24 meses
    InformaMiss "Fent neteja ccFacturas_yyyy_iva"
    dataLimit = DateAdd("M", -24, Now())
    
    sql = "SELECT * "
    sql = sql & "From sys.Tables "
    sql = sql & "WHERE name like 'ccFacturas_%iva' "
    sql = sql & "order by name "
    
    Set rs = Db.OpenResultset(sql)
    While Not rs.EOF And Now < TempsPerNeteja
        Y = Split(rs("name"), "_")(1)
        InformaMiss rs("name"), True
        If IsNumeric(Y) Then
            If (CInt(Y) < Year(dataLimit)) Then
                If CInt(Y) < 2000 Or CInt(Y) > Year(Now) + 1 Then
                    ExecutaComandaSql "drop table [" & rs("name") & "]"
                Else
                    OK = ExecutaComandaSql("select * into " & BakDatabase & ".dbo.[" & rs("name") & "] from [" & rs("name") & "]")
                    If OK Then
                        ExecutaComandaSql "drop table [" & rs("name") & "]"
                    Else
                        ExecutaComandaSql "drop table " & BakDatabase & ".dbo.[" & rs("name") & "]"
                    End If
                End If
            End If
        End If
        
        rs.MoveNext
    Wend
            
    'ccFacturas_yyyy_data
    'Dejamos en la BD original 24 meses
    InformaMiss "Fent neteja ccFacturas_yyyy_data"
    dataLimit = DateAdd("M", -24, Now())
    
    sql = "SELECT * "
    sql = sql & "From sys.Tables "
    sql = sql & "WHERE name like 'ccFacturas_%data' "
    sql = sql & "order by name "
    
    Set rs = Db.OpenResultset(sql)
    While Not rs.EOF And Now < TempsPerNeteja
        Y = Split(rs("name"), "_")(1)
        InformaMiss rs("name"), True
        If IsNumeric(Y) Then
            If (CInt(Y) < Year(dataLimit)) Then
                If CInt(Y) < 2000 Then
                    ExecutaComandaSql "drop table [" & rs("name") & "]"
                Else
                    OK = ExecutaComandaSql("select * into " & BakDatabase & ".dbo.[" & rs("name") & "] from [" & rs("name") & "]")
                    If OK Then
                        ExecutaComandaSql "drop table [" & rs("name") & "]"
                    Else
                        ExecutaComandaSql "drop table " & BakDatabase & ".dbo.[" & rs("name") & "]"
                    End If
                End If
            End If
        End If
        
        rs.MoveNext
    Wend

    InformaMiss "Fent neteja cdpPlanificacion_"
    dataLimit = DateAdd("M", -12, Now())
    
    sql = "SELECT * "
    sql = sql & "From sys.Tables "
    sql = sql & "WHERE name like 'cdpPlanificacion_%' "
    sql = sql & "order by name"

    Set rs = Db.OpenResultset(sql)
    While Not rs.EOF And Now < TempsPerNeteja
        Y = Split(rs("name"), "_")(1)
        InformaMiss rs("name"), True
        If IsNumeric(Y) Then
            If (CInt(Y) < Year(dataLimit)) Then
                If CInt(Y) < 2000 Then
                    ExecutaComandaSql "drop table [" & rs("name") & "]"
                Else
                    OK = ExecutaComandaSql("select * into " & BakDatabase & ".dbo.[" & rs("name") & "] from [" & rs("name") & "]")
                    If OK Then
                        ExecutaComandaSql "drop table [" & rs("name") & "]"
                    Else
                        ExecutaComandaSql "drop table " & BakDatabase & ".dbo.[" & rs("name") & "]"
                    End If
                End If
            End If
        End If
        
        rs.MoveNext
    Wend



    InformaMiss "Fent neteja Web_Chart_"
    
    sql = "SELECT * "
    sql = sql & "From sys.Tables "
    sql = sql & "WHERE name like 'Web_Chart_%' "
    sql = sql & "order by name "
    
    Set rs = Db.OpenResultset(sql)
    While Not rs.EOF And Now < TempsPerNeteja
        InformaMiss rs("name"), True
        ExecutaComandaSql "drop table [" & rs("name") & "]"
        rs.MoveNext
    Wend

    InformaMiss "Fent neteja Agenda_"
    
    sql = "SELECT * "
    sql = sql & "From sys.Tables "
    sql = sql & "WHERE name like 'Agenda_%' "
    sql = sql & "order by name "
    
    Set rs = Db.OpenResultset(sql)
    While Not rs.EOF And Now < TempsPerNeteja
        Y = Split(rs("name"), "_")(1)
        InformaMiss rs("name"), True
        If IsNumeric(Y) Then
            If (CInt(Y) < Year(Now) - 1) Then
                If CInt(Y) < 2000 Then
                    ExecutaComandaSql "drop table [" & rs("name") & "]"
                Else
                    OK = ExecutaComandaSql("select * into " & BakDatabase & ".dbo.[" & rs("name") & "] from [" & rs("name") & "]")
                    If OK Then ExecutaComandaSql "drop table [" & rs("name") & "]"
                End If
            End If
        End If
        
        rs.MoveNext
    Wend
    
    
    'codisBarresReferencies
    'Dejamos en la BD original 12 meses
    InformaMiss "Fent neteja CodisBarresReferencies"
    
    sql = "SELECT * "
    sql = sql & "From sys.Tables "
    sql = sql & "WHERE name like 'codisBarresReferencies' "
    sql = sql & "order by name "
    
    Set rs = Db.OpenResultset(sql)
    If Not rs.EOF And Now < TempsPerNeteja Then
        InformaMiss rs("name"), True
        If ExisteixTaula(BakDatabase & ".dbo.[CodisBarresReferencies]") Then
            OK = ExecutaComandaSql("insert into " & BakDatabase & ".dbo.[CodisBarresReferencies] select * from codisBarresReferencies where data < dateadd(MONTH , -12, getdate())")
        Else
            OK = ExecutaComandaSql("select * into " & BakDatabase & ".dbo.[CodisBarresReferencies] from codisBarresReferencies where data < dateadd(MONTH , -12, getdate())")
        End If
        If OK Then
            ExecutaComandaSql "delete from CodisBarresReferencies where data < dateadd(MONTH, -12, getdate())"
        End If
    End If
    
    'cajas
    'Dejamos en la BD original 12 meses
    InformaMiss "Fent neteja Cajas"
    
    sql = "SELECT * "
    sql = sql & "From sys.Tables "
    sql = sql & "WHERE name like 'cajas' "
    sql = sql & "order by name "
    
    Set rs = Db.OpenResultset(sql)
    If Not rs.EOF And Now < TempsPerNeteja Then
        InformaMiss rs("name"), True
        If ExisteixTaula(BakDatabase & ".dbo.[Cajas]") Then
            OK = ExecutaComandaSql("insert into " & BakDatabase & ".dbo.[Cajas] select * from cajas where ini < dateadd(MONTH , -12, getdate())")
        Else
            OK = ExecutaComandaSql("select * into " & BakDatabase & ".dbo.[Cajas] from cajas where ini < dateadd(MONTH , -12, getdate())")
        End If
        If OK Then
            ExecutaComandaSql "delete from Cajas where ini < dateadd(MONTH, -12, getdate())"
        End If
    End If

    'appLots
    'Dejamos en la BD original 12 meses
    InformaMiss "Fent neteja appLots"
    
    sql = "SELECT * "
    sql = sql & "From sys.Tables "
    sql = sql & "WHERE name like 'appLots' "
    sql = sql & "order by name "
    
    Set rs = Db.OpenResultset(sql)
    If Not rs.EOF And Now < TempsPerNeteja Then
        InformaMiss rs("name"), True
        If ExisteixTaula(BakDatabase & ".dbo.[AppLots]") Then
            OK = ExecutaComandaSql("insert into " & BakDatabase & ".dbo.[AppLots] select * from appLots where dataI < dateadd(MONTH , -12, getdate())")
        Else
            OK = ExecutaComandaSql("select * into " & BakDatabase & ".dbo.[AppLots] from appLots where dataI < dateadd(MONTH , -12, getdate())")
        End If
        If OK Then
            ExecutaComandaSql "delete from AppLots where dataI < dateadd(MONTH, -12, getdate())"
        End If
    End If

    'TicketsTemporalsAccions
    'Dejamos en la BD original 12 meses
    InformaMiss "Fent neteja TicketsTemporalsAccions"
    
    sql = "SELECT * "
    sql = sql & "From sys.Tables "
    sql = sql & "WHERE name like 'TicketsTemporalsAccions' "
    sql = sql & "order by name "
    
    Set rs = Db.OpenResultset(sql)
    If Not rs.EOF And Now < TempsPerNeteja Then
        InformaMiss rs("name"), True
        If ExisteixTaula(BakDatabase & ".dbo.[TicketsTemporalsAccions]") Then
            OK = ExecutaComandaSql("insert into " & BakDatabase & ".dbo.[TicketsTemporalsAccions] select * from TicketsTemporalsAccions where TmSt < dateadd(MONTH , -12, getdate())")
        Else
            OK = ExecutaComandaSql("select * into " & BakDatabase & ".dbo.[TicketsTemporalsAccions] from TicketsTemporalsAccions where TmSt < dateadd(MONTH , -12, getdate())")
        End If
        If OK Then
            ExecutaComandaSql "delete from TicketsTemporalsAccions where TmSt < dateadd(MONTH, -12, getdate())"
        End If
    End If


    'CdpDadesFichador (dejamos 2 años atras)
    Dim rsDadesFichador As rdoResultset
    
    InformaMiss "Fent neteja CdpDadesFichador"
    
    sql = "SELECT * "
    sql = sql & "From sys.Tables "
    sql = sql & "WHERE name like 'CdpDadesFichador' "
    sql = sql & "order by name "
    
    Set rs = Db.OpenResultset(sql)
    If Not rs.EOF And Now < TempsPerNeteja Then
        InformaMiss rs("name"), True
        Set rsDadesFichador = Db.OpenResultset("select distinct(year(tmst)) y from cdpdadesfichador where year(tmst) < year(getdate())-1 order by y")
        While Not rsDadesFichador.EOF
            If ExisteixTaula(BakDatabase & ".dbo.[CdpDadesFichador_" & rsDadesFichador("y") & "]") Then
                OK = ExecutaComandaSql("insert into " & BakDatabase & ".dbo.[CdpDadesFichador_" & rsDadesFichador("y") & "] select * from cdpDadesFichador where year(TmSt) = " & rsDadesFichador("y"))
            Else
                OK = ExecutaComandaSql("select * into " & BakDatabase & ".dbo.[CdpDadesFichador_" & rsDadesFichador("y") & "] from cdpDadesFichador where year(TmSt) = " & rsDadesFichador("y"))
            End If
            If OK Then
                ExecutaComandaSql "delete from cdpDadesFichador where year(TmSt) = " & rsDadesFichador("Y")
            End If
            
            rsDadesFichador.MoveNext
        Wend
    End If
    
    InformaMiss "Fent neteja Ajustes_Fichajes"
    
    sql = "SELECT * "
    sql = sql & "From sys.Tables "
    sql = sql & "WHERE name like 'Ajustes_Fichajes' "
    sql = sql & "order by name "
    
    Set rs = Db.OpenResultset(sql)
    If Not rs.EOF And Now < TempsPerNeteja Then
        InformaMiss rs("name"), True
        Set rsDadesFichador = Db.OpenResultset("select distinct(year(tmst)) y from Ajustes_Fichajes where year(tmst) < year(getdate())-1 order by y")
        While Not rsDadesFichador.EOF
            If ExisteixTaula(BakDatabase & ".dbo.[Ajustes_Fichajes_" & rsDadesFichador("y") & "]") Then
                OK = ExecutaComandaSql("insert into " & BakDatabase & ".dbo.[Ajustes_Fichajes_" & rsDadesFichador("y") & "] select * from Ajustes_Fichajes where year(TmSt) = " & rsDadesFichador("y"))
            Else
                OK = ExecutaComandaSql("select * into " & BakDatabase & ".dbo.[Ajustes_Fichajes_" & rsDadesFichador("y") & "] from Ajustes_Fichajes where year(TmSt) = " & rsDadesFichador("y"))
            End If
            If OK Then
                ExecutaComandaSql "delete from Ajustes_Fichajes where year(TmSt) = " & rsDadesFichador("Y")
            End If
            
            rsDadesFichador.MoveNext
        Wend
    End If
    
    Dim rsCodigosAccion As rdoResultset
    InformaMiss "Fent neteja CodigosDeAccion"
    
    sql = "SELECT * "
    sql = sql & "From sys.Tables "
    sql = sql & "WHERE name like 'codigosdeaccion' "
    sql = sql & "order by name "
    
    Set rs = Db.OpenResultset(sql)
    If Not rs.EOF And Now < TempsPerNeteja Then
        InformaMiss rs("name"), True
        Set rsCodigosAccion = Db.OpenResultset("select distinct(year(tmstmp)) y from CodigosDeAccion where year(tmstmp) < year(getdate()) order by y")
        While Not rsDadesFichador.EOF
            If ExisteixTaula(BakDatabase & ".dbo.[CodigosDeAccion_" & rsCodigosAccion("y") & "]") Then
                OK = ExecutaComandaSql("insert into " & BakDatabase & ".dbo.[CodigosDeAccion_" & rsCodigosAccion("y") & "] select * from CodigosDeAccion where year(tmstmp) = " & rsCodigosAccion("y"))
            Else
                OK = ExecutaComandaSql("select * into " & BakDatabase & ".dbo.[CodigosDeAccion_" & rsCodigosAccion("y") & "] from CodigosDeAccion where year(tmstmp) = " & rsCodigosAccion("y"))
            End If
            If OK Then
                ExecutaComandaSql "delete from CodigosDeAccion where year(TmSt) = " & rsCodigosAccion("Y")
            End If
            
            rsCodigosAccion.MoveNext
        Wend
    End If
    
    'Dejamos 6 meses en la tabla original
    InformaMiss "Fent neteja ccPedidos"
    Dim rsPedidos As rdoResultset
    
    sql = "SELECT * "
    sql = sql & "From sys.Tables "
    sql = sql & "WHERE name like 'ccPedidos' "
    sql = sql & "order by name "
  
    Set rs = Db.OpenResultset(sql)
    If Not rs.EOF And Now < TempsPerNeteja Then
        InformaMiss rs("name"), True
        Set rsPedidos = Db.OpenResultset("select distinct year(fecha) y, month(fecha) M from ccPedidos where fecha < dateadd(month, -6, getdate()) order by y, m")
        While Not rsPedidos.EOF
            If ExisteixTaula(BakDatabase & ".dbo.[ccPedidos_" & rsPedidos("y") & "_" & Right("0" & rsPedidos("m"), 2) & "]") Then
                OK = ExecutaComandaSql("insert into " & BakDatabase & ".dbo.[ccPedidos_" & rsPedidos("y") & "_" & Right("0" & rsPedidos("m"), 2) & "] select * from ccPedidos where year(fecha) = " & rsPedidos("y") & " and month(fecha) = " & rsPedidos("m"))
            Else
                OK = ExecutaComandaSql("select * into " & BakDatabase & ".dbo.[ccPedidos_" & rsPedidos("y") & "_" & Right("0" & rsPedidos("m"), 2) & "] from ccPedidos where year(fecha) = " & rsPedidos("y") & " and month(fecha) = " & rsPedidos("m"))
            End If
            If OK Then
                ExecutaComandaSql "delete from ccPedidos where year(fecha) = " & rsPedidos("Y") & " and month(fecha) = " & rsPedidos("m")
            End If
            
            rsPedidos.MoveNext
        Wend
    End If
    
    'Dejamos 6 meses en la tabla original
    InformaMiss "Fent neteja ccPedidosCap"
    
    sql = "SELECT * "
    sql = sql & "From sys.Tables "
    sql = sql & "WHERE name like 'ccPedidosCap' "
    sql = sql & "order by name "
  
    Set rs = Db.OpenResultset(sql)
    If Not rs.EOF And Now < TempsPerNeteja Then
        InformaMiss rs("name"), True
        Set rsPedidos = Db.OpenResultset("select distinct year(fecha) y, month(fecha) M from ccPedidosCap where fecha < dateadd(month, -6, getdate()) order by y, m")
        While Not rsPedidos.EOF
            If ExisteixTaula(BakDatabase & ".dbo.[ccPedidosCap_" & rsPedidos("y") & "_" & Right("0" & rsPedidos("m"), 2) & "]") Then
                OK = ExecutaComandaSql("insert into " & BakDatabase & ".dbo.[ccPedidosCap_" & rsPedidos("y") & "_" & Right("0" & rsPedidos("m"), 2) & "] select * from ccPedidosCap where year(fecha) = " & rsPedidos("y") & " and month(fecha) = " & rsPedidos("m"))
            Else
                OK = ExecutaComandaSql("select * into " & BakDatabase & ".dbo.[ccPedidosCap_" & rsPedidos("y") & "_" & Right("0" & rsPedidos("m"), 2) & "] from ccPedidosCap where year(fecha) = " & rsPedidos("y") & " and month(fecha) = " & rsPedidos("m"))
            End If
            If OK Then
                ExecutaComandaSql "delete from ccPedidosCap where year(fecha) = " & rsPedidos("Y") & " and month(fecha) = " & rsPedidos("m")
            End If
            
            rsPedidos.MoveNext
        Wend
    End If
    
    
    
'
'AsientosContabl
'Comptabilitzats
'FacturacioComen
'FacturacioEditB
'PedidosUltimosD
'V_Inventaris_20
'V_Moviments_200
'V_Moviments_201
'V_Venut_Previsi
'AsientosCo
'Comptabili
'Facturacio
'PedidosUlt
'pressupost
'Servit-00-
'V_Albarans
'V_Alertes_
'V_Anulats_
'V_Encarre_
'V_Estadis_
'V_Horaris_
'V_Inventar
'V_Moviment
'V_Tornat_2
'V_Venut_20
'V_Venut_Pr
            
End Sub

Sub FesNetejaTaulaBD(Taula As String, dataLimit As Date, BakDatabase As String, idx As Integer, TempsPerNeteja As Date)
    Dim sql As String
    Dim rs As rdoResultset
    Dim Y, m As String
    Dim OK As Boolean
    
    sql = "SELECT * "
    sql = sql & "From sys.Tables "
    sql = sql & "WHERE name like '" & Taula & "' "
    sql = sql & "order by name "
    
    Set rs = Db.OpenResultset(sql)
    While Not rs.EOF And Now < TempsPerNeteja
        InformaMiss rs("name"), True
        If InStr(1, rs("name"), "-") Then
        Y = Split(Split(rs("name"), "_")(idx), "-")(0)
        m = Left(Split(Split(rs("name"), "_")(idx), "-")(1), 2)
        If IsNumeric(Y) And IsNumeric(m) Then
            If Y >= 2000 And (CInt(Y) < Year(dataLimit)) Or (CInt(Y) = Year(dataLimit) And CInt(m) < Month(dataLimit)) Then
                OK = ExecutaComandaSql("select * into " & BakDatabase & ".dbo.[" & rs("name") & "] from [" & rs("name") & "]")
                If OK Then
                    ExecutaComandaSql "ALTER TABLE " & BakDatabase & ".dbo.[" & rs("name") & "] REBUILD WITH (DATA_COMPRESSION = None);"
                    ExecutaComandaSql "drop table [" & rs("name") & "]"
                End If
            ElseIf Y < 2000 Or CInt(Y) > Year(Now()) + 1 Then
                Dim rs2 As rdoResultset
                Set rs2 = Db.OpenResultset("Select Count(*) n from [" & rs("name") & "] ")
                If rs2.EOF Then ExecutaComandaSql "drop table [" & rs("name") & "]"
                If Not rs2.EOF And rs2(0) = 0 Then ExecutaComandaSql "drop table [" & rs("name") & "]"
            End If
        End If
        
        End If
        rs.MoveNext
    Wend
End Sub


Function Hb(D, hBase_L, hBase_M, hBase_X, hBase_J, hBase_V, hBase_S, hBase_D) As Double
    
     
    Hb = 0
    Select Case Weekday(D, vbMonday)
        Case 1
            Hb = Round(hBase_L * 60, 0)   'En minutos
        Case 2
            Hb = Round(hBase_M * 60, 0)
        Case 3
            Hb = Round(hBase_X * 60, 0)
        Case 4
            Hb = Round(hBase_J * 60, 0)
        Case 5
            Hb = Round(hBase_V * 60, 0)
        Case 6
            Hb = Round(hBase_S * 60, 0)
        Case 7
            Hb = Round(hBase_D * 60, 0)
    End Select
    
    
End Function

Function HiS(D, hBase_L, hBase_M, hBase_X, hBase_J, hBase_V, hBase_S, hBase_D) As Double
    Dim Hi As String, hM
     
    Hi = "8:00"
    Select Case Weekday(D, vbMonday)
        Case 1
            Hi = hBase_L
        Case 2
            Hi = hBase_M
        Case 3
            Hi = hBase_X
        Case 4
            Hi = hBase_J
        Case 5
            Hi = hBase_V
        Case 6
            Hi = hBase_S
        Case 7
            Hi = hBase_D
    End Select
    
    hM = Split(Hi, ":")
    If UBound(hM) = 1 Then
        hM = Split(Hi, ":")
        HiS = TimeSerial(hM(0), hM(0) + (Int((10 * Rnd) + 1) - 5), 5)
    Else
        HiS = TimeSerial(8, Int((10 * Rnd) + 1), 5)
    End If
    
End Function

Sub InterpretaCodigoDeAccion(codigoDeAccion As String)
    Dim rsCdA As rdoResultset
    Dim tipoCodigo As String
    
    On Error GoTo nor
    
    Set rsCdA = Db.OpenResultset("select * from  " & taulaCodigosDeAccion() & " where idCodigo='" & codigoDeAccion & "'")
    If Not rsCdA.EOF Then
        tipoCodigo = rsCdA("TipoCodigo")
        Select Case tipoCodigo
            Case "FICHAJE"
                rectificaTurnoEmail codigoDeAccion
            Case "AUTORIZACION"
                AutorizaFactura codigoDeAccion
        End Select
    End If
    
    Exit Sub
nor:
    sf_enviarMail "secrehit@hit.cat", "ana@solucionesit365.com", "ERROR INTERPRETANDO CÓDIGO DE ACCIÓN", err.Description, "", ""
End Sub

Sub MuranoExecute_TS(st As String)
On Error GoTo emailnorrR


    Db.Execute "SET LANGUAGE us_english ; " & st
    Exit Sub
emailnorrR:

'    sf_enviarMail "email@hit.cat", "ana@solucionesit365.com", "ERROR TRASPASO MURANO", st, "", ""
    Debug.Print "ERROR !! " & st
End Sub

Function NomTaulaPedidosCap() As String
    Dim sql As String

    NomTaulaPedidosCap = "ccPedidosCap"
    If Not ExisteixTaula(NomTaulaPedidosCap) Then
        sql = "CREATE TABLE [dbo].[" & NomTaulaPedidosCap & "] ("
        sql = sql & "[numPedido] [numeric](18, 0)  NOT NULL, "
        sql = sql & "[idPedido] [nvarchar](255) NOT NULL, "
        sql = sql & "[proveedor] [nvarchar](255) NULL, "
        sql = sql & "[almacen] [nvarchar](255) NULL, "
        sql = sql & "[fecha] [datetime] NULL, "
        sql = sql & "[recepcion] [datetime] NULL, "
        sql = sql & "[estado] [nvarchar](255) NULL, "
        sql = sql & "[Albaran] [nvarchar](100) NULL, "
        sql = sql & "[Enviado] [bit] NULL "
        sql = sql & ") ON [PRIMARY]"
        ExecutaComandaSql sql
    End If

End Function

Function nomTaulaPicking(dia As Date) As String
   Dim sql As String
    
   nomTaulaPicking = "Picking_" & Format(dia, "yyyy-mm")
   
   If Not ExisteixTaula(nomTaulaPicking) Then
        sql = "CREATE TABLE [" & nomTaulaPicking & "] ( "
        sql = sql & "[IdServit]  [nvarchar] (255) NULL , "
        sql = sql & "[DataServit]  [datetime] NULL , "
        sql = sql & "[Client] [float] NULL, "
        sql = sql & "[Article] [float] NULL, "
        sql = sql & "[Qtat] [float] NULL, "
        sql = sql & "[Viatge]  [nvarchar] (255) NULL , "
        sql = sql & "[Equip]  [nvarchar] (255) NULL , "
        sql = sql & "[nAlbara] [numeric] (18,0) NULL , "
        sql = sql & "[Caja] [numeric] (18,0) NULL , "
        sql = sql & "[Lote]  [nvarchar] (255) NULL , "
        sql = sql & "[Apodo] [nvarchar] (255) NULL , "
        sql = sql & "[Qui] [nvarchar] (255) NULL , "
        sql = sql & "[Quan] [datetime] NULL DEFAULT (getdate()) "
        sql = sql & ") ON [PRIMARY]"

        ExecutaComandaSql sql
   End If

End Function

Sub OptimizaSerieOracul()
    Dim rs As rdoResultset
    Dim botiga As String
    Dim fecha As Date, D As Integer
    
    botiga = ""
    Set rs = Db.OpenResultset("select distinct botiga from [" & NomTaulaMovi(Now()) & "] where botiga not in (select botiga from [ORACUL_L_PARAMS]) and botiga in (select valor1 from paramshw)")
    If rs.EOF Then
        Set rs = Db.OpenResultset("select top 1 * from [Oracul_L_Botigues] order by lastdata")
    Else
        ExecutaComandaSql "insert into [Oracul_L_Botigues] (botiga, LastData) values (" & rs("botiga") & ", getdate())"
    End If
    
    If Not rs.EOF Then
        botiga = rs("botiga")
        
        InformaMiss "Optimitzant serie botiga " & botiga, True
        
        'MATI
        InformaMiss "Optimitzant serie MATI botiga " & botiga, True
        ExecutaComandaSql "EXEC DBO.CREATE_SERIE_BOTIGA @SERIE = 'MATI', @BOTIGA = " & botiga
        ExecutaComandaSql "EXEC DBO.OPTIMIZE_SERIE @SERIE = 'MATI', @BOT = " & botiga & ", @DATA1 = NULL, @DATA2 = NULL, @EPOQUES = 3, @UPDATE_CONFIG = 1"
        ExecutaComandaSql "EXEC DBO.TRAIN_SERIE @SERIE = 'MATI', @BOT = " & botiga & ", @DATA1 = NULL, @DATA2 = NULL, @EPOQUES = 3"
                        
        'TARDA
        InformaMiss "Optimitzant serie TARDA botiga " & botiga, True
        ExecutaComandaSql "EXEC DBO.CREATE_SERIE_BOTIGA @SERIE = 'TARDA', @BOTIGA = " & botiga
        ExecutaComandaSql "EXEC DBO.OPTIMIZE_SERIE @SERIE = 'TARDA', @BOT = " & botiga & ", @DATA1 = NULL, @DATA2 = NULL, @EPOQUES = 3, @UPDATE_CONFIG = 1"
        ExecutaComandaSql "EXEC DBO.TRAIN_SERIE @SERIE = 'TARDA', @BOT = " & botiga & ", @DATA1 = NULL, @DATA2 = NULL, @EPOQUES = 3"
        
        ExecutaComandaSql "update [Oracul_L_Botigues] set LastData=getdate() where botiga = " & botiga
    End If
End Sub

Sub previsions()

    Informa "Calculant Previsions"
    
'    If UCase(EmpresaActual) = UCase("Tena") Then Exit Sub
    
    PrevisioVendes
    
    
End Sub

Sub PrevisionsVendesSetmanal()
    Dim rs As rdoResultset
    Dim botiga As String
    Dim fecha As Date, D As Integer
    
    'Para asegurarnos de que existen todas las tablas de movimientos
    fecha = DateAdd("d", 7, Now())  'El lunes siguiente
    For D = 0 To 13
        NomTaulaMovi (DateAdd("d", D, fecha))
    Next
        
    
    Set rs = Db.OpenResultset("select c.Codi as botiga ,w.codi as llicencia from clients c join paramshw w on c.Codi = w.Valor1")
    While Not rs.EOF
        botiga = rs("botiga")
        ExecutaComandaSql "EXEC DBO.UPDATE_SERIE_FINS_AVUI @SERIE = 'MATI', @BOTIGA = " & botiga
        ExecutaComandaSql "EXEC DBO.CALCULA_PREDICCION_SEMANAL @SERIE = 'MATI', @BOTIGA = " & botiga
    
        ExecutaComandaSql "EXEC DBO.UPDATE_SERIE_FINS_AVUI @SERIE = 'TARDA', @BOTIGA = " & botiga
        ExecutaComandaSql "EXEC DBO.CALCULA_PREDICCION_SEMANAL @SERIE = 'TARDA', @BOTIGA = " & botiga
    
        rs.MoveNext
    Wend


End Sub
Sub PrevisionsVendesDiari(botiga As String, fecha As Date, serie As String)
    Dim rsOracul As rdoResultset
    Dim rsCaixa As rdoResultset, rsPctObj As rdoResultset, pctObj As Double
    Dim rsPrevision As rdoResultset
    
    'If UCase(EmpresaActual) = UCase("Tena") Or UCase(EmpresaActual) = UCase("Pa natural") Or UCase(EmpresaActual) = UCase("Carne") Then
    
        Set rsOracul = Db.OpenResultset("SELECT * FROM [ORACUL_L_PARAMS] WHERE BOTIGA = " & botiga & " and id = 'BASE_" & serie & "'")
        If Not rsOracul.EOF Then
            'PREVISIÓN LLUIS -----------------------------------------------------------------------------------------------------------------------------------
            ExecutaComandaSql "EXEC DBO.UPDATE_SERIE_FINS_AVUI @SERIE = '" & serie & "', @BOTIGA = " & botiga
           
            'Para asegurarnos de que existe la tabla de movimientos
            NomTaulaMovi (fecha)
                     
            ExecutaComandaSql "EXEC DBO.CALCULA_PREDICCION_DIARIA @DATA_PREDICT = '" & fecha & "', @SERIE = '" & serie & "', @BOTIGA = " & botiga
        
            'Semana siguiente
            NomTaulaMovi (DateAdd("d", 7, fecha))
                    
            ExecutaComandaSql "EXEC DBO.CALCULA_PREDICCION_DIARIA @DATA_PREDICT = '" & DateAdd("d", 7, fecha) & "', @SERIE = '" & serie & "', @BOTIGA = " & botiga
        
            'Semana siguiente
            NomTaulaMovi (DateAdd("d", 14, fecha))
                    
            ExecutaComandaSql "EXEC DBO.CALCULA_PREDICCION_DIARIA @DATA_PREDICT = '" & DateAdd("d", 14, fecha) & "', @SERIE = '" & serie & "', @BOTIGA = " & botiga
            
            'PREVISIÓN TEMPORAL CORONAVIRUS -----------------------------------------------------------------------------------------------------------------------------------
            pctObj = 3
            Set rsPctObj = Db.OpenResultset("select valor from constantsClient where codi = " & botiga & " and variable = 'Pct_Objetivo'")
            If Not rsPctObj.EOF Then pctObj = rsPctObj("valor")
            If Not IsNumeric(pctObj) Then pctObj = 3
            
            If serie = "MATI" Then
                Set rsCaixa = Db.OpenResultset("select isnull(SUM(IMPORT), 0) import From [" & NomTaulaMovi(DateAdd("d", -7, fecha)) & "] where tipus_moviment = 'Z' and botiga=" & botiga & " and day(data)=" & Day(DateAdd("d", -7, fecha)) & " AND datepart(hour, data)<=15")
            End If
            
            If serie = "TARDA" Then
                Set rsCaixa = Db.OpenResultset("select isnull(SUM(IMPORT), 0) import From [" & NomTaulaMovi(DateAdd("d", -7, fecha)) & "] where tipus_moviment = 'Z' and botiga=" & botiga & " and day(data)=" & Day(DateAdd("d", -7, fecha)) & " AND datepart(hour, data)>15")
            End If
            
            If Not rsCaixa.EOF Then
                'Para no machacar si hubiera una corrección manual
                Set rsPrevision = Db.OpenResultset("select * from [" & NomTaulaMovi(fecha) & "] where botiga=" & botiga & " and tipus_moviment='" & serie & "_C' AND MOTIU<>'V_2.1' and day(data)=" & Day(fecha))
                If rsPrevision.EOF Then
                    ExecutaComandaSql "INSERT INTO [" & NomTaulaMovi(fecha) & "] values (" & botiga & ", '" & fecha & "', 0, '" & serie & "_C', " & Round(rsCaixa("import") + rsCaixa("import") * (pctObj / 100), 2) & ", 'V_2.1')"
                End If
            End If
        End If
    'End If
End Sub

Sub PrevisioVendesBotigaDia(botiga As Double, dia As Date)
    Dim RsU As rdoResultset, rs As rdoResultset, rs1 As rdoResultset, rs2 As rdoResultset, Hi As Date, Hf As Date
    Dim llicencia, HotaTall, Da1 As Date, Da2 As Date, StGoal As String, Goal, Colo, i1, i2, C1, C2, n
    Dim Avisat, CagadesSeguides, TexteAvis, Fi As Boolean, Caixa As Double, ColAux As String, AvisarA As String, sql As String, cM As Double, cT As Double, Pm, Pt, DiaRef As Date
   
'Taules involucrades.....
' [V_Estadis_2016-01] Guardem els totals de vendes x dia i els estadistics
' [V_Oracul_2016-01]  Calcul de la previsió de vendes.
' [Oracul_Params]  Parameres referents a l algorisme de previsio

    'ExecutaComandaSql "Drop table [Oracul_Params]"
    If Not ExisteixTaula("Oracul_Params") Then
       sql = "CREATE TABLE [Oracul_Params] ( "
       sql = sql & " [Id]    [nvarchar](255) NOT NULL DEFAULT (newid()),"
       sql = sql & " [Tipo]  [nvarchar](255) NULL,"
       sql = sql & " [Botiga][nvarchar](255) NULL,"
       sql = sql & " [TmSt]  [datetime] DEFAULT (getdate()),"
       sql = sql & " [P1]     [numeric](18, 2) NULL,"
       sql = sql & " [P2]     [numeric](18, 2) NULL,"
       sql = sql & " [P3]     [numeric](18, 2) NULL,"
       sql = sql & " [P4]     [numeric](18, 2) NULL,"
       sql = sql & " [P5]     [numeric](18, 2) NULL,"
       sql = sql & " [Q1]     [numeric](18, 2) NULL,"
       sql = sql & " [Q2]     [numeric](18, 2) NULL,"
       sql = sql & " [Q3]     [numeric](18, 2) NULL,"
       sql = sql & " [Q4]     [numeric](18, 2) NULL,"
       sql = sql & " [Q5]     [numeric](18, 2) NULL"
       sql = sql & " ) ON [PRIMARY] "
       ExecutaComandaSql sql
    End If
    
    
    cM = CaixaMati(botiga, DateAdd("d", -7, dia))
    cT = CaixaTarda(botiga, DateAdd("d", -7, dia))
    
    CreaTaulesDadesTpv dia
    ExecutaComandaSql "Delete [" & NomTaulaMovi(dia) & "] Where botiga='" & botiga & "' and day(data)=" & Day(dia) & " and tipus_moviment = 'PrevisioMati'  "
    ExecutaComandaSql "Delete [" & NomTaulaMovi(dia) & "] Where botiga='" & botiga & "' and day(data)=" & Day(dia) & " and tipus_moviment = 'PrevisioTarda'  "
    
    
    ' LLUIS :  intentem predir les vendes del mati i les de la tarda per separat ja que son dos torns de treball que els motiven com a equips de tres o quatre dependentes
    ' aqui sota ahuries de posar l algoritme de previsio, pots accedir a l historic de caixes amb CaixaMati() i CaixaTarda()
    ' tens la taula Oracul_Params per guardar dades de tuning
    ' aquesta funcio ja s esta executant cada vespre amb la previsio per d aqui 6 dies 7 menos un per asegurar haver rebut les dades
    
    Pm = cM
    Pt = cT
    
    ' la resposta la deixarem a la taula de moviments amb el tipus_moviment PrevisioMati i PrevisioTarda
    ExecutaComandaSql "Insert into [" & NomTaulaMovi(dia) & "] (Botiga,Data,Dependenta,Tipus_Moviment,Import,Motiu) Values ('" & botiga & "'," & sqlData(DateSerial(Year(dia), Month(dia), Day(dia)) + TimeSerial(14, 0, 0)) & ",0,'PrevisioMati','" & Pm & "','V_0.0') "
    ExecutaComandaSql "Insert into [" & NomTaulaMovi(dia) & "] (Botiga,Data,Dependenta,Tipus_Moviment,Import,Motiu) Values ('" & botiga & "'," & sqlData(DateSerial(Year(dia), Month(dia), Day(dia)) + TimeSerial(21, 0, 0)) & ",0,'PrevisioTarda','" & Pt & "','V_0.0') "
    
nor:


End Sub

Sub RecalculaNumFacturaVendes()
    Dim sql As String, botiga As String
    Dim RsBot As rdoResultset
    Dim RsVen As rdoResultset
    Dim RsForats As rdoResultset
    Dim RsVenForats As rdoResultset
    Dim fAux As Date
    
On Error GoTo nor
    Set RsBot = Db.OpenResultset("select valor1 from ParamsHw")
    While Not RsBot.EOF
        botiga = RsBot("valor1")
        'Revisar si hay ventas hoy
        Set RsVen = Db.OpenResultset("select * from [" & NomTaulaVentas(Now) & "] where botiga='" & botiga & "' and day(data)=" & Day(Now))
        Set RsForats = Db.OpenResultset("select * from " & NomTaulaNumFacturaVendes(Now) & " where Botiga=" & botiga & " and data=convert(datetime, '" & CDate(Day(Now) & "/" & Month(Now) & "/" & Year(Now)) & "', 103)")
        If RsVen.EOF Then 'No hay ventas hoy
            If RsForats.EOF Then
                ExecutaComandaSql "insert into " & NomTaulaNumFacturaVendes(Now) & " (Botiga, Data, Factura) values (" & botiga & ", convert(datetime, '" & CDate(Day(Now) & "/" & Month(Now) & "/" & Year(Now)) & "', 103), -1)"
            Else
                ExecutaComandaSql "update " & NomTaulaNumFacturaVendes(Now) & " set Factura=-1 where Botiga=" & botiga & " and data=convert(datetime, '" & CDate(Day(Now) & "/" & Month(Now) & "/" & Year(Now)) & "', 103)"
            End If
        Else
            If RsForats.EOF Then
                ExecutaComandaSql "insert into " & NomTaulaNumFacturaVendes(Now) & " select " & botiga & ", convert(datetime, '" & CDate(Day(Now) & "/" & Month(Now) & "/" & Year(Now)) & "', 103), isnull(MAX(factura), 0)+1 from " & NomTaulaNumFacturaVendes(Now) & " where Factura<>-1 and Botiga=" & botiga
            Else
                sql = "Update " & NomTaulaNumFacturaVendes(Now) & " "
                sql = sql & "SET Factura = ( "
                sql = sql & "select isnull(MAX(nf.Factura),0)+1 "
                sql = sql & "FROM " & NomTaulaNumFacturaVendes(Now) & " AS nf "
                sql = sql & "where nf.Factura<>-1 and nf.Botiga=" & botiga & " and nf.data<convert(datetime, '" & CDate(Day(Now) & "/" & Month(Now) & "/" & Year(Now)) & "', 103)) "
                sql = sql & "where Botiga=" & botiga & " and data=convert(datetime, '" & CDate(Day(Now) & "/" & Month(Now) & "/" & Year(Now)) & "', 103)"
                ExecutaComandaSql sql
            End If
        End If
    
        'Repasar forats (per si han arribat vendes d'un dia anterior, només mes anterior i actual)
        fAux = CDate("01/" & Month(DateAdd("m", -1, Now)) & "/" & Year(DateAdd("m", -1, Now)))
        While fAux <= Now
            Set RsForats = Db.OpenResultset("select * from " & NomTaulaNumFacturaVendes(fAux) & " where Botiga=" & botiga & " and data=convert(datetime, '" & fAux & "', 103)")
            If RsForats.EOF Then 'No hi ha registre
                Set RsVenForats = Db.OpenResultset("select * from [" & NomTaulaVentas(fAux) & "] where Botiga='" & botiga & "' and day(data)=" & Day(fAux))
                If RsVenForats.EOF Then 'No hay ventas
                    ExecutaComandaSql "insert into " & NomTaulaNumFacturaVendes(fAux) & " (Botiga, Data, Factura) values (" & botiga & ", convert(datetime, '" & fAux & "', 103), -1)"
                Else
                    ExecutaComandaSql "insert into " & NomTaulaNumFacturaVendes(fAux) & " (Botiga, Data, Factura) select " & botiga & ", convert(datetime, '" & fAux & "', 103), isnull(MAX(factura), 0)+1 from " & NomTaulaNumFacturaVendes(fAux) & " where Factura<>-1 and Botiga=" & botiga & " and data < convert(datetime, '" & fAux & "', 103)"
                    ExecutaComandaSql "update " & NomTaulaNumFacturaVendes(fAux) & " set Factura = Factura + 1 where Factura<>-1 and Botiga=" & botiga & " and data > convert(datetime, '" & fAux & "', 103)"
                End If
            Else
                If RsForats("Factura") = -1 Then 'Hi ha registre a -1
                    Set RsVenForats = Db.OpenResultset("select * from [" & NomTaulaVentas(fAux) & "] where Botiga='" & botiga & "' and day(data)=" & Day(RsForats("Data")))
                    If Not RsVenForats.EOF Then 'Hay ventas
                        sql = "Update " & NomTaulaNumFacturaVendes(fAux) & " "
                        sql = sql & "SET Factura = ( "
                        sql = sql & "select isnull(MAX(nf.Factura),0)+1 "
                        sql = sql & "FROM " & NomTaulaNumFacturaVendes(fAux) & " AS nf "
                        sql = sql & "where nf.Factura<>-1 and nf.Botiga=" & botiga & " and nf.data<convert(datetime, '" & fAux & "', 103)) "
                        sql = sql & "where Botiga=" & botiga & " and data=convert(datetime, '" & fAux & "', 103) "
                        ExecutaComandaSql sql
                        
                        ExecutaComandaSql "update " & NomTaulaNumFacturaVendes(fAux) & " set Factura = Factura + 1 where Botiga=" & botiga & " and data > convert(datetime, '" & fAux & "', 103) and Factura<>-1"
                    End If
                End If
            End If
            fAux = DateAdd("d", 1, fAux)
        Wend
        
        RsBot.MoveNext
    Wend
    
nor:
End Sub


Sub FesFeinesPerFerCadaHora()

    

End Sub

Sub RebaixaEstocksConjelador()
    Dim D As Date, Df As Date, Avui As Date
    Dim rs As rdoResultset, Rs3 As rdoResultset, RsLot As rdoResultset
    Dim sql As String, Lote As String, Apodo As String
    Dim i As Integer, qs As Integer
    Dim finLote As Boolean
    
On Error Resume Next

    D = DateAdd("d", -10, Now())
    Df = DateAdd("d", 2, Now())
    'Avui = DateSerial(Year(Now()), Month(Now()), Day(Now()))
    Avui = DateSerial(Year(Df), Month(Df), Day(Df))
    D = DateSerial(Year(D), Month(D), Day(D))
    'D = DateSerial(2015, 10, 1)
    While D <= Avui
        InformaMiss "Assignant caixes Data:  " & D, True
        
        'Actualiza números de albarán
        ActualitzaNumAlbarans D
        
        'Lista de servits de productos etiquetados (con lote y caja)
        Set rs = Db.OpenResultset("Select *, SUBSTRING (comentari, CHARINDEX( '[IdAlbara:',comentari, 0)+10, (CHARINDEX( ']', comentari, CHARINDEX( '[IdAlbara:',comentari, 0)+10))-(CHARINDEX( '[IdAlbara:',comentari, 0)+10)) Albara From [" & DonamNomTaulaServit(D) & "] where QuantitatServida > 0 and CodiArticle in ( select distinct(plu) from cajas where facturada= 0 and ini <= convert(datetime,'" & D & " 23:59:59',103) ) and not Comentari like '%Lote:%' and Comentari like '%\[IdAlbara:%' escape '\' order by timestamp")
        
        While Not rs.EOF
            qs = 0
                          
            Set RsLot = Db.OpenResultset("select id, nom, apodo, Datai from applots where plu = '" & rs("CodiArticle") & "' and datai <= convert(datetime,'" & D & " 23:59:59',103) and dataF is null order by datai ")
            While Not RsLot.EOF And qs < rs("QuantitatServida")
                finLote = False
                Lote = RsLot("nom")
                Apodo = RsLot("apodo")
                
                'Sacar una caja del congelador por cada unidad (marcar facturada=1)
                While qs < rs("QuantitatServida") And Not finLote
                    'CUIDADO CajasLote y Cajas no siempre esta el número entero de la caja (20000...)

                    sql = "Select top 1 c.caja, c.ini "
                    sql = sql & "From cajas c "
                    sql = sql & "left join cajasLote cL on c.plu = cL.Plu and c.caja = cL.Caja "
                    'sql = sql & "left join cajasLote cL on c.plu = cL.Plu and left('200000000000', 12-LEN(c.caja)) + cast(c.caja as varchar) = cL.Caja "
                    sql = sql & "where cL.Lote='" & Lote & "' and cL.Apodo='" & Apodo & "' and c.plu = " & rs("CodiArticle") & " And c.facturada= 0 and c.ini <= Convert(datetime,'" & D & " 23:59:59',103) "
                    sql = sql & "order by c.ini"

                    Set Rs3 = Db.OpenResultset(sql)
                    If Not Rs3.EOF Then
                       'Asigna lote en servit
                       If qs = 0 Then ExecutaComandaSql "Update [" & DonamNomTaulaServit(D) & "] set comentari = left(comentari + '[Lote:" & Lote & Apodo & "]' , 250) where id = '" & rs("Id") & "' "
                        
                       ExecutaComandaSql "Update Cajas Set fin= Convert(datetime,'" & D & "',103) ,Facturada=1 , estado= " & rs("Albara") & " Where caja = " & Rs3("Caja") & " "
                        qs = qs + 1
                    Else 'Fin del lote
                       ExecutaComandaSql "Update AppLots set dataF = GETDATE() where id='" & RsLot("id") & "'"
                       finLote = True
                    End If
                Wend
                RsLot.MoveNext
            Wend
            
            
            rs.MoveNext
        Wend
        D = DateAdd("d", 1, D)
    Wend
    

End Sub


Sub ActualitzaNumAlbarans(fecha As Date)
    Dim tServit As String, sql As String, cliente As String
    Dim rs As rdoResultset, rsCli As rdoResultset
    
    tServit = "[" & DonamNomTaulaServit(fecha) & "]"
    ExecutaComandaSql "update " & tServit & " set comentari = '' where comentari is null"
    
    Set rsCli = Db.OpenResultset("select distinct client from " & tServit)
    
    While Not rsCli.EOF
        cliente = rsCli("client")
        
        Set rs = Db.OpenResultset("select * from " & tServit & " where comentari not like '%Albara:%' and client='" & cliente & "'")
        If Not rs.EOF Then
            sql = "Update S set comentari = left('[IdAlbara:' + cast(a.Codi as nvarchar) +  ']' + comentari, 255)  "
            sql = sql & "From " & tServit & " s "
            sql = sql & "join " & DonamNomTaulaAlbaransNum(fecha) & " a "
            sql = sql & "on isnull(s.viatge, '') = isnull(a.viatge, '') and s.client = a.client and Not Comentari like '%Albara:%' and day(a.data) = " & Day(fecha) & " and month(a.data)= " & Month(fecha) & " "
            sql = sql & "where s.client = '" & cliente & "'"
            ExecutaComandaSql sql
            
            sql = "insert into " & DonamNomTaulaAlbaransNum(fecha) & " (Data,Client,Viatge) "
            sql = sql & "Select distinct '" & Day(fecha) & "/" & Month(fecha) & "/" & Year(fecha) & "',client,viatge "
            sql = sql & "from " & tServit & " "
            sql = sql & "Where Not Comentari like '%Albara:%' and client = '" & cliente & "'"
            ExecutaComandaSql sql
    
            sql = "Update S set comentari = left('[IdAlbara:' + cast(a.Codi as nvarchar) +  ']' + comentari, 255)  "
            sql = sql & "From " & tServit & " s "
            sql = sql & "join " & DonamNomTaulaAlbaransNum(fecha) & " a "
            sql = sql & "on isnull(s.viatge, '') = isnull(a.viatge, '') and s.client = a.client and Not Comentari like '%Albara:%' and day(a.data) = " & Day(fecha) & " and month(a.data)= " & Month(fecha) & " "
            sql = sql & "where s.client = '" & cliente & "'"
            ExecutaComandaSql sql
        End If
        rsCli.MoveNext
    Wend
End Sub

Sub RebaixaEstocksMateriesPrimeres()
    Dim sql As String, D As Date, Avui As Date, rs As rdoResultset, Rs3 As rdoResultset, Comen As String, i As Integer
    Dim qs As Integer, stk As Integer

On Error Resume Next


    Informa "Rebaixant Stock Materies Primes"
    
    D = DateAdd("d", -40, Now())
    Avui = DateSerial(Year(Now()), Month(Now()), Day(Now()))
    D = DateSerial(Year(D), Month(D), Day(D))
    'D = DateSerial(2012, 11, 28)

    While D <= Avui
        InformaMiss "Rebaixant Stock:  " & D, True
        Set rs = Db.OpenResultset("Select s.Id IdServit, s.QuantitatServida, ap.valor MatPri From [" & DonamNomTaulaServit(D) & "] s left join articlesPropietats ap on s.CodiArticle=ap.codiarticle and ap.variable='MatPri' where ap.valor in (select id from ccmateriasprimas)  and id not in (select IdServit from " & TaulaStockSortides() & ") order by timestamp")
        While Not rs.EOF
            qs = rs("QuantitatServida")

            Set Rs3 = Db.OpenResultset("Select s.id, isnull(ss.queden, s.cantidad) cantidad from ccStock s left join (select idStock, MIN(queden) queden from ccStockSortides group by idstock) ss on s.id=ss.idStock where fechaEntrada <= Convert(datetime,'" & D & "',103) and  matprima='" & rs("MatPri") & "' and estado='DENTRO' order by fechaEntrada")
            While Not Rs3.EOF And qs > 0
            'If Rs3("id") = "0B7E9318-8D22-4A4D-AB43-B8B8AFD7A9DE" Then
            '    Comen = "para"
            'End If
                stk = Rs3("cantidad")
                If qs >= stk Then
                    ExecutaComandaSql "insert into " & TaulaStockSortides() & " (idStock, idServit, TaulaServit, Quantitat, Queden) values ('" & Rs3("Id") & "', '" & rs("IdServit") & "', '" & DonamNomTaulaServit(D) & "', " & stk & ", 0)"
                    ExecutaComandaSql "update ccStock set fechaSalida=getdate(), estado='FUERA' where id='" & Rs3("Id") & "'"
                    qs = qs - stk
                Else
                    ExecutaComandaSql "insert into " & TaulaStockSortides() & " (idStock, idServit, TaulaServit, Quantitat, Queden) values ('" & Rs3("Id") & "', '" & rs("IdServit") & "', '" & DonamNomTaulaServit(D) & "', " & qs & ", " & stk - qs & ")"
                    qs = 0
                End If
                Rs3.MoveNext
            Wend
            
            rs.MoveNext
        Wend
        D = DateAdd("d", 1, D)
    Wend
    
End Sub



Sub AfageixArticlesATeclat()
    Dim rs As rdoResultset, pos
    Dim nivell As String
    Dim Lastambient As String
    Dim AmbientN As String
    Set rs = Db.OpenResultset("Select a.codi,'02Nuevo ' + nombreseccion Ambient from dat_articulo da join  articles a on a.NOM = da.descripcion join dat_seccion s on da.idseccion = s.idseccion left join TeclatsTpv t on t.Article = a.codi  and rtrim(ltrim(nombreseccion)) = rtrim(ltrim(right(t.Ambient,LEN(t.ambient) - 2 ))) and Llicencia =535 and Data = '2012-03-01 18:56:54'  where t.Ambient is null  and nombreseccion in (select rtrim(ltrim(right(Ambient,LEN(ambient) - 2 ))) from TeclatsTpv where Llicencia =535 and Data = '2012-03-01 18:56:54' )  order by Ambient")
    Set rs = Db.OpenResultset("Select a.codi,'02Nuevo ' + nombreseccion Ambient from dat_articulo da join  articles a on a.NOM = da.descripcion join dat_seccion s on da.idseccion = s.idseccion left join TeclatsTpv t on t.Article = a.codi  and rtrim(ltrim(nombreseccion)) = rtrim(ltrim(right(t.Ambient,LEN(t.ambient) - 2 ))) and Llicencia =535 where t.Ambient is null  and nombreseccion in (select rtrim(ltrim(right(Ambient,LEN(ambient) - 2 ))) from TeclatsTpv where Llicencia =535 )  order by Ambient")
'    Pos = 0
'    nivell = ""
'    Lastambient = ""
'    While Not Rs.EOF
'        If Pos = 36 Then
'            If nivell = "" Then nivell = 0
'            nivell = nivell + 1
'            Pos = 0
'        End If
'        If Not Lastambient = Rs("Ambient") Then
'            Pos = 0
'            nivell = ""
'        End If
'        AmbientN = Rs("Ambient")
'        AmbientN = "03*" & Right(AmbientN, Len(AmbientN) - 8)
'        ExecutaComandaSql "insert into teclatstpv (Data,Llicencia,Maquina,Ambient,Article,Pos,color) values ('2012-03-01 18:56:54.000',535,0,'" & AmbientN & nivell & "'," & Rs("Article") & "," & Pos & ",1215231) "
'        Pos = Pos + 1
'        Lastambient = Rs("Ambient")
'        Rs.MoveNext
'    Wend
    
    Set rs = Db.OpenResultset("select * from TeclatsTpv Where Llicencia = 535  and Ambient in (select distinct a.ambient from (select * from TeclatsTpv Where Llicencia = 535 ) a join (select * from TeclatsTpv Where Llicencia = 535 ) b on a.Ambient = b.Ambient and a.Pos = b.Pos and not a.Article = b.Article ) order by Ambient,Pos")
    pos = 0
    nivell = ""
    Lastambient = ""
    While Not rs.EOF
        If Not Lastambient = rs("Ambient") Then
            pos = 0
            nivell = ""
        End If
        If pos = 36 Then
            If nivell = "" Then nivell = 0
'            nivell = nivell + 1
'            Pos = 0
        End If
        ExecutaComandaSql "Update teclatstpv Set Maquina = " & pos & " Where Llicencia = 535 And Ambient = '" & rs("Ambient") & "' And Article = '" & rs("Article") & "' and Pos = '" & rs("Pos") & "' and color = '" & rs("Color") & "' "
        pos = pos + 1
        Lastambient = rs("Ambient")
        rs.MoveNext
    Wend
    
    
End Sub

Sub AsientoAddInit()
    
End Sub

Sub DadesExportaCpFlush()
    Dim f
    
    DadesExportaCp = Replace(DadesExportaCp, "NoSeSiMoU", "U")

    If Len(DadesExportaCp) > 0 Then
        f = FreeFile
        Open nomFileTemp For Append As #f
        Print #f, DadesExportaCp;
        DadesExportaCp = ""
        Close f
    End If
    
End Sub

Sub DadesExportaCpGet()
    Dim f, L
    
    DadesExportaCpFlush
    f = FreeFile
    DadesExportaCp = ""
    If Len(Dir(nomFileTemp)) > 0 Then
        Open nomFileTemp For Input As #f
        While Not EOF(f)
            Line Input #f, L
            DadesExportaCp = DadesExportaCp & L & Chr(13) & Chr(10)
            DoEvents
        Wend
    End If
    
End Sub

Function EmailAvissos() As String
    Dim rs
    
    Set rs = Db.OpenResultset("select * from constantsempresa where camp='AvisarComandaEmail'")
    If Not rs.EOF Then
        If rs("valor") = "on" Then
            Set rs = Db.OpenResultset("select * from constantsempresa where camp='emailAvisComanda'")
            If Not rs.EOF Then
                If rs("valor") <> "" Then
                    EmailAvissos = rs("valor")
                End If
            End If
        End If
    End If

End Function

Sub enviaEmailTasca(iD As String)
    Dim de As String, para As String, asunto As String, cuerpo As String, EmpresaNom As String
    Dim rsInc As rdoResultset
    Dim rsE As rdoResultset
    Dim sql As String
    
    InformaMiss "enviaEmailTasca ", True
     
    If iD <> "" Then
    sql = "select isnull(re.valor, isnull(cc.valor, '')) para, isnull(de1.valor, '') de, isnull(c.nom, '') client, isnull(d.nom, '') nomTecnic, i.*  "
    sql = sql & "from incidencias i "
    sql = sql & "left join dependentes d on  d.CODI=i.tecnico "
    sql = sql & "left join dependentesExtes de1 on i.Tecnico = de1.id and de1.nom='EMAIL' "
    sql = sql & "left join constantsclient cc on i.Cliente=cast(cc.Codi as varchar) and Variable = 'eMail' "
    sql = sql & "left join recursosExtes re on re.Id = i.Recurso and re.Variable='EMAIL' "
    sql = sql & "left join clients c on i.Cliente = cast(c.Codi as varchar) "
    sql = sql & "where i.Id='" & iD & "' "
    Set rsInc = Db.OpenResultset(sql, rdConcurRowVer)
    
    If Not rsInc.EOF Then
        If rsInc("de") <> "" And rsInc("para") <> "" Then
            Set rsE = Db.OpenResultset("select * from constantsempresa where Camp=(select valor + 'Nom' from constantsempresa where Camp='Predeterminada')")
            If Not rsE.EOF Then EmpresaNom = rsE("valor")
            asunto = EmpresaNom & ".Petició " & Left(rsInc("tipo"), 1) & iD & " "
            If rsInc("estado") = "Pendiente" Then
                asunto = asunto & " registrada."
            ElseIf rsInc("estado") = "Resuelta" Then
                asunto = asunto & " solventada."
            End If

            cuerpo = cuerpo & "PETICIÓ : " & Left(rsInc("Tipo"), 1) & iD & "<br>"
            cuerpo = cuerpo & "CLIENT  : " & rsInc("client") & " (" & rsInc("contacto") & ")<br>"
            cuerpo = cuerpo & "DATA    : " & rsInc("timestamp") & "<br>"
            cuerpo = cuerpo & "ESTAT   : " & rsInc("estado") & "<br><br>"

            cuerpo = cuerpo & DameValor(rsInc, "incidencia") & "<br><br>"
            cuerpo = cuerpo & DameValor(rsInc, "observaciones") & "<br><br>"
            
            cuerpo = cuerpo & "SALUTACIONS,<br><br>"

            cuerpo = cuerpo & rsInc("nomTecnic") & "<br><br>"
            cuerpo = cuerpo & EmpresaNom & "<br><br>"
            'Email per al client
            sf_enviarMail rsInc("de"), rsInc("para"), asunto, cuerpo, "", ""
            'Copia per al creador
            sf_enviarMail rsInc("de"), rsInc("de"), asunto, cuerpo, "", ""
        End If
    End If
    End If
    cuerpo = ""
End Sub
Sub enviaEmailSeguimentMURANO(Optional subj As String, Optional emailD As String, Optional empresa As String)
    Dim asunto As String, cuerpo As String, sql As String, cuerpoTmp As String, hayError As Boolean
    Dim rsEmp As rdoResultset, rsEmpHit As rdoResultset, rs As rdoResultset, rsBots As rdoResultset
    Dim rsHit As rdoResultset, rsMurano As rdoResultset, rsFac As rdoResultset, rsFacR As rdoResultset, rsBancs As rdoResultset
    Dim fecha As Date
    Dim cEmpresaHit As String
    Dim arrBots() As String, arrBotsNom() As String, b As Integer
    Dim impH As Double, impM As Double, impIRPF_H As Double, impIRPF_M As Double, impHTar As Double, impHTkR As Double
    Dim nFactura As String, fFactura As Date, descError As String
    Dim rsHist As rdoResultset, rsImportacio As rdoResultset, rsProv As rdoResultset
    Dim SqlMur As String
    Dim codiProv As String
    Dim totalVendesH As Double, totalVendesM As Double, totalDespesesH As Double, totalDespesesM As Double, totalDesquadreH As Double, totalDesquadreM As Double, totalTkrsH As Double, totalTkrsM As Double, totalSortidaH As Double, totalSortidaM As Double, totalMetalicH As Double, totalMetalicM As Double
    Dim totalBasesH As Double, totalBasesM As Double
    Dim TeRetencio As Boolean
    Dim pctRetencio As Double
    Dim B1 As Double, B2 As Double, B3 As Double, B4 As Double
    Dim tabsFacturacio As String, m As Integer
    Dim codigoEmpresa As String
    
    dbSage = "[silema_Ts].sage"

    On Error GoTo ErrData
    fecha = CDate(Split(subj, " ")(2))
    If Year(fecha) > Year(Now()) Then GoTo ErrData
    GoTo OkData
    
ErrData:
    fecha = DateAdd("d", -1, Now())
    
OkData:

On Error GoTo err:

    InformaMiss "enviaEmailSeguimentMURANO ", True
    
    If InStr(UCase(subj), UCase("Empresa ")) Then
        codigoEmpresa = Split(UCase(subj), UCase("Empresa "))(1)
    End If
    
    If UCase(empresa) = UCase("FAC_HITRS") Then
        SqlMur = "select CodigoEmpresa, Empresa, cifDni from " & dbSage & ".dbo.empresas where Codigoempresa = 50"
    Else
        If codigoEmpresa = "" Then
            SqlMur = "select CodigoEmpresa, Empresa, cifDni from " & dbSage & ".dbo.empresas where Codigoempresa < 20"
        Else
            SqlMur = "select CodigoEmpresa, Empresa, cifDni from " & dbSage & ".dbo.empresas where Codigoempresa = " & codigoEmpresa
        End If
    End If
    
    Set rsEmp = Db.OpenResultset(SqlMur)
    While Not rsEmp.EOF
    
        Set rsEmpHit = Db.OpenResultset("select * from constantsEmpresa where valor='" & rsEmp("cifDni") & "'")
        If Not rsEmpHit.EOF Then
            cEmpresaHit = "0"
            If InStr(rsEmpHit("camp"), "_") Then
                cEmpresaHit = Split(rsEmpHit("camp"), "_")(0)
            End If
            
            asunto = "INFORME TRASPASO " & rsEmp("Empresa") & " DIA " & Format(fecha, "dd-mm-yyyy")
            cuerpo = "<H2>INFORME TRASPASO " & rsEmp("Empresa") & " DIA " & Format(fecha, "dd-mm-yyyy") & "</H2><br>"
    
            cuerpo = cuerpo & "<BR><BR>"
            Set rs = Db.OpenResultset("select count (distinct asiento) OK from " & dbSage & ".dbo.A_IMPORTACIO_ASSENTAMENTS where codigoEmpresa=" & rsEmp("CodigoEmpresa") & " and StatusTraspasadoIME=1 and day(fechaGrabacion)=" & Day(fecha) & " and month(fechaGrabacion)=" & Month(fecha) & " and year(fechaGrabacion)=" & Year(fecha))
            If Not rs.EOF Then cuerpo = cuerpo & "<B>ASIENTOS CORRECTOS " & rs("OK") & "</B><br>"
            Set rs = Db.OpenResultset("select count (distinct asiento) KO from " & dbSage & ".dbo.A_IMPORTACIO_ASSENTAMENTS where codigoEmpresa=" & rsEmp("CodigoEmpresa") & " and StatusTraspasadoIME=2 and day(fechaGrabacion)=" & Day(fecha) & " and month(fechaGrabacion)=" & Month(fecha) & " and year(fechaGrabacion)=" & Year(fecha))
            If Not rs.EOF Then cuerpo = cuerpo & "<B>ASIENTOS INCORRECTOS " & rs("KO") & "</B><br>"
            Set rs = Db.OpenResultset("select count (distinct asiento) Pendents from " & dbSage & ".dbo.A_IMPORTACIO_ASSENTAMENTS where codigoEmpresa=" & rsEmp("CodigoEmpresa") & " and StatusTraspasadoIME=0 and day(fechaGrabacion)=" & Day(fecha) & " and month(fechaGrabacion)=" & Month(fecha) & " and year(fechaGrabacion)=" & Year(fecha))
            If Not rs.EOF Then cuerpo = cuerpo & "<B>ASIENTOS PENDIENTES " & rs("Pendents") & "</B><br>"
    
            sql = "select cc.Valor, c.Codi, c.Nom "
            sql = sql & "from constantsclient cc "
            sql = sql & "left join clients c on cc.Codi=c.codi "
            sql = sql & "where cc.variable = 'EmpresaVendes' and cc.Codi in (select valor1 from ParamsHw) and c.codi is not null and cc.valor='" & cEmpresaHit & "' "
            sql = sql & "order by cc.Valor, c.nom"
            Set rsBots = Db.OpenResultset(sql)
            
            b = 0
            ReDim arrBots(b)
            ReDim arrBotsNom(b)
            While Not rsBots.EOF
                ReDim Preserve arrBots(b)
                ReDim Preserve arrBotsNom(b)
                arrBots(b) = rsBots("Codi")
                arrBotsNom(b) = rsBots("Nom")
                
                b = b + 1
                rsBots.MoveNext
            Wend
    
            'CAJAS
            If b > 0 Then
                cuerpo = cuerpo & "<H3>CAIXES</H3>"
                
                cuerpo = cuerpo & "<TABLE CELLPADDING=""5"" CELLSPACING=""0"" BORDER=""1"">"
                cuerpo = cuerpo & "<TR><TD><B>BOTIGA</B></TD><TD COLSPAN=""2""><B>VENDES</B></TD><TD COLSPAN=""2""><B>DESPESES</B></TD><TD COLSPAN=""2""><B>DESQUADRE</B></TD><TD COLSPAN=""2""><B>TK RESTAURANT</B></TD><TD COLSPAN=""2""><B>SORTIDA CAIXA</B></TD><TD COLSPAN=""2""><B>METÀL·LIC</B></TD></TR>"
                cuerpo = cuerpo & "<TR><TD>&nbsp;</TD><TD><B>HIT</B></TD><TD><B>MURANO</B></TD><TD><B>HIT</B></TD><TD><B>MURANO</B></TD><TD><B>HIT</B></TD><TD><B>MURANO</B></TD><TD><B>HIT</B></TD><TD><B>MURANO</B></TD></TD><TD><B>HIT</B></TD><TD><B>MURANO</B></TD><TD><B>HIT</B></TD><TD><B>MURANO</B></TD></TR>"
                totalVendesH = 0: totalVendesM = 0: totalDespesesH = 0: totalDespesesM = 0: totalDesquadreH = 0: totalDesquadreM = 0: totalTkrsH = 0: totalTkrsM = 0: totalSortidaH = 0: totalSortidaM = 0: totalMetalicH = 0: totalMetalicM = 0
                For b = 0 To UBound(arrBots)
                    cuerpoTmp = ""
                    hayError = False
                    cuerpoTmp = cuerpoTmp & "<TR><TD>" & UCase(arrBotsNom(b)) & "</TD>"
                    
                    'TARGETES
                    Set rsHit = Db.OpenResultset("select isnull(sum(abs(import)), 0) import from [" & NomTaulaMovi(fecha) & "] where botiga='" & arrBots(b) & "' and day(data)=" & Day(fecha) & " and motiu like 'Pagat Targeta :%'")
                    If Not rsHit.EOF Then impHTar = rsHit("import")
                
                    'VENTAS
                    Set rsHit = Db.OpenResultset("select isnull(sum(import), 0) import from [" & NomTaulaVentas(fecha) & "] where botiga='" & arrBots(b) & "' and day(data)=" & Day(fecha))
                    If Not rsHit.EOF Then impH = rsHit("import")
                        
                    sql = "select isnull(sum(importeAsiento), 0) import from " & dbSage & ".dbo.movimientos "
                    sql = sql & "where day(fechaAsiento)=" & Day(fecha) & " and month(fechaAsiento)=" & Month(fecha) & " and year(fechaAsiento)=" & Year(fecha) & " "
                    sql = sql & "and ejercicio='" & Year(fecha) & "' and codigoEmpresa=" & rsEmp("CodigoEmpresa") & " and comentario like 'Ventas%" & arrBotsNom(b) & "%' and cargoAbono='D' "
                    Set rsMurano = Db.OpenResultset(sql)
                    If Not rsMurano.EOF Then impM = rsMurano("import")
        
                    If Abs(impH - impM) > 0.01 Or impH = 0 Then
                        cuerpoTmp = cuerpoTmp & "<TD><FONT COLOR='#FF0000'>" & FormatNumber(impH, 2) & "</FONT></TD><TD><FONT COLOR='#FF0000'>" & FormatNumber(impM, 2) & "</FONT></TD>"
                        totalVendesH = totalVendesH + impH
                        totalVendesM = totalVendesM + impM

                        hayError = True
                    Else
                        cuerpoTmp = cuerpoTmp & "<TD><FONT COLOR='#000000'>" & FormatNumber(impH, 2) & "</FONT></TD><TD><FONT COLOR='#000000'>" & FormatNumber(impM, 2) & "</FONT></TD>"
                    End If
                        
                    'GASTOS
                    Set rsHit = Db.OpenResultset("select isnull(sum(abs(import)), 0) import from [" & NomTaulaMovi(fecha) & "] where botiga='" & arrBots(b) & "' and day(data)=" & Day(fecha) & " and Tipus_moviment in ('A', 'O') and motiu not like 'Pagat Targeta%' and motiu not like 'Entrega Diària%' and motiu not like 'Sortida de Canvi%' and motiu not like 'Pagat TkRs%' and motiu not like 'Albara%' and motiu not like 'Excs.TkRs%'")
                    If Not rsHit.EOF Then impH = rsHit("import")
            
                    sql = "select isnull(sum(importeAsiento), 0) import from " & dbSage & ".dbo.movimientos "
                    sql = sql & "where day(fechaAsiento)=" & Day(fecha) & " and month(fechaAsiento)=" & Month(fecha) & " and year(fechaAsiento)=" & Year(fecha) & " "
                    sql = sql & "and ejercicio='" & Year(fecha) & "' and codigoEmpresa=" & rsEmp("CodigoEmpresa") & " and comentario like 'GASTOS%" & arrBotsNom(b) & "%' and cargoAbono='H'"
                    Set rsMurano = Db.OpenResultset(sql)
                    If Not rsMurano.EOF Then impM = rsMurano("import")
                    
                    If Abs(impH - impM) > 0.01 Then
                        cuerpoTmp = cuerpoTmp & "<TD><FONT COLOR='#FF0000'>" & FormatNumber(impH, 2) & "</FONT></TD><TD><FONT COLOR='#FF0000'>" & FormatNumber(impM, 2) & "</FONT></TD>"
                        totalDespesesH = totalDespesesH + impH
                        totalDespesesM = totalDespesesM + impM
                        
                        hayError = True
                    Else
                        cuerpoTmp = cuerpoTmp & "<TD><FONT COLOR='#000000'>" & FormatNumber(impH, 2) & "</FONT></TD><TD><FONT COLOR='#000000'>" & FormatNumber(impM, 2) & "</FONT></TD>"
                    End If
                    
                    'DESCUADRES
                    Set rsHit = Db.OpenResultset("select isnull(sum(abs(import)), 0) import from [" & NomTaulaMovi(fecha) & "] where botiga='" & arrBots(b) & "' and day(data)=" & Day(fecha) & " and Tipus_moviment = 'J'")
                    If Not rsHit.EOF Then impH = rsHit("import")
                    
                    sql = "select isnull(sum(importeAsiento), 0) import from " & dbSage & ".dbo.movimientos "
                    sql = sql & "where day(fechaAsiento)=" & Day(fecha) & " and month(fechaAsiento)=" & Month(fecha) & " and year(fechaAsiento)=" & Year(fecha) & " "
                    sql = sql & "and ejercicio='" & Year(fecha) & "' and codigoEmpresa=" & rsEmp("CodigoEmpresa") & " and comentario like 'DESCUADRE%" & arrBotsNom(b) & "%' and cargoAbono='H'"
                    Set rsMurano = Db.OpenResultset(sql)
                    If Not rsMurano.EOF Then impM = rsMurano("import")
                    If Abs(impH - impM) > 0.01 Then
                        cuerpoTmp = cuerpoTmp & "<TD><FONT COLOR='#FF0000'>" & FormatNumber(impH, 2) & "</FONT></TD><TD><FONT COLOR='#FF0000'>" & FormatNumber(impM, 2) & "</FONT></TD>"
                        totalDesquadreH = totalDesquadreH + impH
                        totalDesquadreM = totalDesquadreM + impM
                        
                        hayError = True
                    Else
                        cuerpoTmp = cuerpoTmp & "<TD><FONT COLOR='#000000'>" & FormatNumber(impH, 2) & "</FONT></TD><TD><FONT COLOR='#000000'>" & FormatNumber(impM, 2) & "</FONT></TD>"
                    End If
                    
                    'TICKETS RESTAURANT
                    Set rsHit = Db.OpenResultset("select isnull(sum(abs(import)), 0) import from [" & NomTaulaMovi(fecha) & "] where botiga='" & arrBots(b) & "' and day(data)=" & Day(fecha) & " and Tipus_moviment='O' and motiu like 'Pagat TkRs%'")
                    If Not rsHit.EOF Then impH = rsHit("import")
                    impHTkR = impH
                    
                    sql = "select isnull(sum(importeAsiento), 0) import from " & dbSage & ".dbo.movimientos "
                    sql = sql & "where day(fechaAsiento)=" & Day(fecha) & " and month(fechaAsiento)=" & Month(fecha) & " and year(fechaAsiento)=" & Year(fecha) & " "
                    sql = sql & "and ejercicio='" & Year(fecha) & "' and codigoEmpresa=" & rsEmp("CodigoEmpresa") & " and comentario like 'Cobros ticket restaurant%" & arrBotsNom(b) & "%' and cargoAbono='H'"
                    Set rsMurano = Db.OpenResultset(sql)
                    If Not rsMurano.EOF Then impM = rsMurano("import")
                    
                    If Abs(Abs(impH) - Abs(impM)) > 0.01 Then
                        cuerpoTmp = cuerpoTmp & "<TD><FONT COLOR='#FF0000'>" & FormatNumber(impH, 2) & "</FONT></TD><TD><FONT COLOR='#FF0000'>" & FormatNumber(impM, 2) & "</FONT></TD>"
                        totalTkrsH = totalTkrsH + impH
                        totalTkrsM = totalTkrsM + impM
                        
                        hayError = True
                    Else
                        cuerpoTmp = cuerpoTmp & "<TD><FONT COLOR='#000000'>" & FormatNumber(impH, 2) & "</FONT></TD><TD><FONT COLOR='#000000'>" & FormatNumber(impM, 2) & "</FONT></TD>"
                    End If
                    
                    
                    'SORTIDA DE CAIXA FORTA
                    Set rsHit = Db.OpenResultset("select isnull(sum(abs(import)), 0) import from [" & NomTaulaMovi(fecha) & "] where botiga='" & arrBots(b) & "' and day(data)=" & Day(fecha) & " and Tipus_moviment='O' and (motiu like 'Entrega Diària%' or motiu like 'Sortida de Canvi%')")
                    If Not rsHit.EOF Then impH = rsHit("import")
                    
                    sql = "select isnull(sum(importeAsiento), 0) import from " & dbSage & ".dbo.movimientos "
                    sql = sql & "where day(fechaAsiento)=" & Day(fecha) & " and month(fechaAsiento)=" & Month(fecha) & " and year(fechaAsiento)=" & Year(fecha) & " "
                    sql = sql & "and ejercicio='" & Year(fecha) & "' and codigoEmpresa=" & rsEmp("CodigoEmpresa") & " and comentario like 'SALIDA DE CAJA A CAJA FUERTE%" & arrBotsNom(b) & "%' and cargoAbono='H'"
                    Set rsMurano = Db.OpenResultset(sql)
                    If Not rsMurano.EOF Then impM = rsMurano("import")
                   
                    If Abs(impH - impM) > 0.01 Then
                        cuerpoTmp = cuerpoTmp & "<TD><FONT COLOR='#FF0000'>" & FormatNumber(impH, 2) & "</FONT></TD><TD><FONT COLOR='#FF0000'>" & FormatNumber(impM, 2) & "</FONT></TD>"
                        totalSortidaH = totalSortidaH + impH
                        totalSortidaM = totalSortidaM + impM
                        
                        hayError = True
                    Else
                        cuerpoTmp = cuerpoTmp & "<TD><FONT COLOR='#000000'>" & FormatNumber(impH, 2) & "</FONT></TD><TD><FONT COLOR='#000000'>" & FormatNumber(impM, 2) & "</FONT></TD>"
                    End If
                    
                    'COBRO EN METÁLICO
                    Set rsHit = Db.OpenResultset("select isnull(sum(abs(import)), 0) import from [" & NomTaulaMovi(fecha) & "] where botiga='" & arrBots(b) & "' and day(data)=" & Day(fecha) & " and Tipus_moviment='Z' ")
                    If Not rsHit.EOF Then impH = rsHit("import") - impHTar - impHTkR
                    
                    sql = "select isnull(sum(importeAsiento), 0) import from " & dbSage & ".dbo.movimientos "
                    sql = sql & "where day(fechaAsiento)=" & Day(fecha) & " and month(fechaAsiento)=" & Month(fecha) & " and year(fechaAsiento)=" & Year(fecha) & " "
                    sql = sql & "and ejercicio='" & Year(fecha) & "' and codigoEmpresa=" & rsEmp("CodigoEmpresa") & " and comentario like 'COBRO EN METALICO CAJA REGISTRA%" & arrBotsNom(b) & "%' and cargoAbono='H'"
                    Set rsMurano = Db.OpenResultset(sql)
                    If Not rsMurano.EOF Then impM = rsMurano("import")
                    
                    If Abs(impH - impM) > 0.01 Then
                        cuerpoTmp = cuerpoTmp & "<TD><FONT COLOR='#FF0000'>" & FormatNumber(impH, 2) & "</FONT></TD><TD><FONT COLOR='#FF0000'>" & FormatNumber(impM, 2) & "</FONT></TD>"
                        totalMetalicH = totalMetalicH + impH
                        totalMetalicM = totalMetalicM + impM
                        
                        hayError = True
                    Else
                        cuerpoTmp = cuerpoTmp & "<TD><FONT COLOR='#000000'>" & FormatNumber(impH, 2) & "</FONT></TD><TD><FONT COLOR='#000000'>" & FormatNumber(impM, 2) & "</FONT></TD>"
                    End If
                    
                    cuerpoTmp = cuerpoTmp & "</TR>"
                    If hayError Then
                        cuerpo = cuerpo & cuerpoTmp
                    End If
                    'cuerpo = cuerpo & cuerpoTmp
                Next
                cuerpo = cuerpo & "<TR><TD><B>TOTALS</B></TD><TD>" & FormatNumber(totalVendesH, 2) & "</TD><TD>" & FormatNumber(totalVendesM, 2) & "</TD><TD>" & FormatNumber(totalDespesesH, 2) & "</TD><TD>" & FormatNumber(totalDespesesM, 2) & "</TD>"
                cuerpo = cuerpo & "<TD>" & FormatNumber(totalDesquadreH, 2) & "</TD><TD>" & FormatNumber(totalDesquadreM, 2) & "</TD><TD>" & FormatNumber(totalTkrsH, 2) & "</TD><TD>" & FormatNumber(totalTkrsM, 2) & "</TD>"
                cuerpo = cuerpo & "<TD>" & FormatNumber(totalSortidaH, 2) & "</TD><TD>" & FormatNumber(totalSortidaM, 2) & "</TD><TD>" & FormatNumber(totalMetalicH, 2) & "</TD><TD>" & FormatNumber(totalMetalicM, 2) & "</TD></TR>"
                cuerpo = cuerpo & "</TABLE>"
            End If
            '~CAJAS
            
            'FACTURAS EMITIDAS
            cuerpo = cuerpo & "<H3>FACTURES EMESES " & Year(fecha) & "</H3>"
            
            cuerpo = cuerpo & "<TABLE CELLPADDING=""5"" CELLSPACING=""0"" BORDER=""1"">"
            cuerpo = cuerpo & "<TR><TD><B>FACTURA</B></TD><TD COLSPAN=""2""><B>QUOTA IRPF</B></TD><TD COLSPAN=""2""><B>BASE</B></TD><TD COLSPAN=""2""><B>TOTAL</B></TD><TD>&nbsp;</TD></TR>"
            cuerpo = cuerpo & "<TR><TD>&nbsp;</TD><TD><B>HIT</B></TD><TD><B>MURANO</B></TD><TD><B>HIT</B></TD><TD><B>MURANO</B></TD><TD><B>HIT</B></TD><TD><B>MURANO</B></TD><TD>&nbsp;</TD></TR>"
                
            'If Month(fecha) > 1 Then
            '    tabsFacturacio = ""
            '    For m = Month(fecha) - 1 To Month(fecha)
            '        If tabsFacturacio <> "" Then tabsFacturacio = tabsFacturacio & " union all "
            '        tabsFacturacio = tabsFacturacio & "select * from [facturacio_" & Year(fecha) & "-" & Right("0" & m, 2) & "_iva]"
            '    Next
            'Else
            '    tabsFacturacio = "[facturacio_" & Year(fecha) & "-01_iva]"
            'End If
            
            'Set rsFac = Db.OpenResultset("select * from (" & tabsFacturacio & ") f where empresaCodi=" & cEmpresaHit & " order by dataFactura")
            Set rsFac = Db.OpenResultset("select (case when charindex('[Retencio',isnull(reservat,'Directa'))  = 0 then 0 else 1 end) TeRetencio,isnull(baseIva1,0) B1,isnull(baseIva2,0) B2,isnull(baseIva3,0) B3,isnull(baseIva4,0) B4,isnull(Total,0) Total, * from [facturacio_" & Year(fecha) & "-" & Right("0" & Month(fecha), 2) & "_iva] f where empresaCodi=" & cEmpresaHit & " order by dataFactura")
            While Not rsFac.EOF
                nFactura = rsFac("NumFactura")
                InformaMiss nFactura, False
                fFactura = rsFac("DataFactura")
                
                impIRPF_H = 0
                pctRetencio = 0
                
                totalBasesH = rsFac("B1") + rsFac("B2") + rsFac("B3") + rsFac("B4")
                TeRetencio = rsFac("TeRetencio")
                If TeRetencio Then
                    pctRetencio = CDbl(Split(Split(rsFac("Reservat"), "[Retencio")(1), "]")(0))
                    impIRPF_H = Round(totalBasesH * (pctRetencio / 100), 2)
                End If
                
                impH = rsFac("Total")
                
                descError = ""
                impM = 0
                impIRPF_M = 0
                Set rsMurano = Db.OpenResultset("select isnull(sum(ImporteAsiento), 0) Importe from " & dbSage & ".dbo.movimientos where codigoempresa=" & rsEmp("CodigoEmpresa") & " and (rTrim(comentario) = 'F.num : " & nFactura & "' or rTrim(comentario) = 'F. num : " & nFactura & "') and cargoAbono='D' and CodigoCuenta like '43%' and day(fechaAsiento)=" & Day(fFactura) & " and month(fechaAsiento)=" & Month(fFactura) & " and year(fechaAsiento)=" & Year(fFactura) & " and NumeroPeriodo=" & Month(fecha) & " and Ejercicio=" & Year(fecha))
                If Not rsMurano.EOF Then impM = rsMurano("Importe")
                rsMurano.Close
                
                Set rsMurano = Db.OpenResultset("select isnull(sum(ImporteAsiento), 0) Importe from " & dbSage & ".dbo.movimientos where codigoempresa=" & rsEmp("CodigoEmpresa") & " and (rTrim(comentario) = 'F.num : " & nFactura & "' or rTrim(comentario) = 'F. num : " & nFactura & "') and cargoAbono='D' and CodigoCuenta like '473%' and day(fechaAsiento)=" & Day(fFactura) & " and month(fechaAsiento)=" & Month(fFactura) & " and year(fechaAsiento)=" & Year(fFactura) & " and NumeroPeriodo=" & Month(fecha) & " and Ejercicio=" & Year(fecha))
                If Not rsMurano.EOF Then impIRPF_M = rsMurano("Importe")
                rsMurano.Close
                
                'EN SAGE ESTÁN TODAS LAS BASES JUNTAS EN LA CUENTA 7000, NO SABEMOS QUE BASE CORRESPONDE A CADA IVA
                Set rsMurano = Db.OpenResultset("select isnull(sum(ImporteAsiento), 0) Importe from " & dbSage & ".dbo.movimientos where codigoempresa=" & rsEmp("CodigoEmpresa") & " and (rTrim(comentario) = 'F.num : " & nFactura & "' or rTrim(comentario) = 'F. num : " & nFactura & "') and cargoAbono='D' and CodigoCuenta like '700000000' and day(fechaAsiento)=" & Day(fFactura) & " and month(fechaAsiento)=" & Month(fFactura) & " and year(fechaAsiento)=" & Year(fFactura) & " and NumeroPeriodo=" & Month(fecha) & " and Ejercicio=" & Year(fecha))
                If Not rsMurano.EOF Then totalBasesM = rsMurano("Importe")
                rsMurano.Close
                                
                If Abs(impH - impM) > 0.5 Then
                    Set rsHist = Db.OpenResultset("select * from HistoricoExportacionMURANO_" & Year(fecha) & " where tipoExportacion='FACTURA' AND Param2 ='" & rsFac("idFactura") & "'")
                    If Not rsHist.EOF Then
                        Set rsImportacio = Db.OpenResultset("select * from " & dbSage & ".dbo.A_IMPORTACIO_ASSENTAMENTS where asiento=" & rsHist("asiento") & " and codigoEmpresa=" & rsHist("CodigoEmpresa") & " and Ejercicio=" & Year(fecha))
                        If Not rsImportacio.EOF Then
                            descError = rsImportacio("TEXTEERROR")
                        End If
                    End If
                    If descError = "" Then
                        If impM = 0 Then
                            descError = "PENDIENTE"
                        Else
                            descError = "DESQUADRADA"
                        End If
                    End If
                    If descError <> "OK" Then
                        'cuerpo = cuerpo & "<TR><TD><B>" & rsFac("Serie") & nFactura & " (" & rsFac("dataFactura") & ")</B></TD><TD><FONT COLOR='#FF0000'>" & impH & "</FONT></TD><TD><FONT COLOR='#FF0000'>" & impM & "</FONT></TD><TD><FONT COLOR='#FF0000'><B>" & descError & "</B></FONT></TD></TR>"
                        cuerpo = cuerpo & "<TR><TD><B>" & rsFac("Serie") & nFactura & " (" & rsFac("dataFactura") & ")</B></TD><TD><FONT COLOR='#FF0000'>" & impIRPF_H & "</FONT></TD><TD><FONT COLOR='#FF0000'>" & impIRPF_M & "</FONT></TD><TD><FONT COLOR='#FF0000'>" & totalBasesH & "</FONT></TD><TD><FONT COLOR='#FF0000'>" & totalBasesM & "</FONT></TD><TD><FONT COLOR='#FF0000'>" & impH & "</FONT></TD><TD><FONT COLOR='#FF0000'>" & impM & "</FONT></TD><TD><FONT COLOR='#FF0000'><B>" & descError & "</B></FONT></TD></TR>"
                    End If
                End If
                
                rsFac.MoveNext
            Wend
            rsFac.Close
            cuerpo = cuerpo & "</TABLE>"
            '~FACTURAS
            
            'FACTURAS RECIBIDAS
            cuerpo = cuerpo & "<H3>FACTURES REBUDES " & Year(fecha) & "</H3>"
            
            cuerpo = cuerpo & "<TABLE CELLPADDING=""5"" CELLSPACING=""0"" BORDER=""1"">"
            cuerpo = cuerpo & "<TR><TD><B>FACTURA</B></TD><TD COLSPAN=""2""><B>QUOTA IRPF</B></TD><TD COLSPAN=""2""><B>BASE</B></TD><TD COLSPAN=""2""><B>TOTAL</B></TD><TD>&nbsp;</TD></TR>"
            cuerpo = cuerpo & "<TR><TD>&nbsp;</TD><TD><B>HIT</B></TD><TD><B>MURANO</B></TD><TD><B>HIT</B></TD><TD><B>MURANO</B></TD><TD><B>HIT</B></TD><TD><B>MURANO</B></TD><TD>&nbsp;</TD></TR>"
            
            Set rsFacR = Db.OpenResultset("select *, isnull(baseIva1,0) B1,isnull(baseIva2,0) B2,isnull(baseIva3,0) B3,isnull(baseIva4,0) B4 from [ccFacturas_" & Year(fecha) & "_iva] where clientCodi=" & cEmpresaHit & " and month(dataFactura)= " & Month(fecha) & " order by dataFactura")
            'Set rsFacR = Db.OpenResultset("select * from [ccFacturas_" & Year(fecha) & "_iva] where month(dataFactura) in (" & Month(fecha) & ", " & Month(fecha) - 1 & ") and clientCodi=" & cEmpresaHit & " order by dataFactura")
            While Not rsFacR.EOF
                nFactura = rsFacR("NumFactura")
                fFactura = rsFacR("DataFactura")
                'If nFactura = "119" Then
                '    nFactura = "119"
                'End If
                InformaMiss nFactura, False
                
                Set rsProv = Db.OpenResultset("select * from ccproveedores where id='" & rsFacR("EmpresaCodi") & "'")
                If Not rsProv.EOF Then codiProv = Right(rsProv("codi"), 4)
                rsProv.Close
                
                totalBasesH = rsFacR("B1") + rsFacR("B2") + rsFacR("B3") + rsFacR("B4")
                
                impH = rsFacR("Total")
                impIRPF_H = Abs(rsFacR("IvaRec4"))
                
                descError = ""
                impM = 0
                
                SqlMur = "select isnull(sum(ImporteAsiento), 0) Importe from " & dbSage & ".dbo.movimientos where codigoempresa=" & rsEmp("CodigoEmpresa") & " and (rtrim(comentario) like 'F.num : " & nFactura & "' or rtrim(comentario) like 'F.num: " & nFactura & "' or rtrim(comentario) like 'F. num : " & nFactura & "') and cargoAbono='D' and CodigoCuenta not like '472%' and day(fechaAsiento)=" & Day(fFactura) & " and month(fechaAsiento)=" & Month(fFactura) & " and Ejercicio=" & Year(fFactura)
                Set rsMurano = Db.OpenResultset(SqlMur)
                If Not rsMurano.EOF Then totalBasesM = rsMurano("Importe")
                rsMurano.Close
                
                SqlMur = "select isnull(sum(ImporteAsiento), 0) Importe from " & dbSage & ".dbo.movimientos where codigoempresa=" & rsEmp("CodigoEmpresa") & " and (rtrim(comentario) like 'F.num : " & nFactura & "' or rtrim(comentario) like 'F.num: " & nFactura & "' or rtrim(comentario) like 'F. num : " & nFactura & "') and cargoAbono='H' and (CodigoCuenta like '41%" & codiProv & "' or codigoCuenta like '40%" & codiProv & "') and day(fechaAsiento)=" & Day(fFactura) & " and month(fechaAsiento)=" & Month(fFactura) & " and Ejercicio=" & Year(fFactura)
                Set rsMurano = Db.OpenResultset(SqlMur)
                If Not rsMurano.EOF Then impM = rsMurano("Importe")
                rsMurano.Close
                
                SqlMur = "select isnull(sum(ImporteAsiento), 0) Importe from " & dbSage & ".dbo.movimientos where codigoempresa=" & rsEmp("CodigoEmpresa") & " and (rtrim(comentario) like 'F.num : " & nFactura & "' or rtrim(comentario) like 'F.num: " & nFactura & "' or rtrim(comentario) like 'F. num : " & nFactura & "') and cargoAbono='H' and CodigoCuenta like '4751%' and day(fechaAsiento)=" & Day(fFactura) & " and month(fechaAsiento)=" & Month(fFactura) & " and Ejercicio=" & Year(fFactura)
                Set rsMurano = Db.OpenResultset(SqlMur)
                If Not rsMurano.EOF Then impIRPF_M = rsMurano("Importe")
                rsMurano.Close
                
                If Abs(impH - impM) > 0.5 Then
                    
                    Set rsHist = Db.OpenResultset("select * from HistoricoExportacionMURANO_" & Year(fecha) & " where tipoExportacion='FACTURA_REBUDA' AND Param2 ='" & rsFacR("idFactura") & "'")
                    If Not rsHist.EOF Then
                        SqlMur = "select * from " & dbSage & ".dbo.A_IMPORTACIO_ASSENTAMENTS where asiento=" & rsHist("asiento") & " and codigoEmpresa=" & rsHist("CodigoEmpresa") & " and Ejercicio=" & Year(fecha)
                        Set rsImportacio = Db.OpenResultset(SqlMur)
                        If Not rsImportacio.EOF Then
                            descError = rsImportacio("TEXTEERROR")
                        End If
                        rsImportacio.Close
                    End If
                    rsHist.Close
                    If descError = "" Then
                        If impM = 0 Then
                            descError = "PENDIENTE"
                        Else
                            descError = "DESQUADRADA"
                        End If
                    End If
                    If descError <> "OK" Then
                        cuerpo = cuerpo & "<TR><TD><B>" & rsFacR("Serie") & nFactura & " (" & rsFacR("dataFactura") & ")</B></TD><TD><FONT COLOR='#FF0000'>" & impIRPF_H & "</FONT></TD><TD><FONT COLOR='#FF0000'>" & impIRPF_M & "</FONT></TD><TD><FONT COLOR='#FF0000'>" & totalBasesH & "</FONT></TD><TD><FONT COLOR='#FF0000'>" & totalBasesM & "</FONT></TD><TD><FONT COLOR='#FF0000'>" & impH & "</FONT></TD><TD><FONT COLOR='#FF0000'>" & impM & "</FONT></TD><TD><FONT COLOR='#FF0000'><B>" & descError & "</B></FONT></TD></TR>"
                    End If
                End If
                
                rsFacR.MoveNext
            Wend
            rsFacR.Close
            cuerpo = cuerpo & "</TABLE>"
            '~FACTURAS
                        
            'BANCS
            'Asientos no traspasados
            cuerpo = cuerpo & "<H3>BANCS. MOVIMENTS NO TRASPASSATS</H3>"
            cuerpo = cuerpo & "<TABLE CELLPADDING=""5"" CELLSPACING=""0"" BORDER=""1"">"
            cuerpo = cuerpo & "<TR><TD><B>DATA</B></TD><TD><B>CONCEPTE</B></TD><TD><B>COMPTE</B></TD><TD><B>DEBE</B></TD><TD><B>HABER</B></TD></TR>"
            sql = "select * "
            sql = sql & "from asientoscontables_" & Year(fecha) & " a "
            sql = sql & "left join norma43 n on a.idNorma43 = n.idNorma43 "
            sql = sql & "where a.orden=1 and a.idnorma43 not like '%|%' and a.idnorma43 not in (select param1 from [HistoricoExportacionMURANO_" & Year(fecha) & "] where tipoexportacion='BANCS') "
            If cEmpresaHit = "0" Then
                sql = sql & "and Comu_numcuenta in (select valor from constantsempresa where camp = 'CampCuentaContable')"
            Else
                sql = sql & "and Comu_numcuenta in (select valor from constantsempresa where camp = '" & cEmpresaHit & "_CampCuentaContable')"
            End If
            sql = sql & "order by a.fecha"
            Set rsBancs = Db.OpenResultset(sql)
            While Not rsBancs.EOF
                cuerpo = cuerpo & "<TR><TD>" & Format(rsBancs("FECHA"), "dd/mm/yyyy") & "</TD><TD>" & rsBancs("CONCEPTO") & "</TD><TD>" & rsBancs("SUBCUENTA") & "</TD><TD>" & rsBancs("DEBE") & "</TD><TD>" & rsBancs("HABER") & "</TD></TR>"
                rsBancs.MoveNext
            Wend
            cuerpo = cuerpo & "</TABLE>"
            
            'Asientos pendientes
            cuerpo = cuerpo & "<H3>BANCS. TRASPAS PENDENT O ERRONI</H3>"
            cuerpo = cuerpo & "<TABLE CELLPADDING=""5"" CELLSPACING=""0"" BORDER=""1"">"
            cuerpo = cuerpo & "<TR><TD><B>DATA</B></TD><TD><B>CONCEPTE</B></TD><TD><B>COMPTE</B></TD><TD><B>DEBE</B></TD><TD><B>HABER</B></TD><TD><B>ESTAT</B></TD></TR>"
            Set rsBancs = Db.OpenResultset("select * from " & dbSage & ".dbo.A_IMPORTACIO_ASSENTAMENTS a left join [HistoricoExportacionMURANO_" & Year(fecha) & "] h on a.codigoempresa=h.CodigoEmpresa and a.asiento=h.asiento where h.tipoexportacion='BANCS' and a.StatusTraspasadoIME <> 1 and a.codigoempresa=" & cEmpresaHit)
            While Not rsBancs.EOF
                cuerpo = cuerpo & "<TR><TD>" & Format(rsBancs("FechaAsiento"), "dd/mm/yyyy") & "</TD><TD>" & rsBancs("Comentario") & "</TD><TD>" & rsBancs("CodigoCuenta") & "</TD>"
                If rsBancs("CargoAbono") = "D" Then
                    cuerpo = cuerpo & "<TD>" & rsBancs("ImporteAsiento") & "</TD>"
                    cuerpo = cuerpo & "<TD>0.00</TD>"
                Else
                    cuerpo = cuerpo & "<TD>0.00</TD>"
                    cuerpo = cuerpo & "<TD>" & rsBancs("ImporteAsiento") & "</TD>"
                End If
                
                If rsBancs("StatusTraspasadoIME") = 0 Then
                    cuerpo = cuerpo & "<TD>PENDENT</TD>"
                Else
                    cuerpo = cuerpo & "<TD>" & rsBancs("TEXTEERROR") & "</TD>"
                End If
                
                rsBancs.MoveNext
            Wend
            cuerpo = cuerpo & "</TABLE>"
            '~BANCS
                        
            'sf_enviarMail "emai@hit.cat", "ana@solucionesit365.com", asunto, cuerpo, "", ""
            If emailD <> "" Then
                sf_enviarMail "emai@hit.cat", emailD, asunto, cuerpo, "", ""
            Else
                sf_enviarMail "emai@hit.cat", "pjgarcia@silemabcn.com", asunto, cuerpo, "", ""
                sf_enviarMail "emai@hit.cat", "facturas@silemabcn.com", asunto, cuerpo, "", ""
            End If
            'sf_enviarMail "emai@hit.cat", "contabilidad@silemabcn.com", asunto, cuerpo, "", ""
            
        End If
        
        rsEmp.MoveNext
    Wend
    
    Exit Sub
err:
        sf_enviarMail "emai@hit.cat", "ana@solucionesit365.com", "ERROR REPORT SEGUIMIENTO MURANO", err.Description, "", ""
        If emailD <> "" Then sf_enviarMail "emai@hit.cat", emailD, "ERROR REPORT SEGUIMIENTO MURANO", "Ha habido un error.<br>Vuelve a pedir el informe.", "", ""

End Sub

Sub enviaEmailPedidoProveedor(empEMail As String, eMailProv As String, IdFile As String, nomProv As String)
    Dim rs As rdoResultset, TenimFile As Boolean, texte As String, para, P As Integer
    
    Set rs = Db.OpenResultset("select Count(*) from Archivo Where id  = '" & IdFile & "' ")
    If Not rs.EOF Then TenimFile = True
    
    If TenimFile And (empEMail <> "" Or eMailProv <> "") Then

        texte = "Adjuntamos fichero PDF con pedido. GRACIAS " & "<Br>"
        'If UCase(EmpresaActual) = UCase("FornsEnrich") Then Texte = Texte & "NO CONTESTAR AQUEST EMAIL <BR>"
        texte = texte & "" & "<Br>"
        
        para = Split(eMailProv, ";")
        For P = 0 To UBound(para)
            sf_enviarMail empEMail, Trim(para(P)), "Pedido para " & nomProv, texte, IdFile, "c:\Pedido.Pdf"
        Next
        
        sf_enviarMail "email@hit.cat", empEMail, "Enviado Pedido a " & eMailProv, texte, IdFile, "c:\Pedido.Pdf"

    Else
        sf_enviarMail "email@hit.cat", empEMail, "Error al Enviar Pedido a " & eMailProv, texte, IdFile, "c:\Pedido.Pdf"
    End If
    
    ExecutaComandaSql "Delete archivo Where id  = '" & IdFile & "' "
End Sub

Sub enviaEmailTecnicTasca(iD As String)
    Dim para() As String, asunto As String, cuerpo As String
    Dim P As Integer
    Dim rsInc As rdoResultset
    Dim sql As String
    
    InformaMiss "enviaEmailTecnicTasca ", True
     
    If iD <> "" Then

        sql = "select i.id, isnull(de1.valor, '') emailFB, isnull(c.nom, '') client,isnull(re.valor, isnull(cc.valor, '')) emailCli, "
        sql = sql & "isnull(re2.valor, '') adreca, isnull(r.Nombre, '') botiga, isnull(re3.valor, '') Tlf, i.Incidencia "
        sql = sql & "from incidencias i "
        sql = sql & "left join dependentesExtes de1 on i.Tecnico = de1.id and de1.nom='EMAIL' "
        sql = sql & "left join constantsclient cc on i.Cliente=cast(cc.Codi as varchar) and Variable = 'eMail' "
        sql = sql & "left join recursos r on r.Id = i.recurso "
        sql = sql & "left join recursosExtes re on re.Id = i.Recurso and re.Variable='EMAIL' "
        sql = sql & "left join recursosExtes re2 on re2.Id = i.Recurso and re2.Variable='DIRECCION' "
        sql = sql & "left join recursosExtes re3 on re3.Id = i.Recurso and re3.Variable='TELEFONOS' "
        sql = sql & "left join clients c on i.Cliente = cast(c.Codi as varchar) "
        sql = sql & "where i.Id='" & iD & "'"

        Set rsInc = Db.OpenResultset(sql, rdConcurRowVer)
    
        If Not rsInc.EOF Then
            asunto = "Incidència HIT SYSTEMS N-" & rsInc("Id")

            cuerpo = "Hola! Tenim la següent incidència:<br><br>"
            cuerpo = cuerpo & "CLIENT   : " & rsInc("Client") & "<br>"
            cuerpo = cuerpo & "CONTACTE : " & rsInc("Botiga") & "<br>"
            cuerpo = cuerpo & "ADREÇA   : " & rsInc("Adreca") & "<br>"
            cuerpo = cuerpo & "TLF      : " & rsInc("Tlf") & "<br><br><br>"

            cuerpo = cuerpo & rsInc("Incidencia") & "<br><br>"
            
            cuerpo = cuerpo & "SALUTACIONS"

            para = Split(rsInc("emailFB"), ";")
            For P = 0 To UBound(para)
                sf_enviarMail "", para(P), asunto, cuerpo, "", ""
            Next
        End If
    End If
End Sub

Sub enviaEmailTascaFastByte(iD As String)
    Dim para() As String, asunto As String, cuerpo As String
    Dim P As Integer
    Dim rsInc As rdoResultset
    Dim sql As String
    
    InformaMiss "enviaEmailTascaFastByte ", True
     
    If iD <> "" Then

        sql = "select i.id, isnull(de1.valor, '') emailFB, isnull(c.nom, '') client,isnull(re.valor, isnull(cc.valor, '')) emailCli, "
        sql = sql & "isnull(re2.valor, '') adreca, isnull(r.Nombre, '') botiga, isnull(re3.valor, '') Tlf, i.Incidencia "
        sql = sql & "from incidencias i "
        sql = sql & "left join dependentesExtes de1 on i.Tecnico = de1.id and de1.nom='EMAIL' "
        sql = sql & "left join constantsclient cc on i.Cliente=cast(cc.Codi as varchar) and Variable = 'eMail' "
        sql = sql & "left join recursos r on r.Id = i.recurso "
        sql = sql & "left join recursosExtes re on re.Id = i.Recurso and re.Variable='EMAIL' "
        sql = sql & "left join recursosExtes re2 on re2.Id = i.Recurso and re2.Variable='DIRECCION' "
        sql = sql & "left join recursosExtes re3 on re3.Id = i.Recurso and re3.Variable='TELEFONOS' "
        sql = sql & "left join clients c on i.Cliente = cast(c.Codi as varchar) "
        sql = sql & "where i.Id='" & iD & "'"

        Set rsInc = Db.OpenResultset(sql, rdConcurRowVer)
    
        If Not rsInc.EOF Then
            asunto = "Incidència HIT SYSTEMS N-" & rsInc("Id")

            cuerpo = "Hola! Tenim la següent incidència:<br><br>"
            cuerpo = cuerpo & "CLIENT  : " & rsInc("Client") & "<br>"
            cuerpo = cuerpo & "BOTIGA  : " & rsInc("Botiga") & "<br>"
            cuerpo = cuerpo & "ADREÇA  : " & rsInc("Adreca") & "<br>"
            cuerpo = cuerpo & "TLF     : " & rsInc("Tlf") & "<br><br><br>"

            cuerpo = cuerpo & rsInc("Incidencia") & "<br><br>"
            
            cuerpo = cuerpo & "SALUTACIONS"

            para = Split(rsInc("emailFB"), ";")
            For P = 0 To UBound(para)
                sf_enviarMail "", para(P), asunto, cuerpo, "", ""
            Next
        End If
    End If
End Sub
Sub enviaEmailEncarrec(email As String, cuerpo As String)
    
On Error GoTo err
    sf_enviarMail "", email, "Aviso encargo", cuerpo, "", ""
    
err:

Debug.Print "error enviando encargo "

Resume Next
    
End Sub
Sub enviaEmailFaltaLLicencia(llicencia As String, bdEmpresa As String)
    Dim cuerpo As String
    
    cuerpo = "FALTA CREAR LA FICHA DE CLIENTE ASOCIADA A LA LICENCIA " & llicencia & " DE LA EMPRESA " & bdEmpresa
On Error GoTo err
    sf_enviarMail "", "ana@solucionesit365.com", "FALTA LA LICENCIA " & llicencia, cuerpo, "", ""
    sf_enviarMail "", "sat@hitsystems.es", "FALTA LA LICENCIA " & llicencia, cuerpo, "", ""
    
err:

Debug.Print "Error Enviando Falta LLicencia"

Resume Next
    
End Sub


Sub enviaEmailFaltaQuota(llicencia As String, bdEmpresa As String)
    Dim cuerpo As String
    
    cuerpo = "FALTA ALBARÀ DE QUOTA DE LA LLICENCIA " & llicencia & " EMPRESA " & bdEmpresa
On Error GoTo err
    sf_enviarMail "", "ana@solucionesit365.com", "FALTA LA QUOTA " & llicencia, cuerpo, "", ""
    sf_enviarMail "", "sat@hitsystems.es", "FALTA LA qUOTA " & llicencia, cuerpo, "", ""
    
err:

Debug.Print "Error Enviando Falta Quota"

Resume Next
    
End Sub

Sub EmailReposicioBotiga(para As String, botiga As String)
    Dim asunto As String, cuerpo As String
    Dim rsRepo As rdoResultset, RsBot As rdoResultset
    Dim sql As String
    Dim fecha As Date
    Dim nomBot As String
    
    InformaMiss "enviaEmailReposicioBotiga", True

    fecha = DateAdd("d", 1, Now())
    'tServits = "[servit-" & Right(Year(fecha), 2) & "-" & Right("00" & Month(fecha), 2) & "-" & Right("00" & Day(fecha), 2) & "]"
    
    cuerpo = ""
    Set RsBot = Db.OpenResultset("select * from clients where codi='" & botiga & "'")
    If Not RsBot.EOF Then nomBot = RsBot("nom")
        
    cuerpo = "Enviado: " & Now() & "<BR>"
    cuerpo = cuerpo & "PEDIDO PARA EL DÍA " & Day(fecha) & "/" & Month(fecha) & "/" & Year(fecha) & " DE LA TIENDA " & nomBot & "<BR>"

    cuerpo = cuerpo & "<TABLE BORDER='0' CELLPADDING='5' CELLSPACING='0'>"
    
    asunto = "REPOSICIÓN: la tienda " & nomBot & " ha hecho su pedido"
    
    sql = "select a.nom, r.quantitatDemanada "
    sql = sql & "from [Repo_Tienda_" & botiga & "] r "
    sql = sql & "left join articles a on r.codiarticle=a.codi"
    Set rsRepo = Db.OpenResultset(sql)
        
    While Not rsRepo.EOF
        cuerpo = cuerpo & "<TR><TD>" & rsRepo("nom") & "</TD><TD>" & rsRepo("quantitatDemanada") & "</TD></TR>"
        rsRepo.MoveNext
    Wend
    cuerpo = cuerpo & "</TABLE>"
        
    If para <> "" Then sf_enviarMail "", para, asunto, cuerpo, "", ""

    cuerpo = ""
End Sub


Sub ExportaContabilitatCalaixos(numAsiento, Di As Date, Df As Date, empresa, EsB)
    Dim rs As rdoResultset
        InformaMiss "Calaixos ", True
        Set rs = Db.OpenResultset("SELECT c.Codi FROM clients c join ConstantsClient cc on c.codi = cc.codi  and cc.variable = 'EsCalaix' and cc.Valor = 'EsCalaix' join ConstantsClient ccc on c.codi = ccc.codi  and ccc.variable = 'EmpCalaix'  and ccc.Valor = '" & empresa & "' ")
        While Not rs.EOF
            ExportaCalaixosJustificats Di, Df, numAsiento, rs("Codi"), EsB
            rs.MoveNext
        Wend

End Sub

Sub ExportaContabilitatDescuadres(numAsiento, Di As Date, Df As Date, empresa, EsB)
    Dim i, j, D As Date, fecha As Date, sql As String, rsCtb As rdoResultset, rsAlb As rdoResultset, rsCli As rdoResultset, botiga, import, Motiu, client, nAlb
    
    If empresa = "" Then empresa = "0"
    InformaMiss "Descuadres ", True
    j = 0
    D = Di
    'While D < Df Or (Year(D) = Year(Df) And Month(D) = Month(Df))
        'fecha = DateSerial(Year(D), Month(D), Day(DateAdd("d", -1, DateSerial(Year(DateAdd("m", 1, D)), Month(DateAdd("m", 1, D)), 1))))
    While D <= Df
        'Descuadres
        sql = "Select case when isnull(cc.valor,c.codi)='' then c.codi else isnull(cc.valor,c.codi) end botiga, sum(import) as import  "
        sql = sql & "From [" & NomTaulaMovi(D) & "] v "
        sql = sql & "left join clients c on v.botiga = c.codi "
        sql = sql & "left join constantsclient cc On cc.codi = c.codi and cc.variable = 'CodiContable' "
        sql = sql & "where tipus_moviment = 'J' and day(Data)=" & Day(D) & " "
        sql = sql & " And botiga in (select distinct Codi from constantsclient where variable = 'EmpresaVendes' and valor = '" & empresa & "') "
        sql = sql & "Group By cc.valor,c.codi"
        
        Set rsCtb = Db.OpenResultset(sql)
        While Not rsCtb.EOF
            botiga = rsCtb("botiga")
            import = rsCtb("Import")
            Motiu = "Desquadre botiga " & BotigaCodiNom(botiga)
            
            If import < 0 Then 'Falten diners
                AsientoAdd numAsiento, D, "659" & Right("000000000000" & botiga, nDigitos - 3), "", 0, Motiu & " " & BotigaCodiNom(botiga), Abs(import), 0, 0, 0, 0, ""
                AsientoAdd numAsiento, D, "57" & Right("000000000000" & botiga, nDigitos - 2), "", 0, Motiu & " " & BotigaCodiNom(botiga), 0, Abs(import), 0, 0, 0, ""
            Else 'Sobren diners
                AsientoAdd numAsiento, D, "659" & Right("000000000000" & botiga, nDigitos - 3), "", 0, Motiu & " " & BotigaCodiNom(botiga), 0, Abs(import), 0, 0, 0, ""
                AsientoAdd numAsiento, D, "57" & Right("000000000000" & botiga, nDigitos - 2), "", 0, Motiu & " " & BotigaCodiNom(botiga), Abs(import), 0, 0, 0, 0, ""
            End If
            numAsiento = numAsiento + 1
            InformaMiss "Calaixos " & D, True
            DoEvents
            rsCtb.MoveNext
        Wend
        rsCtb.Close
        
        'Diferencias de cambio
'        sql = "select botiga ,sum(Wi-w) Import from ( "
'        sql = sql & "Select "
'        sql = sql & "case tipus_moviment when 'W' then sum(import) else 0 end  w, "
'        sql = sql & "case tipus_moviment when 'Wi' then sum(import) else 0 end wi, Botiga "
'        sql = sql & "From [" & NomTaulaMovi(D) & "] "
'        sql = sql & "where (tipus_moviment = 'W' or tipus_moviment = 'Wi') and day(Data)=" & Day(D) & " "
'        sql = sql & " And botiga in (select distinct Codi from constantsclient where variable = 'EmpresaVendes' and valor = '" & Empresa & "') "
'        'If Empresa = "0" Or Empresa = "" Then
'        '    sql = sql & " And not botiga in(select distinct valor from constantsempresa where camp = 'CampCliente') "
'        'Else
'        '    sql = sql & " And botiga in(select distinct valor from constantsempresa where camp = '" & Empresa & "_CampCliente') "
'        'End If
'        sql = sql & "Group By botiga,tipus_moviment "
'        sql = sql & ") a group by botiga "
        
'        Set rsCtb = Db.OpenResultset(sql)
'        While Not rsCtb.EOF
'            Botiga = rsCtb("botiga")
'            import = Abs(rsCtb("Import"))
'            Motiu = "Dif. Canvis " & BotigaCodiNom(Botiga)

'            AsientoAdd NumAsiento, D, "6299" & Right("000000000000" & Botiga, nDigitos - 4), "", 0, Motiu & " " & BotigaCodiNom(Botiga), import, 0, 0, 0, 0, ""
'            AsientoAdd NumAsiento, D, "57" & Right("000000000000", nDigitos - 2), "", 0, Motiu & " " & BotigaCodiNom(Botiga), 0, import, 0, 0, 0, ""
'            NumAsiento = NumAsiento + 1
'            InformaMiss "Calaixos " & D, True
'            DoEvents
'            rsCtb.MoveNext
'        Wend
'        rsCtb.Close
        
        
        'Moviments
        sql = "Select motiu, tipus_moviment, case when isnull(cc.valor,c.codi)='' then c.codi else isnull(cc.valor,c.codi) end botiga, sum(import) as import "
        sql = sql & "from [" & NomTaulaMovi(D) & "] v "
        sql = sql & "left join clients c on v.botiga = c.codi "
        sql = sql & "left join constantsclient cc On cc.codi = c.codi and cc.variable = 'CodiContable' "
        sql = sql & "where tipus_moviment in ('O','A') and day(Data)=" & Day(D) & " "
        sql = sql & " And botiga in (select distinct Codi from constantsclient where variable = 'EmpresaVendes' and valor = '" & empresa & "') "
        'If Empresa = "0" Or Empresa = "" Then
        '    sql = sql & " And not botiga in(select distinct valor from constantsempresa where camp = 'CampCliente') "
        'Else
        '    sql = sql & " And botiga in(select distinct valor from constantsempresa where camp = '" & Empresa & "_CampCliente') "
        'End If
        sql = sql & "Group By motiu, tipus_moviment, cc.valor, c.codi "
        
        Set rsCtb = Db.OpenResultset(sql)
        While Not rsCtb.EOF
            botiga = rsCtb("botiga")
            import = Abs(rsCtb("Import"))
            Motiu = rsCtb("motiu") & " " & BotigaCodiNom(botiga)
            
            If rsCtb("motiu") = "Entrega Diària" Then
'                    AsientoAdd NumAsiento, Fecha, "57" & Right("000000000000" & Botiga, nDigitos - 2), "", 0, Motiu & " " & BotigaCodiNom(Botiga), Import, 0, 0, 0, 0
'                    AsientoAdd NumAsiento, Fecha, "57" & Right("000000000000" & Empresa, nDigitos - 2), "", 0, Motiu & " " & BotigaCodiNom(Botiga), 0, Import, 0, 0, 0
            ElseIf Left(rsCtb("motiu"), 13) = "Pagat Targeta" Then
'                AsientoAdd NumAsiento, D, "44" & Right("000000000000" & Botiga, nDigitos - 2), "", 0, Motiu & " " & BotigaCodiNom(Botiga), import, 0, 0, 0, 0, ""
'                AsientoAdd NumAsiento, D, "43" & Right("000000000000" & Botiga, nDigitos - 2), "", 0, Motiu & " " & BotigaCodiNom(Botiga), 0, import, 0, 0, 0, ""
                AsientoAdd numAsiento, D, "57" & Right("000000000000" & botiga, nDigitos - 2), "", 0, Motiu & " " & BotigaCodiNom(botiga), 0, import, 0, 0, 0, ""
                AsientoAdd numAsiento, D, "44" & Right("000000000000" & botiga, nDigitos - 2), "", 0, Motiu & " " & BotigaCodiNom(botiga), import, 0, 0, 0, 0, ""
            ElseIf Left(rsCtb("motiu"), 6) = "Albara" Then 'ALBARANES
                nAlb = LTrim(Mid(Motiu, InStr(1, Motiu, "Albara ") + Len("Albara "), InStr(InStr(1, Motiu, "Albara ") + Len("Albara ") + 2, Motiu, " ") - (InStr(1, Motiu, "Albara ") + Len("Albara "))))
                Set rsAlb = Db.OpenResultset("select * From [" & NomTaulaAlbarans(D) & "] where num_tick='" & nAlb & "'")
                If Not rsAlb.EOF Then
                    client = rsAlb("Otros")
                    Set rsCli = Db.OpenResultset("SELECT Valor FROM " & tablaConstantsClient() & " WHERE  codi='" & client & "' AND variable = 'CodiContable'")
                    If Not rsCli.EOF Then client = rsCli("valor")
                    
                    AsientoAdd numAsiento, D, "57" & Right("000000000000" & botiga, nDigitos - 2), "", 0, Motiu & " " & BotigaCodiNom(botiga), import, 0, 0, 0, 0, ""
                    AsientoAdd numAsiento, D, "43" & Right("000000000000" & client, nDigitos - 2), "", 0, Motiu & " " & BotigaCodiNom(botiga), 0, import, 0, 0, 0, ""
                End If
            ElseIf Left(rsCtb("motiu"), 2) = "D." Then 'DEIXA A DEURE
                AsientoAdd numAsiento, D, "629" & Right("000000000000" & botiga, nDigitos - 3), "", 0, Motiu & " " & BotigaCodiNom(botiga), import, 0, 0, 0, 0, ""
                AsientoAdd numAsiento, D, "43" & Right("000000000000" & botiga, nDigitos - 2), "", 0, Motiu & " " & BotigaCodiNom(botiga), 0, import, 0, 0, 0, ""
            ElseIf Left(rsCtb("motiu"), 2) = "P." Then 'PAGA DEUTE
                AsientoAdd numAsiento, D, "57" & Right("000000000000" & botiga, nDigitos - 2), "", 0, Motiu & " " & BotigaCodiNom(botiga), import, 0, 0, 0, 0, ""
                AsientoAdd numAsiento, D, "629" & Right("000000000000" & botiga, nDigitos - 3), "", 0, Motiu & " " & BotigaCodiNom(botiga), 0, import, 0, 0, 0, ""
            ElseIf Left(rsCtb("motiu"), 2) <> "D." And Left(rsCtb("motiu"), 2) <> "P." And Left(rsCtb("motiu"), 6) <> "Albara" Then
                AsientoAdd numAsiento, D, "57" & Right("000000000000" & botiga, nDigitos - 2), "", 0, Motiu & " " & BotigaCodiNom(botiga), 0, import, 0, 0, 0, ""
                AsientoAdd numAsiento, D, "629" & Right("000000000000" & botiga, nDigitos - 3), "", 0, Motiu & " " & BotigaCodiNom(botiga), import, 0, 0, 0, 0, ""
            End If
            
            numAsiento = numAsiento + 1
            InformaMiss "Calaixos " & D, True
            DoEvents
            rsCtb.MoveNext
        Wend
        rsCtb.Close
        
        
        D = DateAdd("d", 1, D)
    Wend

End Sub
Sub ExportaContabilitatMoviments(numAsiento, Di As Date, Df As Date, empresa, EsB)
    Dim D, i, j, sql As String, rsCtb As rdoResultset, Num, fecha, Descripcio, FacturaId, texte As String, ReferenciaInterna, ClauEmp As String
    
    ClauEmp = "CampCuentaContable"
    If CDbl(empresa) > 0 Then ClauEmp = empresa & "_CampCuentaContable"
    
        InformaMiss "Moviments", True
        D = Di
        i = 0
        j = 0
        Dim ImportReal
        
        sql = " CREATE NONCLUSTERED INDEX [ind1_" & DonamNomTaulaAsientosContables(Di) & "]"
        sql = sql & " ON [" & DonamNomTaulaAsientosContables(Di) & "] ([idNorma43])"
        sql = sql & " INCLUDE ([orden],[FECHA],[CONCEPTO],[DESCRIPCION],[SUBCUENTA],[DEBE],[HABER],[FacturaId],[ReferenciaInterna])"
        ExecutaComandaSql sql
        
        
        
 
        sql = "select c.IdNorma43, Orden, FECHA, isnull(SUBCUENTA, '') SUBCUENTA, isnull(ReferenciaInterna, '') ReferenciaInterna, isnull(DESCRIPCION, '') DESCRIPCION, "
        sql = sql & "isnull(CONCEPTO, '') CONCEPTO, isnull(hit_importe, 0) hit_importe, isnull(DEBE, 0) DEBE , isnull(HABER, 0) HABER, isnull(facturaId, '') facturaId "
        sql = sql & "from " & DonamNomTaulaAsientosContables(Di) & " c "
        sql = sql & "join norma43 n on "
        sql = sql & "n.Comu_numCuenta in (select distinct valor  from constantsempresa   where camp = '" & ClauEmp & "') and "
        sql = sql & "c.idNorma43 = n.idNorma43 "
        sql = sql & "where c.idnorma43 not like '%|%' And DataOperacio <= '" & Format(Df, "yymmdd") & "' and DataOperacio >= '" & Format(Di, "yymmdd") & "' "
        sql = sql & "order by hit_datavalor, c.idnorma43, c.orden"
        
        Set rsCtb = Db.OpenResultset(sql)
        Dim iD, Cuenta1, Cuenta2, Deve, Haver, acd, Ach, DadesExportaCpFinsAra
        If Not rsCtb.EOF Then iD = rsCtb("IdNorma43")
        Num = -1
        acd = 0
        Ach = 0
        
        DadesExportaCpFinsAra = DadesExportaCp
        While Not rsCtb.EOF
'           If InStr(rsCtb("valor"), "Efectivo Hit") > 0 Then
'               Num = Num
'           End If
            If Not (iD = rsCtb("IdNorma43") And Num = rsCtb("Orden")) Then
                If Not Num = -1 Then
                   MyAsientoAdd numAsiento, fecha, Cuenta1, Descripcio, Deve, Haver, FacturaId, texte, ReferenciaInterna
                End If
                If iD = rsCtb("IdNorma43") Then
                   Cuenta1 = ""
                Else
                   If Abs(acd - Ach) > 0.001 Then
                        DadesExportaCp = DadesExportaCpFinsAra
                        DadesExportaCpFlush
                   Else
                        DadesExportaCp = DadesExportaCp
                        DadesExportaCpFlush
                   End If
                   acd = 0
                   Ach = 0
                   Cuenta1 = 0
                   DadesExportaCpFinsAra = DadesExportaCp
                   numAsiento = numAsiento + 1
                End If
                iD = rsCtb("IdNorma43")
                Num = rsCtb("Orden")
                fecha = 0
                Descripcio = 0
                Deve = 0
                Haver = 0
                ReferenciaInterna = ""
                FacturaId = ""
            End If
            

            fecha = rsCtb("FECHA")
            ReferenciaInterna = rsCtb("ReferenciaInterna")
            If Len(ReferenciaInterna) > 5 Then
               Cuenta1 = codiContableProveedor(ReferenciaInterna)
            Else
               Cuenta1 = codiContable(ReferenciaInterna)
            End If
            If ReferenciaInterna = "" Then
                If Cuenta1 = "" Or Cuenta1 = "0" Or Cuenta1 = 0 Then
                    Cuenta1 = BancoNumConta(rsCtb("IdNorma43"), rsCtb("SUBCUENTA"))
                End If
            End If
            If (Descripcio = "" Or Descripcio = 0) Then Descripcio = rsCtb("DESCRIPCION")
            
            If Not rsCtb("FacturaId") = "Pendiente" Then
                If (FacturaId = "" Or FacturaId = 0) Then
                    FacturaId = rsCtb("FacturaId")
                    If Len(FacturaId) > 5 And InStr(FacturaId, "|") = 0 Then
                        Cuenta1 = codiContableFacturaProveedor(FacturaId, fecha, ReferenciaInterna)
                    Else
                        'Cuenta1 = codiContable(FacturaId)
                    End If
                End If
            End If
                                
            texte = rsCtb("CONCEPTO")
            If (Descripcio = "" Or Descripcio = 0) Then Descripcio = rsCtb("CONCEPTO")

            ImportReal = rsCtb("hit_importe")
            If Not rsCtb("DEBE") = "" Then Deve = Round(rsCtb("DEBE"), 2)
            If Deve = "" Then Deve = "0"
            acd = acd + CDbl(Deve)
            
            If Not rsCtb("HABER") = "" Then Haver = Round(rsCtb("HABER"), 2)
            If Haver = "" Then Haver = "0"
            Ach = Ach + CDbl(Haver)
            
            'Select Case rsCtb("concepto")
            '    Case "FECHA"
            '            Fecha = rsCtb("Valor")
            '    Case "SUBCUENTA"
            '        If ReferenciaInterna = "" Then
            '           If Cuenta1 = "" Or Cuenta1 = "0" Or Cuenta1 = 0 Then
            '                Cuenta1 = BancoNumConta(rsCtb("IdNorma43"), rsCtb("Valor"))
            '           End If
            '        End If
            '    Case "ReferenciaInterna"
            '        ReferenciaInterna = rsCtb("valor")
            '        If Len(ReferenciaInterna) > 5 Then
            '            Cuenta1 = codiContableProveedor(ReferenciaInterna)
            '        Else
            '            Cuenta1 = codiContable(ReferenciaInterna)
            '        End If
            '    Case "DESCRIPCIÓN"
            '        If (Descripcio = "" Or Descripcio = 0) Then Descripcio = rsCtb("Valor")
            '    Case "FacturaId"
            '        If Not rsCtb("Valor") = "Pendiente" Then
            '            If (FacturaId = "" Or FacturaId = 0) Then
            '                FacturaId = rsCtb("Valor")
            '                If Len(FacturaId) > 5 And InStr(FacturaId, "|") = 0 Then
            '                    Cuenta1 = codiContableFacturaProveedor(FacturaId, Fecha, ReferenciaInterna)
            '                Else
            '                    'Cuenta1 = codiContable(FacturaId)
            '                End If
            '            End If
            '        End If
            '    Case "CONCEPTO"
            '        Texte = rsCtb("Valor")
            '        If (Descripcio = "" Or Descripcio = 0) Then Descripcio = rsCtb("Valor")
            '    Case "DEBE"
            '        ImportReal = rsCtb("hit_importe")
            '        If Not rsCtb("Valor") = "" Then Deve = Round(rsCtb("Valor"), 2)
            '        If Deve = "" Then Deve = "0"
            '        Acd = Acd + CDbl(Deve)
            '    Case "HABER"
            '        If Not rsCtb("Valor") = "" Then Haver = Round(rsCtb("Valor"), 2)
            '        If Haver = "" Then Haver = "0"
            '        Ach = Ach + CDbl(Haver)
            'End Select
            
            InformaMiss "Moviments " & numAsiento & "  " & fecha, True
            DoEvents
            rsCtb.MoveNext
        Wend
        rsCtb.Close
        If Not Num = -1 Then
            MyAsientoAdd numAsiento, fecha, Cuenta1, Descripcio, Deve, Haver, FacturaId, texte, ReferenciaInterna
            numAsiento = numAsiento + 1
        End If
        If Abs(acd - Ach) > 0.001 Then
            DadesExportaCp = DadesExportaCpFinsAra
            DadesExportaCpFlush
        End If
  


End Sub

Sub ExportaMURANO_Calaixos(idNorma43 As String, fecha As Date)
    Dim rsCtb As rdoResultset, rsEmp As rdoResultset, rsNA As rdoResultset, rsHist As rdoResultset
    Dim nEmpresa As String
    Dim calaix As String
    Dim numAsiento As String
    Dim debe As Double, haber As Double
    Dim fechaAsiento As Date
    
    fechaAsiento = fecha
      
    On Error GoTo noExportat
    
    nEmpresa = "0"
    
    InformaMiss "MURANO BANCS: " & idNorma43 & " Dia: " & fecha, True

    calaix = Split(idNorma43, "|")(0)

    Set rsEmp = Db.OpenResultset("select * from constantsclient where codi='" & calaix & "' and variable='EmpCalaix'")
    If Not rsEmp.EOF Then nEmpresa = rsEmp("Valor")
    
    If nEmpresa = "0" Then
        Set rsCtb = Db.OpenResultset("Select Isnull(valor,'') Valor from constantsempresa  where camp = 'CampEnlaceNominas' ")
    Else
        Set rsCtb = Db.OpenResultset("Select Isnull(valor,'') Valor from constantsempresa  where camp = '" & nEmpresa & "_CampEnlaceNominas' ")
    End If
    If Not rsCtb.EOF Then EmpresaMurano = Trim(Left(rsCtb("Valor"), InStr(rsCtb("Valor"), " ")))
    
    Set rsNA = Db.OpenResultset("select isnull(max(Asiento), 0) + 1 NumAsiento from [WEB].[Sage].[dbo].[Movimientos] where CodigoEmpresa = " & EmpresaMurano & " and year(fechaAsiento) = " & Year(fecha))
    If Not rsNA.EOF Then numAsiento = rsNA("NumAsiento")

    Set rsHist = Db.OpenResultset("select distinct(Asiento) from " & TaulaHistoricoMURANO(fecha) & " where month(FechaAsiento)=" & Month(fecha) & " and day(FechaAsiento)=" & Day(fecha) & " and Param1 = '" & idNorma43 & "' and CodigoEmpresa=" & EmpresaMurano & " and TipoExportacion='CALAIX'")
    While Not rsHist.EOF
        MuranoExecute "Delete from [WEB].[Sage].[dbo].[Movimientos] where Asiento = " & rsHist("Asiento") & " and CodigoEmpresa=" & EmpresaMurano & " and ejercicio=" & Year(fecha)
        rsHist.MoveNext
    Wend
    
    ExecutaComandaSql "Insert into " & TaulaHistoricoMURANO(fecha) & " (FechaGrabacion, CodigoEmpresa, FechaAsiento, Param1, Asiento, TipoExportacion) values (getdate(), " & EmpresaMurano & ", '" & fecha & "', '" & idNorma43 & "', " & numAsiento & ", 'CALAIX')"
        
    Set rsCtb = Db.OpenResultset("select * from " & DonamNomTaulaAsientosContables(fecha) & " where idNorma43 ='" & idNorma43 & "' order by orden")
    While Not rsCtb.EOF
        debe = rsCtb("DEBE")
        haber = rsCtb("HABER")
        
        AsientoAddMURANO 0, numAsiento, rsCtb("FECHA"), Left(rsCtb("SUBCUENTA"), 4) & "0" & Right(rsCtb("SUBCUENTA"), 4), "", Left(LTrim(RTrim(rsCtb("DESCRIPCION"))), 20), debe, haber
        
        rsCtb.MoveNext
    Wend

noExportat:

End Sub


Sub CalculaComandaPerEquip(dia As String, equip As String)
    Dim rs As rdoResultset, Di As Date, Df As Date, rs2 As rdoResultset, Tornat, servit, Demanat As Double, client As Double, article As Double, dCalculat As Double, sql As String, co As String, Increment As Double, Alarma As String, Viatge As String, NextArticle, NextClient, NextViatge, MinutInici, NextMinutInici, PrevArticle, email As String, LastClient As String, EnviatA As String, RsV As rdoResultset, i, MinutI, MinutF, AccV, AccV2, Vnom() As String, Vq() As Double, Vped As Double, rsQ As rdoResultset
    
    Di = DateSerial(Year(dia), Month(dia), Day(dia))
    Df = DateAdd("d", 7, Di)
    co = ""
    InformaMiss "CalculaComandaPerEquip", False
    
    On Error GoTo err
            
    Set rs = Db.OpenResultset("Select Distinct client,codiarticle from ComandesMemotecnicPerClient Where equip = '" & equip & "' and client is not null Order By client,codiarticle ")
    LastClient = 0
    PrevArticle = ""
    While Not rs.EOF
        PrevArticle = article
        Demanat = 0
        servit = 0
        Tornat = 0
        article = rs("codiarticle")
        client = rs("Client")
        InformaMiss ArticleCodiNom(article), True
        
        sql = "Select isnull(sum(quantitatdemanada),0) d ,isnull(sum(QuantitatServida),0) s from [" & DonamNomTaulaServit(Di) & "] s "
        sql = sql & "Where equip = '" & equip & "' "
        sql = sql & "And   client = '" & client & "' "
        sql = sql & "And   codiarticle = '" & article & "' "
        Set rsQ = Db.OpenResultset(sql)
        If Not rsQ.EOF Then
            Demanat = rsQ("d")
            servit = rsQ("s")
        End If
        Dim tornatStr As String
        
        tornatStr = ""
        Set rsQ = Db.OpenResultset("Select isnull(sum(Quantitat),0) t, data  from [" & NomTaulaDevol(Di) & "] where day(data)= " & Day(Di) & " and botiga = " & client & " and plu = " & article & " group by data")
        While Not rsQ.EOF
            tornatStr = tornatStr & rsQ("t") & " - " & rsQ("data") & "<br>"
        
            rsQ.MoveNext
        Wend
        
        Set rsQ = Db.OpenResultset("Select  isnull(sum(QuantitatTornada),0) t from [" & DonamNomTaulaServit(Di) & "] where client = " & client & " and codiarticle = " & article & " ")
        Tornat = rsQ("t")
        
        If LastClient <> client Then
            LastClient = client
            co = co & "<H1>" & BotigaCodiNom(client) & " </H1>"
            co = co & "<Table border=2><Tr>"
            co = co & "<Td>Producto</Td>"
            co = co & "<Td>Viatge</Td>"
            co = co & "<Td>Produits</Td>"
            co = co & "<Td>Venuts</Td>"
            co = co & "<Td>Devolucio</Td>"
            co = co & "<Td>Comanda</Td>"
            co = co & "<Td>Import</Td>"
            co = co & "</Tr>"
            co = co & ""
        End If
        rs.MoveNext
        
        If servit = 0 Then servit = Demanat
        dCalculat = Int(((servit - Tornat) * 1.1) + 0.6)  'Servit-Tonat + 10% redondeado hacia arriba
        If dCalculat > 0 Then If Int(((servit - Tornat) * 1.1) + 0.5) = (servit - Tornat) Then dCalculat = dCalculat + 1
                    
        Increment = (dCalculat - servit) * ArticleCodiPvp(article)
        Alarma = ""
        If dCalculat <= 0 Then
            Alarma = "<font color='Red'>Error !!</font>"
            dCalculat = servit
        End If
        
        'Repartim x viatges
        Set RsV = Db.OpenResultset("select * from viatges where nom in(select distinct viatge from ComandesMemotecnicPerClient where codiarticle= '" & article & "' and client = '" & client & "' and  equip='" & equip & "') order by Minutinici ")
        i = 0
        MinutI = 0
        MinutF = 0
        AccV = 0
        While Not RsV.EOF
            ReDim Preserve Vnom(i)
            ReDim Preserve Vq(i)
            
            Vnom(i) = RsV("Nom")
            RsV.MoveNext
            If RsV.EOF Then
                MinutF = 23 * 60 + 58
            Else
                MinutF = RsV("Minutinici")
            End If
            Vq(i) = PedidoCalculaVenut(article, client, DateAdd("n", MinutI, DateSerial(Year(Di), Month(Di), Day(Di))), DateAdd("n", MinutF, DateSerial(Year(Di), Month(Di), Day(Di)))) + 1
            AccV = AccV + Vq(i)
            MinutI = MinutF
            i = i + 1
        Wend
      
        ExecutaComandaSql "delete from [" & DonamNomTaulaComandesCalculades(Df) & "] where equip='" & equip & "' and client='" & client & "' and Article='" & article & "'"
        ExecutaComandaSql "delete from [" & DonamNomTaulaServit(Df) & "] where equip='" & equip & "' and client='" & client & "' and codiarticle='" & article & "'"
        AccV2 = 0
        For i = UBound(Vnom()) To 0 Step -1
            If AccV > 0 Then
                Vped = Int(dCalculat * (Vq(i) / AccV))
            Else
                Vped = 0
            End If
            
            If i = 0 Then Vped = dCalculat - AccV2
            AccV2 = AccV2 + Vped
            sql = "Insert into [" & DonamNomTaulaComandesCalculades(Df) & "] (Client,Article,Viatge,Equip,Quantitat) values "
            sql = sql & "('" & client & "', '" & article & "', '" & Vnom(i) & "', '" & equip & "', " & Vped & ")"
            ExecutaComandaSql sql
            
            sql = "Insert into [" & DonamNomTaulaServit(Df) & "] (client, codiarticle, viatge, equip, quantitatDemanada, quantitatServida, quantitatTornada, Hora, TipusComanda, Comentari) values "
            sql = sql & "('" & client & "', '" & article & "', '" & Vnom(i) & "', '" & equip & "', " & Vped & ", " & Vped & ", 0, 91, 3, '')"
            ExecutaComandaSql sql
        
            co = co & "<Tr><Td>" & ArticleCodiNom(article) & "</Td>"
            co = co & "<Td>" & Vnom(i) & "</Td>"
            co = co & "<Td>" & servit & "</Td>"
            co = co & "<Td>" & Vq(i) - 1 & "</Td>"
            co = co & "<Td>" & tornatStr & "</Td>"
            co = co & "<Td><INPUT TYPE=""TEXT"" NAME=""Vped_" & i & """ VALUE=""" & Vped & """></Td>"
            co = co & "<Td>"
            If Alarma = "" Then
                co = co & "<font "
                If (Increment) > 0 Then
                    co = co & " color='green' "
                Else
                    co = co & " color='Red' "
                End If
                co = co & " >"
                co = co & Increment & ""
                co = co & "</font>"
            Else
                    co = co & Alarma & ""
            End If
            co = co & "</Td>"
            co = co & "</Tr>"
        Next
    Wend
    co = co & "</Table>"
    
    EnviatA = "Enviat a : "
    Set rs = Db.OpenResultset("select valor from dependentesExtes where id in(select distinct id from dependentesExtes where nom = 'EQUIPS' and valor ='" & equip & "') And nom = 'EMAIL' ")
    While Not rs.EOF
        email = rs("Valor")
        EnviatA = EnviatA & email & "<br>"
        sf_enviarMail "Secrehit@gmail.com", email, Format(Di, "dddd dd ") & " Pedido Tienda ", co, "", ""
        rs.MoveNext
    Wend
    sf_enviarMail "Secrehit@gmail.com", "Jordi@hit.cat", Format(Di, "dddd dd ") & " Pedido Tienda ", EnviatA & co, "", ""
    'sf_enviarMail "Secrehit@gmail.com", "contreras.salva@gmail.com", Format(Di, "dddd dd ") & " Pedido Tienda ", EnviatA & Co, "", ""
    'sf_enviarMail "Secrehit@gmail.com", "ana@solucionesit365.com", Format(Di, "dddd dd ") & " Pedido Tienda ", EnviatA & Co, "", ""
    'sf_enviarMail "Secrehit@gmail.com", "cescuder@silemabcn.com", Format(Di, "dddd dd ") & " Pedido Tienda ", Co, "", ""

    Exit Sub
err:
    sf_enviarMail "Secrehit@gmail.com", "ana@solucionesit365.com", EmpresaActual & " -- CalculaComandaPerEquip " & Format(dia, "dddd dd ") & "--" & equip, "Error en CalculaComandaPerEquip: " & err.Description, "", ""
End Sub
Sub ExportaContabilitatNominas(numAsiento, Di As Date, Df As Date, empresa, EsB)
        Dim CntBrut, clauEmpresa, rsCtb As rdoResultset, data As Date
        
        InformaMiss "Nominas", True
        
        clauEmpresa = ""
        If empresa = 0 Then
            Set rsCtb = Db.OpenResultset("Select Isnull(valor,'') Valor from constantsempresa  where camp = 'CampEnlaceNominas' ")
        Else
            Set rsCtb = Db.OpenResultset("Select Isnull(valor,'') Valor from constantsempresa  where camp = '" & empresa & "_CampEnlaceNominas' ")
        End If
        SousNominaImportats
        
        If Not rsCtb.EOF Then clauEmpresa = rsCtb("Valor")
        Set rsCtb = Db.OpenResultset("Select D.nom,dependentesExtes.Id as codi ,data,treb,i_liquid,i_irpf,i_tc1,i_brut,i_ssemp,isnull(RetibEspecie,0) RetibEspecie ,isnull(IrpfEspecies,0) IrpfEspecies from SousNominaImportats join dependentesExtes on SousNominaImportats.Treb = dependentesExtes.Valor And dependentesExtes.nom = 'CODINOMINA' Join Dependentes d on d.codi = dependentesExtes.Id Where Data <= '" & Format(Df, "yyyymmdd") & "' and Data >= '" & Format(Di, "yyyymmdd") & "' And SousNominaImportats.CodiEmpresa = '" & clauEmpresa & "' order by data,treb ")
        Dim DadesExportaCpGran
        DadesExportaCpGran = DadesExportaCp
        DadesExportaCp = ""
        While Not rsCtb.EOF
            Dim Sdata As String
            Dim codiCentre As String
            Dim nom As String
            
            Sdata = "20070202"
            Sdata = rsCtb("Data")
            
            data = DateSerial(Mid(Sdata, 1, 4), Mid(Sdata, 5, 2), Mid(Sdata, 7, 2))
            codiCentre = CodiCentreTreball(rsCtb("Codi"))
            CntBrut = "6400" & Right("000000", 4 - Len(codiCentre)) + codiCentre
            nom = QuitarCaracteres(rsCtb("Nom"))
            'nom = Replace(Replace(Replace(rsCtb("Nom"), "Ó", "O"), "Ñ", "N"), "ó", "o")
            
            'AsientoAdd numAsiento, Data, CDbl("4650" & Right("000000", 4)) + rsCtb("Codi"), "", 0, "Liquid " & rsCtb("Nom"), 0, Round(rsCtb("i_liquid"), 2), 0, 0
            'AsientoAdd NumAsiento, data, CDbl("4650" & Right("000000", 4)), "", 0, "Liquid " & nom, 0, Round(rsCtb("i_liquid"), 2), 0, 0, 0
            'AsientoAdd NumAsiento, data, "4751" & Right("000000", 4), "", 0, "Irpf " & nom, 0, Round(rsCtb("i_irpf"), 2), 0, 0, 0
            'AsientoAdd NumAsiento, data, "4751" & Right("000101", 4), "", 0, "Retencion En Especie " & nom, 0, Round(rsCtb("IrpfEspecies"), 2), 0, 0, 0
            'AsientoAdd NumAsiento, data, "4751" & Right("000101", 4), "", 0, "P. Especie " & nom, 0, Round(rsCtb("RetibEspecie"), 2), 0, 0, 0
            'AsientoAdd NumAsiento, data, "4760" & Right("000000", 4), "", 0, "Tc1 " & nom, 0, Round(rsCtb("i_tc1"), 2), 0, 0, 0
            'AsientoAdd numAsiento, data, "4760" & Right("000000", 4), "", 0, "RetEmp " & rsCtb("Nom"), 0, -Round(rsCtb("i_tc1") - rsCtb("i_ssemp"), 2), 0, 0
            'AsientoAdd NumAsiento, data, CntBrut, "", 0, "Brut " & nom, Round(rsCtb("i_brut"), 2), 0, 0, 0, 0
            'AsientoAdd NumAsiento, data, "4760" & Right("000000", 4), "", 0, "Retencion De SS " & nom, 0, Round(rsCtb("i_ssemp"), 2), 0, 0, 0
            
            AsientoAdd numAsiento, data, CDbl("4650" & Right("000000", 4)), "", 0, "Liquid " & nom, 0, Round(rsCtb("i_liquid"), 2), 0, 0, 0, ""
            AsientoAdd numAsiento, data, "4751" & Right("000000", 4), "", 0, "Retencion De Irpf " & nom, 0, Round(rsCtb("i_irpf"), 2), 0, 0, 0, ""
            AsientoAdd numAsiento, data, "4751" & Right("000101", 4), "", 0, "Retencion En Especie " & nom, 0, Round(rsCtb("IrpfEspecies"), 2), 0, 0, 0, ""
            AsientoAdd numAsiento, data, "7550" & Right("000000", 4), "", 0, "Ingreso Por servicios al personal " & nom, 0, rsCtb("RetibEspecie"), 0, 0, 0, ""
            AsientoAdd numAsiento, data, "6490" & Right("000000", 4), "", 0, "Retrib En Especie " & nom, Round(rsCtb("RetibEspecie") + rsCtb("IrpfEspecies"), 2), 0, 0, 0, 0, ""
            AsientoAdd numAsiento, data, "6400" & Right("000000", 4), "", 0, "Salario Bruto " & nom, Round(rsCtb("i_brut") - rsCtb("RetibEspecie"), 2), 0, 0, 0, 0, ""
            AsientoAdd numAsiento, data, "6420" & Right("000000", 4), "", 0, "Ssemp " & nom, Round(rsCtb("i_tc1") - rsCtb("i_ssemp"), 2), 0, 0, 0, 0, ""
            AsientoAdd numAsiento, data, "4760" & Right("000000", 4), "", 0, "Tc1 SS " & nom, 0, Round(rsCtb("i_tc1"), 2), 0, 0, 0, ""
            
            numAsiento = numAsiento + 1
            InformaMiss "Nominas " & numAsiento, True
            DoEvents
            rsCtb.MoveNext
            DadesExportaCpFlush
        Wend
        rsCtb.Close
        DadesExportaCp = DadesExportaCpGran & DadesExportaCp

End Sub



Sub ExportaMURANO_Nomines(nEmpresa As Double, dataInici As Date, dataFi As Date)
    Dim sql As String
    Dim rsCtb As rdoResultset, rsNA As rdoResultset, rsHist As rdoResultset
    Dim clauEmpresa As String
    Dim numAsiento As Integer
    Dim data As Date
    Dim CntBrut As String
    
    Informa "MURANO nómines"
    
    clauEmpresa = ""
    If nEmpresa = 0 Then
        Set rsCtb = Db.OpenResultset("Select Isnull(valor,'') Valor from constantsempresa  where camp = 'CampEnlaceNominas' ")
    Else
        Set rsCtb = Db.OpenResultset("Select Isnull(valor,'') Valor from constantsempresa  where camp = '" & nEmpresa & "_CampEnlaceNominas' ")
    End If
    If Not rsCtb.EOF Then
        clauEmpresa = rsCtb("Valor")
        EmpresaMurano = Trim(Left(rsCtb("Valor"), InStr(rsCtb("Valor"), " ")))
    End If
        
   
    Set rsNA = Db.OpenResultset("select isnull(max(Asiento), 0) + 1 NumAsiento from [WEB].[Sage].[dbo].[Movimientos] where CodigoEmpresa = " & EmpresaMurano & " and year(fechaAsiento) = " & Year(dataInici))
    If Not rsNA.EOF Then numAsiento = rsNA("NumAsiento")
    
    sql = "Select D.nom,dependentesExtes.Id as codi ,data,treb,i_liquid,i_irpf,i_tc1,i_brut,i_ssemp,isnull(RetibEspecie,0) RetibEspecie ,isnull(IrpfEspecies,0) IrpfEspecies "
    sql = sql & "from SousNominaImportats "
    sql = sql & "join dependentesExtes on SousNominaImportats.Treb = dependentesExtes.Valor And dependentesExtes.nom = 'CODINOMINA' "
    sql = sql & "Join Dependentes d on d.codi = dependentesExtes.Id "
    sql = sql & "Where Data <= '" & Format(dataFi, "yyyymmdd") & "' and Data >= '" & Format(dataInici, "yyyymmdd") & "' And SousNominaImportats.CodiEmpresa = '" & clauEmpresa & "' "
    Set rsCtb = Db.OpenResultset(sql)
    
    While Not rsCtb.EOF
        Dim Sdata As String
        Dim codiCentre As String
        Dim nom As String
        
        Sdata = "20070202"
        Sdata = rsCtb("Data")
        
        data = DateSerial(Mid(Sdata, 1, 4), Mid(Sdata, 5, 2), Mid(Sdata, 7, 2))
        codiCentre = CodiCentreTreball(rsCtb("Codi"))
        CntBrut = "6400" & Right("000000", 4 - Len(codiCentre)) + codiCentre
        nom = QuitarCaracteres(rsCtb("Nom"))
        
        Set rsHist = Db.OpenResultset("select distinct(Asiento) from " & TaulaHistoricoMURANO(data) & " where month(FechaAsiento)=" & Month(data) & " and day(FechaAsiento)=" & Day(data) & " and Param1 = '" & nom & "' and CodigoEmpresa=" & EmpresaMurano & " and TipoExportacion='NOMINA'")
        While Not rsHist.EOF
            MuranoExecute "Delete from [WEB].[Sage].[dbo].[Movimientos] where Asiento = " & rsHist("Asiento") & " and CodigoEmpresa=" & EmpresaMurano
            rsHist.MoveNext
        Wend
        
        ExecutaComandaSql "Insert into " & TaulaHistoricoMURANO(data) & " (FechaGrabacion, CodigoEmpresa, FechaAsiento, Param1, Asiento, TipoExportacion) values (getdate(), " & EmpresaMurano & ", '" & data & "', '" & nom & "', " & numAsiento & ", 'NOMINA')"
        
        AsientoAddMURANO 0, numAsiento, data, "465000000", "", Left("Liquid " & nom, 40), 0, Round(rsCtb("i_liquid"), 2)
        AsientoAddMURANO 0, numAsiento, data, "475100000", "", Left("Retencion De Irpf " & nom, 40), 0, Round(rsCtb("i_irpf"), 2)
        AsientoAddMURANO 0, numAsiento, data, "475100101", "", Left("Retencion En Especie " & nom, 40), 0, Round(rsCtb("IrpfEspecies"), 2)
        AsientoAddMURANO 0, numAsiento, data, "755000000", "", Left("Ingreso Por servicios al personal " & nom, 40), 0, rsCtb("RetibEspecie")
        AsientoAddMURANO 0, numAsiento, data, "649000000", "", Left("Retrib En Especie " & nom, 40), Round(rsCtb("RetibEspecie") + rsCtb("IrpfEspecies"), 2), 0
        AsientoAddMURANO 0, numAsiento, data, "640000000", "", Left("Salario Bruto " & nom, 40), Round(rsCtb("i_brut") - rsCtb("RetibEspecie"), 2), 0
        AsientoAddMURANO 0, numAsiento, data, "642000000", "", Left("Ssemp " & nom, 40), Round(rsCtb("i_tc1") - rsCtb("i_ssemp"), 2), 0
        AsientoAddMURANO 0, numAsiento, data, "476000000", "", Left("Tc1 SS " & nom, 40), 0, Round(rsCtb("i_tc1"), 2)

        numAsiento = numAsiento + 1
        InformaMiss "Nominas " & numAsiento, True
        DoEvents
        rsCtb.MoveNext
        DadesExportaCpFlush
    Wend
    rsCtb.Close
End Sub


Function QuitarCaracteres(cadena As String) As String

    cadena = Replace(cadena, "ñ", "n")
    cadena = Replace(cadena, "Ñ", "N")
    cadena = Replace(cadena, "á", "a")
    cadena = Replace(cadena, "Á", "A")
    cadena = Replace(cadena, "é", "e")
    cadena = Replace(cadena, "É", "E")
    cadena = Replace(cadena, "í", "i")
    cadena = Replace(cadena, "Í", "I")
    cadena = Replace(cadena, "ó", "o")
    cadena = Replace(cadena, "Ó", "O")
    cadena = Replace(cadena, "ú", "u")
    cadena = Replace(cadena, "Ú", "U")

    QuitarCaracteres = cadena
End Function
Sub ExportaContabilitatOtros(numAsiento, Di As Date, Df As Date, empresa, EsB)
'    Dim Rs As rdoResultset, data As Date, Deve, Haver
'
'        InformaMiss "Otros ", True
'        Set Rs = Db.OpenResultset("SELECT * From MovimentsExtres2007 order by movi")
'        Dim Movi
'        Movi = ""
'        While Not Rs.EOF
'            data = DateSerial(Mid(Right(Rs("Data"), 8), 1, 4), Mid(Right(Rs("Data"), 8), 5, 2), Mid(Right(Rs("Data"), 8), 7, 2))
'            If Not Movi = Rs("Movi") And Not Movi = "" Then numAsiento = numAsiento + 1
'            Movi = Rs("Movi")
'            Dim Partidadeve, PartidaHaver, Concepto
'            Partidadeve = ""
'
'            PartidaHaver = ""
'            Concepto = ""
'            Deve = 0
'            Haver = 0
'            If Not IsNull(Rs("Partidadebe")) Then
'                Partidadeve = Rs("Partidadebe")
'                Concepto = Rs("Concepto")
'                Deve = Rs("ImporteDebe")
'            End If
'
'            If Not IsNull(Rs("PartidaHaber")) Then
'                Partidadeve = Rs("PartidaHaber")
'                Concepto = Rs("Concepto")
'                Haver = Rs("importeHaver ")
'            End If
'
'            AsientoAdd numAsiento, data, Partidadeve, PartidaHaver, 0, Concepto, Deve, Haver, 0, 0, 0
'
'            Rs.MoveNext
'        Wend

End Sub

Sub ExportaContabilitatRecibidas(numAsiento, Di As Date, Df As Date, empresa, EsB)
    Dim D As Date, TaulaIva, TaulaData, Taulacomptab, i, j, TaulaRebudes, sql As String, K, rsCtb As rdoResultset, iva1, iva2, iva3, baseIva1, baseIva2, baseIva3, baseIva4, TeRetencions, TaulaRebudesData
        
        InformaMiss "Recibidas", True
        D = Di
        TaulaIva = NomTaulaFacturaIva(D)
        TaulaData = NomTaulaFacturaData(D)
        Taulacomptab = NomTaulaComptavilitzat(D)
        i = 0
        j = 0
        TaulaRebudes = tablaFacturaProforma(D)
        TaulaRebudesData = tablaFacturaProformaData(D)
        
        ExecutaComandaSql "Drop table TraspasTmp "
        sql = "select tn.empresaCodi, tn.idfactura idfactura, tn.dataFactura datafactura, "
        sql = sql & "tn.empNom clientNom, tn.empresaCodi clientCodi, "
        sql = sql & "tn.numFactura numFactura,isnull(tn.serie,'') serie, isnull(tn.total,0) total, "
        sql = sql & " tn.total nnn, isnull(tn.total,0) total_bo, isnull(tc.comptabilitzat,'NO') comp, '" & Taulacomptab & "' tablaData, "
        sql = sql & "isnull(p.NumFacturacion, '') numfacturacion, isnull(p.contra4,'60000000') contra4, isnull(p.contra7,'60000000') contra7, isnull(p.contra16,'60000000') contra16, "
        sql = sql & "isnull(p.direccion,'') direccion, isnull(p.ciudad,'') ciudad, isnull(p.nif, '') nif, "
        sql = sql & "isnull(p.cc,40000000+p.codi) cc, isnull(p.email,'') email, isnull(p.fax,'') fax, isnull(p.tlf1, '') tlf1 "
        For K = 0 To 3
            sql = sql & ",tn.baseIva" & (K + 1) & ", tn.iva" & (K + 1) & ",tn.baseRec" & (K + 1) & ",tn.rec" & (K + 1) & ", tn.ivarec" & (K + 1)
        Next
        sql = sql & " Into TraspasTmp from [" & TaulaRebudes & "] tn "
        sql = sql & " left join [" & Taulacomptab & "] tc on tn.idfactura = tc.id_doc "
        sql = sql & " left join (select idfactura, right(idfactura,38) idfactura2 from [" & TaulaRebudes & "]) te on tn.idfactura=te.idfactura "
        sql = sql & " left join ccproveedores p on p.id=tn.Empresacodi "
        sql = sql & " where tn.total<>0 and tn.datafactura between"
        sql = sql & " convert(datetime,'" & Right("0" & Day(Di), 2) & "/" & Right("0" & Month(Di), 2) & "/" & Right(CStr(Year(Di)), 2) & "',3)"
        sql = sql & " and convert(datetime,'" & Right("0" & Day(Df), 2) & "/" & Right("0" & Month(Df), 2) & "/" & Right(CStr(Year(Df)), 2) & "',3)"
        sql = sql & " + convert(datetime,'23:59:59',8) "
        sql = sql & " and isnull(tn.clientCodi,0) = " & empresa
'        Sql = Sql & " and numfactura='7' "
        ExecutaComandaSql sql
        
        ExecutaComandaSql "update t set baseiva4 = d.import from TraspasTmp t join [" & TaulaRebudesData & "] d on t.idfactura= d.idfactura and d.TipusIva=4"
        
        Set rsCtb = Db.OpenResultset("Select * from TraspasTmp order by dataFactura ")
        While Not rsCtb.EOF
            InformaMiss "Recibidas " & rsCtb("dataFactura"), True
            iva1 = Round(rsCtb("Iva1"), 2)
            iva2 = Round(rsCtb("Iva2"), 2)
            iva3 = Round(rsCtb("Iva3"), 2)

            baseIva1 = Round(rsCtb("baseIva1"), 2)
            baseIva2 = Round(rsCtb("baseIva2"), 2)
            baseIva3 = Round(rsCtb("baseIva3"), 2)
            baseIva4 = Round(rsCtb("baseIva4"), 2)
            TeRetencions = False
            InformaMiss "Factura: " & rsCtb("numFactura"), True
            
            If (rsCtb("numFactura") <> "") Then ExportaAmbIvaRebudes numAsiento, rsCtb("dataFactura"), rsCtb("clientCodi"), rsCtb("numFactura"), Round(rsCtb("Total"), 2), Round(rsCtb("Iva1"), 2), Round(rsCtb("Iva2"), 2), Round(rsCtb("Iva3"), 2), Round(rsCtb("baseIva1"), 2), Round(rsCtb("baseIva2"), 2), Round(rsCtb("baseIva3"), 2), Round(rsCtb("IvaRec4"), 2), rsCtb("idfactura")
            
            numAsiento = numAsiento + 1
            DoEvents
            rsCtb.MoveNext
            DadesExportaCpFlush
        Wend
        rsCtb.Close

End Sub

Sub ExportaContabilitat(empresa As String, data As String, Tipus As String, P4 As String, P5 As String, Optional idCalcul As String)
    Dim Descripcio, EsB As Boolean, numAsiento, Di As Date, Df As Date, nEmpresa As Double
    Dim rsEmp As rdoResultset, rsNA As rdoResultset
    
    If Not frmSplash.Debugant Then On Error GoTo norR
    nomFileTemp = App.Path & "\XdiartioTmp_" & Format(Now, "hhnnss") & ".Txt"
    
    MyKill nomFileTemp
    
    DonamNomTaulaNorma43
    SousNominaImportats
    
    Descripcio = ""
    EsB = EsUsuariContable(P5)
    numAsiento = 1
    DadesExportaCp = ""
    
    codiContableProveedorTotsOk
    
    Di = Car(data)
    Df = Car(data)
    codiContableProveedor 0
    
    If Di > Df Then Exit Sub
    If empresa = "" Then empresa = "0"
    nEmpresa = empresa
    Descripcio = " " & EmpresaCodiNom(nEmpresa) & " Desde " & Di & " Hasta " & Df
    nDigitos = DSubcuenta(nEmpresa)
    FormatExportacio = FormatExportacioBusca(nEmpresa)

    AsientoAddInit
    DadesExportaCpFlush
    
    If idCalcul <> "" Then 'CALCULO EXTERNO
        Set rsEmp = Db.OpenResultset("select * from hit.dbo.CalculsEspecials where id = '" & idCalcul & "'")
        If Not rsEmp.EOF Then EmpresaActual = rsEmp("Empresa")
    End If
   
    If Car(Tipus) = "on" Then
         If FormatExportacio = "A3" Then
            ExportaContabilitatEmitidasA3 numAsiento, Di, Df, nEmpresa, EsB
        Else
            ExportaContabilitatEmitidas numAsiento, Di, Df, nEmpresa, EsB
        End If
    End If
    DadesExportaCpFlush
    If Car(Tipus) = "on" Then ExportaContabilitatRecibidas numAsiento, Di, Df, nEmpresa, EsB
    DadesExportaCpFlush
    If Car(Tipus) = "on" Then ExportaContabilitatMoviments numAsiento, Di, Df, nEmpresa, EsB 'MOVIMENTS BANCS
    DadesExportaCpFlush
    If Car(Tipus) = "on" Then ExportaContabilitatsInicials numAsiento, Di, Df, nEmpresa, EsB
    DadesExportaCpFlush
    If Car(Tipus) = "on" Then ExportaContabilitatNominas numAsiento, Di, Df, nEmpresa, EsB
    DadesExportaCpFlush
    If Car(Tipus) = "on" Then ExportaContabilitatCalaixos numAsiento, Di, Df, nEmpresa, EsB
    DadesExportaCpFlush
    If Car(Tipus) = "on" Then
        If FormatExportacio = "A3" Then
            ExportaContabilitatVentasA3 numAsiento, Di, Df, nEmpresa, P4, EsB
        Else
            ExportaContabilitatVentas numAsiento, Di, Df, nEmpresa, P4, EsB
        End If
    End If
    DadesExportaCpFlush
    If Car(Tipus) = "on" Then ExportaContabilitatDescuadres numAsiento, Di, Df, nEmpresa, EsB
    DadesExportaCpFlush
    If Car(Tipus) = "on" Then ExportaContabilitatOtros numAsiento, Di, Df, nEmpresa, EsB
    DadesExportaCpFlush
    If Car(Tipus) = "on" Then ExportaContabilitatFacturacio numAsiento, Di, Df, nEmpresa, EsB
    DadesExportaCpFlush
    
    
    InformaMiss "Guardando " & numAsiento, True
    
    DadesExportaCpGet
    
    If Len(DadesExportaCp) > 0 Then
        Select Case FormatExportacio
            Case "A3": guardaFile DadesExportaCp, "A3", "SuEnlace", Now & " " & Descripcio, "Dat"
            Case Else: guardaFile DadesExportaCp, "ContaPlus", "Xdiario", Now & " " & Descripcio, "Txt"
        End Select
    End If
    
    InformaMiss "", True
    
    Exit Sub
    
norR:

Debug.Print "error"

Resume Next


End Sub

Sub ExportaANALITICA(Tipus As String, empresa As String, Semana As String, Optional idCalcul As String)
    Dim rsEmp As rdoResultset, rsFacturasE As rdoResultset, rsFReb As rdoResultset
    Dim semanaAux As Integer, lunes As Date, domingo As Date
    Dim idFactura As String, dataFactura As Date, numFactura As String, taulaFactura As String
    Dim rsEmpHit As rdoResultset, rsEmpSage As rdoResultset, empNif As String, empSage As String
    
    'If Not frmSplash.Debugant Then
    On Error GoTo norR
    
    If idCalcul <> "" Then 'CALCULO EXTERNO
        Set rsEmp = Db.OpenResultset("select * from hit.dbo.CalculsEspecials where id = '" & idCalcul & "'")
        If Not rsEmp.EOF Then EmpresaActual = rsEmp("Empresa")
    
        If UCase(EmpresaActual) = UCase("Tena") Or UCase(EmpresaActual) = UCase("HitRs") Then dbSage = "[silema_Ts].sage"
        If UCase(EmpresaActual) = UCase("PadeCava") Then dbSage = "[HIT_Ts].sage"
    End If

    semanaAux = 0
    lunes = CDate("01/01/" & Year(Now()))
    While Semana <> semanaAux
        lunes = DateAdd("d", 1, lunes)
        semanaAux = DatePart("ww", lunes, vbMonday, vbFirstFullWeek)
    Wend
    domingo = DateAdd("d", 6, lunes)
        
    Informa "ANALITICA SEMANAL " & EmpresaActual
    
    If UCase(EmpresaActual) = UCase("Tena") Or UCase(EmpresaActual) = UCase("HitRs") Or UCase(EmpresaActual) = UCase("PadeCava") Then
       'Select Case Tipus
        
        'Case "FACTURA_EMITIDA"
            For dataFactura = lunes To domingo
                taulaFactura = NomTaulaFacturaIva(dataFactura)
               
                Set rsFacturasE = Db.OpenResultset("select * from [" & taulaFactura & "] where EmpresaCodi=" & empresa & " and dataFactura = '" & dataFactura & "' order by dataFactura")
                While Not rsFacturasE.EOF
                   idFactura = rsFacturasE("idFactura")
                    numFactura = rsFacturasE("numFactura")
            
                    ExportaANALITICA_FacturaEmesa idFactura, dataFactura, numFactura, taulaFactura
            
                   rsFacturasE.MoveNext
                Wend
                rsFacturasE.Close
            Next
        
        'Case "FACTURA_RECIBIDA"
            For dataFactura = lunes To domingo
                taulaFactura = tablaFacturaProforma(dataFactura)
                
                Set rsFReb = Db.OpenResultset("select * from [" & taulaFactura & "] where ClientCodi=" & empresa & " and dataFactura = '" & dataFactura & "' order by numFactura", rdOpenForwardOnly, rdConcurReadOnly)
                While Not rsFReb.EOF
                    idFactura = rsFReb("idFactura")
                    numFactura = rsFReb("numFactura")
                    
                    ExportaANALITICA_FacturaRebuda idFactura, dataFactura, numFactura, taulaFactura
                    
                    rsFReb.MoveNext
                Wend
                rsFReb.Close
            Next
      'End Select
    End If
  
    Exit Sub
    
norR:

Debug.Print "error"

'Resume Next

End Sub


Sub ExportaMURANO_Contactos()
    Dim sql As String, Descripcio As String, rsEmp As rdoResultset, rsNEmp As rdoResultset, nEmpresa As Double, rsNA As rdoResultset, rsCtb As rdoResultset, numAsiento As String, botiga As String, Di As Date, D As Integer, idFactura As String, dataFactura As Date, numFactura As String, taulaFactura As String, rsHist As rdoResultset, dataInici As Date, dataFi As Date, idNorma43 As String, strSQL As String, rsClients, clientCodi, clienteNif As String, ClientNif As String, nom As String, conta, datos, cCompte, RsMu, IdSincro, IdMurano, Ccuenta, Tel, email
    
    If Not frmSplash.Debugant Then On Error GoTo norR
    
    If Not ExisteixTaula("MuranoSincroPlanSubcuentas") Then
       sql = "CREATE TABLE [MuranoSincroPlanSubcuentas] ( "
       sql = sql & " [Id] [nvarchar](255) NOT NULL DEFAULT (newid()),"
       sql = sql & " [Tipo] [nvarchar](255) NULL,"
       sql = sql & " [Codigo][nvarchar](255) NULL,"
       sql = sql & " [CodigoEmpresa][nvarchar](255) NULL,"
       sql = sql & " [IdMurano]  [nvarchar](255) NULL,"
       sql = sql & " [Fecha]    [datetime]   NULL, "
       sql = sql & " ) ON [PRIMARY] "
       ExecutaComandaSql sql
    End If
    
'ExecutaComandaSql "Delete MuranoSincroPlanSubcuentas" ' Reset !!!!
'****---- Clients


    ExecutaComandaSql "Delete Clients Where Codi <= 0 "
    Set rsClients = Db.OpenResultset("SELECT c.codi as codi , isnull(nif, '') nif,[nom llarg] as Nom ,Nom as Nom2 , adresa, ciutat, CP ,cc.valor as email FROM clients c Join constantsclient cc on cc.Codi = c.codi and variable = 'eMail' ORDER BY Codi ")
    
    
        
        Set rsClients = Db.OpenResultset("select isnull(valor,'') valor from constantsclient where variable = 'Tel' and codi =  " & clientCodi & "  ")
    If Not rsClients.EOF Then MuranoExecute "Update " & dbSage & ".dbo.ClientesProveedores Set [Telefono] = '" & Left(rsClients("Valor"), 9) & "' where cifdni='" & ClientNif & "' and not [TipoCif] = '" & Left(rsClients("Valor"), 9) & "' "
    
    Set rsClients = Db.OpenResultset("select isnull(valor,'') valor from constantsclient where variable = 'Email' and codi =  " & clientCodi & "  ")
    If Not rsClients.EOF Then MuranoExecute "Update " & dbSage & ".dbo.ClientesProveedores Set [EMail1] = '" & Left(rsClients("Valor"), 9) & "' where cifdni='" & ClientNif & "' and not [EMail1] = '" & Left(rsClients("Valor"), 9) & "' "

    
    
    While Not rsClients.EOF
        clientCodi = Trim(rsClients("Codi"))
        ClientNif = rsClients("Nif")
        
        ClientNif = Join(Split(ClientNif, "'"), "`")
        ClientNif = Join(Split(ClientNif, """"), "`")
        ClientNif = Left(ClientNif, 13)
        ClientNif = Replace(ClientNif, "-", "")
        ClientNif = Replace(ClientNif, " ", "")
        ClientNif = Replace(ClientNif, " ", "")
        ClientNif = Replace(ClientNif, " ", "")
        ClientNif = Trim(ClientNif)
        
        nom = Trim(rsClients("Nom"))
        If nom = "" Then nom = rsClients("Nom2")
        nom = Join(Split(nom, "'"), "`")
        nom = Join(Split(nom, """"), "`")
        nom = Left(nom, 35)
        InformaMiss "Murano Cuenta " & nom, True
        
        Tel = ""
        email = ""
        
'If InStr(nom, "81") > 0 Then
'nom = nom
'End If
        'VENTAS
        'conta = "43" & Right("00000000" & Trim(codiContable(clientCodi)), nDigitos - 2)
        cCompte = codiContable(clientCodi)
        If clientCodi = codiContable(clientCodi) Then cCompte = cCompte + 1000
        
        conta = "43" & Right("00000000" & Trim(cCompte), nDigitos - 2)
'        Set RsMu = Db.OpenResultset("Select * from MuranoSincroPlanSubcuentas where CodigoEmpresa='" & CodigoEmpresa & "' And tipo = 'Client' And Codigo = '" & clientCodi & "' ")
'        If RsMu.EOF Then
'            Db.Execute "Insert into MuranoSincroPlanSubcuentas (CodigoEmpresa, tipo , Codigo, Fecha ) values ('" & CodigoEmpresa & "','Client','" & clientCodi & "',getdate())"
'            Set RsMu = Db.OpenResultset("Select * from MuranoSincroPlanSubcuentas where CodigoEmpresa='" & CodigoEmpresa & "' And tipo = 'Client' And Codigo = '" & clientCodi & "' ")
'        End If
'        IdSincro = RsMu("Id")
'        IdMurano = RsMu("IdMurano")
        
        ExportaMURANO_SubcuentasEmpresaClientesProveedores clientCodi, ClientNif, nom, "", Tel, email
        
        
        
'        Sql = ""
'        Sql = Sql & "INSERT INTO PlanCuentas "
'        Sql = Sql & "(CodigoEmpresa, CodigoCuenta, Cuenta, ClienteOProveedor, CodigoDivisa, IndicadorProrrata, IdCuentaGuid, Bloqueo) "
'        Sql = Sql & "VALUES     (1, '430000081', 'IME MIL SL', 'C','', 0,NEWID(), 0) "
                
'        If IsNull(RsMu("IdMurano")) Then
'            Set RsMu = Db.OpenResultset("select * from " & dbSage & ".dbo.plancuentas where CodigoEmpresa = '" & CodigoEmpresa & "' and codigocuenta = '" & conta & "'")
'            If RsMu.EOF Then
'                MuranoExecute "Insert into  " & dbSage & ".dbo.plancuentas (CodigoEmpresa,CodigoCuenta) values ('" & CodigoEmpresa & "','" & conta & "')"
'                Set RsMu = Db.OpenResultset("select * from " & dbSage & ".dbo.plancuentas where CodigoEmpresa = '" & CodigoEmpresa & "' and codigocuenta = '" & conta & "'")
'            End If
'            IdMurano = RsMu("IdCuentaGuid")
'            Db.Execute "Update MuranoSincroPlanSubcuentas Set IdMurano = '" & IdMurano & "' Where Id = '" & IdSincro & "' "
'        End If
'
'        Set RsMu = Db.OpenResultset("select * from " & dbSage & ".dbo.plancuentas where IdCuentaGuid = '" & IdMurano & "' ")
'        If Not IsNull(RsMu("IdCuentaGuid")) Then If Not RsMu("Cuenta") = nom Then MuranoExecute "Update " & dbSage & ".dbo.plancuentas Set Cuenta = '" & nom & "' Where IdCuentaGuid = '" & IdMurano & "' "
'        If Not IsNull(RsMu("IdCuentaGuid")) Then If Not RsMu("codigocuenta") = conta Then MuranoExecute "Update " & dbSage & ".dbo.plancuentas Set codigocuenta = '" & conta & "' Where IdCuentaGuid = '" & IdMurano & "' "
'        MuranoExecute "Update " & dbSage & ".dbo.plancuentas Set ClienteOProveedor = 'C' Where IdCuentaGuid = '" & IdMurano & "' "
'        MuranoExecute "Update " & dbSage & ".dbo.plancuentas Set IndicadorProrrata = '0' Where IdCuentaGuid = '" & IdMurano & "' "
'        MuranoExecute "Update " & dbSage & ".dbo.plancuentas Set Bloqueo           = '0' Where IdCuentaGuid = '" & IdMurano & "' "
'
        rsClients.MoveNext
    Wend
    rsClients.Close
'
''****************************PROVEEDORS
'    codiContableProveedorPosaOk ""
'
'    strSQL = "select e2.valor as codi,c.id,isnull(e1.valor,'') Acreedor, isnull(nif, '') nif, nombre as  nom,Direccion as  adresa, ciudad as ciutat, CP "
'    strSQL = strSQL & "FROM ccproveedores c "
'    strSQL = strSQL & "left join ccproveedoresextes e1 on e1.id = c.id and e1.nom = 'Acreedor' and e1.valor = 'on' "
'    strSQL = strSQL & "left join ccproveedoresextes e2 on e2.id = c.id and e2.nom = 'CodiIntern' "
'    strSQL = strSQL & "ORDER BY nom "
'    Set rsClients = Db.OpenResultset(strSQL)
'
'    While Not rsClients.EOF
'        Tel = ""
'        Email = ""
'        clientCodi = Trim(rsClients("Codi"))
'        ClientNif = rsClients("Nif")
'        ClientNif = Replace(ClientNif, "-", "")
'        ClientNif = Replace(ClientNif, " ", "")
'        ClientNif = Replace(ClientNif, " ", "")
'        ClientNif = Replace(ClientNif, " ", "")
'        ClientNif = Trim(ClientNif)
'
'        'VENTAS
'        nom = Trim(rsClients("Nom"))
'        nom = Join(Split(nom, "'"), "`")
'        nom = Join(Split(nom, """"), "`")
'        nom = Left(nom, 35)
'
'        InformaMiss "Murano Cuenta Prov. " & nom, True
'
'        cCompte = Trim(codiContableProveedor(rsClients("id")))
'        conta = cCompte
'
'        ExportaMURANO_SubcuentasEmpresaClientesProveedores CodigoEmpresa, clientCodi, ClientNif, nom, conta, "", Tel, Email
'
'        If rsClients("Acreedor") = "on" Then conta = "41" & Right("00000000" & Trim(clientCodi), nDigitos - 2)
'        Set RsMu = Db.OpenResultset("Select * from MuranoSincroPlanSubcuentas where CodigoEmpresa='" & CodigoEmpresa & "' And tipo = 'Proveidor' And Codigo = '" & clientCodi & "' ")
'        If RsMu.EOF Then
'            Db.Execute "Insert into MuranoSincroPlanSubcuentas (CodigoEmpresa, tipo , Codigo, Fecha ) values ('" & CodigoEmpresa & "','Proveidor','" & clientCodi & "',getdate())"
'            Set RsMu = Db.OpenResultset("Select * from MuranoSincroPlanSubcuentas where CodigoEmpresa='" & CodigoEmpresa & "' And tipo = 'Proveidor' And Codigo = '" & clientCodi & "' ")
'        End If
'        IdSincro = RsMu("Id")
'        IdMurano = RsMu("IdMurano")
'        If IsNull(RsMu("IdMurano")) Then
'            Set RsMu = Db.OpenResultset("select * from " & dbSage & ".dbo.plancuentas where CodigoEmpresa = '" & CodigoEmpresa & "' and codigocuenta = '" & conta & "'")
'            If RsMu.EOF Then
'                MuranoExecute "Insert into  " & dbSage & ".dbo.plancuentas (CodigoEmpresa,CodigoCuenta) values ('" & CodigoEmpresa & "','" & conta & "')"
'                Set RsMu = Db.OpenResultset("select * from " & dbSage & ".dbo.plancuentas where CodigoEmpresa = '" & CodigoEmpresa & "' and codigocuenta = '" & conta & "'")
'            End If
'            IdMurano = RsMu("IdCuentaGuid")
'            Db.Execute "Update MuranoSincroPlanSubcuentas Set IdMurano = '" & IdMurano & "' Where Id = '" & IdSincro & "' "
'        End If
'
'        Set RsMu = Db.OpenResultset("select * from " & dbSage & ".dbo.plancuentas where IdCuentaGuid = '" & IdMurano & "' ")
'        If Not IsNull(RsMu("IdCuentaGuid")) Then If Not RsMu("Cuenta") = nom Then MuranoExecute "Update " & dbSage & ".dbo.plancuentas Set Cuenta = '" & nom & "' Where IdCuentaGuid = '" & IdMurano & "' "
'        If Not IsNull(RsMu("IdCuentaGuid")) Then If Not RsMu("codigocuenta") = conta Then MuranoExecute "Update " & dbSage & ".dbo.plancuentas Set codigocuenta = '" & conta & "' Where IdCuentaGuid = '" & IdMurano & "' "
'
'        Set RsMu = Db.OpenResultset("select * from [Sage].[dbo].[ClientesConta] where CodigoEmpresa=" & CodigoEmpresa & " And CodigoClienteProveedor = " & clientCodi & "  ")
'        If RsMu.EOF Then
'            MuranoExecute "insert into  [Sage].[dbo].[ClientesConta] (CodigoEmpresa,ClienteOproveedor,CodigoClienteProveedor,SiglaNacion,CodigoCuenta) Values (" & CodigoEmpresa & ",'P'," & clientCodi & ",'ES','" & conta & "')"
'            Set RsMu = Db.OpenResultset("select * from [Sage].[dbo].[ClientesConta] where CodigoEmpresa=" & CodigoEmpresa & " And CodigoClienteProveedor = " & clientCodi & "  ")
'        End If
'        If Not IsNull(RsMu("CifDni")) Then If Not RsMu("CifDni") = ClientNif Then MuranoExecute "Update " & dbSage & ".dbo.ClientesConta Set CifDni = '" & ClientNif & "' Where CodigoEmpresa=" & CodigoEmpresa & " And CodigoClienteProveedor = " & clientCodi & "   "
'
'
''        If InStr(datos, conta) = 0 Then
''            datos = datos & Ccuenta                         'Código de la subcuenta
''            datos = datos & Left(rsClients("Nom") & Space(40), 40)                          'Nombre de la subcuenta
''            datos = datos & Left(ClientNif & Space(15), 15)                                 'NIF
''            datos = datos & Left(rsClients("Adresa") & Space(35), 35)                       'Domicilio
''            datos = datos & Left(rsClients("Ciutat") & Space(25), 25)                       'Población
''            datos = datos & Left(Space(10) & "-" & Space(10), 20)                           'Provincia
''            datos = datos & Left(rsClients("CP") & Space(5), 5)                             'CP
''            datos = datos & Left("F" & Space(1), 1)                                         'SubCuenta moneda extranjera
''            datos = datos & Left(Space(5), 5)                                               'Código divisa asociado
''            datos = datos & Left("F" & Space(1), 1)                                         'Uso obligatorio del documento
''            datos = datos & Left("F" & Space(1), 1)                                         'Ajustes M.E
''            datos = datos & Left(" " & Space(1), 1)                                         'Tipo IVA - No sujeto
''            datos = datos & Chr(13) & Chr(10)
''        End If
'        rsClients.MoveNext
'        DoEvents
'    Wend
'    rsClients.Close
'
''    'Contrapartidas
''    Set rsClients = rec("Select distinct  right(valor,len(valor) - CHARINDEX ('|',valor)) Co  ,left(valor,CHARINDEX ('|',valor)-1) De from ccproveedoresextes where nom = 'Contrapartida' ")
''    While Not rsClients.EOF
''        clientCodi = Trim(rsClients("Co"))
''        clienteNif = ""
''        conta = Left(Right("000000000000" & clientCodi, nDigitos) & "                           ", 12)
''        If InStr(datos, conta) = 0 Then
''            'VENTAS
''            datos = datos & conta                           'Código de la subcuenta
''            datos = datos & Left(rsClients("De") & Space(40), 40)                           'Nombre de la subcuenta
''            datos = datos & Left(ClientNif & Space(15), 15)                                 'NIF
''            datos = datos & Left("" & Space(35), 35)                        'Domicilio
''            datos = datos & Left("" & Space(25), 25)                        'Población
''            datos = datos & Left(Space(10) & "-" & Space(10), 20)                           'Provincia
''            datos = datos & Left("" & Space(5), 5)                              'CP
''            datos = datos & Left("F" & Space(1), 1)                                         'SubCuenta moneda extranjera
''            datos = datos & Left(Space(5), 5)                                               'Código divisa asociado
''            datos = datos & Left("F" & Space(1), 1)                                         'Uso obligatorio del documento
''            datos = datos & Left("F" & Space(1), 1)                                         'Ajustes M.E
''            datos = datos & Left(" " & Space(1), 1)                                         'Tipo IVA - No sujeto
''            datos = datos & Chr(13) & Chr(10)
''        End If
''        rsClients.MoveNext()
''    Wend
''    rsClients.Close()
''
''
''    Function BancNom(Cb)
''        Dim R
''        BancNom = "Entidad : " & Cb
''        Set R = rec("select entidad from hit.dbo.codigosentidades where identidad = '" & Cb & "'")
''        If Not R.EOF Then If Not IsNull(R("entidad")) Then BancNom = R("entidad")
''    End Function
''
''    'Bancos
''    Set rsClients = rec("Select distinct comu_numcuenta,Comu_banco,Comu_oficina  from norma43")
''    While Not rsClients.EOF
''        clientCodi = Trim(rsClients("comu_numcuenta"))
''        conta = Left("5720" & Right("000000000000" & clientCodi, nDigitos - 4) & Space(12), 12)
''        If InStr(datos, conta) = 0 Then
''            datos = datos & conta                           'Código de la subcuenta
''            datos = datos & Left(BancNom(rsClients("Comu_banco")) & " Oficina : " & rsClients("Comu_oficina") & Space(40), 40)                          'Nombre de la subcuenta
''            datos = datos & Left("" & Space(15), 15)                                    'NIF
''            datos = datos & Left("" & Space(35), 35)                        'Domicilio
''            datos = datos & Left("" & Space(25), 25)                        'Población
''            datos = datos & Left(Space(10) & "-" & Space(10), 20)                           'Provincia
''            datos = datos & Left("" & Space(5), 5)                              'CP
''            datos = datos & Left("F" & Space(1), 1)                                         'SubCuenta moneda extranjera
''            datos = datos & Left(Space(5), 5)                                               'Código divisa asociado
''            datos = datos & Left("F" & Space(1), 1)                                         'Uso obligatorio del documento
''            datos = datos & Left("F" & Space(1), 1)                                         'Ajustes M.E
''            datos = datos & Left(" " & Space(1), 1)                                         'Tipo IVA - No sujeto
''            datos = datos & Chr(13) & Chr(10)
''        End If
''        rsClients.MoveNext()
''    Wend
''    rsClients.Close()
'
'
    Exit Sub
    
norR:

Debug.Print "error"

Resume Next

End Sub



Sub ExportaMURANO_SubcuentasEmpresaClientesProveedores(clientCodi, ClientNif, nom, ClPr, Tel, email)
    Dim sql As String, Descripcio As String, rsEmp As rdoResultset, rsNEmp As rdoResultset, nEmpresa As Double, rsNA As rdoResultset, rsCtb As rdoResultset, numAsiento As String, botiga As String, Di As Date, D As Integer, idFactura As String, dataFactura As Date, numFactura As String, taulaFactura As String, rsHist As rdoResultset, dataInici As Date, dataFi As Date, idNorma43 As String, strSQL As String, rsClients, clienteNif As String, datos, cCompte, RsMu, IdSincro, IdMurano, Ccuenta
    
    nDigitos = 9
On Error GoTo 0
    clientCodi = Trim(clientCodi)
        
        Set RsMu = Db.OpenResultset("Select * from " & dbSage & ".dbo.ClientesProveedores where cifdni='" & ClientNif & "'")
        If RsMu.EOF Then
            sql = ""
            sql = sql & "INSERT INTO Sage.[dbo].[ClientesProveedores] "
            sql = sql & "([SiglaNacion]"
            sql = sql & ",[CifDni]"
            sql = sql & ",[CifEspanol]"
            sql = sql & ",[CifEuropeo]"
            sql = sql & ",[ClienteProveedor]"
            sql = sql & ",[CodigoSigla]"
            sql = sql & ",[ViaPublica]"
            sql = sql & ",[Numero1]"
            sql = sql & ",[Numero2]"
            sql = sql & ",[Escalera]"
            sql = sql & ",[Piso]"
            sql = sql & ",[Puerta]"
            sql = sql & ",[Letra]"
            sql = sql & ",[CodigoPostal]"
            sql = sql & ",[CodigoMunicipio]"
            sql = sql & ",[Municipio]"
            sql = sql & ",[ColaMunicipio]"
            sql = sql & ",[CodigoProvincia]"
            sql = sql & ",[Provincia]"
            sql = sql & ",[CodigoNacion]"
            sql = sql & ",[Nacion]"
            sql = sql & ",[Telefono]"
            sql = sql & ",[Telefono2]"
            sql = sql & ",[Telefono3]"
            sql = sql & ",[Fax]"
            sql = sql & ",[EMail1]"
            sql = sql & ",[EMail2]"
            sql = sql & ",[MarcaMenorSinNif]"
            sql = sql & ",[NombreEmpleado]"
            sql = sql & ",[PrimerApellidoEmpleado]"
            sql = sql & ",[SegundoApellidoEmpleado]"
            sql = sql & ",[PersonaFisicaJuridica]"
            sql = sql & ",[TipoCif]"
            sql = sql & ",[LetrasEtiqueta]"
            sql = sql & ",[FechaNacimiento]) "
            sql = sql & "Values "
            sql = sql & "('ES'"
            sql = sql & ",'" & ClientNif & "'"
            sql = sql & ",'" & Left(ClientNif, 9) & "'"
            sql = sql & ",'" & ClientNif & "'"
            sql = sql & ",'" & nom & "'"
            sql = sql & ",'" & ClPr & "'"
            sql = sql & ",''" 'BARCELONA
            sql = sql & ",''" '145
            sql = sql & ",''"
            sql = sql & ",''"
            sql = sql & ",''"
            sql = sql & ",''"
            sql = sql & ",''"
            sql = sql & ",''" '08820
            sql = sql & ",''" '08169
            sql = sql & ",''" 'PRAT DE LLOBREGAT, EL
            sql = sql & ",''"
            sql = sql & ",''" '08
            sql = sql & ",''" 'BARCELONA
            sql = sql & ",''" '108
            sql = sql & ",''" 'ESPAÑA
            sql = sql & ",''" '600989876
            sql = sql & ",''"
            sql = sql & ",''"
            sql = sql & ",''"
            sql = sql & ",''" 'Tienda81@Silemabcn.es
            sql = sql & ",''"
            sql = sql & ",0" 'MarcaMenorSinNif
            sql = sql & ",''"
            sql = sql & ",''"
            sql = sql & ",''"
            sql = sql & ",'J'" 'PersonaFisicaJuridica
            sql = sql & ",'C'" ' TipoCif
            sql = sql & ",''"
            sql = sql & ",NULL) "
            MuranoExecute sql
        End If
    
    MuranoExecute "Update " & dbSage & ".dbo.ClientesProveedores Set [SiglaNacion] = 'ES' where cifdni='" & ClientNif & "' and not [SiglaNacion] = 'ES' "
    MuranoExecute "Update " & dbSage & ".dbo.ClientesProveedores Set [CifEspanol] = '" & Left(ClientNif, 9) & "' where cifdni='" & ClientNif & "' and not [CifEspanol] = '" & Left(ClientNif, 9) & "' "
    MuranoExecute "Update " & dbSage & ".dbo.ClientesProveedores Set [CifEuropeo] = '" & ClientNif & "' where cifdni='" & ClientNif & "' and not [CifEuropeo] = '" & ClientNif & "' "
    MuranoExecute "Update " & dbSage & ".dbo.ClientesProveedores Set [ClienteProveedor] = '" & nom & "' where cifdni='" & ClientNif & "' and not [ClienteProveedor] = '" & nom & "' "
    MuranoExecute "Update " & dbSage & ".dbo.ClientesProveedores Set [CodigoSigla] = '" & ClPr & "' where cifdni='" & ClientNif & "' and not [CodigoSigla] = '" & ClPr & "' "
    MuranoExecute "Update " & dbSage & ".dbo.ClientesProveedores Set [MarcaMenorSinNif] = '0' where cifdni='" & ClientNif & "' and not [MarcaMenorSinNif] = '0' "
    MuranoExecute "Update " & dbSage & ".dbo.ClientesProveedores Set [PersonaFisicaJuridica] = 'J' where cifdni='" & ClientNif & "' and not [PersonaFisicaJuridica] = 'J' "
    
'    Set RsMu = Db.OpenResultset("Select * from " & dbSage & ".dbo.ClientesConta where CodigoEmpresa = '" & CodigoEmpresa & "' And CifDni='" & ClientNif & "' and CodigoCuenta = '" & conta & "' ")
'    If RsMu.EOF Then
'
'        MuranoExecute "delete " & dbSage & ".dbo.ClientesConta where CodigoCuenta= '" & conta & "' and CodigoEmpresa= '" & CodigoEmpresa & "' "
'
'        sql = ""
'        sql = sql & "INSERT INTO " & dbSage & ".dbo.ClientesConta "
'        sql = sql & "(CodigoEmpresa, ClienteOproveedor, CodigoClienteProveedor, SiglaNacion, CifDni, CodigoTransaccion, CodigoRetencion, CodigoTipoEfecto, Contrapartida, "
'        sql = sql & "RemesaHabitual, Deducible, CodigoIva, Mediacion, Exclusion347, NumeroPlazos, DiasPrimerPlazo, DiasEntrePlazos, DiasFijos1, DiasFijos2, DiasFijos3, "
'        sql = sql & "InicioNoPago, FinNoPago, ControlarFestivos, DiasRetroceso, MesesComerciales, EnEuros_, CodigoCuenta, CodigoCondiciones, CodigoCuentaEfecto, CodigoTerritorio, "
'        sql = sql & "RetencionInformativa, CodigoCuentaImpagado, AsesorNominaLW, EmpresaNominaLW, ClienteProveedor, CifEuropeo, CodigoConcepto, CriterioIva, PlazoMedioPCMA) "
'        sql = sql & "VALUES     ('" & CodigoEmpresa & "', 'C', '', 'ES', '" & ClientNif & "', 1, 0, 0, '', '', -1, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, '" & conta & "',0,'', 0, 0, '', '', '', 'IME MIL SL', 'B61957189', 0, 0, 0) "
'        MuranoExecute sql
'    End If
'
'    MuranoExecute "Update " & dbSage & ".dbo.ClientesConta Set SiglaNacion='ES' where CifDni='" & ClientNif & "' and CodigoEmpresa='" & CodigoEmpresa & "' and not SiglaNacion = 'ES' "
'    MuranoExecute "Update " & dbSage & ".dbo.ClientesConta Set ClienteOproveedor='C' where CifDni='" & ClientNif & "' and CodigoEmpresa='" & CodigoEmpresa & "' and not ClienteOproveedor = 'C' "
'    MuranoExecute "Update " & dbSage & ".dbo.ClientesConta Set CodigoTransaccion='1' where CifDni='" & ClientNif & "' and CodigoEmpresa='" & CodigoEmpresa & "' and not CodigoTransaccion = '1' "
'    MuranoExecute "Update " & dbSage & ".dbo.ClientesConta Set CodigoRetencion='0' where CifDni='" & ClientNif & "' and CodigoEmpresa='" & CodigoEmpresa & "' and not CodigoRetencion = '0' "
'    MuranoExecute "Update " & dbSage & ".dbo.ClientesConta Set CodigoTipoEfecto='0' where CifDni='" & ClientNif & "' and CodigoEmpresa='" & CodigoEmpresa & "' and not CodigoTipoEfecto = '0' "
'    MuranoExecute "Update " & dbSage & ".dbo.ClientesConta Set PlazoMedioPCMA='0' where CifDni='" & ClientNif & "' and CodigoEmpresa='" & CodigoEmpresa & "' and not PlazoMedioPCMA = '0' "
'    MuranoExecute "Update " & dbSage & ".dbo.ClientesConta Set CriterioIva='0' where CifDni='" & ClientNif & "' and CodigoEmpresa='" & CodigoEmpresa & "' and not CriterioIva = '0' "
'    MuranoExecute "Update " & dbSage & ".dbo.ClientesConta Set CodigoConcepto='0' where CifDni='" & ClientNif & "' and CodigoEmpresa='" & CodigoEmpresa & "' and not CodigoConcepto = '0' "
    
End Sub



Sub ExportaMURANO_Subcuentas()
    Dim sql As String, Descripcio As String, rsEmp As rdoResultset, rsNEmp As rdoResultset, nEmpresa As Double, rsNA As rdoResultset, rsCtb As rdoResultset, numAsiento As String, botiga As String, Di As Date, D As Integer, idFactura As String, dataFactura As Date, numFactura As String, taulaFactura As String, rsHist As rdoResultset, dataInici As Date, dataFi As Date, idNorma43 As String, strSQL As String, rsClients, clientCodi, clienteNif As String, ClientNif As String, nom As String, conta, datos, rs1, Prefix, rs2, Rs3
    Dim RsMu, codigoEmpresa, IdSincro, IdMurano
    
    ExportaMURANO_Contactos
    
    Set rs1 = Db.OpenResultset("select * from constantsempresa where camp like '%CampNif%' and not valor is null")
    While Not rs1.EOF
        Prefix = Left(rs1("Camp"), InStr(rs1("Camp"), "_"))
        Set rs2 = Db.OpenResultset("select * from " & dbSage & ".dbo.Empresas where cifdni='" & rs1("Valor") & "'")
        If Not rs2.EOF Then
            codigoEmpresa = rs2("CodigoEmpresa")
            InformaMiss "Murano Sincro Plan Contable " & rs2("Empresa")
            

            Set Rs3 = Db.OpenResultset("Select * from constantsempresa where left(camp," & Len(Prefix) & ") = '" & Prefix & "' ")
            While Not Rs3.EOF
                Select Case Rs3("camp")
                    Case Prefix & "CampNom"
                            MuranoExecute "update " & dbSage & ".dbo.Empresas  Set Empresa = '" & Rs3("Valor") & "' where CodigoEmpresa = '" & codigoEmpresa & "' "
                    Case Prefix & "CampNif"
                    Case Prefix & "CampAdresa"
                    Case Prefix & "CampCiutat"
                    Case Prefix & "CampCodiPostal"
                    Case Prefix & "CampTel"
                    Case Prefix & "CampFax"
                    Case Prefix & "CampMail"
'                    Case _CampServidorSMTP"
'                    Case _CampUsuariSMTP
'                    Case _CampContrasenyaSMTP
'                    Case _CampPORT
'                    Case _CampIdioma
'                    Case _CampMercantil
'                    Case _CampCompteCorrent
'                    Case _CampRSI
'                    Case _CampLliure
'                    Case _CampSeguentFactura
'                    Case _CampSerieDeFactura
'                    Case _CampDSubcuenta
'                    Case _CampRecEquivalencia
                End Select
                Rs3.MoveNext
            Wend
        End If
        rs1.MoveNext
    Wend

End Sub




Function InformeSincronizacionMURANO(botiga As String, cEmpresa As String, cEmpresaHit As String, mes As String)
    Dim para As String, asunto As String, cuerpo As String, nomEmp As String
    Dim rsHit As rdoResultset
    Dim rsMurano As rdoResultset
    Dim rsBots As rdoResultset, rsEmp As rdoResultset
    Dim rsDebug As rdoResultset
    Dim sql As String
    Dim Di As Date, Df As Date, D As Date
    Dim impH As Double, impM As Double, impIRPF_H As Double, impIRPF_M As Double, impHTkR As Double, impHTar As Double
    Dim b As Integer
    Dim arrBots() As String, arrBotsNom() As String
    
    InformaMiss "enviaEmailInformeMURANO", True
    
    On Error GoTo noExportat
    
    If cEmpresaHit = "0" Then
        Set rsEmp = Db.OpenResultset("select * from constantsEmpresa where camp = 'CampNom'")
    Else
        Set rsEmp = Db.OpenResultset("select * from constantsEmpresa where camp = '" & cEmpresaHit & "_CampNom'")
    End If
    If Not rsEmp.EOF Then nomEmp = rsEmp("Valor")
    asunto = "INFORME MURANO DE " & nomEmp & " " & Now()
    
    If botiga = "0" Then
        sql = "select cc.Valor, c.Codi, c.Nom "
        sql = sql & "from constantsclient cc "
        sql = sql & "left join clients c on cc.Codi=c.codi "
        sql = sql & "where cc.variable = 'EmpresaVendes' and cc.Codi in (select valor1 from ParamsHw) and c.codi is not null and cc.valor='" & cEmpresaHit & "' "
        sql = sql & "order by cc.Valor, c.nom"
        Set rsBots = Db.OpenResultset(sql)
        
        b = 0
        While Not rsBots.EOF
            ReDim Preserve arrBots(b)
            ReDim Preserve arrBotsNom(b)
            arrBots(b) = rsBots("Codi")
            arrBotsNom(b) = rsBots("Nom")
            
            b = b + 1
            rsBots.MoveNext
        Wend
    Else
        ReDim Preserve arrBots(0)
        ReDim Preserve arrBotsNom(0)
        arrBots(0) = botiga
        Set rsBots = Db.OpenResultset("select nom from clients where codi='" & botiga & "'")
        If Not rsBots.EOF Then
            arrBotsNom(0) = rsBots("nom")
        Else
            arrBotsNom(0) = botiga
        End If
    End If
    
    For b = 0 To UBound(arrBots)
        cuerpo = cuerpo & "<h1>BOTIGA: " & arrBotsNom(b) & " (" & arrBots(b) & ")</h1>"
        Di = CDate("01/" & mes & "/" & Year(Now()))
        Df = DateAdd("D", -1, DateAdd("M", 1, Di))
        
        D = Di
        While D <= Df
            'TARGETES
            Set rsHit = Db.OpenResultset("select isnull(sum(abs(import)), 0) import from fac_tena.dbo.[" & NomTaulaMovi(D) & "] where botiga='" & arrBots(b) & "' and day(data)=" & Day(D) & " and motiu like 'Pagat Targeta :%'")
            If Not rsHit.EOF Then impHTar = rsHit("import")
    
            'sql = "select isnull(sum(importeAsiento), 0) import from " & dbSage & ".dbo.movimientos "
            'sql = sql & "where asiento in (select asiento from fac_tena.dbo." & TaulaHistoricoMURANO(D) & " where codigoEmpresa=" & cEmpresa & " and day(fechaAsiento)=" & Day(D) & " and month(fechaAsiento)=" & Month(D) & " and year(fechaAsiento)=" & Year(D) & " and param1='" & arrBots(b) & "') "
            'sql = sql & "and ejercicio='" & Year(D) & "' and codigoEmpresa=" & cEmpresa & " and comentario like 'Cobros Tarjeta%' and cargoAbono='H'"
            'Set rsMurano = Db.OpenResultset(sql)
            'If Not rsMurano.EOF Then impM = rsMurano("import")
            
            'If Abs(impH - impM) > 0.01 Then
            '    cuerpo = cuerpo & "<h2>NO cuadra el importe de tarjetas del dia " & Day(D) & "/" & Month(D) & " HIT: [" & impH & "] MURANO: [" & impM & "]</h2>"
            'End If
        
            cuerpo = cuerpo & "<h2>" & Day(D) & "/" & Month(D) & "</h2>"
            
            'VENTAS
            Set rsHit = Db.OpenResultset("select isnull(sum(import), 0) import from fac_tena.dbo.[" & NomTaulaVentas(D) & "] where botiga='" & arrBots(b) & "' and day(data)=" & Day(D))
            If Not rsHit.EOF Then impH = rsHit("import")
            
            sql = "select isnull(sum(importeAsiento), 0) import from " & dbSage & ".dbo.movimientos "
            'sql = sql & "where asiento in (select asiento from fac_tena.dbo." & TaulaHistoricoMURANO(D) & " where codigoEmpresa=" & cEmpresa & " and day(fechaAsiento)=" & Day(D) & " and month(fechaAsiento)=" & Month(D) & " and year(fechaAsiento)=" & Year(D) & " and param1='" & arrBots(b) & "')"
            sql = sql & "where day(fechaAsiento)=" & Day(D) & " and month(fechaAsiento)=" & Month(D) & " and year(fechaAsiento)=" & Year(D) & " "
            sql = sql & "and ejercicio='" & Year(D) & "' and codigoEmpresa=" & cEmpresa & " and comentario like 'Ventas%" & arrBotsNom(b) & "%' and cargoAbono='D' "
            Set rsMurano = Db.OpenResultset(sql)
            If Not rsMurano.EOF Then impM = rsMurano("import")

            If Abs(impH - impM) > 0.01 Then
                cuerpo = cuerpo & "<dd><h3><FONT COLOR='#FF0000'>NO cuadra el importe de VENTAS >> HIT: [" & impH & "] MURANO: [" & impM & "]</FONT></h3></dd>"
            Else
                cuerpo = cuerpo & "<dd><h3>VENTAS OK</h3></dd>"
            End If
            
            'GASTOS
            Set rsHit = Db.OpenResultset("select isnull(sum(abs(import)), 0) import from fac_tena.dbo.[" & NomTaulaMovi(D) & "] where botiga='" & arrBots(b) & "' and day(data)=" & Day(D) & " and Tipus_moviment in ('A', 'O') and motiu not like 'Pagat Targeta%' and motiu not like 'Entrega Diària%' and motiu not like 'Sortida de Canvi%' and motiu not like 'Pagat TkRs%' and motiu not like 'Albara%'")
            If Not rsHit.EOF Then impH = rsHit("import")
    
            sql = "select isnull(sum(importeAsiento), 0) import from " & dbSage & ".dbo.movimientos "
            'sql = sql & "where asiento in (select asiento from fac_tena.dbo." & TaulaHistoricoMURANO(D) & " where codigoEmpresa=" & cEmpresa & " and day(fechaAsiento)=" & Day(D) & " and month(fechaAsiento)=" & Month(D) & " and year(fechaAsiento)=" & Year(D) & " and param1='" & arrBots(b) & "')"
            sql = sql & "where day(fechaAsiento)=" & Day(D) & " and month(fechaAsiento)=" & Month(D) & " and year(fechaAsiento)=" & Year(D) & " "
            sql = sql & "and ejercicio='" & Year(D) & "' and codigoEmpresa=" & cEmpresa & " and comentario like 'GASTOS%" & arrBotsNom(b) & "%' and cargoAbono='H'"
            Set rsMurano = Db.OpenResultset(sql)
            If Not rsMurano.EOF Then impM = rsMurano("import")
            
            If Abs(impH - impM) > 0.01 Then
                cuerpo = cuerpo & "<dd><h3><FONT COLOR='#FF0000'>NO cuadra el importe de GASTOS >> HIT: [" & impH & "] MURANO: [" & impM & "]</FONT></h3></dd>"
            Else
                cuerpo = cuerpo & "<dd><h3>GASTOS OK</h3></dd>"
            End If
            
            'DESCUADRES
            Set rsHit = Db.OpenResultset("select isnull(sum(abs(import)), 0) import from fac_tena.dbo.[" & NomTaulaMovi(D) & "] where botiga='" & arrBots(b) & "' and day(data)=" & Day(D) & " and Tipus_moviment = 'J'")
            If Not rsHit.EOF Then impH = rsHit("import")
            
            sql = "select isnull(sum(importeAsiento), 0) import from " & dbSage & ".dbo.movimientos "
            'sql = sql & "where asiento in (select asiento from fac_tena.dbo." & TaulaHistoricoMURANO(D) & " where codigoEmpresa=" & cEmpresa & " and day(fechaAsiento)=" & Day(D) & " and month(fechaAsiento)=" & Month(D) & " and year(fechaAsiento)=" & Year(D) & " and param1='" & arrBots(b) & "')"
            sql = sql & "where day(fechaAsiento)=" & Day(D) & " and month(fechaAsiento)=" & Month(D) & " and year(fechaAsiento)=" & Year(D) & " "
            sql = sql & "and ejercicio='" & Year(D) & "' and codigoEmpresa=" & cEmpresa & " and comentario like 'DESCUADRE%" & arrBotsNom(b) & "%' and cargoAbono='H'"
            Set rsMurano = Db.OpenResultset(sql)
            If Not rsMurano.EOF Then impM = rsMurano("import")
            If Abs(impH - impM) > 0.01 Then
                cuerpo = cuerpo & "<dd><h3><FONT COLOR='#FF0000'>NO cuadra el importe de DESCUADRES >> HIT: [" & impH & "] MURANO: [" & impM & "]</FONT></h3></dd>"
            Else
                cuerpo = cuerpo & "<dd><h3>DESCUADRES OK</h3></dd>"
            End If
        
            'TICKETS RESTAURANT
            Set rsHit = Db.OpenResultset("select isnull(sum(abs(import)), 0) import from fac_tena.dbo.[" & NomTaulaMovi(D) & "] where botiga='" & arrBots(b) & "' and day(data)=" & Day(D) & " and Tipus_moviment='O' and motiu like 'Pagat TkRs%'")
            If Not rsHit.EOF Then impH = rsHit("import")
            impHTkR = impH
            
            sql = "select isnull(sum(importeAsiento), 0) import from " & dbSage & ".dbo.movimientos "
            'sql = sql & "where asiento in (select asiento from fac_tena.dbo." & TaulaHistoricoMURANO(D) & " where codigoEmpresa=" & cEmpresa & " and day(fechaAsiento)=" & Day(D) & " and month(fechaAsiento)=" & Month(D) & " and year(fechaAsiento)=" & Year(D) & " and param1='" & arrBots(b) & "')"
            sql = sql & "where day(fechaAsiento)=" & Day(D) & " and month(fechaAsiento)=" & Month(D) & " and year(fechaAsiento)=" & Year(D) & " "
            sql = sql & "and ejercicio='" & Year(D) & "' and codigoEmpresa=" & cEmpresa & " and comentario like 'Cobros ticket restaurant%" & arrBotsNom(b) & "%' and cargoAbono='H'"
            Set rsMurano = Db.OpenResultset(sql)
            If Not rsMurano.EOF Then impM = rsMurano("import")
            
            If Abs(impH - impM) > 0.01 Then
                cuerpo = cuerpo & "<dd><h3><FONT COLOR='#FF0000'>NO cuadra el importe de TICKETS RESTAURANT >> HIT: [" & impH & "] MURANO: [" & impM & "]</FONT></h3></dd>"
            Else
                cuerpo = cuerpo & "<dd><h3>TICKETS RESTAURANT OK</h3></dd>"
            End If
            
            'SORTIDA DE CAIXA FORTA
            Set rsHit = Db.OpenResultset("select isnull(sum(abs(import)), 0) import from fac_tena.dbo.[" & NomTaulaMovi(D) & "] where botiga='" & arrBots(b) & "' and day(data)=" & Day(D) & " and Tipus_moviment='O' and (motiu like 'Entrega Diària%' or motiu like 'Sortida de Canvi%')")
            If Not rsHit.EOF Then impH = rsHit("import")
            
            sql = "select isnull(sum(importeAsiento), 0) import from " & dbSage & ".dbo.movimientos "
            'sql = sql & "where asiento in (select asiento from fac_tena.dbo." & TaulaHistoricoMURANO(D) & " where codigoEmpresa=" & cEmpresa & " and day(fechaAsiento)=" & Day(D) & " and month(fechaAsiento)=" & Month(D) & " and year(fechaAsiento)=" & Year(D) & " and param1='" & arrBots(b) & "')"
            sql = sql & "where day(fechaAsiento)=" & Day(D) & " and month(fechaAsiento)=" & Month(D) & " and year(fechaAsiento)=" & Year(D) & " "
            sql = sql & "and ejercicio='" & Year(D) & "' and codigoEmpresa=" & cEmpresa & " and comentario like 'SALIDA DE CAJA A CAJA FUERTE%" & arrBotsNom(b) & "%' and cargoAbono='H'"
            Set rsMurano = Db.OpenResultset(sql)
            If Not rsMurano.EOF Then impM = rsMurano("import")
            
            If Abs(impH - impM) > 0.01 Then
                cuerpo = cuerpo & "<dd><h3><FONT COLOR='#FF0000'>NO cuadra el importe de SALIDA DE CAJA >> HIT: [" & impH & "] MURANO: [" & impM & "]</FONT></h3></dd>"
            Else
                cuerpo = cuerpo & "<dd><h3>SALIDA DE CAJA OK</h3></dd>"
            End If
            
            'COBRO EN METÁLICO
            Set rsHit = Db.OpenResultset("select isnull(sum(abs(import)), 0) import from fac_tena.dbo.[" & NomTaulaMovi(D) & "] where botiga='" & arrBots(b) & "' and day(data)=" & Day(D) & " and Tipus_moviment='Z' ")
            If Not rsHit.EOF Then impH = rsHit("import") - impHTar - impHTkR
            
            sql = "select isnull(sum(importeAsiento), 0) import from " & dbSage & ".dbo.movimientos "
            'sql = sql & "where asiento in (select asiento from fac_tena.dbo." & TaulaHistoricoMURANO(D) & " where codigoEmpresa=" & cEmpresa & " and day(fechaAsiento)=" & Day(D) & " and month(fechaAsiento)=" & Month(D) & " and year(fechaAsiento)=" & Year(D) & " and param1='" & arrBots(b) & "')"
            sql = sql & "where day(fechaAsiento)=" & Day(D) & " and month(fechaAsiento)=" & Month(D) & " and year(fechaAsiento)=" & Year(D) & " "
            sql = sql & "and ejercicio='" & Year(D) & "' and codigoEmpresa=" & cEmpresa & " and comentario like 'COBRO EN METALICO CAJA REGISTRA%" & arrBotsNom(b) & "%' and cargoAbono='H'"
            Set rsMurano = Db.OpenResultset(sql)
            If Not rsMurano.EOF Then impM = rsMurano("import")
            
            If Abs(impH - impM) > 0.01 Then
                cuerpo = cuerpo & "<dd><h3><FONT COLOR='#FF0000'>NO cuadra el importe de COBRO EN METALICO >> HIT: [" & impH & "] MURANO: [" & impM & "]</FONT></h3></dd>"
            Else
                cuerpo = cuerpo & "<dd><h3>COBRO EN METALICO OK</h3></dd>"
            End If
            
            
            D = DateAdd("D", 1, D)
        Wend
        
        'cuerpo = cuerpo & "<h1>DEBUG</h1>"
        'Set rsDebug = Db.OpenResultset("select * from debug where str like '%murano%" & arrBots(b) & "%' order by data desc")
        'While Not rsDebug.EOF
        '    cuerpo = cuerpo & "<h2>" & rsDebug("str") & "</h2>"
        '    rsDebug.MoveNext
        'Wend
    Next
    
    sf_enviarMail "", "ana@solucionesit365.com", asunto, cuerpo, "", ""

    cuerpo = ""
    
noExportat:
    
End Function
Function InformeBancosCajonesMURANO()
    Dim para As String, asunto As String, cuerpo As String, cuerpo2 As String
    Dim rsCtb As rdoResultset
    Dim rsMurano As rdoResultset
    Dim rsHist  As rdoResultset
    Dim sql As String
    Dim debe As Double, haber As Double, debeM As Double, haberM As Double
    Dim idNorma43 As String, cEmpresa As String
    Dim fecha As Date
    
    InformaMiss "enviaBancosCajasMURANO", True
    
    On Error GoTo noExportat
    
    asunto = "INFORME MURANO DE BANCOS Y CAJAS " & Now()
    
    Set rsCtb = Db.OpenResultset("select idNorma43, fecha, sum(Debe) Debe, sum(Haber) Haber from asientoscontables_2017 where month(FECHA)=1 group by idnorma43, FECHA Having Sum(debe) = Sum(haber) order by fecha")
    While Not rsCtb.EOF
        debe = rsCtb("Debe")
        haber = rsCtb("Haber")
        idNorma43 = rsCtb("idNorma43")
        fecha = CDate(rsCtb("fecha"))

        debeM = 0
        haberM = 0
        
        Set rsHist = Db.OpenResultset("select * from historicoExportacionMurano_2017 where param1='" & idNorma43 & "'")
        While Not rsHist.EOF
            cEmpresa = rsHist("CodigoEmpresa")
            
'            If InStr(1, idNorma43, "|") Then
'         ExportaMURANO "BANCS", "[" & idNorma43 & "]", "[" & Day(fecha) & "-" & Month(fecha) & "-" & Year(fecha) & "]", "", "", "", ""
'            End If
            
            Set rsMurano = Db.OpenResultset("select CargoAbono , sum(ImporteAsiento) Importe from " & dbSage & ".dbo.movimientos where codigoempresa=" & cEmpresa & " and asiento=" & rsHist("Asiento") & " group by CargoAbono")
            While Not rsMurano.EOF
                If rsMurano("CargoAbono") = "D" Then
                    debeM = debeM + rsMurano("Importe")
                ElseIf rsMurano("CargoAbono") = "H" Then
                    haberM = haberM + rsMurano("Importe")
                End If
                rsMurano.MoveNext
            Wend
            rsHist.MoveNext
        Wend
DoEvents
        If (Abs(debe - debeM) > 0.01) Or (Abs(haber - haberM) > 0.01) Then
            cuerpo = cuerpo & "<dd><h3><FONT COLOR='#FF0000'>LA NORMA 43 " & idNorma43 & " NO CUADRA >> DEBE HIT [" & debe & "] DEBE MURANO [" & debeM & "] HABER HIT [" & haber & "] HABER MURANO [" & haberM & "]</FONT></h3></dd>"
            If debeM = 0 And haberM = 0 Then
                If InStr(1, idNorma43, "|") Then
                    cuerpo2 = cuerpo2 & "<dd><h4>insert into feinesafer values (newid(), 'SincroMURANOCalaixos', 0, '[" & idNorma43 & "]', '[" & Day(fecha) & "-" & Month(fecha) & "-" & Year(fecha) & "]', '', '', '', getdate())</h3></dd>"
                Else
                    cuerpo2 = cuerpo2 & "<dd><h4>insert into feinesafer values (newid(), 'SincroMURANOBancs', 0, '[" & idNorma43 & "]', '[" & Day(fecha) & "-" & Month(fecha) & "-" & Year(fecha) & "]', '', '', '', getdate())</h3></dd>"
      '  ExportaMURANO "BANCS", "[" & idNorma43 & "]", "[" & Day(fecha) & "-" & Month(fecha) & "-" & Year(fecha) & "]", "", "", "", ""
                    
                    
                End If
            End If
        End If
        
        rsCtb.MoveNext
    Wend
    
    sf_enviarMail "", "ana@solucionesit365.com", asunto, cuerpo & cuerpo2, "", ""

    cuerpo = ""
    
noExportat:
    
End Function


Function InformeFacturasMURANO(cEmpresa As String, cEmpresaHit As String, mes As String)
    Dim para As String, asunto As String, cuerpo As String, cuerpo2 As String, nomEmp As String
    Dim rsFac As rdoResultset, rsEmp As rdoResultset
    Dim rsMurano As rdoResultset
    Dim sql As String
    Dim nFactura As String
    Dim fecha As Date
    Dim totalHit As Double, totalMurano As Double
    
    InformaMiss "enviaFacturasMURANO", True
    
    On Error GoTo noExportat
    
    If cEmpresaHit = "0" Then
        Set rsEmp = Db.OpenResultset("select * from constantsEmpresa where camp = 'CampNom'")
    Else
        Set rsEmp = Db.OpenResultset("select * from constantsEmpresa where camp = '" & cEmpresaHit & "_CampNom'")
    End If
    If Not rsEmp.EOF Then nomEmp = rsEmp("Valor")
    
    asunto = "INFORME MURANO DE FACTURAS EMITIDAS " & nomEmp & " " & Now()
    
    Set rsFac = Db.OpenResultset("select * from [facturacio_2017-" & Right("0" & mes, 2) & "_iva] where empresaCodi=" & cEmpresaHit & " order by dataFactura")
    While Not rsFac.EOF
        nFactura = rsFac("NumFactura")
        totalHit = rsFac("Total")
        
        Set rsMurano = Db.OpenResultset("select isnull(sum(ImporteAsiento), 0) Importe from " & dbSage & ".dbo.movimientos where codigoempresa=" & cEmpresa & " and comentario = 'F.num : " & Left(nFactura & "                 ", 17) & "' and cargoAbono='D'")
        If Not rsMurano.EOF Then
            totalMurano = rsMurano("Importe")
        End If
        
        If Abs(totalHit - totalMurano) > 0.5 Then
            cuerpo = cuerpo & "<dd><h3><FONT COLOR='#FF0000'>LA FACTURA " & nFactura & " NO CUADRA >> IMPORTE HIT [" & totalHit & "] IMPORTE MURANO [" & totalMurano & "] </FONT></h3></dd>"
        End If
        
        rsFac.MoveNext
    Wend
    
'Al revés: lo que hay en MURANO que este en hit
'select * from [facturacio_2017-01_iva] where empresacodi=4
'select distinct comentario from " & dbSage & ".dbo.movimientos where comentario like 'F.num : %' and codigoempresa=54 and cargoAbono='D' and month(fechaAsiento)=1

    sf_enviarMail "", "ana@solucionesit365.com", asunto, cuerpo & cuerpo2, "", ""

    cuerpo = ""
    
noExportat:
 
    
End Function



Sub ActualitzaSaldo(Cli As String, An As String)
    Dim rs As rdoResultset, rs2 As rdoResultset
    Dim sql As String, idNorma43 As String, CONCEP As String, nConc As String, nSubC1 As String, Concepte As String, idDeute As String
    Dim orden As String, debe As String, DESCRIPCIoN As String, FacturaId  As String, FacturaNum  As String, fecha  As String, haber  As String, taulaFactura  As String
    Dim D As Date, data As Date
    Dim CociCLient As Double, Ccli As Double, Acc As Double, botiga As Double, import As Double, dependenta As Double, AlbaraNum, P, pp
    Dim K As Integer, i As Integer
    Dim Posat As Boolean
    Dim DATA_FAC As data, TOTAL_FAC As Double
    
    D = DateSerial(An, 1, 1)
    
    If UCase(EmpresaActual) = UCase("Tena") Then
        asignaFacturasPendientes An, Cli
    End If
    
    InformaMiss "Actualitzant Saldo " & BotigaCodiNom(Cli)
    
    'Borrar asientos de facturas que se han eliminado
    sql = "delete from " & DonamNomTaulaAsientosContables(D) & " "
    sql = sql & "Where DESCRIPCION like 'Cobro Albara N.%' and FacturaNum is not null and "
    sql = sql & "DescripcionInterna not in ( "
    sql = sql & "select IdFactura  from [" & NomTaulaFacturaIva(DateSerial(An, 1, 1)) & "] union "
    sql = sql & "select IdFactura  from [" & NomTaulaFacturaIva(DateSerial(An, 2, 1)) & "] union "
    sql = sql & "select IdFactura  from [" & NomTaulaFacturaIva(DateSerial(An, 3, 1)) & "] union "
    sql = sql & "select IdFactura  from [" & NomTaulaFacturaIva(DateSerial(An, 4, 1)) & "] union "
    sql = sql & "select IdFactura  from [" & NomTaulaFacturaIva(DateSerial(An, 5, 1)) & "] union "
    sql = sql & "select IdFactura  from [" & NomTaulaFacturaIva(DateSerial(An, 6, 1)) & "] union "
    sql = sql & "select IdFactura  from [" & NomTaulaFacturaIva(DateSerial(An, 7, 1)) & "] union "
    sql = sql & "select IdFactura  from [" & NomTaulaFacturaIva(DateSerial(An, 8, 1)) & "] union "
    sql = sql & "select IdFactura  from [" & NomTaulaFacturaIva(DateSerial(An, 9, 1)) & "] union "
    sql = sql & "select IdFactura  from [" & NomTaulaFacturaIva(DateSerial(An, 10, 1)) & "] union "
    sql = sql & "select IdFactura  from [" & NomTaulaFacturaIva(DateSerial(An, 11, 1)) & "] union "
    sql = sql & "select IdFactura  from [" & NomTaulaFacturaIva(DateSerial(An, 12, 1)) & "]"
    sql = sql & ")"
    ExecutaComandaSql sql
    
    For K = 1 To 12
        D = DateSerial(An, K, 1)
                
        sql = "insert into FacturacioComentaris (IdFactura, Data, Comentari, Cobrat) "
        sql = sql & "select IdFactura, getdate(), '', 'N' "
        sql = sql & "from [" & NomTaulaFacturaIva(D) & "] "
        sql = sql & "where IdFactura not in (select IdFactura from FacturacioComentaris) "
        ExecutaComandaSql sql
        
        InformaMiss "Actualitzant Saldo " & BotigaCodiNom(Cli) & " " & D
        ExecutaComandaSql "Insert Into " & ClientsSaldos(D) & " (Client,Tipo,Origen,Data,Debe,Haber,Auxi1,Auxi2) Select clientcodi,'Factura','[" & NomTaulaFacturaIva(D) & "]',DataFactura + convert(datetime,'23:59')  ,total,0,numfactura,idfactura From [" & NomTaulaFacturaIva(D) & "] where not idfactura in (Select distinct Auxi2 from " & ClientsSaldos(D) & " Where  Tipo = 'Factura') "
        
'        If ExisteixTaula(NomTaulaMovi(D)) Then
'            For i = 1 To 31
'                DoEvents
'                sql = "SELECT *, cast(botiga as nvarchar)+ '|' + convert(varchar,data,103) + ' ' + convert(varchar,data,108) + '|' + cast(dependenta as nvarchar)  as IdNorma43 "
'                sql = sql & "FROM [" & NomTaulaMovi(D) & "] "
'                sql = sql & " where Day(data) = " & i & " And "
'                sql = sql & " left(Motiu,7) = 'Albara ' And "
'                sql = sql & " cast(botiga as nvarchar)+ '|' + convert(varchar,data,103) + ' ' + convert(varchar,data,108) + '|' + cast(dependenta as nvarchar) not in (Select Distinct IdNorma43 from " & DonamNomTaulaAsientosContables(D) & ") "
'                sql = sql & " order by data "

'                Set rs = Db.OpenResultset(sql)
'                While Not rs.EOF
'                    idNorma43 = rs("IdNorma43")
'                    Concepte = rs("Motiu")
'                    data = rs("Data")
'                    import = rs("Import")
'                    Botiga = rs("Botiga")
'                    Dependenta = rs("Dependenta")
'                    p = InStr(Concepte, " ")
'                    Pp = InStr(p + 2, Concepte, "a")
                    
'                    If Pp > 0 Then AlbaraNum = Trim(Mid(Concepte, p, Pp - p))
'                    If Not IsNumeric(AlbaraNum) Then AlbaraNum = -9999
                    
'                    sql = "SELECT * FROM [" & NomTaulaAlbarans(data) & "] where botiga='" & Botiga & "' and day(data) = '" & Day(data) & "' And num_tick = '" & Trim(AlbaraNum) & "' "
'                    Set Rs2 = Db.OpenResultset(sql)
'                    If Not Rs2.EOF Then
'                        Debug.Print idNorma43
'                        Ccli = Rs2("Otros")
'                        CociCLient = Rs2("Otros")
'                        CONCEP = "Cobro Albara N. " & AlbaraNum
'                        nConc = "Pago A Cnta "
'                        nSubC1 = "43" & Right("00000000" & 0, 6)
'                        Set Rs2 = Db.OpenResultset("SELECT c.* , cc.valor CodiContable FROM clients c left join constantsclient cc on c.codi=cc.codi and cc.variable='CodiContable' WHERE c.codi='" & Ccli & "'")
'                        If Not Rs2.EOF Then
'                            If Not IsNull(Rs2("CodiContable")) Then If IsNumeric(Rs2("CodiContable")) Then Ccli = Rs2("CodiContable")
'                            nConc = "Pago A Cnta " & Rs2("Nom")
'                            nSubC1 = "43" & Right("00000000" & Rs2("CodiContable"), 6)
'                        End If
'                        Debe = import
'                        Haber = 0
'                        CreaAsientoCtb idNorma43, "1", "C", "", CDate(data), CONCEP, " ", "  ", nSubC1, nConc, Haber, Debe, AlbaraNum
'                        ExecutaComandaSql "update " & DonamNomTaulaAsientosContables(CDate(data)) & " set referenciaInterna ='" & CociCLient & "' where idNorma43='" & idNorma43 & "' and orden = 1"
'                    End If
'                    rs.MoveNext
'                Wend
'                rs.Close
'            Next
'        End If
        
        If ExisteixTaula(NomTaulaAlbarans(D)) Then
            For i = 1 To 31
                DoEvents

                sql = "SELECT Botiga, Data, Dependenta, Num_tick, Otros, SUM(import) import, 'Albara ' + cast(cast(Num_tick as int) as varchar) Motiu, cast(botiga as nvarchar)+ '|' + convert(varchar,data,103) + ' ' + convert(varchar,data,108) + '|' + cast(dependenta as nvarchar)  as IdNorma43 "
                sql = sql & "FROM [" & NomTaulaAlbarans(D) & "] "
                sql = sql & "where Day(data) = " & i & " And "
                'sql = sql & " cast(botiga as nvarchar)+ '|' + convert(varchar,data,103) + ' ' + convert(varchar,data,108) + '|' + cast(dependenta as nvarchar) not in (Select Distinct IdNorma43 from " & DonamNomTaulaAsientosContables(D) & ") "
                sql = sql & " 'Cobro Albara N. ' + cast(cast(Num_tick as int) as varchar) not in (Select Distinct descripcion from " & DonamNomTaulaAsientosContables(D) & " where MONTH(fecha)>= " & Month(D) & ") "
                sql = sql & "group by Botiga, Data, Dependenta, Num_tick, Otros "
                sql = sql & "order by data"
                Set rs = Db.OpenResultset(sql)
                While Not rs.EOF
                    idNorma43 = rs("IdNorma43")
                    Concepte = rs("Motiu")
                    data = rs("Data")
                    import = rs("Import")
                    botiga = rs("Botiga")
                    dependenta = rs("Dependenta")
                    AlbaraNum = rs("Num_tick")
                    
                    sql = "SELECT * "
                    sql = sql & "From [" & NomTaulaMovi(data) & "] "
                    sql = sql & "where botiga='" & botiga & "' and Motiu like 'Albara%" & AlbaraNum & "%' and DAY(data)=" & Day(data) & " and dependenta='" & dependenta & "' "
                    sql = sql & "order by data"
                    Set rs2 = Db.OpenResultset(sql)
                    If Not rs2.EOF Then  'Pagat a botiga
                        Debug.Print idNorma43
                        Ccli = rs("Otros")
                        CociCLient = rs("Otros")
                        CONCEP = "Cobro Albara N. " & AlbaraNum
                        nConc = "Pago A Cnta "
                        nSubC1 = "43" & Right("00000000" & 0, 6)
                        Set rs2 = Db.OpenResultset("SELECT c.* , cc.valor CodiContable FROM clients c left join constantsclient cc on c.codi=cc.codi and cc.variable='CodiContable' WHERE c.codi='" & Ccli & "'")
                        If Not rs2.EOF Then
                            If Not IsNull(rs2("CodiContable")) Then If IsNumeric(rs2("CodiContable")) Then Ccli = rs2("CodiContable")
                            nConc = "Pago A Cnta " & rs2("Nom")
                            nSubC1 = "43" & Right("00000000" & rs2("CodiContable"), 6)
                        End If
                        debe = import
                        haber = 0
                        CreaAsientoCtb idNorma43, "1", "C", "", CDate(data), CONCEP, " ", "  ", nSubC1, nConc, haber, debe, AlbaraNum
                        ExecutaComandaSql "update " & DonamNomTaulaAsientosContables(CDate(data)) & " set referenciaInterna ='" & CociCLient & "' where idNorma43='" & idNorma43 & "' and orden = 1"
                    Else
                        Set rs2 = Db.OpenResultset("select * from CertificatDeutesAnticips where Params2='" & botiga & "' and dependenta='" & dependenta & "' and ltrim(Params1) like '%" & AlbaraNum & "%' and Accio='Asumit'")
                        If Not rs2.EOF Then 'Hi ha deute
                            idDeute = rs2("idDeute")
                            Set rs2 = Db.OpenResultset("select * from CertificatDeutesAnticips where idDeute='" & idDeute & "' and Accio='Pagat'")
                            If Not rs2.EOF Then 'Esta pagat
                                Debug.Print idNorma43
                                Ccli = rs("Otros")
                                CociCLient = rs("Otros")
                                CONCEP = "Cobro Albara N. " & AlbaraNum
                                nConc = "Pago A Cnta "
                                nSubC1 = "43" & Right("00000000" & 0, 6)
                                Set rs2 = Db.OpenResultset("SELECT c.* , cc.valor CodiContable FROM clients c left join constantsclient cc on c.codi=cc.codi and cc.variable='CodiContable' WHERE c.codi='" & Ccli & "'")
                                If Not rs2.EOF Then
                                    If Not IsNull(rs2("CodiContable")) Then If IsNumeric(rs2("CodiContable")) Then Ccli = rs2("CodiContable")
                                    nConc = "Pago A Cnta " & rs2("Nom")
                                    nSubC1 = "43" & Right("00000000" & rs2("CodiContable"), 6)
                                End If
                                debe = import
                                haber = 0
                                CreaAsientoCtb idNorma43, "1", "C", "", CDate(data), CONCEP, " ", "  ", nSubC1, nConc, haber, debe, AlbaraNum
                                ExecutaComandaSql "update " & DonamNomTaulaAsientosContables(CDate(data)) & " set referenciaInterna ='" & CociCLient & "' where idNorma43='" & idNorma43 & "' and orden = 1"
                            End If
                        End If
                    End If
                    rs.MoveNext
                Wend
                rs.Close
            Next
        End If
               
     Next
     
    InformaMiss "Actualitzant Saldo " & BotigaCodiNom(Cli) & " Assignem Albarans "
    For K = 1 To 12 ' Posem num factura als albarans cobrats
        D = DateSerial(An, K, 1)
        
        sql = "Update a Set a.FacturaNum = Fa.numfactura ,a.descripcioninterna=IdFactura , a.taulafactura = '" & NomTaulaFacturaIva(D) & "' From  [" & DonamNomTaulaAsientosContables(D) & "] a "
        sql = sql & "Join "
        sql = sql & "( "
        sql = sql & "select   I.IdFactura,i.numfactura,d.Albara from  [" & NomTaulaFacturaIva(D) & "] i "
        sql = sql & "join ( "
        sql = sql & "select distinct  idfactura , SUBSTRING (referencia , CHARINDEX('IdAlbaraBot:',referencia)+12 , CHARINDEX(']',referencia,CHARINDEX('IdAlbaraBot:',referencia)) -  CHARINDEX('IdAlbaraBot:',referencia) -12) as Albara "
        sql = sql & "from [" & NomTaulaFacturaData(D) & "] where  referencia like '%IdAlbaraBot:%' "
        sql = sql & ") d on d.idfactura = i.idfactura "
        sql = sql & ") Fa "
        sql = sql & "on a.descripcion like 'Cobro Albara N.%' and isnull(a.FacturaNum,'') ='' and a.FacturaId = fa.Albara "
        If K = 12 Then
            sql = sql & " and MONTH(a.fecha)= " & K
        Else
            sql = sql & " and (MONTH(a.fecha)= " & K & " or MONTH(a.fecha)= " & K + 1 & ")"
        End If
        ExecutaComandaSql sql
    Next
          
    InformaMiss "Actualitzant Saldo " & BotigaCodiNom(Cli) & " Marcant Facturas Pagadas "
    'Posem com a no pagades les factures amb pago per albara
    'Sql = "update c Set c.Comentari = 'Cobro Botiga ' + cast(A.Cobrat as varchar ) + ' en ' + cast(a.an as varchar) + ' Albarans' ,C.Cobrat = 'N'  from ( "
    'Sql = Sql & "select facturanum,SUM (HABER) Cobrat,MIN(Facturaid) ai,max(Facturaid) af,COUNT(*)  an "
    'Sql = Sql & "from " & DonamNomTaulaAsientosContables(D) & " where descripcion like 'Cobro Albara N.%'  group by facturanum "
    'Sql = Sql & ") a "
    'Sql = Sql & "join ( "
    'Sql = Sql & "select NumFactura,IdFactura,Total from [" & NomTaulaFacturaIva(DateSerial(An, 1, 1)) & "] union "
    'Sql = Sql & "select NumFactura,IdFactura,Total from [" & NomTaulaFacturaIva(DateSerial(An, 2, 1)) & "] union "
    'Sql = Sql & "select NumFactura,IdFactura,Total from [" & NomTaulaFacturaIva(DateSerial(An, 3, 1)) & "] union "
    'Sql = Sql & "select NumFactura,IdFactura,Total from [" & NomTaulaFacturaIva(DateSerial(An, 4, 1)) & "] union "
    'Sql = Sql & "select NumFactura,IdFactura,Total from [" & NomTaulaFacturaIva(DateSerial(An, 5, 1)) & "] union "
    'Sql = Sql & "select NumFactura,IdFactura,Total from [" & NomTaulaFacturaIva(DateSerial(An, 6, 1)) & "] union "
    'Sql = Sql & "select NumFactura,IdFactura,Total from [" & NomTaulaFacturaIva(DateSerial(An, 7, 1)) & "] union "
    'Sql = Sql & "select NumFactura,IdFactura,Total from [" & NomTaulaFacturaIva(DateSerial(An, 8, 1)) & "] union "
    'Sql = Sql & "select NumFactura,IdFactura,Total from [" & NomTaulaFacturaIva(DateSerial(An, 9, 1)) & "] union "
    'Sql = Sql & "select NumFactura,IdFactura,Total from [" & NomTaulaFacturaIva(DateSerial(An, 10, 1)) & "] union "
    'Sql = Sql & "select NumFactura,IdFactura,Total from [" & NomTaulaFacturaIva(DateSerial(An, 11, 1)) & "] union "
    'Sql = Sql & "select NumFactura,IdFactura,Total from [" & NomTaulaFacturaIva(DateSerial(An, 12, 1)) & "] ) b "
    'Sql = Sql & "on a.FacturaNum = b.NumFactura "
    
    
    'Sql = "update c Set c.Comentari = 'Cobro Botiga ' + cast(A.Cobrat as varchar ) + ' en ' + cast(a.an as varchar) + ' Albarans' ,C.Cobrat = 'N'  from ( "
    'Sql = Sql & "select facturanum,SUM (HABER) Cobrat,MIN(Facturaid) ai,max(Facturaid) af,COUNT(*)  an "
    'Sql = Sql & "from [" & DonamNomTaulaAsientosContables(DateSerial(An, 1, 1)) & "] where descripcion like 'Cobro Albara N.%'  group by facturanum "
    'Sql = Sql & ") a "
    'Sql = Sql & "join ( "
    'Sql = Sql & "select NumFactura,IdFactura,Total  from [" & NomTaulaFacturaIva(DateSerial(An, 1, 1)) & "] union "
    'Sql = Sql & "select NumFactura,IdFactura,Total  from [" & NomTaulaFacturaIva(DateSerial(An, 2, 1)) & "] union "
    'Sql = Sql & "select NumFactura,IdFactura,Total  from [" & NomTaulaFacturaIva(DateSerial(An, 3, 1)) & "] union "
    'Sql = Sql & "select NumFactura,IdFactura,Total  from [" & NomTaulaFacturaIva(DateSerial(An, 4, 1)) & "] union "
    'Sql = Sql & "select NumFactura,IdFactura,Total  from [" & NomTaulaFacturaIva(DateSerial(An, 5, 1)) & "] union "
    'Sql = Sql & "select NumFactura,IdFactura,Total  from [" & NomTaulaFacturaIva(DateSerial(An, 6, 1)) & "] union "
    'Sql = Sql & "select NumFactura,IdFactura,Total  from [" & NomTaulaFacturaIva(DateSerial(An, 7, 1)) & "] union "
    'Sql = Sql & "select NumFactura,IdFactura,Total  from [" & NomTaulaFacturaIva(DateSerial(An, 8, 1)) & "] union "
    'Sql = Sql & "select NumFactura,IdFactura,Total  from [" & NomTaulaFacturaIva(DateSerial(An, 9, 1)) & "] union "
    'Sql = Sql & "select NumFactura,IdFactura,Total  from [" & NomTaulaFacturaIva(DateSerial(An, 10, 1)) & "] union "
    'Sql = Sql & "select NumFactura,IdFactura,Total  from [" & NomTaulaFacturaIva(DateSerial(An, 11, 1)) & "] union "
    'Sql = Sql & "select NumFactura,IdFactura,Total  from [" & NomTaulaFacturaIva(DateSerial(An, 12, 1)) & "] ) b "
    'Sql = Sql & "on a.FacturaNum = b.NumFactura "
    'Sql = Sql & "join facturaciocomentaris c on b.IdFactura = c.IdFactura "
    'Sql = Sql & "Where (b.Total - a.Cobrat) < 0.8 * b.Total "
    'ExecutaComandaSql Sql
    
    'insert into facturacioComentaris (IdFactura , Data, Comentari , Cobrat )
    'select IdFactura, GETDATE(), '', 'N'
    'from (
    'select IdFactura  from [facturacio_2014-01_iva] union
    'select IdFactura  from [facturacio_2014-02_iva] union
    'select IdFactura  from [facturacio_2014-03_iva] union
    'select IdFactura  from [facturacio_2014-04_iva] union
    'select IdFactura  from [facturacio_2014-05_iva] union
    'select IdFactura  from [facturacio_2014-06_iva] union
    'select IdFactura  from [facturacio_2014-07_iva] union
    'select IdFactura  from [facturacio_2014-08_iva] union
    'select IdFactura  from [facturacio_2014-09_iva] union
    'select IdFactura  from [facturacio_2014-10_iva] union
    'select IdFactura  from [facturacio_2014-11_iva] union
    'select IdFactura  from [facturacio_2014-12_iva]
    ') x
    'where IdFactura not in (select IdFactura from facturacioComentaris)
    
    
    sql = "update c Set c.Comentari = 'Cobro Botiga ' + cast(A.Cobrat as varchar ) + ' en ' + cast(a.an as varchar) + ' Albarans' ,C.Cobrat = 'S'  from ( "
    sql = sql & "select descripcionInterna, facturanum,SUM (HABER) Cobrat,MIN(Facturaid) ai,max(Facturaid) af,COUNT(*)  an "
    sql = sql & "from [" & DonamNomTaulaAsientosContables(DateSerial(An, 1, 1)) & "] where descripcion like 'Cobro Albara N.%' "
    sql = sql & "group by descripcionInterna, facturanum "
    sql = sql & ") a "
    sql = sql & "join ( "
    sql = sql & "select NumFactura,IdFactura,Total  from [" & NomTaulaFacturaIva(DateSerial(An, 1, 1)) & "] union "
    sql = sql & "select NumFactura,IdFactura,Total  from [" & NomTaulaFacturaIva(DateSerial(An, 2, 1)) & "] union "
    sql = sql & "select NumFactura,IdFactura,Total  from [" & NomTaulaFacturaIva(DateSerial(An, 3, 1)) & "] union "
    sql = sql & "select NumFactura,IdFactura,Total  from [" & NomTaulaFacturaIva(DateSerial(An, 4, 1)) & "] union "
    sql = sql & "select NumFactura,IdFactura,Total  from [" & NomTaulaFacturaIva(DateSerial(An, 5, 1)) & "] union "
    sql = sql & "select NumFactura,IdFactura,Total  from [" & NomTaulaFacturaIva(DateSerial(An, 6, 1)) & "] union "
    sql = sql & "select NumFactura,IdFactura,Total  from [" & NomTaulaFacturaIva(DateSerial(An, 7, 1)) & "] union "
    sql = sql & "select NumFactura,IdFactura,Total  from [" & NomTaulaFacturaIva(DateSerial(An, 8, 1)) & "] union "
    sql = sql & "select NumFactura,IdFactura,Total  from [" & NomTaulaFacturaIva(DateSerial(An, 9, 1)) & "] union "
    sql = sql & "select NumFactura,IdFactura,Total  from [" & NomTaulaFacturaIva(DateSerial(An, 10, 1)) & "] union "
    sql = sql & "select NumFactura,IdFactura,Total  from [" & NomTaulaFacturaIva(DateSerial(An, 11, 1)) & "] union "
    sql = sql & "select NumFactura,IdFactura,Total  from [" & NomTaulaFacturaIva(DateSerial(An, 12, 1)) & "] ) b "
    sql = sql & "on a.FacturaNum = b.NumFactura and a.descripcionInterna = b.IdFactura "
    sql = sql & "join facturaciocomentaris c on b.IdFactura = c.IdFactura "
    sql = sql & "Where (b.Total - a.Cobrat) < 0.5 * b.Total "
    ExecutaComandaSql sql
    
    ' Esborrem eliminats
    ExecutaComandaSql "delete " & ClientsSaldos(D) & "  where origen = 'norma43conta' and not auxi2 in (select distinct idnorma43 from " & DonamNomTaulaAsientosContables(D) & ") "
    
    sql = "Insert Into  " & ClientsSaldos(D) & " (Client,Tipo,Origen,Data,Debe,Haber,Auxi1,Auxi2) "
    sql = sql & "Select referenciaInterna, 'Pago Albara Botiga', 'norma43conta', FECHA, DEBE, HABER, DESCRIPCION, idNorma43 "
    sql = sql & "from " & DonamNomTaulaAsientosContables(D) & " "
    sql = sql & "where orden = 1 and left(DESCRIPCION,14) = 'Cobro Albara N.' and idnorma43 not in (Select distinct Auxi2 From " & ClientsSaldos(D) & ") "

    ExecutaComandaSql "Delete " & ClientsSaldos(D) & " Where Tipo = 'Cobro Albara Botiga' and year(data) = " & Year(D)
    ExecutaComandaSql sql
    
    sql = "Insert Into  " & ClientsSaldos(D) & " (Client,Tipo,Origen,Data,Debe,Haber,Auxi1,Auxi2) "
    sql = sql & "Select referenciaInterna, 'Pago Factura', 'norma43conta', FECHA, DEBE, HABER, DESCRIPCION, idNorma43 "
    sql = sql & "from " & DonamNomTaulaAsientosContables(D) & " "
    sql = sql & "where orden = 1 and left(DESCRIPCION,14) <> 'Cobro Albara N.' and idnorma43 not in (Select distinct Auxi2 From " & ClientsSaldos(D) & ") "
   
    ExecutaComandaSql "Delete " & ClientsSaldos(D) & " Where Tipo = 'Pago Factura' and year(data) = " & Year(D)
    ExecutaComandaSql sql
    
    'sql = "Insert Into  " & ClientsSaldos(D) & " (Client,Tipo,Origen,Data,Debe,Haber,Auxi1,Auxi2) "
    'sql = sql & "Select f.clientcodi,'Cobro Factura ' , 'norma43conta',c5.valor ,c3.valor ,c4.valor,c2.valor,c1.idnorma43 "
    'sql = sql & "from  [norma43conta]  c1 join "
    'sql = sql & "[norma43conta]  c2 on c1.idnorma43 = c2.idnorma43 and c2.concepto = 'FacturaNum' and c2.orden=c1.orden join "
    'sql = sql & "[norma43conta]  c3 on c1.idnorma43 = c3.idnorma43 and c3.concepto = 'DEBE' and c3.orden=c1.orden join "
    'sql = sql & "[norma43conta]  c4 on c1.idnorma43 = c4.idnorma43 and c4.concepto = 'HABER' and c4.orden=c1.orden join "
    'sql = sql & "[norma43conta]  c5 on c1.idnorma43 = c5.idnorma43 and c5.concepto = 'FECHA' and c5.orden=c1.orden join "
    'sql = sql & "[norma43conta]  c6 on c1.idnorma43 = c6.idnorma43 and c6.concepto = 'FacturaId' and c6.orden=c1.orden "
    'sql = sql & "join ( "
    'For i = 1 To 12
    '    sql = sql & " select IdFactura,Clientcodi from [" & NomTaulaFacturaIva(DateSerial(Year(D), i, 1)) & "]  "
    '    If i < 12 Then sql = sql & " Union "
    'Next
    'sql = sql & " ) f on f.IdFactura = c6.valor "
    'sql = sql & " Where c1.concepto = 'TaulaFactura' and left(c1.valor,12) = '[facturacio_' "
    'sql = sql & " and year(c5.valor) =  " & Year(D)
    
    sql = "Insert Into  " & ClientsSaldos(D) & " (Client,Tipo,Origen,Data,Debe,Haber,Auxi1,Auxi2) "
    sql = sql & "Select f.clientcodi,'Cobro Factura ' , 'norma43conta', ac.FECHA, ac.DEBE, ac.HABER, ac.FacturaNum, ac.idnorma43 "
    sql = sql & "from  " & DonamNomTaulaAsientosContables(D) & " ac "
    sql = sql & "join ( "
    For i = 1 To 12
        sql = sql & " select IdFactura,Clientcodi from [" & NomTaulaFacturaIva(DateSerial(Year(D), i, 1)) & "]  "
        If i < 12 Then sql = sql & " Union "
    Next
    sql = sql & " ) f on f.IdFactura = ac.FacturaId "
    sql = sql & " Where left(ac.TaulaFactura,12) = '[facturacio_' "
    
    
    ExecutaComandaSql "Delete " & ClientsSaldos(D) & " Where Tipo = 'Cobro Factura ' and year(data) = " & Year(D)
    ExecutaComandaSql sql

End Sub
Sub asignaFacturasPendientes(An As String, codiCli As String)

    Dim rsFac As rdoResultset, rsCont1 As rdoResultset, rsCont2 As rdoResultset, sql As String, idFactura As String
    Dim D As Date, NumFac As String, codiFac As String, importFac As Double, importQuadrat As Double, importDisp As Double
    Dim idNorma43() As String, orden() As String, desc() As String, importDebe() As Double, i As Integer, c As Integer
    Dim copiaSufix As String
    Dim TengoimportDebe As Integer
    

    copiaSufix = Day(Now) & Month(Now) & Year(Now) & Hour(Now)
    ExecutaComandaSql "select * into " & DonamNomTaulaAsientosContables(DateSerial(An, 1, 1)) & "_" & copiaSufix & " from " & DonamNomTaulaAsientosContables(DateSerial(An, 1, 1))
    ExecutaComandaSql "select * into FacturacioComentaris_" & copiaSufix & " from FacturacioComentaris"
    
    InformaMiss "Asignando facturas pendientes de " & codiCli
    
    D = DateSerial(An, 1, 1)
    nDigitos = DSubcuenta(0)
    
    'Facturas NO cobradas en lo que va de año
    sql = "Select idfactura, total, clientCodi, case when isnull(clientcodiFac, '')='' then clientCodi else clientCodiFac end clientCodiFac, NumFactura, DataFactura "
    sql = sql & "From "
    sql = sql & "("
    While D < Now()
        FacturacioCreaTaulesBuides D
        sql = sql & "select * from [" & NomTaulaFacturaIva(D) & "] with (nolock) where clientcodi='" & codiCli & "'"
        If Month(D) < Month(Now()) Then sql = sql & " union "
        D = DateAdd("m", 1, D)
    Wend
    sql = sql & ") f "
    sql = sql & "where IdFactura  not in "
    sql = sql & "(select idfactura from FacturacioComentaris with (nolock) where Cobrat = 'S') "
    sql = sql & "order by DataFactura"

    Set rsFac = Db.OpenResultset(sql)
    While Not rsFac.EOF
        i = 0
        TengoimportDebe = 0
        importQuadrat = 0
        importDisp = 0
        importFac = rsFac("total")
        codiFac = rsFac("clientCodiFac")
        NumFac = rsFac("numFactura")
        idFactura = rsFac("idFactura")

        'Revisar si hay un asiento que cuadre con la factura
        'Primero intento colocarla en una que tenga importe pendiente
        sql = "select idnorma43, orden, haber, descripcion, "
        sql = sql & "substring(substring(descripcion,charindex('ImportePendiente:',descripcion)+17,len(descripcion)),0, charindex(']',substring(descripcion,charindex('ImportePendiente:',descripcion)+17,len(descripcion)))) impPendiente "
        sql = sql & "From " & DonamNomTaulaAsientosContables(DateSerial(An, 1, 1)) & " "
        sql = sql & "where SUBCUENTA like '" & ("43" & Right("000000000000", nDigitos - 2)) + CInt(codiFac) & "' and FacturaId='Pendiente' "
        sql = sql & "and CHARINDEX('ImportePendiente', descripcion)>0 "
        sql = sql & "order by fecha"
        Set rsCont1 = Db.OpenResultset(sql)
        While Not rsCont1.EOF
            TengoimportDebe = 1
            ReDim Preserve idNorma43(i)
            idNorma43(i) = rsCont1("idNorma43")
            ReDim Preserve orden(i)
            orden(i) = rsCont1("orden")
            ReDim Preserve desc(i)
            desc(i) = rsCont1("descripcion")
            ReDim Preserve importDebe(i)
            importDebe(i) = rsCont1("impPendiente")
            
            i = i + 1
            rsCont1.MoveNext
        Wend
        'Si no hay pendientes... o no hay suficiente importe
        sql = "select idnorma43, orden, haber, descripcion "
        sql = sql & "From " & DonamNomTaulaAsientosContables(DateSerial(An, 1, 1)) & " "
        sql = sql & "where SUBCUENTA like '" & ("43" & Right("000000000000", nDigitos - 2)) + CInt(codiFac) & "' and FacturaId='Pendiente' "
        sql = sql & " and CHARINDEX('ImportePendiente', descripcion)=0 "
        sql = sql & " order by fecha "
        Set rsCont2 = Db.OpenResultset(sql)
        '******************
        ' 21/01/2012
        '************ JORDI esta consulta no devuelve nada por lo tanto donde
        ' pone Comprobar si podemos liquidar el importe total de la factura peta
        ' 21/01/2012
        ' sql cuando peto: select idnorma43, orden, haber, descripcion From AsientosContables_2012 where SUBCUENTA like '43000000' and FacturaId='Pendiente'  and CHARINDEX('ImportePendiente', descripcion)=0  order by fecha
        ' peta en numfactura 121 id factura {A11A6935-8265-4B54-824E-F57F1CA66B04}
        '************
        While Not rsCont2.EOF
            TengoimportDebe = 1
            ReDim Preserve idNorma43(i)
            idNorma43(i) = rsCont2("idNorma43")
            ReDim Preserve orden(i)
            orden(i) = rsCont2("orden")
            ReDim Preserve desc(i)
            desc(i) = rsCont2("descripcion")
            ReDim Preserve importDebe(i)
            importDebe(i) = rsCont2("haber")
                
            i = i + 1
            rsCont2.MoveNext
        Wend

        'Comprobar si podemos liquidar el importe total de la factura
        '******************
        ' 21/01/2012
        ' PETA AQUI POR QUE importdebe no hay nada ni nunac ha tenido un redimpreserve ni a 0
        ' ya que las 2 consultas anteriores para la factura no hacen nada con importdebe
        ' pongo un if si no hay nada en importdebe
        '******************
        ' 21/01/2012
        If TengoimportDebe = 1 Then
            For c = 0 To UBound(importDebe)
                importDisp = importDisp + importDebe(c)
            Next
        End If
        
        If importDisp >= importFac Then
            i = 0
            While importQuadrat < importFac
                If importDebe(i) > (importFac - importQuadrat) Then
                    ExecutaComandaSql "Update " & DonamNomTaulaAsientosContables(DateSerial(An, 1, 1)) & " set descripcion='[ImportePendiente:" & (importDebe(i) - (importFac - importQuadrat)) & "]', facturaNum=facturaNum + '," & NumFac & "' where idnorma43='" & idNorma43(i) & "' and orden=" & orden(i)
                    importQuadrat = importFac
                Else
                    ExecutaComandaSql "Update " & DonamNomTaulaAsientosContables(DateSerial(An, 1, 1)) & " set descripcion='Cobro Facturas ' + facturaNum + '," & NumFac & "', facturaNum=facturaNum + '," & NumFac & "', facturaId='Cobro automatico' where idnorma43='" & idNorma43(i) & "' and orden=" & orden(i)
                    importQuadrat = importQuadrat + importDebe(i)
                    i = i + 1
                End If
            Wend
            
            'Marcar factura cobrada
            ExecutaComandaSql "insert into facturacioComentaris (idFactura, data, comentari, Cobrat) values ('" & idFactura & "', GETDATE(), 'Cobro automatico', 'S')"
        End If
        rsFac.MoveNext
    Wend
End Sub
Function BancoNumConta(iD, Banc) As String
    Dim CodiClient, strCodi, rs As rdoResultset, Num, c
    
    If Left(Banc, 4) <> "5720" Then
        BancoNumConta = Left(Banc & "000000000000", nDigitos)
    Else
        c = Banc
        Set rs = Db.OpenResultset("select comu_numcuenta from norma43 where idNorma43 = '" & iD & "'")
        If Not rs.EOF Then c = rs("comu_numcuenta")
        BancoNumConta = Left("5720" & Right("000000000000" & c, nDigitos - 4) & Space(12), 12)
    End If
    
    
    
    

End Function

Sub CalculaCalcul(Curts As Boolean, LLargs As Boolean, Emails As Boolean, SFtp As Boolean, iD As String)
    Dim D As Date, Di As String, Df As String, pt1 As String, pt2 As String, pt3 As String, pt4 As String, rs, Tipus As String, p1 As String, p1Bis As String, P2 As String, P3 As String, P4 As String, P5 As String, Cuants, rs2 As rdoResultset, rsEmail As rdoResultset, rsFac As rdoResultset, rsBancs As rdoResultset, D2 As Date, exclusio As Boolean, HoraEnvio As Double, rsE As rdoResultset
       
    Set rs = Db.OpenResultset("Select * From FeinesAFer Where Id = '" & iD & "' ")
    If rs.EOF Then Exit Sub

    dbSage = "[silema_Ts].sage"



    Tipus = NoNull(rs("Tipus"))
    p1 = NoNull(rs("Param1"))
    P2 = NoNull(rs("Param2"))
    P3 = NoNull(rs("Param3"))
    P4 = NoNull(rs("Param4"))
    P5 = NoNull(rs("Param5"))
    
    Select Case Tipus
         Case "FeinesPerFerAles23":
             D = StData(Car(p1))
             If (D = DateSerial(Year(Now), Month(Now), Day(Now)) And Hour(Now) >= 23) Or D < DateSerial(Year(Now), Month(Now), Day(Now)) Then
                GuardaHistoric Cnf.llicencia, Now, "Peticio->" & Tipus, p1, P2, P3, P4
                If D = DateSerial(Year(Now), Month(Now), Day(Now)) Then
                FesFeinesPerFerAles23
                End If
                ExecutaComandaSql "Delete FeinesAFer Where Tipus = 'FeinesPerFerAles23' "
                ExecutaComandaSql "Insert Into FeinesAFer (Tipus,Ciclica,Param1,Param2,Param3,Param4) Values ('FeinesPerFerAles23',0,'[" & Format(DateAdd("d", 1, Now), "dd-mm-yy") & "]','Si " & Now() & "','','') "
             End If
    End Select
    
    If Emails Then
        Select Case Tipus
    'PETICIONES --------------------------------------------------------------------------------------------------------------------------------------------------
            Case "AvisosTelegram":
                AvisosTelegram
            Case "SecreInformeHelp":
                SecreInformeHelp p1, P2, P3
                ExecutaComandaSql "Delete FeinesAFer Where Id = '" & iD & "' And Ciclica = 0"
            Case "SecreInformeLicencias":
                SecreInformeLicencias p1, P2, P3
                ExecutaComandaSql "Delete FeinesAFer Where Id = '" & iD & "' And Ciclica = 0"
            Case "SecreInformeVentas":
                SecreInformeVentas p1, P2, P3
                ExecutaComandaSql "Delete FeinesAFer Where Id = '" & iD & "' And Ciclica = 0"
            Case "SecreInformeReposicion":
                SecreInformeReposicion p1, P2, P3
                ExecutaComandaSql "Delete FeinesAFer Where Id = '" & iD & "' And Ciclica = 0"
            Case "SecreInformeResumenVentas":
                SecreResumenVentas p1, P2
                ExecutaComandaSql "Delete FeinesAFer Where Id = '" & iD & "' And Ciclica = 0"
            Case "SecreInformeSupervisora"
                SecreEmailSupervisoras p1, P2
                ExecutaComandaSql "Delete FeinesAFer Where Id = '" & iD & "' And Ciclica = 0"
            Case "SecreInformeCoordinadora"
                SecreEmailCoordinadoras p1, P2
                ExecutaComandaSql "Delete FeinesAFer Where Id = '" & iD & "' And Ciclica = 0"
            Case "SecreInformePedidoSemanal":
                SecreInformePedidoSemanal p1, P2, P3
                ExecutaComandaSql "Delete FeinesAFer Where Id = '" & iD & "' And Ciclica = 0"
            Case "SecreInformeProductos"
                SecreInformeProductos p1, P2, P3
                ExecutaComandaSql "Delete FeinesAFer Where Id = '" & iD & "' And Ciclica = 0"
            Case "SecreInformeUsoProductos"
                SecreInformeUsoProductos p1, P2, P3
                ExecutaComandaSql "Delete FeinesAFer Where Id = '" & iD & "' And Ciclica = 0"
            Case "SecreInformeProductosCompraVenta"
                SecreInformeProductosCompraVenta p1, P2, P3
                ExecutaComandaSql "Delete FeinesAFer Where Id = '" & iD & "' And Ciclica = 0"
            Case "calculaInformePrevisiones"
                calculaInformePrevisiones p1, P2, P3
                ExecutaComandaSql "Delete FeinesAFer Where Id = '" & iD & "' And Ciclica = 0"
            Case "calculaInformePrevisiones2"
                calculaInformePrevisiones2 p1, P2, P3
                ExecutaComandaSql "Delete FeinesAFer Where Id = '" & iD & "' And Ciclica = 0"
            Case "SecreActualizaPrevisiones"
                SecreActualizaPrevisiones P4, P2, P3
                ExecutaComandaSql "Delete FeinesAFer Where Id = '" & iD & "' And Ciclica = 0"
            Case "SecreInformeIncidencias"
                SecreInformeIncidencias p1, P2, P3
                ExecutaComandaSql "Delete FeinesAFer Where Id = '" & iD & "' And Ciclica = 0"
            'Case "SecreInformeIncidenciasSilema"
            '    SecreInformeIncidenciasSILEMA p1, P2, P3
            '    ExecutaComandaSql "Delete FeinesAFer Where Id = '" & iD & "' And Ciclica = 0"
            Case "SecreInformeMasas"
                SecreInformeMasas p1, P2, P3
                ExecutaComandaSql "Delete FeinesAFer Where Id = '" & iD & "' And Ciclica = 0"
            Case "SecreInformeTraspaso"
                enviaEmailSeguimentMURANO p1, P2, P3
                ExecutaComandaSql "Delete FeinesAFer Where Id = '" & iD & "' And Ciclica = 0"
            Case "SecreCuadranteSemanal"
                SecreCuadranteSemanal p1, P2, P3
                ExecutaComandaSql "Delete FeinesAFer Where Id = '" & iD & "' And Ciclica = 0"
            Case "SecreInformeInstalacion"
                SecreInformeInstalacion p1, P2, P3
                ExecutaComandaSql "Delete FeinesAFer Where Id = '" & iD & "' And Ciclica = 0"
            Case "SolicitarAutorizacion"
                SolicitudAutorizacionPago p1, P2, P3
                ExecutaComandaSql "Delete FeinesAFer Where Id = '" & iD & "' And Ciclica = 0"
            Case "SecreInformeBocadillos"
                SecreInformeBocadillos p1, P2, P3
                ExecutaComandaSql "Delete FeinesAFer Where Id = '" & iD & "' And Ciclica = 0"
            Case "SecreInformePersonal"
                SecreInformePersonal p1, P2, P3
                ExecutaComandaSql "Delete feinesafer where Id = '" & iD & "' And Ciclica = 0"
            Case "EnviaEmailIncidencia"
                GuardaHistoric Cnf.llicencia, Now, "Peticio->" & Tipus, p1, P2, P3, P4
                SecreEnviaEmailIncidencia p1, P2, P3, P4, P5
                ExecutaComandaSql "Delete feinesafer where Id = '" & iD & "' And Ciclica = 0"
            Case "SecreVeureTiquets"
                EnviaEmailAdjunto P2, "VEURE TIQUETS", CalculaExcelVeureTiquets(p1, P2, P3, P4, P5)
                ExecutaComandaSql "Delete feinesafer where Id = '" & iD & "' And Ciclica = 0"
            Case "SecreResumenHoras"
                SecreEmailResumenHoras p1, P2
                ExecutaComandaSql "Delete FeinesAFer Where Id = '" & iD & "' And Ciclica = 0"
                
    'GDT, CDP, CDC, .... ---------------------------------------------------------------------------------------------------------------------------------------------------
            Case "EnviaPedidoEmail": GuardaHistoric Cnf.llicencia, Now, "Peticio->" & Tipus, p1, P2, P3, P4
                Dim eMailCompras As String
                eMailCompras = ""
                
                Set rsEmail = Db.OpenResultset("select isnull(valor, '') valor from constantsEmpresa where camp='UsuariPOP3'")
                If Not rsEmail.EOF Then eMailCompras = rsEmail("valor")
                
                enviaEmailPedidoProveedor eMailCompras, p1, P2, P3
                ExecutaComandaSql "Delete FeinesAFer Where Id = '" & iD & "' "
                
                
    'AUTOMÁTICOS ---------------------------------------------------------------------------------------------------------------------------------------------------
            Case "ReportSeguimentMURANOxx":
                 D = StData(Car(p1))
                 If (D = DateSerial(Year(Now), Month(Now), Day(Now)) And Hour(Now) >= 8) Or D < DateSerial(Year(Now), Month(Now), Day(Now)) Then
                    enviaEmailSeguimentMURANO
                    ExecutaComandaSql "Delete FeinesAFer Where Id = '" & iD & "' And Ciclica = 0"
                    ExecutaComandaSql "Insert Into FeinesAFer (Tipus,Ciclica,Param1,Param2,Param3,Param4) Values ('ReportSeguimentMURANO',0,'[" & Format(DateAdd("d", 1, Now()), "dd-mm-yy") & "]','Si " & Now() & "','','') "
                 End If
            Case "InformeVentasCoordinadoras":
                 D = StData(Car(p1))
                 If (D = DateSerial(Year(Now), Month(Now), Day(Now)) And Hour(Now) >= 8) Or D < DateSerial(Year(Now), Month(Now), Day(Now)) Then
                    SecreEmailCoordinadoras
                    ExecutaComandaSql "Delete FeinesAFer Where Id = '" & iD & "' And Ciclica = 0"
                    ExecutaComandaSql "Insert Into FeinesAFer (Tipus,Ciclica,Param1,Param2,Param3,Param4) Values ('InformeVentasCoordinadoras',0,'[" & Format(DateAdd("d", 1, Now()), "dd-mm-yy") & "]','Si " & Now() & "','','') "
                 End If
            Case "InformeVentasSupervisoras":
                 D = StData(Car(p1))
                 If (D = DateSerial(Year(Now), Month(Now), Day(Now)) And Hour(Now) >= 8) Or D < DateSerial(Year(Now), Month(Now), Day(Now)) Then
                    SecreEmailSupervisoras
                    ExecutaComandaSql "Delete FeinesAFer Where Id = '" & iD & "' And Ciclica = 0"
                    ExecutaComandaSql "Insert Into FeinesAFer (Tipus,Ciclica,Param1,Param2,Param3,Param4) Values ('InformeVentasSupervisoras',0,'[" & Format(DateAdd("d", 1, Now()), "dd-mm-yy") & "]','Si " & Now() & "','','') "
                 End If
                
    'CÁLCULOS / PROCESOS ---------------------------------------------------------------------------------------------------------------------------------------------------
            Case "CodigoDeAccion":
                InterpretaCodigoDeAccion p1
                ExecutaComandaSql "Delete FeinesAFer Where Id = '" & iD & "' And Ciclica = 0"
        End Select
    End If
    
    If Curts Then
    
      Select Case Tipus
         Case "ImportarClients": GuardaHistoric Cnf.llicencia, Now, "Peticio->" & Tipus, p1, P2, P3, P4
            ImportarClients p1, P2, P3
            ExecutaComandaSql "Delete FeinesAFer Where Id = '" & iD & "' And Ciclica = 0"
         Case "ImportarComanda": GuardaHistoric Cnf.llicencia, Now, "Peticio->" & Tipus, p1, P2, P3, P4
            ImportarComanda p1, P2, P3, P4
            ExecutaComandaSql "Delete FeinesAFer Where Id = '" & iD & "' And Ciclica = 0"
         Case "ImportarArticles": GuardaHistoric Cnf.llicencia, Now, "Peticio->" & Tipus, p1, P2, P3, P4
            ImportarArticles p1, P2, P3
            ExecutaComandaSql "Delete FeinesAFer Where Id = '" & iD & "' And Ciclica = 0"
         Case "ImportarTarifa": GuardaHistoric Cnf.llicencia, Now, "Peticio->" & Tipus, p1, P2, P3, P4
            ImportarTarifa p1, P2, P3
            ExecutaComandaSql "Delete FeinesAFer Where Id = '" & iD & "' And Ciclica = 0"
         Case "ImportarArticlesEmpresa": GuardaHistoric Cnf.llicencia, Now, "Peticio->" & Tipus, p1, P2, P3, P4
            ImportarArticles p1, P2, P3
            ExecutaComandaSql "Delete FeinesAFer Where Id = '" & iD & "' And Ciclica = 0"
         Case "ImportarFamilies": GuardaHistoric Cnf.llicencia, Now, "Peticio->" & Tipus, p1, P2, P3, P4
            ImportarFamilies p1, P2, P3
            ExecutaComandaSql "Delete FeinesAFer Where Id = '" & iD & "' And Ciclica = 0"
         Case "ImportarPromocions": GuardaHistoric Cnf.llicencia, Now, "Peticio->" & Tipus, p1, P2, P3, P4
            ImportarPromocions p1, P2, P3
            ExecutaComandaSql "Delete FeinesAFer Where Id = '" & iD & "' And Ciclica = 0"
         Case "FesFactures": GuardaHistoric Cnf.llicencia, Now, "Peticio->" & Tipus, p1, P2, P3, P4
            Factura P2, P3, P4, P5, p1
            ExecutaComandaSql "Delete FeinesAFer Where Id = '" & iD & "' And Ciclica = 0"
         Case "DelFactura": GuardaHistoric Cnf.llicencia, Now, "Peticio->" & Tipus, p1, P2, P3, P4
            DelFactura p1, P2
            ExecutaComandaSql "Delete FeinesAFer Where Id = '" & iD & "' And Ciclica = 0"
         Case "ComandaAutomatica": GuardaHistoric Cnf.llicencia, Now, "Peticio->" & Tipus, p1, P2, P3, P4
             ComandaAutomatica P2, P3, P4
             ExecutaComandaSql "Delete FeinesAFer Where Id = '" & iD & "' And Ciclica = 0"
         Case "FesCopiaComandes": GuardaHistoric Cnf.llicencia, Now, "Peticio->" & Tipus, p1, P2, P3, P4
            CopiaComandes P2, P3, P4, P5, p1
             ExecutaComandaSql "Delete FeinesAFer Where Id = '" & iD & "' And Ciclica = 0"
         Case "FesCopiaComandesOrigen": GuardaHistoric Cnf.llicencia, Now, "Peticio->" & Tipus, p1, P2, P3, P4
            CopiaComandesOrigen P2, P3, P4, P5, p1
            ExecutaComandaSql "Delete FeinesAFer Where Id = '" & iD & "' And Ciclica = 0"
         Case "FesCopiaTraspas": GuardaHistoric Cnf.llicencia, Now, "Peticio->" & Tipus, p1, P2, P3, P4
            CopiaComandesTraspas P2, P3, P4, P5, p1
            ExecutaComandaSql "Delete FeinesAFer Where Id = '" & iD & "' And Ciclica = 0"
         Case "FesCopiaDiaria": GuardaHistoric Cnf.llicencia, Now, "Peticio->" & Tipus, p1, P2, P3, P4
            If UCase(EmpresaActual) = UCase("Carne") Then
                D = StData(Car(p1))
                If D < DateAdd("d", 6, Now) Then
                   Di = "[" & Format(DateAdd("d", -7, D), "dd-mm-yyyy") & "]"
                   Df = "[" & Format(D, "dd-mm-yyyy") & "]"
                   CopiaComandes Di, Df, "[-1]", "", "Servit"
                   ExecutaComandaSql "Delete FeinesAFer Where Id = '" & iD & "' And Ciclica = 0"
                   ExecutaComandaSql "Update FeinesAFer Set Param1 = '" & "[" & Format(DateAdd("d", 1, D), "dd-mm-yyyy") & "]" & "' Where Id = '" & iD & "'"
                End If
             End If
         Case "FesImportarTicketsAFacturacio": GuardaHistoric Cnf.llicencia, Now, "Peticio->" & Tipus, p1, P2, P3, P4
            ImportarTicketsAFacturacio P4, P5, P2, P3
            ExecutaComandaSql "Delete FeinesAFer Where Id = '" & iD & "' And Ciclica = 0"
         Case "FesComandes": GuardaHistoric Cnf.llicencia, Now, "Peticio->" & Tipus, p1, P2, P3, P4
              ExecutaComandaSql "Delete FeinesAFer Where Id = '" & iD & "' And Ciclica = 0"
              
         Case "FesFacturesAutomatiques":
            D = StData(Car(p1))
        
            If (D = DateSerial(Year(Now), Month(Now), Day(Now)) And Hour(Now) >= 12) Or D < DateSerial(Year(Now), Month(Now), Day(Now)) Then
                facturaAutomatica D, P2, P3
                GuardaHistoric Cnf.llicencia, Now, "Peticio->" & Tipus, p1, P2, P3, P4
                ExecutaComandaSql "Delete FeinesAFer Where Id = '" & iD & "' And Ciclica = 0"
                ExecutaComandaSql "Insert Into FeinesAFer (Tipus,Ciclica,Param1,Param2,Param3,Param4,Param5) Values ('FesFacturesAutomatiques',0,'[" & Format(DateAdd("d", 7, D), "dd-mm-yy") & "]','" & P2 & "','" & P3 & "','" & P4 & "', '" & P5 & "') "
            End If
              
         Case "FesFacturesAutomatiquesSoluciones":
            D = StData(Car(p1))
        
            If (D = DateSerial(Year(Now), Month(Now), Day(Now)) And Hour(Now) >= 12) Or D < DateSerial(Year(Now), Month(Now), Day(Now)) Then
                facturaAutomaticaSoluciones D
                GuardaHistoric Cnf.llicencia, Now, "Peticio->" & Tipus, p1, P2, P3, P4
                ExecutaComandaSql "Delete FeinesAFer Where Id = '" & iD & "' And Ciclica = 0"
                ExecutaComandaSql "Insert Into FeinesAFer (Tipus,Ciclica,Param1) Values ('FesFacturesAutomatiquesSoluciones',0,'[" & Format(DateAdd("d", 7, D), "dd-mm-yy") & "]') "
            End If
              
         Case "GeneraAlbaransProgramacioHITRS":
            D = StData(Car(p1))
        
            If (D = DateSerial(Year(Now), Month(Now), Day(Now)) And Hour(Now) >= 12) Or D < DateSerial(Year(Now), Month(Now), Day(Now)) Then
                AlbaransProgramacioHITRS D
                GuardaHistoric Cnf.llicencia, Now, "Peticio->" & Tipus, p1, P2, P3, P4
                ExecutaComandaSql "Delete FeinesAFer Where Id = '" & iD & "' And Ciclica = 0"
                If Month(D) = 12 Then
                    ExecutaComandaSql "Insert Into FeinesAFer (Tipus,Ciclica,Param1) Values ('GeneraAlbaransProgramacioHITRS',0,'[01-01-" & Year(D) + 1 & "]') "
                Else
                    ExecutaComandaSql "Insert Into FeinesAFer (Tipus,Ciclica,Param1) Values ('GeneraAlbaransProgramacioHITRS',0,'[01-" & Right("00" & Month(D) + 1, 2) & "-" & Year(D) & "]') "
                End If
            End If
              
              
         Case "FesRecapitulativasMensual":
            D = StData(Car(p1))
        
            If (D = DateSerial(Year(Now), Month(Now), Day(Now)) And Hour(Now) >= 12) Or D < DateSerial(Year(Now), Month(Now), Day(Now)) Then
                Set rsFac = Db.OpenResultset("select cc1.codi, cc2.valor from constantsclient cc1 left join constantsclient cc2 on cc1.codi = cc2.codi and cc2.variable = 'Per_Facturacio' where cc1.variable = 'Recapitulativa' and cc1.valor='Recapitulativa' and (cc2.valor = '' or cc2.valor='Mensual')")
                While Not rsFac.EOF
                    FacturaRecapitulativa DateAdd("m", -1, D), DateAdd("d", -1, D), rsFac("codi")
                    GuardaHistoric Cnf.llicencia, Now, "Peticio->" & Tipus, DateAdd("m", -1, D), DateAdd("d", -1, D), rsFac("codi"), ""
                    rsFac.MoveNext
                Wend
                ExecutaComandaSql "Delete FeinesAFer Where Tipus = 'FesRecapitulativasMensual' "
                ExecutaComandaSql "Insert Into FeinesAFer (Tipus,Ciclica,Param1,Param2,Param3,Param4) Values ('FesRecapitulativasMensual',0,'[" & Format(DateAdd("m", 1, Now), "dd-mm-yy") & "]','Si " & Now() & "','','') "
            End If

         Case "FesRecapitulativasSetmanal":
            D = StData(Car(p1))
        
            If (D = DateSerial(Year(Now), Month(Now), Day(Now)) And Hour(Now) >= 12) Or D < DateSerial(Year(Now), Month(Now), Day(Now)) Then
                Set rsFac = Db.OpenResultset("select cc1.codi, cc2.valor from constantsclient cc1 left join constantsclient cc2 on cc1.codi = cc2.codi and cc2.variable = 'Per_Facturacio' where cc1.variable = 'Recapitulativa' and cc1.valor='Recapitulativa' and cc2.valor='Setmanal'")
                While Not rsFac.EOF
                    FacturaRecapitulativa DateAdd("d", -7, D), DateAdd("d", -1, D), rsFac("codi")
                    GuardaHistoric Cnf.llicencia, Now, "Peticio->" & Tipus, DateAdd("d", -7, D), DateAdd("d", -1, D), rsFac("codi"), ""
                    rsFac.MoveNext
                Wend
                ExecutaComandaSql "Delete FeinesAFer Where Tipus = 'FesRecapitulativasSetmanal' "
                ExecutaComandaSql "Insert Into FeinesAFer (Tipus,Ciclica,Param1,Param2,Param3,Param4) Values ('FesRecapitulativasSetmanal',0,'[" & Format(DateAdd("d", 7, Now), "dd-mm-yy") & "]','Si " & Now() & "','','') "
            End If

         Case "FesRecapitulativa":
            FacturaRecapitulativa CDate(P2), CDate(P3), p1
            GuardaHistoric Cnf.llicencia, Now, "Peticio->" & Tipus, p1, P2, P3, P4
            ExecutaComandaSql "Delete FeinesAFer Where Id = '" & iD & "' And Ciclica = 0"
            
         Case "RecalculaProveedores":
            GuardaHistoric Cnf.llicencia, Now, "Peticio->" & Tipus, p1, P2, P3, P4
            RecalculaProveedores
            ExecutaComandaSql "Delete FeinesAFer Where Id = '" & iD & "' "
            
         Case "ImpresoraBocadillos"
            If p1 < Now() Then
                GuardaHistoric Cnf.llicencia, Now, "Peticio->" & Tipus, p1, P2, P3, P4
                ImpresoraBocadillos_QueCalProduir "761"
                ExecutaComandaSql "Delete FeinesAFer Where Tipus = 'ImpresoraBocadillos' "
                ExecutaComandaSql "Insert Into FeinesAFer (Tipus,Ciclica,Param1,Param2,Param3,Param4) Values ('ImpresoraBocadillos', 0, '" & DateAdd("n", 5, Now) & "', 'Si " & Now() & "','','') "
            End If
            
         Case Else:
      End Select
    End If
    
    If LLargs Then
      Select Case Tipus
         Case "VendesTiquetMig":
             D = StData(Car(p1))
             If (D = DateSerial(Year(Now), Month(Now), Day(Now)) And Hour(Now) >= 10) Or D < DateSerial(Year(Now), Month(Now), Day(Now)) Then
                GuardaHistoric Cnf.llicencia, Now, "Peticio->" & Tipus, p1, P2, P3, P4
                VendesTiquetMig
                ExecutaComandaSql "Delete FeinesAFer Where Tipus = 'VendesTiquetMig' "
                ExecutaComandaSql "Insert Into FeinesAFer (Tipus,Ciclica,Param1,Param2,Param3,Param4) Values ('VendesTiquetMig',0,'[" & Format(DateAdd("d", 1, Now), "dd-mm-yy") & "]','Si " & Now() & "','','') "
             End If
         Case "AsignacionTurnosDeTrabajo":
             D = Car(p1)
             If D < Now Then
                GuardaHistoric Cnf.llicencia, Now, "Peticio->" & Tipus, p1, P2, P3, P4
                For D = DateAdd("d", -3, Now()) To Now()
                    AsignacionTurnosDeTrabajo D
                Next
                ExecutaComandaSql "Delete FeinesAFer Where Tipus = 'AsignacionTurnosDeTrabajo' "
                ExecutaComandaSql "Insert Into FeinesAFer (Tipus,Ciclica,Param1,Param2,Param3,Param4) Values ('AsignacionTurnosDeTrabajo',0,'[" & DateAdd("n", 20, Now) & "]','Si " & Now() & "','','') "
             End If
         Case "ExportaAlbarans": GuardaHistoric Cnf.llicencia, Now, "Peticio->" & Tipus, p1, P2, P3, P4
            ExportaAlbarans P2, P3
            ExecutaComandaSql "Delete FeinesAFer Where Id = '" & iD & "' And Ciclica = 0"
           
         Case "SecreAvisos": GuardaHistoric Cnf.llicencia, Now, "Peticio->" & Tipus, p1, P2, P3, P4
            SecreAvisos
         Case "Inventaris": GuardaHistoric Cnf.llicencia, Now, "Peticio->" & Tipus, p1, P2, P3, P4
            Dim botiga As Double, dia
            botiga = Car(P4)
            dia = Car(P2)
             ModificaComandesSegonsInventarisBotiga botiga, CVDate(dia), True
             GuardaHistoric Cnf.llicencia, Now, Tipus, p1, P2, "Peticion WWW", P4
             ExecutaComandaSql "Delete FeinesAFer Where Id = '" & iD & "' And Ciclica = 0"
         Case "TractaInventaris": GuardaHistoric Cnf.llicencia, Now, "Peticio->" & Tipus, p1, P2, P3, P4
            TractaInventaris P2, P3, P4
            GuardaHistoric Cnf.llicencia, Now, Tipus, p1, P2, P3, P4
            ExecutaComandaSql "Delete FeinesAFer Where Id = '" & iD & "' And Ciclica = 0"
         Case "AjuntaTpvS": GuardaHistoric Cnf.llicencia, Now, "Peticio->" & Tipus, p1, P2, P3, P4
            AjuntaTpvS Car(p1), Car(P2), Car(P3)
            ExecutaComandaSql "Delete FeinesAFer Where Id = '" & iD & "' And Ciclica = 0"
         Case "ActualizaSaldo": GuardaHistoric Cnf.llicencia, Now, "Peticio->" & Tipus, p1, P2, P3, P4
            ActualitzaSaldo p1, P2
             GuardaHistoric Cnf.llicencia, Now, Tipus, p1, P2, P3, P4
             ExecutaComandaSql "Delete FeinesAFer Where Id = '" & iD & "' "
'             ExecutaComandaSql "delete feinesafer where tipus = 'ActualizaSaldo' "  ' Per si apreten mes de un cop
         Case "CuantosVendidosDesdePedido": GuardaHistoric Cnf.llicencia, Now, "Peticio->" & Tipus, p1, P2, P3, P4
            CuantosVendidosDesdePedido p1, P3
             ExecutaComandaSql "Delete FeinesAFer Where Id = '" & iD & "' "
         Case "ConverteixEmpresa": GuardaHistoric Cnf.llicencia, Now, "Peticio->" & Tipus, p1, P2, P3, P4
            If Hour(Now) >= 3 And Hour(Now) <= 5 Then
                ConverteixEmpresa
                ExecutaComandaSql "Delete FeinesAFer Where Id = '" & iD & "' And Ciclica = 0"
            End If
         Case "CreaEmpressa": GuardaHistoric Cnf.llicencia, Now, "Peticio->" & Tipus, p1, P2, P3, P4
            CreaEmpressa p1, P2
             ExecutaComandaSql "Delete FeinesAFer Where Id = '" & iD & "' And Ciclica = 0"
         Case "CalculaEstadistic": GuardaHistoric Cnf.llicencia, Now, "Peticio->" & Tipus, p1, P2, P3, P4
            CalculaEstadistic P2, P3
             ExecutaComandaSql "Delete FeinesAFer Where Id = '" & iD & "' And Ciclica = 0"
         Case "TraspasHores": GuardaHistoric Cnf.llicencia, Now, "Peticio->" & Tipus, p1, P2, P3, P4
            ExportaHores p1, P2, P3
             ExecutaComandaSql "Delete FeinesAFer Where Id = '" & iD & "' And Ciclica = 0"
         Case "CalcularPrevisions": GuardaHistoric Cnf.llicencia, Now, "Peticio->" & Tipus, p1, P2, P3, P4
            CalcularPrevisions p1, P2, P3, P4, P5
             ExecutaComandaSql "Delete FeinesAFer Where Id = '" & iD & "' And Ciclica = 0"
         Case "A_RecalcularTiquetsPromocions": GuardaHistoric Cnf.llicencia, Now, "Peticio->" & Tipus, p1, P2, P3, P4
            RecalcularTiquetsPromocions CDate(Car(p1)), CDate(Car(P2)), Car(P3)
             ExecutaComandaSql "Delete FeinesAFer Where Id = '" & iD & "' And Ciclica = 0"
         Case "CalcularObjectius": GuardaHistoric Cnf.llicencia, Now, "Peticio->" & Tipus, p1, P2, P3, P4
            CalcularObjectius p1, P2, P3
            ExecutaComandaSql "Delete FeinesAFer Where Id = '" & iD & "' And Ciclica = 0"
         Case "VigilarAlertes": GuardaHistoric Cnf.llicencia, Now, "Peticio->" & Tipus, p1, P2, P3, P4
            VigilarAlertes p1, P2, P3
             ExecutaComandaSql "Delete FeinesAFer Where Id = '" & iD & "' And Ciclica = 0"
         Case "ActualitzaFacturat": GuardaHistoric Cnf.llicencia, Now, "Peticio->" & Tipus, p1, P2, P3, P4
            'ActualitzaFacturat P1, p2
             ExecutaComandaSql "Delete FeinesAFer Where Id = '" & iD & "' And Ciclica = 0"
         Case "EmailResumBotiga": GuardaHistoric Cnf.llicencia, Now, "Peticio->" & Tipus, p1, P2, P3, P4
             EmailResumBotiga p1, P2
             ExecutaComandaSql "Delete FeinesAFer Where Id = '" & iD & "' "
         Case "EmailResumBotigaEstat": GuardaHistoric Cnf.llicencia, Now, "Peticio->" & Tipus, p1, P2, P3, P4
             EmailResumBotigaEstat p1, P2
             ExecutaComandaSql "Delete FeinesAFer Where Id = '" & iD & "' "
         Case "EmailRecepcio": GuardaHistoric Cnf.llicencia, Now, "Peticio->" & Tipus, p1, P2, P3, P4
             EmailRecepcio p1, P2
             ExecutaComandaSql "Delete FeinesAFer Where Id = '" & iD & "' "
         Case "EnviaFacturaEmail": GuardaHistoric Cnf.llicencia, Now, "Peticio->" & Tipus, p1, P2, P3, P4
             EnviaFacturaEmail p1, P2, P3, P4, P5
             ExecutaComandaSql "Delete FeinesAFer Where Id = '" & iD & "' "
         Case "EnviaPressupostEmail": GuardaHistoric Cnf.llicencia, Now, "Peticio->" & Tipus, p1, P2, P3, P4
             EnviaPressupostEmail p1, P2, P3, P4
             ExecutaComandaSql "Delete FeinesAFer Where Id = '" & iD & "' "
         Case "FeinesPerFerCada10Min":
             D = Car(p1)
             'If D < Now Or UCase(EmpresaActual) = UCase("TENA") Then
             If D < Now Then
                GuardaHistoric Cnf.llicencia, Now, "Peticio->" & Tipus, p1, P2, P3, P4
                FesFeinesPerFerCada10Min
                ExecutaComandaSql "Delete FeinesAFer Where Tipus = 'FeinesPerFerCada10Min' "
                ExecutaComandaSql "Insert Into FeinesAFer (Tipus,Ciclica,Param1,Param2,Param3,Param4) Values ('FeinesPerFerCada10Min',0,'[" & DateAdd("n", 10, Now) & "]','Si " & Now() & "','','') "
             End If
         Case "FeinesPerFerCadaHora":
             D = Car(p1)
             If D < Now Then
                GuardaHistoric Cnf.llicencia, Now, "Peticio->" & Tipus, p1, P2, P3, P4
                FesFeinesPerFerCadaHora
                ExecutaComandaSql "Delete FeinesAFer Where Tipus = 'FeinesPerFerCadaHora' "
                ExecutaComandaSql "Insert Into FeinesAFer (Tipus,Ciclica,Param1,Param2,Param3,Param4) Values ('FeinesPerFerCadaHora',0,'[" & DateAdd("h", 1, Now) & "]','Si " & Now() & "','','') "
             End If
         Case "FeinesPerFerAles5":
             D = StData(Car(p1))
             If (D = DateSerial(Year(Now), Month(Now), Day(Now)) And Hour(Now) >= 17) Or D < DateSerial(Year(Now), Month(Now), Day(Now)) Then
                GuardaHistoric Cnf.llicencia, Now, "Peticio->" & Tipus, p1, P2, P3, P4
                If D = DateSerial(Year(Now), Month(Now), Day(Now)) Then FesFeinesPerFerAles5
                ExecutaComandaSql "Delete FeinesAFer Where Tipus = 'FeinesPerFerAles5' "
                ExecutaComandaSql "Insert Into FeinesAFer (Tipus,Ciclica,Param1,Param2,Param3,Param4) Values ('FeinesPerFerAles5',0,'[" & Format(DateAdd("d", 1, Now), "dd-mm-yy") & "]','Si " & Now() & "','','') "
             End If
         Case "FeinesPerFerAles23":
             D = StData(Car(p1))
             If (D = DateSerial(Year(Now), Month(Now), Day(Now)) And Hour(Now) >= 23) Or D < DateSerial(Year(Now), Month(Now), Day(Now)) Then
                'Borrat de hit.dbo.pingmaquina?
                If D = DateSerial(Year(Now), Month(Now), Day(Now)) Then
                    FesFeinesPerFerAles23
                    GuardaHistoric Cnf.llicencia, Now, "Peticio->" & Tipus, p1, P2, P3, P4
                End If
                ExecutaComandaSql "Delete FeinesAFer Where Tipus = 'FeinesPerFerAles23' "
                ExecutaComandaSql "Insert Into FeinesAFer (Tipus,Ciclica,Param1,Param2,Param3,Param4) Values ('FeinesPerFerAles23',0,'[" & Format(DateAdd("d", 1, Now), "dd-mm-yy") & "]','Si " & Now() & "','','') "
             End If
         Case "FeinesPerFerAles13":
             D = StData(Car(p1))
             If (D = DateSerial(Year(Now), Month(Now), Day(Now)) And Hour(Now) >= 13) Or D < DateSerial(Year(Now), Month(Now), Day(Now)) Then
                GuardaHistoric Cnf.llicencia, Now, "Peticio->" & Tipus, p1, P2, P3, P4
                If D = DateSerial(Year(Now), Month(Now), Day(Now)) Then FesFeinesPerFerAles13
                ExecutaComandaSql "Delete FeinesAFer Where Tipus = 'FeinesPerFerAles13' "
                ExecutaComandaSql "Insert Into FeinesAFer (Tipus,Ciclica,Param1,Param2,Param3,Param4) Values ('FeinesPerFerAles13',0,'[" & Format(DateAdd("d", 1, Now), "dd-mm-yy") & "]','Si " & Now() & "','','') "
             End If
         Case "FeinesPerFerAles15":
             D = StData(Car(p1))
             If (D = DateSerial(Year(Now), Month(Now), Day(Now)) And Hour(Now) >= 7) Or D < DateSerial(Year(Now), Month(Now), Day(Now)) Then
                GuardaHistoric Cnf.llicencia, Now, Tipus, p1, P2, P3, P4
                If D = DateSerial(Year(Now), Month(Now), Day(Now)) Then FesFeinesPerFerAles15
                ExecutaComandaSql "Delete FeinesAFer Where Tipus = 'FeinesPerFerAles15' "
                ExecutaComandaSql "Insert Into FeinesAFer (Tipus,Ciclica,Param1,Param2,Param3,Param4) Values ('FeinesPerFerAles15',0,'[" & Format(DateAdd("d", 1, Now), "dd-mm-yy") & "]','Si " & Now() & "','','') "
             End If
         Case "FeinesPerFerAles22":
             D = StData(Car(p1))
             If (D = DateSerial(Year(Now), Month(Now), Day(Now)) And Hour(Now) >= 7) Or D < DateSerial(Year(Now), Month(Now), Day(Now)) Then
                GuardaHistoric Cnf.llicencia, Now, Tipus, p1, P2, P3, P4
                If D = DateSerial(Year(Now), Month(Now), Day(Now)) Then FesFeinesPerFerAles22
                ExecutaComandaSql "Delete FeinesAFer Where Tipus = 'FeinesPerFerAles22' "
                ExecutaComandaSql "Insert Into FeinesAFer (Tipus,Ciclica,Param1,Param2,Param3,Param4) Values ('FeinesPerFerAles22',0,'[" & Format(DateAdd("d", 1, Now), "dd-mm-yy") & "]','Si " & Now() & "','','') "
             End If
         Case "FeinesPerFerAles12":
             D = StData(Car(p1))
             If (D = DateSerial(Year(Now), Month(Now), Day(Now)) And Hour(Now) >= 12) Or D < DateSerial(Year(Now), Month(Now), Day(Now)) Then
                GuardaHistoric Cnf.llicencia, Now, Tipus, p1, P2, P3, P4
                If D = DateSerial(Year(Now), Month(Now), Day(Now)) Then FesFeinesPerFerAles12
                ExecutaComandaSql "Delete FeinesAFer Where Tipus = 'FeinesPerFerAles12' "
                ExecutaComandaSql "Insert Into FeinesAFer (Tipus,Ciclica,Param1,Param2,Param3,Param4) Values ('FeinesPerFerAles12',0,'[" & Format(DateAdd("d", 1, Now), "dd-mm-yy") & "]','Si " & Now() & "','','') "
             End If
         Case "BuscarAlertasFacturacion":
             D = StData(Car(p1))
             If (D = DateSerial(Year(Now), Month(Now), Day(Now)) And Hour(Now) >= 23) Or D < DateSerial(Year(Now), Month(Now), Day(Now)) Then
                GuardaHistoric Cnf.llicencia, Now, Tipus, p1, P2, P3, P4
                BuscarAlertasFacturacion
                ExecutaComandaSql "Delete FeinesAFer Where Tipus = 'BuscarAlertasFacturacion' "
                ExecutaComandaSql "Insert Into FeinesAFer (Tipus,Ciclica,Param1,Param2,Param3,Param4) Values ('BuscarAlertasFacturacion',0,'[" & Format(DateAdd("d", 1, Now), "dd-mm-yy") & "]','Si " & Now() & "','','') "
             End If
         Case "FeinesPerFerAlVespre":
             D = StData(Car(p1))
             If (D = DateSerial(Year(Now), Month(Now), Day(Now)) And Hour(Now) >= 23) Or D < DateSerial(Year(Now), Month(Now), Day(Now)) Then
                GuardaHistoric Cnf.llicencia, Now, Tipus, p1, P2, P3, P4
                FesFeinesPerFerAlVespre
                ExecutaComandaSql "Delete FeinesAFer Where Tipus = 'FeinesPerFerAlVespre' "
                ExecutaComandaSql "Insert Into FeinesAFer (Tipus,Ciclica,Param1,Param2,Param3,Param4) Values ('FeinesPerFerAlVespre',0,'[" & Format(DateAdd("d", 1, Now), "dd-mm-yy") & "]','Si " & Now() & "','','') "
             End If
         Case "RepasaCuotasHIT":
             D = StData(Car(p1))
             If (D = DateSerial(Year(Now), Month(Now), Day(Now)) And Hour(Now) >= 9) Or D < DateSerial(Year(Now), Month(Now), Day(Now)) Then
                GuardaHistoric Cnf.llicencia, Now, Tipus, p1, P2, P3, P4
                RepasaCuotasHIT
                ExecutaComandaSql "Delete FeinesAFer Where Tipus = 'RepasaCuotasHIT' "
                ExecutaComandaSql "Insert Into FeinesAFer (Tipus,Ciclica,Param1,Param2,Param3,Param4) Values ('RepasaCuotasHIT',0,'[" & Format(DateAdd("d", 1, Now), "dd-mm-yy") & "]','Si " & Now() & "','','') "
             End If
         Case "EnviaEmailPicking":
             D = StData(Car(p1))
             HoraEnvio = 6
             If (D = DateSerial(Year(Now), Month(Now), Day(Now)) And Hour(Now) >= HoraEnvio) Or D < DateSerial(Year(Now), Month(Now), Day(Now)) Then
                GuardaHistoric Cnf.llicencia, Now, Tipus, p1, P2, P3, P4
                EnviaEmailPicking
                ExecutaComandaSql "Delete FeinesAFer Where Tipus = 'EnviaEmailPicking' "
                ExecutaComandaSql "Insert Into FeinesAFer (Tipus,Ciclica,Param1,Param2,Param3,Param4) Values ('EnviaEmailPicking',0,'[" & Format(DateAdd("d", 1, Now), "dd-mm-yy") & "]','Si " & Now() & "','','') "
             End If
         Case "EnviaEmailDemanatServit":
             D = StData(Car(p1))
             HoraEnvio = 6
             If (D = DateSerial(Year(Now), Month(Now), Day(Now)) And Hour(Now) >= HoraEnvio) Or D < DateSerial(Year(Now), Month(Now), Day(Now)) Then
                GuardaHistoric Cnf.llicencia, Now, Tipus, p1, P2, P3, P4
                EnviaEmailAdjunto "sgomez@silemabcn.com", "Excel Resultat ", EnviaEmailDemanatServit()
                'EnviaEmailAdjunto "ana@solucionesit365.com", "Excel Resultat ", EnviaEmailDemanatServit()
                ExecutaComandaSql "Delete FeinesAFer Where Tipus = 'EnviaEmailDemanatServit' "
                ExecutaComandaSql "Insert Into FeinesAFer (Tipus,Ciclica,Param1,Param2,Param3,Param4) Values ('EnviaEmailDemanatServit',0,'[" & Format(DateAdd("d", 1, Now), "dd-mm-yy") & "]','Si " & Now() & "','','') "
             End If
         Case "FesNetejaBD":
             D = StData(Car(p1))
             If (D = DateSerial(Year(Now), Month(Now), Day(Now)) And Hour(Now) >= 23) Or D < DateSerial(Year(Now), Month(Now), Day(Now)) Then
                GuardaHistoric Cnf.llicencia, Now, Tipus, p1, P2, P3, P4
                FesNetejaBD
                ExecutaComandaSql "Delete FeinesAFer Where Tipus = 'FesNetejaBD' "
                ExecutaComandaSql "Insert Into FeinesAFer (Tipus,Ciclica,Param1,Param2,Param3,Param4) Values ('FesNetejaBD',0,'[" & Format(DateAdd("d", 1, Now()), "dd-mm-yy") & "]','Si " & Now() & "','','') "
             End If
         'Case "RebaixaEstocksMateriesPrimeres":
         '   RebaixaEstocksMateriesPrimeres
         Case "ImportaFitchers": GuardaHistoric Cnf.llicencia, Now, "Peticio->" & Tipus, p1, P2, P3, P4
            ImportaFitchers
            ExecutaComandaSql "Delete FeinesAFer Where Id = '" & iD & "' And Ciclica = 0"
         Case "FeinesPerFerAfinalDeMes": GuardaHistoric Cnf.llicencia, Now, "Peticio->" & Tipus, p1, P2, P3, P4
             D = StData(Car(p1))
             If (D = DateSerial(Year(Now), Month(Now), Day(Now)) And Hour(Now) >= 23) Or D < DateSerial(Year(Now), Month(Now), Day(Now)) Then
                FeinesPerFerAFinalDeMes
                ExecutaComandaSql "Delete FeinesAFer Where Id = '" & iD & "' And Ciclica = 0"
                ExecutaComandaSql "Insert Into FeinesAFer (Tipus,Ciclica,Param1,Param2,Param3,Param4) Values ('FeinesPerFerAFinalDeMes',0,'[" & Format(DateAdd("d", -1, DateAdd("m", 2, DateSerial(Year(Now), Month(Now), 1))), "dd-mm-yy") & "]','Si " & Now() & "','','') "
             End If
         Case "FeinesPerFerAPrincipiDeMes": GuardaHistoric Cnf.llicencia, Now, "Peticio->" & Tipus, p1, P2, P3, P4
             D = StData(Car(p1))
             If (D = DateSerial(Year(Now), Month(Now), Day(Now)) And Hour(Now) >= 23) Or D < DateSerial(Year(Now), Month(Now), Day(Now)) Then
                FeinesPerFerAPrincipiDeMes
                ExecutaComandaSql "Delete FeinesAFer Where Id = '" & iD & "' And Ciclica = 0"
                ExecutaComandaSql "Insert Into FeinesAFer (Tipus,Ciclica,Param1,Param2,Param3,Param4) Values ('FeinesPerFerAPrincipiDeMes',0,'[" & Format(DateSerial(Year(Now), Month(Now) + 1, 1), "dd-mm-yy") & "]','Si " & Now() & "','','') "
             End If
         Case "EmailTasca"
            GuardaHistoric Cnf.llicencia, Now, "Peticio->" & Tipus, p1, P2, P3, P4
            enviaEmailTasca p1
            ExecutaComandaSql "Delete FeinesAFer Where Id = '" & iD & "' And Ciclica = 0"
         Case "EmailTecnicTasca"
            GuardaHistoric Cnf.llicencia, Now, "Peticio->" & Tipus, p1, P2, P3, P4
            enviaEmailTecnicTasca p1
            ExecutaComandaSql "Delete FeinesAFer Where Id = '" & iD & "' And Ciclica = 0"
         Case "EmailTascaFastByte"
            GuardaHistoric Cnf.llicencia, Now, "Peticio->" & Tipus, p1, P2, P3, P4
            enviaEmailTascaFastByte p1
            ExecutaComandaSql "Delete FeinesAFer Where Id = '" & iD & "' And Ciclica = 0"
         Case "EMailEncarrec"
            GuardaHistoric Cnf.llicencia, Now, "Peticio->" & Tipus, p1, P2, P3, P4
            enviaEmailEncarrec p1, P2
            ExecutaComandaSql "Delete FeinesAFer Where Id = '" & iD & "' And Ciclica = 0"
         Case "EMailFaltaLLicencia"
            GuardaHistoric Cnf.llicencia, Now, "Peticio->" & Tipus, p1, P2, P3, P4
            enviaEmailFaltaLLicencia p1, P2
            ExecutaComandaSql "Delete FeinesAFer Where Id = '" & iD & "' And Ciclica = 0"
         Case "EMailFaltaQuota"
            GuardaHistoric Cnf.llicencia, Now, "Peticio->" & Tipus, p1, P2, P3, P4
            enviaEmailFaltaQuota p1, P2
            ExecutaComandaSql "Delete FeinesAFer Where Id = '" & iD & "' And Ciclica = 0"
         Case "EmailReposicioBotiga"
            GuardaHistoric Cnf.llicencia, Now, "Peticio->" & Tipus, p1, P2, P3, P4
            EmailReposicioBotiga p1, P2
            ExecutaComandaSql "Delete FeinesAFer Where Id = '" & iD & "' And Ciclica = 0"
            
         Case "PedidoProveedor":
            GuardaHistoric Cnf.llicencia, Now, "Peticio->" & Tipus, p1, P2, P3, P4
            If P2 = "" Then P2 = 0
            If P3 = "" Then P3 = 0
'            PedidoCalcula p1, CDbl(P2), CDbl(P3)
            ExecutaComandaSql "Insert Into FeinesAFer (Tipus,Ciclica,Param1,Param2,Param3,Param4) Values ('PedidoCalculaExtern',0,'" & p1 & "','" & P2 & "','" & P3 & "','" & P4 & "') "
            ExecutaComandaSql "Delete FeinesAFer Where Id = '" & iD & "' "
         Case "SincronitzaTangram" ' esta com EXTERN
            SincronitzaTangram p1, P2, P3, P4
            ExecutaComandaSql "Delete FeinesAFer Where Id = '" & iD & "' And Ciclica = 0"
         Case "ExcelEmail"
             GuardaHistoric Cnf.llicencia, Now, "Peticio->" & Tipus, p1, P2, P3, P4
             pt1 = Car(p1)
             pt2 = Car(p1)
             If Not InStr(pt2, "@") Then
                Set rsEmail = Db.OpenResultset("select email from hit.dbo.secretaria where Empresa='" & LastDatabase & "' and Usuario='" & pt2 & "'")
                If Not rsEmail.EOF Then pt2 = rsEmail("email")
             End If

             pt3 = Car(p1)
             p1 = pt1
             ExecutaComandaSql "Update FeinesAFer Set Param1 = '[" & pt1 & "][" & pt2 & "][Calculando ... " & Now & "]'  Where Id = '" & iD & "' "
             EnviaEmailAdjunto pt2, "Calcul Excel " & p1, CalculaExcel(p1, P2, P3, P4, P5)
             ExecutaComandaSql "Delete FeinesAFer Where Id = '" & iD & "' "
         Case "enviarEmailPedidoTV": GuardaHistoric Cnf.llicencia, Now, "Peticio->" & Tipus, p1, P2, P3, P4
            EmailPedidoTVoice p1, P2, P3, P4
            ExecutaComandaSql "Delete FeinesAFer Where Id = '" & iD & "' And Ciclica = 0"
         Case "EnviarReportTasques":
             D = StData(Car(p1))
             If (D = DateSerial(Year(Now), Month(Now), Day(Now)) And Hour(Now) >= 19) Or D < DateSerial(Year(Now), Month(Now), Day(Now)) Then
                GuardaHistoric Cnf.llicencia, Now, "Peticio->" & Tipus, p1, P2, P3, P4
                If D = DateSerial(Year(Now), Month(Now), Day(Now)) Then
                    EnviaEmailAdjunto P2, "LListat tasques HIT " & p1, EnviarReportTasques
                End If
                ExecutaComandaSql "Delete FeinesAFer Where Id='" & iD & "' and Tipus = 'EnviarReportTasques' "
                ExecutaComandaSql "Insert Into FeinesAFer (Tipus,Ciclica,Param1,Param2,Param3,Param4) Values ('EnviarReportTasques',0,'[" & Format(DateAdd("d", 1, Now), "dd-mm-yy") & "]','" & P2 & "','','') "
             End If
         Case "EnviarReportBotiga":
             D = StData(Car(p1))
             
             If (D = DateSerial(Year(Now), Month(Now), Day(Now)) And Hour(Now) >= 23) Or D < DateSerial(Year(Now), Month(Now), Day(Now)) Then
                GuardaHistoric Cnf.llicencia, Now, "Peticio->" & Tipus, p1, P2, P3, P4
                If D = DateSerial(Year(Now), Month(Now), Day(Now)) Then EnviarReportBotiga CDbl(P2), P3
                ExecutaComandaSql "Delete FeinesAFer Where Id='" & iD & "' and Tipus = 'EnviarReportBotiga' "
'                ExecutaComandaSql "Insert Into FeinesAFer (Tipus,Ciclica,Param1,Param2,Param3,Param4) Values ('EnviarReportBotiga',0,'[" & Format(DateAdd("d", 1, Now), "dd-mm-yy") & "]','1','cristinamartinezd@hotmail.com;jordi@hit.cat;javierlo72@gmail.com;xbalmes@hotmail.com','')  "
             End If
         Case "EnviarReportBotigaHistoric":
             D = StData(Car(p1))
             
             If (D = DateSerial(Year(Now), Month(Now), Day(Now)) And Hour(Now) >= 22) Or D < DateSerial(Year(Now), Month(Now), Day(Now)) Then
                GuardaHistoric Cnf.llicencia, Now, "Peticio->" & Tipus, p1, P2, P3, P4
                If D = DateSerial(Year(Now), Month(Now), Day(Now)) Then EnviarReportBotigaHistoric CDbl(P2), P3
                ExecutaComandaSql "Delete FeinesAFer Where Id='" & iD & "' and Tipus = 'EnviarReportBotigaHistoric' "
'                ExecutaComandaSql "Insert Into FeinesAFer (Tipus,Ciclica,Param1,Param2,Param3,Param4) Values ('EnviarReportBotigaHistoric',0,'[" & Format(DateAdd("d", 1, Now), "dd-mm-yy") & "]','1','cristinamartinezd@hotmail.com;jordi@hit.cat;javierlo72@gmail.com;xbalmes@hotmail.com','')  "
             End If
        Case "EmailFaltaProducte": GuardaHistoric Cnf.llicencia, Now, "Peticio->" & Tipus, p1, P2, P3, P4
            EmailFaltaProducte p1, P2
            ExecutaComandaSql "Delete FeinesAFer Where Id = '" & iD & "' And Ciclica = 0"
            
         Case "RebaixaStocks":
            If UCase(EmpresaActual) = UCase("xxx") Then RebaixaEstocksConjelador
            
        Case "FacturaSERUNION":
            AlbaranSERUNION p1, CDate(P2)
            FacturaSERUNION P3, CDate(P4)
            ExecutaComandaSql "Delete FeinesAFer Where Id = '" & iD & "' "
            
         Case "CalculaComandaPerEquip":
             D = StData(Car(p1))
             
             If (D = DateSerial(Year(Now), Month(Now), Day(Now)) And Hour(Now) >= 17) Or D < DateSerial(Year(Now), Month(Now), Day(Now)) Then
                GuardaHistoric Cnf.llicencia, Now, "Peticio->" & Tipus, p1, P2, P3, P4
                Set rsE = Db.OpenResultset("Select * from paramsEquip where param = 'P_AUTOMATICA' and valor = 'on'")
                While Not rsE.EOF
                    CalculaComandaPerEquip DateAdd("d", -1, Now), rsE("Equip")
                    rsE.MoveNext
                Wend
                ExecutaComandaSql "Delete FeinesAFer Where Id = '" & iD & "' "
                ExecutaComandaSql "Insert Into FeinesAFer (Tipus,Ciclica,Param1,Param2,Param3,Param4) Values ('CalculaComandaPerEquip',0,'[" & Format(DateAdd("d", 1, Now), "dd-mm-yy") & "]','','','') "
            End If
            
' ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
'SAGE -----------------------------------------------------------------------------------------------------------------------------------------------------------------------------
' ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
            
        Case "SincroMURANOCaixaOnLine":
           GuardaHistoric Cnf.llicencia, Now, "Peticio->" & Tipus, p1, P2, P3, P4
            If UCase(EmpresaActual) <> UCase("Concordia") Then
                ExportaMURANO "CAIXA_ONLINE", p1, P2, P3, P4, P5, iD
            End If
           ExecutaComandaSql "Delete FeinesAFer Where Id = '" & iD & "' "
'insert into feinesafer (id, tipus, ciclica, param1) values (newid(), 'SincroMURANOVendes', 0, '[761]', '[11-05-20]')
        Case "SincroMURANOVendes":
            D = StData(Car(P2))
             
            If (D = DateSerial(Year(Now), Month(Now), Day(Now)) And Hour(Now) >= 23) Or D < DateSerial(Year(Now), Month(Now), Day(Now)) Then
                GuardaHistoric Cnf.llicencia, Now, "Peticio->" & Tipus, p1, P2, P3, P4
                ExportaMURANO "VENDES", p1, P2, P3, P4, P5, iD
                ExecutaComandaSql "Delete FeinesAFer Where Id = '" & iD & "' "
                ExecutaComandaSql "Insert Into FeinesAFer (Tipus,Ciclica,Param1,Param2,Param3,Param4) Values ('SincroMURANOVendes',0,'" & p1 & "','[" & Format(DateAdd("d", 1, Now), "dd-mm-yy") & "]','','') "
            End If
            
        Case "SincroMURANOFacturasEmitidas":
            D = StData(Car(p1))
             
            If (D = DateSerial(Year(Now), Month(Now), Day(Now)) And Hour(Now) >= 22) Or D < DateSerial(Year(Now), Month(Now), Day(Now)) Then
                Set rsFac = Db.OpenResultset("select * from feinesAFer where tipus='SincroMURANOFactura' order by tmStmp")
                While Not rsFac.EOF
                'If rsFac("Param3") = "[1728]" Then
                    ExportaMURANO "FACTURA", rsFac("Param1"), rsFac("Param2"), rsFac("Param3"), rsFac("Param4"), "", rsFac("Id")
                    GuardaHistoric Cnf.llicencia, Now, "Peticio->FACTURA EMITIDA MURANO", rsFac("Param1"), rsFac("Param2"), rsFac("Param3"), rsFac("Param4")
                    ExecutaComandaSql "Delete FeinesAFer Where Id = '" & rsFac("Id") & "' "
                'End If
                    rsFac.MoveNext
                Wend
                
                'NO PODEMOS BORRAR FACTURAS QUE YA ESTÁN EN SAGE
                Set rsFac = Db.OpenResultset("select * from feinesAFer where tipus='SincroMURANODelFactura' order by tmStmp")
                While Not rsFac.EOF
                    ExportaMURANO "FACTURA_DEL", rsFac("Param1"), rsFac("Param2"), rsFac("Param3"), rsFac("Param4"), "", rsFac("Id")
                    GuardaHistoric Cnf.llicencia, Now, "Peticio->DELETE FACTURA EMITIDA MURANO", rsFac("Param1"), rsFac("Param2"), rsFac("Param3"), rsFac("Param4")
                    ExecutaComandaSql "Delete FeinesAFer Where Id = '" & rsFac("Id") & "' "
                
                    rsFac.MoveNext
                Wend
                
                ExecutaComandaSql "Delete FeinesAFer Where Id = '" & iD & "' "
                ExecutaComandaSql "Insert Into FeinesAFer (Tipus,Ciclica,Param1,Param2,Param3,Param4) Values ('SincroMURANOFacturasEmitidas',0,'[" & Format(DateAdd("d", 1, Now), "dd-mm-yy") & "]','','','') "
            End If
        Case "SincroMURANOFacturasRecibidas":
            D = StData(Car(p1))
             
            If (D = DateSerial(Year(Now), Month(Now), Day(Now)) And Hour(Now) >= 22) Or D < DateSerial(Year(Now), Month(Now), Day(Now)) Then
                Set rsFac = Db.OpenResultset("select * from feinesAFer where tipus='SincroMURANOFacturaRebuda' order by tmStmp")
                While Not rsFac.EOF
                    ExportaMURANO "FACTURA_REBUDA", rsFac("Param1"), rsFac("Param2"), rsFac("Param3"), rsFac("Param4"), "", rsFac("Id")
                    ExecutaComandaSql "Delete FeinesAFer Where Id = '" & rsFac("Id") & "' "

                    rsFac.MoveNext
                Wend
                
                Set rsFac = Db.OpenResultset("select * from feinesAFer where tipus='SincroMURANODelFacturaRebuda' order by tmStmp")
                While Not rsFac.EOF
                    ExportaMURANO "FACTURA_REBUDA_DEL", rsFac("Param1"), rsFac("Param2"), rsFac("Param3"), rsFac("Param4"), "", rsFac("Id")
                    ExecutaComandaSql "Delete FeinesAFer Where Id = '" & rsFac("Id") & "' "
                
                    rsFac.MoveNext
                Wend
                
                ExecutaComandaSql "Delete FeinesAFer Where Id = '" & iD & "' "
                ExecutaComandaSql "Insert Into FeinesAFer (Tipus,Ciclica,Param1,Param2,Param3,Param4) Values ('SincroMURANOFacturasRecibidas',0,'[" & Format(DateAdd("d", 1, Now), "dd-mm-yy") & "]','','','') "
            End If
            
        Case "SincroMURANONomines":  'NOMINES
            ExportaMURANO "NOMINES", p1, P2, P3, P4, "", iD
            ExecutaComandaSql "Delete FeinesAFer Where Id = '" & iD & "' "
        'Case "SincroMURANOBancs":  'BANCS
        '    ExportaMURANO "BANCS", p1, P2, P3, P4, "", Id
        Case "SincroMURANOBancsDiari":
            D = StData(Car(p1))
             
            If (D = DateSerial(Year(Now), Month(Now), Day(Now)) And Hour(Now) >= 22) Or D < DateSerial(Year(Now), Month(Now), Day(Now)) Or UCase(EmpresaActual) = "HITRS" Then
                Set rsBancs = Db.OpenResultset("select * from feinesAFer where tipus='SincroMURANOBancs' order by tmStmp desc")
                While Not rsBancs.EOF
                    ExportaMURANO "BANCS", rsBancs("Param1"), rsBancs("Param2"), rsBancs("Param3"), rsBancs("Param4"), "", rsBancs("Id")
                    ExecutaComandaSql "Delete FeinesAFer Where Id = '" & rsBancs("Id") & "' "
                
                    rsBancs.MoveNext
                Wend
                If UCase(EmpresaActual) <> "HITRS" Then
                    ExecutaComandaSql "Delete FeinesAFer Where Id = '" & iD & "' "
                    ExecutaComandaSql "Insert Into FeinesAFer (Tipus,Ciclica,Param1,Param2,Param3,Param4) Values ('SincroMURANOBancsDiari',0,'[" & Format(DateAdd("d", 1, Now), "dd-mm-yy") & "]','','','') "
                End If
            End If
        Case "SincroMURANOCalaixos":  'CALAIXOS
            ExportaMURANO "CALAIX", p1, P2, P3, P4, "", iD
            ExecutaComandaSql "Delete FeinesAFer Where Id = '" & iD & "' "
        Case "SincroMURANOManuales":  'MANUALES
            ExportaMURANO "MANUAL", p1, P2, P3, P4, "", iD
            ExecutaComandaSql "Delete FeinesAFer Where Id = '" & iD & "' "
        Case "SincroMURANODelManuales":  'MANUALES DELETE
            ExportaMURANO "MANUAL_DEL", p1, P2, P3, P4, "", iD
            ExecutaComandaSql "Delete FeinesAFer Where Id = '" & iD & "' "
        Case "CalculaExcel":
            CalculaExcel p1, P2, P3, P4, P5
            ExecutaComandaSql "Delete FeinesAFer Where Id = '" & iD & "' "
        Case "InformeSincronizacionMURANO":
            InformeSincronizacionMURANO p1, P2, P3, P4
            ExecutaComandaSql "Delete FeinesAFer Where Id = '" & iD & "' "
        Case "InformeBancosCajonesMURANO":
            InformeBancosCajonesMURANO
            ExecutaComandaSql "Delete FeinesAFer Where Id = '" & iD & "' "
        Case "InformeFacturasMURANO":
            InformeFacturasMURANO p1, P2, P3
            ExecutaComandaSql "Delete FeinesAFer Where Id = '" & iD & "' "
        'Case "ReportSeguimentMURANO":
        '     D = StData(Car(p1))
        '     If (D = DateSerial(Year(Now), Month(Now), Day(Now)) And Hour(Now) >= 8) Or D < DateSerial(Year(Now), Month(Now), Day(Now)) Then
        '        enviaEmailSeguimentMURANO
        '        ExecutaComandaSql "Delete FeinesAFer Where Id = '" & Id & "' And Ciclica = 0"
        '        ExecutaComandaSql "Insert Into FeinesAFer (Tipus,Ciclica,Param1,Param2,Param3,Param4) Values ('ReportSeguimentMURANO',0,'[" & Format(DateAdd("d", 1, Now()), "dd-mm-yy") & "]','Si " & Now() & "','','') "
        '     End If
        
        Case "SincroANALITICAEmitida":
                        
            ExportaANALITICA_FacturaEmesa p1, CDate(P2), P3, P4
            ExecutaComandaSql "Delete FeinesAFer Where Id = '" & iD & "' "
        Case "SincroANALITICA_SEMANAL":
           
            ExportaANALITICA p1, P2, P3
            ExecutaComandaSql "Delete FeinesAFer Where Id = '" & iD & "' "
            
        Case "SincroANALITICARecibida":
            'D = StData(Car(P2))

            ExportaANALITICA_FacturaRebuda p1, CDate(P2), P3, P4
            ExecutaComandaSql "Delete FeinesAFer Where Id = '" & iD & "' "
        
        Case "SincroForzarTraspasoCAJAS"
'insert into feinesafer values (newid(), 'SincroForzarTraspasoCAJAS', 0, '185', '01/01/2020', '05/01/2020', '', '', getdate())
            ForzarTraspasoCajas p1, CDate(P2), CDate(P3)
            ExecutaComandaSql "Delete FeinesAFer Where Id = '" & iD & "' And Ciclica = 0"
        
' ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
'~SAGE -----------------------------------------------------------------------------------------------------------------------------------------------------------------------------
' ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
        
        
        Case "AlertaProducto":
             D = StData(Car(p1))
             If (D = DateSerial(Year(Now), Month(Now), Day(Now)) And Hour(Now) >= 12) Or D < DateSerial(Year(Now), Month(Now), Day(Now)) Then
                GuardaHistoric Cnf.llicencia, Now, "Peticio->" & Tipus, p1, P2, P3, P4
                If D = DateSerial(Year(Now), Month(Now), Day(Now)) Then
                    AlertaProducto P2, P3
                End If
                ExecutaComandaSql "Delete FeinesAFer Where Tipus = 'AlertaProducto' "
                ExecutaComandaSql "Insert Into FeinesAFer (Tipus,Ciclica,Param1,Param2,Param3,Param4) Values ('AlertaProducto',0,'[" & Format(DateAdd("d", 1, Now), "dd-mm-yy") & "]','" & P2 & "', '" & P3 & "', 'Si " & Now() & "') "
             End If
        Case "PrevisionsVendesDiari":
            PrevisionsVendesDiari P2, DateAdd("d", 7, p1), P3
            ExecutaComandaSql "Delete FeinesAFer Where Id = '" & iD & "' "
      End Select
    End If

'    If Curts Or LLargs Then                     ' ESPECIALS *************************************
    If LLargs Then
'        Select Case Tipus
'         Case "PedidoProveedor": GuardaHistoric Cnf.Llicencia, Now, "Peticio->" & Tipus, p1, P2, P3, P4
'            If P2 = "" Then P2 = 0
'            If P3 = "" Then P3 = 0
'            PedidoCalcula p1, CDbl(P2), CDbl(P3)
'             ExecutaComandaSql "Delete FeinesAFer Where Id = '" & Id & "' "
'         Case "ExportaCp"
'           ExportaCp p1, P2, P3, P4, P5
'           ExecutaComandaSql "Delete FeinesAFer Where Id = '" & Id & "' And Ciclica = 0"
'         Case "SincroDbExternaIcg": GuardaHistoric Cnf.Llicencia, Now, "Peticio->" & Tipus, p1, P2, P3, P4
'            SincroDbExternaIcg p1, P2, P3, P4
'           ExecutaComandaSql "Delete FeinesAFer Where Id = '" & Id & "' And Ciclica = 0"
'         Case "ExcelEmail": GuardaHistoric Cnf.Llicencia, Now, "Peticio->" & Tipus, p1, P2, P3, P4
'          CalculaExcel p1, P2, P3, P4, P5
'         ExecutaComandaSql "Delete FeinesAFer Where Id = '" & Id & "' And Ciclica = 0"
'        End Select
        
        Select Case Tipus
         Case "", _
                "ExportaCp", _
                "PedidoCalculaExtern", _
                "SincronitzaFornsEnrich", _
                "SincronitzaComandaFornsEnrich", _
                "SincronitzaComandaXDiaFornsEnrich", _
                "SincronitzaCaixesMURANO", _
                "CalculaDadesFichador", _
                "OptimizaSerieOracul", _
                "PrevisionsVendesSetmanal", _
                "SincroANALITICA_SEMANAL":
                
              Dim CalFer As Boolean
              Set rs2 = Db.OpenResultset("Select * from " & TaulaCalculsEspecials & " Where IdFeinaAFer = '" & iD & "'")
              CalFer = True
              If Tipus = "SincroDbExternaSp" Then
                 If IsDate(P2) Then If DateDiff("h", P2, Now) <= 1 Then CalFer = False
              End If
              If Tipus = "SincroDbExternaBdp" Then
                 If IsDate(P2) Then If DateDiff("h", P2, Now) <= 1 Then CalFer = False
              End If
              If Tipus = "SincronitzaFornsEnrich" Or Tipus = "SincronitzaComandaFornsEnrich" Or Tipus = "CalculaDadesFichador" Then
                     D = Car(p1)
                     If D > Now Then CalFer = False
              End If
              If Tipus = "SincronitzaCaixesMURANO" Then
                    p1Bis = p1
                    D = Car(p1Bis)
                    If Not ((D = DateSerial(Year(Now), Month(Now), Day(Now)) And Hour(Now) >= 2) Or D < DateSerial(Year(Now), Month(Now), Day(Now))) Then 'Cada dia a las 2 de la mañana
                        CalFer = False
                    End If
              End If
              If Tipus = "PrevisionsVendesSetmanal" Then
                    D = Car(p1)
                    If D > Now() Or DatePart("w", Now(), vbMonday) <> 1 Then CalFer = False
              End If
              If Tipus = "OptimizaSerieOracul" Then
                D = Car(p1)
                If D > Now() Then
                    CalFer = False
                Else
                    If Hour(Now()) > 6 Then 'más tarde de las 6 de la mañana ya no lo hacemos, colapsa la BD
                        CalFer = False
                    End If
                End If
              End If

              If CalFer And rs2.EOF Then
                Cuants = ""
                Set rs2 = Db.OpenResultset("Select Count(*) From " & TaulaCalculsEspecials & " Where Empresa = '" & EmpresaActual & "' ")
                If Not rs2.EOF Then If Not IsNull(rs2(0)) Then Cuants = rs2(0)
                 If Cuants < 8 Then
                   ExecutaComandaSql "Insert Into " & TaulaCalculsEspecials & " (Id,Empresa,IdFeinaAFer,Estat,Ti,Tf,Tipus,Param1,Param2,Param3,Param4,Param5) Values (newid(),'" & EmpresaActual & "','" & iD & "','NoIniciat',getdate(),null,'" & Tipus & "','" & p1 & "','" & P2 & "','" & P3 & "','" & P4 & "','" & P5 & "') "
                   If frmSplash.Debugant Then
                       ExecutaCalculPuntual iD, False
                   Else
                       Shell App.Path & "\Sincro.exe " & "Idf:" & iD
                   End If
                 End If
              End If
         End Select
    End If
    
    ' ESPECIALS *************************************
    If Curts Then
        
        Select Case Tipus
         Case "", _
                "PedidoCalculaExtern":
                
              Set rs2 = Db.OpenResultset("Select * from " & TaulaCalculsEspecials & " Where IdFeinaAFer = '" & iD & "' and Estat='NoIniciat'")
              CalFer = True

              If CalFer And rs2.EOF Then
                Cuants = ""
                Set rs2 = Db.OpenResultset("Select Count(*) From " & TaulaCalculsEspecials & " Where Empresa = '" & EmpresaActual & "' ")
                If Not rs2.EOF Then If Not IsNull(rs2(0)) Then Cuants = rs2(0)
                 If Cuants < 8 Then
                   ExecutaComandaSql "Insert Into " & TaulaCalculsEspecials & " (Id,Empresa,IdFeinaAFer,Estat,Ti,Tf,Tipus,Param1,Param2,Param3,Param4,Param5) Values (newid(),'" & EmpresaActual & "','" & iD & "','NoIniciat',getdate(),null,'" & Tipus & "','" & p1 & "','" & P2 & "','" & P3 & "','" & P4 & "','" & P5 & "') "
                   If frmSplash.Debugant Then
                       ExecutaCalculPuntual iD, False
                   Else
                       Shell App.Path & "\Sincro.exe " & "Idf:" & iD
                   End If
                 End If
              End If
         End Select
    End If
    
    
    If SFtp Then
        Select Case Tipus
            Case "DescargaSFTP":
                D = Car(p1)
        
                'If DateDiff("n", D, Now()) > 15 Then
                    descargaSFTP UCase(EmpresaActual)
                    ExecutaComandaSql "Delete FeinesAFer Where Tipus = 'DescargaSFTP' "
                    ExecutaComandaSql "Insert Into FeinesAFer (Tipus,Ciclica,Param1,Param2,Param3,Param4) Values ('DescargaSFTP',0,'[" & Format(Now, "dd-mm-yy hh:mm:ss") & "]','Si " & Now() & "','','') "
                'End If
        End Select
    End If
End Sub


Sub ImpresoraBocadillos_QueCalProduir(codiBotiga As String)
    Dim rs As rdoResultset, rs2 As rdoResultset
    Dim sql As String
    Dim ambient As String
    Dim faltanTotal As Integer, servitTotal As Integer
    Dim date_Now As Date, date_Past As Date, date_Now_0 As Date, date_past3 As Date, minutsHastaLas6 As Integer
    Dim Eq As String
    Dim faltan As Integer, venutHoy As Integer, venutHoyEq As Integer, venut7D As Integer, venut7DEq As Integer, albaraHoy As Integer, albara7D As Integer, servit As Integer, PaQueSobre As Integer
    Dim article As String, nomArt As String
    Dim LatasDe As Integer
    Dim frescura As String
    
    
    date_Now = Now()
    date_Now_0 = DateAdd("h", DatePart("h", date_Now) * -1, Now())
    date_Past = DateAdd("d", -7, Now())
        
               
    sql = "select a.codi, a.nom, isnull(p.valor,0) UCoccio, ambient, case when p2.valor='' then '120' else isnull(p2.valor, 120) end  frescura "
    sql = sql & "from teclatstpv t "
    sql = sql & "left join articles a on t.article=a.codi "
    sql = sql & "left join ArticlesPropietats p on p.CodiArticle=a.codi and p.Variable ='UnitatsCoccio' "
    sql = sql & "left join ArticlesPropietats p2 on p2.CodiArticle=a.codi and p2.Variable ='MinutosFrescura' "
    sql = sql & "where llicencia=" & codiBotiga & " and a.codi is not null and data = (select top 1 data from teclatstpv where llicencia=" & codiBotiga & " order by data desc) "
    sql = sql & "and isnull(p.valor, 0)>0"
   'If (filtre <> "") Then sql = sql & " And ambient like '%" & filtre & "%' "
    sql = sql & "order by ambient, a.nom"
    Set rs = Db.OpenResultset(sql)

    ambient = ""
    faltanTotal = 0
    servitTotal = 0
            
    While Not rs.EOF
        Eq = ""
        faltan = 0
        venutHoy = 0
        venutHoyEq = 0
        venut7D = 0
        venut7DEq = 0
        albaraHoy = 0
        albara7D = 0
        servit = 0
        PaQueSobre = 0
        article = rs("codi")
        nomArt = Mid(rs("nom"), 1, 30)
        LatasDe = rs("UCoccio")
        ambient = rs("ambient")
        If rs("frescura") = " " Then
            frescura = "120"
        Else
            frescura = rs("frescura")
        End If


        If LatasDe > 0 Then
            'Servit
            'Producto $Article
            sql = "select isnull(sum(isnull(quantitatServida,0)), 0) qtat from [Servit-" & Format(Now(), "yy-mm-dd") & "] where client=" & codiBotiga & " and codiArticle=" & article
            Set rs2 = Db.OpenResultset(sql)
            servit = CInt(rs2("qtat"))
            servitTotal = servitTotal + servit

            venutHoy = PedidoCuantosFaltan(CDbl(article), CDbl(codiBotiga), date_Now_0, date_Now) 'Ya incluye los equivalentes
            'venutHoy = cuantoSeVendio(codiBotiga, article, date_Now_0, date_Now, 1)
            'venutHoyEq = cuantoSeVendioEq(codiBotiga, article, date_Now_0, date_Now, 1)

            'Ventas x Albaran Hoy
            Set rs2 = Db.OpenResultset("select isnull(sum(quantitat), 0) qtat from [v_albarans_" & Format(Now(), "yyyy-mm") & "] v where v.botiga=" & codiBotiga & " and day(data)=" & Day(Now()) & " and v.plu=" & article)
            albaraHoy = CInt(rs2("qtat"))

            'Semana pasada
            date_past3 = DateAdd("d", -7, Now())

            minutsHastaLas6 = (6 * 60) - (DatePart("h", date_past3) * 60 + DatePart("n", date_past3))
            If (minutsHastaLas6 > 0) Then date_past3 = DateAdd("n", minutsHastaLas6, date_past3)
            date_past3 = DateAdd("n", frescura, date_past3)
      
            'Producto $Article
            sql = "select isnull(sum(isnull(quantitat,0)),0) qtat from [V_venut_" & Format(date_Past, "yyyy-mm") & "] v where v.botiga=" & codiBotiga & " and "
            sql = sql & "convert(datetime, data, 103) between '" & date_Past & "' and '" & date_past3 & "' and v.plu=" & article
            Set rs2 = Db.OpenResultset(sql)
            venut7D = CInt(rs2("qtat"))

            'Productos equivalentes a $Article
            sql = "select isnull(sum(quantitat*isnull(UnitatsEquivalencia, 1)), 0) qtat "
            sql = sql & "from [V_venut_" & Format(date_Past, "yyyy-mm") & "] v "
            sql = sql & "left join EquivalenciaProductes ep on v.plu = ep.prodVenut "
            sql = sql & "where v.botiga=" & codiBotiga & " and "
            sql = sql & "convert(datetime, data, 103) between '" & date_Past & "' and '" & date_past3 & "' and ep.prodServit=" & article
            Set rs2 = Db.OpenResultset(sql)
            venut7DEq = Round(rs2("qtat"))
                
            'Ventas x Albaran semana 7D
            sql = "select isnull(sum(isnull(quantitat,0)),0) qtat from [v_albarans_" & Format(date_Past, "yyyy-mm") & "] v where v.botiga=" & codiBotiga & " and "
            sql = sql & "convert(datetime, data, 103) between '" & date_Past & "' and '" & date_past3 & "' and v.plu=" & article
            Set rs2 = Db.OpenResultset(sql)
            albara7D = CInt(rs2("qtat"))

            If (venut7D = 0) Then ' Vigilem la devolucio
                sql = "select isnull(sum(isnull(quantitat,0)),0) qtat from [V_venut_" & Format(date_Past, "yyyy-mm") & "] v where v.botiga=" & codiBotiga & " and "
                sql = sql & "convert(datetime, data, 103) between '" & date_Past & "' and '" & Format(date_Past, "dd/mm/yyyy 23:30:30") & "' and v.plu=" & article
                Set rs2 = Db.OpenResultset(sql)
                If (rs2("qtat") = 0) Then PaQueSobre = 1
            End If

            faltan = (venutHoy + venut7D + venut7DEq + albaraHoy + albara7D + PaQueSobre) - servit
            If (faltan < 0) Then faltan = 0
            If (faltan > 0) Then
                If (CInt(faltan / LatasDe) = (faltan / LatasDe)) Then
                    faltan = (CInt(faltan / LatasDe)) * LatasDe
                End If
            Else
                faltan = (CInt(faltan / LatasDe) + 1) * LatasDe
            End If

            faltanTotal = faltanTotal + faltan
            
            'Actualiza servit
            If faltan > 0 Then
                ExecutaComandaSql "insert into [servit-" & Format(Now(), "yy-mm-dd") & "_TMP] (id,[timestamp],quistamp,Client,CodiArticle,PluUtilitzat,Viatge,Equip ,QuantitatDemanada, QuantitatTornada,QuantitatServida,Hora,TipusComanda,Comentari,ComentariPer,Atribut) values  (newid(), getdate(), 'SECRE', " & codiBotiga & ", " & article & ", " & article & ", 'Auto', 'Auto', 0, 0, " & CInt(faltan) & ", 18, 2, 'Reposicion', '', 0)"
            End If
            
        End If
                    
        rs.MoveNext
    Wend
 
End Sub
  
Function CodiCentreTreball(Treb)
   Dim rs As rdoResultset, Lloc, CodiLloc
   
   Lloc = ""
   Set rs = Db.OpenResultset("select isnull(valor,'') valor from dependentesextes  where nom = 'LLOC_TREBALL' and id = " & Treb)
   If Not rs.EOF Then Lloc = rs("valor")
   rs.Close

    CodiLloc = "0"
    If Len(Lloc) > 0 Then
        CodiLloc = Trim(Left(Lloc, InStr(Lloc, " ")))
        If Not IsNumeric(CodiLloc) Then CodiLloc = "0"
    End If
    CodiCentreTreball = CodiLloc

End Function

Function DataUltimaVentaBusca(botiga As String, Fins As Date) As Date
    Dim rs As rdoResultset, D As Date
    ' Caldra tenir en compte els tpv agregats
    DataUltimaVentaBusca = DateAdd("d", -7, Now)

' BUSCAR HUECOS
'    SELECT TOP 1 num_tick + 1 As PrimerHueco
'FROM [v_venut_2011-05] T
'where Data >= CONVERT(datetime,'2011/05/29 22:18:46')
'and Data <= CONVERT(datetime,'2011/05/30 22:13:48:02')
'and NOT EXISTS( SELECT 1 FROM [v_venut_2011-05] WHERE (num_tick = T.num_tick + 1) )
'--AND num_tick >= 1000
'and Botiga = 202
'ORDER BY num_tick


    Set rs = Db.OpenResultset("Select max(data) data From [" & NomTaulaVentas(Now) & "] Where Botiga = " & botiga & " ")
    If rs.EOF Then
        Set rs = Db.OpenResultset("Select max(data) data From [" & NomTaulaVentas(DateAdd("m", -1, Now)) & "] Where Botiga = " & botiga & " ")
        If Not rs.EOF Then If Not IsNull(rs("data")) Then DataUltimaVentaBusca = rs("data")
    Else
        If Not IsNull(rs("data")) Then DataUltimaVentaBusca = rs("data")
    End If
    If DataUltimaVentaBusca > Fins Then DataUltimaVentaBusca = Fins
    
End Function

Function DataUltimaVentaBusca_91(botiga As String, Fins As Date) As Date
    Dim rs As rdoResultset, D As Date

    DataUltimaVentaBusca_91 = DateAdd("d", -7, Now)


    Set rs = Db.OpenResultset("Select max(data) data From [" & NomTaulaVentas(Now) & "] Where Botiga = " & botiga & " ")
    If rs.EOF Then
        Set rs = Db.OpenResultset("Select max(data) data From [" & NomTaulaVentas(DateAdd("m", -1, Now)) & "] Where Botiga = " & botiga & " ")
        If Not rs.EOF Then If Not IsNull(rs("data")) Then DataUltimaVentaBusca_91 = rs("data")
    Else
        If Not IsNull(rs("data")) Then DataUltimaVentaBusca_91 = rs("data")
    End If
    If DataUltimaVentaBusca_91 > Fins Then DataUltimaVentaBusca_91 = Fins
    
End Function
Function DataUltimaVentaBusca_V2(botiga As String, Fins As Date) As Date
    Dim rs As rdoResultset, D As Date

    DataUltimaVentaBusca_V2 = DateAdd("d", -7, Now)


    Set rs = Db.OpenResultset("Select max(data) data From [" & NomTaulaVentas(Now) & "] Where Botiga = " & botiga & " ")
    If rs.EOF Then
        Set rs = Db.OpenResultset("Select max(data) data From [" & NomTaulaVentas(DateAdd("m", -1, Now)) & "] Where Botiga = " & botiga & " ")
        If Not rs.EOF Then If Not IsNull(rs("data")) Then DataUltimaVentaBusca_V2 = rs("data")
    Else
        If Not IsNull(rs("data")) Then DataUltimaVentaBusca_V2 = rs("data")
    End If
    If DataUltimaVentaBusca_V2 > Fins Then DataUltimaVentaBusca_V2 = Fins
    
End Function

Function DataUltimaDevolucioBusca(botiga As String, Fins As Date) As Date
    Dim rs As rdoResultset, D As Date
    
    DataUltimaDevolucioBusca = DateAdd("d", -7, Now)
    
    Set rs = Db.OpenResultset("Select max(data) data From [" & NomTaulaDevol(Now) & "] Where Botiga = " & botiga & " ")
    If rs.EOF Then
        Set rs = Db.OpenResultset("Select max(data) data From [" & NomTaulaVentas(DateAdd("m", -1, Now)) & "] Where Botiga = " & botiga & " ")
        If Not rs.EOF Then If Not IsNull(rs("data")) Then DataUltimaDevolucioBusca = rs("data")
    Else
        If Not IsNull(rs("data")) Then DataUltimaDevolucioBusca = rs("data")
    End If
    If DataUltimaDevolucioBusca > Fins Then DataUltimaDevolucioBusca = Fins
    
End Function


Function DataUltimaDevolucioBusca_91(botiga As String, Fins As Date) As Date
    Dim rs As rdoResultset, D As Date
    
    DataUltimaDevolucioBusca_91 = DateAdd("d", -7, Now)
    
    Set rs = Db.OpenResultset("Select max(data) data From [" & NomTaulaDevol(Now) & "] Where Botiga = " & botiga & " ")
    If rs.EOF Then
        Set rs = Db.OpenResultset("Select max(data) data From [" & NomTaulaVentas(DateAdd("m", -1, Now)) & "] Where Botiga = " & botiga & " ")
        If Not rs.EOF Then If Not IsNull(rs("data")) Then DataUltimaDevolucioBusca_91 = rs("data")
    Else
        If Not IsNull(rs("data")) Then DataUltimaDevolucioBusca_91 = rs("data")
    End If
    If DataUltimaDevolucioBusca_91 > Fins Then DataUltimaDevolucioBusca_91 = Fins
    
End Function


Function DataUltimaDevolucioBusca_V2(botiga As String, Fins As Date) As Date
    Dim rs As rdoResultset, D As Date
    
    DataUltimaDevolucioBusca_V2 = DateAdd("d", -7, Now)
    
    Set rs = Db.OpenResultset("Select max(data) data From [" & NomTaulaDevol(Now) & "] Where Botiga = " & botiga & " ")
    If rs.EOF Then
        Set rs = Db.OpenResultset("Select max(data) data From [" & NomTaulaVentas(DateAdd("m", -1, Now)) & "] Where Botiga = " & botiga & " ")
        If Not rs.EOF Then If Not IsNull(rs("data")) Then DataUltimaDevolucioBusca_V2 = rs("data")
    Else
        If Not IsNull(rs("data")) Then DataUltimaDevolucioBusca_V2 = rs("data")
    End If
    If DataUltimaDevolucioBusca_V2 > Fins Then DataUltimaDevolucioBusca_V2 = Fins
    
End Function


Sub DataUltimaVentaInventa(botiga As String, desde As Date, Fins As Date, Unitats As Double)
    Dim rs As rdoResultset, D As Date
    
    Unitats = 0

    
    Set rs = Db.OpenResultset("Select max(data) data From [" & NomTaulaVentas(Now) & "] Where Botiga = " & botiga & " ")
    If rs.EOF Then
        Set rs = Db.OpenResultset("Select max(data) data From [" & NomTaulaVentas(DateAdd("m", -1, Now)) & "] Where Botiga = " & botiga & " ")
        If Not rs.EOF Then If Not IsNull(rs("data")) Then Unitats = rs("data")
    Else
        If Not IsNull(rs("data")) Then Unitats = rs("data")
    End If
    
End Sub


Sub ExportaContabilitatEmitidas(numAsiento, Di As Date, Df As Date, empresa, EsB)
    Dim j, D As Date, TaulaIva, TaulaData, Taulacomptab, sqlEmitidas, K, sql As String, rsCtb As rdoResultset, Archivo, clientCodi
    
    InformaMiss "Emitidas", True

    ReDim SQLA(0)
    j = 0
    D = Di
    TaulaIva = NomTaulaFacturaIva(D)
    TaulaData = NomTaulaFacturaData(D)
    Taulacomptab = NomTaulaComptavilitzat(D)
    sqlEmitidas = ""
    While D < Df Or (Year(D) = Year(Df) And Month(D) = Month(Df))
        TaulaIva = NomTaulaFacturaIva(D)
        TaulaData = NomTaulaFacturaData(D)
        Taulacomptab = NomTaulaComptavilitzat(D)
        ReDim Preserve SQLA(j)
        SQLA(j) = "select (case when  charindex('[Retencio',isnull(tn.reservat,'Directa'))  = 0 then 0 else 1 end) TeRetencio, isnull(tn.reservat,'Directa') reservat, tn.empresaCodi,tn.idfactura idfactura,tn.dataFactura datafactura,tn.datafactura,tn.clientNom clientNom,tn.clientCodi AS clientCodi,tn.numFactura numFactura,abs(tn.numFactura) nf, isnull(tn.serie,'') serie,isnull(tn.total,0) total, tn.total nnn, tb.total bbb, isnull((tn.total - tb.total),0) total_bo, isnull(tc.comptabilitzat,'NO') comp,'" & TaulaData & "' tablaData "
        For K = 0 To 3
            SQLA(j) = SQLA(j) & ",(case when tn.numfactura < 0 then 0 else tn.baseIva" & (K + 1) & " end) baseiva" & (K + 1) & ",(case when tn.numfactura < 0 then 0 else tn.iva" & (K + 1) & " end) iva" & (K + 1) & ",(case when tn.numfactura < 0 then 0 else tn.baseRec" & (K + 1) & " end) baserec" & (K + 1) & ",(case when tn.numfactura < 0 then 0 else tn.rec" & (K + 1) & " end) rec" & (K + 1) & ", (case when tn.numfactura < 0 then 0 else tn.ivarec" & (K + 1) & " end) ivarec" & (K + 1)
        Next
        SQLA(j) = SQLA(j) & " from [" & TaulaIva & "] tn left join "
        SQLA(j) = SQLA(j) & "(select idfactura, right(idfactura,38) idfactura2 from  [" & TaulaIva & "]) te on tn.idfactura=te.idfactura left join "
        SQLA(j) = SQLA(j) & "[" & TaulaIva & "] tb on tb.idfactura = te.idfactura2 left join "
        SQLA(j) = SQLA(j) & "[" & Taulacomptab & "] tc on tn.idfactura = tc.id_doc where tn.total<>0 and tn.datafactura between"
        SQLA(j) = SQLA(j) & " convert(datetime,'" & Right("0" & Day(Di), 2) & "/" & Right("0" & Month(Di), 2) & "/" & Right(CStr(Year(Di)), 2) & "',3)"
        SQLA(j) = SQLA(j) & " and convert(datetime,'" & Right("0" & Day(Df), 2) & "/" & Right("0" & Month(Df), 2) & "/" & Right(CStr(Year(Df)), 2) & "',3)"
        SQLA(j) = SQLA(j) & " + convert(datetime,'23:59:59',8)"

'       Contab ?
'       If contab = "SI" Then SQLA(j) = SQLA(j) & " and tc.comptabilitzat = 'SI'"
'       If contab = "NO" Then                SQLA(j) = SQLA(j) & " and tc.comptabilitzat = 'NO' or tc.comptabilitzat is NULL"
        SQLA(j) = SQLA(j) & " and tn.empresaCodi in(" & empresa & ")"
'       sql = sql & " and tn.clientCodi in (" & Client & ")"
        j = j + 1
        D = DateAdd("m", 1, D)
        DadesExportaCpFlush
    Wend
    sqlEmitidas = Join(SQLA, " union ") & " order by tn.datafactura,abs(tn.numFactura),clientNom,total_bo"
        
    '*************************************IMPRIMIM
    'LINEA EJEMPLO FORMATO SP
    '1200501012200000                      42289411.00Asiento de Apertura                  0.00       0            0.00 0.00 0.00                         00     0        0.000000            0.00            0.00                       0.002       254164.48            0.00            0.00F                  0            0.00            0.00F
    sql = sqlEmitidas           'Consulta SQL para generar el listado de asientos

    Set rsCtb = Db.OpenResultset(sql)
    
    InformaMiss sql, True
        
    K = 0
    While Not rsCtb.EOF
        InformaMiss "Emitidas " & rsCtb("dataFactura"), True
        clientCodi = Trim(rsCtb("clientCodi"))
            
        If (rsCtb("numFactura") > 0) Then
            If clientCodi = 0 Then clientCodi = BuscaclientCodi(rsCtb("clientNom"))
            If 0 = Round(rsCtb("Iva1"), 2) + Round(rsCtb("Iva2"), 2) + Round(rsCtb("Iva3"), 2) + Round(rsCtb("baseIva1"), 2) + Round(rsCtb("baseIva2"), 2) + Round(rsCtb("baseIva3"), 2) + rsCtb("Rec1") + rsCtb("Rec2") + rsCtb("Rec3") + rsCtb("BaseRec1") + rsCtb("BaseRec2") + rsCtb("BaseRec3") Then
                ExportaSensaIva numAsiento, rsCtb("dataFactura"), clientCodi, rsCtb("numFactura"), Round(rsCtb("Total"), 2), rsCtb("TeRetencio")
            Else
                ExportaAmbIva numAsiento, rsCtb("dataFactura"), clientCodi, rsCtb("numFactura"), Round(rsCtb("Iva1"), 2), Round(rsCtb("Iva2"), 2), Round(rsCtb("Iva3"), 2), Round(rsCtb("baseIva1"), 2), Round(rsCtb("baseIva2"), 2), Round(rsCtb("baseIva3"), 2), Round(rsCtb("IvaRec1"), 2), Round(rsCtb("IvaRec2"), 2), Round(rsCtb("IvaRec3"), 2), rsCtb("Rec1"), rsCtb("Rec2"), rsCtb("Rec3"), rsCtb("BaseRec1"), rsCtb("BaseRec2"), rsCtb("BaseRec3"), rsCtb("clientCodi"), rsCtb("TeRetencio"), rsCtb("Reservat")
            End If
        Else
            If Not EsB Then ExportaSensaIva numAsiento, rsCtb("dataFactura"), clientCodi, rsCtb("numFactura"), Round(rsCtb("Total"), 2), False
        End If
        numAsiento = numAsiento + 1
        DoEvents
        rsCtb.MoveNext
        DadesExportaCpFlush
    Wend
    rsCtb.Close

End Sub


Sub ExportaContabilitatEmitidasA3(numAsiento, Di As Date, Df As Date, empresa, EsB)
    Dim TaulaIva As String, TaulaData As String, Taulacomptab As String
    Dim D As Date, fecha As Date
    Dim K As Integer, j As Integer
    Dim nIvas As Integer, i As Integer
    Dim sql As String
    Dim linea As String
    Dim T1 As Double, T2 As Double, T3 As Double, T4 As Double, TR1 As Double, TR2 As Double, TR3 As Double, TR4 As Double
    Dim import As Double, PctIva As Double, Base As Double, Cuota As Double
    Dim CuentaVentas As String
    Dim rsCtb As rdoResultset

    
    InformaMiss "Emitidas", True
    ReDim SQLA(0)
    j = 0
    D = Di
    TaulaIva = NomTaulaFacturaIva(D)
    TaulaData = NomTaulaFacturaData(D)
    Taulacomptab = NomTaulaComptavilitzat(D)
    While D < Df ' Or (Year(D) = Year(Df) And Month(D) = Month(Df))
        TaulaIva = NomTaulaFacturaIva(D)
        TaulaData = NomTaulaFacturaData(D)
        Taulacomptab = NomTaulaComptavilitzat(D)
        ReDim Preserve SQLA(j)
        SQLA(j) = "select (case when  charindex('[Retencio',isnull(tn.reservat,'Directa'))  = 0 then 0 else 1 end) TeRetencio, tn.empresaCodi,tn.idfactura idfactura,tn.dataFactura datafactura,tn.clientNom clientNom,tn.clientCodi AS clientCodi,tn.numFactura numFactura,abs(tn.numFactura) nf, isnull(tn.serie,'') serie,isnull(tn.total,0) total, tn.total nnn, tb.total bbb, isnull((tn.total - tb.total),0) total_bo, isnull(tc.comptabilitzat,'NO') comp,'" & TaulaData & "' tablaData "
        For K = 0 To 3
            SQLA(j) = SQLA(j) & ",(case when tn.numfactura < 0 then 0 else tn.baseIva" & (K + 1) & " end) baseiva" & (K + 1) & ",(case when tn.numfactura < 0 then 0 else tn.iva" & (K + 1) & " end) iva" & (K + 1) & ",(case when tn.numfactura < 0 then 0 else tn.baseRec" & (K + 1) & " end) baserec" & (K + 1) & ",(case when tn.numfactura < 0 then 0 else tn.rec" & (K + 1) & " end) rec" & (K + 1) & ", (case when tn.numfactura < 0 then 0 else tn.ivarec" & (K + 1) & " end) ivarec" & (K + 1)
        Next
        SQLA(j) = SQLA(j) & " from [" & TaulaIva & "] tn left join "
        SQLA(j) = SQLA(j) & "(select idfactura, right(idfactura,38) idfactura2 from  [" & TaulaIva & "]) te on tn.idfactura=te.idfactura left join "
        SQLA(j) = SQLA(j) & "[" & TaulaIva & "] tb on tb.idfactura = te.idfactura2 left join "
        SQLA(j) = SQLA(j) & "[" & Taulacomptab & "] tc on tn.idfactura = tc.id_doc where tn.total<>0 and tn.datafactura between"
        SQLA(j) = SQLA(j) & " convert(datetime,'" & Right("0" & Day(Di), 2) & "/" & Right("0" & Month(Di), 2) & "/" & Right(CStr(Year(Di)), 2) & "',3)"
        SQLA(j) = SQLA(j) & " and convert(datetime,'" & Right("0" & Day(Df), 2) & "/" & Right("0" & Month(Df), 2) & "/" & Right(CStr(Year(Df)), 2) & "',3)"
        SQLA(j) = SQLA(j) & " + convert(datetime,'23:59:59',8)"
        SQLA(j) = SQLA(j) & " and tn.empresaCodi in(" & empresa & ")"
        
        j = j + 1
        D = DateAdd("m", 1, D)
        DadesExportaCpFlush
    Wend
    sql = Join(SQLA, " union ") & " order by tn.datafactura, abs(tn.numFactura), clientNom, total_bo"
    Set rsCtb = Db.OpenResultset(sql)
    

    While Not rsCtb.EOF
        import = 0
        fecha = rsCtb("datafactura")
        TipusDeIva T1, T2, T3, T4, TR1, TR2, TR3, TR4, fecha
        
        'IVAS
        nIvas = 0
        ReDim TiposIva(0)
        ReDim Bases(0)
        ReDim Cuotas(0)
        For i = 1 To 4
            If rsCtb("baseiva" & i) <> 0 Then
                ReDim Preserve TiposIva(nIvas)
                ReDim Preserve Bases(nIvas)
                ReDim Preserve Cuotas(nIvas)
                
                TiposIva(nIvas) = i
                Bases(nIvas) = Round(rsCtb("baseiva" & i), 2)
                Cuotas(nIvas) = Round(rsCtb("iva" & i), 2)
                import = import + Bases(nIvas) + Cuotas(nIvas)
                nIvas = nIvas + 1
            End If
        Next
        
        AsientoAddA3 empresa, "1", "I", fecha, codiContable(rsCtb("clientCodi")), "", "F" & rsCtb("numFactura"), "Factura per " & rsCtb("ClientNom"), import, 0, 0, 0, 0
        
        For i = 0 To UBound(TiposIva)
            linea = "M"
            If i + 1 = nIvas Then linea = "U"
               
            Select Case TiposIva(i)
                Case 1: PctIva = T1
                Case 2: PctIva = T2
                Case 3: PctIva = T3
            End Select
            
            Base = Bases(i)
            Cuota = Cuotas(i)
                
            CuentaVentas = ("7" & Right("000000000000", nDigitos - 1))
    
            AsientoAddA3 empresa, "9", linea, fecha, CuentaVentas, "", "F" & rsCtb("numFactura"), "F" & rsCtb("numFactura") & " IVA " & PctIva, import, Base, PctIva, Cuota, 0
        Next
                
        rsCtb.MoveNext
        DadesExportaCpFlush
    Wend
    rsCtb.Close

End Sub


Sub ExportaContabilitatsInicials(numAsiento, DataInicial As Date, Df As Date, nEmpresa, EsB)
    Dim rs As rdoResultset, Th, Td, ImporteDeve, ImporteHaver, Sal, Cuenta
    Dim Saldos()   As String
    
    Set rs = Db.OpenResultset("select nombre,saldo,cuenta from ccCuentas Where not (Saldo = '0' or saldo = '' ) order by saldo desc")

    numAsiento = numAsiento + 1
    Th = 0
    Td = 0
    While Not rs.EOF
        ImporteDeve = 0
        ImporteHaver = 0
        If IsNumeric(rs("Saldo")) And nEmpresa = 0 Then
            Sal = Round(CDbl(rs("Saldo")) * 100) / 100
            If CDbl(rs("Saldo")) > 0 Then
                ImporteDeve = Sal
            Else
               ImporteHaver = Sal * -1
            End If
        Else
            Saldos = Split(rs("Saldo"), "|")
            Dim i
            For i = 0 To UBound(Saldos)
                If CStr(Split(Saldos(i), "_")(0)) = CStr(nEmpresa) Then
                    Sal = Round(CDbl(Split(Saldos(i), "_")(1)) * 100) / 100
                    If CDbl(Split(Saldos(i), "_")(1)) > 0 Then
                        ImporteDeve = Sal
                    Else
                        ImporteHaver = Sal * -1
                    End If
                End If
            Next
        End If
        If (Abs(ImporteHaver) + Abs(ImporteDeve)) > 0 Then
        
            Th = Th + ImporteHaver
            Td = Td + ImporteDeve
            Cuenta = cccuentasCodiCompte(rs("Cuenta"))
            InformaMiss "Saldo Inicial " & rs("Cuenta"), True
            
            DadesExportaCp = DadesExportaCp & Right(Space(6) & numAsiento, 6)         ' Núm. del asiento '000001
            DadesExportaCp = DadesExportaCp & Right("0000" & Year(DataInicial), 4)    ' Año '2002
            DadesExportaCp = DadesExportaCp & Right("00" & Month(DataInicial), 2)     ' Mes '01
            DadesExportaCp = DadesExportaCp & Right("00" & Day(DataInicial), 2)       ' Día '03
            DadesExportaCp = DadesExportaCp & Left(Cuenta & Space(12), 12)               ' Cuenta destino '430000000000
            DadesExportaCp = DadesExportaCp & Left(Cuenta & Space(12), 12)        ' Cuenta VENTAS
            DadesExportaCp = DadesExportaCp & Right(Space(16), 16)            ' Importe Debe Pts
            DadesExportaCp = DadesExportaCp & Left("Asiento Reapertura " & Space(25), 25)     ' Concepto del asiento 'DESCRIPCION VENTA
            DadesExportaCp = DadesExportaCp & Right(Space(16) & "0.00", 16)      ' Importe Haber Pts
            DadesExportaCp = DadesExportaCp & Right(Space(8), 8)            ' Num Factura '00000073'
            DadesExportaCp = DadesExportaCp & Right(Space(16) & "0.00", 16)      ' Base imponible del IVA en Pts
            DadesExportaCp = DadesExportaCp & Right(Space(5) & "0.00", 5)      ' Porcentage de IVA
            DadesExportaCp = DadesExportaCp & Right(Space(5) & "0.00", 5)      ' Recargo de equivalencia
            DadesExportaCp = DadesExportaCp & Right(Space(10) & numAsiento, 10)       ' Número de documento
            DadesExportaCp = DadesExportaCp & Right(Space(3), 3)            ' Código de departamento
            DadesExportaCp = DadesExportaCp & Right(Space(6), 6)            ' Código del proyecto
            DadesExportaCp = DadesExportaCp & Right(Space(1), 1)            ' Punteo (interno)
            DadesExportaCp = DadesExportaCp & Right(Space(6) & "0", 6)        ' Númerico de casación (interno)
            DadesExportaCp = DadesExportaCp & Right(Space(1) & "0", 1)        ' Tipo de casado (interno)
            DadesExportaCp = DadesExportaCp & Right(Space(6) & "0", 6)        ' Número de pago
            DadesExportaCp = DadesExportaCp & Right(Space(16) & "0.000000", 16)       ' Cambio a aplicar
            DadesExportaCp = DadesExportaCp & Right(Space(16) & "0.00", 16)      ' Importe debe moneda extranjera
            DadesExportaCp = DadesExportaCp & Right(Space(16) & "0.00", 16)      ' Importe haber moneda extranjera
            DadesExportaCp = DadesExportaCp & Right(Space(1), 1)            ' Auxiliar (interno)
            DadesExportaCp = DadesExportaCp & Right(Space(1), 1)            ' Serie de la facturación
            DadesExportaCp = DadesExportaCp & Right(Space(4), 4)            ' Sucursal (sin uso)
            DadesExportaCp = DadesExportaCp & Right(Space(5), 5)            ' Código de la divisa
            DadesExportaCp = DadesExportaCp & Right(Space(16) & "0.00", 16)      ' Importe auxiliar moneda extranjera
            DadesExportaCp = DadesExportaCp & Right(Space(1) & "2", 1)        ' Moneda en USo (1-Peseteas, 2-Euros)
            DadesExportaCp = DadesExportaCp & Right(Space(16) & ImporteDeve, 16)      ' Importe al debe en euros
            DadesExportaCp = DadesExportaCp & Right(Space(16) & ImporteHaver, 16)     ' Importe al haber en euros
            DadesExportaCp = DadesExportaCp & Right(Space(16) & 0, 16)        ' Base imponible del IVA en Euros
            DadesExportaCp = DadesExportaCp & Right(Space(1) & "F", 1)        ' NoConv (interno)
            DadesExportaCp = DadesExportaCp & Right(Space(10), 10)            ' Código de Activo
            DadesExportaCp = DadesExportaCp & Right(Space(1), 1)            ' serie de Factura rectificada
            DadesExportaCp = DadesExportaCp & Right(Space(8), 8)            ' Número factura rectificada
            DadesExportaCp = DadesExportaCp & Right(Space(16) & "0.00", 16)      ' Base imponible factura rectificada
            DadesExportaCp = DadesExportaCp & Right(Space(16) & "0.00", 16)      ' Base imponible factura rectificada
            DadesExportaCp = DadesExportaCp & Right(Space(1) & "F", 1)        ' Factura rectificada (T en caso de factura rectificada)
            DadesExportaCp = DadesExportaCp & Right(Space(4), 4)            ' Año '2002 FacturaRectificada
            DadesExportaCp = DadesExportaCp & Right(Space(2), 2)            ' Mes '01   FacturaRectificada
            DadesExportaCp = DadesExportaCp & Right(Space(2), 2)                ' Día '03   FacturaRectificada
            DadesExportaCp = DadesExportaCp & Chr(13) & Chr(10)                                  ' Fin     ' chr13 + chr10
        End If
        rs.MoveNext
        DoEvents
    Wend
    rs.Close
    
    If Abs(Th - Td) > 0.001 Then
        ImporteDeve = 0
        ImporteHaver = 0
        If CDbl(Th - Td) < 0 Then
            ImporteDeve = Abs(Round(Th - Td, 2))
        Else
            ImporteHaver = Abs(Round(Th - Td, 2))
        End If
    
        DadesExportaCp = DadesExportaCp & Right(Space(6) & numAsiento, 6)                      ' Núm. del asiento '000001
        DadesExportaCp = DadesExportaCp & Right("0000" & Year(DataInicial), 4)                    ' Año '2002
        DadesExportaCp = DadesExportaCp & Right("00" & Month(DataInicial), 2)                  ' Mes '01
        DadesExportaCp = DadesExportaCp & Right("00" & Day(DataInicial), 2)                      ' Día '03
        DadesExportaCp = DadesExportaCp & Left("79000000" & Space(12), 12)                              ' Cuenta destino '430000000000
        DadesExportaCp = DadesExportaCp & Left("79000000" & Space(12), 12)                                                          ' Cuenta VENTAS
        DadesExportaCp = DadesExportaCp & Right(Space(16), 16)                                                ' Importe Debe Pts
        DadesExportaCp = DadesExportaCp & Left("Errores descuadre ReApertura " & Space(25), 25)   ' Concepto del asiento 'DESCRIPCION VENTA
        DadesExportaCp = DadesExportaCp & Right(Space(16) & "0.00", 16)                                                       ' Importe Haber Pts
        DadesExportaCp = DadesExportaCp & Right(Space(8), 8)                                          ' Num Factura '00000073'
        DadesExportaCp = DadesExportaCp & Right(Space(16) & "0.00", 16)                                                       ' Base imponible del IVA en Pts
        DadesExportaCp = DadesExportaCp & Right(Space(5) & "0.00", 5)                                                         ' Porcentage de IVA
        DadesExportaCp = DadesExportaCp & Right(Space(5) & "0.00", 5)                                                         ' Recargo de equivalencia
        DadesExportaCp = DadesExportaCp & Right(Space(10) & numAsiento, 10)                                                   ' Número de documento
        DadesExportaCp = DadesExportaCp & Right(Space(3), 3)                                                                  ' Código de departamento
        DadesExportaCp = DadesExportaCp & Right(Space(6), 6)                                                                  ' Código del proyecto
        DadesExportaCp = DadesExportaCp & Right(Space(1), 1)                                                                  ' Punteo (interno)
        DadesExportaCp = DadesExportaCp & Right(Space(6) & "0", 6)                                                            ' Númerico de casación (interno)
        DadesExportaCp = DadesExportaCp & Right(Space(1) & "0", 1)                                                            ' Tipo de casado (interno)
        DadesExportaCp = DadesExportaCp & Right(Space(6) & "0", 6)                                                            ' Número de pago
        DadesExportaCp = DadesExportaCp & Right(Space(16) & "0.000000", 16)                                                   ' Cambio a aplicar
        DadesExportaCp = DadesExportaCp & Right(Space(16) & "0.00", 16)                                                       ' Importe debe moneda extranjera
        DadesExportaCp = DadesExportaCp & Right(Space(16) & "0.00", 16)                                                       ' Importe haber moneda extranjera
        DadesExportaCp = DadesExportaCp & Right(Space(1), 1)                                                                  ' Auxiliar (interno)
        DadesExportaCp = DadesExportaCp & Right(Space(1), 1)                                                                  ' Serie de la facturación
        DadesExportaCp = DadesExportaCp & Right(Space(4), 4)                                                                  ' Sucursal (sin uso)
        DadesExportaCp = DadesExportaCp & Right(Space(5), 5)                                                                  ' Código de la divisa
        DadesExportaCp = DadesExportaCp & Right(Space(16) & "0.00", 16)                                                       ' Importe auxiliar moneda extranjera
        DadesExportaCp = DadesExportaCp & Right(Space(1) & "2", 1)                                                            ' Moneda en USo (1-Peseteas, 2-Euros)
        DadesExportaCp = DadesExportaCp & Right(Space(16) & ImporteHaver, 16)                                                   ' Importe al debe en euros
        DadesExportaCp = DadesExportaCp & Right(Space(16) & ImporteDeve, 16)                                               ' Importe al haber en euros
        DadesExportaCp = DadesExportaCp & Right(Space(16) & 0, 16)                                                            ' Base imponible del IVA en Euros
        DadesExportaCp = DadesExportaCp & Right(Space(1) & "F", 1)                                                            ' NoConv (interno)
        DadesExportaCp = DadesExportaCp & Right(Space(10), 10)                                                                ' Código de Activo
        DadesExportaCp = DadesExportaCp & Right(Space(1), 1)                                                                  ' serie de Factura rectificada
        DadesExportaCp = DadesExportaCp & Right(Space(8), 8)                                                                  ' Número factura rectificada
        DadesExportaCp = DadesExportaCp & Right(Space(16) & "0.00", 16)                                                       ' Base imponible factura rectificada
        DadesExportaCp = DadesExportaCp & Right(Space(16) & "0.00", 16)                                                       ' Base imponible factura rectificada
        DadesExportaCp = DadesExportaCp & Right(Space(1) & "F", 1)                                                            ' Factura rectificada (T en caso de factura rectificada)
        DadesExportaCp = DadesExportaCp & Right(Space(4), 4)                                                                  ' Año '2002 FacturaRectificada
        DadesExportaCp = DadesExportaCp & Right(Space(2), 2)                                                                  ' Mes '01   FacturaRectificada
        DadesExportaCp = DadesExportaCp & Right(Space(2), 2)                                                                  ' Día '03   FacturaRectificada
    End If
    numAsiento = numAsiento + 1
            

End Sub

Sub ExportaContabilitatVentas(numAsiento, Di As Date, Df As Date, empresa, Botigues As String, EsB As Boolean)
    Dim i, j, D As Date, sql As String, rsCtb As rdoResultset, fecha As Date, botiga, import, tipoIva, PctIva, Base, Quota, CuentaVentas
    Dim T1 As Double, T2 As Double, T3 As Double, T4 As Double, TR1 As Double, TR2 As Double, TR3 As Double, TR4 As Double, CcVentas
    Dim CFam, prj As String, cCtble, rsCodi As rdoResultset
    Dim RsnFact As rdoResultset, nFact As Double
    Dim rsSerie As rdoResultset, serieFact As String, NomTaulaNumFactura As String
    
    
    Informa "Ventas"
    Informa "Ventas"
    Informa "Ventas"
    Informa "Ventas"
    Informa "Ventas"
    Informa "Ventas"
    
    
    InformaMiss "Ventas", True
    j = 0
    D = Di
    While D <= Df ' Or (Year(D) = Year(Df) And Month(D) = Month(Df))
        TipusDeIva T1, T2, T3, T4, TR1, TR2, TR3, TR4, D
        DadesExportaCpFlush
    
    ' Tienes el cF que es la cuenta de familia contable. 70FFFTTT t= Tienda, F = Familia
    
        'sql = "Select cF,a.tipoiva,v.botiga,sum(v.import) as import"
        'sql = sql & " from (Select Botiga,Plu,sum(import) Import from [" & NomTaulaVentasAoB(D, EsB) & "]"
        'sql = sql & " where day(data) = " & Day(D) & " And  botiga in(select Codi  from constantsclient where variable = 'EmpresaVendes' and valor = " & Empresa & ")"
        'sql = sql & " group by botiga,plu) v"
        'sql = sql & " Left Join"
        'sql = sql & " ("
        'sql = sql & " Select left(isnull(a,'0 Cap'),CHARINDEX (' ',isnull(a,'0 Cap'))) Cf,codi,tipoiva From "
        'sql = sql & " (select Familia,codi,tipoiva from articles  union select Familia,codi,tipoiva from articles_zombis) aa "
        'sql = sql & " left Join (select isnull(f1.pare,'0 Cap') a,f1.nom b ,f2.nom c from Families F1 join Families F2 on f1.nom = f2.pare) f "
        'sql = sql & " on aa.familia = f.c and CHARINDEX (' ',a)>0 "
        'sql = sql & " ) a on a.codi  = v.plu "
        'sql = sql & " group by botiga,tipoiva,cF "
        'sql = sql & " order by botiga, Cf, tipoiva "
        
        sql = "Select cF,a.tipoiva,v.botiga,sum(v.import) as import, a.projecte "
        sql = sql & " from (Select Botiga,Plu,sum(import) Import "
        sql = sql & " From [" & NomTaulaVentasAoB(D, EsB) & "] "
        sql = sql & " where day(data) = " & Day(D) & " And  botiga in (select Codi  from constantsclient where variable = 'EmpresaVendes' and valor = " & empresa & ") "
        If Botigues <> "()" Then sql = sql & " and botiga in " & Botigues & " "
        sql = sql & " group by botiga,plu) v "
        sql = sql & "Left Join "
        sql = sql & "( "
        sql = sql & "select isnull(fe3.valor, isnull(fe2.valor, isnull(fe1.valor, '0'))) Cf, Aa.codi, aa.TipoIva, ISNULL(feP.valor, '') projecte "
        sql = sql & "From "
        sql = sql & "(select Familia,codi,tipoiva from articles union select Familia,codi,tipoiva from articles_zombis) aa "
        sql = sql & "left join families F3 on aa.Familia = F3.Nom "
        sql = sql & "left join families F2 on F2.nom = F3.pare "
        sql = sql & "left join families F1 on F1.Nom = F2.Pare "
        sql = sql & "left Join " & NomTaulaFamiliesExtes() & " fe3 on F3.nom=fe3.familia and fe3.variable='CUENTA_CONTABLE' "
        sql = sql & "left Join " & NomTaulaFamiliesExtes() & " fe2 on F2.nom=fe2.familia and fe2.variable='CUENTA_CONTABLE' "
        sql = sql & "left Join " & NomTaulaFamiliesExtes() & " fe1 on F1.nom=fe1.familia and fe1.variable='CUENTA_CONTABLE' "
        sql = sql & "left Join " & NomTaulaFamiliesExtes() & " feP on F1.nom=feP.familia and feP.variable='PROJECTE' "
        sql = sql & ") a on a.codi  = v.plu "
        sql = sql & "group by botiga,tipoiva,cF, a.projecte "
        sql = sql & "order by botiga, Cf, tipoiva, a.projecte "
        Dim botigaLast
        Set rsCtb = Db.OpenResultset(sql)
        'If Not rsCtb.EOF Then botigaLast = rsCtb("botiga")
        If Not rsCtb.EOF Then botigaLast = -1
    
        While Not rsCtb.EOF
            fecha = D 'DateSerial(Year(D), Month(D), Day(DateAdd("d", -1, DateSerial(Year(DateAdd("m", 1, D)), Month(DateAdd("m", 1, D)), 1))))
            botiga = rsCtb("botiga")
            import = rsCtb("Import")
            tipoIva = rsCtb("TipoIva")
            CFam = rsCtb("cF")
            prj = NoNull(rsCtb("projecte"))
            
            If Not botigaLast = botiga Then numAsiento = numAsiento + 1
            botigaLast = botiga
            
            InformaMiss "Exporta Ventas  " & fecha & " Botiga " & BotigaCodiNom(botiga), True
            Select Case tipoIva
                Case 1: PctIva = T1
                Case 2: PctIva = T2
                Case 3: PctIva = T3
            End Select
            Base = Round(import / (1 + (PctIva / 100)), 2)
            Quota = Round(import - Base, 2)
            import = Base + Quota
            
            CuentaVentas = cVentaMercaderies(rsCtb("botiga"), False)
            If IsNumeric(rsCtb("cF")) Then CuentaVentas = CuentaVentas + rsCtb("cF") * 1000
            CcVentas = cVentaMercaderies(rsCtb("botiga"), False)
            
            cCtble = botiga
            Set rsCodi = Db.OpenResultset("SELECT Valor FROM " & tablaConstantsClient() & " WHERE  codi = " & botiga & " AND variable = 'CodiContable' ")
            If Not rsCodi.EOF Then If Not IsNull(rsCodi("Valor")) And (Len(rsCodi("Valor")) > 0) And IsNumeric(rsCodi("Valor")) Then cCtble = CDbl(rsCodi("Valor"))
    
            serieFact = " "
            Set rsSerie = Db.OpenResultset("SELECT Valor FROM " & tablaConstantsClient() & " WHERE codi = " & botiga & " AND variable = 'SerieFacturacio'")
            If Not rsSerie.EOF Then
                serieFact = rsSerie("Valor")
            End If
    
            NomTaulaNumFactura = "NumFacturaVendes_" & Format(fecha, "yyyy")
            If ExisteixTaula(NomTaulaNumFactura) Then
                nFact = 1
                Set RsnFact = Db.OpenResultset("SELECT Factura FROM " & NomTaulaNumFacturaVendes(fecha) & " WHERE  Botiga = " & botiga & " AND data = convert(datetime,'" & fecha & "',103) ")
                If Not RsnFact.EOF Then
                    nFact = RsnFact("Factura")
                End If
            
               AsientoAddSerie numAsiento, fecha, ("43" & Right("000000000000", nDigitos - 2)) + cCtble, CuentaVentas, serieFact, cCtble * 1000 + nFact, "Ventas " & BotigaCodiNom(botiga), import, 0, 0, 0, 0, prj, "C"
               AsientoAddSerie numAsiento, fecha, ("477" & Right("000000000000", nDigitos - 3)) + PctIva, ("43" & Right("000000000000", nDigitos - 2)) + cCtble, serieFact, cCtble * 1000 + nFact, "Ventas " & BotigaCodiNom(botiga), 0, Quota, Base, PctIva, 0, prj, "C"
               AsientoAddSerie numAsiento, fecha, CcVentas, CcVentas, serieFact, cCtble * 1000 + nFact, "Ventas " & BotigaCodiNom(botiga), 0, Base, Base, PctIva, 0, prj, "C"
            
               If EsB Then
                   AsientoAddSerie numAsiento, fecha, ("57" & Right("000000000000", nDigitos - 2)) + cCtble, ("43" & Right("000000000000", nDigitos - 2)) + cCtble, serieFact, cCtble * 1000 + Month(fecha), "Ventas " & BotigaCodiNom(botiga), import, 0, 0, 0, 0, prj, "C"
                   AsientoAddSerie numAsiento, fecha, ("43" & Right("000000000000", nDigitos - 2)) + cCtble, ("57" & Right("000000000000", nDigitos - 2)) + cCtble, serieFact, cCtble * 1000 + Month(fecha), "Ventas " & BotigaCodiNom(botiga), 0, import, 0, 0, 0, prj, "C"
               End If
            Else
               AsientoAddSerie numAsiento, fecha, ("43" & Right("000000000000", nDigitos - 2)) + cCtble, CuentaVentas, serieFact, cCtble * 1000 + DatePart("y", fecha), "Ventas " & BotigaCodiNom(botiga), import, 0, 0, 0, 0, prj
               AsientoAddSerie numAsiento, fecha, ("477" & Right("000000000000", nDigitos - 3)) + PctIva, ("43" & Right("000000000000", nDigitos - 2)) + cCtble, serieFact, cCtble * 1000 + DatePart("y", fecha), "Ventas " & BotigaCodiNom(botiga), 0, Quota, Base, PctIva, 0, prj
               AsientoAddSerie numAsiento, fecha, CcVentas, CcVentas, serieFact, cCtble * 1000 + DatePart("y", fecha), "Ventas " & BotigaCodiNom(botiga), 0, Base, Base, PctIva, 0, prj
            
               If EsB Or UCase(EmpresaActual) = UCase("Panet") Then
                   AsientoAddSerie numAsiento, fecha, ("57" & Right("000000000000", nDigitos - 2)) + cCtble, ("43" & Right("000000000000", nDigitos - 2)) + cCtble, serieFact, cCtble * 1000 + Month(fecha), "Ventas " & BotigaCodiNom(botiga), import, 0, 0, 0, 0, prj
                   AsientoAddSerie numAsiento, fecha, ("43" & Right("000000000000", nDigitos - 2)) + cCtble, ("57" & Right("000000000000", nDigitos - 2)) + cCtble, serieFact, cCtble * 1000 + Month(fecha), "Ventas " & BotigaCodiNom(botiga), 0, import, 0, 0, 0, prj
               End If
            End If
    
            InformaMiss "Ventas " & D, True
            DoEvents
            rsCtb.MoveNext
        Wend
        
        rsCtb.Close
        D = DateAdd("d", 1, D)
    Wend

End Sub

Sub FacturaSERUNION(idFactura As String, dataFactura As Date)
    Dim fitxer As String
    Dim rs As rdoResultset, rsData As rdoResultset, rsCli As rdoResultset, rsEmp As rdoResultset, rsCom As rdoResultset, sql As String
    Dim nFactura As String, nAlb As String, dataAlb As String, empNom As String, empNif As String, empCodi As String, empCodiCamp As String, empIBAN As String
    Dim Clicodi As String, CliNif As String, CliNom As String, cliNomComercial As String, CliAdresa As String, CliCp As String, CliCiutat As String, cliProvincia As String, serunion_po As String, cliIBAN As String
    Dim Total As Double, dataVenciment As Date
    Dim baseIva1 As Double, iva1 As Double, baseIva2 As Double, iva2 As Double, baseIva3 As Double, iva3 As Double, totalImpIVA As Double
    Dim pos As Integer, nomFileTemp As String
    Dim f As Integer
    
    On Error GoTo SERUNION_ERROR
    
    nomFileTemp = "UBL_SP_INVOIC_" & Format(Now, "yyyymmdd") & "_" & Format(Now, "hhnnss") & "000.xml"
   
     Dim objStream As Object
    
     'Create the stream
     Set objStream = CreateObject("ADODB.Stream")
    
     'Initialize the stream
     objStream.Open
    
     'Reset the position and indicate the charactor encoding
     objStream.Position = 0
     objStream.Charset = "UTF-8"

    Set rs = Db.OpenResultset("Select * From [" & NomTaulaFacturaIva(dataFactura) & "] f where idFactura='" & idFactura & "'")
    
    If Not rs.EOF Then
        nFactura = rs("NumFactura")
        empNom = rs("EmpNom")
        empNif = rs("EmpNif")
        Clicodi = rs("ClientCodi")
        empCodi = rs("EmpresaCodi")
        Total = rs("total")
        dataVenciment = rs("dataVenciment")
        
        baseIva1 = rs("BaseIva1")
        iva1 = rs("Iva1")
  
        baseIva2 = rs("BaseIva2")
        iva2 = rs("Iva2")
  
        baseIva3 = rs("BaseIva3")
        iva3 = rs("Iva3")
  
        sql = "select isnull(substring(referencia,charindex('IdAlbara:',referencia)+9,charindex(']',referencia,charindex('IdAlbara:',referencia)+9)-charindex('IdAlbara:',referencia)-9),'') nAlb, "
        sql = sql & "isnull(substring(referencia,charindex('Data:',referencia)+5,charindex(']',referencia,charindex('Data:',referencia)+5)-charindex('Data:',referencia)-5),'') data "
        sql = sql & "From [" & NomTaulaFacturaData(dataFactura) & "] "
        sql = sql & "where idfactura='" & idFactura & "' and referencia like '%IdAlbara:%' and referencia like '%Data:%'"
        Set rsData = Db.OpenResultset(sql)
        If Not rsData.EOF Then
            nAlb = rsData("nAlb")
            dataAlb = rsData("data")
        End If
        
        sql = "select nom nomComercial, [nom llarg] nomFiscal, adresa, isnull(cc1.valor, '') provincia, c.cp, c.ciutat, c.nif, ISNULL(cc2.valor, '') serunion_po, ISNULL(cc3.valor, '') IBAN "
        sql = sql & "from clients c "
        sql = sql & "left join constantsClient cc1 on c.codi=cc1.codi and cc1.variable='PROVINCIA' "
        sql = sql & "left join constantsClient cc2 on c.codi=cc2.codi and cc2.variable='SERUNION_PO' "
        sql = sql & "left join constantsClient cc3 on c.codi=cc3.codi and cc3.variable='CompteCorrent' "
        sql = sql & "Where c.Codi = " & Clicodi
        Set rsCli = Db.OpenResultset(sql)
        If Not rsCli.EOF Then
            CliNom = rsCli("nomFiscal")
            cliNomComercial = rsCli("NomComercial")
            CliAdresa = rsCli("Adresa")
            CliCp = rsCli("cp")
            CliCiutat = rsCli("ciutat")
            cliProvincia = rsCli("provincia")
            CliNif = rsCli("nif")
            serunion_po = rsCli("serunion_po")
        End If
        
        empCodiCamp = ""
        If empCodi <> "0" Then empCodiCamp = empCodi & "_"
        Set rsEmp = Db.OpenResultset("select * from constantsempresa where camp = '" & empCodiCamp & "CampCompteCorrent'")
        If Not rsEmp.EOF Then empIBAN = rsEmp("Valor")
    End If
    
    fitxer = "<?xml version=""1.0"" encoding=""UTF-8""?> "
    fitxer = fitxer & "<Invoice "
    fitxer = fitxer & "xmlns=""urn:oasis:names:specification:ubl:schema:xsd:Invoice-2"" "
    fitxer = fitxer & "xmlns:cac=""urn:oasis:names:specification:ubl:schema:xsd:CommonAggregateComponents-2"" "
    fitxer = fitxer & "xmlns:cbc=""urn:oasis:names:specification:ubl:schema:xsd:CommonBasicComponents-2""> "
    fitxer = fitxer & "<cbc:ID>" & nFactura & "</cbc:ID> "
    fitxer = fitxer & "<cbc:IssueDate>" & Year(dataFactura) & "-" & Right("00" & Month(dataFactura), 2) & "-" & Right("00" & Day(dataFactura), 2) & "</cbc:IssueDate> "
    fitxer = fitxer & "<cbc:InvoiceTypeCode>380</cbc:InvoiceTypeCode> "
    fitxer = fitxer & "<cbc:Note>" & cliNomComercial & "</cbc:Note> "
    fitxer = fitxer & "<cbc:DocumentCurrencyCode>EUR</cbc:DocumentCurrencyCode> "
    fitxer = fitxer & "<cac:DespatchDocumentReference> "
    fitxer = fitxer & "<cbc:ID>ALB_" & Right("00000000" & nAlb, 8) & "</cbc:ID> "
    fitxer = fitxer & "<cbc:IssueDate>" & dataAlb & "</cbc:IssueDate> "
    fitxer = fitxer & "</cac:DespatchDocumentReference> "
    fitxer = fitxer & "<cac:AccountingSupplierParty> "
    fitxer = fitxer & "<cac:Party> "
    fitxer = fitxer & "<cac:PartyIdentification> "
    fitxer = fitxer & "<cbc:ID identificationSchemeName=""CIF/NIF"">" & empNif & "</cbc:ID> "
    fitxer = fitxer & "</cac:PartyIdentification> "
    fitxer = fitxer & "<cac:PartyName> "
    fitxer = fitxer & "<cbc:Name>" & empNom & "</cbc:Name> "
    fitxer = fitxer & "</cac:PartyName> "
    fitxer = fitxer & "</cac:Party> "
    fitxer = fitxer & "</cac:AccountingSupplierParty> "
    fitxer = fitxer & "<cac:AccountingCustomerParty> "
    fitxer = fitxer & "<cac:Party> "
    fitxer = fitxer & "<cac:PartyIdentification> "
    fitxer = fitxer & "<cbc:ID identificationSchemeName=""CIF/NIF"">" & CliNif & "</cbc:ID> "
    fitxer = fitxer & "</cac:PartyIdentification> "
    fitxer = fitxer & "<cac:PartyName> "
    fitxer = fitxer & "<cbc:Name>" & CliNom & "</cbc:Name> "
    fitxer = fitxer & "</cac:PartyName> "
    fitxer = fitxer & "</cac:Party> "
    fitxer = fitxer & "</cac:AccountingCustomerParty> "

    fitxer = fitxer & "<cac:Delivery> "
    fitxer = fitxer & "<cac:DeliveryAddress> "
    fitxer = fitxer & "<cbc:StreetName>" & CliAdresa & "</cbc:StreetName> "
    fitxer = fitxer & "<cbc:CityName>" & CliCiutat & "</cbc:CityName> "
    fitxer = fitxer & "<cbc:PostalZone>" & CliCp & "</cbc:PostalZone> "
    fitxer = fitxer & "<cbc:Region>" & cliProvincia & "</cbc:Region> "
    fitxer = fitxer & "<cac:Country> "
    fitxer = fitxer & "<cbc:IdentificationCode>ES</cbc:IdentificationCode> "
    fitxer = fitxer & "<cbc:Name>España</cbc:Name> "
    fitxer = fitxer & "</cac:Country> "
    fitxer = fitxer & "</cac:DeliveryAddress> "
    fitxer = fitxer & "<cac:DeliveryLocation> "
    fitxer = fitxer & "<cbc:ID identificationSchemeName=""GLN"">" & serunion_po & "</cbc:ID> "
    fitxer = fitxer & "<cbc:Name>" & cliNomComercial & "</cbc:Name> "
    fitxer = fitxer & "</cac:DeliveryLocation> "
    fitxer = fitxer & "</cac:Delivery> "
 
    fitxer = fitxer & "<cac:PaymentMeans> "
    fitxer = fitxer & "<cbc:ID>1</cbc:ID> " 'Identificador del método de pago para usar en los vencimientos
    fitxer = fitxer & "<cbc:PaymentMeansCode>7</cbc:PaymentMeansCode> "  'Forma de pago (7) Transferencia
    fitxer = fitxer & "<cac:PayerFinancialAccount> "
    fitxer = fitxer & "<cbc:ID>" & cliIBAN & "</cbc:ID> " 'Número de cuenta del pagador (IBAN)
    fitxer = fitxer & "</cac:PayerFinancialAccount> "
    fitxer = fitxer & "<cac:PayeeFinancialAccount> "
    fitxer = fitxer & "<cbc:ID>" & empIBAN & "</cbc:ID> " 'Número de cuenta del receptor del pago (IBAN)
    fitxer = fitxer & "</cac:PayeeFinancialAccount> "
    fitxer = fitxer & "</cac:PaymentMeans> "
    
    fitxer = fitxer & "<cac:PaymentTerms> "
    fitxer = fitxer & "<cbc:PaymentMeansID>1</cbc:PaymentMeansID> "
    fitxer = fitxer & "<cbc:Note></cbc:Note> "
    fitxer = fitxer & "<cbc:Amount>" & Replace(FormatNumber(Total, 2), ",", "") & "</cbc:Amount> "
    fitxer = fitxer & "<cbc:PaymentDueDate>" & Year(dataVenciment) & "-" & Right("00" & Month(dataVenciment), 2) & "-" & Right("00" & Day(dataVenciment), 2) & "</cbc:PaymentDueDate> "
    fitxer = fitxer & "</cac:PaymentTerms> "
    
    totalImpIVA = iva1 + iva2 + iva3
    
    fitxer = fitxer & "<cac:TaxTotal> "
    fitxer = fitxer & "<cbc:TaxAmount currencyID=""EUR"">" & Replace(FormatNumber(totalImpIVA, 2), ",", "") & "</cbc:TaxAmount> "
    
    If iva1 > 0 Then
        'fitxer = fitxer & "<cac:TaxTotal> "
        'fitxer = fitxer & "<cbc:TaxAmount currencyID=""EUR"">" & Replace(FormatNumber(totalImpIVA, 2), ",", "") & "</cbc:TaxAmount> "
        fitxer = fitxer & "<cac:TaxSubtotal> "
        fitxer = fitxer & "<cbc:TaxableAmount currencyID=""EUR"">" & Replace(FormatNumber(baseIva1, 2), ",", "") & "</cbc:TaxableAmount> "
        fitxer = fitxer & "<cbc:TaxAmount currencyID=""EUR"">" & Replace(FormatNumber(iva1, 2), ",", "") & "</cbc:TaxAmount> "
        fitxer = fitxer & "<cac:TaxCategory> "
        fitxer = fitxer & "<cbc:Percent>4.00</cbc:Percent> "
        fitxer = fitxer & "<cac:TaxScheme> "
        fitxer = fitxer & "<cbc:Name>IVA</cbc:Name> "
        fitxer = fitxer & "<cbc:TaxTypeCode>1</cbc:TaxTypeCode> "
        fitxer = fitxer & "</cac:TaxScheme>"
        fitxer = fitxer & "</cac:TaxCategory>"
        fitxer = fitxer & "</cac:TaxSubtotal>"
        'fitxer = fitxer & "</cac:TaxTotal>"
    End If

    If iva2 > 0 Then
        'fitxer = fitxer & "<cac:TaxTotal>"
        'fitxer = fitxer & "<cbc:TaxAmount currencyID=""EUR"">" & Replace(FormatNumber(totalImpIVA, 2), ",", "") & "</cbc:TaxAmount>"
        fitxer = fitxer & "<cac:TaxSubtotal>"
        fitxer = fitxer & "<cbc:TaxableAmount currencyID=""EUR"">" & Replace(FormatNumber(baseIva2, 2), ",", "") & "</cbc:TaxableAmount>"
        fitxer = fitxer & "<cbc:TaxAmount currencyID=""EUR"">" & Replace(FormatNumber(iva2, 2), ",", "") & "</cbc:TaxAmount>"
        fitxer = fitxer & "<cac:TaxCategory>"
        fitxer = fitxer & "<cbc:Percent>10.00</cbc:Percent>"
        fitxer = fitxer & "<cac:TaxScheme>"
        fitxer = fitxer & "<cbc:Name>IVA</cbc:Name>"
        fitxer = fitxer & "<cbc:TaxTypeCode>1</cbc:TaxTypeCode>"
        fitxer = fitxer & "</cac:TaxScheme>"
        fitxer = fitxer & "</cac:TaxCategory>"
        fitxer = fitxer & "</cac:TaxSubtotal>"
        'fitxer = fitxer & "</cac:TaxTotal>"
    End If

    If iva3 > 0 Then
        'fitxer = fitxer & "<cac:TaxTotal>"
        'fitxer = fitxer & "<cbc:TaxAmount currencyID=""EUR"">" & Replace(FormatNumber(totalImpIVA, 2), ",", "") & "</cbc:TaxAmount>"
        fitxer = fitxer & "<cac:TaxSubtotal>"
        fitxer = fitxer & "<cbc:TaxableAmount currencyID=""EUR"">" & Replace(FormatNumber(baseIva3, 2), ",", "") & "</cbc:TaxableAmount>"
        fitxer = fitxer & "<cbc:TaxAmount currencyID=""EUR"">" & Replace(FormatNumber(iva3, 2), ",", "") & "</cbc:TaxAmount>"
        fitxer = fitxer & "<cac:TaxCategory>"
        fitxer = fitxer & "<cbc:Percent>21.00</cbc:Percent>"
        fitxer = fitxer & "<cac:TaxScheme>"
        fitxer = fitxer & "<cbc:Name>IVA</cbc:Name>"
        fitxer = fitxer & "<cbc:TaxTypeCode>1</cbc:TaxTypeCode>"
        fitxer = fitxer & "</cac:TaxScheme>"
        fitxer = fitxer & "</cac:TaxCategory>"
        fitxer = fitxer & "</cac:TaxSubtotal>"
        'fitxer = fitxer & "</cac:TaxTotal>"
    End If
    fitxer = fitxer & "</cac:TaxTotal>"

    fitxer = fitxer & "<cac:LegalMonetaryTotal>"
    fitxer = fitxer & "<cbc:TaxExclusiveAmount>" & Replace(FormatNumber(baseIva1 + baseIva2 + baseIva3, 2), ",", "") & "</cbc:TaxExclusiveAmount>"
    fitxer = fitxer & "<cbc:TaxInclusiveAmount>" & Replace(FormatNumber(Total, 2), ",", "") & "</cbc:TaxInclusiveAmount>"
    fitxer = fitxer & "<cbc:PayableAmount>" & Replace(FormatNumber(Total, 2), ",", "") & "</cbc:PayableAmount>"
    fitxer = fitxer & "</cac:LegalMonetaryTotal>"
    
    pos = 1
    
    sql = "select case "
    sql = sql & "when charindex('IdAlbara:',referencia) = 0 then '' "
    sql = sql & "when charindex('IdAlbara:',referencia) > 0 then "
    sql = sql & "isnull(substring(referencia,charindex('IdAlbara:',referencia)+9,charindex(']',referencia,charindex('IdAlbara:',referencia)+9)-charindex('IdAlbara:',referencia)-9),'') "
    sql = sql & "end nAlb, "
    sql = sql & "case "
    sql = sql & "when charindex('Data:',referencia) = 0 then '' "
    sql = sql & "when charindex('Data:',referencia) > 0 then "
    sql = sql & "isnull(substring(referencia,charindex('Data:',referencia)+5,charindex(']',referencia,charindex('Data:',referencia)+5)-charindex('Data:',referencia)-5),'') "
    sql = sql & "end Data, "
    sql = sql & "isnull((select top 1 codi from codisbarres where Producte=f.producte), '') EAN, * "
    sql = sql & "From [" & NomTaulaFacturaData(dataFactura) & "] f "
    sql = sql & "where idfactura='" & idFactura & "'"
    Set rsData = Db.OpenResultset(sql)
    While Not rsData.EOF
        fitxer = fitxer & "<cac:InvoiceLine>"
        fitxer = fitxer & "<cbc:ID>" & pos * 10 & "</cbc:ID>"
        fitxer = fitxer & "<cbc:Note>" & cliNomComercial & "</cbc:Note>"
        fitxer = fitxer & "<cbc:InvoicedQuantity quantityUnitCode=""UNIDAD"">" & Replace(FormatNumber(rsData("Servit") - rsData("Tornat"), 3), ",", "") & "</cbc:InvoicedQuantity>"
        fitxer = fitxer & "<cbc:LineExtensionAmount>" & Replace(FormatNumber(rsData("import"), 2), ",", "") & "</cbc:LineExtensionAmount>"
        fitxer = fitxer & "<cac:DespatchLineReference>"
        fitxer = fitxer & "<cbc:LineID>" & pos & "</cbc:LineID>"
        fitxer = fitxer & "<cac:DocumentReference>"
        fitxer = fitxer & "<cbc:ID>ALB_" & Right("00000000" & rsData("nAlb"), 8) & "</cbc:ID>"
        fitxer = fitxer & "<cbc:IssueDate>" & rsData("data") & "</cbc:IssueDate>"
        fitxer = fitxer & "</cac:DocumentReference>"
        fitxer = fitxer & "</cac:DespatchLineReference>"
        fitxer = fitxer & "<cac:TaxTotal>"
        fitxer = fitxer & "<cbc:TaxAmount currencyID=""EUR"">" & Replace(FormatNumber(rsData("import") * (rsData("iva") / 100), 2), ",", "") & "</cbc:TaxAmount>"
        fitxer = fitxer & "<cac:TaxSubtotal>"
        fitxer = fitxer & "<cbc:TaxableAmount currencyID=""EUR"">" & Replace(FormatNumber(rsData("import"), 2), ",", "") & "</cbc:TaxableAmount>"
        fitxer = fitxer & "<cbc:TaxAmount currencyID=""EUR"">" & Replace(FormatNumber(rsData("import") * (rsData("iva") / 100), 2), ",", "") & "</cbc:TaxAmount>"
        fitxer = fitxer & "<cac:TaxCategory>"
        fitxer = fitxer & "<cbc:Percent>" & Replace(FormatNumber(rsData("iva"), 2), ",", "") & "</cbc:Percent>"
        fitxer = fitxer & "<cac:TaxScheme>"
        fitxer = fitxer & "<cbc:Name>IVA</cbc:Name>"
        fitxer = fitxer & "<cbc:TaxTypeCode>1</cbc:TaxTypeCode>"
        fitxer = fitxer & "</cac:TaxScheme>"
        fitxer = fitxer & "</cac:TaxCategory>"
        fitxer = fitxer & "</cac:TaxSubtotal>"
        fitxer = fitxer & "</cac:TaxTotal>"
        fitxer = fitxer & "<cac:Item>"
        fitxer = fitxer & "<cbc:Description>" & rsData("ProducteNom") & "</cbc:Description>"
        fitxer = fitxer & "<cac:BuyersItemIdentification>"
        fitxer = fitxer & "<cbc:ID>" & rsData("Producte") & "</cbc:ID>"
        fitxer = fitxer & "</cac:BuyersItemIdentification>"
        fitxer = fitxer & "<cac:SellersItemIdentification>"
        fitxer = fitxer & "<cbc:ID>" & rsData("Producte") & "</cbc:ID>"
        fitxer = fitxer & "</cac:SellersItemIdentification>"
        fitxer = fitxer & "<cac:StandardItemIdentification>"
        fitxer = fitxer & "<cbc:ID>" & rsData("EAN") & "</cbc:ID>"
        fitxer = fitxer & "</cac:StandardItemIdentification>"
        fitxer = fitxer & "</cac:Item>"
        fitxer = fitxer & "<cac:Price>"
        fitxer = fitxer & "<cbc:PriceAmount currencyID=""EUR"">" & Replace(FormatNumber(rsData("preu"), 2), ",", "") & "</cbc:PriceAmount>"
        fitxer = fitxer & "</cac:Price>"
        fitxer = fitxer & "</cac:InvoiceLine>"
        pos = pos + 1
        rsData.MoveNext
    Wend
    fitxer = fitxer & "</Invoice>"

    'Write to the steam
    objStream.WriteText fitxer
    
    'Save the stream to a file
    objStream.SaveToFile "c:\" & nomFileTemp
    
    EnviaFTPSerunion nomFileTemp, "facturas/"
    
    Set rsCom = Db.OpenResultset("select * from FacturacioComentaris where IdFactura='" & idFactura & "'")
    If rsCom.EOF Then
        ExecutaComandaSql "insert into FacturacioComentaris values ('" & idFactura & "', '" & dataFactura & "', '[SERUNION]', 'N', null)"
    Else
        ExecutaComandaSql "update FacturacioComentaris set Comentari=isnull(comentari, '') + '[SERUNION]' where IdFactura='" & idFactura & "'"
    End If

    
SERUNION_ERROR:

    MyKill "c:\" & nomFileTemp
    
End Sub
Sub FacturaXML(idFactura As String, numFactura As String, dataFactura As Date)
    Dim fitxer As String
    Dim rs As rdoResultset, rsData As rdoResultset, rsCli As rdoResultset, rsEmp As rdoResultset, rsCom As rdoResultset, sql As String
    Dim nFactura As String, serie As String, nAlb As String, dataAlb As String, empNom As String, empNif As String, empCodi As String, empCodiCamp As String, empIBAN As String
    Dim Total As Double, dataVenciment As Date
    Dim baseIva1 As Double, iva1 As Double, baseIva2 As Double, iva2 As Double, baseIva3 As Double, iva3 As Double, totalImpIVA As Double
    Dim pos As Integer, nomFileTemp As String
    Dim f As Integer
    Dim empAdresa As String, empCp As String, empCiutat As String, empTel As String, empFax As String, empEMail As String, EmpTown As String
    Dim Clicodi As String, clientNom As String, ClientNif As String, clientAdresa As String, clientCp As String, clientTel As String, clientFax As String, clienteMail As String, clientCiutat As String
    
    On Error GoTo XML_ERROR
    
    nomFileTemp = numFactura & ".XML"
   
     Dim objStream As Object
    
     'Create the stream
     Set objStream = CreateObject("ADODB.Stream")
    
     'Initialize the stream
     objStream.Open
    
     'Reset the position and indicate the charactor encoding
     objStream.Position = 0
     objStream.Charset = "UTF-8"

    Set rs = Db.OpenResultset("Select f.* , isnull(upper(c.nom), '') [NomComercial] From [" & NomTaulaFacturaIva(dataFactura) & "] f left join clients c on f.clientcodi=c.codi where idFactura='" & idFactura & "'")
    
    If Not rs.EOF Then
        nFactura = rs("NumFactura")
        serie = rs("Serie")
        If serie <> "" Then nFactura = serie & nFactura
        If rs("NomComercial") <> "" Then nFactura = nFactura & " (" & rs("NomComercial") & ")"
        empNom = rs("EmpNom")
        empNif = rs("EmpNif")
        empCodi = rs("EmpresaCodi")
        empAdresa = rs("EmpAdresa")
        empCp = rs("EmpCP")
        empCiutat = rs("EmpCiutat")
        empTel = rs("EmpTel")
        empFax = rs("EmpFax")
        empEMail = rs("EmpeMail")
        
        clientNom = rs("ClientNom")
        ClientNif = rs("ClientNif")
        clientAdresa = rs("ClientAdresa")
        clientCp = rs("ClientCp")
        clientTel = rs("Tel")
        clientFax = rs("Fax")
        clienteMail = rs("eMail")
        clientCiutat = rs("ClientCiutat")
        
        Clicodi = rs("ClientCodi")
        Total = rs("total")
        'dataVenciment = rs("dataVenciment")
        dataVenciment = Year(dataFactura) & "-" & Right("00" & Month(dataFactura), 2) & "-" & Right("00" & Day(dataFactura), 2)
        
        baseIva1 = rs("BaseIva1")
        iva1 = rs("Iva1")
   
        'baseIva2 = Rs("BaseIva2") + Rs("BaseIva4") 'IBEE : BaseIva4
        'iva2 = Rs("Iva2") + Rs("Iva4")
        
        baseIva2 = rs("BaseIva2")
        iva2 = rs("Iva2")
  
        sql = "select sum( "
        sql = sql & "case when isnumeric(SUBSTRING(referencia, charindex('IBEE', referencia)+5, charindex(']', referencia, charindex('IBEE', referencia))-len('[IBEE:')-1))=1 then "
        sql = sql & "SUBSTRING(referencia, charindex('IBEE', referencia)+5, charindex(']', referencia, charindex('IBEE', referencia))-len('[IBEE:')-1)*(servit-tornat) else 0 end) IBEE "
        sql = sql & "from [" & NomTaulaFacturaData(dataFactura) & "] where idfactura='" & idFactura & "' and referencia like '%IBEE:%' "
        Set rsData = Db.OpenResultset(sql)
        If Not rsData.EOF Then
            If rsData("IBEE") <> 0 Then
                baseIva2 = baseIva2 + rsData("IBEE")
                iva2 = iva2 + (rsData("IBEE") * 0.1)
            End If
        End If
  
        baseIva3 = rs("BaseIva3")
        iva3 = rs("Iva3")
  
        sql = "select isnull(substring(referencia,charindex('IdAlbara:',referencia)+9,charindex(']',referencia,charindex('IdAlbara:',referencia)+9)-charindex('IdAlbara:',referencia)-9),'') nAlb, "
        sql = sql & "isnull(substring(referencia,charindex('Data:',referencia)+5,charindex(']',referencia,charindex('Data:',referencia)+5)-charindex('Data:',referencia)-5),'') data "
        sql = sql & "From [" & NomTaulaFacturaData(dataFactura) & "] "
        sql = sql & "where idfactura='" & idFactura & "' and referencia like '%IdAlbara:%' and referencia like '%Data:%'"
        Set rsData = Db.OpenResultset(sql)
        If Not rsData.EOF Then
            nAlb = rsData("nAlb")
            dataAlb = rsData("data")
        End If
        
        empCodiCamp = ""
        If empCodi <> "0" Then empCodiCamp = empCodi & "_"
        Set rsEmp = Db.OpenResultset("select * from constantsempresa where camp = '" & empCodiCamp & "CampCompteCorrent'")
        If Not rsEmp.EOF Then empIBAN = rsEmp("Valor")
    End If
    
    
    'fitxer = "<?xml version=""1.0"" encoding=""ISO-8859-1""?>"
    'fitxer = "<?xml version=""1.0"" encoding=""UTF-8""?>" & Chr(13)
    fitxer = "<m:Facturae xmlns:m=""http://www.facturae.es/Facturae/2009/v3.2/Facturae"" xmlns:ds=""http://www.w3.org/2000/09/xmldsig#"" xmlns:xsi=""http://www.w3.org/2001/XMLSchema-instance"">" & Chr(13)
    
    fitxer = fitxer & "<FileHeader>" & Chr(13)
    fitxer = fitxer & "<SchemaVersion>3.2</SchemaVersion>" & Chr(13)
    fitxer = fitxer & "<Modality>I</Modality>" & Chr(13)
    fitxer = fitxer & "<InvoiceIssuerType>EM</InvoiceIssuerType>" & Chr(13)
    fitxer = fitxer & "<Batch>" & Chr(13)
    fitxer = fitxer & "<BatchIdentifier>" & nFactura & "</BatchIdentifier>" & Chr(13)
    fitxer = fitxer & "<InvoicesCount>1</InvoicesCount>" & Chr(13)
    fitxer = fitxer & "<TotalInvoicesAmount>" & Chr(13)
    fitxer = fitxer & "<TotalAmount>" & Replace(FormatNumber(Total, 2), ",", "") & "</TotalAmount>" & Chr(13)
    fitxer = fitxer & "<EquivalentInEuros>0.00</EquivalentInEuros>" & Chr(13)
    fitxer = fitxer & "</TotalInvoicesAmount>" & Chr(13)
    fitxer = fitxer & "<TotalOutstandingAmount>" & Chr(13)
    fitxer = fitxer & "<TotalAmount>" & Replace(FormatNumber(Total, 2), ",", "") & "</TotalAmount>" & Chr(13)
    fitxer = fitxer & "<EquivalentInEuros>0.00</EquivalentInEuros>" & Chr(13)
    fitxer = fitxer & "</TotalOutstandingAmount>" & Chr(13)
    fitxer = fitxer & "<TotalExecutableAmount>" & Chr(13)
    fitxer = fitxer & "<TotalAmount>" & Replace(FormatNumber(Total, 2), ",", "") & "</TotalAmount>" & Chr(13)
    fitxer = fitxer & "<EquivalentInEuros>0.00</EquivalentInEuros>" & Chr(13)
    fitxer = fitxer & "</TotalExecutableAmount>" & Chr(13)
    fitxer = fitxer & "<InvoiceCurrencyCode>EUR</InvoiceCurrencyCode>" & Chr(13)
    fitxer = fitxer & "</Batch>" & Chr(13)
    fitxer = fitxer & "</FileHeader>" & Chr(13)
    
    fitxer = fitxer & "<Parties>" & Chr(13)
    fitxer = fitxer & "<SellerParty>" & Chr(13)
    fitxer = fitxer & "<TaxIdentification>" & Chr(13)
    fitxer = fitxer & "<PersonTypeCode>J</PersonTypeCode>" & Chr(13)
    fitxer = fitxer & "<ResidenceTypeCode>R</ResidenceTypeCode>" & Chr(13)
    fitxer = fitxer & "<TaxIdentificationNumber>" & empNif & "</TaxIdentificationNumber>" & Chr(13)
    fitxer = fitxer & "</TaxIdentification>" & Chr(13)
    fitxer = fitxer & "<LegalEntity>" & Chr(13)
    fitxer = fitxer & "<CorporateName>" & empNom & "</CorporateName>" & Chr(13)
    fitxer = fitxer & "<TradeName>" & empNom & "</TradeName>" & Chr(13)
    'fitxer = fitxer & "<RegistrationData>" & Chr(13)
    'fitxer = fitxer & "<Book>28723</Book>"
    'fitxer = fitxer & "<RegisterOfCompaniesLocation>Barcelona</RegisterOfCompaniesLocation>"
    'fitxer = fitxer & "<Sheet>139874</Sheet>"
    'fitxer = fitxer & "<Folio>123</Folio>"
    'fitxer = fitxer & "</RegistrationData>"
    fitxer = fitxer & "<AddressInSpain>" & Chr(13)
    fitxer = fitxer & "<Address>" & empAdresa & "</Address>" & Chr(13)
    fitxer = fitxer & "<PostCode>" & empCp & "</PostCode>" & Chr(13)
    If InStr(empCiutat, ",") Then
        EmpTown = Trim(Split(empCiutat, ",")(0))
        fitxer = fitxer & "<Town>" & Trim(Split(empCiutat, ",")(0)) & "</Town>" & Chr(13)
        fitxer = fitxer & "<Province>" & Trim(Split(empCiutat, ",")(1)) & "</Province>" & Chr(13)
    Else
        EmpTown = empCiutat
        fitxer = fitxer & "<Town>" & empCiutat & "</Town>" & Chr(13)
        fitxer = fitxer & "<Province>BARCELONA</Province>" & Chr(13)
    End If
    fitxer = fitxer & "<CountryCode>ESP</CountryCode>" & Chr(13)
    fitxer = fitxer & "</AddressInSpain>" & Chr(13)
    If empTel <> "" Or empFax <> "" Or empEMail <> "" Then
        fitxer = fitxer & "<ContactDetails>" & Chr(13)
        If empTel <> "" Then fitxer = fitxer & "<Telephone>" & empTel & "</Telephone>" & Chr(13)
        If empFax <> "" Then fitxer = fitxer & "<TeleFax>" & empFax & "</TeleFax>" & Chr(13)
        If empEMail <> "" Then fitxer = fitxer & "<ElectronicMail>" & empEMail & "</ElectronicMail>" & Chr(13)
        'fitxer = fitxer & "<INETownCode>08022</INETownCode>"
        fitxer = fitxer & "</ContactDetails>" & Chr(13)
    End If
    fitxer = fitxer & "</LegalEntity>" & Chr(13)
    fitxer = fitxer & "</SellerParty>" & Chr(13)
          
    fitxer = fitxer & "<BuyerParty>" & Chr(13)
    fitxer = fitxer & "<TaxIdentification>" & Chr(13)
    fitxer = fitxer & "<PersonTypeCode>J</PersonTypeCode>" & Chr(13)
    fitxer = fitxer & "<ResidenceTypeCode>R</ResidenceTypeCode>" & Chr(13)
    fitxer = fitxer & "<TaxIdentificationNumber>" & ClientNif & "</TaxIdentificationNumber>" & Chr(13)
    fitxer = fitxer & "</TaxIdentification>" & Chr(13)
    fitxer = fitxer & "<LegalEntity>" & Chr(13)
    fitxer = fitxer & "<CorporateName>" & clientNom & "</CorporateName>" & Chr(13)
    fitxer = fitxer & "<TradeName>" & clientNom & "</TradeName>" & Chr(13)
    fitxer = fitxer & "<AddressInSpain>" & Chr(13)
    fitxer = fitxer & "<Address>" & clientAdresa & "</Address>" & Chr(13)
    fitxer = fitxer & "<PostCode>" & clientCp & "</PostCode>" & Chr(13)
    If InStr(clientCiutat, ",") Then
        fitxer = fitxer & "<Town>" & Trim(Split(clientCiutat, ",")(0)) & "</Town>" & Chr(13)
        fitxer = fitxer & "<Province>" & Trim(Split(clientCiutat, ",")(1)) & "</Province>" & Chr(13)
    Else
        fitxer = fitxer & "<Town>" & clientCiutat & "</Town>" & Chr(13)
        fitxer = fitxer & "<Province>BARCELONA</Province>" & Chr(13)
    End If
    fitxer = fitxer & "<CountryCode>ESP</CountryCode>" & Chr(13)
    fitxer = fitxer & "</AddressInSpain>" & Chr(13)
    If clientTel <> "" Or clienteMail <> "" Then
        fitxer = fitxer & "<ContactDetails>"
        If clientTel <> "" Then fitxer = fitxer & "<Telephone>" & clientTel & "</Telephone>" & Chr(13)
        If clienteMail <> "" Then fitxer = fitxer & "<ElectronicMail>" & clienteMail & "</ElectronicMail>" & Chr(13)
        fitxer = fitxer & "</ContactDetails>" & Chr(13)
    End If
    fitxer = fitxer & "</LegalEntity>" & Chr(13)
    fitxer = fitxer & "</BuyerParty>" & Chr(13)
    fitxer = fitxer & "</Parties>" & Chr(13)
   
    fitxer = fitxer & "<Invoices>" & Chr(13)
    fitxer = fitxer & "<Invoice>" & Chr(13)
    fitxer = fitxer & "<InvoiceHeader>" & Chr(13)
    fitxer = fitxer & "<InvoiceNumber>" & nFactura & "</InvoiceNumber>" & Chr(13)
    'fitxer = fitxer & "<InvoiceSeriesCode></InvoiceSeriesCode>"
    fitxer = fitxer & "<InvoiceDocumentType>FC</InvoiceDocumentType>" & Chr(13)
    fitxer = fitxer & "<InvoiceClass>OO</InvoiceClass>" & Chr(13)
    fitxer = fitxer & "</InvoiceHeader>" & Chr(13)
    fitxer = fitxer & "<InvoiceIssueData>" & Chr(13)
    fitxer = fitxer & "<IssueDate>" & Year(dataFactura) & "-" & Right("00" & Month(dataFactura), 2) & "-" & Right("00" & Day(dataFactura), 2) & "</IssueDate>" & Chr(13)
    fitxer = fitxer & "<OperationDate>" & Year(dataFactura) & "-" & Right("00" & Month(dataFactura), 2) & "-" & Right("00" & Day(dataFactura), 2) & "</OperationDate>" & Chr(13)
    fitxer = fitxer & "<PlaceOfIssue>" & Chr(13)
    fitxer = fitxer & "<PostCode>" & empCp & "</PostCode>" & Chr(13)
    fitxer = fitxer & "<PlaceOfIssueDescription>" & EmpTown & "</PlaceOfIssueDescription>" & Chr(13)
    fitxer = fitxer & "</PlaceOfIssue>" & Chr(13)
    fitxer = fitxer & "<InvoiceCurrencyCode>EUR</InvoiceCurrencyCode>" & Chr(13)
    fitxer = fitxer & "<TaxCurrencyCode>EUR</TaxCurrencyCode>" & Chr(13)
    fitxer = fitxer & "<LanguageName>es</LanguageName>" & Chr(13)
    fitxer = fitxer & "</InvoiceIssueData>" & Chr(13)
    fitxer = fitxer & "<TaxesOutputs>" & Chr(13)
    If iva1 > 0 Then
        fitxer = fitxer & "<Tax>" & Chr(13)
        fitxer = fitxer & "<TaxTypeCode>01</TaxTypeCode>" & Chr(13)
        fitxer = fitxer & "<TaxRate>4.00</TaxRate>" & Chr(13)
        fitxer = fitxer & "<TaxableBase>" & Chr(13)
        fitxer = fitxer & "<TotalAmount>" & Replace(FormatNumber(baseIva1, 2), ",", "") & "</TotalAmount>" & Chr(13)
        fitxer = fitxer & "</TaxableBase>" & Chr(13)
        fitxer = fitxer & "<TaxAmount>" & Chr(13)
        fitxer = fitxer & "<TotalAmount>" & Replace(FormatNumber(iva1, 2), ",", "") & "</TotalAmount>" & Chr(13)
        fitxer = fitxer & "</TaxAmount>" & Chr(13)
        fitxer = fitxer & "</Tax>" & Chr(13)
    End If
    If iva2 > 0 Then
        fitxer = fitxer & "<Tax>" & Chr(13)
        fitxer = fitxer & "<TaxTypeCode>01</TaxTypeCode>" & Chr(13)
        fitxer = fitxer & "<TaxRate>10.00</TaxRate>" & Chr(13)
        fitxer = fitxer & "<TaxableBase>" & Chr(13)
        fitxer = fitxer & "<TotalAmount>" & Replace(FormatNumber(baseIva2, 2), ",", "") & "</TotalAmount>" & Chr(13)
        fitxer = fitxer & "</TaxableBase>" & Chr(13)
        fitxer = fitxer & "<TaxAmount>" & Chr(13)
        fitxer = fitxer & "<TotalAmount>" & Replace(FormatNumber(iva2, 2), ",", "") & "</TotalAmount>" & Chr(13)
        fitxer = fitxer & "</TaxAmount>" & Chr(13)
        fitxer = fitxer & "</Tax>" & Chr(13)
    End If
    If iva3 > 0 Then
        fitxer = fitxer & "<Tax>" & Chr(13)
        fitxer = fitxer & "<TaxTypeCode>01</TaxTypeCode>" & Chr(13)
        fitxer = fitxer & "<TaxRate>21.00</TaxRate>" & Chr(13)
        fitxer = fitxer & "<TaxableBase>" & Chr(13)
        fitxer = fitxer & "<TotalAmount>" & Replace(FormatNumber(baseIva3, 2), ",", "") & "</TotalAmount>" & Chr(13)
        fitxer = fitxer & "</TaxableBase>" & Chr(13)
        fitxer = fitxer & "<TaxAmount>" & Chr(13)
        fitxer = fitxer & "<TotalAmount>" & Replace(FormatNumber(iva3, 2), ",", "") & "</TotalAmount>" & Chr(13)
        fitxer = fitxer & "</TaxAmount>" & Chr(13)
        fitxer = fitxer & "</Tax>" & Chr(13)
    End If
    fitxer = fitxer & "</TaxesOutputs>" & Chr(13)
               
    fitxer = fitxer & "<InvoiceTotals>" & Chr(13)
    fitxer = fitxer & "<TotalGrossAmount>" & Replace(FormatNumber(baseIva1 + baseIva2 + baseIva3, 2), ",", "") & "</TotalGrossAmount>" & Chr(13)
    fitxer = fitxer & "<TotalGeneralDiscounts>0.00</TotalGeneralDiscounts>" & Chr(13)
    fitxer = fitxer & "<TotalGeneralSurcharges>0.00</TotalGeneralSurcharges>" & Chr(13)
    fitxer = fitxer & "<TotalGrossAmountBeforeTaxes>" & Replace(FormatNumber(baseIva1 + baseIva2 + baseIva3, 2), ",", "") & "</TotalGrossAmountBeforeTaxes>" & Chr(13)
    fitxer = fitxer & "<TotalTaxOutputs>" & Replace(FormatNumber(iva1 + iva2 + iva3, 2), ",", "") & "</TotalTaxOutputs>" & Chr(13)
    fitxer = fitxer & "<TotalTaxesWithheld>0.00</TotalTaxesWithheld>" & Chr(13)
    fitxer = fitxer & "<InvoiceTotal>" & Replace(FormatNumber(Total, 2), ",", "") & "</InvoiceTotal>" & Chr(13)
    fitxer = fitxer & "<TotalOutstandingAmount>" & Replace(FormatNumber(Total, 2), ",", "") & "</TotalOutstandingAmount>" & Chr(13)
    fitxer = fitxer & "<TotalPaymentsOnAccount>0.00</TotalPaymentsOnAccount>" & Chr(13)
    fitxer = fitxer & "<TotalExecutableAmount>" & Replace(FormatNumber(Total, 2), ",", "") & "</TotalExecutableAmount>" & Chr(13)
    fitxer = fitxer & "</InvoiceTotals>" & Chr(13)
               
    fitxer = fitxer & "<Items>" & Chr(13)
               
    pos = 1
    
    sql = "select case "
    sql = sql & "when charindex('IdAlbara:',referencia) = 0 then '' "
    sql = sql & "when charindex('IdAlbara:',referencia) > 0 then "
    sql = sql & "isnull(substring(referencia,charindex('IdAlbara:',referencia)+9,charindex(']',referencia,charindex('IdAlbara:',referencia)+9)-charindex('IdAlbara:',referencia)-9),'') "
    sql = sql & "end nAlb, "
    'sql = sql & "case "
    'sql = sql & "when charindex('Data:',referencia) = 0 then '' "
    'sql = sql & "when charindex('Data:',referencia) > 0 then "
    'sql = sql & "isnull(substring(referencia,charindex('Data:',referencia)+5,charindex(']',referencia,charindex('Data:',referencia)+5)-charindex('Data:',referencia)-5),'') "
    'sql = sql & "end Data, "
    sql = sql & "isnull((select top 1 codi from codisbarres where Producte=f.producte), '') EAN, data, Servit, Tornat, isnull(ProducteNom, '') ProducteNom, isnull(preu, 0) preu, "
    sql = sql & "isnull(desconte, 0) desconte, iva, isnull(import, 0) import, Producte "
    sql = sql & "From [" & NomTaulaFacturaData(dataFactura) & "] f "
    sql = sql & "where idfactura='" & idFactura & "' "
    sql = sql & "order by nAlb "
    Set rsData = Db.OpenResultset(sql)
    While Not rsData.EOF
        fitxer = fitxer & "<InvoiceLine>" & Chr(13)
        fitxer = fitxer & "<IssuerContractReference>ALB_" & Right("00000000" & rsData("nAlb"), 8) & "</IssuerContractReference>" & Chr(13)
        fitxer = fitxer & "<SequenceNumber>" & pos * 10 & "</SequenceNumber>" & Chr(13)
        fitxer = fitxer & "<DeliveryNotesReferences>" & Chr(13)
        fitxer = fitxer & "<DeliveryNote>" & Chr(13)
        fitxer = fitxer & "<DeliveryNoteNumber>ALB_" & Right("00000000" & rsData("nAlb"), 8) & "</DeliveryNoteNumber>" & Chr(13)
        fitxer = fitxer & "<DeliveryNoteDate>" & rsData("data") & "</DeliveryNoteDate>" & Chr(13)
        fitxer = fitxer & "</DeliveryNote>" & Chr(13)
        fitxer = fitxer & "</DeliveryNotesReferences>" & Chr(13)
        fitxer = fitxer & "<ItemDescription>" & Replace(rsData("ProducteNom"), "&", "") & "</ItemDescription>" & Chr(13)
        fitxer = fitxer & "<Quantity>" & Replace(FormatNumber(rsData("Servit") - rsData("Tornat"), 3), ",", "") & "</Quantity>" & Chr(13)
        fitxer = fitxer & "<UnitOfMeasure>01</UnitOfMeasure>" & Chr(13)
        fitxer = fitxer & "<UnitPriceWithoutTax>" & Replace(FormatNumber(rsData("preu"), 5), ",", "") & "</UnitPriceWithoutTax>" & Chr(13)
        fitxer = fitxer & "<TotalCost>" & Replace(FormatNumber(rsData("preu"), 5), ",", "") & "</TotalCost>" & Chr(13)
        fitxer = fitxer & "<GrossAmount>" & Replace(FormatNumber(rsData("preu") - (rsData("preu") * (rsData("desconte") / 100)), 5), ",", "") & "</GrossAmount>" & Chr(13)
        fitxer = fitxer & "<TaxesOutputs>" & Chr(13)
        fitxer = fitxer & "<Tax>" & Chr(13)
        fitxer = fitxer & "<TaxTypeCode>01</TaxTypeCode>" & Chr(13)
        fitxer = fitxer & "<TaxRate>" & Replace(FormatNumber(rsData("iva"), 2), ",", "") & "</TaxRate>" & Chr(13)
        fitxer = fitxer & "<TaxableBase>" & Chr(13)
        fitxer = fitxer & "<TotalAmount>" & Replace(FormatNumber(rsData("import"), 2), ",", "") & "</TotalAmount>" & Chr(13)
        fitxer = fitxer & "<EquivalentInEuros>0.00</EquivalentInEuros>" & Chr(13)
        fitxer = fitxer & "</TaxableBase>" & Chr(13)
        fitxer = fitxer & "<TaxAmount>" & Chr(13)
        fitxer = fitxer & "<TotalAmount>" & Replace(FormatNumber(rsData("import") * (rsData("iva") / 100), 2), ",", "") & "</TotalAmount>" & Chr(13)
        fitxer = fitxer & "<EquivalentInEuros>0.00</EquivalentInEuros>" & Chr(13)
        fitxer = fitxer & "</TaxAmount>" & Chr(13)
        fitxer = fitxer & "</Tax>" & Chr(13)
        fitxer = fitxer & "</TaxesOutputs>" & Chr(13)
        fitxer = fitxer & "<TransactionDate>" & rsData("data") & "</TransactionDate>" & Chr(13)
        'fitxer = fitxer & "<AdditionalLineItemInformation>USB/RS-232. 250mm/segon</AdditionalLineItemInformation>"
        fitxer = fitxer & "<ArticleCode>" & rsData("Producte") & "</ArticleCode>" & Chr(13)
        fitxer = fitxer & "</InvoiceLine>" & Chr(13)
        
        pos = pos + 1
        rsData.MoveNext
    Wend
    
    'IBEE
    sql = "select sum( "
    sql = sql & "case when isnumeric(SUBSTRING(referencia, charindex('IBEE', referencia)+5, charindex(']', referencia, charindex('IBEE', referencia))-len('[IBEE:')-1))=1 then "
    sql = sql & "SUBSTRING(referencia, charindex('IBEE', referencia)+5, charindex(']', referencia, charindex('IBEE', referencia))-len('[IBEE:')-1)*(servit-tornat) else 0 end) IBEE "
    sql = sql & "from [" & NomTaulaFacturaData(dataFactura) & "] where idfactura='" & idFactura & "' and referencia like '%IBEE:%' "
    Set rsData = Db.OpenResultset(sql)
    If Not rsData.EOF Then
        fitxer = fitxer & "<InvoiceLine>" & Chr(13)
        fitxer = fitxer & "<IssuerContractReference>ALB_" & "0000IBEE" & "</IssuerContractReference>" & Chr(13)
        fitxer = fitxer & "<SequenceNumber>" & pos * 10 & "</SequenceNumber>" & Chr(13)
        fitxer = fitxer & "<DeliveryNotesReferences>" & Chr(13)
        fitxer = fitxer & "<DeliveryNote>" & Chr(13)
        fitxer = fitxer & "<DeliveryNoteNumber>ALB_" & "0000IBEE" & "</DeliveryNoteNumber>" & Chr(13)
        fitxer = fitxer & "<DeliveryNoteDate>" & dataFactura & "</DeliveryNoteDate>" & Chr(13)
        fitxer = fitxer & "</DeliveryNote>" & Chr(13)
        fitxer = fitxer & "</DeliveryNotesReferences>" & Chr(13)
        fitxer = fitxer & "<ItemDescription>IBEE</ItemDescription>" & Chr(13)
        fitxer = fitxer & "<Quantity>1</Quantity>" & Chr(13)
        fitxer = fitxer & "<UnitOfMeasure>01</UnitOfMeasure>" & Chr(13)
        fitxer = fitxer & "<UnitPriceWithoutTax>" & Replace(FormatNumber(rsData("IBEE"), 5), ",", "") & "</UnitPriceWithoutTax>" & Chr(13)
        fitxer = fitxer & "<TotalCost>" & Replace(FormatNumber(rsData("IBEE"), 5), ",", "") & "</TotalCost>" & Chr(13)
        fitxer = fitxer & "<GrossAmount>" & Replace(FormatNumber(rsData("IBEE"), 5), ",", "") & "</GrossAmount>" & Chr(13)
        fitxer = fitxer & "<TaxesOutputs>" & Chr(13)
        fitxer = fitxer & "<Tax>" & Chr(13)
        fitxer = fitxer & "<TaxTypeCode>01</TaxTypeCode>" & Chr(13)
        fitxer = fitxer & "<TaxRate>10</TaxRate>" & Chr(13)
        fitxer = fitxer & "<TaxableBase>" & Chr(13)
        fitxer = fitxer & "<TotalAmount>" & Replace(FormatNumber(rsData("IBEE"), 2), ",", "") & "</TotalAmount>" & Chr(13)
        fitxer = fitxer & "<EquivalentInEuros>0.00</EquivalentInEuros>" & Chr(13)
        fitxer = fitxer & "</TaxableBase>" & Chr(13)
        fitxer = fitxer & "<TaxAmount>" & Chr(13)
        fitxer = fitxer & "<TotalAmount>" & Replace(FormatNumber(rsData("IBEE") * (10 / 100), 2), ",", "") & "</TotalAmount>" & Chr(13)
        fitxer = fitxer & "<EquivalentInEuros>0.00</EquivalentInEuros>" & Chr(13)
        fitxer = fitxer & "</TaxAmount>" & Chr(13)
        fitxer = fitxer & "</Tax>" & Chr(13)
        fitxer = fitxer & "</TaxesOutputs>" & Chr(13)
        fitxer = fitxer & "<TransactionDate>" & dataFactura & "</TransactionDate>" & Chr(13)
        'fitxer = fitxer & "<AdditionalLineItemInformation>USB/RS-232. 250mm/segon</AdditionalLineItemInformation>"
        fitxer = fitxer & "<ArticleCode>000</ArticleCode>" & Chr(13)
        fitxer = fitxer & "</InvoiceLine>" & Chr(13)
    End If
    
    fitxer = fitxer & "</Items>" & Chr(13)
                                  
    fitxer = fitxer & "<PaymentDetails>" & Chr(13)
    fitxer = fitxer & "<Installment>" & Chr(13)
    fitxer = fitxer & "<InstallmentDueDate>" & Year(dataVenciment) & "-" & Right("00" & Month(dataVenciment), 2) & "-" & Right("00" & Day(dataVenciment), 2) & "</InstallmentDueDate>" & Chr(13)
    fitxer = fitxer & "<InstallmentAmount>" & Replace(FormatNumber(Total, 2), ",", "") & "</InstallmentAmount>" & Chr(13)
    fitxer = fitxer & "<PaymentMeans>04</PaymentMeans>" & Chr(13)
    fitxer = fitxer & "<AccountToBeCredited>" & Chr(13)
    fitxer = fitxer & "<IBAN>" & empIBAN & "</IBAN>" & Chr(13)
    'fitxer = fitxer & "<BankCode>0075</BankCode>"
    'fitxer = fitxer & "<BranchCode>0034</BranchCode>"
    'fitxer = fitxer & "<BranchInSpainAddress>"
    'fitxer = fitxer & "<Address> Pl. DE LA CREU  10     </Address>"
    'fitxer = fitxer & "<PostCode>08600</PostCode>"
    'fitxer = fitxer & "<Town>BERGA</Town>"
    'fitxer = fitxer & "<Province>BARCELONA</Province>"
    'fitxer = fitxer & "<CountryCode>ESP</CountryCode>"
    'fitxer = fitxer & "</BranchInSpainAddress>"
    fitxer = fitxer & "</AccountToBeCredited>" & Chr(13)
    fitxer = fitxer & "</Installment>" & Chr(13)
    fitxer = fitxer & "</PaymentDetails>" & Chr(13)
    fitxer = fitxer & "</Invoice>" & Chr(13)
    fitxer = fitxer & "</Invoices>" & Chr(13)

    fitxer = fitxer & "</m:Facturae>" & Chr(13)

    'Write to the steam
    objStream.WriteText fitxer
    
    'Save the stream to a file
    objStream.SaveToFile "c:\" & nomFileTemp
    
    
XML_ERROR:
    'fitxer = fitxer
    'MyKill "c:\" & nomFileTemp
    
End Sub



Sub AlbaranSERUNION(nAlbaran As String, dataAlbaran As Date)
    Dim fitxer As String
    Dim rs As rdoResultset, rsData As rdoResultset, rsCli As rdoResultset, rsEmp As rdoResultset, sql As String
    Dim empNom As String, empNif As String, empCodi As String, Viatge As String, EAN As String
    Dim Clicodi As String, CliNif As String, CliNom As String, cliNomComercial As String, CliAdresa As String, CliCp As String, CliCiutat As String, cliProvincia As String, serunion_po As String

    Dim pos As Integer, nomFileTemp As String
    Dim f As Integer
    
    On Error GoTo SERUNION_ERROR
    
    nomFileTemp = "UBL_SP_DESADV_" & Format(Now, "yyyymmdd") & "_" & Format(Now, "hhnnss") & "000.xml"
        
    Dim objStream As Object
    
    'Create the stream
    Set objStream = CreateObject("ADODB.Stream")
    
    'Initialize the stream
    objStream.Open
    
    'Reset the position and indicate the charactor encoding
    objStream.Position = 0
    objStream.Charset = "UTF-8"

    Set rs = Db.OpenResultset("Select * From [AlbaransNum_" & Year(dataAlbaran) & "] f where codi='" & nAlbaran & "'")
    
    If Not rs.EOF Then
        Clicodi = rs("Client")
        Viatge = rs("Viatge")

        Set rsEmp = Db.OpenResultset("select * from constantsempresa where camp = 'CampNom'")
        If Not rsEmp.EOF Then empNom = rsEmp("Valor")
        Set rsEmp = Db.OpenResultset("select * from constantsempresa where camp = 'CampNif'")
        If Not rsEmp.EOF Then empNif = rsEmp("Valor")
  
        sql = "select nom nomComercial, [nom llarg] nomFiscal, adresa, isnull(cc1.valor, '') provincia, c.cp, c.ciutat, c.nif, ISNULL(cc2.valor, '') serunion_po, ISNULL(cc3.valor, '') IBAN "
        sql = sql & "from clients c "
        sql = sql & "left join constantsClient cc1 on c.codi=cc1.codi and cc1.variable='PROVINCIA' "
        sql = sql & "left join constantsClient cc2 on c.codi=cc2.codi and cc2.variable='SERUNION_PO' "
        sql = sql & "left join constantsClient cc3 on c.codi=cc3.codi and cc3.variable='CompteCorrent' "
        sql = sql & "Where c.Codi = " & Clicodi
        Set rsCli = Db.OpenResultset(sql)
        If Not rsCli.EOF Then
            CliNom = rsCli("nomFiscal")
            cliNomComercial = rsCli("NomComercial")
            CliAdresa = rsCli("Adresa")
            CliCp = rsCli("cp")
            CliCiutat = rsCli("ciutat")
            cliProvincia = rsCli("provincia")
            CliNif = rsCli("nif")
            serunion_po = rsCli("serunion_po")
        End If
    End If
    
    fitxer = "<?xml version=""1.0"" encoding=""UTF-8""?>"
    fitxer = fitxer & "<DespatchAdvice xmlns=""urn:oasis:names:specification:ubl:schema:xsd:DespatchAdvice-2"" "
    fitxer = fitxer & "xmlns:cac=""urn:oasis:names:specification:ubl:schema:xsd:CommonAggregateComponents-2"" "
    fitxer = fitxer & "xmlns:cbc=""urn:oasis:names:specification:ubl:schema:xsd:CommonBasicComponents-2""> "
    
    fitxer = fitxer & "<cbc:UBLVersionID>2.1</cbc:UBLVersionID> "
    fitxer = fitxer & "<cbc:ID>ALB_" & Right("00000000" & nAlbaran, 8) & "</cbc:ID> "
    fitxer = fitxer & "<cbc:IssueDate>" & Year(dataAlbaran) & "-" & Right("00" & Month(dataAlbaran), 2) & "-" & Right("00" & Day(dataAlbaran), 2) & "</cbc:IssueDate>"
    fitxer = fitxer & "<cbc:Note>" & cliNomComercial & "</cbc:Note>"
    
    fitxer = fitxer & "<cac:OrderReference>"
    fitxer = fitxer & "<cbc:ID>" & nAlbaran & "</cbc:ID>"
    fitxer = fitxer & "<cbc:IssueDate>" & Year(dataAlbaran) & "-" & Right("00" & Month(dataAlbaran), 2) & "-" & Right("00" & Day(dataAlbaran), 2) & "</cbc:IssueDate>"
    fitxer = fitxer & "</cac:OrderReference>"
    
    fitxer = fitxer & "<cac:DespatchSupplierParty>"
    fitxer = fitxer & "<cac:Party>"
    fitxer = fitxer & "<cac:PartyIdentification>"
    fitxer = fitxer & "<cac:ID identificationSchemeName=""CIF/NIF"">" & empNif & "</cac:ID>"
    fitxer = fitxer & "</cac:PartyIdentification>"
    fitxer = fitxer & "<cac:PartyName>"
    fitxer = fitxer & "<cbc:Name>" & empNom & "</cbc:Name>"
    fitxer = fitxer & "</cac:PartyName>"
    fitxer = fitxer & "</cac:Party>"
    fitxer = fitxer & "</cac:DespatchSupplierParty>"
    
    fitxer = fitxer & "<cac:DeliveryCustomerParty>"
    fitxer = fitxer & "<cac:Party>"
    fitxer = fitxer & "<cac:PartyIdentification>"
    fitxer = fitxer & "<cbc:ID identificationSchemeName=""CIF/NIF"">" & CliNif & "</cbc:ID>"
    fitxer = fitxer & "</cac:PartyIdentification>"
    fitxer = fitxer & "<cac:PartyName>"
    fitxer = fitxer & "<cbc:Name>" & CliNom & "</cbc:Name>"
    fitxer = fitxer & "</cac:PartyName>"
    fitxer = fitxer & "</cac:Party>"
    fitxer = fitxer & "</cac:DeliveryCustomerParty>"

    fitxer = fitxer & "<cac:Shipment>"
    fitxer = fitxer & "<cac:Delivery>"
    fitxer = fitxer & "<cac:DeliveryAddress>"
    fitxer = fitxer & "<cbc:StreetName>" & CliAdresa & "</cbc:StreetName>"
    fitxer = fitxer & "<cbc:CityName>" & CliCiutat & "</cbc:CityName>"
    fitxer = fitxer & "<cbc:PostalZone>" & CliCp & "</cbc:PostalZone>"
    fitxer = fitxer & "<cbc:Region>" & cliProvincia & "</cbc:Region>"
    fitxer = fitxer & "<cac:Country>"
    fitxer = fitxer & "<cbc:IdentificationCode>ES</cbc:IdentificationCode>"
    fitxer = fitxer & "<cbc:Name>España</cbc:Name>"
    fitxer = fitxer & "</cac:Country>"
    fitxer = fitxer & "</cac:DeliveryAddress>"
    fitxer = fitxer & "<cac:DeliveryLocation>"
    fitxer = fitxer & "<cbc:ID identificationSchemeName=""GLN"">" & serunion_po & "</cbc:ID>"
    fitxer = fitxer & "<cbc:Name>" & cliNomComercial & "</cbc:Name>"
    fitxer = fitxer & "</cac:DeliveryLocation>"
    fitxer = fitxer & "</cac:Delivery>"
    fitxer = fitxer & "</cac:Shipment>"

    pos = 1
    
    sql = "select "
    sql = sql & "case "
    sql = sql & "when charindex('Lote:',s.comentari) = 0 then '' "
    sql = sql & "when charindex('Lote:',s.comentari) > 0 then "
    sql = sql & "isnull(substring(s.comentari,charindex('Lote:',s.comentari)+5,charindex(']',s.comentari,charindex('Lote:',s.comentari)+5)-charindex('Lote:',s.comentari)-5),'') "
    sql = sql & "end nLote, s.*, a.nom ProducteNom, a.preu, isnull(c.codi, '') as EAN "
    sql = sql & "from [" & DonamNomTaulaServit(dataAlbaran) & "] s "
    sql = sql & "left join articles a on s.CodiArticle = a.codi "
    sql = sql & "left join codisBarres c on s.CodiArticle=c.producte "
    sql = sql & "where s.comentari like '%IdAlbara:" & nAlbaran & "%' "
    Set rsData = Db.OpenResultset(sql)

    While Not rsData.EOF
        fitxer = fitxer & "<cac:DespatchLine>"
        fitxer = fitxer & "<cbc:ID>" & pos * 10 & "</cbc:ID>"
        fitxer = fitxer & "<cbc:DeliveredQuantity unitCode=""UNIDAD"">" & Replace(FormatNumber(rsData("QuantitatServida"), 3), ",", "") & "</cbc:DeliveredQuantity>"
        fitxer = fitxer & "<cac:Item>"
        fitxer = fitxer & "<cbc:Description>" & rsData("ProducteNom") & "</cbc:Description>"
        fitxer = fitxer & "<cac:BuyersItemIdentification>"
        fitxer = fitxer & "<cbc:ID>" & rsData("CodiArticle") & "</cbc:ID>"
        fitxer = fitxer & "</cac:BuyersItemIdentification>"
        fitxer = fitxer & "<cac:SellersItemIdentification>"
        fitxer = fitxer & "<cbc:ID>" & rsData("CodiArticle") & "</cbc:ID>"
        fitxer = fitxer & "</cac:SellersItemIdentification>"
        fitxer = fitxer & "<cac:StandardItemIdentification>"
        fitxer = fitxer & "<cac:ID identificationSchemeID=""EAN/UCC-13"">" & rsData("EAN") & "</cac:ID>"
        fitxer = fitxer & "</cac:StandardItemIdentification>"
        fitxer = fitxer & "<cac:AdditionalItemProperty>"
        fitxer = fitxer & "<cbc:Name>PRICE_AMOUNT</cbc:Name>"
        fitxer = fitxer & "<cbc:Value>" & Replace(FormatNumber(rsData("preu"), 2), ",", "") & "</cbc:Value>"
        fitxer = fitxer & "</cac:AdditionalItemProperty>"
        fitxer = fitxer & "<cac:AdditionalItemProperty>"
        fitxer = fitxer & "<cbc:Name>DELETED</cbc:Name>"
        fitxer = fitxer & "<cbc:Value>0</cbc:Value>"
        fitxer = fitxer & "</cac:AdditionalItemProperty>"
        fitxer = fitxer & "<cac:AdditionalItemProperty>"
        fitxer = fitxer & "<cbc:Name>SUBSTITUTED</cbc:Name>"
        fitxer = fitxer & "<cbc:Value>0</cbc:Value>"
        fitxer = fitxer & "</cac:AdditionalItemProperty>"
        fitxer = fitxer & "<cac:AdditionalItemProperty>"
        fitxer = fitxer & "<cbc:Name>SUBSTITUTED_POSITION</cbc:Name>"
        fitxer = fitxer & "<cbc:Value></cbc:Value>"
        fitxer = fitxer & "</cac:AdditionalItemProperty>"
        fitxer = fitxer & "<cac:ItemInstance>"
        fitxer = fitxer & "<cbc:BestBeforeDate>" & Year(dataAlbaran) & "-" & Right("00" & Month(dataAlbaran), 2) & "-" & Right("00" & Day(dataAlbaran), 2) & "</cbc:BestBeforeDate>"
        fitxer = fitxer & "<cac:LotIdentification>"
        fitxer = fitxer & "<cbc:LotNumberID>" & rsData("nLote") & "</cbc:LotNumberID>"
        fitxer = fitxer & "</cac:LotIdentification>"
        fitxer = fitxer & "</cac:ItemInstance>"
        fitxer = fitxer & "</cac:Item>"
        fitxer = fitxer & "</cac:DespatchLine>"

        pos = pos + 1
        
        rsData.MoveNext
    Wend
        
    fitxer = fitxer & "</DespatchAdvice>"

    'Write to the steam
    objStream.WriteText fitxer
    
    'Save the stream to a file
    objStream.SaveToFile "c:\" & nomFileTemp
    
    EnviaFTPSerunion nomFileTemp, "albaranes/"
    
SERUNION_ERROR:

    MyKill "c:\" & nomFileTemp

End Sub

Sub ExportaContabilitatVentasA3(numAsiento, Di As Date, Df As Date, empresa, Botigues As String, EsB As Boolean)
    Dim D As Date, fecha As Date
    Dim sql As String, botiga As String, linea As String
    Dim import As Double, tipoIva As Double, PctIva As Double, Base As Double, Quota As Double
    Dim T1 As Double, T2 As Double, T3 As Double, T4 As Double, TR1 As Double, TR2 As Double, TR3 As Double, TR4 As Double
    Dim cCtble As String, CuentaVentas As String
    Dim rsCtb As rdoResultset, rsCtbIVA As rdoResultset, rsCodi As rdoResultset, rsNIVAs As rdoResultset
    Dim nIvas As Integer, i As Integer
    
    InformaMiss "Ventas", True
    D = Di
    While D <= Df ' Or (Year(D) = Year(Df) And Month(D) = Month(Df))
        TipusDeIva T1, T2, T3, T4, TR1, TR2, TR3, TR4, D
        DadesExportaCpFlush
    
        'TOTALS
        sql = "Select c.nom, v.botiga, sum(v.import) Import "
        sql = sql & "From [" & NomTaulaVentasAoB(D, EsB) & "] v "
        sql = sql & "left join clients c on v.Botiga = c.codi "
        sql = sql & "where day(v.data) = " & Day(D) & " and v.botiga in (select Codi  from constantsclient where variable = 'EmpresaVendes' and valor = " & empresa & ") "
        If Botigues <> "()" Then sql = sql & " and botiga in (" & Botigues & ") "
        sql = sql & "group by c.nom, v.Botiga "
        sql = sql & "order by v.Botiga"
        
        Dim botigaLast
        Set rsCtb = Db.OpenResultset(sql)
        If Not rsCtb.EOF Then botigaLast = -1
    
        While Not rsCtb.EOF
            fecha = D
            botiga = rsCtb("botiga")
            
            InformaMiss "Exporta Ventas  " & fecha & " Botiga " & rsCtb("nom"), True
            
            cCtble = botiga
            Set rsCodi = Db.OpenResultset("SELECT Valor FROM " & tablaConstantsClient() & " WHERE  codi = " & botiga & " AND variable = 'CodiContable' ")
            If Not rsCodi.EOF Then If Not IsNull(rsCodi("Valor")) And (Len(rsCodi("Valor")) > 0) And IsNumeric(rsCodi("Valor")) Then cCtble = CDbl(rsCodi("Valor"))
            
            '40000220140301143000680    Ventas STA.EULALIA            1FAC680001 IVentas STA.EULALIA            +0000000607.42                                                                                                                                           EN
            AsientoAddA3 empresa, "1", "I", fecha, ("43" & Right("000000000000" & cCtble, nDigitos - 2)), "", "F" & cCtble & Right("00" & Day(fecha), 2) & Right("00" & Month(fecha), 2) & Right("00" & Year(fecha), 2), "Ventas " & rsCtb("nom"), rsCtb("import"), 0, 0, 0, 0
              
            sql = "Select a.tipoiva, v.botiga, sum(v.import) as import "
            sql = sql & "from ( "
            sql = sql & "Select Botiga,Plu,sum(import) Import "
            sql = sql & "From [" & NomTaulaVentasAoB(D, EsB) & "] v "
            sql = sql & "Where Day(data) = " & Day(D) & " And Botiga = " & botiga & " "
            sql = sql & "group by botiga,plu) v "
            sql = sql & "Left Join (select codi,tipoiva from articles union select codi,tipoiva from articles_zombis) a on a.codi  = v.plu "
            sql = sql & "group by botiga,tipoiva "
            
            Set rsNIVAs = Db.OpenResultset("select COUNT(*) nIvas from(" & sql & ") x")
            nIvas = rsNIVAs("nIvas")
            
            sql = sql & "order by botiga, tipoiva "
            Set rsCtbIVA = Db.OpenResultset(sql)
            
            i = 0
            While Not rsCtbIVA.EOF
                i = i + 1
                linea = "M"
                If i = nIvas Then linea = "U"
                
                tipoIva = rsCtbIVA("TipoIva")
                import = rsCtbIVA("import")
                Select Case tipoIva
                    Case 1: PctIva = T1
                    Case 2: PctIva = T2
                    Case 3: PctIva = T3
                End Select
                Base = Round(import / (1 + (PctIva / 100)), 2)
                Quota = Round(import - Base, 2)
                import = Base + Quota
                
'40000220140301970000000    Ventas STA.EULALIA IVA 4      CFAC680001 MVentas STA.EULALIA IVA 4      01+0000000447.9304.00+0000000017.92                                      01S                                                                             EN
'40000220140301970000000    Ventas STA.EULALIA IVA 10     CFAC680001 UVentas STA.EULALIA IVA 10     01+0000000128.7010.00+0000000012.87                                      01S                                                                             EN
               
                CuentaVentas = ("7" & Right("000000000000", nDigitos - 1))
                AsientoAddA3 empresa, "9", linea, fecha, CuentaVentas, "", "F" & cCtble & Right("00" & Day(fecha), 2) & Right("00" & Month(fecha), 2) & Right("00" & Year(fecha), 2), "Ventas " & rsCtb("nom") & " IVA " & PctIva, import, Base, PctIva, Quota, 0
            
                rsCtbIVA.MoveNext
            Wend
               
            If Not botigaLast = botiga Then numAsiento = numAsiento + 1
            botigaLast = botiga

            InformaMiss "Ventas " & D, True
            DoEvents
            rsCtb.MoveNext
        Wend
        
        rsCtb.Close
        D = DateAdd("d", 1, D)
    Wend

End Sub


Sub PedidoCalcula(Proveedor As String, horas As Double, ChatUser As Double)
    Dim rs As rdoResultset, CalDemanar, sql As String, DataUltimaVentaServida As Date, DataUltimaVenta As Date, ServitsManuals, IdP, rs2 As rdoResultset, Minimo, CalDemanarArodonit, Pack, Cares As String, NomArticle As String, CalDemanarEnPacks, Ut As Double, Pt As Double, Nt As Double, DataUltimaDevolucio As Date, StErr  As String, URL As String, resposta As String, IdFile As String
    Dim ProduccionPropia As Boolean, SirvePorUnidades As Boolean, Viatge As String, equip As String, quantitatServida, BotigaNom, Ara As Date, UnitatsInventades As Double, D1 As Date, D2 As Date, His_FechaUltimaVentaNoEncontrada As Date, His_FechaUltimaDevolucionNoEncontrada As Date, His_Inventados As Double, His_Redondeo As Double, CalDemanarDev
    Dim ErrorInventosAnteriores As Double, Encarregs, rsPreu As rdoResultset, ContemEncarregs As Boolean, rsInv As rdoResultset, precio As Double, Txt As String, texteEMail As String, LastBotiga As String, TexteEmailHi As Date, OK As Boolean
    Dim RepPedido() As Double, RepCliente() As Double, RepArticle() As Double, iC As Integer, iA As Integer, ip As Integer, accIp As Double, textePart As String
    Dim tabPedidosUltimosDatos As String
    Dim rsPedido As rdoResultset, numPedido As String
    
    Ara = Now

'    Ara = DateSerial(2010, 8, 16) + TimeSerial(20, 3, 10)
' ************
    If ChatUser > 0 Then ExecutaComandaSql "Insert Into " & NomTaulaSecreAvisosTxt & " (Tipus,usuari,lliure1) Values ('Pedido','" & ChatUser & "','Inicio Pedido')"
    texteEMail = ""
    
    TexteEmailHi = Now
    texteEMail = texteEMail & "Inicio Pedido Para  " & ProveedorCodiNom(Proveedor) & " iniciada a les : " & Now & "<Br>"
    
    'If Not ExisteixTaula("PedidosUltimosDatos") Then
    '   Sql = "CREATE TABLE [PedidosUltimosDatos] ( "
    '    Sql = Sql & " [Id] [nvarchar](255) NOT NULL DEFAULT (newid()),"
    '   Sql = Sql & " [IdPedido] [nvarchar](255) NULL,"
    '    Sql = Sql & " [Proveedor][nvarchar](255) NULL,"
    '    Sql = Sql & " [Materia]  [nvarchar](255) NULL,"
    '    Sql = Sql & " [Cliente]  [nvarchar](255) NULL,"
    '    Sql = Sql & " [Fecha]    [datetime]   NULL, "
    '    Sql = Sql & " [RedondeoProveedor] [nvarchar](255) NULL,"
    '    Sql = Sql & " [RedondeoCliente]   [nvarchar](255) NULL,"
    '    Sql = Sql & " [FechaUltimaVenta]  [datetime]   NULL, "
    '    Sql = Sql & " [FechaUltimaDevolucion]  [datetime]   NULL "
    '    Sql = Sql & " ) ON [PRIMARY] "
    '    ExecutaComandaSql Sql
    'End If
    'ExecutaComandaSql "CREATE INDEX PedidosUltimosDatos_Idx ON PedidosUltimosDatos (fecha , Materia, Cliente, Proveedor, idpedido)"
    
    tabPedidosUltimosDatos = "[" & NomTaulaPedidosUltimosDatos(Ara, Proveedor) & "]"
    
    ReDim RepPedido(1000, 1000)
    ReDim RepCliente(0)
    ReDim RepArticle(0)
    
    GuardaHistoricReposicio "", Ara, "Reposicio Automatica ", ProveedorCodiNom(Proveedor)
    Informa "Pedido " & ProveedorCodiNom(Proveedor)
    '22/06/2012 SERGI CUIDADO TAULA EQUIVALENCIESPRODUCTES ES BUIDA!
    'ExecutaComandaSql "delete articlespropietats  where valor in ( select valor from articlespropietats  where variable = 'MatPri'  and not valor = '' group by valor having count(*) > 1 ) "
    'ExecutaComandaSql "delete equivalenciaproductes where prodvenut not in (select codi from articles )"
    'ExecutaComandaSql "delete equivalenciaproductes where prodServit not in (select codi from articles )"
    'ExecutaComandaSql "drop table equivalenciaproductes2"
    'ExecutaComandaSql "select prodVenut,ProdServit,max(UnitatsEquivalencia) UnitatsEquivalencia  into equivalenciaproductes2  from equivalenciaproductes group by prodVenut,ProdServit"
    'ExecutaComandaSql "Delete equivalenciaproductes"
    'ExecutaComandaSql "insert into equivalenciaproductes select * from equivalenciaproductes2"
    ExecutaComandaSql "Delete " & tabPedidosUltimosDatos & " where  DATEDIFF(D,Fecha,GETDATE()) > 100"

    ProduccionPropia = False
    Set rs = Db.OpenResultset("Select Valor from ccproveedoresextes with (nolock) where id = '" & Proveedor & "' and nom = 'pPropia' and valor = 'on' ")
    If Not rs.EOF Then If Not IsNull(rs(0)) Then If rs(0) = "on" Then ProduccionPropia = True
    GuardaHistoricReposicio "", Ara, "Reposicio Automatica ", "Es Produccio Propia : " & ProduccionPropia
    texteEMail = texteEMail & "Es Produccio Propia : " & ProduccionPropia

    SirvePorUnidades = False
    Set rs = Db.OpenResultset("Select Valor from ccproveedoresextes with (nolock) where id = '" & Proveedor & "' and nom = 'SirveUnidades' and valor = 'on' ")
    If Not rs.EOF Then If Not IsNull(rs(0)) Then If rs(0) = "on" Then SirvePorUnidades = True
    GuardaHistoricReposicio "", Ara, "Reposicio Automatica ", "SirvePorUnidades : " & SirvePorUnidades
    texteEMail = texteEMail & "SirvePorUnidades : " & SirvePorUnidades
    
    
    ContemEncarregs = False
    Set rs = Db.OpenResultset("Select Valor from ccproveedoresextes with (nolock) where id = '" & Proveedor & "' and nom = 'siEncargos' and valor = 'on' ")
    If Not rs.EOF Then If Not IsNull(rs(0)) Then If rs(0) = "on" Then ContemEncarregs = True
    GuardaHistoricReposicio "", Ara, "Reposicio Automatica ", "ContemEncarregs : " & ContemEncarregs
    texteEMail = texteEMail & "ContemEncarregs : " & ContemEncarregs
    
    If ProduccionPropia Then
        Set rs = Db.OpenResultset("select Valor from ccproveedoresextes with (nolock) where id = '" & Proveedor & "' and nom = 'viatge'")
        Viatge = ""
        If Not rs.EOF Then If Not IsNull(rs(0)) Then Viatge = rs(0)
        equip = ""
        Set rs = Db.OpenResultset("select valor from ccproveedoresextes with (nolock) where id = '" & Proveedor & "' and nom = 'equip'")
        If Not rs.EOF Then If Not IsNull(rs(0)) Then equip = rs(0)
        'Para que sirve esto?????????????????????
        ExecutaComandaSql "select * from ccpedidos with (nolock) where proveedor = '" & Proveedor & "' and day(Fecha) = " & Day(Now) & " and month(Fecha) = " & Month(Now) & "  and year(fecha) = " & Year(Now) & "  "
        GuardaHistoricReposicio "", Ara, "Reposicio Automatica ", "Viatge :" & Viatge & " Equip :" & equip
        texteEMail = texteEMail & "ProduccionPropia  Viatge :" & Viatge & " Equip :" & equip
    End If
    
'    GuardaHistoric proveedorcodinom(Proveedor), Now, "Reposicio Automatica ", " Ventes ... ", "Desde " & DataUltimaVenta & " Fins A " & DataUltimaVentaServida & "  Unitats = " & CalDemanar
    ExecutaComandaSql "CREATE INDEX ccmateriasprimas_Idx ON ccmateriasprimas (Id) WITH (DATA_COMPRESSION = None)"
    ExecutaComandaSql "CREATE INDEX ccnombrevalor_Idx ON ccnombrevalor (Id,Nombre,Valor)"
    'PROVES PANET PORT PARES Set Rs = Db.OpenResultset("Select m.id materia,c.codi botiga,p.codiarticle codiarticle, m.nombre mnombre,c.nom,* from ccmateriasprimas m with (nolock) join ccnombrevalor Pr with (nolock) on Pr.valor = '" & Proveedor & "' And m.id=Pr.id and left(Pr.nombre,13) = 'P_REPOSICION_' join ccnombrevalor b with (nolock) on m.id=b.id and left(b.nombre,11) = 'REPOSICION_' join Clients c with (nolock) on Pr.nombre = 'P_REPOSICION_' + cast(c.codi  as nvarchar) And b.nombre = 'REPOSICION_' + cast(c.codi  as nvarchar) join articlespropietats p with (nolock) on p.variable = 'MatPri' and p.valor = m.id where c.Codi=559 and p.CodiArticle =7789 order by  c.nom,m.nombre ")
    'Set Rs = Db.OpenResultset("Select m.id materia,c.codi botiga,p.codiarticle codiarticle, m.nombre mnombre,c.nom,* from ccmateriasprimas m with (nolock) join ccnombrevalor Pr with (nolock) on Pr.valor = '" & Proveedor & "' And m.id=Pr.id and left(Pr.nombre,13) = 'P_REPOSICION_' join ccnombrevalor b with (nolock) on m.id=b.id and left(b.nombre,11) = 'REPOSICION_' join Clients c with (nolock) on Pr.nombre = 'P_REPOSICION_' + cast(c.codi  as nvarchar) And b.nombre = 'REPOSICION_' + cast(c.codi  as nvarchar) join articlespropietats p with (nolock) on p.variable = 'MatPri' and p.valor = m.id order by  c.nom,m.nombre ")
    
    
    'TENER EN CUENTA LA MATERIA PRIMA BASE!!!!!
    sql = "Select m.id materia,c.codi botiga,p.codiarticle codiarticle, m.nombre mnombre,isnull(cc.valor, '99') ordre,c.nom,* "
    sql = sql & "from ccmateriasprimas m with (nolock) "
    sql = sql & "join ccnombrevalor Pr with (nolock) on Pr.valor = '" & Proveedor & "' And m.id=Pr.id and left(Pr.nombre,13) = 'P_REPOSICION_' "
    sql = sql & "join ccnombrevalor b with (nolock) on m.id=b.id and left(b.nombre,11) = 'REPOSICION_' "
    sql = sql & "join Clients c with (nolock) on Pr.nombre = 'P_REPOSICION_' + cast(c.codi  as nvarchar) And b.nombre = 'REPOSICION_' + cast(c.codi  as nvarchar) "
    sql = sql & "left join constantsclient cc on c.codi=cc.codi and cc.variable='OrdreRuta' "
    sql = sql & "join articlespropietats p with (nolock) on p.variable = 'MatPri' and p.valor = m.id "
'!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
sql = sql & "where c.codi NOT in (819, 343,335,411,794,338,679,165,318,307) " '!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
'!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
    sql = sql & "order by  isnull(cc.valor, '99'), c.nom, m.nombre"
    Set rs = Db.OpenResultset(sql)
    
    texteEMail = texteEMail & String(50, "-") & "<Br>"
    LastBotiga = ""
    
    While Not rs.EOF
        BotigaNom = BotigaCodiNom(rs("Botiga"))
        If LastBotiga <> BotigaNom Then
            texteEMail = texteEMail & "Botiga : " & BotigaNom & "<Br>"
            
            Set rsPedido = Db.OpenResultset("select isnull(MAX(numPedido), 0) + 1 nPedido from " & NomTaulaPedidosCap())
            numPedido = rsPedido("nPedido")
        End If
        LastBotiga = BotigaNom
        
        For iC = 0 To UBound(RepCliente)
            If RepCliente(iC) = rs("botiga") Then Exit For
        Next
        If iC > UBound(RepCliente) Then
            ReDim Preserve RepCliente(iC)
            RepCliente(iC) = rs("botiga")
        End If
        
        For iA = 0 To UBound(RepArticle)
            If RepArticle(iA) = rs("codiarticle") Then Exit For
        Next
        If iA > UBound(RepArticle) Then
            ReDim Preserve RepArticle(iA)
            RepArticle(iA) = rs("codiarticle")
        End If
        
        RepPedido(iC, iA) = 0
        
        NomArticle = ArticleCodiNom(rs("codiarticle"))
        texteEMail = texteEMail & "           " & NomArticle & " -> "
        Debug.Print BotigaNom & " -- " & NomArticle
        Informa2 BotigaNom & " -- " & NomArticle
        If InStr(NomArticle, "damm") > 0 Then
            NomArticle = NomArticle
            If rs("Botiga") = 822 Then
                NomArticle = NomArticle
            End If
        End If

        rec "insert into " & NomTaulaPedidosZombis() & " select *, getdate(), 'SINCRO' from ccPedidos where fecha >= convert(datetime,'" & Right("0" & Day(Ara), 2) & "/" & Right("0" & Month(Ara), 2) & "/" & Right(CStr(Year(Ara)), 2) & "',3)  And MateriaPrima = '" & rs("materia") & "' And Almacen = 'Client_" & rs("Botiga") & "'"

        ExecutaComandaSql "Delete ccpedidos where fecha >= convert(datetime,'" & Right("0" & Day(Ara), 2) & "/" & Right("0" & Month(Ara), 2) & "/" & Right(CStr(Year(Ara)), 2) & "',3)  And MateriaPrima = '" & rs("materia") & "' And Almacen = 'Client_" & rs("Botiga") & "'"
' solo un pedido por fecha
        ExecutaComandaSql "Delete " & tabPedidosUltimosDatos & " Where  fecha >= convert(datetime,'" & Right("0" & Day(Ara), 2) & "/" & Right("0" & Month(Ara), 2) & "/" & Right(CStr(Year(Ara)), 2) & "',3) And  Materia = '" & rs("materia") & "' and Cliente = '" & rs("Botiga") & "' and Proveedor =  '" & Proveedor & "'  and idpedido in (select id from ccpedidos)    "
        GuardaHistoricReposicio rs("Botiga"), Ara, "Reposicio Automatica ", ArticleCodiNom(rs("codiarticle"))
        If Not PedidosUltimosDatos(rs("materia"), rs("Botiga"), Proveedor, DataUltimaVentaServida, His_FechaUltimaVentaNoEncontrada, His_FechaUltimaDevolucionNoEncontrada, His_Inventados, His_Redondeo) Then
            GuardaHistoricReposicio rs("Botiga"), Ara, "Reposicio Automatica ", NomArticle, "!! Primer Pedido , No Encuentro pedidos anteriores, Cojemos historico de 14 dias.   "
            texteEMail = texteEMail & "!! Primer Pedido , No Encuentro pedidos anteriores, Cojemos historico de 14 dias.   <Br>"
        End If
        GuardaHistoricReposicio rs("Botiga"), Ara, "Reposicio Automatica ", "PedidosUltimosDatos : DataUltimaVentaServida = " & DataUltimaVentaServida & " His_FechaUltimaVentaNoEncontrada = " & His_FechaUltimaVentaNoEncontrada & " His_FechaUltimaDevolucionNoEncontrada = " & His_FechaUltimaDevolucionNoEncontrada & " His_Inventados = " & His_Inventados & " His_Redondeo = " & His_Redondeo
        texteEMail = texteEMail & "PedidosUltimosDatos : DataUltimaVentaServida = " & DataUltimaVentaServida & " His_FechaUltimaVentaNoEncontrada = " & His_FechaUltimaVentaNoEncontrada & " His_FechaUltimaDevolucionNoEncontrada = " & His_FechaUltimaDevolucionNoEncontrada & " His_Inventados = " & His_Inventados & " His_Redondeo = " & His_Redondeo & "<Br>"
        
        'If Not DateSerial(Year(Ara), Month(Ara), Day(Ara)) = DateSerial(Year(Now), Month(Now), Day(Now)) Then DataUltimaVentaServida = DateSerial(Year(Ara), Month(Ara), Day(Ara)) + TimeSerial(1, 1, 1)
        CalDemanarArodonit = 0
        
        DataUltimaVenta = DataUltimaVentaBusca(rs("Botiga"), Ara)
        GuardaHistoricReposicio rs("Botiga"), Ara, "Reposicio Automatica ", "DataUltimaVenta  : " & DataUltimaVenta
        texteEMail = texteEMail & "DataUltimaVenta  : " & DataUltimaVenta & "<Br>"
        'If ChatUser > 0 Then ExecutaComandaSql "Insert Into " & NomTaulaSecreAvisosTxt & " (Tipus,usuari,lliure1) Values ('Pedido','" & ChatUser & "','Article -> " & NomArticle & "')"
       
        CalDemanar = PedidoCuantosFaltan(rs("codiarticle"), rs("Botiga"), His_FechaUltimaVentaNoEncontrada, DataUltimaVenta)
        GuardaHistoricReposicio rs("Botiga"), Ara, "Reposicio Automatica ", "Ventas desde " & His_FechaUltimaVentaNoEncontrada & " Hasta : " & DataUltimaVenta & " : " & CalDemanar
        
        PedidoCuantosFaltanNumTicks rs("codiarticle"), rs("Botiga"), His_FechaUltimaVentaNoEncontrada, DataUltimaVenta, Ut, Pt, Nt
        GuardaHistoricReposicio rs("Botiga"), Ara, "Reposicio Automatica ", NomArticle, "Primer Tick: " & Ut & " Ultim Tick: " & Pt & " NumTics: " & Nt & " (" & Ut - Pt & ") "
        
        
        DataUltimaDevolucio = DataUltimaDevolucioBusca(rs("Botiga"), Ara)
        GuardaHistoricReposicio rs("Botiga"), Ara, "Reposicio Automatica ", "DataUltimaDevolucio : " & DataUltimaDevolucio
        
        '********************
        ' ENCARRECS PER ACABAR
        '********************
        
        Encarregs = 0
        If ContemEncarregs Then
            Encarregs = EncarregatsServits(rs("codiarticle"), rs("Botiga"), His_FechaUltimaVentaNoEncontrada, DataUltimaVenta)
            GuardaHistoricReposicio rs("Botiga"), Ara, "Reposicio Automatica ", "Encarregs Servits desde " & His_FechaUltimaVentaNoEncontrada & " Hasta : " & DataUltimaVenta & " : " & Encarregs
        End If
        
        CalDemanarDev = PedidoCuantosFaltanDevolucion(rs("codiarticle"), rs("Botiga"), His_FechaUltimaDevolucionNoEncontrada, DataUltimaDevolucio)
        GuardaHistoricReposicio rs("Botiga"), Ara, "Reposicio Automatica ", "Devolucions desde " & His_FechaUltimaDevolucionNoEncontrada & " Hasta : " & DataUltimaDevolucio & " : " & CalDemanarDev
        CalDemanar = CalDemanar + CalDemanarDev - Encarregs
        
        UnitatsInventades = 0
        Set rsInv = Db.OpenResultset("select Valor from ccproveedoresextes with (nolock) where id = '" & Proveedor & "' and nom = 'noInventar' and valor='on'")
        If rsInv.EOF Then
            D1 = DateSerial(Year(DataUltimaVenta), Month(DataUltimaVenta), Day(DataUltimaVenta)) + TimeSerial(Hour(Ara), Minute(Ara), Second(Ara))
            If DateSerial(Year(DataUltimaVenta), Month(DataUltimaVenta), Day(DataUltimaVenta)) + TimeSerial(Hour(Ara), Minute(Ara), Second(Ara)) > DataUltimaVenta Then D1 = DateAdd("d", -1, D1)
            D2 = DateAdd("s", -DateDiff("s", DataUltimaVenta, Ara), D1)
            UnitatsInventades = PedidoCuantosFaltan(rs("codiarticle"), rs("Botiga"), D2, D1)
            GuardaHistoricReposicio rs("Botiga"), Ara, "Reposicio Automatica ", "Inventados desde " & D1 & " Hasta : " & D2 & " : " & UnitatsInventades
        End If
        
        ErrorInventosAnteriores = PedidoCuantosFaltan(rs("codiarticle"), rs("Botiga"), DataUltimaVentaServida, His_FechaUltimaVentaNoEncontrada)
        GuardaHistoricReposicio rs("Botiga"), Ara, "Reposicio Automatica ", "ErrorInventosAnteriores  desde " & DataUltimaVentaServida & " Hasta : " & His_FechaUltimaVentaNoEncontrada & " : " & ErrorInventosAnteriores
        

        ErrorInventosAnteriores = (ErrorInventosAnteriores - His_Inventados)
        If Abs(ErrorInventosAnteriores) > 0 Then
            GuardaHistoricReposicio rs("Botiga"), Ara, "Reposicio Automatica ", NomArticle, " Arreglem error inventats anterior en : " & ErrorInventosAnteriores
        End If
        
        If (CalDemanar + UnitatsInventades + His_Redondeo + ErrorInventosAnteriores) > 0 Then
            Pack = 1
            Minimo = 1
            Set rs2 = Db.OpenResultset("Select unidades,UnidadesEnvio from ccmateriasprimas with (nolock) where id ='" & rs("materia") & "' ")
            If Not rs2.EOF Then If Not IsNull(rs2("Unidades")) Then Pack = rs2("Unidades")
            If Pack = 0 Then Pack = 1
                If Not rs2.EOF Then If Not IsNull(rs2("UnidadesEnvio")) Then Minimo = rs2("UnidadesEnvio")
            If Minimo = 0 Then Minimo = 1
            
            If SirvePorUnidades Then
                Pack = 1
                Minimo = 1
            End If
            
            GuardaHistoricReposicio rs("Botiga"), Ara, "Reposicio Automatica ", NomArticle, "Pack :" & Pack & " Minimo:" & Minimo & "  (Pack * Minimo) = " & (Pack * Minimo)
            Dim Limite
            Limite = (Pack * Minimo)
            If Minimo = 1 And Pack > 5 Then Limite = Int(Limite * 0.9)
            
            If (CalDemanar + UnitatsInventades + His_Redondeo + ErrorInventosAnteriores) >= Limite Then
                CalDemanarArodonit = Int((CalDemanar + UnitatsInventades + His_Redondeo + ErrorInventosAnteriores) / (Pack * Minimo)) * (Pack * Minimo)
                GuardaHistoricReposicio rs("Botiga"), Ara, "Reposicio Automatica ", NomArticle, " Fem Comanda CalDemanarArodonit " & CalDemanarArodonit & " Per Propera comanda guardem : " & ((CalDemanar + UnitatsInventades + His_Redondeo + ErrorInventosAnteriores) - CalDemanarArodonit)
                Set rs2 = Db.OpenResultset("Select NewId() ")
                IdP = rs2(0)
                texteEMail = texteEMail & " Fem Comanda CalDemanarArodonit " & CalDemanarArodonit & " Per Propera comanda guardem : " & ((CalDemanar + UnitatsInventades + His_Redondeo + ErrorInventosAnteriores) - CalDemanarArodonit)
                
                precio = 0
                Set rsPreu = Db.OpenResultset("select precio from ccmateriasprimas with (nolock) where id = '" & rs("Materia") & "'")
                If Not rsPreu.EOF Then
                    If Left(rsPreu("precio"), 1) = "." Then
                        precio = CDbl("0" & rsPreu("precio"))
                    Else
                        precio = rsPreu("precio")
                    End If
                End If
                
                sql = "Insert into ccPedidos(Id,materiaPrima,proveedor,almacen,precio,cantidad,fecha,recepcion) "
                
                CalDemanarEnPacks = CalDemanarArodonit
                If Pack > 1 Then CalDemanarEnPacks = Int(CalDemanarArodonit / Pack)
                
                sql = sql & "values('" & IdP & "','" & rs("Materia") & "','" & Proveedor & "','Client_" & rs("Botiga") & "'," & precio & "," & CalDemanarEnPacks & ",convert(datetime,'" & Ara & "',103),convert(datetime,'" & DateAdd("d", 1, Ara) & "',103))"
                ExecutaComandaSql sql
                
 On Error GoTo sigue
 
                ExecutaComandaSql "insert into " & NomTaulaPedidosCap() & " (numPedido, idPedido, proveedor, almacen, fecha, recepcion) values (" & numPedido & ", '" & IdP & "', '" & Proveedor & "', 'Client_" & rs("Botiga") & "', convert(datetime,'" & Ara & "',103), convert(datetime,'" & Ara & "',103))"
sigue:
                RepPedido(iC, iA) = CalDemanarEnPacks
                
                If ChatUser > 0 Then ExecutaComandaSql "Insert Into " & NomTaulaSecreAvisosTxt & " (Tipus,usuari,lliure1) Values ('Pedido','" & ChatUser & "','Article -> " & NomArticle & " Servir :" & CalDemanarArodonit & " Unitats')"
                
                sql = "Insert into " & tabPedidosUltimosDatos
                sql = sql & " ([IdPedido],[Proveedor],[Materia],[Cliente],[Fecha],[RedondeoProveedor],[RedondeoCliente],[FechaUltimaVenta],[FechaUltimaDevolucion])  "
                sql = sql & " Values ("
                sql = sql & " '" & IdP & "',"
                sql = sql & " '" & Proveedor & "',"
                sql = sql & " '" & rs("Materia") & "',"
                sql = sql & " '" & rs("Botiga") & "',"
                sql = sql & " convert(datetime,'" & Ara & "',103),"
                sql = sql & " '" & ((CalDemanar + UnitatsInventades + His_Redondeo + ErrorInventosAnteriores) - CalDemanarArodonit) & "',"
                sql = sql & " '" & UnitatsInventades & "',"
                sql = sql & " convert(datetime,'" & DataUltimaVenta & "',103), "
                sql = sql & " convert(datetime,'" & DataUltimaDevolucio & "',103) "
                sql = sql & " ) "
                ExecutaComandaSql sql
                
            Else
                texteEMail = texteEMail & "NO PEDIDO (CalDemanar + UnitatsInventades + His_Redondeo + ErrorInventosAnteriores) <= Limite , " & (CalDemanar + UnitatsInventades + His_Redondeo + ErrorInventosAnteriores) & "<=" & Limite
                GuardaHistoricReposicio rs("Botiga"), Ara, "Reposicio Automatica ", "NO PEDIDO (CalDemanar + UnitatsInventades + His_Redondeo + ErrorInventosAnteriores) <= Limite , " & (CalDemanar + UnitatsInventades + His_Redondeo + ErrorInventosAnteriores) & "<=" & Limite
            End If
            
        End If
        
        If ProduccionPropia Then
            quantitatServida = 0
            Set rs2 = Db.OpenResultset("Select Sum(QuantitatServida) Qs From [" & DonamNomTaulaServit(DateAdd("d", 1, Ara)) & "] with (nolock) Where Client = " & rs("Botiga") & " And CodiArticle = " & rs("codiarticle") & " ")
            If Not rs2.EOF Then If Not IsNull(rs2(0)) Then quantitatServida = rs2(0)
            texteEMail = texteEMail & "Fins ara Servits = " & quantitatServida & " Ara Ventas = " & (CalDemanar + UnitatsInventades + His_Redondeo + ErrorInventosAnteriores) & " Comanda de  = " & CalDemanarArodonit
            
            GuardaHistoricReposicio rs("Botiga"), Ara, "Reposicio Automatica ", NomArticle, "Fins ara Servits = " & quantitatServida & " Ara Ventas = " & (CalDemanar + UnitatsInventades + His_Redondeo + ErrorInventosAnteriores) & " Comanda de  = " & CalDemanarArodonit
            ExecutaComandaSql "Update [" & DonamNomTaulaServit(DateAdd("d", 1, Ara)) & "] Set QuantitatDemanada = 0 ,QuantitatServida = 0 Where Client = " & rs("Botiga") & " And CodiArticle = " & rs("codiarticle") & " And  Viatge = '" & Viatge & "' And Equip = '" & equip & "' "
            ExecutaComandaSql "Delete [" & DonamNomTaulaServit(DateAdd("d", 1, Ara)) & "] Where QuantitatDemanada = 0 And Client = " & rs("Botiga") & " And CodiArticle = " & rs("codiarticle") & " And Comentari like '%Reposicio%'  "
            If CalDemanarArodonit > 0 Then
                GuardaHistoricReposicio rs("Botiga"), Ara, "Reposicio Automatica ", NomArticle, "FemComanda " & Format(DateAdd("d", 1, Ara), "dd-mm-yyyy") & " Unitats  " & CalDemanarArodonit & " Viatge = [" & Viatge & "] Equip : [" & equip & "]"
                sql = "Insert Into [" & DonamNomTaulaServit(DateAdd("d", 1, Ara)) & "] "
                sql = sql & "(Client,CodiArticle,QuantitatDemanada,QuantitatServida,Comentari,PluUtilitzat,Viatge,Equip,MotiuModificacio,Hora,TipusComanda,ComentariPer,Atribut) "
                sql = sql & " Values ("
                sql = sql & " " & rs("Botiga") & " , "
                sql = sql & " " & rs("codiarticle") & " , "
                sql = sql & " '" & CalDemanarArodonit & "' , "
                sql = sql & " '" & CalDemanarArodonit & "' , "
                sql = sql & " '[Reposicio:" & UnitatsInventades & "]', "
                sql = sql & " " & rs("codiarticle") & " , "
                sql = sql & " '" & Viatge & "' , "
                sql = sql & " '" & equip & "' , "
                sql = sql & " '' , "
                sql = sql & " 95 , "
                sql = sql & " 1 , "
                sql = sql & " '' , "
                sql = sql & " 0 ) "
                'GuardaHistoricReposicio Rs("Botiga"), Ara, "Reposicio Automatica ", NomArticle, "FemComanda Sql ", Sql
                'GuardaHistoricReposicio Rs("Botiga"), Ara, "Reposicio Automatica ", NomArticle, Left(Sql, 255)
                'GuardaHistoricReposicio Rs("Botiga"), Ara, "Reposicio Automatica ", NomArticle, Right(Sql, 255)
                StErr = ""
                OK = ExecutaComandaSql(sql, StErr)
                If Not OK Then
'                    GuardaHistoric Rs("Botiga"), Ara, "Reposicio Automatica ", NomArticle, "FemComanda " & Ok & " " & Err.Description
                    GuardaHistoricReposicio rs("Botiga"), Ara, "Reposicio Automatica ", NomArticle, "FemComanda Reintento"
                    StErr = ""
                    OK = ExecutaComandaSql(sql, StErr)
                    If Not OK Then
                        GuardaHistoricReposicio rs("Botiga"), Ara, "Reposicio Automatica ", NomArticle, "FemComanda " & OK & " " & StErr
                    End If
'                    GuardaHistoric Rs("Botiga"), Ara, "Reposicio Automatica ", NomArticle, "FemComanda " & Ok & " ", Err.Description, Sql
'                    GuardaHistoric Rs("Botiga"), Ara, "Reposicio Automatica ", NomArticle, StErr
'                    GuardaHistoric Rs("Botiga"), Ara, "Reposicio Automatica ", NomArticle, "." & Sql & "."
                End If
                GuardaHistoricReposicio rs("Botiga"), Ara, "Reposicio Automatica ", NomArticle, "FemComanda " & OK & " " & StErr
            End If
        End If
        
        texteEMail = texteEMail & "<Br>"
        
otro:
        rs.MoveNext
    Wend
    
    texteEMail = texteEMail & String(50, "-") & "<Br>"
    texteEMail = texteEMail & "Fin Pedido " & Now & "<Br>"
    If ChatUser > 0 Then ExecutaComandaSql "Insert Into " & NomTaulaSecreAvisosTxt & " (Tipus,usuari,lliure1) Values ('Pedido','" & ChatUser & "','Fin Pedido (" & DataUltimaVenta & ")')"

On Error GoTo posna

    'sf_enviarMail "Secrehit@gmail.com", "ana@solucionesit365.com", Format(Now, "dddd dd ") & "REPOSICIO AUTOMÀTICA a " & ProveedorCodiNom(Proveedor) & " " & DateDiff("n", TexteEmailHi, Now) & " n. ", TexteEmail, "", ""
    
    If Not EmailAvissos() = "" Then sf_enviarMail "Secrehit@gmail.com", EmailAvissos(), Format(Now, "dddd dd ") & "REPOSICIO AUTOMÀTICA a " & ProveedorCodiNom(Proveedor) & " " & DateDiff("n", TexteEmailHi, Now) & " n. ", texteEMail, "", ""
    
    Set rs = Db.OpenResultset("Select eMail,via from ccproveedores with (nolock) where id = '" & Proveedor & "' ")
    If Not rs.EOF Then
        If Not IsNull(rs("VIA")) Then
            If rs("Via") = "EMAIL" Then
                If Len(rs("eMail")) > 0 Then
                    If InStr(rs("eMail"), "@") > 0 Then
                        MyKill AppPath & "\DetallCalcul.html"
                        'TexteEmail
                        Dim f
                        f = FreeFile
                        Open AppPath & "\DetallCalcul.html" For Output As #f
                        Print #f, texteEMail
                        Close #f
                        
                        texteEMail = ""
                        texteEMail = texteEMail & "<H><b> Comanda Per " & ProveedorCodiNom(Proveedor) & " </b></H>"
                        texteEMail = texteEMail & "<Table border=1 ><Tr><Td style='width:20%;'><b>Producte</b></Td><Td style='width:30%;'><b>Total</b></Td>"
                        For iA = 1 To UBound(RepCliente)
                            texteEMail = texteEMail & "<Td style='width:20%;'><b>" & BotigaCodiNom(RepCliente(iA)) & "</b></Td>"
                        Next
                        texteEMail = texteEMail & "</Tr>"
                        For ip = 1 To UBound(RepArticle)
                            accIp = 0
                            textePart = ""
                            For iA = 1 To UBound(RepCliente)
                                If UBound(RepPedido, 1) >= iA And UBound(RepPedido, 2) >= ip Then
'                                    Debug.Print RepPedido(iA, iP)
                                    accIp = accIp + RepPedido(iA, ip)
                                    textePart = textePart & "<Td>" & IIf(RepPedido(iA, ip) = 0, "", RepPedido(iA, ip)) & "</Td>"
                                End If
                            Next
                            texteEMail = texteEMail & "<Tr><Td>" & ArticleCodiNom(RepArticle(ip)) & "</Td><Td>" & Format(accIp, "#.00") & "</Td>" & textePart & "</Tr>"
                        Next
                        texteEMail = texteEMail & "</Table>" & "<Br>"
                        'sf_enviarMail "Secrehit@gmail.com", "ana@solucionesit365.com", Format(Now, "dddd dd ") & "REPOSICIO AUTOMÀTICA a " & ProveedorCodiNom(Proveedor) & " " & DateDiff("n", TexteEmailHi, Now) & " n. ", TexteEmail, AppPath & "\DetallCalcul.html", ""
                        sf_enviarMail "Secrehit@gmail.com", rs("eMail"), Format(Now, "dddd dd ") & "REPOSICIO AUTOMÀTICA a " & ProveedorCodiNom(Proveedor) & " " & DateDiff("n", TexteEmailHi, Now) & " n. ", texteEMail, "", AppPath & "\DetallCalcul.html"
                        MyKill AppPath & "\DetallCalcul.html"
                   End If
                End If
            End If
        End If
    End If
posna:

End Sub




Sub PedidoCalcula_91(Proveedor As String, horas As Double, ChatUser As Double)
'A- VENTAS DESDE FECHA ÚLTIMA REPOSICIÓN HASTA AHORA.
'B- ME INVENTO VENTAS DE LO QUE FALTA DE TARDE, CONTANDO LAS DE LA SEMANA PASADA (PORQUE LAS DE HOY AÚN NO LAS SÉ).
'C- PARA ARREGLAR ERRORES DE INVENTOS:
'    d - TENGO GUARDADO LO QUE ME INVENTÉ AYER
'    e - LAS VENTAS REALES AYER
'    c = e - D
'A + B + C = ES LO QUE HAY QUE PEDIR

    Dim Ara As Date
    Dim texteEMail As String, TexteEmailHi As Date
    Dim tabPedidosUltimosDatos As String
    Dim proveedorNom As String
    
    Dim RepPedido() As Double, RepCliente() As Double, RepArticle() As Double
    ReDim RepPedido(1000, 1000)
    ReDim RepCliente(0)
    ReDim RepArticle(0)
    
    Dim iC As Integer, iA As Integer
    
    Dim ProduccionPropia As Boolean, Viatge As String, equip As String
    Dim SirvePorUnidades As Boolean, Pack As Integer, Minimo As Integer, Limite As Integer
    Dim ContemEncarregs As Boolean, Encarregs As Double
    Dim AnticipaComanda As String
    Dim noInventar As Boolean, UnitatsInventades As Double, UnitatsInventadesTarda As Double
    
    Dim rs As rdoResultset, rs2 As rdoResultset
    
    Dim LastBotiga As String, BotigaNom As String
    
    Dim rsPedido As rdoResultset, numPedido As String
    
    Dim NomArticle As String
    
    Dim DataUltimaVentaServida As Date, DataUltimaVenta As Date, DataUltimaDevolucio As Date
    Dim His_FechaUltimaVentaNoEncontrada As Date, His_FechaUltimaDevolucionNoEncontrada As Date, His_Inventados As Integer, His_Redondeo As Integer
    
    Dim CalDemanar As Double, CalDemanarArodonit As Integer, CalDemanarEnPacks As Double, CalDemanarDev As Double
    Dim consumoPersonal As Double
    Dim demanatNOServit As Double
    Dim stockBotiga As Double
    
    Dim Ut As Double, Pt As Double, Nt As Double
    
    Dim sql As String, IdP As String, StErr As String
    Dim quantitatServida As Double, D1 As Date, D2 As Date
    Dim ErrorInventosAnteriores As Double, rsPreu As rdoResultset, rsInv As rdoResultset, precio As Double, OK As Boolean
    Dim ip As Integer, accIp As Double, textePart As String
    

    proveedorNom = ProveedorCodiNom(Proveedor)
    
    Informa "Pedido " & proveedorNom
    
    If ChatUser > 0 Then ExecutaComandaSql "Insert Into " & NomTaulaSecreAvisosTxt & " (Tipus,usuari,lliure1) Values ('Pedido','" & ChatUser & "','Inicio Pedido')"
        
    'Para poner en el email cuanto ha tardado el cálculo del pedido
    TexteEmailHi = Now
    
    GuardaHistoricReposicio "", Now, "REPOSICIO AUTOMATICA NUEVA", "---------------------" & UCase(proveedorNom) & "---------------------"
    texteEMail = "<B>Inicio Pedido Para  [" & UCase(proveedorNom) & "] iniciada a les : " & TexteEmailHi & "</B><BR><BR>"
    
    'ANTICIPA COMANDA
    AnticipaComanda = "10H"
    Set rs = Db.OpenResultset("Select Valor from ccproveedoresextes with (nolock) where id = '" & Proveedor & "' and nom = 'AnticipaComanda' ")
    If Not rs.EOF Then If Not IsNull(rs("Valor")) Then AnticipaComanda = rs("Valor")
    
'AnticipaComanda = "19H"

    If InStr(AnticipaComanda, "H") Then
        If IsNumeric(Replace(AnticipaComanda, "H", "")) Then
            Ara = DateAdd("h", Replace(AnticipaComanda, "H", ""), Now)
        Else
            Ara = DateAdd("h", 10, Now)
        End If
    Else
        Ara = DateAdd("h", 10, Now)
    End If
    
    GuardaHistoricReposicio "", Ara, "REPOSICIO AUTOMATICA NUEVA", proveedorNom, "ANTICIPA COMANDA [" & AnticipaComanda & "]"
    texteEMail = texteEMail & "<DD><B>ANTICIPA COMANDA</B> [" & AnticipaComanda & "]</DD><BR>"
    
    'Tabla para guardar información de los pedidos (una tabla por mes y proveedor)
    tabPedidosUltimosDatos = "[" & NomTaulaPedidosUltimosDatos(Now, Proveedor) & "]"
    
    'PRODUCCIÓN PROPIA
    ProduccionPropia = False
    Set rs = Db.OpenResultset("Select Valor from ccproveedoresextes with (nolock) where id = '" & Proveedor & "' and nom = 'pPropia' and valor = 'on' ")
    If Not rs.EOF Then If Not IsNull(rs(0)) Then If rs(0) = "on" Then ProduccionPropia = True
    GuardaHistoricReposicio "", Ara, "REPOSICIO AUTOMATICA NUEVA", proveedorNom, "PRODUCCION PROPIA [" & ProduccionPropia & "]"
    texteEMail = texteEMail & "<DD><B>PRODUCCION PROPIA</B> [" & ProduccionPropia & "]</DD><BR>"
    
    If ProduccionPropia Then 'VIAJE Y EQUIPO DEL PROVEEDOR, QUE SE USAN PARA ...
        Viatge = ""
        Set rs = Db.OpenResultset("select Valor from ccproveedoresextes with (nolock) where id = '" & Proveedor & "' and nom = 'viatge'")
        If Not rs.EOF Then If Not IsNull(rs(0)) Then Viatge = rs(0)
        
        equip = ""
        Set rs = Db.OpenResultset("select valor from ccproveedoresextes with (nolock) where id = '" & Proveedor & "' and nom = 'equip'")
        If Not rs.EOF Then If Not IsNull(rs(0)) Then equip = rs(0)
        
        GuardaHistoricReposicio "", Ara, "REPOSICIO AUTOMATICA NUEVA", proveedorNom, "VIAJE [" & Viatge & "] ----- EQUIPO [" & equip & "]"
        texteEMail = texteEMail & "<DD><B>VIAJE</B> [" & Viatge & "] <B>EQUIPO</B> [" & equip & "]</DD><BR>"
    End If

    'SE SIRVE POR UNIDADES (Si se sirve por unidades Pack=1 y Minimo=1)
    SirvePorUnidades = False
    Set rs = Db.OpenResultset("Select Valor from ccproveedoresextes with (nolock) where id = '" & Proveedor & "' and nom = 'SirveUnidades' and valor = 'on' ")
    If Not rs.EOF Then If Not IsNull(rs(0)) Then If rs(0) = "on" Then SirvePorUnidades = True
    GuardaHistoricReposicio "", Ara, "REPOSICIO AUTOMATICA NUEVA", proveedorNom, "SIRVE UNIDADES [" & SirvePorUnidades & "]"
    texteEMail = texteEMail & "<DD><B>SIRVE UNIDADES</B> [" & SirvePorUnidades & "]</DD><BR>"
    
    'CUENTA ENCARGOS
    ContemEncarregs = False
    Set rs = Db.OpenResultset("Select Valor from ccproveedoresextes with (nolock) where id = '" & Proveedor & "' and nom = 'siEncargos' and valor = 'on' ")
    If Not rs.EOF Then If Not IsNull(rs(0)) Then If rs(0) = "on" Then ContemEncarregs = True
    GuardaHistoricReposicio "", Ara, "REPOSICIO AUTOMATICA NUEVA", proveedorNom, "CUENTA ENCARGOS [" & ContemEncarregs & "]"
    texteEMail = texteEMail & "<DD><B>CUENTA ENCARGOS</B> [" & ContemEncarregs & "]</DD><BR>"
    
    
    'NO INVENTAR PEDIDO
    noInventar = False
    Set rs = Db.OpenResultset("Select Valor from ccproveedoresextes with (nolock) where id = '" & Proveedor & "' and nom = 'noInventar' and valor = 'on' ")
    If Not rs.EOF Then If Not IsNull(rs(0)) Then If rs(0) = "on" Then noInventar = True
    GuardaHistoricReposicio "", Ara, "REPOSICIO AUTOMATICA NUEVA", proveedorNom, "NO INVENTAR [" & noInventar & "]"
    texteEMail = texteEMail & "<DD><B>NO INVENTAR </B>[" & noInventar & "]</DD><BR>"
    
    'TENER EN CUENTA LA MATERIA PRIMA BASE!!!!!
    sql = "Select m.id materia,c.codi botiga,p.codiarticle codiarticle, m.nombre mnombre,isnull(cc.valor, '99') ordre,c.nom,* "
    sql = sql & "from ccmateriasprimas m with (nolock) "
    sql = sql & "join ccnombrevalor Pr with (nolock) on Pr.valor = '" & Proveedor & "' And m.id=Pr.id and left(Pr.nombre,13) = 'P_REPOSICION_' "
    sql = sql & "join ccnombrevalor b with (nolock) on m.id=b.id and left(b.nombre,11) = 'REPOSICION_' "
    sql = sql & "join Clients c with (nolock) on Pr.nombre = 'P_REPOSICION_' + cast(c.codi  as nvarchar) And b.nombre = 'REPOSICION_' + cast(c.codi  as nvarchar) "
    sql = sql & "left join constantsclient cc on c.codi=cc.codi and cc.variable='OrdreRuta' "
    sql = sql & "join articlespropietats p with (nolock) on p.variable = 'MatPri' and p.valor = m.id "
'!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
sql = sql & "where c.codi in (819) " 'SOLO LA T--091 !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
'!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
    sql = sql & "order by  isnull(cc.valor, '99'), c.nom, m.nombre"
    Set rs = Db.OpenResultset(sql)
'PARA AÑADIR MÁS TIENDAS:
'UPDATE ccnombrevalor SET VALOR='{3D209298-A15C-4CA4-ABB6-38ACB3E5CF05}' where valor='{8AAD58EE-AD28-4A46-9552-0C1DF5B32036}' and nombre='P_REPOSICION_679'
    LastBotiga = ""
    
    While Not rs.EOF
On Error GoTo otro
        BotigaNom = BotigaCodiNom(rs("Botiga"))
        If LastBotiga <> BotigaNom Then
            texteEMail = texteEMail & "<BR><B>BOTIGA " & UCase(BotigaNom) & "</B><BR><BR>"
            
            Set rsPedido = Db.OpenResultset("select isnull(MAX(numPedido), 0) + 1 nPedido from " & NomTaulaPedidosCap())
            numPedido = rsPedido("nPedido")
            
            GuardaHistoricReposicio rs("Botiga"), Ara, "REPOSICIO AUTOMATICA NUEVA", "<b>" & proveedorNom & "</b>", "Número pedido [" & numPedido & "]"
            texteEMail = texteEMail & "Número pedido [" & numPedido & "]<BR>"
        End If
        LastBotiga = BotigaNom
        
        For iC = 0 To UBound(RepCliente)
            If RepCliente(iC) = rs("botiga") Then Exit For
        Next
        If iC > UBound(RepCliente) Then
            ReDim Preserve RepCliente(iC)
            RepCliente(iC) = rs("botiga")
        End If
        
        For iA = 0 To UBound(RepArticle)
            If RepArticle(iA) = rs("codiarticle") Then Exit For
        Next
        If iA > UBound(RepArticle) Then
            ReDim Preserve RepArticle(iA)
            RepArticle(iA) = rs("codiarticle")
        End If
        
        RepPedido(iC, iA) = 0
        
        NomArticle = ArticleCodiNom(rs("codiarticle"))
        GuardaHistoricReposicio rs("Botiga"), Ara, "REPOSICIO AUTOMATICA NUEVA", proveedorNom, "<b>" & NomArticle & "</b>"
        texteEMail = texteEMail & "<DD><B>" & NomArticle & "</B></DD><BR>"
        
        Informa2 BotigaNom & " -- " & NomArticle

        'SOLO UN PEDIDO POR FECHA
        'Se borran todos los pedidos con fecha igual o mayor a hoy de la materia prima y tienda
        rec "insert into " & NomTaulaPedidosZombis() & " select *, getdate(), 'SINCRO' from ccPedidos where fecha >= convert(datetime,'" & Right("0" & Day(Ara), 2) & "/" & Right("0" & Month(Ara), 2) & "/" & Right(CStr(Year(Ara)), 2) & "',3)  And MateriaPrima = '" & rs("materia") & "' And Almacen = 'Client_" & rs("Botiga") & "'"
        ExecutaComandaSql "Delete ccpedidos where fecha >= convert(datetime,'" & Right("0" & Day(Ara), 2) & "/" & Right("0" & Month(Ara), 2) & "/" & Right(CStr(Year(Ara)), 2) & "',3)  And MateriaPrima = '" & rs("materia") & "' And Almacen = 'Client_" & rs("Botiga") & "'"
        ExecutaComandaSql "Delete " & tabPedidosUltimosDatos & " Where  fecha >= convert(datetime,'" & Right("0" & Day(Ara), 2) & "/" & Right("0" & Month(Ara), 2) & "/" & Right(CStr(Year(Ara)), 2) & "',3) And  Materia = '" & rs("materia") & "' and Cliente = '" & rs("Botiga") & "' and Proveedor =  '" & Proveedor & "' and idPedido <> 'Primer pedido automatico' "
        
        'DATOS DEL ÚLTIMO RECALCULO (si no hay datos coge 1 días atras para las fechas y 0 inventados y redondeo)
        'DataUltimaVentaServida --> [PedidosUltimosDatos_[...].FechaUltimaVenta  ----- FECHA DE LA ÚTIMA VENTA (DE CUALQUIER COSA) DE LA TIENDA CUANDO SE HIZO LA ÚLTIMA REPOSICIÓN (SI ES LA PRIMERA REPOSICIÓN SERÁ AYER) ---------
        'His_FechaUltimaVentaNoEncontrada --> [PedidosUltimosDatos_[...].Fecha ------ FECHA DEL ÚLTIMO PEDIDO POR REPOSICIÓN --------
        'His_FechaUltimaDevolucionNoEncontrada --> [PedidosUltimosDatos_[...].FechaUltimaDevolucion ---FECHA DE LA ÚTIMA DEVOLUCIÓN (DE CUALQUIER COSA?) DE LA TIENDA CUANDO SE HIZO LA ÚLTIMA REPOSICIÓN  ---------
        'His_Inventados -> [PedidosUltimosDatos_[...].RedondeoCliente
        'His_Redondeo-> [PedidosUltimosDatos_[...].RedondeoProveedor
        If Not PedidosUltimosDatos_91(rs("materia"), rs("Botiga"), Proveedor, DataUltimaVentaServida, His_FechaUltimaVentaNoEncontrada, His_FechaUltimaDevolucionNoEncontrada, His_Inventados, His_Redondeo) Then
            GuardaHistoricReposicio rs("Botiga"), Ara, "REPOSICIO AUTOMATICA NUEVA", proveedorNom, NomArticle, "<B>Primer Pedido. Cojemos fecha del día en el que se debería haber calculado la útima reposición.<B>"
            texteEMail = texteEMail & "<B>Primer Pedido. Cojemos fecha del día en el que se debería haber calculado la útima reposición.</B><BR>"
        End If
        
        GuardaHistoricReposicio rs("botiga"), Ara, "REPOSICIO AUTOMATICA NUEVA", proveedorNom, NomArticle, "<b>ÚLTIMA REPOSICIÓN</b> [" & His_FechaUltimaVentaNoEncontrada & "]"
        GuardaHistoricReposicio rs("Botiga"), Ara, "REPOSICIO AUTOMATICA NUEVA", proveedorNom, NomArticle, "&nbsp;&nbsp;&nbsp;&nbsp;FECHA ULTIMA VENTA [" & DataUltimaVentaServida & "]"
        GuardaHistoricReposicio rs("botiga"), Ara, "REPOSICIO AUTOMATICA NUEVA", proveedorNom, NomArticle, "&nbsp;&nbsp;&nbsp;&nbsp;FECHA ULTIMA DEVOLUCION [" & His_FechaUltimaDevolucionNoEncontrada & "]"
        GuardaHistoricReposicio rs("Botiga"), Ara, "REPOSICIO AUTOMATICA NUEVA", proveedorNom, NomArticle, "&nbsp;&nbsp;&nbsp;&nbsp;UNIDADES INVENTADAS = " & His_Inventados & ""
        'GuardaHistoricReposicio rs("Botiga"), Ara, "REPOSICIO AUTOMATICA NUEVA", proveedorNom, NomArticle, "His_Redondeo [" & His_Redondeo & "]"
        texteEMail = texteEMail & "DataUltimaVentaServida [" & DataUltimaVentaServida & "]<br>His_FechaUltimaVentaNoEncontrada [" & His_FechaUltimaVentaNoEncontrada & "]<br>His_FechaUltimaDevolucionNoEncontrada [" & His_FechaUltimaDevolucionNoEncontrada & "]<br>His_Inventados [" & His_Inventados & "]<br>His_Redondeo [" & His_Redondeo & "]<Br><br>"
        
        'FECHA ÚLTIMA VENTA QUE SE HIZO EN LA TIENDA (DE CUALQUIER PRODUCTO). SI NO ENCUETRA EN LOS ÚLTIMOS 2 MESES DEVUELVE -7 DÍAS
        DataUltimaVenta = DataUltimaVentaBusca_91(rs("Botiga"), Ara)
        GuardaHistoricReposicio rs("botiga"), Ara, "REPOSICIO AUTOMATICA NUEVA", proveedorNom, NomArticle, "<b>CÁLCULO REPOSICIÓN</b>"
        GuardaHistoricReposicio rs("Botiga"), Ara, "REPOSICIO AUTOMATICA NUEVA", proveedorNom, NomArticle, "<B>&nbsp;&nbsp;&nbsp;&nbsp;VENTAS</B>"
        GuardaHistoricReposicio rs("Botiga"), Ara, "REPOSICIO AUTOMATICA NUEVA", proveedorNom, NomArticle, "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FECHA ÚLTIMA VENTA [" & DataUltimaVenta & "]"
        texteEMail = texteEMail & "DataUltimaVenta [" & DataUltimaVenta & "]<Br>"
       
        'Ventas del artículo desde la fecha de la útima reposición (His_FechaUltimaVentaNoEncontrada) hasta la fecha de la útima venta (DataUltimaVenta)
        consumoPersonal = PedidoCuantosFaltan_91(rs("codiarticle"), rs("Botiga"), His_FechaUltimaVentaNoEncontrada, DataUltimaVenta, True)
        CalDemanar = PedidoCuantosFaltan_91(rs("codiarticle"), rs("Botiga"), His_FechaUltimaVentaNoEncontrada, DataUltimaVenta)
       
        GuardaHistoricReposicio rs("Botiga"), Ara, "REPOSICIO AUTOMATICA NUEVA", proveedorNom, NomArticle, "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VENTAS DESDE ÚLTIMA REPOSICIÓN [" & His_FechaUltimaVentaNoEncontrada & "] HASTA ÚLTIMA VENTA [" & DataUltimaVenta & "] = <B>" & CalDemanar & "</B>"
        GuardaHistoricReposicio rs("Botiga"), Ara, "REPOSICIO AUTOMATICA NUEVA", proveedorNom, NomArticle, "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CONSUMO PERSONAL DESDE ÚLTIMA REPOSICIÓN [" & His_FechaUltimaVentaNoEncontrada & "] HASTA ÚLTIMA VENTA [" & DataUltimaVenta & "] = " & consumoPersonal

        texteEMail = texteEMail & "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VENTAS DESDE ÚLTIMA REPOSICIÓN [" & His_FechaUltimaVentaNoEncontrada & "] HASTA ÚLTIMA VENTA [" & DataUltimaVenta & "] = <B>" & CalDemanar & "</B><BR>"
        texteEMail = texteEMail & "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CONSUMO PERSONAL DESDE ÚLTIMA REPOSICIÓN [" & His_FechaUltimaVentaNoEncontrada & "] HASTA ÚLTIMA VENTA [" & DataUltimaVenta & "] = " & consumoPersonal & "<BR>"
                
        'Pedidos no servidos (en el útimo pedido)
        demanatNOServit = PedidoNOServido_91(rs("codiarticle"), rs("botiga"), His_FechaUltimaVentaNoEncontrada, DataUltimaVenta)
        CalDemanar = CalDemanar + demanatNOServit
        GuardaHistoricReposicio rs("Botiga"), Ara, "REPOSICIO AUTOMATICA NUEVA", proveedorNom, NomArticle, "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PEDIDOS NO SERVIDOS DESDE ÚLTIMA REPOSICIÓN [" & His_FechaUltimaVentaNoEncontrada & "] HASTA ÚLTIMA VENTA [" & DataUltimaVenta & "] = " & demanatNOServit
        
        'Intervalo de tickets Ut (primer ticket) Pt (último ticket) Nt (número de tickets)
        PedidoCuantosFaltanNumTicks_91 rs("codiarticle"), rs("Botiga"), His_FechaUltimaVentaNoEncontrada, DataUltimaVenta, Ut, Pt, Nt
        GuardaHistoricReposicio rs("Botiga"), Ara, "REPOSICIO AUTOMATICA NUEVA", proveedorNom, NomArticle, "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PRIMER TIQUET [" & Ut & "] ULTIM TIQUET [" & Pt & "] NUMERO TIQUETS [" & Nt & "] (" & Abs(Ut - Pt) & ")"
        texteEMail = texteEMail & "PRIMER TIQUET [" & Ut & "] ULTIM TIQUET [" & Pt & "] NUMERO TIQUETS [" & Nt & "] (" & Abs(Ut - Pt) & ")<br>"
        
        'Fecha última devolución
        DataUltimaDevolucio = DataUltimaDevolucioBusca_91(rs("Botiga"), Ara)
        GuardaHistoricReposicio rs("Botiga"), Ara, "REPOSICIO AUTOMATICA NUEVA", proveedorNom, NomArticle, "<B>&nbsp;&nbsp;&nbsp;&nbsp;DEVOLUCIONES</B>"
        GuardaHistoricReposicio rs("Botiga"), Ara, "REPOSICIO AUTOMATICA NUEVA", proveedorNom, NomArticle, "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FECHA ULTIMA DEVOLUCIÓN [" & DataUltimaDevolucio & "]"
        texteEMail = texteEMail & "FECHA ULTIMA DEVOLUCION [" & DataUltimaDevolucio & "]<br>"
        
        'ENCARRECS PER ACABAR
        Encarregs = 0
        If ContemEncarregs Then
            Encarregs = EncarregatsServits_91(rs("codiarticle"), rs("Botiga"), His_FechaUltimaVentaNoEncontrada, DataUltimaVenta)
            GuardaHistoricReposicio rs("Botiga"), Ara, "REPOSICIO AUTOMATICA NUEVA", proveedorNom, NomArticle, "&nbsp;&nbsp;&nbsp;<B>ENCARRECS</B> Servits desde [" & His_FechaUltimaVentaNoEncontrada & "] Hasta [" & DataUltimaVenta & "] = <b>" & Encarregs & "</b>"
            texteEMail = texteEMail & "<B>ENCARRECS</B> Servits desde [" & His_FechaUltimaVentaNoEncontrada & "] Hasta [" & DataUltimaVenta & "] = <b>" & Encarregs & "<b><br>"
        End If
        '~ENCARRECS PER ACABAR ********************
        
        'Devoluciones del producto desde His_FechaUltimaDevolucionNoEncontrada hasta DataUltimaDevolucio
        CalDemanarDev = PedidoCuantosFaltanDevolucion_91(rs("codiarticle"), rs("Botiga"), His_FechaUltimaDevolucionNoEncontrada, DataUltimaDevolucio)
        GuardaHistoricReposicio rs("Botiga"), Ara, "REPOSICIO AUTOMATICA NUEVA", proveedorNom, NomArticle, "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DEVOLUCIONES DESDE ÚTIMA REPOSICIÓN [" & His_FechaUltimaDevolucionNoEncontrada & "] HASTA ÚLTIMA DEVOLUCIÓN [" & DataUltimaDevolucio & "] = <b> " & CalDemanarDev & "</b>"
        texteEMail = texteEMail & "<B>DEVOLUCIONS</B> desde [" & His_FechaUltimaDevolucionNoEncontrada & "] Hasta [" & DataUltimaDevolucio & "] = <b> " & CalDemanarDev & "</b><br>"
        
        'DE MOMENTO NO TENEMOS EN CUENTA LA DEVOLUCIÓN
        'GuardaHistoricReposicio rs("Botiga"), Ara, "REPOSICIO AUTOMATICA NUEVA", proveedorNom, NomArticle, "&nbsp;&nbsp;&nbsp;<B>CalDemanar = CalDemanar + CalDemanarDev - Encarregs = " & CalDemanar & " + " & CalDemanarDev & " - " & Encarregs & " = " & CalDemanar + CalDemanarDev - Encarregs & "</b>"
        'texteEMail = texteEMail & "<B>CalDemanar = CalDemanar + CalDemanarDev - Encarregs</B> = <b> " & CalDemanar & "</b><br>"
        'CalDemanar = CalDemanar + CalDemanarDev - Encarregs
        
        GuardaHistoricReposicio rs("Botiga"), Ara, "REPOSICIO AUTOMATICA NUEVA", proveedorNom, NomArticle, "&nbsp;&nbsp;&nbsp;<B>PEDIDO = " & CalDemanar & "</b>"
        
        'INVENTOS **************************
        UnitatsInventades = 0
        If Not noInventar Then 'El proveedor está configurado para permitir inventar
            'Nos inventamos los datos del trocito que falte DE ATRAS HASTA AHORA calculando las ventas de la semana pasada
            D1 = DateAdd("d", -7, DataUltimaVenta)
            D2 = DateAdd("d", -7, Ara)
            
            UnitatsInventades = PedidoCuantosFaltan_91(rs("codiarticle"), rs("Botiga"), D1, D2)
            GuardaHistoricReposicio rs("Botiga"), Ara, "REPOSICIO AUTOMATICA NUEVA", proveedorNom, NomArticle, "<B>PREVISIÓN (INVENTOS)</B>"
            GuardaHistoricReposicio rs("Botiga"), Ara, "REPOSICIO AUTOMATICA NUEVA", proveedorNom, NomArticle, "&nbsp;&nbsp;&nbsp;&nbsp;Ventas desde [" & D1 & "] Hasta [" & D2 & "] = <b>" & UnitatsInventades & "<b>"
            GuardaHistoricReposicio rs("Botiga"), Ara, "REPOSICIO AUTOMATICA NUEVA", proveedorNom, NomArticle, "&nbsp;&nbsp;&nbsp;&nbsp;<b>Inventados = " & UnitatsInventades & "</b>"
            texteEMail = texteEMail & "<B>Inventados </B> desde [" & D1 & "] Hasta [" & D2 & "] = <b>" & UnitatsInventades & "</b><br>"
            
        End If
        '~INVENTOS **************************
        
        'CORREGIMOS INVENTOS DE LA ÚTIMA REPOSICIÓN
        'Ventas del artículo desde la fecha DataUltimaVentaServida hasta His_FechaUltimaVentaNoEncontrada
        ErrorInventosAnteriores = PedidoCuantosFaltan_91(rs("codiarticle"), rs("Botiga"), DataUltimaVentaServida, His_FechaUltimaVentaNoEncontrada)
        stockBotiga = PedidoCuantosFaltan_91(rs("codiarticle"), rs("Botiga"), DateSerial(Year(His_FechaUltimaVentaNoEncontrada), Month(His_FechaUltimaVentaNoEncontrada), Day(His_FechaUltimaVentaNoEncontrada)) + TimeSerial(Hour(His_FechaUltimaVentaNoEncontrada), 0, 0), DateSerial(Year(His_FechaUltimaVentaNoEncontrada), Month(Now()), Day(His_FechaUltimaVentaNoEncontrada)) + TimeSerial(Hour(His_FechaUltimaVentaNoEncontrada), 59, 59), True)
        GuardaHistoricReposicio rs("Botiga"), Ara, "REPOSICIO AUTOMATICA NUEVA", proveedorNom, NomArticle, "&nbsp;&nbsp;&nbsp;&nbsp;<b>RECTIFICACIÓN ÚLTIMA PREVISIÓN</b>"
        GuardaHistoricReposicio rs("Botiga"), Ara, "REPOSICIO AUTOMATICA NUEVA", proveedorNom, NomArticle, "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;En la última reposición me inventé [" & His_Inventados & "]"
        GuardaHistoricReposicio rs("Botiga"), Ara, "REPOSICIO AUTOMATICA NUEVA", proveedorNom, NomArticle, "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Ventas reales desde [" & DataUltimaVentaServida & "] Hasta [" & His_FechaUltimaVentaNoEncontrada & "] = <b>" & ErrorInventosAnteriores & "</b>"
        GuardaHistoricReposicio rs("Botiga"), Ara, "REPOSICIO AUTOMATICA NUEVA", proveedorNom, NomArticle, "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;STOCK PEDIDO EN TIENDA POR CONSUMO PERSONAL (" & DateSerial(Year(His_FechaUltimaVentaNoEncontrada), Month(His_FechaUltimaVentaNoEncontrada), Day(His_FechaUltimaVentaNoEncontrada)) + TimeSerial(Hour(His_FechaUltimaVentaNoEncontrada), 0, 0) & "-" & DateSerial(Year(His_FechaUltimaVentaNoEncontrada), Month(Now()), Day(His_FechaUltimaVentaNoEncontrada)) + TimeSerial(Hour(His_FechaUltimaVentaNoEncontrada), 59, 59) & ") = " & stockBotiga
        texteEMail = texteEMail & "&nbsp;&nbsp;&nbsp;&nbsp;<b>RECTIFICACIÓN ÚLTIMA PREVISIÓN</b><br>"
        texteEMail = texteEMail & "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;En la última reposición me inventé [" & His_Inventados & "]<br>"
        texteEMail = texteEMail & "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Ventas reales desde [" & DataUltimaVentaServida & "] Hasta [" & His_FechaUltimaVentaNoEncontrada & "] = <b>" & ErrorInventosAnteriores & "</b><br>"
        texteEMail = texteEMail & "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;STOCK PEDIDO EN TIENDA POR CONSUMO PERSONAL = " & stockBotiga & "<br>"

        GuardaHistoricReposicio rs("Botiga"), Ara, "REPOSICIO AUTOMATICA NUEVA", proveedorNom, NomArticle, "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ME INVENTÉ " & His_Inventados & " PERO REALMENTE VENDÍ " & ErrorInventosAnteriores & " Y ME HAN PEDIDO " & stockBotiga
        texteEMail = texteEMail & "<b>ME INVENTÉ " & His_Inventados & " PERO REALMENTE VENDÍ " & ErrorInventosAnteriores & "</B><BR>"
        ErrorInventosAnteriores = (ErrorInventosAnteriores - His_Inventados)
        If stockBotiga > 0 Then
            ErrorInventosAnteriores = ErrorInventosAnteriores + (stockBotiga - ErrorInventosAnteriores)
            GuardaHistoricReposicio rs("Botiga"), Ara, "REPOSICIO AUTOMATICA NUEVA", proveedorNom, NomArticle, "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Añadimos " & (stockBotiga - ErrorInventosAnteriores) & " para ajustar inventario " & (stockBotiga - ErrorInventosAnteriores) & " = (" & stockBotiga & "-" & ErrorInventosAnteriores & ") <br>"
            texteEMail = texteEMail & "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Añadimos " & (stockBotiga - ErrorInventosAnteriores) & " para ajustar inventario " & (stockBotiga - ErrorInventosAnteriores) & " = (" & stockBotiga & "-" & ErrorInventosAnteriores & ") <br>"
        End If
        
        
        If Abs(ErrorInventosAnteriores) > 0 Then
            GuardaHistoricReposicio rs("Botiga"), Ara, "REPOSICIO AUTOMATICA NUEVA", proveedorNom, NomArticle, "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>Rectificación " & ErrorInventosAnteriores & "</b>"
            texteEMail = texteEMail & "<b>Arreglem error inventats anterior en</b> " & ErrorInventosAnteriores & "<br>"
        End If
        
        '~CONSUPO PERSONAL **************************
        
        
        
        CalDemanarArodonit = 0
        
        'SE HACE EL PEDIDO, SI ES NECESARIO
        If (CalDemanar + UnitatsInventades + His_Redondeo + ErrorInventosAnteriores) > 0 Then
        
            GuardaHistoricReposicio rs("Botiga"), Ara, "REPOSICIO AUTOMATICA NUEVA", proveedorNom, NomArticle, "<b>HAY PEDIDO</b>"
            texteEMail = texteEMail & "<b>HAY PEDIDO</b><br>"
            
            If SirvePorUnidades Then
                Pack = 1
                Minimo = 1
            Else
                Set rs2 = Db.OpenResultset("Select unidades,UnidadesEnvio from ccmateriasprimas with (nolock) where id ='" & rs("materia") & "' ")
                
                If Not rs2.EOF Then If Not IsNull(rs2("Unidades")) Then Pack = rs2("Unidades")
                If Pack = 0 Then Pack = 1
                
                If Not rs2.EOF Then If Not IsNull(rs2("UnidadesEnvio")) Then Minimo = rs2("UnidadesEnvio")
                If Minimo = 0 Then Minimo = 1
            End If
            
            GuardaHistoricReposicio rs("Botiga"), Ara, "REPOSICIO AUTOMATICA NUEVA", proveedorNom, NomArticle, "&nbsp;&nbsp;&nbsp;&nbsp;Pack [" & Pack & "] Minimo [" & Minimo & "]  (Pack * Minimo) = [" & (Pack * Minimo) & "]"
            texteEMail = texteEMail & "<b>PEDIDO</b> Pack [" & Pack & "] Minimo [" & Minimo & "]  (Pack * Minimo) = [" & (Pack * Minimo) & "]<br>"
            
            Limite = (Pack * Minimo)
            If Minimo = 1 And Pack > 5 Then Limite = Int(Limite * 0.9)
            
            If (CalDemanar + UnitatsInventades + His_Redondeo + ErrorInventosAnteriores) >= Limite Then
                CalDemanarArodonit = Int((CalDemanar + UnitatsInventades + His_Redondeo + ErrorInventosAnteriores) / (Pack * Minimo)) * (Pack * Minimo)
                GuardaHistoricReposicio rs("Botiga"), Ara, "REPOSICIO AUTOMATICA NUEVA", proveedorNom, NomArticle, "&nbsp;&nbsp;&nbsp;&nbsp;Per Propera comanda guardem : " & ((CalDemanar + UnitatsInventades + His_Redondeo + ErrorInventosAnteriores) - CalDemanarArodonit)
                GuardaHistoricReposicio rs("Botiga"), Ara, "REPOSICIO AUTOMATICA NUEVA", proveedorNom, NomArticle, "&nbsp;&nbsp;&nbsp;&nbsp;<B>PEDIDO A PROVEEDOR = " & CalDemanar & "+" & UnitatsInventades & "+" & ErrorInventosAnteriores & "</B>"
                GuardaHistoricReposicio rs("Botiga"), Ara, "REPOSICIO AUTOMATICA NUEVA", proveedorNom, NomArticle, "&nbsp;&nbsp;&nbsp;&nbsp;<B>PEDIDO A PROVEEDOR = " & CalDemanarArodonit & "</B>"
                texteEMail = texteEMail & "<b>PEDIDO [" & CalDemanarArodonit & "]</b> Per Propera comanda guardem : " & ((CalDemanar + UnitatsInventades + His_Redondeo + ErrorInventosAnteriores) - CalDemanarArodonit) & "<br>"
                
                Set rs2 = Db.OpenResultset("Select NewId() ")
                IdP = rs2(0)
                
                'GuardaHistoricReposicio Rs("Botiga"), Ara, "REPOSICIO AUTOMATICA NUEVA", proveedorNom, NomArticle, "PEDIDO -> IdPedido : " & IdP
                texteEMail = texteEMail & "PEDIDO = IdPedido : " & IdP & "<br>"

                precio = 0
                Set rsPreu = Db.OpenResultset("select precio from ccmateriasprimas with (nolock) where id = '" & rs("Materia") & "'")
                If Not rsPreu.EOF Then
                    If Left(rsPreu("precio"), 1) = "." Then
                        precio = CDbl("0" & rsPreu("precio"))
                    Else
                        precio = rsPreu("precio")
                    End If
                End If
                
                sql = "Insert into ccPedidos(Id,materiaPrima,proveedor,almacen,precio,cantidad,fecha,recepcion) "
                
                CalDemanarEnPacks = CalDemanarArodonit
                If Pack > 1 Then CalDemanarEnPacks = Int(CalDemanarArodonit / Pack)
                
                sql = sql & "values('" & IdP & "','" & rs("Materia") & "','" & Proveedor & "','Client_" & rs("Botiga") & "'," & precio & "," & CalDemanarEnPacks & ",convert(datetime,'" & Now() & "',103),convert(datetime,'" & DateAdd("d", 1, Now()) & "',103))"
                ExecutaComandaSql sql
                
On Error GoTo sigue
                ExecutaComandaSql "insert into " & NomTaulaPedidosCap() & " (numPedido, idPedido, proveedor, almacen, fecha, recepcion) values (" & numPedido & ", '" & IdP & "', '" & Proveedor & "', 'Client_" & rs("Botiga") & "', convert(datetime,'" & Now() & "',103), convert(datetime,'" & Now() & "',103))"
sigue:
                RepPedido(iC, iA) = CalDemanarEnPacks
                
                If ChatUser > 0 Then ExecutaComandaSql "Insert Into " & NomTaulaSecreAvisosTxt & " (Tipus,usuari,lliure1) Values ('Pedido','" & ChatUser & "','Article -> " & NomArticle & " Servir :" & CalDemanarArodonit & " Unitats')"
                
                sql = "Insert into " & tabPedidosUltimosDatos
                sql = sql & " ([IdPedido],[Proveedor],[Materia],[Cliente],[Fecha],[RedondeoProveedor],[RedondeoCliente],[FechaUltimaVenta],[FechaUltimaDevolucion])  "
                sql = sql & " Values ("
                sql = sql & " '" & IdP & "',"
                sql = sql & " '" & Proveedor & "',"
                sql = sql & " '" & rs("Materia") & "',"
                sql = sql & " '" & rs("Botiga") & "',"
                sql = sql & " convert(datetime,'" & Ara & "',103),"
                sql = sql & " '" & ((CalDemanar + UnitatsInventades + His_Redondeo + ErrorInventosAnteriores) - CalDemanarArodonit) & "',"
                sql = sql & " '" & UnitatsInventades & "',"
                sql = sql & " convert(datetime,'" & DataUltimaVenta & "',103), "
                sql = sql & " convert(datetime,'" & DataUltimaDevolucio & "',103) "
                sql = sql & " ) "
                ExecutaComandaSql sql
                
            Else
                GuardaHistoricReposicio rs("Botiga"), Ara, "REPOSICIO AUTOMATICA NUEVA", proveedorNom, NomArticle, "<b>NO HAY PEDIDO</b> (CalDemanar + UnitatsInventades + His_Redondeo + ErrorInventosAnteriores) <= Limite , " & (CalDemanar + UnitatsInventades + His_Redondeo + ErrorInventosAnteriores) & "<" & Limite
                texteEMail = texteEMail & "<B>NO HAY PEDIDO</B> (CalDemanar + UnitatsInventades + His_Redondeo + ErrorInventosAnteriores) <= Limite , " & (CalDemanar + UnitatsInventades + His_Redondeo + ErrorInventosAnteriores) & "<" & Limite & "<br>"
            End If
            
        Else
            GuardaHistoricReposicio rs("Botiga"), Ara, "REPOSICIO AUTOMATICA NUEVA", proveedorNom, NomArticle, "<b>NO HAY PEDIDO</b> (CalDemanar + UnitatsInventades + His_Redondeo + ErrorInventosAnteriores) <= 0 , " & (CalDemanar + UnitatsInventades + His_Redondeo + ErrorInventosAnteriores) & "<=0"
            texteEMail = texteEMail & "<B>NO HAY PEDIDO</B> (CalDemanar + UnitatsInventades + His_Redondeo + ErrorInventosAnteriores) <= Limite , " & (CalDemanar + UnitatsInventades + His_Redondeo + ErrorInventosAnteriores) & "<=" & Limite & "<br>"
            
        End If
        
        'SI ES PRODUCCIÓN PROPIA PASAMOS EL PEDIDO A LA GRAELLA
        If ProduccionPropia Then
            GuardaHistoricReposicio rs("Botiga"), Ara, "REPOSICIO AUTOMATICA NUEVA", proveedorNom, NomArticle, "<B>PRODUCCIO PROPIA</B>"

            quantitatServida = 0
            Set rs2 = Db.OpenResultset("Select Sum(QuantitatServida) Qs From [" & DonamNomTaulaServit(DateAdd("d", 1, Now())) & "] with (nolock) Where Client = " & rs("Botiga") & " And CodiArticle = " & rs("codiarticle") & " ")
            If Not rs2.EOF Then If Not IsNull(rs2(0)) Then quantitatServida = rs2(0)
            
            GuardaHistoricReposicio rs("Botiga"), Ara, "REPOSICIO AUTOMATICA NUEVA", proveedorNom, NomArticle, "&nbsp;&nbsp;&nbsp;&nbsp;SERVIDO HASTA " & Format(DateAdd("d", 1, Now()), "dd/mm/yyyy") & " = " & quantitatServida & " VENDIDO = " & (CalDemanar + UnitatsInventades + His_Redondeo + ErrorInventosAnteriores) & " <B>PEDIDO = " & CalDemanarArodonit & "</B>"
            texteEMail = texteEMail & "<B>PRODUCCIO PROPIA</B> Fins ara Servits = " & quantitatServida & " Ara Ventas = " & (CalDemanar + UnitatsInventades + His_Redondeo + ErrorInventosAnteriores) & " Comanda de  = " & CalDemanarArodonit & "<br>"
            
            ExecutaComandaSql "Update [" & DonamNomTaulaServit(DateAdd("d", 1, Now())) & "] Set QuantitatDemanada = 0 ,QuantitatServida = 0 Where Client = " & rs("Botiga") & " And CodiArticle = " & rs("codiarticle") & " And  Viatge = '" & Viatge & "' And Equip = '" & equip & "' And Comentari like '%Reposicio%' "
            ExecutaComandaSql "Delete [" & DonamNomTaulaServit(DateAdd("d", 1, Now())) & "] Where QuantitatDemanada = 0 And Client = " & rs("Botiga") & " And CodiArticle = " & rs("codiarticle") & " And Comentari like '%Reposicio%'  "
            If CalDemanarArodonit > 0 Then
                GuardaHistoricReposicio rs("Botiga"), Ara, "REPOSICIO AUTOMATICA NUEVA", proveedorNom, NomArticle, "&nbsp;&nbsp;&nbsp;&nbsp;<B>HACEMOS PEDIDO EN GRAELLA</B> " & Format(DateAdd("d", 1, Now()), "dd/mm/yyyy") & " UNIDADES  " & CalDemanarArodonit & " VIAJE = [" & Viatge & "] EQUIPO = [" & equip & "]"
                texteEMail = texteEMail & "<B>PRODUCCIO PROPIA</B> FemComanda " & Format(DateAdd("d", 1, Ara), "dd-mm-yyyy") & " Unitats  " & CalDemanarArodonit & " Viatge = [" & Viatge & "] Equip : [" & equip & "]<br>"
                
                sql = "Insert Into [" & DonamNomTaulaServit(DateAdd("d", 1, Now())) & "] "
                sql = sql & "(Client,CodiArticle,QuantitatDemanada,QuantitatServida,Comentari,PluUtilitzat,Viatge,Equip,MotiuModificacio,Hora,TipusComanda,ComentariPer,Atribut) "
                sql = sql & " Values ("
                sql = sql & " " & rs("Botiga") & " , "
                sql = sql & " " & rs("codiarticle") & " , "
                sql = sql & " '" & CalDemanarArodonit & "' , "
                sql = sql & " '" & CalDemanarArodonit & "' , "
                sql = sql & " '[Reposicio:" & UnitatsInventades & "]', "
                sql = sql & " " & rs("codiarticle") & " , "
                sql = sql & " '" & Viatge & "' , "
                sql = sql & " '" & equip & "' , "
                sql = sql & " '' , "
                sql = sql & " 95 , "
                sql = sql & " 1 , "
                sql = sql & " '' , "
                sql = sql & " 0 ) "
                
                StErr = ""
                OK = ExecutaComandaSql(sql, StErr)
                If Not OK Then
                    GuardaHistoricReposicio rs("Botiga"), Ara, "REPOSICIO AUTOMATICA NUEVA", proveedorNom, NomArticle, "<B>FemComanda Reintento</B>"
                    texteEMail = texteEMail & "<b>PRODUCCIO PROPIA</b> FemComanda Reintento<br>"
                    
                    StErr = ""
                    OK = ExecutaComandaSql(sql, StErr)
                    If Not OK Then
                        GuardaHistoricReposicio rs("Botiga"), Ara, "REPOSICIO AUTOMATICA NUEVA", proveedorNom, NomArticle, "<B>PEDIDO HECHO " & OK & "  " & StErr & "</B>"
                        texteEMail = texteEMail & "<b>PRODUCCIO PROPIA</b> FemComanda " & OK & "  " & StErr & "<br>"
                    End If
                End If
                GuardaHistoricReposicio rs("Botiga"), Ara, "REPOSICIO AUTOMATICA NUEVA", proveedorNom, NomArticle, "<B>PEDIDO HECHO " & OK & " " & StErr & "</B>"
                texteEMail = texteEMail & "<b>PRODUCCIO PROPIA</b> FemComanda " & OK & "  " & StErr & "<br>"
                texteEMail = texteEMail & ""
            End If
        End If
        
        texteEMail = texteEMail & "<Br>"
        
otro:
        rs.MoveNext
    Wend
    
    GuardaHistoricReposicio "", Ara, "REPOSICIO AUTOMATICA NUEVA", proveedorNom, "--------------------- FIN REPARTO " & UCase(proveedorNom) & "---------------------"
    
    texteEMail = texteEMail & String(50, "-") & "<Br>"
    texteEMail = texteEMail & "<B>Fin Pedido " & Now & "</B><Br>"
    
    If ChatUser > 0 Then ExecutaComandaSql "Insert Into " & NomTaulaSecreAvisosTxt & " (Tipus,usuari,lliure1) Values ('Pedido','" & ChatUser & "','Fin Pedido (" & DataUltimaVenta & ")')"

'ENVIAMOS EMAIL AL RESPONSABLE DE LA REPOSICIÓN -------------------------------------------------------------------------------------------------------------------------------
On Error GoTo posna

    'sf_enviarMail "Secrehit@gmail.com", "ana@solucionesit365.com", Format(Now, "dddd dd ") & "REPOSICIO AUTOMÀTICA a " & proveedorNom & " " & DateDiff("n", TexteEmailHi, Now) & " n. ", texteEMail, "", ""
    
    If Not EmailAvissos() = "" Then sf_enviarMail "Secrehit@gmail.com", EmailAvissos(), Format(Now, "dddd dd ") & "REPOSICIO AUTOMÀTICA a " & proveedorNom & " " & DateDiff("n", TexteEmailHi, Now) & " n. ", texteEMail, "", ""
    
    Set rs = Db.OpenResultset("Select eMail,via from ccproveedores with (nolock) where id = '" & Proveedor & "' ")
    If Not rs.EOF Then
        If Not IsNull(rs("VIA")) Then
            If rs("Via") = "EMAIL" Then
                If Len(rs("eMail")) > 0 Then
                    If InStr(rs("eMail"), "@") > 0 Then
                        MyKill AppPath & "\DetallCalcul.html"
                        'TexteEmail
                        Dim f
                        f = FreeFile
                        Open AppPath & "\DetallCalcul.html" For Output As #f
                        Print #f, texteEMail
                        Close #f
                        
                        texteEMail = ""
                        texteEMail = texteEMail & "<H><b> Comanda Per " & proveedorNom & " </b></H>"
                        texteEMail = texteEMail & "<Table border=1 ><Tr><Td style='width:20%;'><b>Producte</b></Td><Td style='width:30%;'><b>Total</b></Td>"
                        For iA = 1 To UBound(RepCliente)
                            texteEMail = texteEMail & "<Td style='width:20%;'><b>" & BotigaCodiNom(RepCliente(iA)) & "</b></Td>"
                        Next
                        texteEMail = texteEMail & "</Tr>"
                        For ip = 1 To UBound(RepArticle)
                            accIp = 0
                            textePart = ""
                            For iA = 1 To UBound(RepCliente)
                                If UBound(RepPedido, 1) >= iA And UBound(RepPedido, 2) >= ip Then
'                                    Debug.Print RepPedido(iA, iP)
                                    accIp = accIp + RepPedido(iA, ip)
                                    textePart = textePart & "<Td>" & IIf(RepPedido(iA, ip) = 0, "", RepPedido(iA, ip)) & "</Td>"
                                End If
                            Next
                            texteEMail = texteEMail & "<Tr><Td>" & ArticleCodiNom(RepArticle(ip)) & "</Td><Td>" & Format(accIp, "#.00") & "</Td>" & textePart & "</Tr>"
                        Next
                        texteEMail = texteEMail & "</Table>" & "<Br>"
                        'sf_enviarMail "Secrehit@gmail.com", "ana@solucionesit365.com", Format(Now, "dddd dd ") & "REPOSICIO AUTOMÀTICA a " & proveedorNom & " " & DateDiff("n", TexteEmailHi, Now) & " n. ", TexteEmail, AppPath & "\DetallCalcul.html", ""
                        sf_enviarMail "Secrehit@gmail.com", rs("eMail"), Format(Now, "dddd dd ") & "REPOSICIO AUTOMÀTICA a " & proveedorNom & " " & DateDiff("n", TexteEmailHi, Now) & " n. ", texteEMail, "", AppPath & "\DetallCalcul.html"
                        MyKill AppPath & "\DetallCalcul.html"
                   End If
                End If
            End If
        End If
    End If
posna:

End Sub

Sub PedidoCalcula_V2(Proveedor As String, horas As Double, ChatUser As Double)
'A- VENTAS DESDE FECHA ÚLTIMA REPOSICIÓN HASTA AHORA.
'B- ME INVENTO VENTAS DE LO QUE FALTA DE TARDE, CONTANDO LAS DE LA SEMANA PASADA (PORQUE LAS DE HOY AÚN NO LAS SÉ).
'C- PARA ARREGLAR ERRORES DE INVENTOS:
'    d - TENGO GUARDADO LO QUE ME INVENTÉ AYER
'    e - LAS VENTAS REALES AYER
'    c = e - D
'A + B + C = ES LO QUE HAY QUE PEDIR

    Dim Ara As Date
    Dim texteEMail As String, TexteEmailHi As Date
    Dim tabPedidosUltimosDatos As String
    Dim proveedorNom As String
    
    Dim RepPedido() As Double, RepCliente() As Double, RepArticle() As Double
    ReDim RepPedido(1000, 1000)
    ReDim RepCliente(0)
    ReDim RepArticle(0)
    
    Dim iC As Integer, iA As Integer
    
    Dim ProduccionPropia As Boolean, Viatge As String, equip As String
    Dim SirvePorUnidades As Boolean, Pack As Integer, Minimo As Integer, Limite As Integer
    Dim ContemEncarregs As Boolean, Encarregs As Double
    Dim AnticipaComanda As String
    Dim noInventar As Boolean, UnitatsInventades As Double, UnitatsInventadesTarda As Double
    
    Dim rs As rdoResultset, rs2 As rdoResultset
    
    Dim LastBotiga As String, BotigaNom As String
    
    Dim rsPedido As rdoResultset, numPedido As String
    
    Dim NomArticle As String
    
    Dim DataUltimaVentaServida As Date, DataUltimaVenta As Date, DataUltimaDevolucio As Date
    Dim His_FechaUltimaVentaNoEncontrada As Date, His_FechaUltimaDevolucionNoEncontrada As Date, His_Inventados As Integer, His_Redondeo As Integer
    
    Dim CalDemanar As Double, CalDemanarArodonit As Integer, CalDemanarEnPacks As Double, CalDemanarDev As Double
    Dim consumoPersonal As Double
    Dim demanatNOServit As Double
    Dim stockBotiga As Double
    
    Dim Ut As Double, Pt As Double, Nt As Double
    
    Dim sql As String, IdP As String, StErr As String
    Dim quantitatServida As Double, D1 As Date, D2 As Date
    Dim ErrorInventosAnteriores As Double, rsPreu As rdoResultset, rsInv As rdoResultset, precio As Double, OK As Boolean
    Dim ip As Integer, accIp As Double, textePart As String
    
    Dim hayVentas As Boolean
    
    proveedorNom = ProveedorCodiNom(Proveedor)
    
    Informa "Pedido " & proveedorNom
    
    'Para poner en el email cuanto ha tardado el cálculo del pedido
    TexteEmailHi = Now
   
    If ChatUser > 0 Then ExecutaComandaSql "Insert Into " & NomTaulaSecreAvisosTxt & " (Tipus,usuari,lliure1) Values ('Pedido','" & ChatUser & "','Inicio Pedido')"
        
    GuardaHistoricReposicio "", Now, "REPOSICIO AUTOMATICA NUEVA", "---------------------" & UCase(proveedorNom) & "---------------------"
    texteEMail = "<B>Inicio Pedido Para  [" & UCase(proveedorNom) & "] iniciada a les : " & TexteEmailHi & "</B><BR><BR>"
    
    'ANTICIPA COMANDA
    AnticipaComanda = "10H"
    Set rs = Db.OpenResultset("Select Valor from ccproveedoresextes with (nolock) where id = '" & Proveedor & "' and nom = 'AnticipaComanda' ")
    If Not rs.EOF Then If Not IsNull(rs("Valor")) Then AnticipaComanda = rs("Valor")
    
    If InStr(AnticipaComanda, "H") Then
        If IsNumeric(Replace(AnticipaComanda, "H", "")) Then
            Ara = DateAdd("h", Replace(AnticipaComanda, "H", ""), Now)
        Else
            Ara = DateAdd("h", 10, Now)
        End If
    Else
        Ara = DateAdd("h", 10, Now)
    End If
    
    GuardaHistoricReposicio "", Ara, "REPOSICIO AUTOMATICA NUEVA", proveedorNom, "ANTICIPA COMANDA [" & AnticipaComanda & "]"
    texteEMail = texteEMail & "ANTICIPA COMANDA [" & AnticipaComanda & "]<br>"
    
    'Tabla para guardar información de los pedidos (una tabla por mes y proveedor)
    tabPedidosUltimosDatos = "[" & NomTaulaPedidosUltimosDatos(Now, Proveedor) & "]"
    
    'PRODUCCIÓN PROPIA
    ProduccionPropia = False
    Set rs = Db.OpenResultset("Select Valor from ccproveedoresextes with (nolock) where id = '" & Proveedor & "' and nom = 'pPropia' and valor = 'on' ")
    If Not rs.EOF Then If Not IsNull(rs(0)) Then If rs(0) = "on" Then ProduccionPropia = True
    GuardaHistoricReposicio "", Ara, "REPOSICIO AUTOMATICA NUEVA", proveedorNom, "PRODUCCION PROPIA [" & ProduccionPropia & "]"
    texteEMail = texteEMail & "PRODUCCION PROPIA [" & ProduccionPropia & "]<br>"
    
    If ProduccionPropia Then 'VIAJE Y EQUIPO DEL PROVEEDOR, QUE SE USAN PARA ...
        Viatge = ""
        Set rs = Db.OpenResultset("select Valor from ccproveedoresextes with (nolock) where id = '" & Proveedor & "' and nom = 'viatge'")
        If Not rs.EOF Then If Not IsNull(rs(0)) Then Viatge = rs(0)
        
        equip = ""
        Set rs = Db.OpenResultset("select valor from ccproveedoresextes with (nolock) where id = '" & Proveedor & "' and nom = 'equip'")
        If Not rs.EOF Then If Not IsNull(rs(0)) Then equip = rs(0)
        
        GuardaHistoricReposicio "", Ara, "REPOSICIO AUTOMATICA NUEVA", proveedorNom, "VIAJE [" & Viatge & "] ----- EQUIPO [" & equip & "]"
        texteEMail = texteEMail & "VIAJE [" & Viatge & "] ----- EQUIPO [" & equip & "]<br>"
    End If

    'SE SIRVE POR UNIDADES (Si se sirve por unidades Pack=1 y Minimo=1)
    SirvePorUnidades = False
    Set rs = Db.OpenResultset("Select Valor from ccproveedoresextes with (nolock) where id = '" & Proveedor & "' and nom = 'SirveUnidades' and valor = 'on' ")
    If Not rs.EOF Then If Not IsNull(rs(0)) Then If rs(0) = "on" Then SirvePorUnidades = True
    GuardaHistoricReposicio "", Ara, "REPOSICIO AUTOMATICA NUEVA", proveedorNom, "SIRVE UNIDADES [" & SirvePorUnidades & "]"
    texteEMail = texteEMail & "SIRVE UNIDADES [" & SirvePorUnidades & "]<br>"
    
    'CUENTA ENCARGOS
    ContemEncarregs = False
    Set rs = Db.OpenResultset("Select Valor from ccproveedoresextes with (nolock) where id = '" & Proveedor & "' and nom = 'siEncargos' and valor = 'on' ")
    If Not rs.EOF Then If Not IsNull(rs(0)) Then If rs(0) = "on" Then ContemEncarregs = True
    GuardaHistoricReposicio "", Ara, "REPOSICIO AUTOMATICA NUEVA", proveedorNom, "CUENTA ENCARGOS [" & ContemEncarregs & "]"
    texteEMail = texteEMail & "CUENTA ENCARGOS [" & ContemEncarregs & "]<br>"
    
    'NO INVENTAR PEDIDO
    noInventar = False
    Set rs = Db.OpenResultset("Select Valor from ccproveedoresextes with (nolock) where id = '" & Proveedor & "' and nom = 'noInventar' and valor = 'on' ")
    If Not rs.EOF Then If Not IsNull(rs(0)) Then If rs(0) = "on" Then noInventar = True
    GuardaHistoricReposicio "", Ara, "REPOSICIO AUTOMATICA NUEVA", proveedorNom, "NO INVENTAR [" & noInventar & "]"
    texteEMail = texteEMail & "NO INVENTAR [" & noInventar & "]<br>"
    
    'TENER EN CUENTA LA MATERIA PRIMA BASE!!!!!
    sql = "Select m.id materia,c.codi botiga,p.codiarticle codiarticle, m.nombre mnombre,isnull(cc.valor, '99') ordre,c.nom,* "
    sql = sql & "from ccmateriasprimas m with (nolock) "
    sql = sql & "join ccnombrevalor Pr with (nolock) on Pr.valor = '" & Proveedor & "' And m.id=Pr.id and left(Pr.nombre,13) = 'P_REPOSICION_' "
    sql = sql & "join ccnombrevalor b with (nolock) on m.id=b.id and left(b.nombre,11) = 'REPOSICION_' "
    sql = sql & "join Clients c with (nolock) on Pr.nombre = 'P_REPOSICION_' + cast(c.codi  as nvarchar) And b.nombre = 'REPOSICION_' + cast(c.codi  as nvarchar) "
    sql = sql & "left join constantsclient cc on c.codi=cc.codi and cc.variable='OrdreRuta' "
    sql = sql & "join articlespropietats p with (nolock) on p.variable = 'MatPri' and p.valor = m.id "
'!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
sql = sql & "where c.codi not in (819) " 'TODAS MENOS LA T--091
'!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
    sql = sql & "order by  isnull(cc.valor, '99'), c.nom, m.nombre"
    Set rs = Db.OpenResultset(sql)

    LastBotiga = ""
    
    While Not rs.EOF
On Error GoTo otro
        BotigaNom = BotigaCodiNom(rs("Botiga"))
        If LastBotiga <> BotigaNom Then
            
            Set rsPedido = Db.OpenResultset("select isnull(MAX(numPedido), 0) + 1 nPedido from " & NomTaulaPedidosCap())
            numPedido = rsPedido("nPedido")
            
            GuardaHistoricReposicio rs("Botiga"), Ara, "REPOSICIO AUTOMATICA NUEVA", "<b>" & proveedorNom & "</b>", "Número pedido [" & numPedido & "]"
            texteEMail = texteEMail & "Número pedido [" & numPedido & "]<br>"
        End If
        LastBotiga = BotigaNom
        
        For iC = 0 To UBound(RepCliente)
            If RepCliente(iC) = rs("botiga") Then Exit For
        Next
        If iC > UBound(RepCliente) Then
            ReDim Preserve RepCliente(iC)
            RepCliente(iC) = rs("botiga")
        End If
        
        For iA = 0 To UBound(RepArticle)
            If RepArticle(iA) = rs("codiarticle") Then Exit For
        Next
        If iA > UBound(RepArticle) Then
            ReDim Preserve RepArticle(iA)
            RepArticle(iA) = rs("codiarticle")
        End If
        
        RepPedido(iC, iA) = 0
        
        NomArticle = ArticleCodiNom(rs("codiarticle"))
        GuardaHistoricReposicio rs("Botiga"), Ara, "REPOSICIO AUTOMATICA NUEVA", proveedorNom, "<b>" & NomArticle & "</b>"
        texteEMail = texteEMail & "<b>" & NomArticle & "</b><br>"
        
        Informa2 BotigaNom & " -- " & NomArticle

        'SOLO UN PEDIDO POR FECHA
        'Se borran todos los pedidos con fecha igual o mayor a hoy de la materia prima y tienda
        rec "insert into " & NomTaulaPedidosZombis() & " select *, getdate(), 'SINCRO' from ccPedidos where fecha >= convert(datetime,'" & Right("0" & Day(Ara), 2) & "/" & Right("0" & Month(Ara), 2) & "/" & Right(CStr(Year(Ara)), 2) & "',3)  And MateriaPrima = '" & rs("materia") & "' And Almacen = 'Client_" & rs("Botiga") & "'"
        ExecutaComandaSql "Delete ccpedidos where fecha >= convert(datetime,'" & Right("0" & Day(Ara), 2) & "/" & Right("0" & Month(Ara), 2) & "/" & Right(CStr(Year(Ara)), 2) & "',3)  And MateriaPrima = '" & rs("materia") & "' And Almacen = 'Client_" & rs("Botiga") & "'"
        ExecutaComandaSql "Delete " & tabPedidosUltimosDatos & " Where  fecha >= convert(datetime,'" & Right("0" & Day(Ara), 2) & "/" & Right("0" & Month(Ara), 2) & "/" & Right(CStr(Year(Ara)), 2) & "',3) And  Materia = '" & rs("materia") & "' and Cliente = '" & rs("Botiga") & "' and Proveedor =  '" & Proveedor & "' and idPedido <> 'Primer pedido automatico' "
        
        'DATOS DEL ÚLTIMO RECALCULO (si no hay datos coge 1 días atras para las fechas y 0 inventados y redondeo)
        'DataUltimaVentaServida --> [PedidosUltimosDatos_[...].FechaUltimaVenta  ----- FECHA DE LA ÚTIMA VENTA (DE CUALQUIER COSA) DE LA TIENDA CUANDO SE HIZO LA ÚLTIMA REPOSICIÓN (SI ES LA PRIMERA REPOSICIÓN SERÁ AYER) ---------
        'His_FechaUltimaVentaNoEncontrada --> [PedidosUltimosDatos_[...].Fecha ------ FECHA DEL ÚLTIMO PEDIDO POR REPOSICIÓN --------
        'His_FechaUltimaDevolucionNoEncontrada --> [PedidosUltimosDatos_[...].FechaUltimaDevolucion ---FECHA DE LA ÚTIMA DEVOLUCIÓN (DE CUALQUIER COSA?) DE LA TIENDA CUANDO SE HIZO LA ÚLTIMA REPOSICIÓN  ---------
        'His_Inventados -> [PedidosUltimosDatos_[...].RedondeoCliente
        'His_Redondeo-> [PedidosUltimosDatos_[...].RedondeoProveedor
        If Not PedidosUltimosDatos_V2(rs("materia"), rs("Botiga"), Proveedor, DataUltimaVentaServida, His_FechaUltimaVentaNoEncontrada, His_FechaUltimaDevolucionNoEncontrada, His_Inventados, His_Redondeo) Then
            GuardaHistoricReposicio rs("Botiga"), Ara, "REPOSICIO AUTOMATICA NUEVA", proveedorNom, NomArticle, "<B>Primer Pedido. Cojemos fecha del día en el que se debería haber calculado la útima reposición.<B>"
            texteEMail = texteEMail & "<B>Primer Pedido. Cojemos fecha del día en el que se debería haber calculado la útima reposición.<B><br>"
        End If
        
        'RESETEAR EL HISTORICO DE INVENTOS (SE PUEDE QUEDAR ATASCADA LA REPOSICIÓN SI HAY UN INVENTO MUY ALTO, NORMALMENTE POR PEDIDO EN TOC POR CONSUMO PERSONAL
        If His_Inventados > 100 Then His_Inventados = 0
        
        GuardaHistoricReposicio rs("botiga"), Ara, "REPOSICIO AUTOMATICA NUEVA", proveedorNom, NomArticle, "<b>ÚLTIMA REPOSICIÓN</b> [" & His_FechaUltimaVentaNoEncontrada & "]"
        GuardaHistoricReposicio rs("Botiga"), Ara, "REPOSICIO AUTOMATICA NUEVA", proveedorNom, NomArticle, "&nbsp;&nbsp;&nbsp;&nbsp;FECHA ULTIMA VENTA [" & DataUltimaVentaServida & "]"
        GuardaHistoricReposicio rs("botiga"), Ara, "REPOSICIO AUTOMATICA NUEVA", proveedorNom, NomArticle, "&nbsp;&nbsp;&nbsp;&nbsp;FECHA ULTIMA DEVOLUCION [" & His_FechaUltimaDevolucionNoEncontrada & "]"
        GuardaHistoricReposicio rs("Botiga"), Ara, "REPOSICIO AUTOMATICA NUEVA", proveedorNom, NomArticle, "&nbsp;&nbsp;&nbsp;&nbsp;UNIDADES INVENTADAS = " & His_Inventados & ""
        texteEMail = texteEMail & "<b>ÚLTIMA REPOSICIÓN</b> [" & His_FechaUltimaVentaNoEncontrada & "]<br>"
        texteEMail = texteEMail & "&nbsp;&nbsp;&nbsp;&nbsp;FECHA ULTIMA VENTA [" & DataUltimaVentaServida & "]<br>"
        texteEMail = texteEMail & "&nbsp;&nbsp;&nbsp;&nbsp;FECHA ULTIMA DEVOLUCION [" & His_FechaUltimaDevolucionNoEncontrada & "]<br>"
        texteEMail = texteEMail & "&nbsp;&nbsp;&nbsp;&nbsp;UNIDADES INVENTADAS = " & His_Inventados & "<br>"
        
        'FECHA ÚLTIMA VENTA QUE SE HIZO EN LA TIENDA (DE CUALQUIER PRODUCTO). SI NO ENCUETRA EN LOS ÚLTIMOS 2 MESES DEVUELVE -7 DÍAS
        DataUltimaVenta = DataUltimaVentaBusca_V2(rs("Botiga"), Ara)
        GuardaHistoricReposicio rs("botiga"), Ara, "REPOSICIO AUTOMATICA NUEVA", proveedorNom, NomArticle, "<b>CÁLCULO REPOSICIÓN</b>"
        GuardaHistoricReposicio rs("Botiga"), Ara, "REPOSICIO AUTOMATICA NUEVA", proveedorNom, NomArticle, "<B>&nbsp;&nbsp;&nbsp;&nbsp;VENTAS</B>"
        GuardaHistoricReposicio rs("Botiga"), Ara, "REPOSICIO AUTOMATICA NUEVA", proveedorNom, NomArticle, "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FECHA ÚLTIMA VENTA [" & DataUltimaVenta & "]"
        texteEMail = texteEMail & "<b>CÁLCULO REPOSICIÓN</b><br>"
        texteEMail = texteEMail & "<B>&nbsp;&nbsp;&nbsp;&nbsp;VENTAS</B><br>"
        texteEMail = texteEMail & "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FECHA ÚLTIMA VENTA [" & DataUltimaVenta & "]<br>"
       
        hayVentas = True
        If His_FechaUltimaVentaNoEncontrada > DataUltimaVenta Then 'NO HAY DATOS DE VENTAS!!!
            hayVentas = False
        End If
        
        CalDemanar = 0
        If hayVentas Then
            'Ventas del artículo desde la fecha de la útima reposición (His_FechaUltimaVentaNoEncontrada) hasta la fecha de la útima venta (DataUltimaVenta)
            consumoPersonal = PedidoCuantosFaltan_V2(rs("codiarticle"), rs("Botiga"), His_FechaUltimaVentaNoEncontrada, DataUltimaVenta, True)
            CalDemanar = PedidoCuantosFaltan_V2(rs("codiarticle"), rs("Botiga"), His_FechaUltimaVentaNoEncontrada, DataUltimaVenta)
           
            GuardaHistoricReposicio rs("Botiga"), Ara, "REPOSICIO AUTOMATICA NUEVA", proveedorNom, NomArticle, "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VENTAS DESDE ÚLTIMA REPOSICIÓN [" & His_FechaUltimaVentaNoEncontrada & "] HASTA ÚLTIMA VENTA [" & DataUltimaVenta & "] = <B>" & CalDemanar & "</B>"
            GuardaHistoricReposicio rs("Botiga"), Ara, "REPOSICIO AUTOMATICA NUEVA", proveedorNom, NomArticle, "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CONSUMO PERSONAL DESDE ÚLTIMA REPOSICIÓN [" & His_FechaUltimaVentaNoEncontrada & "] HASTA ÚLTIMA VENTA [" & DataUltimaVenta & "] = " & consumoPersonal
            texteEMail = texteEMail & "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VENTAS DESDE ÚLTIMA REPOSICIÓN [" & His_FechaUltimaVentaNoEncontrada & "] HASTA ÚLTIMA VENTA [" & DataUltimaVenta & "] = <B>" & CalDemanar & "</B><br>"
            texteEMail = texteEMail & "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CONSUMO PERSONAL DESDE ÚLTIMA REPOSICIÓN [" & His_FechaUltimaVentaNoEncontrada & "] HASTA ÚLTIMA VENTA [" & DataUltimaVenta & "] = " & consumoPersonal & "<br>"
                    
            'Pedidos no servidos (en el útimo pedido)
            demanatNOServit = 0
            'demanatNOServit = PedidoNOServido_V2(Rs("codiarticle"), Rs("botiga"), His_FechaUltimaVentaNoEncontrada, DataUltimaVenta)
            'CalDemanar = CalDemanar + demanatNOServit
            'GuardaHistoricReposicio Rs("Botiga"), Ara, "REPOSICIO AUTOMATICA NUEVA", proveedorNom, NomArticle, "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PEDIDOS NO SERVIDOS DESDE ÚLTIMA REPOSICIÓN [" & His_FechaUltimaVentaNoEncontrada & "] HASTA ÚLTIMA VENTA [" & DataUltimaVenta & "] = " & demanatNOServit
            'texteEMail = texteEMail & "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PEDIDOS NO SERVIDOS DESDE ÚLTIMA REPOSICIÓN [" & His_FechaUltimaVentaNoEncontrada & "] HASTA ÚLTIMA VENTA [" & DataUltimaVenta & "] = " & demanatNOServit & "<br>"
            
            'Intervalo de tickets Ut (primer ticket) Pt (último ticket) Nt (número de tickets)
            PedidoCuantosFaltanNumTicks_V2 rs("codiarticle"), rs("Botiga"), His_FechaUltimaVentaNoEncontrada, DataUltimaVenta, Ut, Pt, Nt
            GuardaHistoricReposicio rs("Botiga"), Ara, "REPOSICIO AUTOMATICA NUEVA", proveedorNom, NomArticle, "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PRIMER TIQUET [" & Ut & "] ULTIM TIQUET [" & Pt & "] NUMERO TIQUETS [" & Nt & "] (" & Abs(Ut - Pt) & ")"
            texteEMail = texteEMail & "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PRIMER TIQUET [" & Ut & "] ULTIM TIQUET [" & Pt & "] NUMERO TIQUETS [" & Nt & "] (" & Abs(Ut - Pt) & ")<br>"
        Else
            GuardaHistoricReposicio rs("Botiga"), Ara, "REPOSICIO AUTOMATICA NUEVA", proveedorNom, NomArticle, "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<B>NO HAY DATOS DE VENTAS</B>"
            texteEMail = texteEMail & "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<B>NO HAY DATOS DE VENTAS</B><br>"
        End If
        
        'Fecha última devolución
        DataUltimaDevolucio = DataUltimaDevolucioBusca_V2(rs("Botiga"), Ara)
        GuardaHistoricReposicio rs("Botiga"), Ara, "REPOSICIO AUTOMATICA NUEVA", proveedorNom, NomArticle, "<B>&nbsp;&nbsp;&nbsp;&nbsp;DEVOLUCIONES</B>"
        GuardaHistoricReposicio rs("Botiga"), Ara, "REPOSICIO AUTOMATICA NUEVA", proveedorNom, NomArticle, "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FECHA ULTIMA DEVOLUCIÓN [" & DataUltimaDevolucio & "]"
        texteEMail = texteEMail & "<B>&nbsp;&nbsp;&nbsp;&nbsp;DEVOLUCIONES</B><br>"
        texteEMail = texteEMail & "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FECHA ULTIMA DEVOLUCIÓN [" & DataUltimaDevolucio & "]<br>"
        
        'ENCARRECS PER ACABAR
        Encarregs = 0
        If ContemEncarregs Then
            Encarregs = EncarregatsServits_V2(rs("codiarticle"), rs("Botiga"), His_FechaUltimaVentaNoEncontrada, DataUltimaVenta)
            GuardaHistoricReposicio rs("Botiga"), Ara, "REPOSICIO AUTOMATICA NUEVA", proveedorNom, NomArticle, "&nbsp;&nbsp;&nbsp;<B>ENCARRECS</B> Servits desde [" & His_FechaUltimaVentaNoEncontrada & "] Hasta [" & DataUltimaVenta & "] = <b>" & Encarregs & "</b>"
            texteEMail = texteEMail & "&nbsp;&nbsp;&nbsp;<B>ENCARRECS</B> Servits desde [" & His_FechaUltimaVentaNoEncontrada & "] Hasta [" & DataUltimaVenta & "] = <b>" & Encarregs & "</b><br>"
        End If
        '~ENCARRECS PER ACABAR ********************
        
        'Devoluciones del producto desde His_FechaUltimaDevolucionNoEncontrada hasta DataUltimaDevolucio
        CalDemanarDev = PedidoCuantosFaltanDevolucion_V2(rs("codiarticle"), rs("Botiga"), His_FechaUltimaDevolucionNoEncontrada, DataUltimaDevolucio)
        GuardaHistoricReposicio rs("Botiga"), Ara, "REPOSICIO AUTOMATICA NUEVA", proveedorNom, NomArticle, "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DEVOLUCIONES DESDE ÚTIMA REPOSICIÓN [" & His_FechaUltimaDevolucionNoEncontrada & "] HASTA ÚLTIMA DEVOLUCIÓN [" & DataUltimaDevolucio & "] = <b> " & CalDemanarDev & "</b>"
        texteEMail = texteEMail & "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DEVOLUCIONES DESDE ÚTIMA REPOSICIÓN [" & His_FechaUltimaDevolucionNoEncontrada & "] HASTA ÚLTIMA DEVOLUCIÓN [" & DataUltimaDevolucio & "] = <b> " & CalDemanarDev & "</b><br>"
        
        'DE MOMENTO NO TENEMOS EN CUENTA LA DEVOLUCIÓN
        'GuardaHistoricReposicio rs("Botiga"), Ara, "REPOSICIO AUTOMATICA NUEVA", proveedorNom, NomArticle, "&nbsp;&nbsp;&nbsp;<B>CalDemanar = CalDemanar + CalDemanarDev - Encarregs = " & CalDemanar & " + " & CalDemanarDev & " - " & Encarregs & " = " & CalDemanar + CalDemanarDev - Encarregs & "</b>"
        'CalDemanar = CalDemanar + CalDemanarDev - Encarregs
        
        GuardaHistoricReposicio rs("Botiga"), Ara, "REPOSICIO AUTOMATICA NUEVA", proveedorNom, NomArticle, "&nbsp;&nbsp;&nbsp;<B>PEDIDO = " & CalDemanar & "</b>"
        texteEMail = texteEMail & "&nbsp;&nbsp;&nbsp;<B>PEDIDO = " & CalDemanar & "</b><br>"
        
        'INVENTOS **************************
        UnitatsInventades = 0
        
        '!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
        'PARA LA PRUEBA DEJAMOS INVENTAR SIEMPRE -------------------------------------------------------
        'DESPUÉS HABRÁ QUE CONFIGURAR EL PROVEEDOR PARA QUE INVENTE ------------------------------------
        '!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
        'If Not noInventar Then 'El proveedor está configurado para permitir inventar
            'Nos inventamos los datos del trocito que falte DE ATRAS HASTA AHORA calculando las ventas de la semana pasada
            D1 = DateAdd("d", -7, DataUltimaVenta)
            D2 = DateAdd("d", -7, Ara)
            
            UnitatsInventades = PedidoCuantosFaltan_V2(rs("codiarticle"), rs("Botiga"), D1, D2)
            GuardaHistoricReposicio rs("Botiga"), Ara, "REPOSICIO AUTOMATICA NUEVA", proveedorNom, NomArticle, "<B>PREVISIÓN (INVENTOS)</B>"
            GuardaHistoricReposicio rs("Botiga"), Ara, "REPOSICIO AUTOMATICA NUEVA", proveedorNom, NomArticle, "&nbsp;&nbsp;&nbsp;&nbsp;Ventas desde [" & D1 & "] Hasta [" & D2 & "] = <b>" & UnitatsInventades & "<b>"
            GuardaHistoricReposicio rs("Botiga"), Ara, "REPOSICIO AUTOMATICA NUEVA", proveedorNom, NomArticle, "&nbsp;&nbsp;&nbsp;&nbsp;<b>Inventados = " & UnitatsInventades & "</b>"
            texteEMail = texteEMail & "<B>PREVISIÓN (INVENTOS)</B><br>"
            texteEMail = texteEMail & "&nbsp;&nbsp;&nbsp;&nbsp;Ventas desde [" & D1 & "] Hasta [" & D2 & "] = <b>" & UnitatsInventades & "<b><br>"
            texteEMail = texteEMail & "&nbsp;&nbsp;&nbsp;&nbsp;<b>Inventados = " & UnitatsInventades & "</b><br>"
        'End If
        '~INVENTOS **************************
        
        'CORREGIMOS INVENTOS DE LA ÚTIMA REPOSICIÓN
        'Ventas del artículo desde la fecha DataUltimaVentaServida hasta His_FechaUltimaVentaNoEncontrada
        ErrorInventosAnteriores = PedidoCuantosFaltan_V2(rs("codiarticle"), rs("Botiga"), DataUltimaVentaServida, His_FechaUltimaVentaNoEncontrada)
        stockBotiga = PedidoCuantosFaltan_V2(rs("codiarticle"), rs("Botiga"), DateSerial(Year(His_FechaUltimaVentaNoEncontrada), Month(His_FechaUltimaVentaNoEncontrada), Day(His_FechaUltimaVentaNoEncontrada)) + TimeSerial(Hour(His_FechaUltimaVentaNoEncontrada), 0, 0), DateSerial(Year(His_FechaUltimaVentaNoEncontrada), Month(Now()), Day(His_FechaUltimaVentaNoEncontrada)) + TimeSerial(Hour(His_FechaUltimaVentaNoEncontrada), 59, 59), True)
        GuardaHistoricReposicio rs("Botiga"), Ara, "REPOSICIO AUTOMATICA NUEVA", proveedorNom, NomArticle, "&nbsp;&nbsp;&nbsp;&nbsp;<b>RECTIFICACIÓN ÚLTIMA PREVISIÓN</b>"
        GuardaHistoricReposicio rs("Botiga"), Ara, "REPOSICIO AUTOMATICA NUEVA", proveedorNom, NomArticle, "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;En la última reposición me inventé [" & His_Inventados & "]"
        GuardaHistoricReposicio rs("Botiga"), Ara, "REPOSICIO AUTOMATICA NUEVA", proveedorNom, NomArticle, "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Ventas reales desde [" & DataUltimaVentaServida & "] Hasta [" & His_FechaUltimaVentaNoEncontrada & "] = <b>" & ErrorInventosAnteriores & "</b>"
        GuardaHistoricReposicio rs("Botiga"), Ara, "REPOSICIO AUTOMATICA NUEVA", proveedorNom, NomArticle, "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;STOCK PEDIDO EN TIENDA POR CONSUMO PERSONAL (" & DateSerial(Year(His_FechaUltimaVentaNoEncontrada), Month(His_FechaUltimaVentaNoEncontrada), Day(His_FechaUltimaVentaNoEncontrada)) + TimeSerial(Hour(His_FechaUltimaVentaNoEncontrada), 0, 0) & "-" & DateSerial(Year(His_FechaUltimaVentaNoEncontrada), Month(Now()), Day(His_FechaUltimaVentaNoEncontrada)) + TimeSerial(Hour(His_FechaUltimaVentaNoEncontrada), 59, 59) & ") = " & stockBotiga
        texteEMail = texteEMail & "&nbsp;&nbsp;&nbsp;&nbsp;<b>RECTIFICACIÓN ÚLTIMA PREVISIÓN</b><br>"
        texteEMail = texteEMail & "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;En la última reposición me inventé [" & His_Inventados & "]<br>"
        texteEMail = texteEMail & "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Ventas reales desde [" & DataUltimaVentaServida & "] Hasta [" & His_FechaUltimaVentaNoEncontrada & "] = <b>" & ErrorInventosAnteriores & "</b><br>"
        texteEMail = texteEMail & "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;STOCK PEDIDO EN TIENDA POR CONSUMO PERSONAL (" & DateSerial(Year(His_FechaUltimaVentaNoEncontrada), Month(His_FechaUltimaVentaNoEncontrada), Day(His_FechaUltimaVentaNoEncontrada)) + TimeSerial(Hour(His_FechaUltimaVentaNoEncontrada), 0, 0) & "-" & DateSerial(Year(His_FechaUltimaVentaNoEncontrada), Month(Now()), Day(His_FechaUltimaVentaNoEncontrada)) + TimeSerial(Hour(His_FechaUltimaVentaNoEncontrada), 59, 59) & ") = " & stockBotiga & "<br>"

        GuardaHistoricReposicio rs("Botiga"), Ara, "REPOSICIO AUTOMATICA NUEVA", proveedorNom, NomArticle, "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ME INVENTÉ " & His_Inventados & " PERO REALMENTE VENDÍ " & ErrorInventosAnteriores & " Y ME HAN PEDIDO " & stockBotiga
        texteEMail = texteEMail & "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ME INVENTÉ " & His_Inventados & " PERO REALMENTE VENDÍ " & ErrorInventosAnteriores & " Y ME HAN PEDIDO " & stockBotiga & "<br>"
        ErrorInventosAnteriores = (ErrorInventosAnteriores - His_Inventados)
        If stockBotiga > 0 Then
            ErrorInventosAnteriores = ErrorInventosAnteriores + (stockBotiga - ErrorInventosAnteriores)
            GuardaHistoricReposicio rs("Botiga"), Ara, "REPOSICIO AUTOMATICA NUEVA", proveedorNom, NomArticle, "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Añadimos " & (stockBotiga - ErrorInventosAnteriores) & " para ajustar inventario " & (stockBotiga - ErrorInventosAnteriores) & " = (" & stockBotiga & "-" & ErrorInventosAnteriores & ") <br>"
            texteEMail = texteEMail & "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Añadimos " & (stockBotiga - ErrorInventosAnteriores) & " para ajustar inventario " & (stockBotiga - ErrorInventosAnteriores) & " = (" & stockBotiga & "-" & ErrorInventosAnteriores & ") <br><br>"
        End If
                
        If Abs(ErrorInventosAnteriores) > 0 Then
            GuardaHistoricReposicio rs("Botiga"), Ara, "REPOSICIO AUTOMATICA NUEVA", proveedorNom, NomArticle, "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>Rectificación " & ErrorInventosAnteriores & "</b>"
            texteEMail = texteEMail & "<br>"
        End If
        
        
        CalDemanarArodonit = 0
        
        'SE HACE EL PEDIDO, SI ES NECESARIO
        If (CalDemanar + UnitatsInventades + His_Redondeo + ErrorInventosAnteriores) > 0 Then
        
            GuardaHistoricReposicio rs("Botiga"), Ara, "REPOSICIO AUTOMATICA NUEVA", proveedorNom, NomArticle, "<b>HAY PEDIDO</b>"
            texteEMail = texteEMail & "<b>HAY PEDIDO</b><br>"
            
            If SirvePorUnidades Then
                Pack = 1
                Minimo = 1
            Else
                Set rs2 = Db.OpenResultset("Select unidades,UnidadesEnvio from ccmateriasprimas with (nolock) where id ='" & rs("materia") & "' ")
                
                If Not rs2.EOF Then If Not IsNull(rs2("Unidades")) Then Pack = rs2("Unidades")
                If Pack = 0 Then Pack = 1
                
                If Not rs2.EOF Then If Not IsNull(rs2("UnidadesEnvio")) Then Minimo = rs2("UnidadesEnvio")
                If Minimo = 0 Then Minimo = 1
            End If
            
            GuardaHistoricReposicio rs("Botiga"), Ara, "REPOSICIO AUTOMATICA NUEVA", proveedorNom, NomArticle, "&nbsp;&nbsp;&nbsp;&nbsp;Pack [" & Pack & "] Minimo [" & Minimo & "]  (Pack * Minimo) = [" & (Pack * Minimo) & "]"
            texteEMail = texteEMail & "&nbsp;&nbsp;&nbsp;&nbsp;Pack [" & Pack & "] Minimo [" & Minimo & "]  (Pack * Minimo) = [" & (Pack * Minimo) & "]<br>"
            
            Limite = (Pack * Minimo)
            If Minimo = 1 And Pack > 5 Then Limite = Int(Limite * 0.9)
            
            If (CalDemanar + UnitatsInventades + His_Redondeo + ErrorInventosAnteriores) >= Limite Then
                CalDemanarArodonit = Int((CalDemanar + UnitatsInventades + His_Redondeo + ErrorInventosAnteriores) / (Pack * Minimo)) * (Pack * Minimo)
                GuardaHistoricReposicio rs("Botiga"), Ara, "REPOSICIO AUTOMATICA NUEVA", proveedorNom, NomArticle, "&nbsp;&nbsp;&nbsp;&nbsp;Per Propera comanda guardem : " & ((CalDemanar + UnitatsInventades + His_Redondeo + ErrorInventosAnteriores) - CalDemanarArodonit)
                GuardaHistoricReposicio rs("Botiga"), Ara, "REPOSICIO AUTOMATICA NUEVA", proveedorNom, NomArticle, "&nbsp;&nbsp;&nbsp;&nbsp;<B>PEDIDO A PROVEEDOR = " & CalDemanar & "+" & UnitatsInventades & "+" & ErrorInventosAnteriores & "</B>"
                GuardaHistoricReposicio rs("Botiga"), Ara, "REPOSICIO AUTOMATICA NUEVA", proveedorNom, NomArticle, "&nbsp;&nbsp;&nbsp;&nbsp;<B>PEDIDO A PROVEEDOR = " & CalDemanarArodonit & "</B>"
                texteEMail = texteEMail & "&nbsp;&nbsp;&nbsp;&nbsp;Per Propera comanda guardem : " & ((CalDemanar + UnitatsInventades + His_Redondeo + ErrorInventosAnteriores) - CalDemanarArodonit) & "<br>"
                texteEMail = texteEMail & "&nbsp;&nbsp;&nbsp;&nbsp;<B>PEDIDO A PROVEEDOR = " & CalDemanar & "+" & UnitatsInventades & "+" & ErrorInventosAnteriores & "</B><br>"
                texteEMail = texteEMail & "&nbsp;&nbsp;&nbsp;&nbsp;<B>PEDIDO A PROVEEDOR = " & CalDemanarArodonit & "</B><br>"
                
                Set rs2 = Db.OpenResultset("Select NewId() ")
                IdP = rs2(0)
                
                precio = 0
                Set rsPreu = Db.OpenResultset("select precio from ccmateriasprimas with (nolock) where id = '" & rs("Materia") & "'")
                If Not rsPreu.EOF Then
                    If Left(rsPreu("precio"), 1) = "." Then
                        precio = CDbl("0" & rsPreu("precio"))
                    Else
                        precio = rsPreu("precio")
                    End If
                End If
                
                sql = "Insert into ccPedidos(Id,materiaPrima,proveedor,almacen,precio,cantidad,fecha,recepcion) "
                
                CalDemanarEnPacks = CalDemanarArodonit
                If Pack > 1 Then CalDemanarEnPacks = Int(CalDemanarArodonit / Pack)
                
                sql = sql & "values('" & IdP & "','" & rs("Materia") & "','" & Proveedor & "','Client_" & rs("Botiga") & "'," & precio & "," & CalDemanarEnPacks & ",convert(datetime,'" & Now() & "',103),convert(datetime,'" & DateAdd("d", 1, Now()) & "',103))"
                ExecutaComandaSql sql
                
On Error GoTo sigue
                ExecutaComandaSql "insert into " & NomTaulaPedidosCap() & " (numPedido, idPedido, proveedor, almacen, fecha, recepcion) values (" & numPedido & ", '" & IdP & "', '" & Proveedor & "', 'Client_" & rs("Botiga") & "', convert(datetime,'" & Now() & "',103), convert(datetime,'" & Now() & "',103))"
sigue:
                RepPedido(iC, iA) = CalDemanarEnPacks
                
                If ChatUser > 0 Then ExecutaComandaSql "Insert Into " & NomTaulaSecreAvisosTxt & " (Tipus,usuari,lliure1) Values ('Pedido','" & ChatUser & "','Article -> " & NomArticle & " Servir :" & CalDemanarArodonit & " Unitats')"
                
                sql = "Insert into " & tabPedidosUltimosDatos
                sql = sql & " ([IdPedido],[Proveedor],[Materia],[Cliente],[Fecha],[RedondeoProveedor],[RedondeoCliente],[FechaUltimaVenta],[FechaUltimaDevolucion])  "
                sql = sql & " Values ("
                sql = sql & " '" & IdP & "',"
                sql = sql & " '" & Proveedor & "',"
                sql = sql & " '" & rs("Materia") & "',"
                sql = sql & " '" & rs("Botiga") & "',"
                sql = sql & " convert(datetime,'" & Ara & "',103),"
                sql = sql & " '" & ((CalDemanar + UnitatsInventades + His_Redondeo + ErrorInventosAnteriores) - CalDemanarArodonit) & "',"
                sql = sql & " '" & UnitatsInventades & "',"
                sql = sql & " convert(datetime,'" & DataUltimaVenta & "',103), "
                sql = sql & " convert(datetime,'" & DataUltimaDevolucio & "',103) "
                sql = sql & " ) "
                ExecutaComandaSql sql
                
            Else
                GuardaHistoricReposicio rs("Botiga"), Ara, "REPOSICIO AUTOMATICA NUEVA", proveedorNom, NomArticle, "<b>NO HAY PEDIDO</b> (CalDemanar + UnitatsInventades + His_Redondeo + ErrorInventosAnteriores) <= Limite , " & (CalDemanar + UnitatsInventades + His_Redondeo + ErrorInventosAnteriores) & "<" & Limite
                texteEMail = texteEMail & "<b>NO HAY PEDIDO</b> (CalDemanar + UnitatsInventades + His_Redondeo + ErrorInventosAnteriores) <= Limite , " & (CalDemanar + UnitatsInventades + His_Redondeo + ErrorInventosAnteriores) & "<" & Limite & "<br>"
            End If
            
        Else
            GuardaHistoricReposicio rs("Botiga"), Ara, "REPOSICIO AUTOMATICA NUEVA", proveedorNom, NomArticle, "<b>NO HAY PEDIDO</b> (CalDemanar + UnitatsInventades + His_Redondeo + ErrorInventosAnteriores) <= 0 , " & (CalDemanar + UnitatsInventades + His_Redondeo + ErrorInventosAnteriores) & "<=0"
            texteEMail = texteEMail & "<b>NO HAY PEDIDO</b> (CalDemanar + UnitatsInventades + His_Redondeo + ErrorInventosAnteriores) <= 0 , " & (CalDemanar + UnitatsInventades + His_Redondeo + ErrorInventosAnteriores) & "<=0<br>"
        End If
        
        'SI ES PRODUCCIÓN PROPIA PASAMOS EL PEDIDO A LA GRAELLA
        If ProduccionPropia Then
            GuardaHistoricReposicio rs("Botiga"), Ara, "REPOSICIO AUTOMATICA NUEVA", proveedorNom, NomArticle, "<B>PRODUCCIO PROPIA</B>"
            texteEMail = texteEMail & "<B>PRODUCCIO PROPIA</B><br>"

            quantitatServida = 0
            Set rs2 = Db.OpenResultset("Select Sum(QuantitatServida) Qs From [" & DonamNomTaulaServit(DateAdd("d", 1, Now())) & "] with (nolock) Where Client = " & rs("Botiga") & " And CodiArticle = " & rs("codiarticle") & " ")
            If Not rs2.EOF Then If Not IsNull(rs2(0)) Then quantitatServida = rs2(0)
            
            GuardaHistoricReposicio rs("Botiga"), Ara, "REPOSICIO AUTOMATICA NUEVA", proveedorNom, NomArticle, "&nbsp;&nbsp;&nbsp;&nbsp;SERVIDO HASTA " & Format(DateAdd("d", 1, Now()), "dd/mm/yyyy") & " = " & quantitatServida & " VENDIDO = " & (CalDemanar + UnitatsInventades + His_Redondeo + ErrorInventosAnteriores) & " <B>PEDIDO = " & CalDemanarArodonit & "</B>"
            texteEMail = texteEMail & "&nbsp;&nbsp;&nbsp;&nbsp;SERVIDO HASTA " & Format(DateAdd("d", 1, Now()), "dd/mm/yyyy") & " = " & quantitatServida & " VENDIDO = " & (CalDemanar + UnitatsInventades + His_Redondeo + ErrorInventosAnteriores) & " <B>PEDIDO = " & CalDemanarArodonit & "</B><br>"
            
            ExecutaComandaSql "Update [" & DonamNomTaulaServit(DateAdd("d", 1, Now())) & "] Set QuantitatDemanada = 0 ,QuantitatServida = 0 Where Client = " & rs("Botiga") & " And CodiArticle = " & rs("codiarticle") & " And  Viatge = '" & Viatge & "' And Equip = '" & equip & "' And Comentari like '%Reposicio%' "
            ExecutaComandaSql "Delete [" & DonamNomTaulaServit(DateAdd("d", 1, Now())) & "] Where QuantitatDemanada = 0 And Client = " & rs("Botiga") & " And CodiArticle = " & rs("codiarticle") & " And Comentari like '%Reposicio%'  "
            If CalDemanarArodonit > 0 Then
                GuardaHistoricReposicio rs("Botiga"), Ara, "REPOSICIO AUTOMATICA NUEVA", proveedorNom, NomArticle, "&nbsp;&nbsp;&nbsp;&nbsp;<B>HACEMOS PEDIDO EN GRAELLA</B> " & Format(DateAdd("d", 1, Now()), "dd/mm/yyyy") & " UNIDADES  " & CalDemanarArodonit & " VIAJE = [" & Viatge & "] EQUIPO = [" & equip & "]"
                texteEMail = texteEMail & "&nbsp;&nbsp;&nbsp;&nbsp;<B>HACEMOS PEDIDO EN GRAELLA</B> " & Format(DateAdd("d", 1, Now()), "dd/mm/yyyy") & " UNIDADES  " & CalDemanarArodonit & " VIAJE = [" & Viatge & "] EQUIPO = [" & equip & "]<br>"
                
                sql = "Insert Into [" & DonamNomTaulaServit(DateAdd("d", 1, Now())) & "] "
                sql = sql & "(Client,CodiArticle,QuantitatDemanada,QuantitatServida,Comentari,PluUtilitzat,Viatge,Equip,MotiuModificacio,Hora,TipusComanda,ComentariPer,Atribut) "
                sql = sql & " Values ("
                sql = sql & " " & rs("Botiga") & " , "
                sql = sql & " " & rs("codiarticle") & " , "
                sql = sql & " '" & CalDemanarArodonit & "' , "
                sql = sql & " '" & CalDemanarArodonit & "' , "
                sql = sql & " '[Reposicio:" & UnitatsInventades & "]', "
                sql = sql & " " & rs("codiarticle") & " , "
                sql = sql & " '" & Viatge & "' , "
                sql = sql & " '" & equip & "' , "
                sql = sql & " '' , "
                sql = sql & " 95 , "
                sql = sql & " 1 , "
                sql = sql & " '' , "
                sql = sql & " 0 ) "
                
                StErr = ""
                OK = ExecutaComandaSql(sql, StErr)
                If Not OK Then
                    GuardaHistoricReposicio rs("Botiga"), Ara, "REPOSICIO AUTOMATICA NUEVA", proveedorNom, NomArticle, "<B>FemComanda Reintento</B>"
                    texteEMail = texteEMail & "<B>FemComanda Reintento</B><br>"
                    
                    StErr = ""
                    OK = ExecutaComandaSql(sql, StErr)
                    If Not OK Then
                        GuardaHistoricReposicio rs("Botiga"), Ara, "REPOSICIO AUTOMATICA NUEVA", proveedorNom, NomArticle, "<B>PEDIDO HECHO " & OK & "  " & StErr & "</B>"
                        texteEMail = texteEMail & "<B>PEDIDO HECHO " & OK & "  " & StErr & "</B><br>"
                    End If
                End If
                GuardaHistoricReposicio rs("Botiga"), Ara, "REPOSICIO AUTOMATICA NUEVA", proveedorNom, NomArticle, "<B>PEDIDO HECHO " & OK & " " & StErr & "</B>"
                texteEMail = texteEMail & "<B>PEDIDO HECHO " & OK & " " & StErr & "</B><br>"
            End If
        End If
        
        
otro:
        rs.MoveNext
    Wend
    
    GuardaHistoricReposicio "", Ara, "REPOSICIO AUTOMATICA NUEVA", proveedorNom, "--------------------- FIN REPARTO " & UCase(proveedorNom) & "---------------------"
    texteEMail = texteEMail & "--------------------- FIN REPARTO " & UCase(proveedorNom) & "---------------------<br>"
    
    If ChatUser > 0 Then ExecutaComandaSql "Insert Into " & NomTaulaSecreAvisosTxt & " (Tipus,usuari,lliure1) Values ('Pedido','" & ChatUser & "','Fin Pedido (" & DataUltimaVenta & ")')"

'ENVIAMOS EMAIL AL RESPONSABLE DE LA REPOSICIÓN -------------------------------------------------------------------------------------------------------------------------------
On Error GoTo posna
    
    If Not EmailAvissos() = "" Then sf_enviarMail "Secrehit@gmail.com", EmailAvissos(), Format(Now, "dddd dd ") & "REPOSICIO AUTOMÀTICA a " & proveedorNom & " " & DateDiff("n", TexteEmailHi, Now) & " n. ", texteEMail, "", ""
    
    Set rs = Db.OpenResultset("Select eMail,via from ccproveedores with (nolock) where id = '" & Proveedor & "' ")
    If Not rs.EOF Then
        If Not IsNull(rs("VIA")) Then
            If rs("Via") = "EMAIL" Then
                If Len(rs("eMail")) > 0 Then
                    If InStr(rs("eMail"), "@") > 0 Then
                        MyKill AppPath & "\DetallCalcul.html"
                        'TexteEmail
                        Dim f
                        f = FreeFile
                        Open AppPath & "\DetallCalcul.html" For Output As #f
                        Print #f, texteEMail
                        Close #f
                        
                        texteEMail = ""
                        texteEMail = texteEMail & "<H><b> Comanda Per " & proveedorNom & " </b></H>"
                        texteEMail = texteEMail & "<Table border=1 ><Tr><Td style='width:20%;'><b>Producte</b></Td><Td style='width:30%;'><b>Total</b></Td>"
                        For iA = 1 To UBound(RepCliente)
                            texteEMail = texteEMail & "<Td style='width:20%;'><b>" & BotigaCodiNom(RepCliente(iA)) & "</b></Td>"
                        Next
                        texteEMail = texteEMail & "</Tr>"
                        For ip = 1 To UBound(RepArticle)
                            accIp = 0
                            textePart = ""
                            For iA = 1 To UBound(RepCliente)
                                If UBound(RepPedido, 1) >= iA And UBound(RepPedido, 2) >= ip Then
'                                    Debug.Print RepPedido(iA, iP)
                                    accIp = accIp + RepPedido(iA, ip)
                                    textePart = textePart & "<Td>" & IIf(RepPedido(iA, ip) = 0, "", RepPedido(iA, ip)) & "</Td>"
                                End If
                            Next
                            texteEMail = texteEMail & "<Tr><Td>" & ArticleCodiNom(RepArticle(ip)) & "</Td><Td>" & Format(accIp, "#.00") & "</Td>" & textePart & "</Tr>"
                        Next
                        texteEMail = texteEMail & "</Table>" & "<Br>"
                        'sf_enviarMail "Secrehit@gmail.com", "ana@solucionesit365.com", Format(Now, "dddd dd ") & "REPOSICIO AUTOMÀTICA a " & proveedorNom & " " & DateDiff("n", TexteEmailHi, Now) & " n. ", TexteEmail, AppPath & "\DetallCalcul.html", ""
                        sf_enviarMail "Secrehit@gmail.com", rs("eMail"), Format(Now, "dddd dd ") & "REPOSICIO AUTOMÀTICA a " & proveedorNom & " " & DateDiff("n", TexteEmailHi, Now) & " n. ", texteEMail, "", AppPath & "\DetallCalcul.html"
                        MyKill AppPath & "\DetallCalcul.html"
                   End If
                End If
            End If
        End If
    End If
posna:

End Sub


Function NomTaulaPedidosUltimosDatos(dia As Date, Proveedor As String) As String
   Dim sql As String
    
   NomTaulaPedidosUltimosDatos = "PedidosUltimosDatos_" & Format(dia, "yyyy-mm") & "_" & Proveedor
   
   If Not ExisteixTaula(NomTaulaPedidosUltimosDatos) Then
        sql = "CREATE TABLE [" & NomTaulaPedidosUltimosDatos & "] ( "
        sql = sql & " [Id] [nvarchar](255) NOT NULL DEFAULT (newid()),"
        sql = sql & " [IdPedido] [nvarchar](255) NULL,"
        sql = sql & " [Proveedor][nvarchar](255) NULL,"
        sql = sql & " [Materia]  [nvarchar](255) NULL,"
        sql = sql & " [Cliente]  [nvarchar](255) NULL,"
        sql = sql & " [Fecha]    [datetime]   NULL, "
        sql = sql & " [RedondeoProveedor] [nvarchar](255) NULL,"
        sql = sql & " [RedondeoCliente]   [nvarchar](255) NULL,"
        sql = sql & " [FechaUltimaVenta]  [datetime]   NULL, "
        sql = sql & " [FechaUltimaDevolucion]  [datetime]   NULL "
        sql = sql & " ) ON [PRIMARY] "
        ExecutaComandaSql sql
        
        ExecutaComandaSql "Insert into [" & NomTaulaPedidosUltimosDatos & "] Select * from [PedidosUltimosDatos_" & Format(dia, "yyyy-mm") & "] Where Proveedor = '" & Proveedor & "' "
        
        ExecutaComandaSql "CREATE INDEX [" & NomTaulaPedidosUltimosDatos & "_Idx] ON [" & NomTaulaPedidosUltimosDatos & "] (fecha , Materia, Cliente, Proveedor, idpedido) "
   End If

End Function

Function NomTaulaPedidosZombis() As String
   Dim sql As String
    
   NomTaulaPedidosZombis = "ccPedidos_zombis"
   
   If Not ExisteixTaula(NomTaulaPedidosZombis) Then
        sql = "CREATE TABLE [" & NomTaulaPedidosZombis & "] ( "
        sql = sql & "[id] [nvarchar] (255) CONSTRAINT [DF_" & NomTaulaPedidosZombis & "_id] DEFAULT (newid()),"
        sql = sql & "[materiaPrima] [nvarchar] (255),"
        sql = sql & "[proveedor] [nvarchar] (255),"
        sql = sql & "[almacen] [nvarchar] (255),"
        sql = sql & "[cantidad] [numeric](18, 2) NULL,"
        sql = sql & "[fecha] [datetime] NULL CONSTRAINT [DF_" & NomTaulaPedidosZombis & "_fecha] DEFAULT (getdate()),"
        sql = sql & "[recepcion] [datetime] NULL CONSTRAINT [DF_" & NomTaulaPedidosZombis & "_recepcion] DEFAULT (getdate()),"
        sql = sql & "[precio] [numeric](18, 2) NULL,"
        sql = sql & "[activo] [bit] NULL CONSTRAINT [DF_" & NomTaulaPedidosZombis & "_activo] DEFAULT (1), "
        sql = sql & "[confirmado] [bit] NULL CONSTRAINT [DF_" & NomTaulaPedidosZombis & "_confirmado] DEFAULT (0), "
        sql = sql & "[TimeStamp] [datetime] NULL CONSTRAINT [DF_" & NomTaulaPedidosZombis & "TimeStamp] DEFAULT (getdate()), "
        sql = sql & "[Qui] [nvarchar] (255) NULL "
        sql = sql & ") ON [PRIMARY] "
        ExecutaComandaSql sql
   End If

End Function

Sub CridaComandes()
    Dim sql, i, rs
    
        sql = "Select distinct Pr.Valor From "
        sql = sql & "ccnombrevalor Pr join "
        sql = sql & "ccnombrevalor b on left(b.nombre,11) = 'REPOSICION_' join "
        sql = sql & "Clients c on Pr.nombre = 'P_REPOSICION_' + cast(c.codi  as nvarchar) And b.nombre = 'REPOSICION_' + cast(c.codi  as nvarchar) join "
        sql = sql & "articlespropietats p on p.variable = 'MatPri' "
        sql = sql & "where  left(Pr.nombre,13) = 'P_REPOSICION_' "

        Set rs = Db.OpenResultset(sql)
        Dim Proveedores()
        i = 0
        ReDim Proveedores(0)
        While Not rs.EOF
            i = i + 1
            ReDim Preserve Proveedores(i)
            Proveedores(i) = rs(0)
            rs.MoveNext
        Wend
        rs.Close
        Dim K
        For K = 1 To i
'            PedidoCalcula CStr(Proveedores(K))
        Next

End Sub


Function AvisSms(Movil, ImportDescuadre, JaAvisats) As Boolean
    Dim rs As rdoResultset, K, Persona
    
    AvisSms = False
    Movil = ""
    ImportDescuadre = 0
    K = 0
    Set rs = Db.OpenResultset("select * from dependentesextes where nom ='avisosSMS' and valor = 'on'")
    While (Not rs.EOF) And (K < JaAvisats)
        K = K + 1
        rs.MoveNext
    Wend
    
    If K = JaAvisats And Not rs.EOF Then
        Persona = rs("Id")
        Set rs = Db.OpenResultset("select * from dependentesextes where nom ='TLF_MOBIL' and id = '" & Persona & "' ")
        If Not rs.EOF Then
            If Not IsNull(rs("Valor")) Then
                If Len(rs("Valor")) > 0 Then
                    AvisSms = True
                    If Len(rs("Valor")) = 9 Then Movil = "+34" & rs("Valor")
                    Set rs = Db.OpenResultset("select * from dependentesextes where nom ='descuadresms'  and id = '" & Persona & "'  ")
                    If Not rs.EOF Then If Not IsNull(rs("Valor")) Then If IsNumeric(rs("Valor")) Then ImportDescuadre = rs("Valor")
                End If
            End If
        End If
    End If
    
End Function

Sub CreaAsientoCtb(idN, o, c, Doc, data As Date, desc, TipIva, iva, SubC, concepto, de, Ha, idFac)
    Dim sql As String
    
    ExecutaComandaSql "Delete " & DonamNomTaulaAsientosContables(data) & " Where IdNorma43 = '" & idN & "' And orden = '" & o & "'"

    sql = "Insert into " & DonamNomTaulaAsientosContables(data) & " (idNorma43, orden, HABER, DEBE, CONCEPTO, SUBCUENTA, IVA, T_IVA, DESCRIPCION, FECHA, N_DOC, FacturaId, C) values "
    sql = sql & "('" & idN & "', " & o & ", " & Ha & ", " & de & ", '" & concepto & "','" & SubC & "','" & iva & "','" & TipIva & "','" & desc & "','" & data & "','" & Doc & "','" & idFac & "','" & c & "')"
    ExecutaComandaSql sql
    
    If o = 1 Then
        ExecutaComandaSql "update " & DonamNomTaulaAsientosContables(data) & " set numRegistre='" & ContabilitatNumRegistreNou(data) & "' Where IdNorma43 = '" & idN & "' And orden = '" & o & "'"
    End If
        
End Sub

Sub CreaAsientoCtbBis(idN, o, c, Doc, data As Date, desc, TipIva, iva, SubC, concepto, de, Ha, idFac, refInterna)
    Dim sql As String
    
    ExecutaComandaSql "Delete " & DonamNomTaulaAsientosContables(data) & " Where IdNorma43 = '" & idN & "' And orden = '" & o & "'"

    sql = "Insert into " & DonamNomTaulaAsientosContables(data) & " (idNorma43, orden, HABER, DEBE, CONCEPTO, SUBCUENTA, IVA, T_IVA, DESCRIPCION, FECHA, N_DOC, FacturaId, C, referenciaInterna) values "
    sql = sql & "('" & idN & "', " & o & ", " & Ha & ", " & de & ", '" & concepto & "','" & SubC & "','" & iva & "','" & TipIva & "','" & desc & "','" & data & "','" & Doc & "','" & idFac & "','" & c & "','" & refInterna & "')"
    ExecutaComandaSql sql
    
    If o = 1 Then
        ExecutaComandaSql "update " & DonamNomTaulaAsientosContables(data) & " set numRegistre='" & ContabilitatNumRegistreNou(data) & "' Where IdNorma43 = '" & idN & "' And orden = '" & o & "'"
    End If
        
End Sub


Function ContabilitatNumRegistreNou(data As Date) As Double
    Dim rs As rdoResultset
    
    Set rs = Db.OpenResultset("Select isnull(max(cast(NumRegistre as numeric)),0) From " & DonamNomTaulaAsientosContables(data))
    ContabilitatNumRegistreNou = 10
    If Not rs.EOF Then ContabilitatNumRegistreNou = CDbl(rs(0))
    ContabilitatNumRegistreNou = ContabilitatNumRegistreNou + 1
    
End Function

Function BuscaclientCodi(nom As String)
    Dim rs As rdoResultset
    Dim Nnom
    BuscaclientCodi = 0
    Nnom = Join(Split(nom, "'"), "`")
    Set rs = Db.OpenResultset("Select Codi from clients where nom = '" & Nnom & "' or [nom Llarg] = '" & Nnom & "'")
    If Not rs.EOF Then
        BuscaclientCodi = rs("Codi")
    End If
    
    
End Function

Function CarregaLlistaBlanca() As String
    Dim rs As rdoResultset
    
    CarregaLlistaBlanca = ""
On Error GoTo nor
    Set rs = Db.OpenResultset("Select isnull(CodiArticle,0) CodiArticle,* from articlespropietats where variable = 'CompraExterna'  and valor = 'on'")
    While Not rs.EOF
        CarregaLlistaBlanca = CarregaLlistaBlanca & "," & rs("CodiArticle")
        rs.MoveNext
    Wend
    CarregaLlistaBlanca = CarregaLlistaBlanca & ","
nor:
    
End Function

Function EsUsuariContable(NomUsu As String) As Boolean
    
    EsUsuariContable = False
    If UCase(NomUsu) = "[FALSE]" Then EsUsuariContable = True
    If UCase(NomUsu) = "[FALSO]" Then EsUsuariContable = True
    
    
    
End Function

Sub MyAsientoAdd(numAsiento, fecha, Cuenta1, Descripcio, Deve, Haver, FacturaId, texte As String, ReferenciaInterna)
    
    If InStr(Descripcio, "594") > 0 Or InStr(texte, "594") > 0 Then
        Cuenta1 = Cuenta1
    End If
    If InStr(Descripcio, "1842") > 0 Or InStr(texte, "1842") > 0 Then
        Cuenta1 = Cuenta1
    End If
    
    If FacturaId = "Nomina" Then Cuenta1 = codiNominaTreballador(FacturaId)
    If Trim(Cuenta1) = "40000000" Or Trim(Cuenta1) = 0 Or Cuenta1 = "" Then If Len(FacturaId) > 0 And Not FacturaId = 0 And Len(ReferenciaInterna) < 5 Then Cuenta1 = codiContableFacturaProveedor(FacturaId, fecha, ReferenciaInterna)
    If Trim(Cuenta1) = "43000000" Or Trim(Cuenta1) = 0 Or Cuenta1 = "" Then If Len(ReferenciaInterna) > 0 Then Cuenta1 = codiContable(ReferenciaInterna)
    
    If Trim(Cuenta1) = "40000000" Or Trim(Cuenta1) = "43000000" Or Trim(Cuenta1) = 0 Or Cuenta1 = "" Then Cuenta1 = BuscaComptePerNom(texte)
    
    If Trim(Cuenta1) = "40000000" Then
        Cuenta1 = Cuenta1
    End If
    If Trim(Cuenta1) = "43000000" Then
        Cuenta1 = Cuenta1
    End If
    
    AsientoAdd numAsiento, fecha, Cuenta1, "", 0, Descripcio, Deve, Haver, 0, 0, 0, ""

End Sub

Sub AsientoAdd(numAsiento, data, Cuenta1, Cuenta2, numFactura, Descripcio, Deve, Haver, BaseIva, PorcentajeIva, PorcentajeRet, Proyecto)
    If Deve = 0 And Haver = 0 And BaseIva = 0 Then Exit Sub
    If Trim(Cuenta1) = "" Then
        Cuenta1 = Cuenta1
    End If
    If BaseIva = 0 And PorcentajeIva = 0 Then
        If Left(Trim(Cuenta1), 3) = "472" Or Left(Trim(Cuenta1), 3) = "477" Then
           PorcentajeIva = Right(Trim(Cuenta1), 3)
           Cuenta2 = "47500000"
        End If
        If PorcentajeIva > 0 Then BaseIva = Round((Deve + Haver) / (PorcentajeIva / 100), 2)
    End If
    
    Select Case FormatExportacio
        'Case "A3": AsientoAddA3 NumAsiento, data, Cuenta1, Cuenta2, numFactura, Descripcio, Deve, Haver, BaseIva, PorcentajeIva, PorcentajeRet
        Case "CP": AsientoAddCp numAsiento, data, Cuenta1, Cuenta2, numFactura, Descripcio, Deve, Haver, BaseIva, PorcentajeIva, PorcentajeRet, Proyecto
        Case Else: AsientoAddCp numAsiento, data, Cuenta1, Cuenta2, numFactura, Descripcio, Deve, Haver, BaseIva, PorcentajeIva, PorcentajeRet, Proyecto
    End Select
End Sub

Sub AsientoAddSerie(numAsiento, data, Cuenta1, Cuenta2, serieFactura, numFactura, Descripcio, Deve, Haver, BaseIva, PorcentajeIva, PorcentajeRet, Proyecto, Optional claveOperacion As String)
    If Deve = 0 And Haver = 0 Then Exit Sub
    If Trim(Cuenta1) = "" Then
        Cuenta1 = Cuenta1
    End If
    If BaseIva = 0 And PorcentajeIva = 0 Then
        If Left(Trim(Cuenta1), 3) = "472" Or Left(Trim(Cuenta1), 3) = "477" Then
           PorcentajeIva = Right(Trim(Cuenta1), 3)
           Cuenta2 = "47500000"
        End If
        If PorcentajeIva > 0 Then BaseIva = Round((Deve + Haver) / (PorcentajeIva / 100), 2)
    End If
    
    Select Case FormatExportacio
        'Case "A3": AsientoAddA3 NumAsiento, data, Cuenta1, Cuenta2, numFactura, Descripcio, Deve, Haver, BaseIva, PorcentajeIva, PorcentajeRet
        Case "CP": AsientoAddCpSerie numAsiento, data, Cuenta1, Cuenta2, serieFactura, numFactura, Descripcio, Deve, Haver, BaseIva, PorcentajeIva, PorcentajeRet, Proyecto, claveOperacion
        Case Else: AsientoAddCpSerie numAsiento, data, Cuenta1, Cuenta2, serieFactura, numFactura, Descripcio, Deve, Haver, BaseIva, PorcentajeIva, PorcentajeRet, Proyecto
    End Select
End Sub



Sub AsientoAddA3(empresa, tipoReg, linea, data, Cuenta1, Cuenta2, numFactura, Descripcio, importe, BaseIva, PorcentajeIva, QuotaIva, PorcentajeRet)
    
'40000220140301143000680    Ventas STA.EULALIA            1FAC680001 IVentas STA.EULALIA            +0000000607.42                                                                                                                                           EN
'40000220140301970000000    Ventas STA.EULALIA IVA 4      CFAC680001 MVentas STA.EULALIA IVA 4      01+0000000447.9304.00+0000000017.92                                      01S                                                                             EN
'40000220140301970000000    Ventas STA.EULALIA IVA 10     CFAC680001 UVentas STA.EULALIA IVA 10     01+0000000128.7010.00+0000000012.87                                      01S                                                                             EN
    Dim codiEmp As Integer
    Dim campo As String
    Dim rsC As rdoResultset
    
    If empresa = "0" Then
        campo = "CampCodiComptabilitat"
    Else
        campo = empresa & "_CampCodiComptabilitat"
    End If

    codiEmp = 2
    Set rsC = Db.OpenResultset("select valor from constantsEmpresa where camp='" & campo & "'")
    If Not rsC.EOF Then
        If IsNumeric(rsC("valor")) Then codiEmp = CInt(rsC("valor"))
    End If
    
    DadesExportaCp = DadesExportaCp & "4"                           ' Constante 4
    DadesExportaCp = DadesExportaCp & Right("00000" & codiEmp, 5)   ' Empresa: Codi de empresa corresponent a A3
    DadesExportaCp = DadesExportaCp & Right("0000" & Year(data), 4) ' Any '2002
    DadesExportaCp = DadesExportaCp & Right("00" & Month(data), 2)  ' mes '01
    DadesExportaCp = DadesExportaCp & Right("00" & Day(data), 2)    ' dia '03
    If tipoReg = "1" Then                              '1:Cabecera de apuntes con IVA
        If importe < 0 Then                            '2=Abonos
            DadesExportaCp = DadesExportaCp & "2"
        Else                                           '1=Facturas
            DadesExportaCp = DadesExportaCp & tipoReg
        End If
    Else
        DadesExportaCp = DadesExportaCp & tipoReg      ' 1:Cabecera de apuntes con IVA (1=Facturas; 2=Abonos) 9:Detalle de apuntes con IVA (Facturas y Rectificativas)
    End If
    DadesExportaCp = DadesExportaCp & Left(Cuenta1 & Space(12), 12) 'Nivel 6 a 12 (cuenta de cliente o proveedor). Si no existe la cuenta se da de alta automáticamente en el plan contable.
    DadesExportaCp = DadesExportaCp & Left(Descripcio & Space(30), 30)  ' Nombre del cliente o Proveedor. Si existe en el plan contable se respeta.
    If tipoReg = "1" Then
        DadesExportaCp = DadesExportaCp & "1" '1 = Ventas, 2 = Compras, 3 = Bienes de Inversión
    Else
        If importe < 0 Then 'Abono
            DadesExportaCp = DadesExportaCp & "A" 'C = Cargo en Factura; A = Abono en factura
        Else
            DadesExportaCp = DadesExportaCp & "C" 'C = Cargo en Factura; A = Abono en factura
        End If
    End If
    DadesExportaCp = DadesExportaCp & Left(numFactura & Space(10), 10)  ' Número de factura o documento
    DadesExportaCp = DadesExportaCp & linea  'I = Inicio apunte M = Media apunte (Líneas intermedias) U = Ultimo apunte (Ultima línea del asiento) Obligatoriamente, todo asiento acabar con U. Si existen asientos con más de 2 líneas se ha de especificar las intermedias con M.
    DadesExportaCp = DadesExportaCp & Left(Descripcio & Space(30), 30)  ' Descripcio
    If tipoReg = "1" Then 'Alta de cabecera de apuntes con IVA
        DadesExportaCp = DadesExportaCp & "+" & Right(String(13, "0") & FormatNumber(Abs(importe), 2, -1, 0, 0), 13) 'Importe total factura
        DadesExportaCp = DadesExportaCp & Space(139)
    ElseIf tipoReg = "9" Then 'Detalle de apuntes con IVA
        DadesExportaCp = DadesExportaCp & "01"  'Subtipo de factura (01 a 07)
                                                'Facturas expedidas:
                                                '01: Operaciones interiores sujetas a IVA
                                                '02 : Operaciones exentas sin derecho a deducción
                                                '3:  Entregas intracomunitarias
                                                '04: Entregas intracomunitarias Ops. Triangulares
                                                '05: Operaciones con Canarias, Ceuta y Melilla
                                                '6:  Exportaciones
                                                '07: Otras operaciones no sujetas a IVA
                                                'Facturas Recibidas:
                                                '01: Operaciones interiores IVA deducible
                                                '02: Compensaciones agrarias.
                                                '3:  Adquisiciones intracomunitarias
                                                '04: Inversión del Sujeto Pasivo
                                                '6:  Importaciones
                                                '07: IVA no deducible
        'IVA
        DadesExportaCp = DadesExportaCp & "+" & Right(String(13, "0") & FormatNumber(Abs(BaseIva), 2, -1, 0, 0), 13) ' Base imponible
        DadesExportaCp = DadesExportaCp & Format(PorcentajeIva, "00.00")   'xx.xx
        DadesExportaCp = DadesExportaCp & "+" & Right(String(13, "0") & FormatNumber(Abs(QuotaIva), 2, -1, 0, 0), 13) ' Cuota de IVA
        
        'RECARGO
        DadesExportaCp = DadesExportaCp & Space(5)  'Porcentaje de Recargo
        DadesExportaCp = DadesExportaCp & Space(14) 'Cuota de Recargo
        DadesExportaCp = DadesExportaCp & Space(5)  'Porcentaje de Retención
        DadesExportaCp = DadesExportaCp & Space(14) 'Cuota de Retención
                
        DadesExportaCp = DadesExportaCp & "01"  'Impreso
                                                '01: 347
                                                '02: 349
                                                '03: 115 Dinerarias
                                                '04: 115 Especie
                                                '05: 110 Profesionales Dinerarias
                                                '06: 110 Profesionales en especie
                                                '07: 110 Agrarios Dinerarias
                                                '08: 110 Agrarios en especie
                                                '09: 110 Módulos empresariales dinerarias
                                                '10: 110 Módulos empresariales en especie
        DadesExportaCp = DadesExportaCp & "S"   'Operación sujeta a IVA S: Operación con IVA N: Operación sin IVA (3)
        DadesExportaCp = DadesExportaCp & Space(77)  'Reserva
    End If

    DadesExportaCp = DadesExportaCp & "E"               'Euros  'E
    DadesExportaCp = DadesExportaCp & "N"               'No     'N Indicador de generado (N)
    DadesExportaCp = DadesExportaCp & Chr(13) & Chr(10) 'Fi     ' chr13 + chr10
End Sub



Sub AsientoAddCp(numAsiento, data, Cuenta1, Cuenta2, numFactura, Descripcio, Deve, Haver, BaseIva, PorcentajeIva, PorcentajeRet, Proyecto)
    
    DadesExportaCp = DadesExportaCp & Right(Space(6) & numAsiento, 6)     ' Núm. del asiento '000001
    DadesExportaCp = DadesExportaCp & Right("0000" & Year(data), 4)      ' Año '2002
    DadesExportaCp = DadesExportaCp & Right("00" & Month(data), 2)       ' Mes '01
    DadesExportaCp = DadesExportaCp & Right("00" & Day(data), 2)         ' Día '03
    DadesExportaCp = DadesExportaCp & Left(Cuenta1 & Space(12), 12)      ' Cuenta destino '430000000000
    DadesExportaCp = DadesExportaCp & Left(Cuenta2 & Space(12), 12)      ' Cuenta VENTAS
    DadesExportaCp = DadesExportaCp & Right(Space(16) & "0.00", 16)      ' Importe Debe Pts
    DadesExportaCp = DadesExportaCp & Left(Descripcio & Space(25), 25)   ' Concepto del asiento 'DESCRIPCION VENTA
    DadesExportaCp = DadesExportaCp & Right(Space(16) & "0.00", 16)      ' Importe Haber Pts
    DadesExportaCp = DadesExportaCp & Right(Space(8) & numFactura, 8)    ' Num Factura '00000073'
    DadesExportaCp = DadesExportaCp & Right(Space(16) & "0.00", 16)      ' Base imponible del IVA en Pts
    DadesExportaCp = DadesExportaCp & Right(Space(5) & FormatNumber(PorcentajeIva, 2), 5) ' Porcentage de IVA
    DadesExportaCp = DadesExportaCp & Right(Space(5) & PorcentajeRet, 5) ' Recargo de equivalencia
    DadesExportaCp = DadesExportaCp & Right(Space(10) & numFactura, 10)  ' Número de documento
    DadesExportaCp = DadesExportaCp & Right(Space(3), 3)                 ' Código de departamento
    DadesExportaCp = DadesExportaCp & Left(Proyecto & Space(6), 6)       ' Código del proyecto
    DadesExportaCp = DadesExportaCp & Right(Space(1), 1)                 ' Punteo (interno)
    DadesExportaCp = DadesExportaCp & Right(Space(6) & "0", 6)           ' Númerico de casación (interno)
    DadesExportaCp = DadesExportaCp & Right(Space(1) & "0", 1)           ' Tipo de casado (interno)
    DadesExportaCp = DadesExportaCp & Right(Space(6) & "0", 6)           ' Número de pago
    DadesExportaCp = DadesExportaCp & Right(Space(16) & "0.000000", 16)  ' Cambio a aplicar
    DadesExportaCp = DadesExportaCp & Right(Space(16) & "0.00", 16)      ' Importe debe moneda extranjera
    DadesExportaCp = DadesExportaCp & Right(Space(16) & "0.00", 16)      ' Importe haber moneda extranjera
    DadesExportaCp = DadesExportaCp & Right(Space(1), 1)                 ' Auxiliar (interno)
    DadesExportaCp = DadesExportaCp & Right(Space(1), 1)                 ' Serie de la facturación
    DadesExportaCp = DadesExportaCp & Right(Space(4), 4)                 ' Sucursal (sin uso)
    DadesExportaCp = DadesExportaCp & Right(Space(5), 5)                 ' Código de la divisa
    DadesExportaCp = DadesExportaCp & Right(Space(16) & "0.00", 16)      ' Importe auxiliar moneda extranjera
    DadesExportaCp = DadesExportaCp & Right(Space(1) & "2", 1)           ' Moneda en USo (1-Peseteas, 2-Euros)
    DadesExportaCp = DadesExportaCp & Right(Space(16) & Replace(FormatNumber(Round(Deve, 2), 2), ",", ""), 16)     ' Importe al debe en euros
    DadesExportaCp = DadesExportaCp & Right(Space(16) & Replace(FormatNumber(Round(Haver, 2), 2), ",", ""), 16)   ' Importe al haber en euros
    DadesExportaCp = DadesExportaCp & Right(Space(16) & Replace(FormatNumber(Round(BaseIva, 2), 2), ",", ""), 16)   ' Base imponible del IVA en Euros
    DadesExportaCp = DadesExportaCp & Right(Space(1) & "F", 1)           ' NoConv (interno)
    DadesExportaCp = DadesExportaCp & Right(Space(10), 10)               ' Código de Activo
    DadesExportaCp = DadesExportaCp & Right(Space(1), 1)                 ' serie de Factura rectificada
    DadesExportaCp = DadesExportaCp & Right(Space(8) & "0", 8)           ' Número factura rectificada
    DadesExportaCp = DadesExportaCp & Right(Space(16) & "0.00", 16)      ' Base imponible factura rectificada
    DadesExportaCp = DadesExportaCp & Right(Space(16) & "0.00", 16)      ' Base imponible factura rectificada
    DadesExportaCp = DadesExportaCp & Right(Space(1) & "F", 1)           ' Factura rectificada (T en caso de factura rectificada)
    DadesExportaCp = DadesExportaCp & Right(Space(4), 4)                 ' Año '2002 FacturaRectificada
    DadesExportaCp = DadesExportaCp & Right(Space(2), 2)                 ' Mes '01   FacturaRectificada
    DadesExportaCp = DadesExportaCp & Right(Space(2), 2)                 ' Día '03   FacturaRectificada
    DadesExportaCp = DadesExportaCp & Right(Space(2) & "EF", 2)
    DadesExportaCp = DadesExportaCp & Right(Space(6) & "0", 6)
    DadesExportaCp = DadesExportaCp & Right(Space(1) & "F", 1)
    DadesExportaCp = DadesExportaCp & Right(Space(12), 12)
    DadesExportaCp = DadesExportaCp & Right(Space(1) & "F", 1)
    DadesExportaCp = DadesExportaCp & Right(Space(16), 16)
    DadesExportaCp = DadesExportaCp & Chr(13) & Chr(10)                                                                    ' Fin     ' chr13 + chr10

End Sub


Sub AsientoAddCpSerie(numAsiento, data, Cuenta1, Cuenta2, serieFactura, numFactura, Descripcio, Deve, Haver, BaseIva, PorcentajeIva, PorcentajeRet, Proyecto, Optional claveOperacion As String)
    DadesExportaCp = DadesExportaCp & Right(Space(6) & numAsiento, 6)     ' Núm. del asiento '000001
    DadesExportaCp = DadesExportaCp & Right("0000" & Year(data), 4)      ' Año '2002
    DadesExportaCp = DadesExportaCp & Right("00" & Month(data), 2)       ' Mes '01
    DadesExportaCp = DadesExportaCp & Right("00" & Day(data), 2)         ' Día '03
    DadesExportaCp = DadesExportaCp & Left(Cuenta1 & Space(12), 12)      ' Cuenta destino '430000000000
    DadesExportaCp = DadesExportaCp & Left(Cuenta2 & Space(12), 12)      ' Cuenta VENTAS
    DadesExportaCp = DadesExportaCp & Right(Space(16) & "0.00", 16)      ' Importe Debe Pts
    DadesExportaCp = DadesExportaCp & Left(Descripcio & Space(25), 25)   ' Concepto del asiento 'DESCRIPCION VENTA
    DadesExportaCp = DadesExportaCp & Right(Space(16) & "0.00", 16)      ' Importe Haber Pts
    DadesExportaCp = DadesExportaCp & Right(Space(8) & numFactura, 8)    ' Num Factura '00000073'
    DadesExportaCp = DadesExportaCp & Right(Space(16) & "0.00", 16)      ' Base imponible del IVA en Pts
    DadesExportaCp = DadesExportaCp & Right(Space(5) & FormatNumber(PorcentajeIva, 2), 5) ' Porcentage de IVA
    DadesExportaCp = DadesExportaCp & Right(Space(5) & PorcentajeRet, 5) ' Recargo de equivalencia
    DadesExportaCp = DadesExportaCp & Right(Space(10) & numFactura, 10)  ' Número de documento
    DadesExportaCp = DadesExportaCp & Right(Space(3), 3)                 ' Código de departamento
    DadesExportaCp = DadesExportaCp & Left(Proyecto & Space(6), 6)       ' Código del proyecto
    DadesExportaCp = DadesExportaCp & Right(Space(1), 1)                 ' Punteo (interno)
    DadesExportaCp = DadesExportaCp & Right(Space(6) & "0", 6)           ' Númerico de casación (interno)
    DadesExportaCp = DadesExportaCp & Right(Space(1) & "0", 1)           ' Tipo de casado (interno)
    DadesExportaCp = DadesExportaCp & Right(Space(6) & "0", 6)           ' Número de pago
    DadesExportaCp = DadesExportaCp & Right(Space(16) & "0.000000", 16)  ' Cambio a aplicar
    DadesExportaCp = DadesExportaCp & Right(Space(16) & "0.00", 16)      ' Importe debe moneda extranjera
    DadesExportaCp = DadesExportaCp & Right(Space(16) & "0.00", 16)      ' Importe haber moneda extranjera
    DadesExportaCp = DadesExportaCp & Right(Space(1), 1)                 ' Auxiliar (interno)
    DadesExportaCp = DadesExportaCp & Right(Space(1) & serieFactura, 1)  ' Serie de la facturación
    DadesExportaCp = DadesExportaCp & Right(Space(4), 4)                 ' Sucursal (sin uso)
    DadesExportaCp = DadesExportaCp & Right(Space(5), 5)                 ' Código de la divisa
    DadesExportaCp = DadesExportaCp & Right(Space(16) & "0.00", 16)      ' Importe auxiliar moneda extranjera
    DadesExportaCp = DadesExportaCp & Right(Space(1) & "2", 1)           ' Moneda en USo (1-Peseteas, 2-Euros)
    DadesExportaCp = DadesExportaCp & Right(Space(16) & Replace(FormatNumber(Round(Deve, 2), 2), ",", ""), 16)     ' Importe al debe en euros
    DadesExportaCp = DadesExportaCp & Right(Space(16) & Replace(FormatNumber(Round(Haver, 2), 2), ",", ""), 16)   ' Importe al haber en euros
    DadesExportaCp = DadesExportaCp & Right(Space(16) & Replace(FormatNumber(Round(BaseIva, 2), 2), ",", ""), 16)   ' Base imponible del IVA en Euros
    DadesExportaCp = DadesExportaCp & Right(Space(1) & "F", 1)           ' NoConv (interno)
    DadesExportaCp = DadesExportaCp & Right(Space(10), 10)               ' Código de Activo
    DadesExportaCp = DadesExportaCp & Right(Space(1), 1)                 ' serie de Factura rectificada
    DadesExportaCp = DadesExportaCp & Right(Space(8) & "0", 8)           ' Número factura rectificada
    DadesExportaCp = DadesExportaCp & Right(Space(16) & "0.00", 16)      ' Base imponible factura rectificada
    DadesExportaCp = DadesExportaCp & Right(Space(16) & "0.00", 16)      ' Base imponible factura rectificada
    DadesExportaCp = DadesExportaCp & Right(Space(1) & "F", 1)           ' Factura rectificada (T en caso de factura rectificada)
    DadesExportaCp = DadesExportaCp & Right(Space(4), 4)                 ' Año '2002 FacturaRectificada
    DadesExportaCp = DadesExportaCp & Right(Space(2), 2)                 ' Mes '01   FacturaRectificada
    DadesExportaCp = DadesExportaCp & Right(Space(2), 2)                 ' Día '03   FacturaRectificada
    DadesExportaCp = DadesExportaCp & Right(Space(2) & "EF", 2)
    DadesExportaCp = DadesExportaCp & Right(Space(6) & "0", 6)
    DadesExportaCp = DadesExportaCp & Right(Space(1) & "F", 1)
    DadesExportaCp = DadesExportaCp & Right(Space(12), 12)
    DadesExportaCp = DadesExportaCp & Right(Space(1) & "F", 1)
    DadesExportaCp = DadesExportaCp & Right(Space(16), 16)
    DadesExportaCp = DadesExportaCp & Right(Space(247), 247)
    DadesExportaCp = DadesExportaCp & Right(Space(1) & claveOperacion, 1)
    DadesExportaCp = DadesExportaCp & Chr(13) & Chr(10)                                                                    ' Fin     ' chr13 + chr10
End Sub

Sub AsientoAddMURANO(TipoMov, numAsiento, data, Cuenta1, Cuenta2, Descripcio, Deve, Haver)
    
    Dim sq As String, Sq2 As String

If Abs(Deve) < 0.01 Then Deve = 0
If Abs(Haver) < 0.01 Then Haver = 0

    '2469DBD7-E336-478D-AE11-6155825E986C    2016    9999    1   10  H   570000002   570020002   2016-09-27 00:00:00.000         Ejemplo de Salida Metálico a Caja Fuerte    500.0000000000
    '-1  0               NULL    9   0   0   0   2   2016-09-27 13:21:47.760 EN  0   0               0.0000000000    0.0000000000    0.0000000000    0   0   NULL        0   0   0               -1  0       26  0   00000000-0000-0000-0000-000000000000    0   0   A7D3A9DE-4D25-40D4-81F0-D7FA6D1B2F1B    0   0   0   2008            0
    sq = "":     Sq2 = ""
    sq = sq & "Insert into [WEB].[Sage].[dbo].[Movimientos] (":     Sq2 = Sq2 & " Values ("
    'Sq = Sq & "[MovPosicion]":                                      Sq2 = Sq2 & "''"
    sq = sq & "[Ejercicio]":                                        Sq2 = Sq2 & "'" & Format(data, "yyyy") & "'"
    sq = sq & ",[CodigoEmpresa]":                                   Sq2 = Sq2 & "," & EmpresaMurano
    sq = sq & ",[TipoMov]":                                         Sq2 = Sq2 & "," & TipoMov
    sq = sq & ",[Asiento]":                                         Sq2 = Sq2 & ",'" & numAsiento & "'"
    If Deve = 0 Then
        sq = sq & ",[CargoAbono]":                                      Sq2 = Sq2 & ",'H'"
    Else
        sq = sq & ",[CargoAbono]":                                      Sq2 = Sq2 & ",'D'"
    End If


    sq = sq & ",[CodigoCuenta]":                                    Sq2 = Sq2 & ",'" & Cuenta1 & "'"
    sq = sq & ",[Contrapartida]":                                   Sq2 = Sq2 & ",'" & Cuenta2 & "'"
    sq = sq & ",[FechaAsiento]":                                    Sq2 = Sq2 & ",convert(datetime,'" & Format(data, "dd/mm/yy") & "',3)"
    'Sq = Sq & ",[TipoDocumento]":                                   Sq2 = Sq2 & ",''"
    'Sq = Sq & ",[DocumentoConta]":                                  Sq2 = Sq2 & ",''"
    sq = sq & ",[Comentario]":                                      Sq2 = Sq2 & ",'" & Left(Descripcio, 40) & "'"
    sq = sq & ",[ImporteAsiento]":                                  Sq2 = Sq2 & ",'" & CDbl(Deve) + CDbl(Haver) & "'"
    sq = sq & ",[StatusAcumulacion]":                               Sq2 = Sq2 & ",-1"
    sq = sq & ",[CodigoDiario]":                                    Sq2 = Sq2 & ",0"
    'Sq = Sq & ",[CodigoCanal]":                                     Sq2 = Sq2 & ",''"
    sq = sq & ",[CodigoActividad]":                                 Sq2 = Sq2 & ",''"
    sq = sq & ",[Previsiones]":                                     Sq2 = Sq2 & ",''"
    sq = sq & ",[FechaVencimiento]":                                Sq2 = Sq2 & ",NULL"
    sq = sq & ",[NumeroPeriodo]":                                   Sq2 = Sq2 & "," & Month(data)
    sq = sq & ",[StatusConciliacion]":                              Sq2 = Sq2 & ",0"
    sq = sq & ",[StatusSaldo]":                                     Sq2 = Sq2 & ",0"
    sq = sq & ",[StatusTraspaso]":                                  Sq2 = Sq2 & ",0"
    sq = sq & ",[CodigoUsuario]":                                   Sq2 = Sq2 & ",2"
    'Sq = Sq & ",[FechaGrabacion]":                                  Sq2 = Sq2 & ",convert(datetime,'" & Format(Now(), "dd/mm/yy") & "',3)"
    sq = sq & ",[FechaGrabacion]":                                  Sq2 = Sq2 & ",getdate()"
    sq = sq & ",[TipoEntrada]":                                     Sq2 = Sq2 & ",'EN'"
    sq = sq & ",[StatusImpagado]":                                  Sq2 = Sq2 & ",0"
    sq = sq & ",[Diseño]":                                          Sq2 = Sq2 & ",0"
    sq = sq & ",[CodigoDepartamento]":                              Sq2 = Sq2 & ",''"
    sq = sq & ",[CodigoSeccion]":                                   Sq2 = Sq2 & ",''"
    sq = sq & ",[CodigoDivisa]":                                    Sq2 = Sq2 & ",''"
    sq = sq & ",[ImporteCambio]":                                   Sq2 = Sq2 & ",0"
    sq = sq & ",[ImporteDivisa]":                                   Sq2 = Sq2 & ",0"
    sq = sq & ",[FactorCambio]":                                    Sq2 = Sq2 & ",0"
    sq = sq & ",[CodigoConcepto]":                                  Sq2 = Sq2 & ",0"
    sq = sq & ",[CodigoConciliacion]":                              Sq2 = Sq2 & ",0"
    sq = sq & ",[FechaConciliacion]":                               Sq2 = Sq2 & ",NULL"
    sq = sq & ",[CodigoProyecto]":                                  Sq2 = Sq2 & ",''"
    sq = sq & ",[StatusAnalitica]":                                 Sq2 = Sq2 & ",0"
    sq = sq & ",[LibreN1]":                                         Sq2 = Sq2 & ",0"
    sq = sq & ",[LibreN2]":                                         Sq2 = Sq2 & ",0"
    sq = sq & ",[LibreA1]":                                         Sq2 = Sq2 & ",''"
    sq = sq & ",[LibreA2]":                                         Sq2 = Sq2 & ",''"
    sq = sq & ",[IdDelegacion]":                                    Sq2 = Sq2 & ",''"
    sq = sq & ",[EnEuros_]":                                        Sq2 = Sq2 & ",-1"
    sq = sq & ",[StatusExportado]":                                 Sq2 = Sq2 & ",0"
    sq = sq & ",[DocumentoConciliacion]":                           Sq2 = Sq2 & ",''"
    'Sq = Sq & ",[OrdenMovimientos]":                                Sq2 = Sq2 & ",'0'"
    sq = sq & ",[ForzarSaldoVivo]":                                 Sq2 = Sq2 & ",0"
    sq = sq & ",[MovCartera]":                                      Sq2 = Sq2 & ",'00000000-0000-0000-0000-000000000000'"
    sq = sq & ",[ControlBorrado]":                                  Sq2 = Sq2 & ",0"
    sq = sq & ",[AgrupacionCuadre]":                                Sq2 = Sq2 & ",0"
    sq = sq & ",[IdDiseñoEntrada]":                                 Sq2 = Sq2 & ",'A7D3A9DE-4D25-40D4-81F0-D7FA6D1B2F1B'"
    sq = sq & ",[NivelIntegridad]":                                 Sq2 = Sq2 & ",0"
    sq = sq & ",[sysTraspasoLWG]":                                  Sq2 = Sq2 & ",0"
    sq = sq & ",[EmpresaOrigen]":                                   Sq2 = Sq2 & ",0"
    sq = sq & ",[TipoPlanCuenta]":                                  Sq2 = Sq2 & ",2008"
    sq = sq & ",[CodigoCuentaANT_]":                                Sq2 = Sq2 & ",''"
    sq = sq & ",[ContrapartidaANT_]":                               Sq2 = Sq2 & ",''"
    sq = sq & ",[Metalico347]":                                     Sq2 = Sq2 & ",0"
    sq = sq & ",[IdAsientoExterno]":                                Sq2 = Sq2 & ",''"
    sq = sq & ",[CodigoElemento]":                                  Sq2 = Sq2 & ",''"
    sq = sq & ") ":                                                 Sq2 = Sq2 & ") "
    sq = sq & Sq2
    
On Error GoTo norR

    MuranoExecute sq
    Exit Sub
    
norR:
    sf_enviarMail "email@hit.cat", "ana@solucionesit365.com", "ERROR TRASPASO MURANO", sq, "", ""

End Sub

Function cIVA(Quota, Optional rec As Boolean = False)
    Dim Num, strCIva
    Dim NQuota As Double
    Dim SQuota As String
    'Generamos una subcuenta de IVA en función de la quota, y los digitos de la subcuenta.
    '--------------------------------------------------------------------------------------
    
    
    SQuota = Quota
    If rec And UCase(EmpresaActual) <> UCase("Vilapan") Then SQuota = SQuota + 400
    
    Num = Len(SQuota)
    Num = Num + 3
    Num = Num - nDigitos
    Num = CInt(Num)
    Num = Abs(Num)
        
    strCIva = "477" & Right("000000000000", Num)
    If UCase(EmpresaActual) <> UCase("Vilapan") Then
        strCIva = strCIva & SQuota
    Else
        strCIva = strCIva & "0"
    End If
    strCIva = strCIva & Space(12)
    strCIva = Left(strCIva, 12)

    cIVA = strCIva
    
End Function

Function cIvaCompras(c)
   cIvaCompras = Left("472" & Right("000000000000" & c, nDigitos - 3) & Space(12), 12)
End Function

Function codiContable(c)
    Dim CodiClient, strCodi, rs As rdoResultset, Num
    
    CodiClient = c
    codiContable = ""
    strCodi = ""
    If CodiClient = "" Then
        strCodi = ""
    Else
        'Buscamos el código de facturación del cliente. Si ni dispone de el, creamos uno a partir de su código de cliente
        
        ExecutaComandaSql "DELETE ConstantsClient  WHERE variable = 'CodiContable' AND VALOR IN(SELECT VALOR FROM ConstantsClient WHERE variable = 'CodiContable' GROUP BY (Valor) HAVING COUNT(*) > 1)"
        If IsNumeric(CodiClient) Then
            Set rs = Db.OpenResultset("SELECT Valor FROM " & tablaConstantsClient() & " WHERE  codi = " & CodiClient & " AND variable = 'CodiContable' ")
            If Not rs.EOF Then If Not IsNull(rs("Valor")) And (Len(rs("Valor")) > 0) Then codiContable = rs("Valor")
        Else
            CodiClient = 0
        End If
        If (codiContable = "") Then codiContable = CodiClient

        Num = nDigitos
        Num = Num - 2
        Num = Abs(Num)
        strCodi = "43"
        
        Set rs = Db.OpenResultset("SELECT Valor FROM " & tablaConstantsClient() & " WHERE  codi = '" & CodiClient & "' AND variable = 'Cuenta4301' ")
        If Not rs.EOF Then
            strCodi = "4301"
            Num = Num - 2
        End If
        
        If IsNumeric(CodiClient) Then
            Set rs = Db.OpenResultset("SELECT Valor FROM ConstantsClient WHERE  codi = " & CodiClient & " AND variable = 'EsCalaix' ")
            If Not rs.EOF Then If Not IsNull(rs("Valor")) Then If rs("Valor") = "EsCalaix" Then strCodi = "57"
        End If
    
        strCodi = strCodi & Right("000000000000" & codiContable, Num)
        strCodi = strCodi & Space(12)
        strCodi = Left(strCodi, 12)
        strCodi = codiContable
    End If
    codiContable = strCodi
End Function

Function codiContable2(c)
    Dim CodiClient, strCodi, rs As rdoResultset, Num
    
    CodiClient = c
    codiContable2 = ""
    strCodi = ""
    If CodiClient = "" Then
        strCodi = ""
    Else
        'Buscamos el código de facturación del cliente. Si ni dispone de el, creamos uno a partir de su código de cliente
        If IsNumeric(CodiClient) Then
            Set rs = Db.OpenResultset("SELECT Valor FROM " & tablaConstantsClient() & " WHERE  codi = " & CodiClient & " AND variable = 'CodiContable' ")
            If Not rs.EOF Then If Not IsNull(rs("Valor")) And (Len(rs("Valor")) > 0) Then codiContable2 = rs("Valor")
        Else
            CodiClient = 0
        End If
        If (codiContable2 = "") Then codiContable2 = CodiClient

        Num = nDigitos
        Num = Num - 2
        Num = Abs(Num)
        strCodi = "43"
        
        Set rs = Db.OpenResultset("SELECT Valor FROM " & tablaConstantsClient() & " WHERE  codi = '" & CodiClient & "' AND variable = 'Cuenta4301' ")
        If Not rs.EOF Then
            strCodi = "4301"
            Num = Num - 2
        End If
        
        strCodi = strCodi & Right("000000000000" & codiContable2, Num)
        strCodi = strCodi & Space(12)
        strCodi = Left(strCodi, 12)
    End If
    codiContable2 = strCodi
End Function

Function codiCalaix(c)
    Dim CodiClient, strCodi, rs As rdoResultset, Num
    
    CodiClient = c
    codiCalaix = ""
    strCodi = ""
    If CodiClient = "" Then CodiClient = 0
    
    'Buscamos el código de facturación del cliente. Si ni dispone de el, creamos uno a partir de su código de cliente
    Set rs = Db.OpenResultset("SELECT Valor FROM " & tablaConstantsClient() & " WHERE  codi = " & CodiClient & " AND variable = 'CodiContable' ")
    If Not rs.EOF Then If Not IsNull(rs("Valor")) And (Len(rs("Valor")) > 0) Then codiCalaix = rs("Valor")
    If (codiCalaix = "") Then codiCalaix = CodiClient

    Num = nDigitos
    Num = Num - 2
    Num = Abs(Num)
    
    strCodi = "57"
    
    Set rs = Db.OpenResultset("SELECT Valor FROM ConstantsClient WHERE  codi = " & CodiClient & " AND variable = 'EsCalaix' ")
    If Not rs.EOF Then If Not IsNull(rs("Valor")) Then If rs("Valor") = "EsCalaix" Then strCodi = "57"
    
    strCodi = strCodi & Right("000000000000" & codiCalaix, Num)
    strCodi = strCodi & Space(12)
    strCodi = Left(strCodi, 12)

    codiCalaix = strCodi
End Function


Function codiNominaTreballador(c)
    Dim CodiClient, strCodi, rs As rdoResultset, Num
    c = 0
    codiNominaTreballador = Left("465" & Right("000000000000" & c, nDigitos - 3) & Space(12), 12)
    
End Function


Function codiContableProveedor(cc)
    Dim Ccuennttaa As String, CodiClient, strCodi, Num, rsCC As rdoResultset, Rsn As rdoResultset, ContaBase, CodiIntern
    
    CodiClient = cc
    codiContableProveedor = cc
    strCodi = ""
    nDigitos = 9
    
    codiContableProveedor = 1
    Set Rsn = Db.OpenResultset("Select Valor From ccproveedoresextes where nom = 'CodiIntern' and Id = '" & cc & "' ")
    If Not Rsn.EOF Then If Not IsNull(Rsn(0)) Then codiContableProveedor = Rsn(0) + 10000
    
    ContaBase = "40"
    Set Rsn = Db.OpenResultset("Select * from ccproveedoresextes where nom= 'Acreedor' and valor = 'on' and id = '" & cc & "'")
    If Not Rsn.EOF Then ContaBase = "41"
    
    strCodi = ContaBase & Right("000000000000" & codiContableProveedor, nDigitos - 2)
    strCodi = strCodi & Space(12)
    strCodi = Left(strCodi, 12)
    codiContableProveedor = strCodi
    
    'Buscamos el código de facturación del cliente. Si ni dispone de el, creamos uno a partir de su código de cliente
'    Set rsCC = Db.OpenResultset("SELECT codi as Valor FROM ccProveedores WHERE Id = '" & CodiClient & "'  ")
'    If Not rsCC.EOF Then
'        If Not IsNull(rsCC("Valor")) And (Len(rsCC("Valor")) > 0) Then
'            codiContableProveedor = Right(rsCC("Valor"), 4)
'
'            strCodi = ContaBase
'            strCodi = strCodi & Right("000000000000" & codiContableProveedor, nDigitos - 2)
'            strCodi = strCodi & Space(12)
'            strCodi = Left(strCodi, 12)
'            codiContableProveedor = strCodi
'        End If
'    End If
    
    'If Len(cccuentasCodiCompte(CodiClient)) > 0 Then codiContableProveedor = Left(cccuentasCodiCompte(CodiClient) & Space(12), 12)
    
End Function

Function codiContableProveedorPosaOk(cc)
    Dim Ccuennttaa As String, CodiClient, strCodi, Num, rsCC As rdoResultset, Rsn As rdoResultset, ContaBase, CodiIntern
    
    CodiClient = cc
    strCodi = ""
    nDigitos = 9
    
    CodiIntern = 1
    Set Rsn = Db.OpenResultset("Select max(cast(valor as numeric)) From ccproveedoresextes where nom = 'CodiIntern' ")
    If Not Rsn.EOF Then If Not IsNull(Rsn(0)) Then CodiIntern = Rsn(0) + 1
    
    Set Rsn = Db.OpenResultset("select * from ccproveedores where id not in (select id from ccproveedoresextes where nom = 'CodiIntern' and not valor is null )")
    While Not Rsn.EOF
        ExecutaComandaSql "insert into ccproveedoresextes (Id , nom , Valor ) Values ('" & Rsn("Id") & "' ,'CodiIntern','" & CodiIntern & "') "
        CodiIntern = CodiIntern + 1
        Rsn.MoveNext
        DoEvents
    Wend
    
End Function


Function codiContableProveedorMURANO(cc As String)
    Dim strCodi, Num
    
    Dim rsAcr As rdoResultset, rsCC As rdoResultset
    Dim ContaBase As String
    
    codiContableProveedorMURANO = ""

    ContaBase = "40"
    Set rsAcr = Db.OpenResultset("Select * from ccproveedoresextes where nom= 'Acreedor' and valor = 'on' and id = '" & cc & "'")
    If Not rsAcr.EOF Then ContaBase = "41"
    
   
    Set rsCC = Db.OpenResultset("SELECT codi as Valor FROM ccProveedores WHERE Id = '" & cc & "'")
    If Not rsCC.EOF Then
        If Not IsNull(rsCC("Valor")) And (Len(rsCC("Valor")) > 0) Then
            If Len(rsCC("valor")) = nDigitos Then
                codiContableProveedorMURANO = rsCC("valor")
            ElseIf Len(rsCC("valor")) = 8 Then
                codiContableProveedorMURANO = Mid(rsCC("valor"), 1, 4) & Left("000000", nDigitos - Len(rsCC("valor"))) & Right(rsCC("valor"), 4)
            Else
                codiContableProveedorMURANO = ContaBase & Right("000000000000" & rsCC("valor"), nDigitos - 2)
            End If
        Else
            codiContableProveedorMURANO = ContaBase & Right("000000000000", nDigitos - 2)
        End If
    Else
        codiContableProveedorMURANO = ContaBase & Right("000000000000", nDigitos - 2)
    End If
   
End Function

Function ccCuentas()
    Dim Str As String, strSQL As String
    
    Str = "ccCuentas"
    
    If Not ExisteixTaula(Str) Then
        strSQL = "CREATE TABLE [" & Str & "] ( "
        strSQL = strSQL & " [Id] [nvarchar](255) NOT NULL DEFAULT (newid()),"
        strSQL = strSQL & " [Nombre] [nvarchar](255) NULL,"
        strSQL = strSQL & " [Descripcion] [nvarchar](255) NULL,"
        strSQL = strSQL & " [Saldo] [nvarchar](255) NULL,"
        strSQL = strSQL & " [Cuenta] [nvarchar](255) NULL"
        strSQL = strSQL & " ) ON [PRIMARY] "
        ExecutaComandaSql strSQL
        
        
    End If
    ccCuentas = Str
End Function '
Sub RecalculaProveedores()
    Dim sql, botiga, rs  As rdoResultset, i, Proveedores(), diaSet As String, Minuts, IdP, rsC As rdoResultset, Ara As Date
    
    Ara = Now
If UCase(EmpresaActual) = UCase("SISTARE") Then
    'Ara = DateSerial(2010, 10, 21) + TimeSerial(6, 0, 0)
End If
    
   ' Ara = DateSerial(2010, 2, 25) + TimeSerial(20, 20, 0)
    
    If Not ExisteixTaula("ccproveedoresExtes") Then Exit Sub
    diaSet = "L"
    If DatePart("w", Ara, vbMonday) = 1 Then diaSet = "L"
    If DatePart("w", Ara, vbMonday) = 2 Then diaSet = "M"
    If DatePart("w", Ara, vbMonday) = 3 Then diaSet = "X"
    If DatePart("w", Ara, vbMonday) = 4 Then diaSet = "J"
    If DatePart("w", Ara, vbMonday) = 5 Then diaSet = "V"
    If DatePart("w", Ara, vbMonday) = 6 Then diaSet = "S"
    If DatePart("w", Ara, vbMonday) = 7 Then diaSet = "D"

    ExecutaComandaSql "Delete FeinesAFer Where Tipus = 'RecalculaProveedoresUn' and Param4 = '" & diaSet & "' And Param2 not in (Select e1.Id from ccproveedoresExtes e1 join ccproveedoresExtes e2 on e1.id=e2.id and e1.nom = 'horaCierre' and e2.nom = 'pAuto_" & diaSet & "' and e2.valor='on' ) "
    Set rsC = Db.OpenResultset("Select e1.Id as Id,e1.Valor as Hora from ccproveedoresExtes e1 join ccproveedoresExtes e2 on e1.id=e2.id and e1.nom = 'horaCierre' and e2.nom = 'pAuto_" & diaSet & "' and e2.valor='on' ")
    
    While Not rsC.EOF
        If InStr(rsC("Hora"), ":") > 0 Then
            Minuts = Left(rsC("Hora"), InStr(rsC("Hora"), ":") - 1) * 60 + Right(rsC("Hora"), Len(rsC("Hora")) - InStr(rsC("Hora"), ":"))
            IdP = rsC("Id")
            Set rs = Db.OpenResultset("Select * From FeinesAFer Where Tipus = 'RecalculaProveedoresUn' And Param2='" & IdP & "' And Param3 = '" & Minuts & "' And Param4 = '" & diaSet & "' ")
            If rs.EOF Then
                ExecutaComandaSql "Delete FeinesAFer Where Tipus = 'RecalculaProveedoresUn' and Param2 = '" & IdP & "' and Param4 = '" & diaSet & "' "
                ExecutaComandaSql "Insert Into FeinesAFer (Tipus,Ciclica,Param1,Param2,Param3,Param4) Values ('RecalculaProveedoresUn',0,'" & DateAdd("d", -7, Ara) & "','" & IdP & "','" & Minuts & "','" & diaSet & "') "
            End If
        End If
        rsC.MoveNext
    Wend
    
    Set rs = Db.OpenResultset("Select * From FeinesAFer Where Tipus = 'RecalculaProveedoresUn' And Param4 = '" & diaSet & "' ")
    While Not rs.EOF
        If (Minute(Ara) + (60 * Hour(Ara))) > CDbl(rs("Param3")) Then
            If Not DateSerial(Year(rs("Param1")), Month(rs("Param1")), Day(rs("Param1"))) = DateSerial(Year(Ara), Month(Ara), Day(Ara)) Then
                ExecutaComandaSql "Insert Into FeinesAFer (Tipus,Ciclica,Param1,Param2,Param3,Param4) Values ('PedidoCalculaExtern',0,'" & rs("Param2") & "','" & 0 & "','" & 0 & "','" & 0 & "') "
                ExecutaComandaSql "Update FeinesAFer Set  Param1 = '" & Ara & "' where Id = '" & rs("Id") & "' "
'                sf_enviarMail "Secrehit@gmail.com", EmailGuardia , "Comanda Calculada ", "Comanda calculada a les : " & Now & " iniciat a  " & Ara, "", ""
            Else
            End If
        End If
        rs.MoveNext
    Wend
    
End Sub

Sub rectificaTurnoEmail(codigoDeAccion As String)
    Dim rsCdA As rdoResultset
    Dim botiga As String, empleado As String, entrada As Date, salida As Date, turno As String, extra As String, aprendiz As String, coord As String, periode As String
    Dim email As String, rsExisteTurno As rdoResultset
    
On Error GoTo nor
    Set rsCdA = Db.OpenResultset("select isnull(param1, '') param1, isnull(param2, '') param2, isnull(param3, '') param3, isnull(param4, '') param4, isnull(param5, '') param5, isnull(param6, '') param6, isnull(param7, '') param7, isnull(param8, '') param8, isnull(param10, '') param10 from  " & taulaCodigosDeAccion() & "  where idCodigo = '" & codigoDeAccion & "'")
    If Not rsCdA.EOF Then
        botiga = rsCdA("param1")
        empleado = rsCdA("param2")
        entrada = CDate(rsCdA("param3"))
        salida = CDate(rsCdA("param4"))
        turno = rsCdA("param5")
        extra = rsCdA("param6")
        aprendiz = rsCdA("param7")
        coord = rsCdA("param8")
        email = rsCdA("param10")
        
        periode = "M"
        If Hour(entrada) > 12 Then periode = "T"
        
        'LE TENEMOS QUE ASIGNAR UN TURNO
        If turno <> "" Then
            Set rsExisteTurno = Db.OpenResultset("select * from " & taulaCdpPlanificacion(entrada) & " where botiga=" & botiga & " and day(fecha)=" & Day(entrada) & " and idTurno='" & turno & "' and (idEmpleado is null or idEmpleado='" & empleado & "') and activo=1")
            If rsExisteTurno.EOF Then 'NO ESTÁ CONFIGURADO
                ExecutaComandaSql "insert into " & taulaCdpPlanificacion(entrada) & " values (newid(), convert(datetime, '" & Format(entrada, "dd/mm/yyyy hh:nn:ss") & "', 103), '" & botiga & "', '" & periode & "', '" & turno & "', '" & empleado & "', '" & email & "', getdate(), 1)"
            Else
                'ASIGNAMOS EL TURNO CORRESPONDIENTE
                'Si hay 2 iguales libres, se lia!!!!!!!!!!!!!!!!!!!!!!!!!
                'ExecutaComandaSql "update " & taulaCdpPlanificacion(entrada) & " set fecha=convert(datetime, '" & Format(entrada, "dd/mm/yyyy hh:nn:ss") & "', 103), idEmpleado='" & empleado & "', usuarioModif='" & email & "', fechaModif=getdate() where botiga=" & botiga & " and day(fecha)=" & Day(entrada) & " and idTurno='" & turno & "'"
                ExecutaComandaSql "update " & taulaCdpPlanificacion(entrada) & " set fecha=convert(datetime, '" & Format(entrada, "dd/mm/yyyy hh:nn:ss") & "', 103), idEmpleado='" & empleado & "', usuarioModif='" & email & "', fechaModif=getdate() where idPlan = '" & rsExisteTurno("IdPlan") & "'"
            End If
            
            'LIBERAMOS POSIBLES TURNOS QUE ESTÉ OCUPANDO EL EMPLEADO (SOLO PUEDE OCUPAR 1 TURNO)
            ExecutaComandaSql "update " & taulaCdpPlanificacion(entrada) & " set fecha=convert(datetime, '" & Format(entrada, "dd/mm/yyyy") & "', 103), idEmpleado=NULL, usuarioModif='" & email & "', fechaModif=getdate() where botiga=" & botiga & " and day(fecha)=" & Day(entrada) & " and idTurno<>'" & turno & "' and idTurno not like '%Extra' and idTurno not like '%Aprendiz' and idTurno not like '%Coordinacion' and idEmpleado='" & empleado & "' and periode='" & periode & "'"
            
            'BORRAMOS EL TURNO "SIN CONFIGURAR" QUE TIENE ASIGNADO (TIENE QUE SER EN ESTE ORDEN, SINO EL CALCULS LLARGS LO VUELVE A METER)
            ExecutaComandaSql "delete from " & taulaCdpPlanificacion(entrada) & " where idTurno is null and idEmpleado='" & empleado & "' and botiga=" & botiga & " and day(fecha)=" & Day(entrada)
            
            'ExecutaComandaSql "update " & taulaCdpPlanificacion(entrada) & " set fecha=convert(datetime, '" & Format(entrada, "dd/mm/yyyy hh:nn:ss") & "', 103), idEmpleado=null, usuarioModif='" & email & "', fechaModif=getdate() where botiga=" & botiga & " and day(fecha)=" & Day(entrada) & " and idEmpleado='" & empleado & "'"
        End If
        
        If IsNumeric(extra) Then
            If extra <> 0 Then
                'BORRAMOS LOS TURNOS EXTRA, SI LO TIENE (SOLO ES VÁLIDO EL ÚLTIMO)
                ExecutaComandaSql "delete from " & taulaCdpPlanificacion(entrada) & " where idTurno like '%Extra' and idEmpleado='" & empleado & "' and botiga=" & botiga & " and day(fecha)=" & Day(entrada) & " and periode='" & periode & "'"
                
                'ASIGNAMOS TURNO EXTRA
                ExecutaComandaSql "insert into " & taulaCdpPlanificacion(entrada) & " (idPlan, fecha, botiga, periode, idTurno, idEmpleado, usuarioModif, fechaModif, activo) values (newid(), convert(datetime, '" & Format(entrada, "dd/mm/yyyy hh:nn:ss") & "', 103), '" & botiga & "', '" & periode & "', '" & extra & "_Extra', '" & empleado & "', '" & email & "', getdate(), 1)"
                
                'BORRAMOS EL TURNO "SIN CONFIGURAR" QUE TIENE ASIGNADO (TIENE QUE SER EN ESTE ORDEN, SINO EL CALCULS LLARGS LO VUELVE A METER)
                ExecutaComandaSql "delete from " & taulaCdpPlanificacion(entrada) & " where idTurno is null and idEmpleado='" & empleado & "' and botiga=" & botiga & " and day(fecha)=" & Day(entrada)
            End If
        End If
        
        If IsNumeric(aprendiz) Then
            If aprendiz <> 0 Then
                'BORRAMOS LOS TURNOS APRENDIZ, SI LO TIENE (SOLO ES VÁLIDO EL ÚLTIMO)
                ExecutaComandaSql "delete from " & taulaCdpPlanificacion(entrada) & " where idTurno like '%Aprendiz' and idEmpleado='" & empleado & "' and botiga=" & botiga & " and day(fecha)=" & Day(entrada) & " and periode='" & periode & "'"
            
                'ASIGNAMOS TURNO APRENDIZ
                ExecutaComandaSql "insert into " & taulaCdpPlanificacion(entrada) & " (idPlan, fecha, botiga, periode, idTurno, idEmpleado, usuarioModif, fechaModif, activo) values (newid(), convert(datetime, '" & Format(entrada, "dd/mm/yyyy hh:nn:ss") & "', 103), '" & botiga & "', '" & periode & "', '" & aprendiz & "_Aprendiz', '" & empleado & "', '" & email & "', getdate(), 1)"
                
                'BORRAMOS EL TURNO "SIN CONFIGURAR" QUE TIENE ASIGNADO (TIENE QUE SER EN ESTE ORDEN, SINO EL CALCULS LLARGS LO VUELVE A METER)
                ExecutaComandaSql "delete from " & taulaCdpPlanificacion(entrada) & " where idTurno is null and idEmpleado='" & empleado & "' and botiga=" & botiga & " and day(fecha)=" & Day(entrada)
            End If
        End If

        If IsNumeric(coord) Then
            If coord <> 0 Then
                'BORRAMOS LOS TURNOS COORDINADORA, SI LO TIENE (SOLO ES VÁLIDO EL ÚLTIMO)
                ExecutaComandaSql "delete from " & taulaCdpPlanificacion(entrada) & " where idTurno like '%Coordinacion' and idEmpleado='" & empleado & "' and botiga=" & botiga & " and day(fecha)=" & Day(entrada) & " and periode='" & periode & "'"
            
                'ASIGNAMOS TURNO COODINADORA
                ExecutaComandaSql "insert into " & taulaCdpPlanificacion(entrada) & " (idPlan, fecha, botiga, periode, idTurno, idEmpleado, usuarioModif, fechaModif, activo) values (newid(), convert(datetime, '" & Format(entrada, "dd/mm/yyyy hh:nn:ss") & "', 103), '" & botiga & "', '" & periode & "', '" & coord & "_Coordinacion', '" & empleado & "', '" & email & "', getdate(), 1)"
                
                'BORRAMOS EL TURNO "SIN CONFIGURAR" QUE TIENE ASIGNADO (TIENE QUE SER EN ESTE ORDEN, SINO EL CALCULS LLARGS LO VUELVE A METER)
                ExecutaComandaSql "delete from " & taulaCdpPlanificacion(entrada) & " where idTurno is null and idEmpleado='" & empleado & "' and botiga=" & botiga & " and day(fecha)=" & Day(entrada)
            End If
        End If

    End If
    Exit Sub
nor:
    sf_enviarMail "secrehit@hit.cat", "ana@solucionesit365.com", "ERROR RECTIFICANDO TURNO EMAIL", err.Description, "", ""
End Sub

Sub regularizaHorasPlan()
Dim fecha As Date, f As Date
Dim rs As rdoResultset, rs2 As rdoResultset

fecha = CDate("01/05/2019")
For f = fecha To Now()
    Set rs = Db.OpenResultset("select * from " & taulaCdpPlanificacion(f) & " where datepart(hour, fecha)=0 and day(fecha)=" & Day(f) & " and idEmpleado is not null order by botiga, fecha")
    While Not rs.EOF
        Set rs2 = Db.OpenResultset("select * from cdpdadesfichador where usuari=" & rs("idEmpleado") & " and day(tmst)=" & Day(f) & " and month(tmst)=" & Month(f) & " and year(tmst)=" & Year(f) & " and accio=1")
        If Not rs2.EOF Then
            ExecutaComandaSql "update " & taulaCdpPlanificacion(f) & " set fecha='" & rs2("tmst") & "' where idPlan='" & rs("idPlan") & "'"
        End If
            
        rs.MoveNext
    Wend
Next
End Sub

Sub RevisaAlbaransBotiga(client, Di, Df)
   Dim D As Date, dia As Date, Da1 As Date, Da2 As Date, P As Integer, rs As rdoResultset, Q_Ins As rdoQuery, Q_Del As rdoQuery, sql As String, Q_Upd As rdoQuery
   
Exit Sub  ' No furrula

   If Not TeAlbaransDeBotiga(client, Di, Df) Then Exit Sub
   
    Informa "Repasant Albarans Botiga Per " & BotigaCodiNom(client)
    D = Di
    While D <= Df
        sql = "Insert Into [" & DonamNomTaulaServit(D) & "] (Client,CodiArticle,QuantitatServida,Comentari,PluUtilitzat,Viatge,Equip,MotiuModificacio,Hora,TipusComanda,ComentariPer,Atribut) "
        sql = sql & "select Otros,Plu,Quantitat,'[IdAlbara:'+cast(cast(Num_Tick as int) as nvarchar)+']','','','','',94,2,'',0 "
        sql = sql & "from [V_Albarans_2009-11] v "
        sql = sql & "left join [" & DonamNomTaulaServit(D) & "] s on s.client = otros and s.quantitatservida = quantitat and s.codiArticle = plu "
        sql = sql & "Where Otros = " & client & " And Day(v.data) = " & Day(D) & " And s.Client Is Null "
        
        ExecutaComandaSql sql
        
        D = DateAdd("D", 1, D)
    Wend
    
End Sub


Sub SincronitzaCaixesMURANO(fecha As Date, idCalcul As String)
    Dim fechaParam As String
    Dim sql As String, codEmp As String
    Dim rsEmp As rdoResultset, rsBots As rdoResultset, rsPendents As rdoResultset
    
    Set rsEmp = Db.OpenResultset("select camp,valor from constantsEmpresa where camp like '%CampNom' order by camp  desc")
    
    While Not rsEmp.EOF
        If InStr(rsEmp("camp"), "_") Then
            codEmp = Split(rsEmp("camp"), "_")(0)
        Else
            codEmp = "0"
        End If
        
        sql = "select cc.Valor, c.Codi, c.Nom "
        sql = sql & "from constantsclient cc "
        sql = sql & "left join clients c on cc.Codi=c.codi "
        sql = sql & "where cc.variable = 'EmpresaVendes' and c.Codi is not null and cc.Valor = '" & codEmp & "' "
        sql = sql & "order by cc.Valor, c.nom"
        Set rsBots = Db.OpenResultset(sql)
        While Not rsBots.EOF
            fechaParam = "[" & Right("00" & Day(fecha), 2) & "/" & Right("00" & Month(fecha), 2) & "/" & Year(fecha) & "]"
            ExportaMURANO "CAIXA", "[" & rsBots("codi") & "]", fechaParam, "", "", "", idCalcul
            rsBots.MoveNext
        Wend
        rsEmp.MoveNext
    Wend
    
    'Caixes pendents
    Set rsPendents = Db.OpenResultset("select * from feinesAFer where Tipus = 'SincronitzaCaixaPendentMURANO'")
    While Not rsPendents.EOF
        ExportaMURANO "CAIXA", rsPendents("Param1"), rsPendents("Param2"), "", "", "", idCalcul
        ExecutaComandaSql "Delete from feinesAFer where id = '" & rsPendents("id") & "'"
        rsPendents.MoveNext
    Wend
    
End Sub

Function TaulaCalculsEspecials() As String
    Dim Str As String, strSQL As String
    
    Str = "hit.dbo.CalculsEspecials"

    'If Not ExisteixTaula(Str) Then
    
'        strSQL = "CREATE TABLE [" & Str & "] ( "
'        strSQL = strSQL & " [Id] [nvarchar](255) NOT NULL DEFAULT (newid()),"
'        strSQL = strSQL & " [Empresa] [nvarchar](255) NULL,"
'        strSQL = strSQL & " [IdFeinaAFer] [nvarchar](255) NULL,"
'        strSQL = strSQL & " [Estat] [nvarchar](255) NULL,"
'        strSQL = strSQL & " [Ti] [nvarchar](255) NULL,"
'        strSQL = strSQL & " [Tf] [nvarchar](255) NULL,"
'        strSQL = strSQL & " [Tipus] [nvarchar](255) NULL,"
'        strSQL = strSQL & " [Param1] [nvarchar](255) NULL,"
'        strSQL = strSQL & " [Param2] [nvarchar](255) NULL,"
'        strSQL = strSQL & " [Param3] [nvarchar](255) NULL,"
'        strSQL = strSQL & " [Param4] [nvarchar](255) NULL,"
'        strSQL = strSQL & " [Param5] [nvarchar](255) NULL"
'        strSQL = strSQL & " ) ON [PRIMARY] "
'        ExecutaComandaSql strSQL
'
    'End If
    
    TaulaCalculsEspecials = Str
    
End Function '
Function PedidosUltimosDatos(Materia, tienda, Proveedor As String, FechaUltimaVenta, FechaUltimaVentaNoEncontrada, FechaUltimaDevolucionNoEncontrada, Inventados, Redondeo)
    Dim strSQL As String, rs As rdoResultset, sql As String

    Dim dia As data
    
    FechaUltimaVenta = DateAdd("d", -14, Now)
    FechaUltimaVentaNoEncontrada = DateAdd("d", -14, Now)
    FechaUltimaDevolucionNoEncontrada = DateAdd("d", -14, Now)
    Inventados = 0
    Redondeo = 0
    PedidosUltimosDatos = False
    
    If Not ExisteixCamp(NomTaulaPedidosUltimosDatos(Now(), Proveedor), "FechaUltimaDevolucion") Then ExecutaComandaSql " Alter table [" & NomTaulaPedidosUltimosDatos(Now(), Proveedor) & "] Add [FechaUltimaDevolucion]  [datetime]   NULL "
   
    strSQL = "Select top 1 * from [" & NomTaulaPedidosUltimosDatos(Now(), Proveedor) & "] Where Materia = '" & Materia & "' and Cliente = '" & tienda & "'  and idpedido collate SQL_Latin1_General_CP1_CI_AS in (select id collate SQL_Latin1_General_CP1_CI_AS from ccpedidos) order by fecha desc "
    Set rs = Db.OpenResultset(strSQL)
    If rs.EOF Then
        strSQL = "Select top 1 * from [" & NomTaulaPedidosUltimosDatos(DateAdd("m", -1, Now()), Proveedor) & "] Where Materia = '" & Materia & "' and Cliente = '" & tienda & "'  and idpedido collate SQL_Latin1_General_CP1_CI_AS in (select id collate SQL_Latin1_General_CP1_CI_AS from ccpedidos) order by fecha desc "
        Set rs = Db.OpenResultset(strSQL)
        If rs.EOF Then
            strSQL = "Select top 1 * from [" & NomTaulaPedidosUltimosDatos(DateAdd("m", -2, Now()), Proveedor) & "] Where Materia = '" & Materia & "' and Cliente = '" & tienda & "'  and idpedido collate SQL_Latin1_General_CP1_CI_AS in (select id collate SQL_Latin1_General_CP1_CI_AS from ccpedidos) order by fecha desc "
            Set rs = Db.OpenResultset(strSQL)
            If rs.EOF Then
                sql = "Insert into [" & NomTaulaPedidosUltimosDatos(Now(), Proveedor) & "] "
                sql = sql & " ([IdPedido],[Proveedor],[Materia],[Cliente],[Fecha],[RedondeoProveedor],[RedondeoCliente],[FechaUltimaVenta],[FechaUltimaDevolucion])  "
                sql = sql & " Values ("
                sql = sql & " 'Primer pedido automatico',"
                sql = sql & " '" & Proveedor & "',"
                sql = sql & " '" & Materia & "',"
                sql = sql & " '" & tienda & "',"
                sql = sql & " convert(datetime,'" & Now() & "',103),"
                sql = sql & " '" & Redondeo & "',"
                sql = sql & " '" & Inventados & "',"
                sql = sql & " convert(datetime,'" & FechaUltimaVenta & "',103), "
                sql = sql & " convert(datetime,'" & FechaUltimaDevolucionNoEncontrada & "',103) "
                sql = sql & " ) "
                ExecutaComandaSql sql
            Else
                FechaUltimaVenta = rs("FechaUltimaVenta")
                FechaUltimaVentaNoEncontrada = rs("Fecha")
                If Not IsNull(rs("FechaUltimaDevolucion")) Then FechaUltimaDevolucionNoEncontrada = rs("FechaUltimaDevolucion")
                Inventados = rs("RedondeoCliente")
                Redondeo = rs("RedondeoProveedor")
                PedidosUltimosDatos = True
            End If
        Else
            FechaUltimaVenta = rs("FechaUltimaVenta")
            FechaUltimaVentaNoEncontrada = rs("Fecha")
            If Not IsNull(rs("FechaUltimaDevolucion")) Then FechaUltimaDevolucionNoEncontrada = rs("FechaUltimaDevolucion")
            Inventados = rs("RedondeoCliente")
            Redondeo = rs("RedondeoProveedor")
            PedidosUltimosDatos = True
        End If
    Else
        FechaUltimaVenta = rs("FechaUltimaVenta")
        FechaUltimaVentaNoEncontrada = rs("Fecha")
        If Not IsNull(rs("FechaUltimaDevolucion")) Then FechaUltimaDevolucionNoEncontrada = rs("FechaUltimaDevolucion")
        Inventados = rs("RedondeoCliente")
        Redondeo = rs("RedondeoProveedor")
        PedidosUltimosDatos = True
    End If
End Function
Function PedidosUltimosDatos_91(Materia As String, tienda As String, Proveedor As String, FechaUltimaVenta As Date, FechaUltimaVentaNoEncontrada As Date, FechaUltimaDevolucionNoEncontrada As Date, Inventados As Integer, Redondeo As Integer) As Boolean
    Dim strSQL As String, rs As rdoResultset, sql As String
    Dim hoy As Date, diaSet As Integer
    Dim diasAtras As Integer
    Dim iD As Integer, diasReparto(8) As Boolean
    
    hoy = Now()
    
On Error GoTo sigue

    diaSet = DatePart("w", hoy, vbMonday)
    
    For iD = 0 To 7
        diasReparto(iD) = False
    Next
    
    Set rs = Db.OpenResultset("select * from ccProveedoresExtes where id = '" & Proveedor & "' and nom like 'pAuto%'")
    While Not rs.EOF
        If rs("valor") = "on" Then
            Select Case Split(rs("nom"), "_")(1)
                Case "L"
                    diasReparto(1) = True
                Case "M"
                    diasReparto(2) = True
                Case "X"
                    diasReparto(3) = True
                Case "J"
                    diasReparto(4) = True
                Case "V"
                    diasReparto(5) = True
                Case "S"
                    diasReparto(6) = True
                Case "D"
                    diasReparto(7) = True
            End Select
            
        End If
        rs.MoveNext
    Wend
    
    diasAtras = -1
    iD = diaSet - 1
    While Not diasReparto(iD) And diasAtras > -8
        diasAtras = diasAtras - 1
        iD = iD - 1
        If iD = 0 Then iD = 7
    Wend
    
sigue:

On Error GoTo err

    If diasAtras = 0 Then diasAtras = -1
    
    FechaUltimaVenta = DateAdd("d", diasAtras, Now)
    FechaUltimaVentaNoEncontrada = DateAdd("d", diasAtras, Now)
    FechaUltimaDevolucionNoEncontrada = DateAdd("d", diasAtras, Now)
    Inventados = 0
    Redondeo = 0
    PedidosUltimosDatos_91 = False
    
   
    strSQL = "Select top 1 * from [" & NomTaulaPedidosUltimosDatos(Now(), Proveedor) & "] Where Materia = '" & Materia & "' and Cliente = '" & tienda & "'  and idpedido collate SQL_Latin1_General_CP1_CI_AS in (select id collate SQL_Latin1_General_CP1_CI_AS from ccpedidos) order by fecha desc "
    Set rs = Db.OpenResultset(strSQL)
    If rs.EOF Then
        strSQL = "Select top 1 * from [" & NomTaulaPedidosUltimosDatos(DateAdd("m", -1, Now()), Proveedor) & "] Where Materia = '" & Materia & "' and Cliente = '" & tienda & "'  and idpedido collate SQL_Latin1_General_CP1_CI_AS in (select id collate SQL_Latin1_General_CP1_CI_AS from ccpedidos) order by fecha desc "
        Set rs = Db.OpenResultset(strSQL)
        If rs.EOF Then
            strSQL = "Select top 1 * from [" & NomTaulaPedidosUltimosDatos(DateAdd("m", -2, Now()), Proveedor) & "] Where Materia = '" & Materia & "' and Cliente = '" & tienda & "'  and idpedido collate SQL_Latin1_General_CP1_CI_AS in (select id collate SQL_Latin1_General_CP1_CI_AS from ccpedidos) order by fecha desc "
            Set rs = Db.OpenResultset(strSQL)
            If rs.EOF Then
                sql = "Insert into [" & NomTaulaPedidosUltimosDatos(Now(), Proveedor) & "] "
                sql = sql & " ([IdPedido],[Proveedor],[Materia],[Cliente],[Fecha],[RedondeoProveedor],[RedondeoCliente],[FechaUltimaVenta],[FechaUltimaDevolucion])  "
                sql = sql & " Values ("
                sql = sql & " 'Primer pedido automatico',"
                sql = sql & " '" & Proveedor & "',"
                sql = sql & " '" & Materia & "',"
                sql = sql & " '" & tienda & "',"
                sql = sql & " convert(datetime,'" & Now() & "',103),"
                sql = sql & " '" & Redondeo & "',"
                sql = sql & " '" & Inventados & "',"
                sql = sql & " convert(datetime,'" & FechaUltimaVenta & "',103), "
                sql = sql & " convert(datetime,'" & FechaUltimaDevolucionNoEncontrada & "',103) "
                sql = sql & " ) "
                ExecutaComandaSql sql
            Else
                FechaUltimaVenta = rs("FechaUltimaVenta")
                FechaUltimaVentaNoEncontrada = rs("Fecha")
                If Not IsNull(rs("FechaUltimaDevolucion")) Then FechaUltimaDevolucionNoEncontrada = rs("FechaUltimaDevolucion")
                Inventados = rs("RedondeoCliente")
                Redondeo = rs("RedondeoProveedor")
                PedidosUltimosDatos_91 = True
            End If
        Else
            FechaUltimaVenta = rs("FechaUltimaVenta")
            FechaUltimaVentaNoEncontrada = rs("Fecha")
            If Not IsNull(rs("FechaUltimaDevolucion")) Then FechaUltimaDevolucionNoEncontrada = rs("FechaUltimaDevolucion")
            Inventados = rs("RedondeoCliente")
            Redondeo = rs("RedondeoProveedor")
            PedidosUltimosDatos_91 = True
        End If
    Else
        FechaUltimaVenta = rs("FechaUltimaVenta")
        FechaUltimaVentaNoEncontrada = rs("Fecha")
        If Not IsNull(rs("FechaUltimaDevolucion")) Then FechaUltimaDevolucionNoEncontrada = rs("FechaUltimaDevolucion")
        Inventados = rs("RedondeoCliente")
        Redondeo = rs("RedondeoProveedor")
        PedidosUltimosDatos_91 = True
    End If
    
    Exit Function
    
err:
    sf_enviarMail "", "ana@solucionesit365.com", "ERROR PedidosUltimosDatos_91", "ERROR PedidosUltimosDatos_91 " & err.Description & "<br>MATERIA:" & Materia & " TIENDA: " & tienda & " PROVEDOR: " & Proveedor, "", ""

End Function


Function PedidosUltimosDatos_V2(Materia As String, tienda As String, Proveedor As String, FechaUltimaVenta As Date, FechaUltimaVentaNoEncontrada As Date, FechaUltimaDevolucionNoEncontrada As Date, Inventados As Integer, Redondeo As Integer) As Boolean
    Dim strSQL As String, rs As rdoResultset, sql As String
    Dim hoy As Date, diaSet As Integer
    Dim diasAtras As Integer
    Dim iD As Integer, diasReparto(8) As Boolean
    
    hoy = Now()
    
On Error GoTo sigue

    diaSet = DatePart("w", hoy, vbMonday)
    
    For iD = 0 To 7
        diasReparto(iD) = False
    Next
    
    Set rs = Db.OpenResultset("select * from ccProveedoresExtes where id = '" & Proveedor & "' and nom like 'pAuto%'")
    While Not rs.EOF
        If rs("valor") = "on" Then
            Select Case Split(rs("nom"), "_")(1)
                Case "L"
                    diasReparto(1) = True
                Case "M"
                    diasReparto(2) = True
                Case "X"
                    diasReparto(3) = True
                Case "J"
                    diasReparto(4) = True
                Case "V"
                    diasReparto(5) = True
                Case "S"
                    diasReparto(6) = True
                Case "D"
                    diasReparto(7) = True
            End Select
            
        End If
        rs.MoveNext
    Wend
    
    diasAtras = -1
    iD = diaSet - 1
    While Not diasReparto(iD) And diasAtras > -8
        diasAtras = diasAtras - 1
        iD = iD - 1
        If iD = 0 Then iD = 7
    Wend
    
sigue:

On Error GoTo err

    If diasAtras = 0 Then diasAtras = -1
    
    FechaUltimaVenta = DateAdd("d", diasAtras, Now)
    FechaUltimaVentaNoEncontrada = DateAdd("d", diasAtras, Now)
    FechaUltimaDevolucionNoEncontrada = DateAdd("d", diasAtras, Now)
    Inventados = 0
    Redondeo = 0
    PedidosUltimosDatos_V2 = False
    
   
    strSQL = "Select top 1 * from [" & NomTaulaPedidosUltimosDatos(Now(), Proveedor) & "] Where Materia = '" & Materia & "' and Cliente = '" & tienda & "'  and idpedido collate SQL_Latin1_General_CP1_CI_AS in (select id collate SQL_Latin1_General_CP1_CI_AS from ccpedidos) order by fecha desc "
    Set rs = Db.OpenResultset(strSQL)
    If rs.EOF Then
        strSQL = "Select top 1 * from [" & NomTaulaPedidosUltimosDatos(DateAdd("m", -1, Now()), Proveedor) & "] Where Materia = '" & Materia & "' and Cliente = '" & tienda & "'  and idpedido collate SQL_Latin1_General_CP1_CI_AS in (select id collate SQL_Latin1_General_CP1_CI_AS from ccpedidos) order by fecha desc "
        Set rs = Db.OpenResultset(strSQL)
        If rs.EOF Then
            strSQL = "Select top 1 * from [" & NomTaulaPedidosUltimosDatos(DateAdd("m", -2, Now()), Proveedor) & "] Where Materia = '" & Materia & "' and Cliente = '" & tienda & "'  and idpedido collate SQL_Latin1_General_CP1_CI_AS in (select id collate SQL_Latin1_General_CP1_CI_AS from ccpedidos) order by fecha desc "
            Set rs = Db.OpenResultset(strSQL)
            If rs.EOF Then
                sql = "Insert into [" & NomTaulaPedidosUltimosDatos(Now(), Proveedor) & "] "
                sql = sql & " ([IdPedido],[Proveedor],[Materia],[Cliente],[Fecha],[RedondeoProveedor],[RedondeoCliente],[FechaUltimaVenta],[FechaUltimaDevolucion])  "
                sql = sql & " Values ("
                sql = sql & " 'Primer pedido automatico',"
                sql = sql & " '" & Proveedor & "',"
                sql = sql & " '" & Materia & "',"
                sql = sql & " '" & tienda & "',"
                sql = sql & " convert(datetime,'" & Now() & "',103),"
                sql = sql & " '" & Redondeo & "',"
                sql = sql & " '" & Inventados & "',"
                sql = sql & " convert(datetime,'" & FechaUltimaVenta & "',103), "
                sql = sql & " convert(datetime,'" & FechaUltimaDevolucionNoEncontrada & "',103) "
                sql = sql & " ) "
                ExecutaComandaSql sql
            Else
                FechaUltimaVenta = rs("FechaUltimaVenta")
                FechaUltimaVentaNoEncontrada = rs("Fecha")
                If Not IsNull(rs("FechaUltimaDevolucion")) Then FechaUltimaDevolucionNoEncontrada = rs("FechaUltimaDevolucion")
                Inventados = rs("RedondeoCliente")
                Redondeo = rs("RedondeoProveedor")
                PedidosUltimosDatos_V2 = True
            End If
        Else
            FechaUltimaVenta = rs("FechaUltimaVenta")
            FechaUltimaVentaNoEncontrada = rs("Fecha")
            If Not IsNull(rs("FechaUltimaDevolucion")) Then FechaUltimaDevolucionNoEncontrada = rs("FechaUltimaDevolucion")
            Inventados = rs("RedondeoCliente")
            Redondeo = rs("RedondeoProveedor")
            PedidosUltimosDatos_V2 = True
        End If
    Else
        FechaUltimaVenta = rs("FechaUltimaVenta")
        FechaUltimaVentaNoEncontrada = rs("Fecha")
        If Not IsNull(rs("FechaUltimaDevolucion")) Then FechaUltimaDevolucionNoEncontrada = rs("FechaUltimaDevolucion")
        Inventados = rs("RedondeoCliente")
        Redondeo = rs("RedondeoProveedor")
        PedidosUltimosDatos_V2 = True
    End If
    
    Exit Function
    
err:
    sf_enviarMail "", "ana@solucionesit365.com", "ERROR PedidosUltimosDatos_V2", "ERROR PedidosUltimosDatos_V2 " & err.Description & "<br>MATERIA:" & Materia & " TIENDA: " & tienda & " PROVEDOR: " & Proveedor, "", ""

End Function


Function cccuentasCodiCompte(iD)
    Dim rs As rdoResultset, Arr, st As String
    st = iD
    cccuentasCodiCompte = ""

    Set rs = Db.OpenResultset("select * from " & ccCuentas & "  where id = '" & st & "'  ")
    If Not rs.EOF Then
       st = rs("Cuenta")
    End If
    
    Set rs = Db.OpenResultset("select * from cccuentas  where cuenta = '" & st & "'  ")
    If Not rs.EOF Then
    
        cccuentasCodiCompte = rs("Cuenta")
        Arr = Split(cccuentasCodiCompte, "|")
        If Arr(0) = "CLIENTE" Then
            cccuentasCodiCompte = codiContable(Arr(1))
            cccuentasCodiCompte = "43" & Right(cccuentasCodiCompte, Len(cccuentasCodiCompte) - 2)
        End If
        If Arr(0) = "MANUAL" Then cccuentasCodiCompte = Arr(1)
        If Arr(0) = "PROVEEDOR" Then cccuentasCodiCompte = codiContableProveedor(Arr(1))
    End If
End Function

Function codiContableFacturaProveedor(cc, D, ReferenciaInterna)

    Dim CodiClient, strCodi, Num, rsCC As rdoResultset, i As Integer, dd As Date
    Dim Rsn As rdoResultset
    
    CodiClient = cc
    codiContableFacturaProveedor = ""
    strCodi = ""
    Num = nDigitos
    
    If InStr(CodiClient, "|") Then
        codiContableFacturaProveedor = codiContableFacturaProveedor
    Else
        'Buscamos el código de facturación del cliente. Si ni dispone de el, creamos uno a partir de su código de cliente
        Set rsCC = Db.OpenResultset("SELECT * FROM [" & tablaFacturaProforma(CVDate(D)) & "] WHERE Idfactura = '" & CodiClient & "'  ")
        If Not rsCC.EOF Then
            If Not IsNull(rsCC("Empresacodi")) And (Len(rsCC("Empresacodi")) > 0) Then
                strCodi = codiContableProveedor(rsCC("Empresacodi"))
            End If
        End If
        
        
        If strCodi = "" Then
            If D = 0 Then D = Now
            dd = DateAdd("m", 3, D)
            While dd > DateAdd("yyyy", -2, D)
                If ExisteixTaula(tablaFacturaProforma(dd)) Then
                    Set rsCC = Db.OpenResultset("SELECT * FROM [" & tablaFacturaProforma(dd) & "] WHERE Idfactura = '" & CodiClient & "'  ")
                    If Not rsCC.EOF Then
                        If Not IsNull(rsCC("Empresacodi")) And (Len(rsCC("Empresacodi")) > 0) Then
                            strCodi = codiContableProveedor(rsCC("Empresacodi"))
                            dd = DateAdd("yyyy", -5, D)
                        End If
                    End If
                 End If
                dd = DateAdd("m", -1, dd)
            Wend
        End If
    End If
    
    codiContableFacturaProveedor = strCodi
    

End Function


Sub codiContableProveedorTotsOk()
    Dim CodiClient, strCodi, Num, rsCC As rdoResultset
    Dim Rsn As rdoResultset
    Dim Ultim As Double
    
    Num = nDigitos
    'Buscamos el código de facturación del cliente. Si ni dispone de el, creamos uno a partir de su código de cliente
    Db.OpenResultset "update ccProveedores  set codi = 0 where codi = ''"
    Set rsCC = Db.OpenResultset("SELECT max(cast(isnull(codi,0) as numeric)) From ccProveedores  ")
    Ultim = 1
    If Not rsCC.EOF Then If Not IsNull(rsCC(0)) Then Ultim = rsCC(0) + 1
    
    Set rsCC = Db.OpenResultset("SELECT Id FROM ccProveedores WHERE codi = cast(0 as numeric) or  codi = '' or codi is null ")
    While Not rsCC.EOF
        Db.OpenResultset "update ccProveedores  set codi = " & Ultim & "  where Id  = '" & rsCC("Id") & "'"
        Ultim = Ultim + 1
        rsCC.MoveNext
    Wend
    

End Sub


Function Cuenta12(c)
    Cuenta12 = Left(c & Space(12), 12)
End Function

Function cVentaMercaderies(Cuenta, TeRetencio As Boolean)
    Dim Contra  As String, rsCtb As rdoResultset, rsCtb2 As rdoResultset, Grupo As String, CodiGrup As String
    Dim vendes701 As Boolean
    'Generamos una subcuenta de IVA en función de la quota, y los digitos de la subcuenta.
    '--------------------------------------------------------------------------------------
    Contra = Cuenta
    Grupo = ClienteGrupo(CDbl(Cuenta))
    CodiGrup = ""
    
    If Len(Grupo) > 0 Then
        CodiGrup = Trim(Left(Grupo, InStr(Grupo, " ")))
        If Not IsNumeric(CodiGrup) Then CodiGrup = ""
    End If
    
    vendes701 = False
    Set rsCtb = Db.OpenResultset("select * from constantsempresa where camp = 'Vendes701'")
    If Not rsCtb.EOF Then
        If rsCtb("valor") = "on" Then
            Set rsCtb2 = Db.OpenResultset("select * from paramsHw where valor1=" & Cuenta)
            If Not rsCtb2.EOF Then
                vendes701 = True
            End If
        End If
    End If
    
    
    If TeRetencio Then
        cVentaMercaderies = "752" & Right("000000000000" & CodiGrup, nDigitos - 3)
    Else
        If vendes701 Then
            cVentaMercaderies = "701" & Right("000000000000" & CodiGrup, nDigitos - 3)
        Else
            cVentaMercaderies = "7" & Right("000000000000" & CodiGrup, nDigitos - 1)
        End If
    End If
    
    cVentaMercaderies = Left(cVentaMercaderies & "             ", 12)
End Function
Function cVentaMercaderiesDevolucions(Cuenta, TeRetencio As Boolean)
    Dim Contra  As String, rs As rdoResultset, Grupo As String, CodiGrup As String
    'Generamos una subcuenta de IVA en función de la quota, y los digitos de la subcuenta.
    '--------------------------------------------------------------------------------------
    Contra = Cuenta
    Grupo = ClienteGrupo(CDbl(Cuenta))
    CodiGrup = ""
    
    If Len(Grupo) > 0 Then
        CodiGrup = Trim(Left(Grupo, InStr(Grupo, " ")))
        If Not IsNumeric(CodiGrup) Then CodiGrup = ""
    End If
    
    If TeRetencio Then
        cVentaMercaderiesDevolucions = "752" & Right("000000000000" & CodiGrup, nDigitos - 3)
    Else
        cVentaMercaderiesDevolucions = "708" & Right("000000000000" & CodiGrup, nDigitos - 3)
    End If
    
    cVentaMercaderiesDevolucions = Left(cVentaMercaderiesDevolucions & "             ", 12)
End Function

Function cVentas(c)
    
     cVentas = Left(Left("7" & Right("000000000000", nDigitos - 1), 12) & Space(12), 12)
    
End Function

Function DSubcuenta(empresa)
    Dim rs
    
    DSubcuenta = 8
    
    Set rs = Db.OpenResultset("select valor from constantsempresa where camp = 'CampDSubcuenta'")
    If Not rs.EOF Then If Not IsNull(rs(0)) Then If Not rs(0) = "" Then DSubcuenta = rs(0)
End Function



Function FormatExportacioBusca(empresa)
    Dim rs
    FormatExportacioBusca = "CP"
    Set rs = Db.OpenResultset("select isnull(valor,'CP') as valor from ConstantsEmpresa where camp = 'ProgramaContable'")
    If Not rs.EOF Then If Not IsNull(rs(0)) Then If Not rs(0) = "" Then FormatExportacioBusca = rs(0)
End Function


Sub ExportaAmbIvaRebudes(numAsiento, dataFactura As Date, clientCodi, numFactura, Total, iva1, iva2, iva3, baseIva1, baseIva2, baseIva3, IvaRec4, idFactura)
    Dim Contra1, Contra2, Contra3, totalImporte, TotalImportePts, datos, CodiEmpressa, IvaRec15, Rs3
    Dim Tenim1, Tenim2, Tenim3, Tenim4, Tenim5, Tenim6, Tenim7, Tenim11, Tenim22, Tenim33, Tenim44
    Dim BaseSinIva, SinIva, IvaRec19, RecConta19, contraSin, RecConta As String, Mes1 As Boolean, Mes2 As Boolean, Mes3 As Boolean, Mes4 As Boolean
    Dim BaseIva11, Iva11, Contra11, BaseIva22, Iva22, Contra22, BaseIva33, Iva33, Contra33, BaseIva44, Iva44, Contra44, IvaRec21, RecConta21, baseIva4, iva4, Contra4
    Dim valorIva1 As Double, valorIva2 As Double, valorIva3 As Double, valorIva4 As Double, valorRec1 As Double, valorRec2 As Double, valorRec3 As Double, valorRec4 As Double
    Dim t As Integer
    
    Contra1 = cCompras(0)
    Contra2 = Contra1
    Contra3 = Contra1
    contraSin = Contra1
    BaseSinIva = 0
    IvaRec15 = 0
    IvaRec4 = 0
    IvaRec19 = 0
    
    TipusDeIva valorIva1, valorIva2, valorIva3, valorIva4, valorRec1, valorRec2, valorRec3, valorRec4, dataFactura

    Set Rs3 = Db.OpenResultset("Select * from [" & tablaFacturaProformaData(CVDate(dataFactura)) & "] where idfactura = '" & idFactura & "' and tipusIva=0 ")
    While Not Rs3.EOF
        Select Case Rs3("preu")
            Case 18
                IvaRec4 = Round(Rs3("Import"), 2)
                RecConta = Left(Right("000000000000" & Rs3("Referencia"), nDigitos) & "                           ", 12)
            Case 15
                IvaRec15 = Round(Rs3("Import"), 2)
                RecConta = Left(Right("000000000000" & Rs3("Referencia"), nDigitos) & "                           ", 12)
            Case 19
                IvaRec19 = Round(Rs3("Import"), 2)
                RecConta19 = Left(Right("000000000000" & Rs3("Referencia"), nDigitos) & "                           ", 12)
            Case 21
                IvaRec21 = Round(Rs3("Import"), 2)
                RecConta21 = Left(Right("000000000000" & Rs3("Referencia"), nDigitos) & "                           ", 12)
            Case Else
                BaseSinIva = Round(Rs3("Import"), 2)
                SinIva = 0
                contraSin = Left(Right("000000000000" & Rs3("Referencia"), nDigitos) & "                           ", 12)
            If contraSin = 0 Then contraSin = "60000000"
        End Select
        Rs3.MoveNext
    Wend
    Rs3.Close
    
    Set Rs3 = Db.OpenResultset("Select tipusIva, referencia, SUM(import) import from [" & tablaFacturaProformaData(CVDate(dataFactura)) & "] where idfactura = '" & idFactura & "' and tipusiva<>0 group by tipusIva, referencia ")
    While Not Rs3.EOF
        If Rs3("TipusIva") = 1 Then
            If Not Mes1 Then
                baseIva1 = Round(Rs3("Import"), 2)
                iva1 = Round(Rs3("Import") * (valorIva1 / 100), 2)
                Contra1 = Left(Right("000000000000" & Rs3("Referencia"), nDigitos) & "                           ", 12)
                If Contra1 = 0 Then Contra1 = "60000000"
                Mes1 = True
            Else
                BaseIva11 = Round(Rs3("Import"), 2)
                Iva11 = Round(Rs3("Import") * (valorIva1 / 100), 2)
                Contra11 = Left(Right("000000000000" & Rs3("Referencia"), nDigitos) & "                           ", 12)
                If Contra11 = 0 Then Contra11 = "60000000"
            End If
        End If
            
            
        If Rs3("TipusIva") = 2 Then
            If Not Mes2 Then
                baseIva2 = Round(Rs3("Import"), 2)
                iva2 = Round(Rs3("Import") * (valorIva2 / 100), 2)
                Contra2 = Left(Right("000000000000" & Rs3("Referencia"), nDigitos) & "                           ", 12)
                If Contra2 = 0 Then Contra2 = "60000000"
                Mes2 = True
            Else
                BaseIva22 = Round(Rs3("Import"), 2)
                Iva22 = Round(Rs3("Import") * (valorIva2 / 100), 2)
                Contra22 = Left(Right("000000000000" & Rs3("Referencia"), nDigitos) & "                           ", 12)
                If Contra22 = 0 Then Contra22 = "60000000"
            End If
        End If
            
        If Rs3("TipusIva") = 3 Then
            If Not Mes3 Then
                baseIva3 = Round(Rs3("Import"), 2)
                iva3 = Round(Rs3("Import") * (valorIva3 / 100), 2)
                Contra3 = Left(Right("000000000000" & Rs3("Referencia"), nDigitos) & "                           ", 12)
                If Contra3 = 0 Then Contra3 = "60000000"
                Mes3 = True
            Else
                BaseIva33 = Round(Rs3("Import"), 2)
                Iva33 = Round(Rs3("Import") * (valorIva3 / 100), 2)
                Contra33 = Left(Right("000000000000" & Rs3("Referencia"), nDigitos) & "                           ", 12)
                If Contra33 = 0 Then Contra33 = "60000000"
            End If
        End If
        
        If Rs3("TipusIva") = 4 Then
            If Not Mes4 Then
                baseIva4 = Round(Rs3("Import"), 2)
                iva4 = 0 'Round(Rs3("Import") * (valorIva1 / 100), 2)
                Contra4 = Left(Right("000000000000" & Rs3("Referencia"), nDigitos) & "                           ", 12)
                If Contra4 = 0 Then Contra4 = "60000000"
                Mes4 = True
            Else
                BaseIva44 = Round(Rs3("Import"), 2)
                Iva44 = 0 'Round(Rs3("Import") * (valorIva1 / 100), 2)
                Contra44 = Left(Right("000000000000" & Rs3("Referencia"), nDigitos) & "                           ", 12)
                If Contra44 = 0 Then Contra44 = "60000000"
            End If
        End If
        Rs3.MoveNext
    Wend
    Rs3.Close
    
    clientCodi = clientCodi
    iva1 = Round(iva1, 2)
    iva2 = Round(iva2, 2)
    iva3 = Round(iva3, 2)
    iva4 = Round(iva4, 2)
    
    baseIva1 = Round(baseIva1, 2)
    baseIva2 = Round(baseIva2, 2)
    baseIva3 = Round(baseIva3, 2)
    baseIva4 = Round(baseIva4, 2)
    BaseIva11 = Round(BaseIva11, 2)
    BaseIva22 = Round(BaseIva22, 2)
    BaseIva33 = Round(BaseIva33, 2)
    BaseIva44 = Round(BaseIva44, 2)
    
    If IsNull(IvaRec4) Then IvaRec4 = 0
    IvaRec4 = Round(IvaRec4, 2)
    IvaRec15 = Round(IvaRec15, 2)
    
    totalImporte = Round((iva1 + iva2 + iva3 + iva4 + Iva11 + Iva22 + Iva33 + Iva44 + baseIva1 + baseIva2 + baseIva3 + baseIva4 + BaseIva11 + BaseIva22 + BaseIva33 + BaseIva44 + BaseSinIva + IvaRec4 + IvaRec15 + IvaRec19 + IvaRec21), 2)
'ERROR ExportaCP Cuando llegan vacias baseIvaX y IvaX no sale del bucle!
    If iva1 = "" Then iva1 = 0
    If iva2 = "" Then iva2 = 0
    If iva3 = "" Then iva3 = 0
    If iva4 = "" Then iva4 = 0
    If Iva11 = "" Then Iva11 = 0
    If Iva22 = "" Then Iva22 = 0
    If Iva33 = "" Then Iva33 = 0
    If Iva44 = "" Then Iva44 = 0
    
    If totalImporte <> 0 Then
        t = 0
        While Total <> totalImporte And t < 30
            If Abs(baseIva1) > 0 Then
                baseIva1 = baseIva1 + (Total - totalImporte)
            ElseIf Abs(baseIva2) > 0 Then
                baseIva2 = baseIva2 + (Total - totalImporte)
            ElseIf Abs(baseIva3) > 0 Then
                baseIva3 = baseIva3 + (Total - totalImporte)
            ElseIf Abs(baseIva4) > 0 Then
                baseIva4 = baseIva4 + (Total - totalImporte)
            ElseIf Abs(BaseIva11) > 0 Then
                BaseIva11 = BaseIva11 + (Total - totalImporte)
            ElseIf Abs(BaseIva22) > 0 Then
                BaseIva22 = BaseIva22 + (Total - totalImporte)
            ElseIf Abs(BaseIva33) > 0 Then
                BaseIva33 = BaseIva33 + (Total - totalImporte)
            ElseIf Abs(BaseIva44) > 0 Then
                BaseIva44 = BaseIva44 + (Total - totalImporte)
            ElseIf Abs(BaseSinIva) > 0 Then
                baseIva3 = BaseSinIva + (Total - totalImporte)
            End If
            totalImporte = Round((iva1 + iva2 + iva3 + Iva11 + Iva22 + Iva33 + Iva44 + baseIva1 + baseIva2 + baseIva3 + baseIva4 + BaseIva11 + BaseIva22 + BaseIva33 + BaseIva44 + BaseSinIva + IvaRec4 + IvaRec15 + IvaRec19 + IvaRec21), 2)
            t = t + 1
            DoEvents
        Wend
    End If
    
    If baseIva2 < 0 Then baseIva2 = baseIva2
    
    AsientoAdd numAsiento, dataFactura, codiContableProveedor(clientCodi), Contra1, numFactura, Left("S/F " & numFactura & Space(25), 25), 0, totalImporte, 0, 0, 0, ""
    
    Tenim1 = False
    Tenim2 = False
    Tenim3 = False
    Tenim4 = False
    Tenim5 = False
    Tenim11 = False
    Tenim22 = False
    Tenim33 = False
    Tenim44 = False
    
    If Abs(iva1) > 0 Then Tenim1 = True
    If Abs(iva2) > 0 Then Tenim2 = True
    If Abs(iva3) > 0 Then Tenim3 = True
    If Abs(baseIva4) > 0 Then Tenim4 = True

    If (Tenim1) And Abs(baseIva1) > 0 Then Tenim4 = True
    If (Tenim2) And Abs(baseIva2) > 0 Then Tenim5 = True
    If (Tenim3) And Abs(baseIva3) > 0 Then Tenim6 = True
    If (Tenim4) And Abs(baseIva4) > 0 Then Tenim7 = True
    
    If (Tenim4) And Abs(BaseIva11) > 0 Then Tenim11 = True
    If (Tenim5) And Abs(BaseIva22) > 0 Then Tenim22 = True
    If (Tenim6) And Abs(BaseIva33) > 0 Then Tenim33 = True
    If (Tenim7) And Abs(BaseIva44) > 0 Then Tenim44 = True

    'En función de los Tipos de IVA, creamos los asientos correspondientes
    If Tenim1 Then PintaDetallIvaRebudes numAsiento, CodiEmpressa, clientCodi, dataFactura, iva1, baseIva1, numFactura, " " & valorIva1 & ".00", cIvaCompras(valorIva1), 0
    If Tenim2 Then PintaDetallIvaRebudes numAsiento, CodiEmpressa, clientCodi, dataFactura, iva2, baseIva2, numFactura, " " & valorIva2 & ".00", cIvaCompras(valorIva2), 0
    If Tenim3 Then PintaDetallIvaRebudes numAsiento, CodiEmpressa, clientCodi, dataFactura, iva3, baseIva3, numFactura, valorIva3 & ".00", cIvaCompras(valorIva3), 0
    If Tenim4 Then PintaDetallIvaRebudes numAsiento, CodiEmpressa, clientCodi, dataFactura, iva4, baseIva4, numFactura, valorIva4 & ".00", cIvaCompras(valorIva4), 0
    
    If Tenim11 Then PintaDetallIvaRebudes numAsiento, CodiEmpressa, clientCodi, dataFactura, Iva11, BaseIva11, numFactura, " " & valorIva1 & ".00", cIvaCompras(valorIva1), 0
    If Tenim22 Then PintaDetallIvaRebudes numAsiento, CodiEmpressa, clientCodi, dataFactura, Iva22, BaseIva22, numFactura, " " & valorIva2 & ".00", cIvaCompras(valorIva2), 0
    If Tenim33 Then PintaDetallIvaRebudes numAsiento, CodiEmpressa, clientCodi, dataFactura, Iva33, BaseIva33, numFactura, valorIva3 & ".00", cIvaCompras(valorIva3), 0
    If Tenim44 Then PintaDetallIvaRebudes numAsiento, CodiEmpressa, clientCodi, dataFactura, Iva44, BaseIva44, numFactura, valorIva4 & ".00", cIvaCompras(valorIva4), 0
    
    If Tenim4 Then PintaDetallIvaRebudes numAsiento, CodiEmpressa, clientCodi, dataFactura, baseIva1, "0.00", numFactura, "0.00", Contra1, 0
    If Tenim5 Then PintaDetallIvaRebudes numAsiento, CodiEmpressa, clientCodi, dataFactura, baseIva2, "0.00", numFactura, "0.00", Contra2, 0
    If Tenim6 Then PintaDetallIvaRebudes numAsiento, CodiEmpressa, clientCodi, dataFactura, baseIva3, "0.00", numFactura, "0.00", Contra3, 0
    If Tenim7 Then PintaDetallIvaRebudes numAsiento, CodiEmpressa, clientCodi, dataFactura, baseIva4, "0.00", numFactura, "0.00", Contra4, 0
    
    If Tenim11 Then PintaDetallIvaRebudes numAsiento, CodiEmpressa, clientCodi, dataFactura, BaseIva11, "0.00", numFactura, "0.00", Contra11, 0
    If Tenim22 Then PintaDetallIvaRebudes numAsiento, CodiEmpressa, clientCodi, dataFactura, BaseIva22, "0.00", numFactura, "0.00", Contra22, 0
    If Tenim33 Then PintaDetallIvaRebudes numAsiento, CodiEmpressa, clientCodi, dataFactura, BaseIva33, "0.00", numFactura, "0.00", Contra33, 0
    If Tenim44 Then PintaDetallIvaRebudes numAsiento, CodiEmpressa, clientCodi, dataFactura, BaseIva44, "0.00", numFactura, "0.00", Contra44, 0
    
    If Abs(BaseSinIva) > 0 Then PintaDetallIvaRebudes numAsiento, CodiEmpressa, clientCodi, dataFactura, BaseSinIva, "0.00", numFactura, "0.00", contraSin, 0
    
    If Abs(IvaRec4) > 0 Then
        If RecConta = "" Then RecConta = Left("4751" & Left("00000", nDigitos - 3 - 4) & Right("00000" & Trim(Contra3), 3) & "                           ", 12)
        PintaDetallIvaRebudes numAsiento, CodiEmpressa, clientCodi, dataFactura, 0, "0.00", numFactura, "0.00", RecConta, Abs(IvaRec4)
    End If
    
    If Abs(IvaRec15) > 0 Then
        If RecConta = "" Then RecConta = Left("4751" & Left("00000", nDigitos - 3 - 4) & Right("00000" & Trim(Contra3), 3) & "                           ", 12)
        PintaDetallIvaRebudes numAsiento, CodiEmpressa, clientCodi, dataFactura, 0, "0.00", numFactura, "0.00", RecConta, Abs(IvaRec15)
    End If

    If Abs(IvaRec19) > 0 Then
        If RecConta19 = "" Then RecConta = Left("4751" & Left("00000", nDigitos - 3 - 4) & Right("00000" & Trim(Contra3), 3) & "                           ", 12)
        PintaDetallIvaRebudes numAsiento, CodiEmpressa, clientCodi, dataFactura, 0, "0.00", numFactura, "0.00", RecConta19, Abs(IvaRec19)
    End If

    If Abs(IvaRec21) > 0 Then
        If RecConta21 = "" Then RecConta = Left("4751" & Left("00000", nDigitos - 3 - 4) & Right("00000" & Trim(Contra3), 3) & "                           ", 12)
        PintaDetallIvaRebudes numAsiento, CodiEmpressa, clientCodi, dataFactura, 0, "0.00", numFactura, "0.00", RecConta21, Abs(IvaRec21)
    End If


    DoEvents

End Sub
Function cCompras(c)
    cCompras = "60000000    "
End Function

Sub ExportaCalaixosJustificats(Di As Date, Df, numAsiento, client, EsB)
    Dim D, i, j, sql As String, rsCtb As rdoResultset, Num, iD, Cuenta1, Cuenta2, Descripcio, Deve, Haver, acd, Ach, DadesExportaCpFinsAra, FacturaId, texte As String, fecha, ReferenciaInterna, ImportReal, Parts
            
   InformaMiss "Calaixos ", True
   D = Di
   i = 0
   j = 0
        
   sql = " select * from " & DonamNomTaulaAsientosContables(Di) & " c "
   sql = sql & " where c.idnorma43 like '%|%/" & Year(Di) & "%' "
   If Not client = 0 Then If Not client = "" Then sql = sql & " And left(idnorma43,charindex('|',idnorma43)-1) = '" & client & "' "
   If EsB Then sql = sql & "  and not left(concepto,14) = 'Entrega diària' "
   
   sql = sql & " order by idnorma43,orden,concepto "

    Set rsCtb = Db.OpenResultset(sql)
    If Not rsCtb.EOF Then iD = rsCtb("IdNorma43")
    Num = -1: acd = 0: Ach = 0
        
    DadesExportaCpFinsAra = DadesExportaCp
    While Not rsCtb.EOF
        Parts = Split(rsCtb("IdNorma43"), "|")
        fecha = DateSerial(Year(CVDate(Parts(1))), Month(CVDate(Parts(1))), Day(CVDate(Parts(1))))
        InformaMiss "Calaixos " & numAsiento & "  " & fecha, True
        If (fecha >= Di And fecha <= Df) And ExisteixMoviment(rsCtb("IdNorma43")) Then
                'If InStr(Texte, "716") > 0 Then
                '   Num = Num
                'End If
            ExportaCalaixosJustificatsMirasiGuarda Num, Cuenta1, FacturaId, texte, numAsiento, fecha, Descripcio, Deve, Haver, iD, rsCtb("IdNorma43"), rsCtb("Orden"), acd, Ach, DadesExportaCpFinsAra, ReferenciaInterna

            Cuenta1 = rsCtb("SUBCUENTA")  ' Caldria guardar la referencia interna CHAPUZON !!!!!
            If Left(Cuenta1, 3) = "572" Then
                Cuenta1 = BancoNumConta(rsCtb("IdNorma43"), rsCtb("SUBCUENTA"))
            ElseIf Left(Cuenta1, 2) = "43" Then
                If Right(Cuenta1, 5) = "00000" Then
                    Cuenta1 = codiContable(Right("00000" & rsCtb("ReferenciaInterna"), 5))
                Else
                    Cuenta1 = codiContable(Right(Cuenta1, 5))
                End If
            End If
            
            If (Descripcio = "" Or Descripcio = 0) Then Descripcio = rsCtb("DESCRIPCION")
            
            If Not rsCtb("FacturaId") = "Pendiente" Then
                If (FacturaId = "" Or FacturaId = 0) Then
                   FacturaId = rsCtb("FacturaId")
                   If Len(FacturaId) > 5 And (Cuenta1 = "" Or Right(Cuenta1, 5) = "00000") Then Cuenta1 = codiContableFacturaProveedor(FacturaId, Now, ReferenciaInterna)
                End If
            End If
            
            texte = rsCtb("CONCEPTO")
            If (Descripcio = "" Or Descripcio = 0) Then Descripcio = rsCtb("CONCEPTO")

            If Not rsCtb("DEBE") = "" Then Deve = Round(rsCtb("DEBE"), 2)
            If Deve = "" Then Deve = "0"
            acd = acd + CDbl(Deve)

            If Not rsCtb("HABER") = "" Then Haver = Round(rsCtb("HABER"), 2)
            If Haver = "" Then Haver = "0"
            Ach = Ach + CDbl(Haver)

            iD = rsCtb("IdNorma43")
            Num = rsCtb("Orden")
        Else
            ExportaCalaixosJustificatsMirasiGuarda Num, Cuenta1, FacturaId, texte, numAsiento, fecha, Descripcio, Deve, Haver, iD, "Ulti", -1, acd, Ach, DadesExportaCpFinsAra, ReferenciaInterna
            iD = rsCtb("IdNorma43")
            Num = -1
            fecha = 0
            Descripcio = 0
            Deve = 0
            Haver = 0
            ReferenciaInterna = ""
            FacturaId = ""
        End If
        DoEvents
        rsCtb.MoveNext
    Wend
    rsCtb.Close
        
    ExportaCalaixosJustificatsMirasiGuarda Num, Cuenta1, FacturaId, texte, numAsiento, fecha, Descripcio, Deve, Haver, iD, "Ulti", -1, acd, Ach, DadesExportaCpFinsAra, ReferenciaInterna
 

End Sub

Function ExisteixMoviment(idNorma43 As String) As Boolean
    Dim Parts
    Dim rs
    ExisteixMoviment = False
    Parts = Split(idNorma43, "|")
    Set rs = Db.OpenResultset("Select * from [" & NomTaulaMovi(CVDate(Parts(1))) & "] Where Botiga = " & Parts(0) & " And Day(Data) = " & Day(CVDate(Parts(1))) & " And DatePart(hh, Data) = " & Hour(CVDate(Parts(1))) & " And DatePart(n, Data) = " & Minute(CVDate(Parts(1))) & " And DatePart(s, Data) = " & Second(CVDate(Parts(1))) & " And Dependenta = " & Parts(2) & " ")
    If Not rs.EOF Then ExisteixMoviment = True

End Function

Sub ExportaCalaixosJustificatsMirasiGuarda(Num, Cuenta1, FacturaId, texte As String, numAsiento, fecha, Descripcio, Deve, Haver, iD, idNorma43, orden, acd, Ach, DadesExportaCpFinsAra, ReferenciaInterna)
    Static UltimaDescripcio As String
    Static PenUltimaDescripcio
    
    If Not (iD = idNorma43 And Num = orden) Then
        If Not Num = -1 Then
            If Trim(Cuenta1) = "40000000" Then
                If Len(FacturaId) > 0 And Not FacturaId = 0 Then Cuenta1 = codiContableFacturaProveedor(FacturaId, Now, ReferenciaInterna)
                If Trim(Cuenta1) = "40000000" Then Cuenta1 = BuscaComptePerNom(texte)
            End If
            If Trim(Cuenta1) = "43000000" Then Cuenta1 = codiContableProveedor(ReferenciaInterna)
            If FacturaId = "Nomina" Then
            Cuenta1 = codiNominaTreballador(FacturaId)
            End If
            
            If Trim(Cuenta1) = "40000000" Then
                Num = Num
            End If
            AsientoAdd numAsiento, Split(iD, "|")(1), Cuenta1, "", 0, Descripcio, Deve, Haver, 0, 0, 0, ""
            PenUltimaDescripcio = UltimaDescripcio
            UltimaDescripcio = Descripcio
        End If
        
        If iD = idNorma43 Then
        
        
        Else
            If InStr(PenUltimaDescripcio, "Codi de barres") > 0 Then
            Descripcio = Descripcio
            End If
            If (Abs(acd - Ach) > 0.001 Or Left(Trim(Cuenta1), 3) = "572" Or InStr(PenUltimaDescripcio, "Codi de barres") > 0) And Not Deve = 179.67 Then
               DadesExportaCp = DadesExportaCpFinsAra
               DadesExportaCpFlush
            Else
               DadesExportaCp = DadesExportaCp
               If Not acd = 0 And Not Ach = 0 Then numAsiento = numAsiento + 1
               DadesExportaCpFlush
            End If
            acd = 0
            Ach = 0
            Cuenta1 = 0
            DadesExportaCpFinsAra = DadesExportaCp
        End If
        texte = ""
        iD = idNorma43
        Num = orden
        fecha = 0
        Descripcio = 0
        Deve = 0
        Haver = 0
        ReferenciaInterna = ""
        FacturaId = ""
    End If

End Sub


Sub ExportaVentas(TipusExportacio, Ini As Date, Fin, preus, tipo, nombre, empresa, client, nAsiento, Group)
    Dim CalSumar, DSubcuenta, campo, rsC As rdoResultset, Cl, clients, i, DESCRIPCIoN
    Dim Di, Mi, Ai, Df, Mf, Af, sql, rsCli As rdoResultset, rsIva As rdoResultset, max, aux As Date, SQLA() As String, rs As rdoResultset, fecha, cBotiga, CcBotiga
    Dim nBotiga, fechaAct, cBotigaAct, CcBotigaAct, tipoIva, strDebe, import, nIVA(), nBase(), Total, posIVA, Base, Quota, Departamento, depa
    
    
    'PARÁMETROS ---------------------------------------------------------------------------

    CalSumar = False
    DSubcuenta = nDigitos
    If empresa = "0" Then
        campo = "CampDSubcuenta"
    Else
        campo = empresa & "_CampDSubcuenta"
    End If

    Set rsC = Db.OpenResultset("select valor from constantsEmpresa where camp='" & campo & "'")
    If Not rsC.EOF Then
        If IsNumeric(rsC("valor")) Then DSubcuenta = CInt(rsC("valor"))
    End If

' Funcio Auxiliar Pinta la linea
    'CLIENTES SELECCIONADOS -----------------------------------------------------------------
    If client = "-1" Or client = "" Then
        Set rsC = Db.OpenResultset("select distinct valor1 from ParamsHw ")
        Cl = 0
        ReDim Clis(Cl)
        While Not rsC.EOF
            ReDim Preserve Clis(Cl)
            Clis(Cl) = rsC("valor1")
            rsC.MoveNext
            Cl = Cl + 1
        Wend
        rsC.Close
        client = Join(Clis, ", ")
    End If
    clients = Split(client, ", ")

    If empresa <> "ALL" Then 'And InStr(request.Form, "empresa")
        If empresa = "0" Then
            campo = "CampCliente"
        Else
            campo = empresa & "_CampCliente"
        End If
        Set rsC = Db.OpenResultset("select valor from constantsEmpresa where camp='" & campo & "'")
        i = 0
        ReDim clients(i)
        While Not rsC.EOF
            ReDim Preserve clients(i)
            clients(i) = rsC("valor")
            i = i + 1
            rsC.MoveNext
        Wend
        client = Join(clients, ",")
    End If
    DESCRIPCIoN = "sss" 'request.Item("descripcion")

    Di = Right("0" & Day(Ini), 2)
    Mi = Right("0" & Month(Ini), 2)
    Ai = Right("0" & Year(Ini), 2)
    Df = Right("0" & Day(Fin), 2)
    Mf = Right("0" & Month(Fin), 2)
    Af = Right("0" & Year(Fin), 2)

    If client = "" Then
        If empresa = "ALL" Then
            sql = "select b.codi c from clients b left join  ParamsHw p on p.valor1=b.codi order by nom"
        Else
            If empresa = "0" Then
                campo = "CampCliente"
            Else
                campo = empresa & "_CampCliente"
            End If
            sql = "select e.valor c from constantsEmpresa e left join  ParamsHw p on p.valor1=e.valor where camp='" & campo & "'"
        End If
        Set rsCli = Db.OpenResultset(sql)
        i = 0
        ReDim aCli(i)
        While Not rsCli.EOF
            ReDim Preserve aCli(i)
            aCli(i) = rsCli("c")
            i = i + 1
            rsCli.MoveNext
        Wend
        rsCli.Close
        client = Join(aCli, ",")
    End If

'   'IVAS ------------------------------------------------------------------
    Set rsIva = Db.OpenResultset("select Tipus, Iva from " & DonamTaulaTipusIva(Ini) & " order by tipus")
    i = 0
    max = 0
    ReDim Tipus(4)
    ReDim iva(4)
    ReDim totalesBase(4)
    For i = 0 To UBound(Tipus)
        Tipus(i) = i + 1
        iva(i) = 1
    Next
    While Not rsIva.EOF
        iva(CInt(rsIva("Tipus")) - 1) = rsIva("iva")
        rsIva.MoveNext
    Wend
    iva(4) = "ALTRES"

    'SUBCONSULTAS --------------------------------------------------------------------------
    aux = Ini
    i = 0
    While aux <= Fin
        ReDim Preserve SQLA(i)

        SQLA(i) = "select Botiga,Day(data) as Dia,month(data) as Mes,Year(data) as Ano,0 as part , sum(import) as Tot , plu From " & NomTaulaVentas(aux) & "  "
        SQLA(i) = SQLA(i) & "where botiga in(" & client & ")  and data between convert(datetime,'" & Di & "/" & Mi & "/" & Ai & "',3)  and convert(datetime,'" & Df & "/" & Mf & "/" & Af & "',3)+convert(datetime,'23:59:59',8) "
        SQLA(i) = SQLA(i) & "group by Botiga,Day(data) ,month(data),Year(data) ,Plu "
' Version sin office xp

        'If Session("Usuari_NivellSeguretat") <> 5 Then
        '    If TipusExportacio <> "Tot" Then
        '        CalSumar = True
        '        SQLA(i) = SQLA(i) & "union "
        '        SQLA(i) = SQLA(i) & "select Botiga,Day(data) as Dia,month(data) as Mes,Year(data) as Ano,sum(import) as Part,0 as tot , plu From " & NomTaulaVentasPrevistes(aux) & " "
        '        SQLA(i) = SQLA(i) & "Where botiga in(" & Client & ")  and data between convert(datetime,'" & Di & "/" & Mi & "/" & Ai & "',3)  and convert(datetime,'" & Df & "/" & Mf & "/" & Af & "',3)+convert(datetime,'23:59:59',8) "
        '        SQLA(i) = SQLA(i) & "group by Botiga,Day(data) ,month(data),Year(data) ,Plu "
        '    End If
        'End If
        aux = DateAdd("m", 1, aux)
        i = i + 1
    Wend

    'GENERACIÓN FICHERO LOGIC CONTROL --------------------------------------------------------
    sql = "select ff.pare as depa,left(isnull(ff.pare,'CAP'),charindex(' ',isnull(ff.pare,'CAP'))) As Departamento,k.dia,k.mes,k.ano,a.tipoiva ,Sum(k.tot) - Sum(k.Part) as import,k.botiga cod,c.nom botiga,cc.valor "
    sql = sql & "from(" & Join(SQLA, " union ") & ") k  "
    sql = sql & "left join (select familia,codi,TipoIva from articles_zombis where codi not in (select codi from Articles) union select familia,codi,TipoIva from Articles ) a on k.Plu = a.codi "
    sql = sql & "left join clients c on c.codi = k.botiga  "
    sql = sql & "left join constantsclient cc On cc.codi = c.codi and cc.variable = 'CodiContable'  "
    sql = sql & "left join Families F On f.nom = a.Familia  "
    sql = sql & "left join Families Ff On Ff.nom = f.pare  "
    sql = sql & "Group by c.nom,k.botiga,cc.valor,ano,mes,dia,left(isnull(ff.pare,'CAP'),charindex(' ',isnull(ff.pare,'CAP'))),TipoIva,ff.pare  "
    sql = sql & "Having abs(Sum(k.tot) - Sum(k.Part)) > 0.001 "
    sql = sql & "Order by c.nom,k.botiga,cc.valor,ano,mes,dia,Departamento,TipoIva  "

    Set rs = Db.OpenResultset(sql)

    If Not rs.EOF Then
        fecha = Right("0" & rs("dia"), 2) & Right("0" & rs("mes"), 2) & Right("0" & rs("ano"), 2)
        cBotiga = CStr(rs("cod"))
        CcBotiga = 0
        If Not IsNull(rs("Valor")) Then If IsNumeric(rs("Valor")) Then CcBotiga = CStr(rs("Valor"))
        nBotiga = rs("botiga")
        fechaAct = ""
        cBotigaAct = ""
        CcBotigaAct = 0
        tipoIva = ""
        strDebe = ""
        import = 0
        ReDim nIVA(3)
        ReDim nBase(3)
        i = 0
        For i = 0 To 3
            nIVA(i) = 0
            nBase(i) = 0
        Next

        ReDim depNom(0)
        ReDim DepNomTxt(0)
        ReDim DepImport(0)
        ReDim DepIvaBase0(0)
        ReDim DepIvaQuota0(0)
        ReDim DepIvaBase1(0)
        ReDim DepIvaQuota1(0)
        ReDim DepIvaBase2(0)
        ReDim DepIvaQuota2(0)
        ReDim DepIvaBase3(0)
        ReDim DepIvaQuota3(0)
        depNom(0) = "NOUTILITZAT"

        While Not rs.EOF
            fechaAct = Right("0" & rs("dia"), 2) & Right("0" & rs("mes"), 2) & Right("0" & rs("ano"), 2)
            cBotigaAct = CStr(rs("cod"))
            CcBotigaAct = 0
            If Not IsNull(rs("Valor")) Then If IsNumeric(rs("Valor")) Then CcBotigaAct = CStr(rs("Valor"))

            If (cBotiga & fecha) <> (cBotigaAct & fechaAct) Then
                PintaBlock Total, CcBotiga, fecha, nBotiga, nAsiento, nBase, depNom, DepImport
                fecha = fechaAct
                cBotiga = cBotigaAct
                CcBotiga = CcBotigaAct
                nAsiento = nAsiento + 1
                nBotiga = rs("botiga")
                Total = 0
                tipoIva = ""
                strDebe = ""
                i = 0
                For i = 0 To 2
                    nIVA(i) = 0
                    nBase(i) = 0
                Next
                ReDim depNom(0)
                ReDim DepNomTxt(0)
                ReDim DepImport(0)
                ReDim DepIvaBase0(0)
                ReDim DepIvaQuota0(0)
                ReDim DepIvaBase1(0)
                ReDim DepIvaQuota1(0)
                ReDim DepIvaBase2(0)
                ReDim DepIvaQuota2(0)
                ReDim DepIvaBase3(0)
                ReDim DepIvaQuota3(0)
                depNom(0) = "NOUTILITZAT"
            End If

            tipoIva = iva(CInt(rs("TipoIva")) - 1)
            import = CDbl(rs("import"))  'ESTE IMPORTE ES CON IVA!!
            posIVA = 0
            If tipoIva = "4" Then posIVA = 0 Else If tipoIva = "7" Then posIVA = 1 Else If tipoIva = "16" Then posIVA = 2
            'If TipoIva = "4" Then posIVA = 0 Else If TipoIva = "8" Then posIVA = 1 Else If TipoIva = "18" Then posIVA = 2
            If CalSumar Then
                posIVA = 0
                Base = import
                Quota = 0
            Else
                Base = Round(import / (1 + (tipoIva / 100)), 2)
                Quota = import - Base
            End If
            nBase(posIVA) = nBase(posIVA) + Base
            nIVA(posIVA) = nIVA(posIVA) + Quota

            Total = Total + Base + Quota
            Departamento = 0
            If Not IsNull(rs("Departamento")) Then If IsNumeric(rs("Departamento")) Then Departamento = rs("Departamento")
            Departamento = rs("Departamento")
            depa = "General "
            If InStr(rs("Depa"), " ") > 1 Then
                depa = Right(rs("Depa"), Len(rs("Depa")) - InStr(rs("Depa"), " "))
            End If

            For i = 0 To UBound(depNom)
                If depNom(i) = Departamento Then Exit For
            Next
            If depNom(0) = "NOUTILITZAT" Then i = 0

            If i > UBound(depNom) Then
                i = UBound(depNom) + 1
                ReDim Preserve depNom(i)
                ReDim Preserve DepNomTxt(i)
                ReDim Preserve DepImport(i)
                ReDim Preserve DepIvaBase0(i)
                ReDim Preserve DepIvaQuota0(i)
                ReDim Preserve DepIvaBase1(i)
                ReDim Preserve DepIvaQuota1(i)
                ReDim Preserve DepIvaBase2(i)
                ReDim Preserve DepIvaQuota2(i)
                ReDim Preserve DepIvaBase3(i)
                ReDim Preserve DepIvaQuota3(i)
            End If

            depNom(i) = Departamento
            DepNomTxt(i) = depa
            DepImport(i) = DepImport(i) + Base

            If posIVA = 0 Then
                DepIvaBase0(i) = DepIvaBase0(i) + Base
                DepIvaQuota0(i) = DepIvaQuota0(i) + Quota
            End If
            If posIVA = 1 Then
                DepIvaBase1(i) = DepIvaBase1(i) + Base
                DepIvaQuota1(i) = DepIvaQuota1(i) + Quota
            End If
            If posIVA = 2 Then
                DepIvaBase2(i) = DepIvaBase2(i) + Base
                DepIvaQuota2(i) = DepIvaQuota2(i) + Quota
            End If

            rs.MoveNext
        Wend

        PintaBlock Total, CcBotiga, fecha, nBotiga, nAsiento, nBase, depNom, DepImport
        rs.Close
    End If
End Sub

Function PedidoCuantosFaltan(Codi As Double, botiga As Double, desde As Date, hasta As Date) As Double
    Dim rs As rdoResultset, UltimaVenta As Date, Sortides
'    InformaMiss BotigaCodiNom(Botiga) & " --> " & ArticleCodiNom(Codi), True
'    GuardaHistoric Botiga, Now, "Comanda Calculat :", " Servit = Vendido desde ultim envio"
    
'    UltimaVenta = DateAdd("d", -7, Now)
'    Set Rs = Db.OpenResultset("Select * from Records Where Concepte = 'ComandesUltimaVenta_" & Botiga & "_" & Codi & "' ")
'    If Not Rs.EOF Then If Not IsNull(Rs("TimeStamp")) Then UltimaVenta = Rs("TimeStamp")

    JaMirats = ""
    PedidoCuantosFaltan = PedidoCalculaVenut(Codi, botiga, desde, hasta)
    
    

End Function
Function PedidoCuantosFaltan_91(Codi As Double, botiga As Double, desde As Date, hasta As Date, Optional consumoPersonal As Boolean) As Double

    JaMirats = ""
    PedidoCuantosFaltan_91 = PedidoCalculaVenut_91(Codi, botiga, desde, hasta, consumoPersonal)

End Function

Function PedidoCuantosFaltan_V2(Codi As Double, botiga As Double, desde As Date, hasta As Date, Optional consumoPersonal As Boolean) As Double

    JaMirats = ""
    PedidoCuantosFaltan_V2 = PedidoCalculaVenut_V2(Codi, botiga, desde, hasta, consumoPersonal)

End Function


Function PedidoNOServido_91(Codi As Double, botiga As Double, desde As Date, hasta As Date) As Double
    Dim rs As rdoResultset
    Dim quantitatDemanada As Double, quantitatServida As Double
    Dim D As Date
    
On Error GoTo err

    quantitatDemanada = 0
    quantitatServida = 0
    
    For D = desde To hasta
        Set rs = Db.OpenResultset("select isnull(sum(quantitatServida), 0) quantitatServida, isnull(sum(quantitatDemanada), 0) quantitatDemanada from [servit-" & Right(Year(D), 2) & "-" & Right("00" & Month(D), 2) & "-" & Right("00" & Day(D), 2) & "] where codiArticle=" & Codi & " and client = " & botiga)
        If Not rs.EOF Then
            quantitatDemanada = quantitatDemanada + rs("quantitatDemanada")
            quantitatServida = quantitatServida + rs("quantitatServida")
        End If
    Next
        
    Set rs = Db.OpenResultset("select isnull(sum(quantitatServida), 0) quantitatServida, isnull(sum(quantitatDemanada), 0) quantitatDemanada from [servit-" & Right(Year(D), 2) & "-" & Right("00" & Month(D), 2) & "-" & Right("00" & Day(D), 2) & "] where codiArticle=" & Codi & " and client = " & botiga)
    If Not rs.EOF Then
        quantitatDemanada = quantitatDemanada + rs("quantitatDemanada")
        quantitatServida = quantitatServida + rs("quantitatServida")
    End If
        
    PedidoNOServido_91 = quantitatDemanada - quantitatServida
    Exit Function
    
err:
    PedidoNOServido_91 = 0
    sf_enviarMail "", "ana@solucionesit365.com", "ERROR PedidoNOServido_91", "ERROR PedidoNOServido_91 Codi: " & Codi & " botiga: " & botiga & " ERR: " & err.Description, "", ""

End Function

Function PedidoNOServido_V2(Codi As Double, botiga As Double, desde As Date, hasta As Date) As Double
    Dim rs As rdoResultset
    Dim quantitatDemanada As Double, quantitatServida As Double
    Dim D As Date
    
On Error GoTo err

    quantitatDemanada = 0
    quantitatServida = 0
    
    For D = desde To hasta
        Set rs = Db.OpenResultset("select isnull(sum(quantitatServida), 0) quantitatServida, isnull(sum(quantitatDemanada), 0) quantitatDemanada from [servit-" & Right(Year(D), 2) & "-" & Right("00" & Month(D), 2) & "-" & Right("00" & Day(D), 2) & "] where codiArticle=" & Codi & " and client = " & botiga)
        If Not rs.EOF Then
            quantitatDemanada = quantitatDemanada + rs("quantitatDemanada")
            quantitatServida = quantitatServida + rs("quantitatServida")
        End If
    Next
        
    Set rs = Db.OpenResultset("select isnull(sum(quantitatServida), 0) quantitatServida, isnull(sum(quantitatDemanada), 0) quantitatDemanada from [servit-" & Right(Year(D), 2) & "-" & Right("00" & Month(D), 2) & "-" & Right("00" & Day(D), 2) & "] where codiArticle=" & Codi & " and client = " & botiga)
    If Not rs.EOF Then
        quantitatDemanada = quantitatDemanada + rs("quantitatDemanada")
        quantitatServida = quantitatServida + rs("quantitatServida")
    End If
        
    PedidoNOServido_V2 = quantitatDemanada - quantitatServida
    Exit Function
    
err:
    PedidoNOServido_V2 = 0
    sf_enviarMail "", "ana@solucionesit365.com", "ERROR PedidoNOServido_V2", "ERROR PedidoNOServido_V2 Codi: " & Codi & " botiga: " & botiga & " ERR: " & err.Description, "", ""

End Function



Function EncarregatsServits(Codi As Double, botiga As Double, desde As Date, hasta As Date) As Double
    Dim rs As rdoResultset, UltimaVenta As Date, Sortides
    JaMirats = ""
    EncarregatsServits = EncarregatsServitsFaltan(Codi, botiga, desde, hasta)
End Function
Function EncarregatsServits_91(Codi As Double, botiga As Double, desde As Date, hasta As Date) As Double
    JaMirats = ""
    EncarregatsServits_91 = EncarregatsServitsFaltan_91(Codi, botiga, desde, hasta)
End Function
Function EncarregatsServits_V2(Codi As Double, botiga As Double, desde As Date, hasta As Date) As Double
    JaMirats = ""
    EncarregatsServits_V2 = EncarregatsServitsFaltan_V2(Codi, botiga, desde, hasta)
End Function


Function PedidoCuantosFaltanDevolucion(Codi As Double, botiga As Double, desde As Date, hasta As Date) As Double
    Dim rs As rdoResultset, UltimaVenta As Date, Sortides

    JaMirats = ""
    PedidoCuantosFaltanDevolucion = PedidoCalculaDevol(Codi, botiga, desde, hasta)
End Function
Function PedidoCuantosFaltanDevolucion_91(Codi As Double, botiga As Double, desde As Date, hasta As Date) As Double
    JaMirats = ""
    PedidoCuantosFaltanDevolucion_91 = PedidoCalculaDevol_91(Codi, botiga, desde, hasta)
End Function

Function PedidoCuantosFaltanDevolucion_V2(Codi As Double, botiga As Double, desde As Date, hasta As Date) As Double
    JaMirats = ""
    PedidoCuantosFaltanDevolucion_V2 = PedidoCalculaDevol_V2(Codi, botiga, desde, hasta)
End Function


Sub PintaBlock(Total, CcBotiga, fecha, nBotiga, nAsiento, nBase, depNom, DepImport)
    AsientoAdd nAsiento, fecha, "43" & Right("0000000" & CcBotiga, 6), "D43" & Right("0000000" & CcBotiga, 6), 0, "ventas contado", Total, 0, 0, 0, 0, ""
End Sub

Sub guardaFile(Str As String, Propietario As String, nombre, DESCRIPCIoN, Extension)
    Dim rs As ADODB.Recordset, Nom1 As String, Nom2 As String, iD As String
    Dim Rrs As rdoResultset
    Dim s() As Byte
    
    Set Rrs = Db.OpenResultset("select newid() as a")
    iD = Rrs("a")
    
On Error Resume Next
db2.Close
On Error GoTo 0
   
   Set db2 = New ADODB.Connection
   db2.Open "WSID=" & db2MyId & ";UID=" & db2User & ";PWD=" & db2Psw & ";Database=" & db2NomDb & ";Server=" & db2Server & ";Driver={SQL Server};DSN='';"
    
    Set rs = rec("select top 1 * from " & tablaArchivo() & " ", True)
    rs.AddNew
    rs("id").Value = iD
  
    rs("nombre").Value = nombre
    rs("descripcion").Value = DESCRIPCIoN
    rs("extension").Value = Extension
    rs("mime").Value = "text/plain"
    rs("propietario").Value = Propietario
    s = Str
    rs("archivo").Value = s
    rs("fecha").Value = Now
    rs("tmp").Value = 0
    rs("down").Value = 1
    rs.Update
    rs.Close

End Sub

Sub PintaDetallIvaRebudes(numAsiento, CodiEmpressa, clientCodi, dataFactura, debe, BaseIva, numFactura, tipoIva, nCuenta, haber)
    Dim DebePts, haberPts, baseIvaPts, datos, clientNom, tmp
    
'    If Debe < 0 Then
'         tmp = Haber
'         Haber = Debe * -1
'         Debe = tmp
'    End If
    
'    If Haber < 0 Then
'         tmp = Debe
'         Debe = Haber * -1
'         Haber = tmp
'    End If
    
    debe = Round(debe, 2)
    DebePts = 0 ' Round((Debe * 166.386), 2)

    haber = Round(haber, 2)
    haberPts = 0 ' Round((Haber * 166.386), 2)

    BaseIva = Round(BaseIva, 2)
    baseIvaPts = 0 'Round((BaseIva * 166.386), 2)
    
    If nCuenta = 0 Then nCuenta = "60000000"
    
    AsientoAdd numAsiento, dataFactura, nCuenta, codiContableProveedor(clientCodi), numFactura, Left("S/F " & numFactura & clientNom & Space(25), 25), debe, haber, BaseIva, tipoIva, 0, ""
    
'    AsientoAddStr Right(Space(6) & numAsiento, 6)                                                      ' Núm. del asiento '000001
'    AsientoAddStr Right("0000" & Year(DataFactura), 4)                                        ' Año '2002
'    AsientoAddStr Right("00" & Month(DataFactura), 2)                                             ' Mes '01
'    AsientoAddStr Right("00" & Day(DataFactura), 2)                                               ' Día '03
'    AsientoAddStr Left(nCuenta & Space(12), 12)                 ' Código de la contrapartida/IVA
'    AsientoAddStr codiContableProveedor(clientCodi)                                                                    ' Cuenta destino '430000000000
'    AsientoAddStr Right(Space(16) & "0.00", 16)                                                        ' Importe Debe Pts
'    AsientoAddStr Left("S/F " & NumFactura & ClientNom & Space(25), 25)                                      ' Concepto del asiento 'DESCRIPCION VENTA
'    AsientoAddStr Right(Space(16) & "0", 16)                                                   ' Importe Haber Pts
'    AsientoAddStr Right(Space(8) & NumFactura, 8)                                         ' Num Factura '00000073'
'    AsientoAddStr Right(Space(16) & baseIvaPts, 16)                                                        ' Base imponible del IVA en Pts
'    AsientoAddStr Right(Space(5) & TipoIva, 5)                                                         ' Porcentage de IVA
'    AsientoAddStr Right(Space(5) & "0.00", 5)                                                          ' Recargo de equivalencia
'    AsientoAddStr Right(Space(10), 10)                                                     ' Número de documento
'    AsientoAddStr Right(Space(3), 3)                                                                   ' Código de departamento
'    AsientoAddStr Right(Space(6), 6)                                                                   ' Código del proyecto
'    AsientoAddStr Right(0 & Space(1), 1)                                                   ' Punteo (interno)
'    AsientoAddStr Right(Space(6) & "0", 6)                                                             ' Númerico de casación (interno)
'    AsientoAddStr Right(Space(1) & "0", 1)                                                             ' Tipo de casado (interno)
'    AsientoAddStr Right(Space(6) & "0", 6)                                                             ' Número de pago
'    AsientoAddStr Right(Space(16) & "0.000000", 16)                                                    ' Cambio a aplicar
'    AsientoAddStr Right(Space(16) & "0.00", 16)                                                        ' Importe debe moneda extranjera
'    AsientoAddStr Right(Space(16) & "0.00", 16)                                                        ' Importe haber moneda extranjera
'    AsientoAddStr Right(Space(1), 1)                                                                   ' Auxiliar (interno)
'    AsientoAddStr Right(Space(1), 1)                                                                   ' Serie de la facturación
'    AsientoAddStr Right(Space(4), 4)                                                                   ' Sucursal (sin uso)
'    AsientoAddStr Right(Space(5), 5)                                                                   ' Código de la divisa
'    AsientoAddStr Right(Space(16) & "0.00", 16)                                                        ' Importe auxiliar moneda extranjera
'    AsientoAddStr Right(Space(1) & "2", 1)                                                             ' Moneda en USo (1-Peseteas, 2-Euros)
'    AsientoAddStr Right(Space(16) & Debe, 16)                                                          ' Importe al debe en euros, en el caso del IVA, siempre ceros
'    AsientoAddStr Right(Space(16) & Haber, 16)                                                         ' Importe al haber en euros
'    AsientoAddStr Right(Space(16) & BaseIva, 16)                                                       ' Base imponible del IVA en Euros
'    AsientoAddStr Right(Space(1) & "F", 1)                                                             ' NoConv (interno)
'    AsientoAddStr Right(Space(10), 10)                                                                 ' Código de Activo
'    AsientoAddStr Right(Space(1), 1)                                                                   ' serie de Factura rectificada
'    AsientoAddStr Right(Space(8) & NumFactura, 8)                                             ' Número factura rectificada
'    AsientoAddStr Right(Space(16) & "0.00", 16)                                                        ' Base imponible factura rectificada
'    AsientoAddStr Right(Space(16) & "0.00", 16)                                                        ' Base imponible factura rectificada
'    AsientoAddStr Right(Space(1) & "F", 1)                                                             ' Factura rectificada (T en caso de factura rectificada)
'    AsientoAddStr Right(Space(4), 4)                                                                   ' Año '2002 FacturaRectificada
'    AsientoAddStr Right(Space(2), 2)                                                                   ' Mes '01   FacturaRectificada
'    AsientoAddStr Right(Space(2), 2)                                                                   ' Día '03   FacturaRectificada
'                                                                                                        ' NIC (' ' Asiento válido solo para P.G.C, 'E' futuras normas NIC)
'    AsientoAddStr Chr(13) & Chr(10)                                                                    ' Fin     ' chr13 + chr10
    
End Sub



Sub ExportaCpVell(empresa As String, data As String, Tipus As String, P4 As String, P5 As String)
    Dim j As Integer, i As Integer, Di As Date, Df As Date, D As Date, K As Integer, TaulaIva As String, TaulaData As String, sqlEmitidas As String, sql As String, nEmpresa As Double, rsCtb As rdoResultset, Archivo As String, tipo As String, desc As String, datos As String, down As Integer, numAsiento As Double, VentaCompra As Double, clientCodi As Double, TaulaRebudes As String, rs As rdoResultset, DataInicial, Td, Th, ImporteDeve, ImporteHaver, Sal, Propietario As String, NumFile As Double, rsBt, Ventas, Descuadres, Cuenta, Taules, PctIva, Base, Quota, VentasNoVila, Motiu, EsB As Boolean, CuentaVentas, Descripcio
    Dim Emitidas As Boolean, Recibidas As Boolean, Num, Otros As Boolean, Moviments As Boolean, sInicials As Boolean, Taulacomptab As String, Nominas, Calaixos
    Dim fecha, fechaAct, cBotiga, cBotigaAct, CcBotiga, CcBotigaAct, nBotiga, Total, tipoIva, strDebe, strIVA, strBase, ReferenciaInterna, FacturaId
    Dim depNom(), DepNomTxt(), DepImport(), DepIvaBase0(), DepIvaQuota0(), DepIvaBase1(), DepIvaQuota1(), DepIvaBase2(), DepIvaQuota2(), DepIvaBase3(), DepIvaQuota3(), nIVA(3), nBase(3), botiga, import, iva1, iva2, iva3, baseIva1, baseIva2, baseIva3, baseIva4, Ccuenta As String, Rs4 As rdoResultset, TeRetencions As Boolean, texte As String, P
    
    If Not frmSplash.Debugant Then On Error GoTo norR

    DonamNomTaulaNorma43
    SousNominaImportats
    
    Descripcio = ""
    NumFile = 1
    Propietario = P5
    EsB = EsUsuariContable(Propietario)
    numAsiento = 1
    DadesExportaCp = ""
    
    nDigitos = 8
    Di = Now
    Df = Now
    
    Emitidas = False
    Recibidas = False
    Moviments = False
    sInicials = False
    Nominas = False
    Calaixos = False
    Ventas = False
    Descuadres = False
    Otros = False
    
    codiContableProveedorTotsOk
    ExecutaComandaSql "CREATE INDEX ccpedidosIndx ON ccpedidos (fecha,MateriaPrima,Almacen)"
    
'    sInicials = True
'    data = "[01/01/2007][31/12/2007]"

    InformaMiss "Exporta Cp " & Di & ".." & Df
    codiContableProveedor 0

    If Car(Tipus) = "on" Then Emitidas = True
    If Car(Tipus) = "on" Then Recibidas = True
    If Car(Tipus) = "on" Then Moviments = True
    If Car(Tipus) = "on" Then sInicials = True
    If Car(Tipus) = "on" Then Nominas = True
    If Car(Tipus) = "on" Then Calaixos = True
    If Car(Tipus) = "on" Then Ventas = True
    If Car(Tipus) = "on" Then Descuadres = True
    If Car(Tipus) = "on" Then Otros = True
    
    Di = Car(data)
    Df = Car(data)
    If Di > Df Then Exit Sub
    If empresa = "" Then empresa = "0"
    nEmpresa = empresa
    Descripcio = " " & EmpresaCodiNom(nEmpresa) & " Desde " & Di & " Hasta " & Df
    nDigitos = DSubcuenta(nEmpresa)
    TaulaIva = NomTaulaFacturaIva(Di)
    TaulaData = NomTaulaFacturaData(Di)
    Taulacomptab = NomTaulaComptavilitzat(Di)
    
    If Emitidas Then
       InformaMiss "Emitidas", True

       ReDim SQLA(0)
       j = 0
       D = Di
       TaulaIva = NomTaulaFacturaIva(D)
       TaulaData = NomTaulaFacturaData(D)
       Taulacomptab = NomTaulaComptavilitzat(D)
       sqlEmitidas = ""
       While D < Df Or (Year(D) = Year(Df) And Month(D) = Month(Df))
            TaulaIva = NomTaulaFacturaIva(D)
            TaulaData = NomTaulaFacturaData(D)
            Taulacomptab = NomTaulaComptavilitzat(D)
            ReDim Preserve SQLA(j)
            SQLA(j) = "select (case when  charindex('[Retencio]',isnull(tn.reservat,'Directa'))  = 0 then 0 else 1 end) TeRetencio, tn.empresaCodi,tn.idfactura idfactura,tn.dataFactura datafactura,tn.datafactura,tn.clientNom clientNom,tn.clientCodi AS clientCodi,tn.numFactura numFactura,abs(tn.numFactura) nf, isnull(tn.serie,'') serie,isnull(tn.total,0) total, tn.total nnn, tb.total bbb, isnull((tn.total - tb.total),0) total_bo, isnull(tc.comptabilitzat,'NO') comp,'" & TaulaData & "' tablaData "
               For K = 0 To 3
                   SQLA(j) = SQLA(j) & ",(case when tn.numfactura < 0 then 0 else tn.baseIva" & (K + 1) & " end) baseiva" & (K + 1) & ",(case when tn.numfactura < 0 then 0 else tn.iva" & (K + 1) & " end) iva" & (K + 1) & ",(case when tn.numfactura < 0 then 0 else tn.baseRec" & (K + 1) & " end) baserec" & (K + 1) & ",(case when tn.numfactura < 0 then 0 else tn.rec" & (K + 1) & " end) rec" & (K + 1) & ", (case when tn.numfactura < 0 then 0 else tn.ivarec" & (K + 1) & " end) ivarec" & (K + 1)
               Next
               SQLA(j) = SQLA(j) & " from [" & TaulaIva & "] tn left join "
               SQLA(j) = SQLA(j) & "(select idfactura, right(idfactura,38) idfactura2 from  [" & TaulaIva & "]) te on tn.idfactura=te.idfactura left join "
               SQLA(j) = SQLA(j) & "[" & TaulaIva & "] tb on tb.idfactura = te.idfactura2 left join "
               SQLA(j) = SQLA(j) & "[" & Taulacomptab & "] tc on tn.idfactura = tc.id_doc where tn.total<>0 and tn.datafactura between"
               SQLA(j) = SQLA(j) & " convert(datetime,'" & Right("0" & Day(Di), 2) & "/" & Right("0" & Month(Di), 2) & "/" & Right(CStr(Year(Di)), 2) & "',3)"
               SQLA(j) = SQLA(j) & " and convert(datetime,'" & Right("0" & Day(Df), 2) & "/" & Right("0" & Month(Df), 2) & "/" & Right(CStr(Year(Df)), 2) & "',3)"
               SQLA(j) = SQLA(j) & " + convert(datetime,'23:59:59',8)"

'                Contab ?
'                If contab = "SI" Then SQLA(j) = SQLA(j) & " and tc.comptabilitzat = 'SI'"
'                If contab = "NO" Then                SQLA(j) = SQLA(j) & " and tc.comptabilitzat = 'NO' or tc.comptabilitzat is NULL"
                SQLA(j) = SQLA(j) & " and tn.empresaCodi in(" & empresa & ")"
'                sql = sql & " and tn.clientCodi in (" & Client & ")"
                j = j + 1
                D = DateAdd("m", 1, D)
        Wend
        sqlEmitidas = Join(SQLA, " union ") & " order by datafactura,abs(tn.numFactura),clientNom,total_bo"
        
        '*************************************IMPRIMIM
        'LINEA EJEMPLO FORMATO SP
        '1200501012200000                      42289411.00Asiento de Apertura                  0.00       0            0.00 0.00 0.00                         00     0        0.000000            0.00            0.00                       0.002       254164.48            0.00            0.00F                  0            0.00            0.00F
        sql = sqlEmitidas           'Consulta SQL para generar el listado de asientos

        Set rsCtb = Db.OpenResultset(sql)
        Archivo = "Diari"
        tipo = "SP"
        desc = "Moviments diari"
        datos = ""
        down = 0
        VentaCompra = 7
        K = 0
        While Not rsCtb.EOF
            InformaMiss "Emitidas " & rsCtb("dataFactura"), True
            clientCodi = Trim(rsCtb("clientCodi"))
            
            If InStr(rsCtb("numFactura"), "3") > 0 Then
                clientCodi = clientCodi
            End If
            
            If (rsCtb("numFactura") > 0) Then
                If clientCodi = 0 Then clientCodi = BuscaclientCodi(rsCtb("clientNom"))
                If 0 = Round(rsCtb("Iva1"), 2) + Round(rsCtb("Iva2"), 2) + Round(rsCtb("Iva3"), 2) + Round(rsCtb("baseIva1"), 2) + Round(rsCtb("baseIva2"), 2) + Round(rsCtb("baseIva3"), 2) + rsCtb("Rec1") + rsCtb("Rec2") + rsCtb("Rec3") + rsCtb("BaseRec1") + rsCtb("BaseRec2") + rsCtb("BaseRec3") Then
                    ExportaSensaIva numAsiento, rsCtb("dataFactura"), clientCodi, rsCtb("numFactura"), Round(rsCtb("Total"), 2), rsCtb("TeRetencio")
                Else
                    ExportaAmbIva numAsiento, rsCtb("dataFactura"), clientCodi, rsCtb("numFactura"), Round(rsCtb("Iva1"), 2), Round(rsCtb("Iva2"), 2), Round(rsCtb("Iva3"), 2), Round(rsCtb("baseIva1"), 2), Round(rsCtb("baseIva2"), 2), Round(rsCtb("baseIva3"), 2), 0, 0, 0, rsCtb("Rec1"), rsCtb("Rec2"), rsCtb("Rec3"), rsCtb("BaseRec1"), rsCtb("BaseRec2"), rsCtb("BaseRec3"), rsCtb("clientCodi"), rsCtb("TeRetencio"), ""
                End If
                
            Else
                If Not EsB Then ExportaSensaIva numAsiento, rsCtb("dataFactura"), clientCodi, rsCtb("numFactura"), Round(rsCtb("Total"), 2), False
            End If
            numAsiento = numAsiento + 1
            DoEvents
            rsCtb.MoveNext
            
        Wend
        rsCtb.Close
    End If
    
    If Recibidas Then
        InformaMiss "Recividas", True
        D = Di
        TaulaIva = NomTaulaFacturaIva(D)
        TaulaData = NomTaulaFacturaData(D)
        Taulacomptab = NomTaulaComptavilitzat(D)
        i = 0
        j = 0
        TaulaRebudes = tablaFacturaProforma(D)
        ExecutaComandaSql "Drop table TraspasTmp "
        sql = "select tn.empresaCodi, tn.idfactura idfactura, tn.dataFactura datafactura, "
        sql = sql & "tn.empNom clientNom, tn.empresaCodi clientCodi, "
        sql = sql & "tn.numFactura numFactura,isnull(tn.serie,'') serie, isnull(tn.total,0) total, "
        sql = sql & " tn.total nnn, isnull(tn.total,0) total_bo, isnull(tc.comptabilitzat,'NO') comp, '" & Taulacomptab & "' tablaData, "
        sql = sql & "isnull(p.NumFacturacion, '') numfacturacion, isnull(p.contra4,'60000000') contra4, isnull(p.contra7,'60000000') contra7, isnull(p.contra16,'60000000') contra16, "
        sql = sql & "isnull(p.direccion,'') direccion, isnull(p.ciudad,'') ciudad, isnull(p.nif, '') nif, "
        sql = sql & "isnull(p.cc,40000000+p.codi) cc, isnull(p.email,'') email, isnull(p.fax,'') fax, isnull(p.tlf1, '') tlf1 "
        For K = 0 To 3
            sql = sql & ",tn.baseIva" & (K + 1) & ", tn.iva" & (K + 1) & ",tn.baseRec" & (K + 1) & ",tn.rec" & (K + 1) & ", tn.ivarec" & (K + 1)
        Next
        sql = sql & " Into TraspasTmp from [" & TaulaRebudes & "] tn "
        sql = sql & " left join [" & Taulacomptab & "] tc on tn.idfactura = tc.id_doc "
        sql = sql & " left join (select idfactura, right(idfactura,38) idfactura2 from [" & TaulaRebudes & "]) te on tn.idfactura=te.idfactura "
        sql = sql & " left join ccproveedores p on p.id=tn.Empresacodi "
        sql = sql & " where tn.total<>0 and tn.datafactura between"
        sql = sql & " convert(datetime,'" & Right("0" & Day(Di), 2) & "/" & Right("0" & Month(Di), 2) & "/" & Right(CStr(Year(Di)), 2) & "',3)"
        sql = sql & " and convert(datetime,'" & Right("0" & Day(Df), 2) & "/" & Right("0" & Month(Df), 2) & "/" & Right(CStr(Year(Df)), 2) & "',3)"
        sql = sql & " + convert(datetime,'23:59:59',8) "
        sql = sql & " and isnull(tn.clientCodi,0) = " & empresa
'        Sql = Sql & " and numfactura='7' "
        ExecutaComandaSql sql
        
        Set rsCtb = Db.OpenResultset("Select * from TraspasTmp order by dataFactura ")
        
        Archivo = "Diari"
        tipo = "SP"
        desc = "Moviments diari"
        datos = ""
        down = 0
        VentaCompra = 6

        While Not rsCtb.EOF
If InStr(rsCtb("numFactura"), "426") > 0 Then
iva1 = iva1
End If
            InformaMiss "Recibidas " & rsCtb("dataFactura"), True
            iva1 = Round(rsCtb("Iva1"), 2)
            iva2 = Round(rsCtb("Iva2"), 2)
            iva3 = Round(rsCtb("Iva3"), 2)
            baseIva1 = Round(rsCtb("baseIva1"), 2)
            baseIva2 = Round(rsCtb("baseIva2"), 2)
            baseIva3 = Round(rsCtb("baseIva3"), 2)
            baseIva4 = Round(rsCtb("baseIva4"), 2)
            TeRetencions = False
                        
            If (rsCtb("numFactura") <> "") Then
               ExportaAmbIvaRebudes numAsiento, rsCtb("dataFactura"), rsCtb("clientCodi"), rsCtb("numFactura"), Round(rsCtb("Total"), 2), Round(rsCtb("Iva1"), 2), Round(rsCtb("Iva2"), 2), Round(rsCtb("Iva3"), 2), Round(rsCtb("baseIva1"), 2), Round(rsCtb("baseIva2"), 2), Round(rsCtb("baseIva3"), 2), Round(rsCtb("IvaRec4"), 2), rsCtb("idfactura")
            End If
            
            numAsiento = numAsiento + 1
            DoEvents
            rsCtb.MoveNext
        Wend
        rsCtb.Close
    End If
    
    If sInicials Then SaldosInicials nEmpresa, Di, numAsiento
    
    If Moviments Then
        InformaMiss "Moviments", True
        D = Di
        i = 0
        j = 0
        Dim ImportReal
        sql = " select * from " & DonamNomTaulaNorma43Conta & " c "
        sql = sql & " join norma43 n on c.idnorma43 = n.idnorma43 "
        sql = sql & " where not c.idnorma43 like '%|%' "
        sql = sql & " And DataOperacio <= '" & Format(Df, "yymmdd") & "' and DataOperacio >= '" & Format(Di, "yymmdd") & "' "
'        If nEmpresa > 0 Then If Empresa <> "" Then SQLA(j) = SQLA(j) & " and tn.empresaCodi in(" & Empresa & ")"
        sql = sql & " And  (Concepto in ('FECHA','SUBCUENTA','ReferenciaInterna','DESCRIPCIÓN','FacturaId','CONCEPTO','DEBE','HABER')) "
'        Sql = Sql & " And  c.idnorma43 = 'BD256AE0-1408-4FD3-B52F-DE8AE28384E9' "

        sql = sql & " order by hit_datavalor,c.idnorma43,orden "
        
        ExecutaComandaSql "CREATE INDEX Norma43Conta_idnorma43 ON Norma43Conta (idnorma43)"
        ExecutaComandaSql "CREATE INDEX Norma43Conta_Concepto ON Norma43Conta (Concepto)"
        ExecutaComandaSql "CREATE INDEX Norma43Conta_orden ON Norma43Conta (orden)"
        
        ExecutaComandaSql "CREATE INDEX norma43_datavalor ON norma43 (hit_datavalor)"
        ExecutaComandaSql "CREATE INDEX norma43_DataOperacio ON norma43 (DataOperacio)"
        ExecutaComandaSql "CREATE INDEX norma43_idnorma43 ON norma43 (idnorma43)"
        
        Set rsCtb = Db.OpenResultset(sql)
        Dim iD, Cuenta1, Cuenta2, Deve, Haver, acd, Ach, DadesExportaCpFinsAra
        If Not rsCtb.EOF Then iD = rsCtb("IdNorma43")
        Num = -1
        acd = 0
        Ach = 0
        
        DadesExportaCpFinsAra = DadesExportaCp
        While Not rsCtb.EOF
            If InStr(rsCtb("valor"), "Efectivo Hit") > 0 Then
                Num = Num
            End If
            If Not (iD = rsCtb("IdNorma43") And Num = rsCtb("Orden")) Then
                If Not Num = -1 Then
                   MyAsientoAdd numAsiento, fecha, Cuenta1, Descripcio, Deve, Haver, FacturaId, texte, ReferenciaInterna
                End If
                If iD = rsCtb("IdNorma43") Then
                   Cuenta1 = ""
                Else
                   If Abs(acd - Ach) > 0.001 Then
                        DadesExportaCp = DadesExportaCpFinsAra
                   Else
                        DadesExportaCp = DadesExportaCp
                   End If
                   acd = 0
                   Ach = 0
                   Cuenta1 = 0
                   DadesExportaCpFinsAra = DadesExportaCp
                   numAsiento = numAsiento + 1
                End If
                iD = rsCtb("IdNorma43")
                Num = rsCtb("Orden")
                fecha = 0
                Descripcio = 0
                Deve = 0
                Haver = 0
                ReferenciaInterna = ""
                FacturaId = ""
            End If
            
            Select Case rsCtb("concepto")
                Case "FECHA"
                        fecha = rsCtb("Valor")
                Case "SUBCUENTA"
                    If ReferenciaInterna = "" Then
                       If Cuenta1 = "" Or Cuenta1 = "0" Or Cuenta1 = 0 Then
                            Cuenta1 = BancoNumConta(rsCtb("IdNorma43"), rsCtb("Valor"))
                       End If
                    End If
                Case "ReferenciaInterna"
                    ReferenciaInterna = rsCtb("valor")
                    If Len(ReferenciaInterna) > 5 Then
                        Cuenta1 = codiContableProveedor(ReferenciaInterna)
                    Else
                        Cuenta1 = codiContable(ReferenciaInterna)
                    End If
                Case "DESCRIPCIÓN"
                    If (Descripcio = "" Or Descripcio = 0) Then Descripcio = rsCtb("Valor")
                Case "FacturaId"
                    If Not rsCtb("Valor") = "Pendiente" Then
                        If (FacturaId = "" Or FacturaId = 0) Then
                            FacturaId = rsCtb("Valor")
                            If Len(FacturaId) > 5 And InStr(FacturaId, "|") = 0 Then
                                Cuenta1 = codiContableFacturaProveedor(FacturaId, fecha, ReferenciaInterna)
                            Else
                                'Cuenta1 = codiContable(FacturaId)
                            End If
                        End If
                    End If
                Case "CONCEPTO"
                    texte = rsCtb("Valor")
                    If (Descripcio = "" Or Descripcio = 0) Then Descripcio = rsCtb("Valor")
                Case "DEBE"
                    ImportReal = rsCtb("hit_importe")
                    If Not rsCtb("Valor") = "" Then Deve = Round(rsCtb("Valor"), 2)
                    If Deve = "" Then Deve = "0"
                    acd = acd + CDbl(Deve)
                Case "HABER"
                    If Not rsCtb("Valor") = "" Then Haver = Round(rsCtb("Valor"), 2)
                    If Haver = "" Then Haver = "0"
                    Ach = Ach + CDbl(Haver)
            End Select
            
            InformaMiss "Moviments " & numAsiento & "  " & fecha, True
            DoEvents
            rsCtb.MoveNext
        Wend
        rsCtb.Close
        If Not Num = -1 Then
            MyAsientoAdd numAsiento, fecha, Cuenta1, Descripcio, Deve, Haver, FacturaId, texte, ReferenciaInterna
            numAsiento = numAsiento + 1
        End If
        If Abs(acd - Ach) > 0.001 Then DadesExportaCp = DadesExportaCpFinsAra
  
    End If
    
    If Nominas Then
        Dim CntBrut, clauEmpresa
        InformaMiss "Nominas", True
        
        clauEmpresa = ""
        If empresa = 0 Then
            Set rsCtb = Db.OpenResultset("Select Isnull(valor,'') Valor from constantsempresa  where camp = 'CampEnlaceNominas' ")
        Else
            Set rsCtb = Db.OpenResultset("Select Isnull(valor,'') Valor from constantsempresa  where camp = '" & empresa & "_CampEnlaceNominas' ")
        End If
        
        If Not rsCtb.EOF Then clauEmpresa = rsCtb("Valor")
        Set rsCtb = Db.OpenResultset("Select D.nom,dependentesExtes.Id as codi ,data,treb,i_liquid,i_irpf,i_tc1,i_brut,i_ssemp,isnull(RetibEspecie,0) RetibEspecie ,isnull(IrpfEspecies,0) IrpfEspecies from SousNominaImportats join dependentesExtes on SousNominaImportats.Treb = dependentesExtes.Valor And dependentesExtes.nom = 'CODINOMINA' Join Dependentes d on d.codi = dependentesExtes.Id Where Data <= '" & Format(Df, "yyyymmdd") & "' and Data >= '" & Format(Di, "yyyymmdd") & "' And SousNominaImportats.CodiEmpresa = '" & clauEmpresa & "' order by data,treb ")
        Dim DadesExportaCpGran
        DadesExportaCpGran = DadesExportaCp
        DadesExportaCp = ""
        While Not rsCtb.EOF
            Dim Sdata As String
            Dim codiCentre As String
            Sdata = "20070202"
            Sdata = rsCtb("Data")
            
            data = DateSerial(Mid(Sdata, 1, 4), Mid(Sdata, 5, 2), Mid(Sdata, 7, 2))
            codiCentre = CodiCentreTreball(rsCtb("Codi"))
            CntBrut = "6400" & Right("000000", 4 - Len(codiCentre)) + codiCentre
            
'            AsientoAdd numAsiento, Data, CDbl("4650" & Right("000000", 4)) + rsCtb("Codi"), "", 0, "Liquid " & rsCtb("Nom"), 0, Round(rsCtb("i_liquid"), 2), 0, 0
            AsientoAdd numAsiento, data, CDbl("4650" & Right("000000", 4)), "", 0, "Liquid " & rsCtb("Nom"), 0, Round(rsCtb("i_liquid"), 2), 0, 0, 0, ""
            AsientoAdd numAsiento, data, "4751" & Right("000000", 4), "", 0, "Irpf " & rsCtb("Nom"), 0, Round(rsCtb("i_irpf"), 2), 0, 0, 0, ""
            AsientoAdd numAsiento, data, "4751" & Right("000101", 4), "", 0, "Retencion En Especie " & rsCtb("Nom"), 0, Round(rsCtb("IrpfEspecies"), 2), 0, 0, 0, ""
            AsientoAdd numAsiento, data, "4751" & Right("000101", 4), "", 0, "P. Especie " & rsCtb("Nom"), 0, Round(rsCtb("RetibEspecie"), 2), 0, 0, 0, ""
            AsientoAdd numAsiento, data, "4760" & Right("000000", 4), "", 0, "Tc1 " & rsCtb("Nom"), 0, Round(rsCtb("i_tc1"), 2), 0, 0, 0, ""

'            AsientoAdd numAsiento, data, "4760" & Right("000000", 4), "", 0, "RetEmp " & rsCtb("Nom"), 0, -Round(rsCtb("i_tc1") - rsCtb("i_ssemp"), 2), 0, 0
            AsientoAdd numAsiento, data, CntBrut, "", 0, "Brut " & rsCtb("Nom"), Round(rsCtb("i_brut"), 2), 0, 0, 0, 0, ""
            AsientoAdd numAsiento, data, "6420" & Right("000000", 4 - Len(codiCentre)) + codiCentre, "", 0, "Ssemp " & rsCtb("Nom"), Round(rsCtb("i_tc1") - rsCtb("i_ssemp"), 2), 0, 0, 0, 0, ""
            
            numAsiento = numAsiento + 1
            InformaMiss "Nominas " & numAsiento, True
            DoEvents
            rsCtb.MoveNext
        Wend
        rsCtb.Close
        DadesExportaCp = DadesExportaCpGran & DadesExportaCp
    End If

    If VentasNoVila Then
        InformaMiss "Ventas", True
        Set rsBt = Db.OpenResultset("Select distinct valor1 from ParamsHw ")
        While Not rsBt.EOF
            j = 0
            D = Di
            While D < Df Or (Year(D) = Year(Df) And Month(D) = Month(Df))
                Taules = "select Botiga,Day(data) as Dia,month(data) as Mes,Year(data) as Ano,0 as part , sum(import) as Tot , plu From [" & NomTaulaVentas(D) & "]  "
                Taules = Taules & "where botiga in(Select distinct valor1 from ParamsHw ) "  ' and data between convert(datetime,'" & Day(Di) & "/" & Month(Di) & "/" & Year(Di) & "',3)  and convert(datetime,'" & Day(Df) & "/" & Month(Df) & "/" & Year(Df) & "',3)+convert(datetime,'23:59:59',8)
                Taules = Taules & "group by Botiga,Day(data) ,month(data),Year(data) ,Plu "

            
                sql = "select ff.pare as depa,left(isnull(ff.pare,'CAP'),charindex(' ',isnull(ff.pare,'CAP'))) As Departamento,k.dia,k.mes,k.ano,a.tipoiva ,Sum(k.tot) - Sum(k.Part) as import,k.botiga cod,c.nom botiga,cc.valor "
                sql = sql & "from (" & Taules & ") k  "
                sql = sql & "left join (select familia,codi,TipoIva from articles_zombis where codi not in (select codi from Articles) union select familia,codi,TipoIva from Articles ) a on k.Plu = a.codi "
                sql = sql & "left join clients c on c.codi = k.botiga  "
                sql = sql & "left join constantsclient cc On cc.codi = c.codi and cc.variable = 'CodiContable'  "
                sql = sql & "left join Families F On f.nom = a.Familia  "
                sql = sql & "left join Families Ff On Ff.nom = f.pare  "
                sql = sql & "Group by c.nom,k.botiga,cc.valor,ano,mes,dia,left(isnull(ff.pare,'CAP'),charindex(' ',isnull(ff.pare,'CAP'))),TipoIva,ff.pare  "
                sql = sql & "Having abs(Sum(k.tot) - Sum(k.Part)) > 0.001 "
                sql = sql & "Order by c.nom,k.botiga,cc.valor,ano,mes,dia,Departamento,TipoIva  "
                
                Set rsCtb = Db.OpenResultset(sql)
                cBotigaAct = ""
                fechaAct = ""
                While Not rsCtb.EOF
                    fechaAct = DateSerial(rsCtb("ano"), rsCtb("mes"), rsCtb("dia"))
                    cBotigaAct = rsCtb("Cod")
                    CcBotigaAct = rsCtb("botiga")
                    If cBotiga <> cBotigaAct Or fecha <> fechaAct Then
                        fecha = fechaAct
                        cBotiga = cBotigaAct
                        CcBotiga = CcBotigaAct
                        numAsiento = numAsiento + 1
                        Total = 0
                        tipoIva = ""
                        strDebe = ""
                        strIVA = ""
                        strBase = ""
                        i = 0
                        For i = 0 To 2
                            nIVA(i) = 0
                            nBase(i) = 0
                        Next
                        ReDim depNom(0)
                        ReDim DepNomTxt(0)
                        ReDim DepImport(0)
                        ReDim DepIvaBase0(0)
                        ReDim DepIvaQuota0(0)
                        ReDim DepIvaBase1(0)
                        ReDim DepIvaQuota1(0)
                        ReDim DepIvaBase2(0)
                        ReDim DepIvaQuota2(0)
                        ReDim DepIvaBase3(0)
                        ReDim DepIvaQuota3(0)
                        depNom(0) = "NOUTILITZAT"
                    End If
                    
'                    TipoIva = iva(CInt(rsCtb("TipoIva")) - 1)
                    'Import = CDbl(Rs("import"))  'ESTE IMPORTE ES CON IVA!!
'                    posIVA = 0
'                    If TipoIva = "4" Then posIVA = 0 Else If TipoIva = "7" Then posIVA = 1 Else If TipoIva = "16" Then posIVA = 2
            
'            If CalSumar Then
'                posIVA = 0
'                Base = Import
'                quota = 0
'            Else
'                Base = Round(Import / (1 + (TipoIva / 100)), 2)
'                quota = Import - Base
'            End If
'            nBase(posIVA) = nBase(posIVA) + Base
'            nIVA(posIVA) = nIVA(posIVA) + quota
'
'            Total = Total + Base + quota
'            Departamento = 0
'            If Not IsNull(Rs("Departamento")) Then If IsNumeric(Rs("Departamento")) Then Departamento = Rs("Departamento")
'            Departamento = Rs("Departamento")
'            depa = "General "
'            If InStr(Rs("Depa"), " ") > 1 Then
'                depa = Right(Rs("Depa"), Len(Rs("Depa")) - InStr(Rs("Depa"), " "))
'            End If
'
'            For i = 0 To UBound(DepNom)
'                If DepNom(i) = Departamento Then Exit For
'            Next
'            If DepNom(0) = "NOUTILITZAT" Then i = 0
'
'            If i > UBound(DepNom) Then
'                i = UBound(DepNom) + 1
'                ReDim Preserve DepNom(i)
'                ReDim Preserve DepNomTxt(i)
'                ReDim Preserve DepImport(i)
'                ReDim Preserve DepIvaBase0(i)
'                ReDim Preserve DepIvaQuota0(i)
'                ReDim Preserve DepIvaBase1(i)
'                ReDim Preserve DepIvaQuota1(i)
'                ReDim Preserve DepIvaBase2(i)
'                ReDim Preserve DepIvaQuota2(i)
'                ReDim Preserve DepIvaBase3(i)
'                ReDim Preserve DepIvaQuota3(i)
'            End If
'
'            DepNom(i) = Departamento
'            DepNomTxt(i) = depa
'            DepImport(i) = DepImport(i) + Base
'
'            If posIVA = 0 Then
'                DepIvaBase0(i) = DepIvaBase0(i) + Base
'                DepIvaQuota0(i) = DepIvaQuota0(i) + quota
'            End If
'            If posIVA = 1 Then
'                DepIvaBase1(i) = DepIvaBase1(i) + Base
'                DepIvaQuota1(i) = DepIvaQuota1(i) + quota
'            End If
'            If posIVA = 2 Then
'                DepIvaBase2(i) = DepIvaBase2(i) + Base
'                DepIvaQuota2(i) = DepIvaQuota2(i) + quota
'            End If
'
'            strIVA = strIVA & "H477" & Right("000000" & TipoIva, 6) & Space(21) & Mid(fecha, 3, 2) & Right(Space(5) & nAsiento, 5) & Space(7) & Left("ventas contado" & Space(25), 25) & fecha & Right(Space(21) & FormatNumber(nIVA(posIVA), 2, , , 0), 21) & "  0  0       TP                                                         0    0    0                0                0            0    0    0    0                0                0            0    0    0    0                0                0            0                                     " & Chr(13) & Chr(10)
'            strBase = strBase & "H7" & Right("00000000" & Trim(Departamento), 8) & Space(21) & Mid(fecha, 3, 2) & Right(Space(5) & nAsiento, 5) & Space(7) & Left("ventas contado" & Space(25), 25) & fecha & Right(Space(21) & FormatNumber(nBase(posIVA), 2, , , 0), 21) & "  0  0       TP                                                         0    0    0                0                0            0    0    0    0                0                0            0    0    0    0                0                0            0                                     " & Chr(13) & Chr(10)
'
'                    If nBase(0) > 0 Then
'                        AsientoAdd numAsiento, fecha, "D43" & Right("0000000" & CcBotiga, 7), "", 0, Descripcio, Deve, Haver, 0, 0
'                        AsientoAdd numAsiento, fecha, "H477" & Right("000000" & 7, 6), "", 0, Descripcio, Deve, Haver, 0, 0
'                    End If
'                    For i = 0 To UBound(DepNom)
'                        response.Write "H7" & Right("00000000" & Trim(DepNom(i)), 8) & Space(21) & Mid(fecha, 3, 2) & Right(Space(5) & numAsiento, 5) & Space(7) & Left("Ventas " & DepNomTxt(i) & Space(25), 25) & fecha & Right(Space(21) & FormatNumber(DepImport(i), 2, , , 0), 21) & "  0  0       TP                                                     "
'                    Next
                    numAsiento = numAsiento + 1
'                    response.Write "H43" & Right("0000000" & CcBotiga, 7) & Space(21) & Mid(fecha, 3, 2) & Right(Space(5) & numAsiento, 5) & Space(7) & Left("Pago contado" & Space(25), 25) & fecha & Right(Space(21) & FormatNumber(Total, 2, , , 0), 21) & "  0  0       TP  " & Right(Space(5) & numAsiento, 5) & "H43" & Right("0000000" & CcBotiga, 7) & Right(Space(25) & nBotiga, 25) & Space(11)
'                    response.Write "D57" & Right("0000000" & 0, 7) & Space(21) & Mid(fecha, 3, 2) & Right(Space(5) & numAsiento, 5) & Space(7) & Left("Cobro contado" & Space(25), 25) & fecha & Right(Space(21) & FormatNumber(Total, 2, , , 0), 21) & "  0  0       TP  " & Right(Space(5) & numAsiento, 5) & "D57" & Right("0000000" & 0, 7) & Right(Space(25) & nBotiga, 25) & Space(11)
                    numAsiento = numAsiento + 1
                    InformaMiss "Ventas" & numAsiento, True
                    DoEvents
                    rsCtb.MoveNext
                Wend
                rsCtb.Close
                D = DateAdd("m", 1, D)
            Wend
            DoEvents
            rsBt.MoveNext
        Wend
    End If

    If Ventas Then
        InformaMiss "Ventas", True
        j = 0
        D = Di
        While D < Df Or (Year(D) = Year(Df) And Month(D) = Month(Df))
        
            sql = "Select a.tipoiva,v.botiga,sum(v.import) as import  from (select Botiga,Plu,sum(import) Import from [" & NomTaulaVentasAoB(D, EsB) & "] group by botiga,plu) v Left Join (select codi,tipoiva from articles  union select codi,tipoiva from articles_zombis ) a on a.codi  = v.plu "
            sql = sql & " where botiga in(select Codi  from constantsclient where variable = 'EmpresaVendes' and valor = " & empresa & ") "
            
            sql = sql & " group by botiga,tipoiva  "
            Set rsCtb = Db.OpenResultset(sql)
            
            While Not rsCtb.EOF
                fecha = DateSerial(Year(D), Month(D), Day(DateAdd("d", -1, DateSerial(Year(DateAdd("m", 1, D)), Month(DateAdd("m", 1, D)), 1))))
                botiga = rsCtb("botiga")
                import = rsCtb("Import")
                tipoIva = rsCtb("TipoIva")
                InformaMiss "Exporta Ventas  " & fecha & " Botiga " & BotigaCodiNom(botiga), True
                Select Case tipoIva
                    Case 1: PctIva = 4
                    Case 2: PctIva = 7
                    Case 3: PctIva = 16
                End Select
                Base = Round(import / (1 + (PctIva / 100)), 2)
                Quota = Round(import - Base, 2)
                import = Base + Quota
                CuentaVentas = cVentaMercaderies(rsCtb("botiga"), False)
                
                AsientoAdd numAsiento, fecha, cVentaMercaderies(rsCtb("botiga"), False), cVentaMercaderies(rsCtb("botiga"), False), botiga * 1000 + Month(fecha), "Ventas Botiga " & BotigaCodiNom(botiga), 0, Base, Base, PctIva, 0, ""
                AsientoAdd numAsiento, fecha, ("477" & Right("000000000000", nDigitos - 3)) + PctIva, CuentaVentas, botiga * 1000 + Month(fecha), "Ventas Botiga " & BotigaCodiNom(botiga), 0, Quota, Base, PctIva, 0, ""
                AsientoAdd numAsiento, fecha, ("57" & Right("000000000000", nDigitos - 2)) + botiga, CuentaVentas, botiga * 1000 + Month(fecha), "Ventas Botiga " & BotigaCodiNom(botiga), import, 0, 0, 0, 0, ""
                
                numAsiento = numAsiento + 1
                InformaMiss "Ventas " & D, True
                DoEvents
                rsCtb.MoveNext
            Wend
            rsCtb.Close
            D = DateAdd("m", 1, D)
        Wend
    End If

    If Otros And ExisteixTaula("MovimentsExtres2007") Then
        InformaMiss "Otros ", True
        Set rs = Db.OpenResultset("SELECT * From MovimentsExtres2007 order by movi")
        Dim Movi
        Movi = ""
        While Not rs.EOF
            data = DateSerial(Mid(Right(rs("Data"), 8), 1, 4), Mid(Right(rs("Data"), 8), 5, 2), Mid(Right(rs("Data"), 8), 7, 2))
            If Not Movi = rs("Movi") And Not Movi = "" Then numAsiento = numAsiento + 1
            Movi = rs("Movi")
            Dim Partidadeve, PartidaHaver, concepto
            Partidadeve = ""
            
            PartidaHaver = ""
            concepto = ""
            Deve = 0
            Haver = 0
            If Not IsNull(rs("Partidadebe")) Then
                Partidadeve = rs("Partidadebe")
                concepto = rs("Concepto")
                Deve = rs("ImporteDebe")
            End If
            
            If Not IsNull(rs("PartidaHaber")) Then
                Partidadeve = rs("PartidaHaber")
                concepto = rs("Concepto")
                Haver = rs("importeHaver ")
            End If
            
            AsientoAdd numAsiento, data, Partidadeve, PartidaHaver, 0, concepto, Deve, Haver, 0, 0, 0, ""
            
            rs.MoveNext
        Wend
    End If
    
    If Calaixos Then
        InformaMiss "Calaixos ", True
        Set rs = Db.OpenResultset("SELECT c.Codi,cc.Valor FROM ConstantsClient cc join clients c on c.codi = cc.codi WHERE   variable = 'EsCalaix' ")
        While Not rs.EOF
            If Not IsNull(rs("Valor")) Then If rs("Valor") = "EsCalaix" Then ExportaCalaixosJustificats Di, Df, numAsiento, rs("Codi"), EsB
            rs.MoveNext
        Wend
    End If

    If Descuadres Then
        InformaMiss "Descuadres ", True
        j = 0
        D = Di
        While D < Df Or (Year(D) = Year(Df) And Month(D) = Month(Df))
            fecha = DateSerial(Year(D), Month(D), Day(DateAdd("d", -1, DateSerial(Year(DateAdd("m", 1, D)), Month(DateAdd("m", 1, D)), 1))))
            sql = "Select botiga,sum(import) as import  from [" & NomTaulaMovi(D) & "]  where tipus_moviment = 'J'  "
            If empresa = "0" Or empresa = "" Then
                sql = sql & " And not botiga in(select distinct valor from constantsempresa where camp = '_CampCliente') "
            Else
                sql = sql & " And botiga in(select distinct valor from constantsempresa where camp = '" & empresa & "_CampCliente') "
            End If
            sql = sql & "Group By botiga"
            
            Set rsCtb = Db.OpenResultset(sql)
            While Not rsCtb.EOF
                botiga = rsCtb("botiga")
                import = rsCtb("Import")
                Motiu = "Descuadre " & BotigaCodiNom(botiga)
                AsientoAdd numAsiento, fecha, "62990000" + botiga, "", 0, Motiu & " " & BotigaCodiNom(botiga), import, 0, 0, 0, 0, ""
                AsientoAdd numAsiento, fecha, "57000000", "", 0, Motiu & " " & BotigaCodiNom(botiga), 0, import, 0, 0, 0, ""
                numAsiento = numAsiento + 1
                InformaMiss "Calaixos " & D, True
                DoEvents
                rsCtb.MoveNext
            Wend
            rsCtb.Close
            
            
            sql = "select botiga ,sum(Wi-w) Import from ( "
            sql = sql & "Select "
            sql = sql & "case tipus_moviment when 'W' then sum(import) else 0 end  w, "
            sql = sql & "case tipus_moviment when 'Wi' then sum(import) else 0 end wi, Botiga "
            sql = sql & "From [" & NomTaulaMovi(D) & "] "
            sql = sql & "where (tipus_moviment = 'W' or tipus_moviment = 'Wi') "
            If empresa = "0" Or empresa = "" Then
                sql = sql & " And not botiga in(select distinct valor from constantsempresa where camp = '_CampCliente') "
            Else
                sql = sql & " And botiga in(select distinct valor from constantsempresa where camp = '" & empresa & "_CampCliente') "
            End If
            sql = sql & "Group By botiga,tipus_moviment "
            sql = sql & ") a group by botiga "
            
            Set rsCtb = Db.OpenResultset(sql)
            While Not rsCtb.EOF
                botiga = rsCtb("botiga")
                import = rsCtb("Import")
                Motiu = "Dif. Canvis " & BotigaCodiNom(botiga)
                AsientoAdd numAsiento, fecha, "62990000" + botiga, "", 0, Motiu & " " & BotigaCodiNom(botiga), import, 0, 0, 0, 0, ""
                AsientoAdd numAsiento, fecha, "57000000", "", 0, Motiu & " " & BotigaCodiNom(botiga), 0, import, 0, 0, 0, ""
                numAsiento = numAsiento + 1
                InformaMiss "Calaixos " & D, True
                DoEvents
                rsCtb.MoveNext
            Wend
            rsCtb.Close
            
            D = DateAdd("m", 1, D)
        Wend
    End If
    
    InformaMiss "Guardando " & numAsiento, True
    If Len(DadesExportaCp) > 0 Then guardaFile DadesExportaCp, "ContaPlus", "Xdiario", Now & " " & Descripcio, "Txt"
    InformaMiss "", True
    
    Exit Sub
norR:
Debug.Print "error"
Resume Next
End Sub


Sub ExportaCp(empresa As String, data As String, Tipus As String, P4 As String, P5 As String, Optional idCalcul As String)
'    If Year(data) >= 2009 Then
        ExportaContabilitat empresa, data, Tipus, P4, P5, idCalcul
'    Else
'        ExportaCpVell Empresa, data, Tipus, P4, P5
'    End If
End Sub



Private Sub SaldosInicials(nEmpresa As Double, DataInicial As Date, numAsiento As Double)
    Dim rs As rdoResultset, Th, Td, ImporteDeve, ImporteHaver, Sal, Cuenta
    Dim Saldos()   As String
    
    Set rs = Db.OpenResultset("select nombre,saldo,cuenta from ccCuentas Where not (Saldo = '0' or saldo = '' ) order by saldo desc")

    numAsiento = numAsiento + 1
    Th = 0
    Td = 0
    While Not rs.EOF
        ImporteDeve = 0
        ImporteHaver = 0
        If IsNumeric(rs("Saldo")) And nEmpresa = 0 Then
            Sal = Round(CDbl(rs("Saldo")) * 100) / 100
            If CDbl(rs("Saldo")) > 0 Then
                ImporteDeve = Sal
            Else
               ImporteHaver = Sal * -1
            End If
        Else
            Saldos = Split(rs("Saldo"), "|")
            Dim i
            For i = 0 To UBound(Saldos)
                If Split(Saldos(i), "_")(0) = nEmpresa Then
                    Sal = Round(CDbl(Split(Saldos(i), "_")(1)) * 100) / 100
                    If CDbl(Split(Saldos(i), "_")(1)) > 0 Then
                        ImporteDeve = Sal
                    Else
                        ImporteHaver = Sal * -1
                    End If
                End If
            Next
        End If
        If (Abs(ImporteHaver) + Abs(ImporteDeve)) > 0 Then
        
            Th = Th + ImporteHaver
            Td = Td + ImporteDeve
            Cuenta = cccuentasCodiCompte(rs("Cuenta"))
            InformaMiss "Saldo Inicial " & rs("Cuenta"), True
            
            DadesExportaCp = DadesExportaCp & Right(Space(6) & numAsiento, 6)         ' Núm. del asiento '000001
            DadesExportaCp = DadesExportaCp & Right("0000" & Year(DataInicial), 4)    ' Año '2002
            DadesExportaCp = DadesExportaCp & Right("00" & Month(DataInicial), 2)     ' Mes '01
            DadesExportaCp = DadesExportaCp & Right("00" & Day(DataInicial), 2)       ' Día '03
            DadesExportaCp = DadesExportaCp & Left(Cuenta & Space(12), 12)               ' Cuenta destino '430000000000
            DadesExportaCp = DadesExportaCp & Left(Cuenta & Space(12), 12)        ' Cuenta VENTAS
            DadesExportaCp = DadesExportaCp & Right(Space(16), 16)            ' Importe Debe Pts
            DadesExportaCp = DadesExportaCp & Left("Asiento Reapertura " & Space(25), 25)     ' Concepto del asiento 'DESCRIPCION VENTA
            DadesExportaCp = DadesExportaCp & Right(Space(16) & "0.00", 16)      ' Importe Haber Pts
            DadesExportaCp = DadesExportaCp & Right(Space(8), 8)            ' Num Factura '00000073'
            DadesExportaCp = DadesExportaCp & Right(Space(16) & "0.00", 16)      ' Base imponible del IVA en Pts
            DadesExportaCp = DadesExportaCp & Right(Space(5) & "0.00", 5)      ' Porcentage de IVA
            DadesExportaCp = DadesExportaCp & Right(Space(5) & "0.00", 5)      ' Recargo de equivalencia
            DadesExportaCp = DadesExportaCp & Right(Space(10) & numAsiento, 10)       ' Número de documento
            DadesExportaCp = DadesExportaCp & Right(Space(3), 3)            ' Código de departamento
            DadesExportaCp = DadesExportaCp & Right(Space(6), 6)            ' Código del proyecto
            DadesExportaCp = DadesExportaCp & Right(Space(1), 1)            ' Punteo (interno)
            DadesExportaCp = DadesExportaCp & Right(Space(6) & "0", 6)        ' Númerico de casación (interno)
            DadesExportaCp = DadesExportaCp & Right(Space(1) & "0", 1)        ' Tipo de casado (interno)
            DadesExportaCp = DadesExportaCp & Right(Space(6) & "0", 6)        ' Número de pago
            DadesExportaCp = DadesExportaCp & Right(Space(16) & "0.000000", 16)       ' Cambio a aplicar
            DadesExportaCp = DadesExportaCp & Right(Space(16) & "0.00", 16)      ' Importe debe moneda extranjera
            DadesExportaCp = DadesExportaCp & Right(Space(16) & "0.00", 16)      ' Importe haber moneda extranjera
            DadesExportaCp = DadesExportaCp & Right(Space(1), 1)            ' Auxiliar (interno)
            DadesExportaCp = DadesExportaCp & Right(Space(1), 1)            ' Serie de la facturación
            DadesExportaCp = DadesExportaCp & Right(Space(4), 4)            ' Sucursal (sin uso)
            DadesExportaCp = DadesExportaCp & Right(Space(5), 5)            ' Código de la divisa
            DadesExportaCp = DadesExportaCp & Right(Space(16) & "0.00", 16)      ' Importe auxiliar moneda extranjera
            DadesExportaCp = DadesExportaCp & Right(Space(1) & "2", 1)        ' Moneda en USo (1-Peseteas, 2-Euros)
            DadesExportaCp = DadesExportaCp & Right(Space(16) & ImporteDeve, 16)      ' Importe al debe en euros
            DadesExportaCp = DadesExportaCp & Right(Space(16) & ImporteHaver, 16)     ' Importe al haber en euros
            DadesExportaCp = DadesExportaCp & Right(Space(16) & 0, 16)        ' Base imponible del IVA en Euros
            DadesExportaCp = DadesExportaCp & Right(Space(1) & "F", 1)        ' NoConv (interno)
            DadesExportaCp = DadesExportaCp & Right(Space(10), 10)            ' Código de Activo
            DadesExportaCp = DadesExportaCp & Right(Space(1), 1)            ' serie de Factura rectificada
            DadesExportaCp = DadesExportaCp & Right(Space(8), 8)            ' Número factura rectificada
            DadesExportaCp = DadesExportaCp & Right(Space(16) & "0.00", 16)      ' Base imponible factura rectificada
            DadesExportaCp = DadesExportaCp & Right(Space(16) & "0.00", 16)      ' Base imponible factura rectificada
            DadesExportaCp = DadesExportaCp & Right(Space(1) & "F", 1)        ' Factura rectificada (T en caso de factura rectificada)
            DadesExportaCp = DadesExportaCp & Right(Space(4), 4)            ' Año '2002 FacturaRectificada
            DadesExportaCp = DadesExportaCp & Right(Space(2), 2)            ' Mes '01   FacturaRectificada
            DadesExportaCp = DadesExportaCp & Right(Space(2), 2)                ' Día '03   FacturaRectificada
            DadesExportaCp = DadesExportaCp & Chr(13) & Chr(10)                                  ' Fin     ' chr13 + chr10
        End If
        rs.MoveNext
        DoEvents
    Wend
    rs.Close
    
    If Abs(Th - Td) > 0.001 Then
        ImporteDeve = 0
        ImporteHaver = 0
        If CDbl(Th - Td) < 0 Then
            ImporteDeve = Abs(Round(Th - Td, 2))
        Else
            ImporteHaver = Abs(Round(Th - Td, 2))
        End If
    
        DadesExportaCp = DadesExportaCp & Right(Space(6) & numAsiento, 6)                      ' Núm. del asiento '000001
        DadesExportaCp = DadesExportaCp & Right("0000" & Year(DataInicial), 4)                    ' Año '2002
        DadesExportaCp = DadesExportaCp & Right("00" & Month(DataInicial), 2)                  ' Mes '01
        DadesExportaCp = DadesExportaCp & Right("00" & Day(DataInicial), 2)                      ' Día '03
        DadesExportaCp = DadesExportaCp & Left("79000000" & Space(12), 12)                              ' Cuenta destino '430000000000
        DadesExportaCp = DadesExportaCp & Left("79000000" & Space(12), 12)                                                          ' Cuenta VENTAS
        DadesExportaCp = DadesExportaCp & Right(Space(16), 16)                                                ' Importe Debe Pts
        DadesExportaCp = DadesExportaCp & Left("Errores descuadre ReApertura " & Space(25), 25)   ' Concepto del asiento 'DESCRIPCION VENTA
        DadesExportaCp = DadesExportaCp & Right(Space(16) & "0.00", 16)                                                       ' Importe Haber Pts
        DadesExportaCp = DadesExportaCp & Right(Space(8), 8)                                          ' Num Factura '00000073'
        DadesExportaCp = DadesExportaCp & Right(Space(16) & "0.00", 16)                                                       ' Base imponible del IVA en Pts
        DadesExportaCp = DadesExportaCp & Right(Space(5) & "0.00", 5)                                                         ' Porcentage de IVA
        DadesExportaCp = DadesExportaCp & Right(Space(5) & "0.00", 5)                                                         ' Recargo de equivalencia
        DadesExportaCp = DadesExportaCp & Right(Space(10) & numAsiento, 10)                                                   ' Número de documento
        DadesExportaCp = DadesExportaCp & Right(Space(3), 3)                                                                  ' Código de departamento
        DadesExportaCp = DadesExportaCp & Right(Space(6), 6)                                                                  ' Código del proyecto
        DadesExportaCp = DadesExportaCp & Right(Space(1), 1)                                                                  ' Punteo (interno)
        DadesExportaCp = DadesExportaCp & Right(Space(6) & "0", 6)                                                            ' Númerico de casación (interno)
        DadesExportaCp = DadesExportaCp & Right(Space(1) & "0", 1)                                                            ' Tipo de casado (interno)
        DadesExportaCp = DadesExportaCp & Right(Space(6) & "0", 6)                                                            ' Número de pago
        DadesExportaCp = DadesExportaCp & Right(Space(16) & "0.000000", 16)                                                   ' Cambio a aplicar
        DadesExportaCp = DadesExportaCp & Right(Space(16) & "0.00", 16)                                                       ' Importe debe moneda extranjera
        DadesExportaCp = DadesExportaCp & Right(Space(16) & "0.00", 16)                                                       ' Importe haber moneda extranjera
        DadesExportaCp = DadesExportaCp & Right(Space(1), 1)                                                                  ' Auxiliar (interno)
        DadesExportaCp = DadesExportaCp & Right(Space(1), 1)                                                                  ' Serie de la facturación
        DadesExportaCp = DadesExportaCp & Right(Space(4), 4)                                                                  ' Sucursal (sin uso)
        DadesExportaCp = DadesExportaCp & Right(Space(5), 5)                                                                  ' Código de la divisa
        DadesExportaCp = DadesExportaCp & Right(Space(16) & "0.00", 16)                                                       ' Importe auxiliar moneda extranjera
        DadesExportaCp = DadesExportaCp & Right(Space(1) & "2", 1)                                                            ' Moneda en USo (1-Peseteas, 2-Euros)
        DadesExportaCp = DadesExportaCp & Right(Space(16) & ImporteHaver, 16)                                                   ' Importe al debe en euros
        DadesExportaCp = DadesExportaCp & Right(Space(16) & ImporteDeve, 16)                                               ' Importe al haber en euros
        DadesExportaCp = DadesExportaCp & Right(Space(16) & 0, 16)                                                            ' Base imponible del IVA en Euros
        DadesExportaCp = DadesExportaCp & Right(Space(1) & "F", 1)                                                            ' NoConv (interno)
        DadesExportaCp = DadesExportaCp & Right(Space(10), 10)                                                                ' Código de Activo
        DadesExportaCp = DadesExportaCp & Right(Space(1), 1)                                                                  ' serie de Factura rectificada
        DadesExportaCp = DadesExportaCp & Right(Space(8), 8)                                                                  ' Número factura rectificada
        DadesExportaCp = DadesExportaCp & Right(Space(16) & "0.00", 16)                                                       ' Base imponible factura rectificada
        DadesExportaCp = DadesExportaCp & Right(Space(16) & "0.00", 16)                                                       ' Base imponible factura rectificada
        DadesExportaCp = DadesExportaCp & Right(Space(1) & "F", 1)                                                            ' Factura rectificada (T en caso de factura rectificada)
        DadesExportaCp = DadesExportaCp & Right(Space(4), 4)                                                                  ' Año '2002 FacturaRectificada
        DadesExportaCp = DadesExportaCp & Right(Space(2), 2)                                                                  ' Mes '01   FacturaRectificada
        DadesExportaCp = DadesExportaCp & Right(Space(2), 2)                                                                  ' Día '03   FacturaRectificada
    End If
    numAsiento = numAsiento + 1
            
End Sub



Function BuscaComptePerNom(texte As String) As String
    Dim P, rs As rdoResultset, Part As String
    
    BuscaComptePerNom = "40000000"
    
    P = InStr(texte, "Factura")
    If P = 0 Then P = InStr(texte, "- NF")
    If P = 0 Then P = InStr(texte, "Fra.")
    If P > 0 Then
        Part = Left(texte, P - 2)
        Set rs = Db.OpenResultset("select * from [ccproveedores]  where nombre like '%" & Part & "%'")
        If Not rs.EOF Then BuscaComptePerNom = codiContableProveedor(rs("id"))
        Set rs = Db.OpenResultset("select * from [Clients]  where nom like '%" & Part & "%'")
        If Not rs.EOF Then BuscaComptePerNom = codiContable(rs("Codi"))
    End If
         
    If BuscaComptePerNom = "40000000" Then
        P = InStr(texte, "Factura")
        If P = 0 Then P = InStr(texte, "- NF")
        If P > 0 Then
            Part = Left(Trim(texte), P - 2)
            Set rs = Db.OpenResultset("select * from [clients]  where nom like '%" & Part & "%' or [Nom Llarg] like '%" & Part & "%' ")
            If Not rs.EOF Then
                BuscaComptePerNom = codiContable(rs("Codi"))
            Else
                P = InStr(Part, " ")
                If P > 0 Then Part = Left(Part, P - 2)
                Set rs = Db.OpenResultset("select * from [clients]  where nom like '%" & Part & "%' or [Nom Llarg] like '%" & Part & "%' ")
                If Not rs.EOF Then BuscaComptePerNom = codiContable(rs("Codi"))
            End If
        End If
    End If
    
    If Trim(BuscaComptePerNom) = "40000000" And Not Left(texte, 6) = "Nomina" Then BuscaComptePerNom = "40000000"
    

End Function

Sub ExportaSensaIva(numAsiento, dataFactura, clientCodi, numFactura, totalImporte, TeRetencio As Boolean)
    Dim datos  As String, TotalImportePts As Double, Total
    Dim CuentaDestino As String, data As Date, CuentaVentas, ImporteDeve, DESCRIPCIoN, ImporteHaver, BaseIva
    
    TotalImportePts = totalImporte
    Total = totalImporte
            
    data = dataFactura
    CuentaDestino = codiContable(clientCodi)
    If Total < 0 Then
        CuentaVentas = cVentaMercaderiesDevolucions(clientCodi, TeRetencio)
    Else
        CuentaVentas = cVentaMercaderies(clientCodi, TeRetencio)
    End If
    ImporteDeve = totalImporte
    DESCRIPCIoN = "F.num : " & Abs(numFactura)
    ImporteHaver = 0
    BaseIva = 0
    numFactura = numFactura
    
    
    AsientoAdd numAsiento, data, CuentaDestino, CuentaVentas, numFactura, DESCRIPCIoN, ImporteDeve, ImporteHaver, 0, 0, 0, ""
    AsientoAdd numAsiento, data, CuentaVentas, CuentaDestino, numFactura, DESCRIPCIoN, ImporteHaver, ImporteDeve, 0, 0, 0, ""
    
End Sub

Sub ExportaAmbIva(numAsiento, dataFactura As Date, clientCodi, numFactura, iva1, iva2, iva3, baseIva1, baseIva2, baseIva3, IvaRec1, IvaRec2, IvaRec3, rec1, rec2, rec3, BaseRec1, BaseRec2, BaseRec3, CodiClient, TeRetencio As Boolean, Reservat As String)
    Dim totalImporte As Double, TotalImportePts As Double, datos As String, Tenim1 As Boolean, Tenim2  As Boolean, Tenim3  As Boolean, Tenim4  As Boolean, Tenim5  As Boolean, Tenim6  As Boolean, TenimRec1 As Boolean, TenimRec2 As Boolean, TenimRec3 As Boolean, ContaVentes
    Dim valorIva1 As Double, valorIva2 As Double, valorIva3 As Double, valorIva4 As Double, valorRec1 As Double, valorRec2 As Double, valorRec3 As Double, valorRec4 As Double
    Dim pctRetencio As Double
    
    TipusDeIva valorIva1, valorIva2, valorIva3, valorIva4, valorRec1, valorRec2, valorRec3, valorRec4, dataFactura
    
    'Iva1 = Iva1 + Round(BaseRec1 * (valorIva1 / 100), 2)
    'Iva2 = Iva2 + Round(BaseRec2 * (valorIva2 / 100), 2)
    'Iva3 = Iva3 + Round(BaseRec3 * (valorIva3 / 100), 2)
    
    'Baseiva1 = Baseiva1 + BaseRec1
    'baseiva2 = baseiva2 + BaseRec2
    'baseIva3 = baseIva3 + BaseRec3
           
    totalImporte = Round((iva1 + iva2 + iva3 + baseIva1 + baseIva2 + baseIva3 + rec1 + rec2 + rec3 + BaseRec1 + BaseRec2 + BaseRec3 + IvaRec1 + IvaRec2 + IvaRec3), 2)
    
    iva1 = Round(iva1, 2)
    iva2 = Round(iva2, 2)
    iva3 = Round(iva3, 2)
    baseIva1 = Round(baseIva1, 2)
    baseIva2 = Round(baseIva2, 2)
    baseIva3 = Round(baseIva3, 2)
    rec1 = Round(rec1, 2)
    rec2 = Round(rec2, 2)
    rec3 = Round(rec3, 2)
    BaseRec1 = Round(BaseRec1, 2)
    BaseRec2 = Round(BaseRec2, 2)
    BaseRec3 = Round(BaseRec3, 2)
    IvaRec1 = Round(IvaRec1, 2)
    IvaRec2 = Round(IvaRec2, 2)
    IvaRec3 = Round(IvaRec3, 2)
    
    If totalImporte <> (iva1 + iva2 + iva3 + baseIva1 + baseIva2 + baseIva3 + rec1 + rec2 + rec3 + BaseRec1 + BaseRec2 + BaseRec3 + IvaRec1 + IvaRec2 + IvaRec3) Then
        If baseIva1 > 0 Then
            iva1 = iva1 + (totalImporte - (iva1 + iva2 + iva3 + baseIva1 + baseIva2 + baseIva3 + rec1 + rec2 + rec3 + BaseRec1 + BaseRec2 + BaseRec3 + IvaRec1 + IvaRec2 + IvaRec3))
        ElseIf baseIva2 > 0 Then
            iva2 = iva2 + (totalImporte - (iva1 + iva2 + iva3 + baseIva1 + baseIva2 + baseIva3 + rec1 + rec2 + rec3 + BaseRec1 + BaseRec2 + BaseRec3 + IvaRec1 + IvaRec2 + IvaRec3))
        ElseIf baseIva3 > 0 Then
            iva3 = iva3 + (totalImporte - (iva1 + iva2 + iva3 + baseIva1 + baseIva2 + baseIva3 + rec1 + rec2 + rec3 + BaseRec1 + BaseRec2 + BaseRec3 + IvaRec1 + IvaRec2 + IvaRec3))
        ElseIf BaseRec1 > 0 Then
            IvaRec1 = IvaRec1 + (totalImporte - (iva1 + iva2 + iva3 + baseIva1 + baseIva2 + baseIva3 + rec1 + rec2 + rec3 + BaseRec1 + BaseRec2 + BaseRec3 + IvaRec1 + IvaRec2 + IvaRec3))
        ElseIf BaseRec2 > 0 Then
            IvaRec2 = IvaRec2 + (totalImporte - (iva1 + iva2 + iva3 + baseIva1 + baseIva2 + baseIva3 + rec1 + rec2 + rec3 + BaseRec1 + BaseRec2 + BaseRec3 + IvaRec1 + IvaRec2 + IvaRec3))
        ElseIf BaseRec3 > 0 Then
            IvaRec3 = IvaRec3 + (totalImporte - (iva1 + iva2 + iva3 + baseIva1 + baseIva2 + baseIva3 + rec1 + rec2 + rec3 + BaseRec1 + BaseRec2 + BaseRec3 + IvaRec1 + IvaRec2 + IvaRec3))
        End If
    End If
    
    If TeRetencio Then
        pctRetencio = 18
        If InStr(1, Reservat, "[Retencio") Then
            pctRetencio = CDbl(Replace(Replace(Reservat, "[Retencio", ""), "]", ""))
        End If
        totalImporte = totalImporte - Round((baseIva1 + baseIva2 + baseIva3) * (pctRetencio / 100), 2)
    End If
    
    If totalImporte < 0 Then
        ContaVentes = cVentaMercaderiesDevolucions(CodiClient, TeRetencio)
    Else
        ContaVentes = cVentaMercaderies(CodiClient, TeRetencio)
    End If
    
    TotalImportePts = 0 ' Round((TotalImportePts * 166.386), 0)
    
    AsientoAdd numAsiento, dataFactura, codiContable2(clientCodi), ContaVentes, numFactura, Left("F.num : " & Abs(numFactura) & Space(25), 25), totalImporte, 0, totalImporte, 0, 0, ""
    
    
'    AsientoAddStr Right(Space(6) & numAsiento, 6)                                                      ' Núm. del asiento '000001
'    'AsientoAddStr   space(6)                                                                                               ' Núm. del asiento '000001
'    AsientoAddStr Right("0000" & Year(DataFactura), 4)                                        ' Año '2002
'    AsientoAddStr Right("00" & Month(DataFactura), 2)                                         ' Mes '01
'    AsientoAddStr Right("00" & Day(DataFactura), 2)                                           ' Día '03
'    AsientoAddStr codiContable(clientCodi)                                                             ' Cuenta destino '430000000000
'    AsientoAddStr ContaVentes                                                                    ' Cuenta VENTAS
'    AsientoAddStr Right(Space(16) & TotalImportePts, 16)                                               ' Importe Debe Pts
'    AsientoAddStr Left("F.num : " & Abs(NumFactura) & Space(25), 25)                          ' Concepto del asiento 'DESCRIPCION VENTA
'    AsientoAddStr Right(Space(16) & "0.00", 16)                                                        ' Importe Haber Pts
'    AsientoAddStr Right(Space(8) & Abs(NumFactura), 8)                                        ' Num Factura '00000073'
'    AsientoAddStr Right(Space(16) & "0.00", 16)                                                        ' Base imponible del IVA en Pts
'    AsientoAddStr Right(Space(5) & "0.00", 5)                                                          ' Porcentage de IVA
'    AsientoAddStr Right(Space(5) & "0.00", 5)                                                          ' Recargo de equivalencia
'    AsientoAddStr Right(Space(10), 10)                                                     ' Número de documento
'    AsientoAddStr Right(Space(3), 3)                                                                   ' Código de departamento
'    AsientoAddStr Right(Space(6), 6)                                                                   ' Código del proyecto
'    AsientoAddStr Right(0 & Space(1), 1)                                                   ' Punteo (interno)
'    AsientoAddStr Right(Space(6) & "0", 6)                                                             ' Númerico de casación (interno)
'    AsientoAddStr Right(Space(1) & "0", 1)                                                             ' Tipo de casado (interno)
'    AsientoAddStr Right(Space(6) & "0", 6)                                                             ' Número de pago
'    AsientoAddStr Right(Space(16) & "0.000000", 16)                                                    ' Cambio a aplicar
'    AsientoAddStr Right(Space(16) & "0.00", 16)                                                        ' Importe debe moneda extranjera
'    AsientoAddStr Right(Space(16) & "0.00", 16)                                                        ' Importe haber moneda extranjera
'    AsientoAddStr Right(Space(1), 1)                                                                   ' Auxiliar (interno)
'    AsientoAddStr Right(Space(1), 1)                                                                   ' Serie de la facturación
'    AsientoAddStr Right(Space(4), 4)                                                                   ' Sucursal (sin uso)
'    AsientoAddStr Right(Space(5), 5)                                                                   ' Código de la divisa
'    AsientoAddStr Right(Space(16) & "0.00", 16)                                                        ' Importe auxiliar moneda extranjera
'    AsientoAddStr Right(Space(1) & "2", 1)                                                             ' Moneda en USo (1-Peseteas, 2-Euros)
'    AsientoAddStr Right(Space(16) & TotalImporte, 16)                                                  ' Importe al debe en euros
'    AsientoAddStr Right(Space(16) & "0.00", 16)                                                        ' Importe al haber en euros
'    AsientoAddStr Right(Space(16) & TotalImporte, 16)                                                  ' Base imponible del IVA en Euros
'    AsientoAddStr Right(Space(1) & "F", 1)                                                             ' NoConv (interno)
'    AsientoAddStr Right(Space(10), 10)                                                                 ' Código de Activo
'    AsientoAddStr Right(Space(1), 1)                                                                   ' serie de Factura rectificada
'    AsientoAddStr Right(Space(8) & Abs(NumFactura), 8)                                            ' Número factura rectificada
'    AsientoAddStr Right(Space(16) & "0.00", 16)                                                        ' Base imponible factura rectificada
'    AsientoAddStr Right(Space(16) & "0.00", 16)                                                        ' Base imponible factura rectificada
'    AsientoAddStr Right(Space(1) & "F", 1)                                                             ' Factura rectificada (T en caso de factura rectificada)
'    AsientoAddStr Right(Space(4), 4)                                                                   ' Año '2002 FacturaRectificada
'    AsientoAddStr Right(Space(2), 2)                                                                   ' Mes '01   FacturaRectificada
'    AsientoAddStr Right(Space(2), 2)                                                                   ' Día '03   FacturaRectificada
'    AsientoAddStr Chr(13) & Chr(10)                                                                    ' Fin     ' chr13 + chr10

    Tenim1 = False
    Tenim2 = False
    Tenim3 = False
    Tenim4 = False
    Tenim5 = False
    Tenim6 = False
    TenimRec1 = False
    TenimRec2 = False
    TenimRec3 = False

    If Abs(iva1) > 0 Then Tenim1 = True
    If Abs(iva2) > 0 Then Tenim2 = True
    If Abs(iva3) > 0 Then Tenim3 = True

    If (Tenim1) And Abs(baseIva1) > 0 Then Tenim4 = True
    If (Tenim2) And Abs(baseIva2) > 0 Then Tenim5 = True
    If (Tenim3) And Abs(baseIva3) > 0 Then Tenim6 = True
    
    If Abs(rec1) > 0 Then TenimRec1 = True
    If Abs(rec2) > 0 Then TenimRec2 = True
    If Abs(rec3) > 0 Then TenimRec3 = True

    If (TenimRec1) And Abs(BaseRec1) > 0 Then Tenim4 = True
    If (TenimRec2) And Abs(BaseRec2) > 0 Then Tenim5 = True
    If (TenimRec3) And Abs(BaseRec3) > 0 Then Tenim6 = True
    
    'IVAS 47700004,47700008,47700018
    If Tenim1 Then PintaDetallIva numAsiento, clientCodi, numFactura, dataFactura, iva1, baseIva1, numFactura, valorIva1 & ".00", TenimRec1
    If Tenim2 Then PintaDetallIva numAsiento, clientCodi, numFactura, dataFactura, iva2, baseIva2, numFactura, valorIva2 & ".00", TenimRec2
    If Tenim3 Then PintaDetallIva numAsiento, clientCodi, numFactura, dataFactura, iva3, baseIva3, numFactura, valorIva3 & ".00", TenimRec3
   
    'IVAS CON RECS 47700404,47700408,47700418
    If TenimRec1 Then PintaDetallIva numAsiento, clientCodi, numFactura, dataFactura, IvaRec1, BaseRec1, numFactura, valorIva1 & ".00", True
    If TenimRec2 Then PintaDetallIva numAsiento, clientCodi, numFactura, dataFactura, IvaRec2, BaseRec2, numFactura, valorIva2 & ".00", True
    If TenimRec3 Then PintaDetallIva numAsiento, clientCodi, numFactura, dataFactura, IvaRec3, BaseRec3, numFactura, valorIva3 & ".00", True
   
    '70000000
    If Tenim4 Then PintaDetallIva numAsiento, clientCodi, numFactura, dataFactura, baseIva1 + BaseRec1, "0.00", numFactura, "0.00", False, TeRetencio, pctRetencio
    If Tenim5 Then PintaDetallIva numAsiento, clientCodi, numFactura, dataFactura, baseIva2 + BaseRec2, "0.00", numFactura, "0.00", False, TeRetencio, pctRetencio
    If Tenim6 Then PintaDetallIva numAsiento, clientCodi, numFactura, dataFactura, baseIva3 + BaseRec3, "0.00", numFactura, "0.00", False, TeRetencio, pctRetencio
        
    If UCase(EmpresaActual) <> UCase("Vilapan") Then
        'Recargos en 475
        If TenimRec1 Then PintaDetallIva numAsiento, clientCodi, numFactura, dataFactura, rec1, 0, numFactura, "0.5"
        If TenimRec2 Then PintaDetallIva numAsiento, clientCodi, numFactura, dataFactura, rec2, 0, numFactura, "1"
        If TenimRec3 Then PintaDetallIva numAsiento, clientCodi, numFactura, dataFactura, rec3, 0, numFactura, "4"
    Else
        'Cuota Recargos
        If TenimRec1 Then PintaDetallIva numAsiento, clientCodi, numFactura, dataFactura, rec1, 0, numFactura, valorIva1 & ".00", True
        If TenimRec2 Then PintaDetallIva numAsiento, clientCodi, numFactura, dataFactura, rec2, 0, numFactura, valorIva2 & ".00", True
        If TenimRec3 Then PintaDetallIva numAsiento, clientCodi, numFactura, dataFactura, rec3, 0, numFactura, valorIva3 & ".00", True
    End If
    
End Sub



Sub PintaDetallIva(numAsiento, clientCodi, umFactura, dataFactura As Date, haber, BaseIva, numFactura, tipoIva, Optional TeRecarreg As Boolean = False, Optional TeRetencio As Boolean = False, Optional pctRetencio As Double)
    Dim haberPts, baseIvaPts, nCuenta, Quota, datos, TipoRec, haberReten
    Dim valorIva1 As Double, valorIva2 As Double, valorIva3 As Double, valorIva4 As Double, valorRec1 As Double, valorRec2 As Double, valorRec3 As Double, valorRec4 As Double
    
    TipusDeIva valorIva1, valorIva2, valorIva3, valorIva4, valorRec1, valorRec2, valorRec3, valorRec4, dataFactura
   
    
    haber = haber
    haber = Round(haber, 3)
    
    haberPts = 0 'Haber * 166.386
    haberPts = 0 'Round(haberPts, 2)
    
    BaseIva = BaseIva
    BaseIva = Round(BaseIva, 2)
    
    baseIvaPts = 0 'BaseIva * 166.386
    baseIvaPts = 0 'Round(baseIvaPts, 2)
    TipoRec = "0.00"
    
    If (tipoIva = "0.00") Then
        'nCuenta = cVentas(0)
        nCuenta = cVentaMercaderies(clientCodi, TeRetencio)
        If TeRetencio Then
'            nCuenta = codiContable(clientCodi)
            haberReten = Round(haber * (pctRetencio / 100), 2)
            'Haber = Haber - HaberReten
        End If
    Else
        Quota = Left(tipoIva, 2)
        Quota = Replace(Quota, ".", "")
        nCuenta = cIVA(Quota, TeRecarreg)
        'nCuenta = cIva(Quota, False)
        If TeRecarreg Then
            If tipoIva = valorIva1 & ".00" Then TipoRec = valorRec1
            If tipoIva = valorIva2 & ".00" Then TipoRec = valorRec2
            If tipoIva = valorIva3 & ".00" Then TipoRec = valorRec3
        End If
        
        If tipoIva = "0.5" Then
            nCuenta = ("475" & Right("000000000000", nDigitos - 3)) + valorIva1
            tipoIva = valorIva1 & ".00"
            'TipoRec = "0.5"
            TipoRec = valorRec1
        End If
        
        If tipoIva = "1" Then
            nCuenta = ("475" & Right("000000000000", nDigitos - 3)) + valorIva2
            tipoIva = valorIva2 & ".00"
            'TipoRec = "1"
            TipoRec = valorRec2
        End If
        
        If tipoIva = "4" Then
            nCuenta = ("475" & Right("000000000000", nDigitos - 3)) + valorIva3
            tipoIva = valorIva3 & ".00"
            'TipoRec = "4"
            TipoRec = valorRec3
        End If
        
        nCuenta = Left(nCuenta & Space(12), 12)

        
    End If

'response.write "b"
'response.flush
  'If TipoRec <> "0.0" Then TipoIva = "0.00"
  
    AsientoAdd numAsiento, dataFactura, nCuenta, codiContable2(clientCodi), numFactura, Left("Factura num: " & numFactura & Space(25), 25), 0, haber, BaseIva, tipoIva, TipoRec, ""
    
'    AsientoAddStr Right(Space(6) & numAsiento, 6)                                                      ' Núm. del asiento '000001
'    AsientoAddStr Right("0000" & Year(DataFactura), 4)                                        ' Año '2002
'    AsientoAddStr Right("00" & Month(DataFactura), 2)                                         ' Mes '01
'    AsientoAddStr Right("00" & Day(DataFactura), 2)                                           ' Día '03
'    AsientoAddStr nCuenta                                                                              ' Código de la contrapartida/IVA
'    AsientoAddStr codiContable(clientCodi)                                                             ' Cuenta destino '430000000000
'    AsientoAddStr Right(Space(16) & "0.00", 16)                                                        ' Importe Debe Pts
'    AsientoAddStr Left("Factura num: " & NumFactura & Space(25), 25)                          ' Concepto del asiento 'DESCRIPCION VENTA
'    AsientoAddStr Right(Space(16) & haberPts, 16)                                                      ' Importe Haber Pts
'    AsientoAddStr Right(Space(8) & Abs(umFactura), 8)                                        ' Num Factura '00000073'
'    AsientoAddStr Right(Space(16) & baseIvaPts, 16)                                                    ' Base imponible del IVA en Pts
'    AsientoAddStr Right(Space(5) & TipoIva, 5)                                                         ' Porcentage de IVA
'    AsientoAddStr Right(Space(5) & TipoRec, 5)                                                          ' Recargo de equivalencia
'    AsientoAddStr Right(Space(10), 10)                                                     ' Número de documento
'    AsientoAddStr Right(Space(3), 3)                                                                   ' Código de departamento
'    AsientoAddStr Right(Space(6), 6)                                                                   ' Código del proyecto
'    AsientoAddStr Right(0 & Space(1), 1)                                                   ' Punteo (interno)
'    AsientoAddStr Right(Space(6) & "0", 6)                                                             ' Númerico de casación (interno)
'    AsientoAddStr Right(Space(1) & "0", 1)                                                             ' Tipo de casado (interno)
'    AsientoAddStr Right(Space(6) & "0", 6)                                                             ' Número de pago
'    AsientoAddStr Right(Space(16) & "0.000000", 16)                                                    ' Cambio a aplicar
'    AsientoAddStr Right(Space(16) & "0.00", 16)                                                        ' Importe debe moneda extranjera
'    AsientoAddStr Right(Space(16) & "0.00", 16)                                                        ' Importe haber moneda extranjera
'    AsientoAddStr Right(Space(1), 1)                                                                   ' Auxiliar (interno)
'    AsientoAddStr Right(Space(1), 1)                                                                   ' Serie de la facturación
'    AsientoAddStr Right(Space(4), 4)                                                                   ' Sucursal (sin uso)
'    AsientoAddStr Right(Space(5), 5)                                                                   ' Código de la divisa
'    AsientoAddStr Right(Space(16) & "0.00", 16)                                                        ' Importe auxiliar moneda extranjera
'    AsientoAddStr Right(Space(1) & "2", 1)                                                             ' Moneda en USo (1-Peseteas, 2-Euros)
'    AsientoAddStr Right(Space(16) & "0.00", 16)                                                        ' Importe al debe en euros, en el caso del IVA, siempre ceros
'    AsientoAddStr Right(Space(16) & Haber, 16)                                                         ' Importe al haber en euros
'    AsientoAddStr Right(Space(16) & BaseIva, 16)                                                       ' Base imponible del IVA en Euros
'    AsientoAddStr Right(Space(1) & "F", 1)                                                             ' NoConv (interno)
'    AsientoAddStr Right(Space(10), 10)                                                                 ' Código de Activo
'    AsientoAddStr Right(Space(1), 1)                                                                   ' serie de Factura rectificada
'    AsientoAddStr Right(Space(8) & Abs(NumFactura), 8)                                        ' Número factura rectificada
'    AsientoAddStr Right(Space(16) & "0.00", 16)                                                        ' Base imponible factura rectificada
'    AsientoAddStr Right(Space(16) & "0.00", 16)                                                        ' Base imponible factura rectificada
'    AsientoAddStr Right(Space(1) & "F", 1)                                                             ' Factura rectificada (T en caso de factura rectificada)
'    AsientoAddStr Right(Space(4), 4)                                                                   ' Año '2002 FacturaRectificada
'    AsientoAddStr Right(Space(2), 2)                                                                   ' Mes '01   FacturaRectificada
'    AsientoAddStr Right(Space(2), 2)                                                                   ' Día '03   FacturaRectificada
'                                                                                                        ' NIC (' ' Asiento válido solo para P.G.C, 'E' futuras normas NIC)
'    AsientoAddStr Chr(13) & Chr(10)                                                                    ' Fin     ' chr13 + chr10

    If TeRetencio Then
        nCuenta = Left(("473" & Right("000000000000", nDigitos - 3)) & Space(12), 12)
        AsientoAdd numAsiento, dataFactura, nCuenta, nCuenta, numFactura, Left("Factura num: " & numFactura & Space(25), 25), haberReten, 0, baseIvaPts, tipoIva, TipoRec, ""
        
'        AsientoAddStr Right(Space(6) & numAsiento, 6)                                                      ' Núm. del asiento '000001
'        AsientoAddStr Right("0000" & Year(DataFactura), 4)                                        ' Año '2002
'        AsientoAddStr Right("00" & Month(DataFactura), 2)                                         ' Mes '01
'        AsientoAddStr Right("00" & Day(DataFactura), 2)                                           ' Día '03
'        AsientoAddStr nCuenta                                                                              ' Código de la contrapartida/IVA
'        AsientoAddStr nCuenta                                                              ' Cuenta destino '430000000000
'        AsientoAddStr Right(Space(16) & "0.00", 16)                                                        ' Importe Debe Pts
'        AsientoAddStr Left("Factura num: " & NumFactura & Space(25), 25)                          ' Concepto del asiento 'DESCRIPCION VENTA
'        AsientoAddStr Right(Space(16) & haberPts, 16)                                                      ' Importe Haber Pts
'        AsientoAddStr Right(Space(8) & Abs(umFactura), 8)                                        ' Num Factura '00000073'
'        AsientoAddStr Right(Space(16) & baseIvaPts, 16)                                                    ' Base imponible del IVA en Pts
'        AsientoAddStr Right(Space(5) & TipoIva, 5)                                                         ' Porcentage de IVA
'        AsientoAddStr Right(Space(5) & TipoRec, 5)                                                          ' Recargo de equivalencia
'        AsientoAddStr Right(Space(10), 10)                                                     ' Número de documento
'        AsientoAddStr Right(Space(3), 3)                                                                   ' Código de departamento
'        AsientoAddStr Right(Space(6), 6)                                                                   ' Código del proyecto
'        AsientoAddStr Right(0 & Space(1), 1)                                                   ' Punteo (interno)
'        AsientoAddStr Right(Space(6) & "0", 6)                                                             ' Númerico de casación (interno)
'        AsientoAddStr Right(Space(1) & "0", 1)                                                             ' Tipo de casado (interno)
'        AsientoAddStr Right(Space(6) & "0", 6)                                                             ' Número de pago
'        AsientoAddStr Right(Space(16) & "0.000000", 16)                                                    ' Cambio a aplicar
'        AsientoAddStr Right(Space(16) & "0.00", 16)                                                        ' Importe debe moneda extranjera
'        AsientoAddStr Right(Space(16) & "0.00", 16)                                                        ' Importe haber moneda extranjera
'        AsientoAddStr Right(Space(1), 1)                                                                   ' Auxiliar (interno)
'        AsientoAddStr Right(Space(1), 1)                                                                   ' Serie de la facturación
'        AsientoAddStr Right(Space(4), 4)                                                                   ' Sucursal (sin uso)
'        AsientoAddStr Right(Space(5), 5)                                                                   ' Código de la divisa
'        AsientoAddStr Right(Space(16) & "0.00", 16)                                                        ' Importe auxiliar moneda extranjera
'        AsientoAddStr Right(Space(1) & "2", 1)                                                             ' Moneda en USo (1-Peseteas, 2-Euros)
'        AsientoAddStr Right(Space(16) & HaberReten, 16)                                                    ' Importe al debe en euros, en el caso del IVA, siempre ceros
'        AsientoAddStr Right(Space(16) & "0.00", 16)                                                        ' Importe al haber en euros
'        AsientoAddStr Right(Space(16) & BaseIva, 16)                                                       ' Base imponible del IVA en Euros
'        AsientoAddStr Right(Space(1) & "F", 1)                                                             ' NoConv (interno)
'        AsientoAddStr Right(Space(10), 10)                                                                 ' Código de Activo
'        AsientoAddStr Right(Space(1), 1)                                                                   ' serie de Factura rectificada
'        AsientoAddStr Right(Space(8) & Abs(NumFactura), 8)                                        ' Número factura rectificada
'        AsientoAddStr Right(Space(16) & "0.00", 16)                                                        ' Base imponible factura rectificada
'        AsientoAddStr Right(Space(16) & "0.00", 16)                                                        ' Base imponible factura rectificada
'        AsientoAddStr Right(Space(1) & "F", 1)                                                             ' Factura rectificada (T en caso de factura rectificada)
'        AsientoAddStr Right(Space(4), 4)                                                                   ' Año '2002 FacturaRectificada
'        AsientoAddStr Right(Space(2), 2)                                                                   ' Mes '01   FacturaRectificada
'        AsientoAddStr Right(Space(2), 2)                                                                   ' Día '03   FacturaRectificada
'        AsientoAddStr Chr(13) & Chr(10)                                                                    ' Fin     ' chr13 + chr10
    End If

'response.write " e <Br>"
'response.flush
End Sub



Sub GuardaHistoric(botiga, data, Tipus, Optional texte1 As String = "", Optional Texte2 As String = "", Optional Texte3 As String = "", Optional Texte4 As String = "")
    Dim tTexte1 As String, tTexte2 As String, tTexte3 As String, tTexte4 As String
    
Debug.Print texte1
    If botiga = "" Then botiga = 0

    If InStr("", Tipus) = 0 Then
        tTexte1 = Join(Split(texte1, "'"), "`")
        tTexte2 = Join(Split(Texte2, "'"), "`")
        tTexte3 = Join(Split(Texte3, "'"), "`")
        tTexte4 = Join(Split(Texte4, "'"), "`")
    
        ExecutaComandaSql "Insert Into " & HistoricComunicacions(data) & " (Llicencia,Data,Tipus,Aux1,Aux2,Aux3,Aux4) Values (" & botiga & ",getdate(),'" & Left(Tipus, 254) & "','" & Left(tTexte1, 254) & "','" & Left(tTexte2, 254) & "','" & Left(tTexte3, 254) & "','" & Left(tTexte4, 254) & "') "
    End If
    
'    Debug.Print Botiga & Texte1 & Texte2 & Texte3 & Texte4
    
End Sub

Sub GuardaHistoricReposicio(botiga As String, data As Date, Tipus As String, Optional texte1 As String = "", Optional Texte2 As String = "", Optional Texte3 As String = "", Optional Texte4 As String = "")
    Dim tTexte1 As String, tTexte2 As String, tTexte3 As String, tTexte4 As String
    
Debug.Print texte1
    If botiga = "" Then botiga = 0

    If InStr("", Tipus) = 0 Then
        tTexte1 = Join(Split(texte1, "'"), "`")
        tTexte2 = Join(Split(Texte2, "'"), "`")
        tTexte3 = Join(Split(Texte3, "'"), "`")
        tTexte4 = Join(Split(Texte4, "'"), "`")
    
        If tTexte3 = "" Then
            If Len(tTexte2) > 255 Then
                tTexte3 = Mid(tTexte3, 255)
            End If
        End If
        
        ExecutaComandaSql "Insert Into " & HistoricComunicacionsReposicio(data) & " (Llicencia,Data,Tipus,Aux1,Aux2,Aux3,Aux4) Values (" & botiga & ",getdate(),'" & Left(Tipus, 254) & "','" & Left(tTexte1, 254) & "','" & Left(tTexte2, 254) & "','" & Left(tTexte3, 254) & "','" & Left(tTexte4, 254) & "') "
    End If
    
'    Debug.Print Botiga & Texte1 & Texte2 & Texte3 & Texte4
    
End Sub
Sub ModificaComandesSegonsInventarisBotiga(botiga As Double, Avui As Date, Optional FesHo As Boolean = False)
    Dim sql As String, rs As rdoResultset, i As Integer, Codi As Double, Dinv As Date, St_inicial As Double, Entrades As Double, Sortides As Double, Dema As Date, Demanat As Double, CalDemanar As Double, LotMin As Double, TotalDemanat
    Dim prevision
    Dim Stri As String
    
    If Not FesHo Then If Hour(Now) > 15 Or (Hour(Now) = 15) Then Exit Sub
    If Hour(Avui) = 0 And Minute(Avui) = 0 And Second(Avui) = 0 Then Avui = Avui + TimeSerial(Hour(Now), Minute(Now), Second(Now))
    
    Dema = DateAdd("d", 1, Avui)
    GuardaHistoric botiga, Avui, "Inventari Calculat :", " Servit = StockFijado - (Inventario + Enviado - Vendido)"
       
    'NetejaInventarisA0 DateAdd("m", 0, Avui)
    'NetejaInventarisA0 DateAdd("m", -1, Avui)
    
    Debug.Print BotigaCodiNom(botiga)
    InformaMiss "Inventari " & BotigaCodiNom(botiga)
    TotalDemanat = 0
    sql = "Select t.* from "
    sql = sql & "( "
    sql = sql & " Select Plu,Data,quantitat  from [" & NomTaulaInventari(DateAdd("m", 0, Avui)) & " ] Where Tipus_Venta=1 and  botiga = " & botiga & " Union "
    sql = sql & " Select Plu,Data,quantitat  from [" & NomTaulaInventari(DateAdd("m", -1, Avui)) & "] Where Tipus_Venta=1 and  botiga = " & botiga & " "
    sql = sql & ") t join "
    sql = sql & "("
    sql = sql & " Select max(data) as data,plu from "
    sql = sql & "( "
    sql = sql & " Select Plu,Data,quantitat from [" & NomTaulaInventari(DateAdd("m", 0, Avui)) & " ] Where Tipus_Venta=1 and  botiga = " & botiga & " Union "
    sql = sql & " Select Plu,Data,quantitat from [" & NomTaulaInventari(DateAdd("m", -1, Avui)) & "] Where Tipus_Venta=1 and  botiga = " & botiga & " "
    sql = sql & ") K "
    sql = sql & " Where "
    sql = sql & " (day(data) = " & Day(Avui) & "                    and month(data) = " & Month(Avui) & "                   ) or "
    sql = sql & " (day(data) = " & Day(DateAdd("d", -1, Avui)) & "  and month(data) = " & Month(DateAdd("d", -1, Avui)) & " ) or "
    sql = sql & " (day(data) = " & Day(DateAdd("d", -2, Avui)) & "  and month(data) = " & Month(DateAdd("d", -2, Avui)) & " ) or "
    sql = sql & " (day(data) = " & Day(DateAdd("d", -3, Avui)) & "  and month(data) = " & Month(DateAdd("d", -3, Avui)) & " ) or "
    sql = sql & " (day(data) = " & Day(DateAdd("d", -4, Avui)) & "  and month(data) = " & Month(DateAdd("d", -4, Avui)) & " ) or "
    sql = sql & " (day(data) = " & Day(DateAdd("d", -5, Avui)) & "  and month(data) = " & Month(DateAdd("d", -5, Avui)) & " ) or "
    sql = sql & " (day(data) = " & Day(DateAdd("d", -6, Avui)) & "  and month(data) = " & Month(DateAdd("d", -6, Avui)) & " ) or "
    sql = sql & " (day(data) = " & Day(DateAdd("d", -7, Avui)) & "  and month(data) = " & Month(DateAdd("d", -7, Avui)) & " ) or "
    sql = sql & " (day(data) = " & Day(DateAdd("d", -8, Avui)) & "  and month(data) = " & Month(DateAdd("d", -8, Avui)) & " ) or "
    sql = sql & " (day(data) = " & Day(DateAdd("d", -9, Avui)) & "  and month(data) = " & Month(DateAdd("d", -9, Avui)) & " ) or "
    sql = sql & " (day(data) = " & Day(DateAdd("d", -10, Avui)) & "  and month(data) = " & Month(DateAdd("d", -10, Avui)) & " ) "
    sql = sql & " "
    sql = sql & "group by plu) tt on t.data=tt.data and t.plu = tt.plu "

    Set rs = Db.OpenResultset(sql)
    
    While Not rs.EOF
        Codi = rs("Plu")
Debug.Print "I.per " & ArticleCodiNom(Codi),
InformaMiss ArticleCodiNom(Codi), True
        If InStr(UCase(ArticleCodiNom(Codi)), UCase("estrella dorada lata")) > 0 Then
            Codi = Codi
        End If
        Dinv = rs("Data")
        St_inicial = rs("Quantitat")
        Demanat = CalculaDemanat(Codi, botiga, Dema, Dema)
            
        If Demanat > 0 Then
            Entrades = CalculaServit(Codi, botiga, Dinv, Avui)
            Sortides = CalculaVenut(Codi, botiga, Dinv, Avui)
            'Prevision = CalculaVenut(Codi, Botiga, Dinv, Avui)
'            If (Day(Dinv) = Day(Avui) And Month(Dinv) = Month(Avui) And Year(Dinv) = Year(Avui)) Then
                If Sortides > (St_inicial + Entrades) Then Sortides = St_inicial + Entrades
                CalDemanar = Demanat - (St_inicial + Entrades - Sortides)
'            Else
'                CalDemanar = CalculaServit(Codi, Botiga, DateSerial(Year(DateAdd("d", -6, Avui)), Month(DateAdd("d", -6, Avui)), Day(DateAdd("d", -6, Avui))) + TimeSerial(0, 0, 0), DateSerial(Year(DateAdd("d", -6, Avui)), Month(DateAdd("d", -6, Avui)), Day(DateAdd("d", -6, Avui))) + TimeSerial(23, 58, 0))
'                If CalDemanar > Demanat Then CalDemanar = Demanat
'            End If
            
            LotMin = ArticleCodiLot(Codi)
                
            If CalDemanar < 0 Then CalDemanar = 0
            If CalDemanar <> Int(CalDemanar) Then CalDemanar = Int(CalDemanar) + 1
                
            While (CalDemanar / LotMin) <> Int(CalDemanar / LotMin)
               CalDemanar = CalDemanar + 1
            Wend
Debug.Print CalDemanar & " = " & St_inicial & " + " & Entrades & " - " & Sortides
            TotalDemanat = TotalDemanat + CalDemanar
            DoEvents
            Stri = CalDemanar & " = " & Demanat & " - (" & St_inicial & "[" & Dinv & "] + " & Entrades & " - " & Sortides & ") " & ")"
            If LotMin <> 1 Then Stri = Stri & " Min(" & LotMin & ")"
            GuardaHistoric botiga, Avui, "Calcul Inventari", ArticleCodiNom(Codi), Stri
            
            ExecutaComandaSql "Update [" & DonamNomTaulaServit(Dema) & "] Set quantitatservida = 0 where  not tipuscomanda=2 and client = " & botiga & " And CodiArticle = " & Codi
            ExecutaComandaSql "Update [" & DonamNomTaulaServit(Dema) & "] Set QuantitatServida = " & CalDemanar & " where  id = (Select top 1 id from  [" & DonamNomTaulaServit(Dema) & "] Where   not tipuscomanda=2 and  client = " & botiga & " And CodiArticle = " & Codi & " Order By QuantitatDemanada ) "
        Else
            Debug.Print " - No Pedido"
        End If
        DoEvents
        rs.MoveNext
    Wend
    rs.Close
    
'    If Botiga = 214 Then
'        Sql = "Select distinct proveedor from ccmateriasprimas m join ccnombrevalor r "
'        Sql = Sql & "on m.id=r.id and r.nombre = 'ReposicionAutomatica'  and r.valor = 'on' join ccnombrevalor b on m.id=r.id and m.id=b.id and left(b.nombre,11) = 'REPOSICION_' join "
'        Sql = Sql & "Clients c on b.nombre = 'REPOSICION_' + cast(c.codi  as nvarchar) join articlespropietats p on p.variable = 'MatPri' and "
'        Sql = Sql & "p.valor = m.id Where c.codi = " & Botiga
'        Set Rs = Db.OpenResultset(Sql)
'        Dim Proveedores()
'        i = 0
'        ReDim Proveedores(0)
'        While Not Rs.EOF
'            i = i + 1
'            ReDim Preserve Proveedores(i)
'            Proveedores(i) = Rs(0)
'            Rs.MoveNext
'        Wend
'        Rs.Close
'        Dim k
'        For k = 1 To i
'            PedidoCalcula CStr(Proveedores(k))
'        Next
'    End If
    
End Sub

Sub ModificaComandesSegonsInventarisBotigaV2(botiga As Double, Avui As Date, Optional FesHo As Boolean = False)
    Dim sql As String, rs As rdoResultset, i As Integer, Codi As Double, Dinv As Date, St_inicial As Double, Entrades As Double, Sortides As Double, Dema As Date, Demanat As Double, CalDemanar As Double, LotMin As Double, TotalDemanat
    Dim prevision, UltimServit As Date, Stri As String
    
    If Hour(Avui) = 0 And Minute(Avui) = 0 And Second(Avui) = 0 Then Avui = Avui + TimeSerial(Hour(Now), Minute(Now), Second(Now))
    
    Dema = DateAdd("d", 1, Avui)
    GuardaHistoric botiga, Avui, "Inventari Calculat V2 :", " Servit = Vendido desde ultim envio"
    
    Debug.Print BotigaCodiNom(botiga)
    InformaMiss "Inventari " & BotigaCodiNom(botiga)
    TotalDemanat = 0
    
    sql = "Select Distinct codiArticle as plu from [" & DonamNomTaulaServit(Dema) & "] where client = " & botiga & " and (left(Viatge,1) = '.' or left(Equip,1) = '.') "
    Set rs = Db.OpenResultset(sql)
    
    While Not rs.EOF
        Codi = rs("Plu")
        Debug.Print "I.per " & ArticleCodiNom(Codi),

        InformaMiss ArticleCodiNom(Codi), True
        If InStr(UCase(ArticleCodiNom(Codi)), UCase("lata")) > 0 Then
            Codi = Codi
        End If
        UltimServit = CalculaServitUltimaData(Codi, botiga, Avui)
        Sortides = CalculaVenut(Codi, botiga, UltimServit, Avui)
        
        ExecutaComandaSql "Update [" & DonamNomTaulaServit(Dema) & "] Set quantitatservida = 0 where  client = " & botiga & " And CodiArticle = " & Codi
        If Sortides > 0 Then
           CalDemanar = Sortides
           LotMin = ArticleCodiLot(Codi)
           If CalDemanar < 0 Then CalDemanar = 0
           If CalDemanar <> Int(CalDemanar) Then CalDemanar = Int(CalDemanar) + 1
           If CalDemanar >= LotMin Then
              CalDemanar = Int(CalDemanar / LotMin) * LotMin
              TotalDemanat = TotalDemanat + CalDemanar
              DoEvents
              Stri = CalDemanar & " = " & Sortides & " Desde  " & UltimServit
              If LotMin <> 1 Then Stri = Stri & " Min(" & LotMin & ")"
              GuardaHistoric botiga, Avui, "Calcul Inventari", ArticleCodiNom(Codi), Stri
              ExecutaComandaSql "Update [" & DonamNomTaulaServit(Dema) & "] Set QuantitatServida = " & CalDemanar & " where  id = (Select top 1 id from  [" & DonamNomTaulaServit(Dema) & "] Where client = " & botiga & " And CodiArticle = " & Codi & " Order By QuantitatDemanada ) "
            Else
              Stri = 0 & " = " & Sortides & " Desde  " & UltimServit
              If LotMin <> 1 Then Stri = Stri & " Min(" & LotMin & ")"
              GuardaHistoric botiga, Avui, "Calcul Inventari", ArticleCodiNom(Codi), Stri
            End If
        Else
            Stri = 0 & " = " & Sortides & " Desde  " & UltimServit
            GuardaHistoric botiga, Avui, "Calcul Inventari", ArticleCodiNom(Codi), Stri
        End If
        DoEvents
        rs.MoveNext
    Wend
    rs.Close
    
End Sub


Sub NetejaInventarisA0(dia As Date)
    Dim sql As String
    
    sql = " delete i from "
    sql = sql & " (select data,botiga,dependenta,tipus_venta from [" & NomTaulaInventari(dia) & "]  "
    sql = sql & "group by data,botiga,dependenta,tipus_venta "
    sql = sql & "having tipus_venta = 1 and sum(quantitat) =0 and dependenta=0 ) a "
    sql = sql & "join [" & NomTaulaInventari(dia) & "] i on  i.data = a.data and i.botiga = a.botiga and i.dependenta = a.dependenta and i.tipus_venta = a.tipus_venta"
    ExecutaComandaSql sql
    
End Sub


Sub ActualitzaFacturatClient(client As Double, D As Date)
    Dim sql As String, rs As rdoResultset, Dff As Date, i As Integer, rs2 As rdoResultset
    
    Set rs = Db.OpenResultset("select * from [" & DonamNomTaulaServit(D) & "] where client = " & client & " and motiumodificacio = ''")
    While Not rs.EOF
        Dff = D
        For i = 1 To 12
            If ExisteixTaula(NomTaulaFacturaData(Dff)) Then
               sql = "Select Distinct d.idfactura  from [" & NomTaulaFacturaData(Dff) & "] d join [" & NomTaulaFacturaIva(Dff) & "] i on d.idfactura = i.idfactura "
               sql = sql & " Where D.producte = " & rs("CodiArticle") & " And D.Client = " & client & " And Year(D.data) = " & Year(D) & "  And Month(D.data) = " & Month(D) & " And Day(D.data) = " & Day(D) & " "
               Set rs2 = Db.OpenResultset(sql)
               If Not rs2.EOF Then
                   ExecutaComandaSql "Update [" & DonamNomTaulaServit(D) & "] set motiumodificacio = '" & rs2(0) & "[TAB:" & NomTaulaFacturaIva(Dff) & "]' where id = '" & rs("Id") & "' "
                   Exit For
               End If
            End If
            Dff = DateAdd("m", 1, Dff)
        Next
        DoEvents
        rs.MoveNext
    Wend
    rs.Close
    
End Sub

Function ArticleCodiLot(a As Double) As Double
    Dim rs As rdoResultset

    Set rs = Db.OpenResultset("select isnull(cast(Valor as nvarchar(255)),0) from ArticlesPropietats where variable = 'LOT_MINIM' and codiarticle = " & a)
    
    ArticleCodiLot = 1
    If Not rs.EOF Then If IsNumeric(rs(0)) Then If rs(0) > 0 Then ArticleCodiLot = rs(0)
    rs.Close
    
End Function

Sub CalculaAcumulatPunts()
   Dim rs As rdoResultset
   
    If Not ExisteixCamp("PuntsAcumulatsMensual", "LastData") Then ExecutaComandaSql "Alter Table PuntsAcumulatsMensual add [LastData] [datetime] NULL"
    ExecutaComandaSql "update PuntsAcumulatsMensual set LastData = dateadd(m,-2,getdate()) where LastData is null "
    ExecutaComandaSql "delete PuntsAcumulatsMensual where not punts=round(punts,0)"
   
 If Day(Now) = 9 And Month(Now) = 7 And Year(Now) = 2007 Then ExecutaComandaSql "delete PuntsAcumulatsMensual where  not  an = 0"
   If Not ExisteixTaula("PuntsAcumulatsMensual") Or (Day(Now) = 9 And Month(Now) = 7 And Year(Now) = 2007) Then
      ExecutaComandaSql "CREATE TABLE [PuntsAcumulatsMensual] ([Client] [nvarchar] (255) NULL ,Mes float,An float,Punts Float )"
      ExecutaComandaSql "update PuntsAcumulatsMensual set LastData = dateadd(m,-2,getdate()) where LastData is null "
      Dim D As Date
      D = DateSerial(2002, 1, 1)
      If ExisteixTaula("PuntsAcumulats") Then
        On Error Resume Next
         Set rs = Db.OpenResultset("select min(data) from PuntsAcumulats ")
         If Not rs.EOF Then If Not IsNull(rs(0)) Then D = DateSerial(Year(rs(0)), Month(rs(0)), 1)
         rs.Close
         ExecutaComandaSql "drop Table PuntsAcumulats "
        On Error GoTo 0
      End If
      
      While D < Now
         AcumulaPuntsMes Year(D), Month(D)
         D = DateAdd("m", 1, D)
      Wend
   End If
   
   Dim sDia As String, SBoti As String
   
   Set rs = Db.OpenResultset("Select distinct param2,Param3 from Feinesafer where tipus = 'AcumulaPunts' ")
   While Not rs.EOF
      If Not IsNull(rs(0)) And Not IsNull(rs(1)) Then
         sDia = Car(rs(0))
         SBoti = Car(rs(1))
         If IsNumeric(sDia) And IsNumeric(SBoti) Then AcumulaPuntsMes CDbl(sDia), CDbl(SBoti)
      End If
      rs.MoveNext
   Wend
   rs.Close
   
' ERROR DE CALCULO, CAL TREURE D AKI UN DIA !!
'AcumulaPuntsMes 2015, 10
'AcumulaPuntsMes 2015, 11
'AcumulaPuntsMes 2015, 12
   
   ExecutaComandaSql "Delete Feinesafer Where tipus = 'AcumulaPunts' "
   
   If Not ExisteixTaula("Punts") Then ExecutaComandaSql "CREATE TABLE [Punts] ([IdClient] [nvarchar] (255) NULL ,[Punts] [float] NULL,data [datetime] NULL,[Punts2] [float] NULL,data2 [datetime] NULL) ON [PRIMARY]"
   InformaMiss "Esborrant Punts Antics"
   ExecutaComandaSql "Delete Punts"
   InformaMiss "Calculant Punts Nous"
   ExecutaComandaSql "Insert Into Punts (Punts,IdClient,Data2) Select sum(Punts) Punts,client IdClient,max(LastData) Data2 from PuntsAcumulatsMensual group by client"
   ExecutaComandaSql "update Punts set Data2 = dateadd(m,-2,getdate()) where Data2 is null "
   ExecutaComandaSql "update Punts set Data2 = dateadd(ss,1,data2) "  ' Afegim un segon pues el toc no mira be la data fi.

'   ExecutaComandaSql "update Punts set Punts = -1 where punts < 0 "
   
   InformaMiss "Punts Ok"
   Missatges_CalEnviar "Resum De Punts", ""
    
End Sub




Sub AcumulaPuntsMes(An As Double, mes As Double)
   Informa2 "Acumulat Punts " & Format(DateSerial(An, mes, 1), "mmmm") & " del " & An
   
   ExecutaComandaSql "CREATE INDEX [" & NomTaulaVentas(DateSerial(An, mes, 1)) & "_Ind_botigadependentanum_tickPludataOtros]   ON [" & NomTaulaVentas(DateSerial(An, mes, 1)) & "]   (botiga,dependenta,num_tick,Plu,data,Otros) WITH (DATA_COMPRESSION = None) "
   
   ExecutaComandaSql "Delete PuntsAcumulatsMensual where an = " & An & " And mes = " & mes
'Posem punts Acumulats
   'ExecutaComandaSql "Insert into PuntsAcumulatsMensual (Client,Punts,An,Mes,LastData) select C1 as client ,round(Sum(c2),0) as IncPu," & An & "," & mes & ",Max(d) from (select substring(Otros,CHARINDEX('[Id:', otros)+4,CHARINDEX(']', otros,CHARINDEX('[Id:', otros))-CHARINDEX('[Id:', otros)-4) as C1, round(sum(import) / 0.03,0,1)  as C2,Max(Data) As D From [" & NomTaulaVentas(DateSerial(An, mes, 1)) & "] V where otros like '%Id:CliBoti_%' and Tipus_venta = 'V' And not otros like '%PagatPerPunts:%' and Plu not in (select CodiArticle from ArticlesPropietats where variable='NoSumaPunts' and valor='on') and Plu not in (select distinct(D_Producte) from " & TaulaProductesPromocionats() & " where ISNUMERIC( d_producte ) = 1) and Plu not in (select distinct(S_Producte) from " & TaulaProductesPromocionats() & " where ISNUMERIC( d_producte ) = 1) group by botiga,num_tick,Plu,data,Otros) Ac Group By C1 "
   ExecutaComandaSql "Insert into PuntsAcumulatsMensual (Client,Punts,An,Mes,LastData) select C1 as client ,round(Sum(c2),0) as IncPu," & An & "," & mes & ",Max(d) from (select substring(Otros,CHARINDEX('[Id:', otros)+4,CHARINDEX(']', otros,CHARINDEX('[Id:', otros))-CHARINDEX('[Id:', otros)-4) as C1, round(sum(import) / 0.03,0,1)  as C2,Max(Data) As D From [" & NomTaulaVentas(DateSerial(An, mes, 1)) & "] V where otros like '%Id:CliBoti_%' and Tipus_venta = 'V' And not otros like '%PagatPerPunts:%' and Plu not in (select CodiArticle from ArticlesPropietats where variable='NoSumaPunts' and valor='on') group by botiga,num_tick,Plu,data,Otros) Ac Group By C1 "

'Posem punts Extras a propietats articles
   ExecutaComandaSql "Insert into PuntsAcumulatsMensual (Client,Punts,An,Mes,LastData) select C1 as client ,round(Sum(c2),0)  as IncPu," & An & "," & mes & ",Max(d) from (select substring(Otros,CHARINDEX('[Id:', otros)+4,CHARINDEX(']', otros,CHARINDEX('[Id:', otros))-CHARINDEX('[Id:', otros)-4) as C1, Sum (P.Valor * Quantitat)      as C2,Max(Data) As D From [" & NomTaulaVentas(DateSerial(An, mes, 1)) & "] V Join ArticlesPropietats  p on p.codiarticle = v.plu and  variable = 'PuntsExtra' where otros like '%Id:CliBoti_%' and Tipus_venta = 'V' And not otros like '%PagatPerPunts:%' group by botiga,num_tick,Plu,data,Otros) Ac Group By C1 "

'Posem punts gastats
   ExecutaComandaSql "Insert into PuntsAcumulatsMensual (Client,Punts,An,Mes,LastData) select C1 as client ,round(Sum(c2),0) as IncPu," & An & "," & mes & ",Max(d) from (select substring(Otros,CHARINDEX('[Id:', otros)+4,CHARINDEX(']', otros,CHARINDEX('[Id:', otros))-CHARINDEX('[Id:', otros)-4) as C1, substring(Otros,CHARINDEX('[PagatPerPunts:', otros)+15,CHARINDEX(']', otros,CHARINDEX('[PagatPerPunts:', otros))-CHARINDEX('[PagatPerPunts:', otros)-15) * -1 as C2,Max(Data) As D From [" & NomTaulaVentas(DateSerial(An, mes, 1)) & "] V where otros like '%Id:CliBoti_%' and not otros like '%PagatPerPunts:Si%'  And otros like '%PagatPerPunts:%'  group by botiga,num_tick,Plu,data,Otros) Ac Group By C1 "
   DoEvents


'PuntsExtra = "0"
'Set Rs = rec("select valor from " & tablaArticlesPropietats() & " where codiArticle='" & Id & "' and variable like 'PuntsExtra'")
'If Not Rs.BOF And Not Rs.EOF Then PuntsExtra = Rs("valor")
   
   
End Sub





Sub CalculaEstadistic(sD As String, SBo As String)
   Dim D As Date, TaunaEst As String, bo As Double, sql As String, WhereBotiga As String, WhereClient As String
   
   bo = Car(SBo)
   D = Cardata(sD)
   Informa2 "Estadistic --> " & BotigaCodiNom(bo) & " " & Format(D, "dd-mm")
   If bo = -1 Then WhereBotiga = " " Else WhereBotiga = "     Botiga = " & bo & " And "
   If bo = -1 Then WhereClient = " " Else WhereClient = " And Client = " & bo & " "
   
   
   TaunaEst = nomTaulaEstadistic(D)
   DoEvents
   ExecutaComandaSql "Delete [" & TaunaEst & "] Where Tipus=1  And Dia = " & Day(D) & WhereClient
   DoEvents
   ExecutaComandaSql "Delete [" & TaunaEst & "] Where Tipus=2  And Dia = " & Day(D) & WhereClient
   DoEvents
   ExecutaComandaSql "Delete [" & TaunaEst & "] Where Tipus=3  And Dia = " & Day(D) & WhereClient
   DoEvents
   
   'Devolucions
   If bo = -1 Then
      sql = "Insert Into [" & TaunaEst & "] (Tipus,Data,Dia,Client,Producte,Quantitat) "
      sql = sql & " Select 1 As Tipus,CONVERT(datetime,'" & Format(D, "dd/mm/yy") & "',3) As Data ," & Day(D) & " As Dia,Botiga As Client,Plu As Producte, (Sum(Quantitat)) As Quantitat From [" & NomTaulaDevol(D) & "] Where " & WhereBotiga & " "
      sql = sql & " Data > CONVERT(datetime,'" & Format(D, "dd/mm/yy") & "',3) And data < CONVERT(datetime,'" & Format(DateAdd("d", 1, D), "dd/mm/yy") & "',3) "
      sql = sql & " Group by plu,Botiga "
   Else
      sql = "Insert Into [" & TaunaEst & "] (Tipus,Data,Dia,Client,Producte,Quantitat) "
      sql = sql & " Select 1 As Tipus,CONVERT(datetime,'" & Format(D, "dd/mm/yy") & "',3) As Data ," & Day(D) & " As Dia," & bo & " As Client,Plu As Producte, (Sum(Quantitat)) As Quantitat From [" & NomTaulaDevol(D) & "] Where " & WhereBotiga & " "
      sql = sql & " Data > CONVERT(datetime,'" & Format(D, "dd/mm/yy") & "',3) And data < CONVERT(datetime,'" & Format(DateAdd("d", 1, D), "dd/mm/yy") & "',3) "
      sql = sql & " Group by plu "
   End If
   ExecutaComandaSql sql
   DoEvents
   'Ventes  Per Producte
   If bo = -1 Then
      sql = "Insert Into [" & TaunaEst & "] (Tipus,Data,Dia,Client,Producte,Quantitat) "
      sql = sql & " Select 2 As Tipus,CONVERT(datetime,'" & Format(D, "dd/mm/yy") & "',3) As Data ," & Day(D) & " As Dia,Botiga As Client,Plu As Producte, (Sum(Quantitat)) As Quantitat From [" & NomTaulaVentas(D) & "] Where "
      sql = sql & " Data >= CONVERT(datetime,'" & Format(D, "dd/mm/yy") & "',3) And data < CONVERT(datetime,'" & Format(DateAdd("d", 1, D), "dd/mm/yy") & "',3) "
      sql = sql & " Group by plu,Botiga "
   Else
      sql = "Insert Into [" & TaunaEst & "] (Tipus,Data,Dia,Client,Producte,Quantitat) "
      sql = sql & " Select 2 As Tipus,CONVERT(datetime,'" & Format(D, "dd/mm/yy") & "',3) As Data ," & Day(D) & " As Dia," & bo & " As Client,Plu As Producte, (Sum(Quantitat)) As Quantitat From [" & NomTaulaVentas(D) & "] Where " & WhereBotiga & " "
      sql = sql & " Data >= CONVERT(datetime,'" & Format(D, "dd/mm/yy") & "',3) And data < CONVERT(datetime,'" & Format(DateAdd("d", 1, D), "dd/mm/yy") & "',3) "
      sql = sql & " Group by plu "
   End If
   ExecutaComandaSql sql
   DoEvents
        
   'Ventes Totals
   If bo = -1 Then
      sql = "Insert Into [" & TaunaEst & "] (Tipus,Data,Dia,Client,Producte,Quantitat) "
      sql = sql & " Select 3 As Tipus,CONVERT(datetime,'" & Format(D, "dd/mm/yy") & "',3) As Data ," & Day(D) & " As Dia,Botiga As Client,count(distinct (cast(num_Tick as nvarchar) + cast(data as nvarchar) + cast(botiga as nvarchar)+ cast(dependenta as nvarchar))) As Producte, (Sum(Import)) As Quantitat From [" & NomTaulaVentas(D) & "] Where "
      sql = sql & " Data >= CONVERT(datetime,'" & Format(D, "dd/mm/yy") & "',3) And data < CONVERT(datetime,'" & Format(DateAdd("d", 1, D), "dd/mm/yy") & "',3) "
      sql = sql & " Group by Botiga "
   Else
      sql = "Insert Into [" & TaunaEst & "] (Tipus,Data,Dia,Client,Producte,Quantitat) "
      sql = sql & " Select 3 As Tipus,CONVERT(datetime,'" & Format(D, "dd/mm/yy") & "',3) As Data ," & Day(D) & " As Dia," & bo & " As Client,count(distinct (cast(num_Tick as nvarchar) + cast(data as nvarchar) + cast(botiga as nvarchar)+ cast(dependenta as nvarchar))) As Producte, (Sum(Import)) As Quantitat From [" & NomTaulaVentas(D) & "] Where " & WhereBotiga & " "
      sql = sql & " Data >= CONVERT(datetime,'" & Format(D, "dd/mm/yy") & "',3) And data < CONVERT(datetime,'" & Format(DateAdd("d", 1, D), "dd/mm/yy") & "',3) "
   End If
   ExecutaComandaSql sql
   DoEvents
        
   ExecutaComandaSql "Delete [" & TaunaEst & "] Where (Tipus=1  Or Tipus=2) And Dia = " & Day(D) & " And Client = " & bo & " And Quantitat < (1/10000) "
   DoEvents
   
   Informa2 "Ok."

End Sub



Sub CalculaIncidencies(Tipus, An, mes, DiaInici, DiaFi, HoraInici, HoraFi, botiga)
   Dim dia As Date, Da1 As Date, Da2 As Date, P As Integer

   dia = DateSerial(An, mes, DiaInici)
   P = InStr(HoraInici, ":")
   Da1 = DateSerial(An, mes, DiaInici) + TimeSerial(Left(HoraInici, P - 1), Right(HoraInici, Len(HoraInici) - P), 0)
   P = InStr(HoraFi, ":")
   Da2 = DateSerial(An, mes, DiaFi) + TimeSerial(Left(HoraFi, P - 1), Right(HoraFi, Len(HoraFi) - P), 0)
   
   CreaTaulesDadesTpv Da1
   Select Case Tipus
      Case "Ventes":
          CalculaIncidenciesAnulats Da1, Da2, botiga
      Case "Caixa":
          CalculaIncidenciesVentesNoTancades Da1, botiga
          CalculaIncidenciesDescuadres Da1, Da2, botiga
   End Select


   
End Sub




Function CalculaServit(Codi As Double, botiga As Double, Di As Date, Df As Date)
    Dim rs As rdoResultset, sql As String, D As Date, Minut As Double, dd As Date
    
    CalculaServit = 0
    D = Di
'    If Hour(Di) > 15 Then D = DateAdd("d", 1, D)
    While DateSerial(Year(D), Month(D), Day(D)) <= DateSerial(Year(Df), Month(Df), Day(Df))
        Set rs = Db.OpenResultset("Select sum(QuantitatServida) Qs,MinutInici From [" & DonamNomTaulaServit(D) & "] s Join viatges on s.viatge = viatges.nom Where client = " & botiga & " And CodiArticle = " & Codi & " Group By MinutInici ")
        
        While Not rs.EOF
            Minut = 15 * 60
            If Not IsNull(rs("MinutInici")) Then Minut = rs("MinutInici")
            dd = DateAdd("n", Minut, DateSerial(Year(D), Month(D), Day(D)))
            If dd >= Di And dd <= Df Then CalculaServit = CalculaServit + rs("Qs")
            rs.MoveNext
        Wend
        rs.Close
        D = DateAdd("d", 1, D)
    Wend
    
    
End Function

Function CalculaServitUltimaData(Codi As Double, botiga As Double, Df As Date) As Date
    Dim rs As rdoResultset, sql As String, D As Date, Minut As Double, dd As Date, i
    
    CalculaServitUltimaData = DateAdd("D", -30, Df)
    For i = 1 To 30
        D = DateAdd("d", -i, Df)
        Set rs = Db.OpenResultset("Select sum(QuantitatServida) Qs,MinutInici From [" & DonamNomTaulaServit(D) & "] s Join viatges on s.viatge = viatges.nom Where client = " & botiga & " And CodiArticle = " & Codi & " Group By MinutInici order by MinutInici Desc ")
        While Not rs.EOF
            If Not IsNull(rs("Qs")) Then
                If rs("Qs") > 0 Then
                    Minut = 15 * 60
                    If Not IsNull(rs("MinutInici")) Then Minut = rs("MinutInici")
                    dd = DateAdd("n", Minut, DateSerial(Year(D), Month(D), Day(D)))
                    CalculaServitUltimaData = dd
                    Exit For
                End If
            End If
            rs.MoveNext
        Wend
        rs.Close
    Next
    
End Function


Function CalculaDemanat(Codi As Double, botiga As Double, Di As Date, Df As Date)
    Dim rs As rdoResultset, sql As String, D As Date
    
    CalculaDemanat = 0
    D = Di
    While D <= Df
        Set rs = Db.OpenResultset("Select isnull(sum(QuantitatDemanada),0) From [" & DonamNomTaulaServit(D) & "] Where (left(viatge,1) = '.' or left(equip,1) = '.') And client = " & botiga & " And CodiArticle = " & Codi)
        If Not rs.EOF Then If Not IsNull(rs(0)) Then CalculaDemanat = CalculaDemanat + rs(0)
        rs.Close
        D = DateAdd("d", 1, D)
    Wend
    
    
End Function
Function CalculaVenutPaso2(Codi As Double, botiga As Double, Di As Date, Df As Date)
    Dim rs As rdoResultset, sql As String, D As Date
    Dim Q As rdoQuery, LlistaEquivalents As String, rs2, cCodi As Double
    
    CalculaVenutPaso2 = 0
        
        D = Di
        While DateSerial(Year(D), Month(D), Day(D)) <= DateSerial(Year(Df), Month(Df), Day(Df))
            Set Q = Db.CreateQuery("", "Select isnull(sum(Quantitat),0) Quantitat From [" & NomTaulaVentas(D) & "] Where Botiga = " & botiga & " And Plu = " & Codi & " And Data >= ? And Data <= ? And Day(Data) = " & Day(D) & " ")
            Q.rdoParameters(0) = Di
            Q.rdoParameters(1) = Df
            Set rs = Q.OpenResultset
            If Not rs.EOF Then If Not IsNull(rs(0)) Then CalculaVenutPaso2 = CalculaVenutPaso2 + (rs(0))
            rs.Close
            D = DateAdd("d", 1, D)
        Wend
    
        D = Di
        While DateSerial(Year(D), Month(D), Day(D)) <= DateSerial(Year(Df), Month(Df), Day(Df))
            Set Q = Db.CreateQuery("", "Select isnull(sum(Quantitat),0) Quantitat From [" & NomTaulaDevol(D) & "] Where Botiga = " & botiga & " And Plu = " & Codi & " And Data > ? And Data < ? And Day(Data) = " & Day(D) & " ")
            Q.rdoParameters(0) = Di
            Q.rdoParameters(1) = Df
            Set rs = Q.OpenResultset
            If Not rs.EOF Then If Not IsNull(rs(0)) Then CalculaVenutPaso2 = CalculaVenutPaso2 + (rs(0))
            rs.Close
            D = DateAdd("d", 1, D)
        Wend
    
End Function






Function PedidoCalculaVenutPaso2(Codi As Double, botiga As Double, Di As Date, Df As Date)
    Dim rs As rdoResultset, sql As String, D As Date
    Dim Q As rdoQuery, LlistaEquivalents As String, rs2, cCodi As Double
    Dim T1 As Double, T2 As Double
    
    PedidoCalculaVenutPaso2 = 0
    
    D = Di
    While DateSerial(Year(D), Month(D), 1) <= DateSerial(Year(Df), Month(Df), 1)
'        Set Q = Db.CreateQuery("", "Select sum(Quantitat) From [" & NomTaulaVentas(D) & "] with (nolock)  Where Botiga = " & Botiga & " And Plu = " & Codi & " And Data >= ? And Data <= ? ")
'        Q.rdoParameters(0) = Di
'        Q.rdoParameters(1) = Df
'        Set Rs = Q.OpenResultset
'        If Not Rs.EOF Then
'            If Not IsNull(Rs(0)) Then
'                t1 = Rs(0)
'                Set Q = Db.CreateQuery("", "Select sum(Quantitat) From [" & NomTaulaVentas(D) & "] with (nolock)  Where Botiga = " & Botiga & " And (Plu = " & Codi & " or FormaMarcar Like '%," & Codi & "' ) And Data >= ? And Data <= ? ")
'                Q.rdoParameters(0) = Di
'                Q.rdoParameters(1) = Df
'                Set Rs = Q.OpenResultset
'                t2 = Rs(0)
'            End If
'        End If
'
'        If Not t1 = t2 Then
'           t1 = t2
'        End If
    
    
    
        Set Q = Db.CreateQuery("", "Select sum(Quantitat) From [" & NomTaulaVentas(D) & "] with (nolock)  Where Botiga = " & botiga & " And (Plu = " & Codi & " or FormaMarcar like '%," & Codi & "' or FormaMarcar like '%," & Codi & ",%') And Data >= ? And Data <= ? ")
        Q.rdoParameters(0) = Di
        Q.rdoParameters(1) = Df
        Set rs = Q.OpenResultset
        If Not rs.EOF Then If Not IsNull(rs(0)) Then PedidoCalculaVenutPaso2 = PedidoCalculaVenutPaso2 + (rs(0))
        rs.Close
        D = DateAdd("m", 1, D)
    Wend
    
End Function

Function PedidoCalculaVenutPaso2_91(Codi As Double, botiga As Double, Di As Date, Df As Date, Optional consumoPersonal As Boolean) As Double
    Dim rs As rdoResultset, D As Date
    Dim Q As rdoQuery
    Dim sql As String
    
    PedidoCalculaVenutPaso2_91 = 0
    
    D = Di
    While DateSerial(Year(D), Month(D), 1) <= DateSerial(Year(Df), Month(Df), 1)
        sql = "Select sum(Quantitat) From [" & NomTaulaVentas(D) & "] with (nolock)  Where Botiga = " & botiga & " And (Plu = " & Codi & " or FormaMarcar like '%," & Codi & "' or FormaMarcar like '%," & Codi & ",%') And Data >= ? And Data <= ? "
        If consumoPersonal Then
            sql = sql & " and (tipus_venta = 'Desc_100' or (tipus_venta = '100' and otros not like '%PagatPerPunts%')) "
        'Else
        '    Sql = Sql & " and not (tipus_venta = 'Desc_100' or (tipus_venta = '100' and otros not like '%PagatPerPunts%')) "
        End If
        
        Set Q = Db.CreateQuery("", sql)
        Q.rdoParameters(0) = Di
        Q.rdoParameters(1) = Df
        Set rs = Q.OpenResultset
        If Not rs.EOF Then If Not IsNull(rs(0)) Then PedidoCalculaVenutPaso2_91 = PedidoCalculaVenutPaso2_91 + (rs(0))
        rs.Close
        
        D = DateAdd("m", 1, D)
    Wend
    
End Function






Function PedidoCalculaVenutPaso2_V2(Codi As Double, botiga As Double, Di As Date, Df As Date, Optional consumoPersonal As Boolean) As Double
    Dim rs As rdoResultset, D As Date
    Dim Q As rdoQuery
    Dim sql As String
    
    PedidoCalculaVenutPaso2_V2 = 0
    
    D = Di
    While DateSerial(Year(D), Month(D), 1) <= DateSerial(Year(Df), Month(Df), 1)
        sql = "Select sum(Quantitat) From [" & NomTaulaVentas(D) & "] with (nolock)  Where Botiga = " & botiga & " And (Plu = " & Codi & " or FormaMarcar like '%," & Codi & "' or FormaMarcar like '%," & Codi & ",%') And Data >= ? And Data <= ? "
        If consumoPersonal Then
            sql = sql & " and (tipus_venta = 'Desc_100' or (tipus_venta = '100' and otros not like '%PagatPerPunts%')) "
        'Else
        '    Sql = Sql & " and not (tipus_venta = 'Desc_100' or (tipus_venta = '100' and otros not like '%PagatPerPunts%')) "
        End If
        
        Set Q = Db.CreateQuery("", sql)
        Q.rdoParameters(0) = Di
        Q.rdoParameters(1) = Df
        Set rs = Q.OpenResultset
        If Not rs.EOF Then If Not IsNull(rs(0)) Then PedidoCalculaVenutPaso2_V2 = PedidoCalculaVenutPaso2_V2 + (rs(0))
        rs.Close
        
        D = DateAdd("m", 1, D)
    Wend
    
End Function







Function EncarregatsServitsFaltanPaso2(Codi As Double, botiga As Double, Di As Date, Df As Date)
    Dim rs As rdoResultset, sql As String, D As Date, Dff As Date
    Dim Q As rdoQuery, LlistaEquivalents As String, rs2, cCodi As Double

    EncarregatsServitsFaltanPaso2 = 0
    
    D = Di
    Dff = DateAdd("d", -1, Df)
    While DateSerial(Year(D), Month(D), Day(D)) <= DateSerial(Year(Dff), Month(Dff), Day(Dff))
        Set rs = Db.OpenResultset("Select sum(QuantitatServida) From [" & DonamNomTaulaServit(D) & "] with (nolock)  Where Client = " & botiga & " And CodiArticle = " & Codi & " and tipuscomanda=1  and comentari not like '%Reposicio%'")
        If Not rs.EOF Then If Not IsNull(rs(0)) Then EncarregatsServitsFaltanPaso2 = EncarregatsServitsFaltanPaso2 + (rs(0))
        rs.Close
        D = DateAdd("d", 1, D)
    Wend
    
End Function
Function EncarregatsServitsFaltanPaso2_91(Codi As Double, botiga As Double, Di As Date, Df As Date) As Double
    Dim rs As rdoResultset, D As Date, Dff As Date
    Dim Q As rdoQuery

    EncarregatsServitsFaltanPaso2_91 = 0
    
    D = Di
    Dff = DateAdd("d", -1, Df)
    While DateSerial(Year(D), Month(D), Day(D)) <= DateSerial(Year(Dff), Month(Dff), Day(Dff))
        Set rs = Db.OpenResultset("Select sum(QuantitatServida) From [" & DonamNomTaulaServit(D) & "] with (nolock)  Where Client = " & botiga & " And CodiArticle = " & Codi & " and tipuscomanda=1  and comentari not like '%Reposicio%'")
        If Not rs.EOF Then If Not IsNull(rs(0)) Then EncarregatsServitsFaltanPaso2_91 = EncarregatsServitsFaltanPaso2_91 + (rs(0))
        rs.Close
        D = DateAdd("d", 1, D)
    Wend
    
End Function









Function EncarregatsServitsFaltanPaso2_V2(Codi As Double, botiga As Double, Di As Date, Df As Date) As Double
    Dim rs As rdoResultset, D As Date, Dff As Date
    Dim Q As rdoQuery

    EncarregatsServitsFaltanPaso2_V2 = 0
    
    D = Di
    Dff = DateAdd("d", -1, Df)
    While DateSerial(Year(D), Month(D), Day(D)) <= DateSerial(Year(Dff), Month(Dff), Day(Dff))
        Set rs = Db.OpenResultset("Select sum(QuantitatServida) From [" & DonamNomTaulaServit(D) & "] with (nolock)  Where Client = " & botiga & " And CodiArticle = " & Codi & " and tipuscomanda=1  and comentari not like '%Reposicio%'")
        If Not rs.EOF Then If Not IsNull(rs(0)) Then EncarregatsServitsFaltanPaso2_V2 = EncarregatsServitsFaltanPaso2_V2 + (rs(0))
        rs.Close
        D = DateAdd("d", 1, D)
    Wend
    
End Function









Function PedidoCalculaDevolPaso2(Codi As Double, botiga As Double, Di As Date, Df As Date)
    Dim rs As rdoResultset, sql As String, D As Date
    Dim Q As rdoQuery, LlistaEquivalents As String, rs2, cCodi As Double
    
    PedidoCalculaDevolPaso2 = 0
    
    D = Di
    While DateSerial(Year(D), Month(D), 1) <= DateSerial(Year(Df), Month(Df), 1)
        Set Q = Db.CreateQuery("", "Select sum(Quantitat) From [" & NomTaulaDevol(D) & "] with (nolock)  Where Botiga = " & botiga & " And Plu = " & Codi & " And Data >= ? And Data <= ? ")
        Q.rdoParameters(0) = Di
        Q.rdoParameters(1) = Df
        Set rs = Q.OpenResultset
        If Not rs.EOF Then
            If Not IsNull(rs(0)) Then
                PedidoCalculaDevolPaso2 = PedidoCalculaDevolPaso2 + (rs(0))
            End If
        End If
        rs.Close
        D = DateAdd("m", 1, D)
    Wend
    
End Function
Function PedidoCalculaDevolPaso2_91(Codi As Double, botiga As Double, Di As Date, Df As Date) As Double
    Dim rs As rdoResultset, D As Date
    Dim Q As rdoQuery
    
    PedidoCalculaDevolPaso2_91 = 0
    
    D = Di
    While DateSerial(Year(D), Month(D), 1) <= DateSerial(Year(Df), Month(Df), 1)
        Set Q = Db.CreateQuery("", "Select sum(Quantitat) From [" & NomTaulaDevol(D) & "] with (nolock)  Where Botiga = " & botiga & " And Plu = " & Codi & " And Data >= ? And Data <= ? ")
        Q.rdoParameters(0) = Di
        Q.rdoParameters(1) = Df
        Set rs = Q.OpenResultset
        If Not rs.EOF Then
            If Not IsNull(rs(0)) Then
                PedidoCalculaDevolPaso2_91 = PedidoCalculaDevolPaso2_91 + (rs(0))
            End If
        End If
        rs.Close
        D = DateAdd("m", 1, D)
    Wend
    
End Function









Function PedidoCalculaDevolPaso2_V2(Codi As Double, botiga As Double, Di As Date, Df As Date) As Double
    Dim rs As rdoResultset, D As Date
    Dim Q As rdoQuery
    
    PedidoCalculaDevolPaso2_V2 = 0
    
    D = Di
    While DateSerial(Year(D), Month(D), 1) <= DateSerial(Year(Df), Month(Df), 1)
        Set Q = Db.CreateQuery("", "Select sum(Quantitat) From [" & NomTaulaDevol(D) & "] with (nolock)  Where Botiga = " & botiga & " And Plu = " & Codi & " And Data >= ? And Data <= ? ")
        Q.rdoParameters(0) = Di
        Q.rdoParameters(1) = Df
        Set rs = Q.OpenResultset
        If Not rs.EOF Then
            If Not IsNull(rs(0)) Then
                PedidoCalculaDevolPaso2_V2 = PedidoCalculaDevolPaso2_V2 + (rs(0))
            End If
        End If
        rs.Close
        D = DateAdd("m", 1, D)
    Wend
    
End Function









Sub PedidoCuantosFaltanNumTicks(Codi As Double, botiga As Double, Di As Date, Df As Date, Tp As Double, Tu As Double, Tn As Double)
    Dim rs As rdoResultset, sql As String, D As Date
    Dim Q As rdoQuery, LlistaEquivalents As String, rs2, cCodi As Double
    
On Error GoTo nor
    
    Tp = 0
    Tu = 0
    Tn = 0
    
'    D = Di
'    While DateSerial(Year(D), Month(D), Day(D)) <= DateSerial(Year(Df), Month(Df), Day(Df))
        Set Q = Db.CreateQuery("", "Select Min(Num_Tick) Tp ,max(Num_Tick) Tu ,Count(distinct Num_Tick) Tn From [" & NomTaulaVentas(Di) & "] Where Botiga = " & botiga & " And Data >= ? And Data <= ?  ")
        Q.rdoParameters(0) = Di
        Q.rdoParameters(1) = Df
        Set rs = Q.OpenResultset
        Tp = rs("Tp")
        Tu = rs("Tu")
        Tn = rs("Tn")
        rs.Close
'        D = DateAdd("d", 1, D)
'    Wend
nor:

End Sub

Sub PedidoCuantosFaltanNumTicks_91(Codi As Double, botiga As Double, Di As Date, Df As Date, Tp As Double, Tu As Double, Tn As Double)
    Dim rs As rdoResultset
    Dim Q As rdoQuery
    
On Error GoTo nor
    
    Tp = 0
    Tu = 0
    Tn = 0
    
    Set Q = Db.CreateQuery("", "Select Min(Num_Tick) Tp ,max(Num_Tick) Tu ,Count(distinct Num_Tick) Tn From [" & NomTaulaVentas(Di) & "] Where Botiga = " & botiga & " And Data >= ? And Data <= ?  ")
    Q.rdoParameters(0) = Di
    Q.rdoParameters(1) = Df
    Set rs = Q.OpenResultset
    Tp = rs("Tp")
    Tu = rs("Tu")
    Tn = rs("Tn")
    rs.Close
        
nor:

End Sub
Sub PedidoCuantosFaltanNumTicks_V2(Codi As Double, botiga As Double, Di As Date, Df As Date, Tp As Double, Tu As Double, Tn As Double)
    Dim rs As rdoResultset
    Dim Q As rdoQuery
    
On Error GoTo nor
    
    Tp = 0
    Tu = 0
    Tn = 0
    
    Set Q = Db.CreateQuery("", "Select Min(Num_Tick) Tp ,max(Num_Tick) Tu ,Count(distinct Num_Tick) Tn From [" & NomTaulaVentas(Di) & "] Where Botiga = " & botiga & " And Data >= ? And Data <= ?  ")
    Q.rdoParameters(0) = Di
    Q.rdoParameters(1) = Df
    Set rs = Q.OpenResultset
    Tp = rs("Tp")
    Tu = rs("Tu")
    Tn = rs("Tn")
    rs.Close
        
nor:

End Sub








Function CalculaVenut(Codi As Double, botiga As Double, Di As Date, Df As Date)
    Dim rs As rdoResultset, sql As String, D As Date, factor As Double
    Dim Q As rdoQuery, LlistaEquivalents As String, rs2, cCodi As Double
    
    CalculaVenut = CalculaVenutPaso2(Codi, botiga, Di, Df)

    Set rs2 = Db.OpenResultset("select prodvenut,unitatsequivalencia  from equivalenciaproductes where prodservit = " & Codi)
    While Not rs2.EOF
        cCodi = rs2("prodvenut")
        factor = rs2("unitatsequivalencia")
        CalculaVenut = factor * CalculaVenutPaso2(cCodi, botiga, Di, Df)
        rs2.MoveNext
    Wend
    
End Function







Function PedidoCalculaVenut(Codi As Double, botiga As Double, Di As Date, Df As Date)
    Dim rs As rdoResultset, sql As String, D As Date, factor As Double
    Dim Q As rdoQuery, LlistaEquivalents As String, rs2, cCodi As Double
    
    PedidoCalculaVenut = PedidoCalculaVenutPaso2(Codi, botiga, Di, Df)

    Set rs2 = Db.OpenResultset("select prodvenut,unitatsequivalencia  from equivalenciaproductes where prodservit = " & Codi)
    While Not rs2.EOF
        cCodi = rs2("prodvenut")
        If InStr(JaMirats, cCodi) = 0 Then
            JaMirats = JaMirats & "," & cCodi & ","
            factor = rs2("unitatsequivalencia")
            PedidoCalculaVenut = PedidoCalculaVenut + (factor * PedidoCalculaVenut(cCodi, botiga, Di, Df))
        End If
        rs2.MoveNext
    Wend
    
End Function
Function PedidoCalculaVenut_91(Codi As Double, botiga As Double, Di As Date, Df As Date, Optional consumoPersonal As Boolean) As Double
    Dim rs As rdoResultset, sql As String, factor As Double, cCodi As Double
    
    PedidoCalculaVenut_91 = PedidoCalculaVenutPaso2_91(Codi, botiga, Di, Df, consumoPersonal)

    Set rs = Db.OpenResultset("select prodvenut,unitatsequivalencia  from equivalenciaproductes where prodservit = " & Codi)
    While Not rs.EOF
        cCodi = rs("prodvenut")
        If InStr(JaMirats, cCodi) = 0 Then
            JaMirats = JaMirats & "," & cCodi & ","
            factor = rs("unitatsequivalencia")
            PedidoCalculaVenut_91 = PedidoCalculaVenut_91 + (factor * PedidoCalculaVenut_91(cCodi, botiga, Di, Df, consumoPersonal))
        End If
        rs.MoveNext
    Wend
    
End Function

Function PedidoCalculaVenut_V2(Codi As Double, botiga As Double, Di As Date, Df As Date, Optional consumoPersonal As Boolean) As Double
    Dim rs As rdoResultset, sql As String, factor As Double, cCodi As Double
    
    PedidoCalculaVenut_V2 = PedidoCalculaVenutPaso2_V2(Codi, botiga, Di, Df, consumoPersonal)

    Set rs = Db.OpenResultset("select prodvenut,unitatsequivalencia  from equivalenciaproductes where prodservit = " & Codi)
    While Not rs.EOF
        cCodi = rs("prodvenut")
        If InStr(JaMirats, cCodi) = 0 Then
            JaMirats = JaMirats & "," & cCodi & ","
            factor = rs("unitatsequivalencia")
            PedidoCalculaVenut_V2 = PedidoCalculaVenut_V2 + (factor * PedidoCalculaVenut_V2(cCodi, botiga, Di, Df, consumoPersonal))
        End If
        rs.MoveNext
    Wend
    
End Function








Function EncarregatsServitsFaltan(Codi As Double, botiga As Double, Di As Date, Df As Date)
    Dim rs As rdoResultset, sql As String, D As Date, factor As Double
    Dim Q As rdoQuery, LlistaEquivalents As String, rs2, cCodi As Double
    
    EncarregatsServitsFaltan = EncarregatsServitsFaltanPaso2(Codi, botiga, Di, Df)

    Set rs2 = Db.OpenResultset("select prodvenut,unitatsequivalencia  from equivalenciaproductes where prodservit = " & Codi)
    While Not rs2.EOF
        cCodi = rs2("prodvenut")
        If InStr(JaMirats, cCodi) = 0 Then
            JaMirats = JaMirats & "," & cCodi & ","
            factor = rs2("unitatsequivalencia")
            EncarregatsServitsFaltan = EncarregatsServitsFaltan + (factor * EncarregatsServitsFaltan(cCodi, botiga, Di, Df))
        End If
        rs2.MoveNext
    Wend
    
End Function










Function EncarregatsServitsFaltan_91(Codi As Double, botiga As Double, Di As Date, Df As Date) As Double
    Dim rs As rdoResultset, factor As Double
    Dim cCodi As Double
    
    EncarregatsServitsFaltan_91 = EncarregatsServitsFaltanPaso2_91(Codi, botiga, Di, Df)

    Set rs = Db.OpenResultset("select prodvenut,unitatsequivalencia  from equivalenciaproductes where prodservit = " & Codi)
    While Not rs.EOF
        cCodi = rs("prodvenut")
        If InStr(JaMirats, cCodi) = 0 Then
            JaMirats = JaMirats & "," & cCodi & ","
            factor = rs("unitatsequivalencia")
            EncarregatsServitsFaltan_91 = EncarregatsServitsFaltan_91 + (factor * EncarregatsServitsFaltan_91(cCodi, botiga, Di, Df))
        End If
        rs.MoveNext
    Wend
    
End Function

Function EncarregatsServitsFaltan_V2(Codi As Double, botiga As Double, Di As Date, Df As Date) As Double
    Dim rs As rdoResultset, factor As Double
    Dim cCodi As Double
    
    EncarregatsServitsFaltan_V2 = EncarregatsServitsFaltanPaso2_V2(Codi, botiga, Di, Df)

    Set rs = Db.OpenResultset("select prodvenut,unitatsequivalencia  from equivalenciaproductes where prodservit = " & Codi)
    While Not rs.EOF
        cCodi = rs("prodvenut")
        If InStr(JaMirats, cCodi) = 0 Then
            JaMirats = JaMirats & "," & cCodi & ","
            factor = rs("unitatsequivalencia")
            EncarregatsServitsFaltan_V2 = EncarregatsServitsFaltan_V2 + (factor * EncarregatsServitsFaltan_V2(cCodi, botiga, Di, Df))
        End If
        rs.MoveNext
    Wend
    
End Function
Function PedidoCalculaDevol(Codi As Double, botiga As Double, Di As Date, Df As Date)

    Dim rs As rdoResultset, sql As String, D As Date, factor As Double
    Dim Q As rdoQuery, LlistaEquivalents As String, rs2, cCodi As Double
    
    PedidoCalculaDevol = PedidoCalculaDevolPaso2(Codi, botiga, Di, Df)

    Set rs2 = Db.OpenResultset("select prodvenut,unitatsequivalencia  from equivalenciaproductes where prodservit = " & Codi)
    While Not rs2.EOF
        cCodi = rs2("prodvenut")
        If InStr(JaMirats, cCodi) = 0 Then
            JaMirats = JaMirats & "," & cCodi & ","
            factor = rs2("unitatsequivalencia")
            PedidoCalculaDevol = PedidoCalculaDevol + (factor * PedidoCalculaDevol(cCodi, botiga, Di, Df))
        End If
        rs2.MoveNext
    Wend
    
End Function
Function PedidoCalculaDevol_91(Codi As Double, botiga As Double, Di As Date, Df As Date)

    Dim rs As rdoResultset, factor As Double, cCodi As Double
    
    PedidoCalculaDevol_91 = PedidoCalculaDevolPaso2_91(Codi, botiga, Di, Df)

    Set rs = Db.OpenResultset("select prodvenut, unitatsequivalencia from equivalenciaproductes where prodservit = " & Codi)
    While Not rs.EOF
        cCodi = rs("prodvenut")
        If InStr(JaMirats, cCodi) = 0 Then
            JaMirats = JaMirats & "," & cCodi & ","
            factor = rs("unitatsequivalencia")
            PedidoCalculaDevol_91 = PedidoCalculaDevol_91 + (factor * PedidoCalculaDevol_91(cCodi, botiga, Di, Df))
        End If
        rs.MoveNext
    Wend
    
End Function









Function PedidoCalculaDevol_V2(Codi As Double, botiga As Double, Di As Date, Df As Date)

    Dim rs As rdoResultset, factor As Double, cCodi As Double
    
    PedidoCalculaDevol_V2 = PedidoCalculaDevolPaso2_V2(Codi, botiga, Di, Df)

    Set rs = Db.OpenResultset("select prodvenut, unitatsequivalencia from equivalenciaproductes where prodservit = " & Codi)
    While Not rs.EOF
        cCodi = rs("prodvenut")
        If InStr(JaMirats, cCodi) = 0 Then
            JaMirats = JaMirats & "," & cCodi & ","
            factor = rs("unitatsequivalencia")
            PedidoCalculaDevol_V2 = PedidoCalculaDevol_V2 + (factor * PedidoCalculaDevol_V2(cCodi, botiga, Di, Df))
        End If
        rs.MoveNext
    Wend
    
End Function










Function Cardata(Dates As String) As Date
   Dim L As String, p1 As Integer, P2 As Integer, P3 As Integer, An, Ms, Di
   
   L = Car(Dates)
   
   p1 = InStr(L, "-")
   If p1 > 0 Then P2 = InStr(p1 + 1, L, "-")
   If P2 > 0 Then P3 = InStr(P2 + 1, L, "-")
   
   Cardata = DateSerial(Mid(L, P2 + 1, Len(L) - P2), Mid(L, p1 + 1, P2 - p1 - 1), Mid(L, 1, p1 - 1))


End Function


Sub ExportaHoresBotigaVell(QInd As rdoQuery, Qdel As rdoQuery, HoraInici As Date, HoraFi As Date, botiga)
   Dim dia As Date, Da1 As Date, Da2 As Date, P As Integer, rs As rdoResultset, BotigaNom As String

   BotigaNom = BotigaCodiNom(botiga)
   QInd.rdoParameters(0) = botiga
   Qdel.rdoParameters(0) = botiga
   
   If Not ExisteixTaula(NomTaulaHoraris(HoraInici)) Then Exit Sub
   
   Set rs = Db.OpenResultset("Select * from [" & NomTaulaHoraris(HoraInici) & "] Where Botiga = " & botiga & " And Data >= " & SqlDataMinute(HoraInici) & " And Data <= " & SqlDataMinute(HoraFi) & " ")
   While Not rs.EOF
      QInd.rdoParameters(1) = rs("Dependenta")
      Qdel.rdoParameters(1) = rs("Dependenta")
      QInd.rdoParameters(2) = rs("Data")
      Qdel.rdoParameters(2) = rs("Data")
      If rs("Operacio") = "E" Then
         QInd.rdoParameters(3) = 1
         Qdel.rdoParameters(3) = 1
      Else
         QInd.rdoParameters(3) = 2
         Qdel.rdoParameters(3) = 2
      End If
      QInd.rdoParameters(4) = BotigaNom
      QInd.rdoParameters(5) = DependentaCodiNom(rs("Dependenta"))
      
      Qdel.Execute
      QInd.Execute
      rs.MoveNext
   Wend
   rs.Close
      
End Sub
Sub ExportaHoresBotiga(QInd As rdoQuery, Qdel As rdoQuery, HoraInici As Date, HoraFi As Date, botiga)
    Dim dia As Date, Da1 As Date, Da2 As Date, P As Integer, rs As rdoResultset, BotigaNom As String, Idr As String
    Dim fechaStr As String, fecha As Date
    Dim rsCdp As rdoResultset
    
    '   Set QIns = db3.CreateQuery("", "insert into CdpDadesFichador (Id,TmSt,Accio,Usuari,Idr,Editor,Historial,Lloc,Comentari) values (?,?,?,?,?,?,?,?,?)")
    '   Set QDel = db3.CreateQuery("", "Delete CdpDadesFichador Where idr = ? ")
    
    BotigaNom = BotigaCodiNom(botiga)
    'Qdel.rdoParameters(0) = 0
    QInd.rdoParameters(0) = 0
    QInd.rdoParameters(5) = botiga
    QInd.rdoParameters(6) = BotigaCodiNom(botiga)
    
    If Not ExisteixTaula(NomTaulaHoraris(HoraInici)) Then Exit Sub
    
    Set rs = Db.OpenResultset("Select * from [" & NomTaulaHoraris(HoraInici) & "] Where Botiga = " & botiga & " And Data >= " & SqlDataMinute(HoraInici) & " And Data <= " & SqlDataMinute(HoraFi) & " ")
    While Not rs.EOF
        fecha = CDate(rs("Data"))
        fechaStr = Right("0" & Day(fecha), 2) & "/" & Right("0" & Month(fecha), 2) & "/" & Year(fecha) & " " & Right("0" & Hour(fecha), 2) & ":" & Right("0" & Minute(fecha), 2) & ":" & Right("0" & Second(fecha), 2)
        Idr = "auto_" & rs("Dependenta") & fechaStr & botiga
        
        Set rsCdp = Db.OpenResultset("select * from cdpDadesFichador where idr='" & Idr & "'")
        If rsCdp.EOF Then
            'Qdel.rdoParameters(0) = Idr
            
            QInd.rdoParameters(1) = rs("Data")
            QInd.rdoParameters(3) = rs("Dependenta")
            QInd.rdoParameters(4) = Idr
            
            If rs("Operacio") = "E" Then
            QInd.rdoParameters(2) = 1
            ElseIf rs("Operacio") = "P" Then
            QInd.rdoParameters(2) = 2
            ElseIf rs("Operacio") = "I" Then
            QInd.rdoParameters(2) = 3
            ElseIf rs("Operacio") = "F" Then
            QInd.rdoParameters(2) = 4
            Else
            QInd.rdoParameters(2) = 2
            End If
            
            'Qdel.Execute
            QInd.Execute
        End If
      rs.MoveNext
   Wend
   rs.Close
      
End Sub

Sub FeinesPerFerAFinalDeMes()
    RepassaDadesDelMes Now
End Sub

Sub FeinesPerFerAPrincipiDeMes()
    RepassaDadesDelMes DateAdd("d", -15, Now)
End Sub

Sub FesFeinesPerFerAlVespre()
    InformaMiss "Feines del Vespre "
    
    InformaMiss "Fes Feines Per Fer Al Vespre"
    
    CalculaAcumulatPunts
    
    'ESTO ES NECESARIO????????
    previsions
        
    'If UCase(EmpresaActual) = UCase("Tena") Then ModificaComandesSegonsInventaris
    'If (UCase(EmpresaActual) = UCase("Tena") Or UCase(EmpresaActual) = UCase("Hitrs")) And DatePart("w", Now()) = vbSunday Then
    If (UCase(EmpresaActual) = UCase("Tena") Or UCase(EmpresaActual) = UCase("Hitrs") Or UCase(EmpresaActual) = UCase("Pa Natural")) Then
        fesCopiaQuadrantsTorns
    End If
    
'    If UCase(EmpresaActual) = UCase("Pa Natural") Then ModificaComandesSegonsInventaris
    
    If UCase(EmpresaActual) <> UCase("Merce") And UCase(EmpresaActual) <> UCase("Guix") Then ActualitzaSaldo 0, Year(Now)
    
    ActualitzaDependentesClientsFinals
    
    If UCase(EmpresaActual) = UCase("Panet") Then
        RecalculaNumFacturaVendes
    End If
    
    ExecutaComandaSql "delete from articles_zombis where codi in (select codi from articles)"
    ExecutaComandaSql "delete from archivo where tmp = 1 "
    ExecutaComandaSql "delete  archivo  where tmp = 1"
    ExecutaComandaSql "drop table  tpvinforma "
    ExecutaComandaSql "drop table  TaulaTpvInforma "
    ExecutaComandaSql "delete from PingMaquina where DATEDIFF(d,tmst,getdate()) > 5 and TmSt not in (select MAX(tmst) tmst from PingMaquina Where Llicencia = PingMaquina.Llicencia group by convert(datetime,CONVERT(nvarchar(10),tmst,101)),llicencia)"
    ExecutaComandaSql "delete from PingMaquina where DATEDIFF(d,tmst,getdate()) > 5"
    'ExecutaComandaSql "delete from ArchivoLines "
    'ExecutaComandaSql "delete from archivo  where tmp=1 "

    If UCase(EmpresaActual) = UCase("Panet") Then RebaixaEstocksMateriesPrimeres
    If UCase(EmpresaActual) = UCase("Pos3") Then RebaixaEstocksConjelador
    
End Sub

Sub FesFeinesPerFerAles5()
   InformaMiss "Feines de les 5h "

'   If UCase(EmpresaActual) = UCase("Tena") Then ModificaComandesSegonsInventaris
'   If UCase(EmpresaActual) = UCase("Pa Natural") Then ModificaComandesSegonsInventaris
 '   If UCase(EmpresaActual) = UCase("LaForneria") Then SincroDbVendesAmetllerCheck
 '  ProcessMatinal
   
End Sub

Sub FesFeinesPerFerCada10Min()
   Dim rs As rdoResultset, EmailAvi As String, llicencia, nomBot As String
   
   InformaMiss "RecalculaObjectiusDeVenda"
   
   RecalculaObjectiusDeVenda
   RecalculaObjectiusDeClients
   'RecalculaObjectiusDeVenda2
   
   
'   If Not ExisteixTaula("PingMaquina") Then ExecutaComandaSql "CREATE TABLE [PingMaquina](   [Id] [nvarchar](255) NULL,   [Llicencia] [float] NULL,   [TmSt] [datetime] NULL,   [Param1] [nvarchar](255) NULL,   [Param2] [nvarchar](255) NULL,    [Param3] [nvarchar](255) NULL ) ON [PRIMARY]"
'   If Not ExisteixTaula("PingMaquinaAvisada") Then ExecutaComandaSql "CREATE TABLE [PingMaquinaAvisada](   [Id] [nvarchar](255) NULL,   [Llicencia] [float] NULL,   [TmSt] [datetime] NULL,   [Param1] [nvarchar](255) NULL,   [Param2] [nvarchar](255) NULL,    [Param3] [nvarchar](255) NULL ) ON [PRIMARY]"
'   'ExecutaComandaSql "insert into PingMaquina select * from  hit.dbo.PingMaquina where llicencia in(select distinct llicencia from hit.dbo.llicencies where upper(Empresa)='" & UCase(EmpresaActual) & "') "
'   'ExecutaComandaSql "Delete hit.dbo.PingMaquina where llicencia in(select distinct llicencia from hit.dbo.llicencies where Upper(Empresa)='" & UCase(EmpresaActual) & "') "
'   EmailAvi = EmailAvissos()
'
'    If EmailAvi <> "" Then
'        Set Rs = Db.OpenResultset("Select MAX(TmSt) Ulti ,Llicencia   from PingMaquina where Llicencia not in(select llicencia from PingMaquinaAvisada Where Param1 = 'Avisada')   group by Llicencia having DATEDIFF(MINUTE,MAX(TmSt),GETDATE()) > 30 ")
'        While Not Rs.EOF
'            Llicencia = Rs("Llicencia")
'            NomBot = BotigaCodiNom(LlicenciaCodiClient(CStr(Llicencia)))
'            Informa "Maquina Desc. " & NomBot & " Desde  " & Rs("Ulti")
'            ExecutaComandaSql "Delete PingMaquinaAvisada Where llicencia = '" & Llicencia & "' "
'            ExecutaComandaSql "Insert Into PingMaquinaAvisada (Id,Llicencia,Param1,Param2,Param3) Values (newid(),'" & Llicencia & "','Avisada',Getdate(),'" & Rs("Ulti") & "')  "
'            sf_enviarMail "Secrehit@gmail.com", EmailAvi, ":-( Maquina Incomunicada ! " & NomBot & " Desde  " & Rs("Ulti") & " n. ", "<Br>:-(<Br>Hora del Email : " & Now & " <Br>Ultim Ping : " & Rs("Ulti"), "", ""
'            Rs.MoveNext
'        Wend
'
'        Set Rs = Db.OpenResultset("select * From  PingMaquinaAvisada where llicencia in (select distinct  Llicencia  from PingMaquina  where DATEDIFF(MINUTE,TmSt,GETDATE()) < 15) ")
'        While Not Rs.EOF
'            Llicencia = Rs("Llicencia")
'            NomBot = BotigaCodiNom(LlicenciaCodiClient(CStr(Llicencia)))
'            Informa "Maquina Conectada " & NomBot
'            sf_enviarMail "Secrehit@gmail.com", EmailAvi, ":-) Maquina Conectada ! " & NomBot & " ", "<Br>:-)<Br>Estava Desconectada desde  : " & Rs("Param3") & " <Br>", "", ""
'            ExecutaComandaSql "Delete PingMaquinaAvisada Where llicencia = '" & Llicencia & "' "
'            Rs.MoveNext
'        Wend
'
'    End If
   
End Sub


Sub RecalculaObjectiusDeVenda()
   Dim RsU As rdoResultset, rs As rdoResultset, rs1 As rdoResultset, rs2 As rdoResultset, Hi As Date, Hf As Date
   Dim llicencia, botiga, HotaTall, Da1 As Date, Da2 As Date, StGoal As String, Goal, Colo, i1, i2, C1, C2
   Dim Avisat, CagadesSeguides, TexteAvis, Fi As Boolean, Caixa As Double, ColAux As String, AvisarA As String, sql As String
   
On Error GoTo nor
    
   If Hour(Now) >= 6 And Hour(Now) < 22 Then
       Informa "Calculant Objectius Horaris"
       HotaTall = Now ' DateAdd("n", -5, Now)
       
       Set rs = Db.OpenResultset("select c.Codi as botiga ,w.codi as llicencia from clients c join paramshw w on c.Codi = w.Valor1 Join ConstantsClient cc on cc.Codi = c.Codi and cc.Variable = 'Objetivo' and cc.Valor = 'Objetivo' ")
       If Not rs.EOF Then
          'ExecutaComandaSql ("Delete MissatgesPerLlicencia Where Accio = 'InformaEstatBotiga' and Desti<>'679'")
          ExecutaComandaSql ("Delete MissatgesPerLlicencia Where Accio = 'InformaEstatBotiga'")
          ExecutaComandaSql "Delete " & PrevisionsVendes & " Where not day(Data) = " & Day(HotaTall)
       End If
       
       While Not rs.EOF
          botiga = rs("botiga")
          llicencia = rs("Llicencia")
            Hi = TimeSerial(0, 0, 0)
            Da1 = DateSerial(Year(HotaTall), Month(HotaTall), Day(HotaTall)) + Hi
            
            Set rs1 = Db.OpenResultset("select data from [" & NomTaulaMovi(Da1) & "] where Tipus_moviment='Z' and DAY(data) = " & Day(Da1) & " and Botiga = " & botiga & " order by Data desc ")
            If Not rs1.EOF Then If Not IsNull(rs1("Data")) Then Hi = TimeSerial(Hour(rs1("Data")), Minute(rs1("Data")), Second(rs1("Data")))
            Da1 = DateSerial(Year(HotaTall), Month(HotaTall), Day(HotaTall)) + Hi
            
            CreaTaulesDadesTpv Da1
            Da2 = HotaTall
            Set rs1 = Db.OpenResultset("select isnull(Sum(Import),0)  I From [" & NomTaulaVentas(Da1) & "] Where Botiga = " & botiga & " and Data >= " & SqlDataMinute(Da1) & " And Data <= " & SqlDataMinute(Da2) & "  ")
            
            sql = ""
            sql = sql & "select top 10 isnull(d1.C,-1) A1,isnull(D2.c,-1) A2, isnull(d1.I,0) - isnull(d2.i,0) Dif from articles a "
            sql = sql & "Left Join "
            sql = sql & "(select isnull(Sum(Import),0) I ,plu  C From [" & NomTaulaVentas(Da1) & "] "
            sql = sql & "Where Botiga = " & botiga & " and Data >= " & SqlDataMinute(Da1) & " And Data <= " & SqlDataMinute(Da2) & "  "
            sql = sql & "group by plu) D1 "
            sql = sql & "on a.Codi = d1.C "
            
            i1 = 0
            If Not rs1.EOF Then If Not IsNull(rs1("I")) Then i1 = rs1("I")
            Set rs1 = Db.OpenResultset("select count(distinct num_tick) C From [" & NomTaulaVentas(Da1) & "] Where Botiga = " & botiga & " and Data >= " & SqlDataMinute(Da1) & " And Data <= " & SqlDataMinute(Da2) & "  ")
            C1 = 0
            If Not rs1.EOF Then If Not IsNull(rs1("C")) Then C1 = rs1("C")
            
            Da1 = DateAdd("d", -7, DateSerial(Year(HotaTall), Month(HotaTall), Day(HotaTall))) + Hi
            CreaTaulesDadesTpv Da1
            Da2 = DateAdd("d", -7, HotaTall)
            Set rs2 = Db.OpenResultset("select isnull(Sum(Import),0)  I From [" & NomTaulaVentas(Da1) & "] Where Botiga = " & botiga & " and Data >= " & SqlDataMinute(Da1) & " And Data <= " & SqlDataMinute(Da2) & "  ")
            i2 = 0
            If Not rs2.EOF Then If Not IsNull(rs2("I")) Then i2 = rs2("I")
          
            Set rs2 = Db.OpenResultset("select count(distinct num_tick) C From [" & NomTaulaVentas(Da1) & "] Where Botiga = " & botiga & " and Data >= " & SqlDataMinute(Da1) & " And Data <= " & SqlDataMinute(Da2) & "  ")
            C2 = 0
            If Not rs2.EOF Then If Not IsNull(rs2("C")) Then C2 = rs2("C")
          
            sql = sql & "Left Join "
            sql = sql & "(select isnull(Sum(Import),0) I,plu C From [" & NomTaulaVentas(Da1) & "] "
            sql = sql & "Where Botiga = " & botiga & " and Data >= " & SqlDataMinute(Da1) & " And Data <= " & SqlDataMinute(Da2) & "   "
            sql = sql & "group by plu) d2 "
            sql = sql & "on  a.codi = D2.c "
            
            
            
            If i1 > 0 And i2 > 0 Then
                Dim M1, M2
                M1 = Round(i1 / C1, 2)
                M2 = Round(i2 / C2, 2)
                
                Goal = Round(M1 - M2, 2)
                Colo = "Red"
                Caixa = Round(i2 - i1, 2)
                If (Goal) > 0 Then Colo = "Green"
                StGoal = Format(Goal, "0.00") & " /c "  ' & Format(Caixa, "0")
                TexteAvis = ""
                
                If Goal > 0 Then
                   sql = sql & "where  isnull(d1.I,0) - isnull(d2.i,0) >0 order by isnull(d1.I,0) - isnull(d2.i,0)  desc  "
                Else
                   sql = sql & "where  isnull(d1.I,0) - isnull(d2.i,0) <0 order by isnull(d1.I,0) - isnull(d2.i,0)        "
                   Set RsU = Db.OpenResultset(sql)
                   While Not RsU.EOF
                      If CDbl(RsU("A1")) <> -1 Then TexteAvis = TexteAvis & ArticleCodiNom(RsU("A1")) & "  " & Format(RsU("Dif"), "0.00") & " <Br>"
                      If CDbl(RsU("A2")) <> -1 Then TexteAvis = TexteAvis & ArticleCodiNom(RsU("A2")) & "  " & Format(RsU("Dif"), "0.00") & " <Br>"
                      RsU.MoveNext
                   Wend
                   TexteAvis = TexteAvis
                End If
                
                AvisarA = ""
                Set RsU = Db.OpenResultset("select d.valor from ConstantsClient cc join dependentesextes d on d.id=cc.Valor   collate Modern_Spanish_CI_AS  and cc.Variable = 'userObjetivo' and cc.Codi = '" & botiga & "' and d.nom='EMAIL'")
                If Not RsU.EOF Then If Not IsNull(RsU(0)) Then AvisarA = RsU(0)
                               
                
                If Not AvisarA = "" Then
                    Set rs1 = Db.OpenResultset("select top 10 * from " & PrevisionsVendes & " where llicencia = '" & botiga & "' order by Data Desc ")
                    Avisat = "Guardat"
                    If Not rs1.EOF Then Avisat = rs1("Estat")
                
                    CagadesSeguides = 0
                    TexteAvis = TexteAvis & "<Table border=2><Tr>"
                    TexteAvis = TexteAvis & "<Td style='width:10%;'><b>Hora</b></Td>"
                    TexteAvis = TexteAvis & "<Td style='width:10%;'><b>Obj</b></Td>"
                    TexteAvis = TexteAvis & "<Td style='width:10%;'><b>Caja</b></Td>"
                    TexteAvis = TexteAvis & "<Td style='width:10%;'><b>Cli</b></Td>"
                    TexteAvis = TexteAvis & "<Td style='width:10%;'><b>Media</b></Td>"
                    TexteAvis = TexteAvis & "<Td style='width:10%;'><b>Diff Caja</b></Td>"
                    TexteAvis = TexteAvis & "</Tr>"
                
                    Fi = False
                    While Not rs1.EOF
                        ColAux = "Green"
                        If rs1("Aux6") < 0 Then ColAux = "Red"
                        TexteAvis = TexteAvis & "<Tr>"
                        TexteAvis = TexteAvis & "<Td>" & Format(rs1("Data"), "hh:nn") & "</Td>"
                        TexteAvis = TexteAvis & "<Td>" & rs1("Aux6") & "</Td>"
                        TexteAvis = TexteAvis & "<Td>" & Format(rs1("Aux3"), "0.00") & "</Td>"
                        TexteAvis = TexteAvis & "<Td>" & rs1("Aux4") & "</Td>"
                        TexteAvis = TexteAvis & "<Td>" & rs1("Aux5") & "</Td>"
                        TexteAvis = TexteAvis & "<Td>" & rs1("Aux7") & "</Td>"
'TexteAvis = TexteAvis & "<Td><font color='" & TriaColor(Rs1("Aux7")) & "'> " & Rs1("Aux7") & "</font></Td>"
                        TexteAvis = TexteAvis & "</Tr>"
                   
                        If rs1("Aux6") < 0 And Not Fi Then
                            CagadesSeguides = CagadesSeguides + 1
                        Else
                            Fi = True
                        End If
                        rs1.MoveNext
                        Wend
                        TexteAvis = TexteAvis & "</Table>"
                   
                        If Goal < 0 Then
                            If Avisat = "Guardat" And CagadesSeguides > 5 Then
                                sf_enviarMail "Secrehit@gmail.com", AvisarA, BotigaCodiNom(botiga) & " " & StGoal & " " & Format(HotaTall, "hh:nn"), TexteAvis, "", ""
                                Avisat = "Avisat"
                            End If
                        Else
                            If Avisat = "Avisat" Then
                                sf_enviarMail "Secrehit@gmail.com", AvisarA, BotigaCodiNom(botiga) & " " & StGoal & " " & Format(HotaTall, "hh:nn"), TexteAvis, "", ""
                                Avisat = "Guardat"
                            End If
                        End If
                End If
                
                ExecutaComandaSql "Insert Into " & PrevisionsVendes & " ([Llicencia],[data],[Tipus],Estat,[Aux1],[Aux2],[Aux3],[Aux4],[Aux5],[Aux6],[Aux7]) values (" & botiga & "," & SqlDataMinute(CVDate(HotaTall)) & ",'ImportVenta','" & Avisat & "','" & StGoal & "','" & Colo & "','" & i1 & "','" & C1 & "','" & M1 & "','" & Goal & "','" & Format(Caixa, "0") & "') "
                'If Llicencia <> "679" Then ExecutaComandaSql "Insert Into MissatgesPerLlicencia (Id,Accio,Desti,Origen,Param1,Param2,Param3,Param4,Texte) values (newid(),'InformaEstatBotiga'," & Llicencia & " ,'CalculsLlarcs' ,'" & StGoal & "','" & Colo & "',0,0,'Objectiu horari per " & Format(Now, "dd-mm-yy hh:nn:ss") & " ') "
                ExecutaComandaSql "Insert Into MissatgesPerLlicencia (Id,Accio,Desti,Origen,Param1,Param2,Param3,Param4,Texte) values (newid(),'InformaEstatBotiga'," & llicencia & " ,'CalculsLlarcs' ,'" & StGoal & "','" & Colo & "',0,0,'Objectiu horari per " & Format(Now, "dd-mm-yy hh:nn:ss") & " ') "
            End If
          
          rs.MoveNext
       Wend
   End If
   
nor:

End Sub


Sub PrevisioVendes()
    Dim RsU As rdoResultset, rs As rdoResultset, rs1 As rdoResultset, rs2 As rdoResultset, Hi As Date, Hf As Date
    Dim llicencia, botiga, HotaTall, Da1 As Date, Da2 As Date, StGoal As String, Goal, Colo, i1, i2, C1, C2
    Dim Avisat, CagadesSeguides, TexteAvis, Fi As Boolean, Caixa As Double, ColAux As String, AvisarA As String, sql As String
  
    Informa "Oracul Vendes"
         
    Set rs = Db.OpenResultset("select c.Codi as botiga ,w.codi as llicencia from clients c join paramshw w on c.Codi = w.Valor1 Join ConstantsClient cc on cc.Codi = c.Codi and cc.Variable = 'Objetivo' and cc.Valor = 'Objetivo' ")
    While Not rs.EOF
        botiga = rs("botiga")
        llicencia = rs("Llicencia")
        Informa "Oracul Vendes " & BotigaCodiNom(rs("botiga")) & " Data " & DateAdd("d", 6, Now)
        
        PrevisioVendesBotigaDia rs("Botiga"), DateAdd("d", 6, Now)
        
        rs.MoveNext
    Wend
   
nor:

End Sub



Sub PrevisioVendesBotigaArticleDia(b, a, D As Date)
    Dim RsU As rdoResultset, rs As rdoResultset, rs1 As rdoResultset, rs2 As rdoResultset, Hi As Date, Hf As Date
    Dim llicencia, botiga, HotaTall, Da1 As Date, Da2 As Date, StGoal As String, Goal, Colo, i1, i2, C1, C2, n
    Dim Avisat, CagadesSeguides, TexteAvis, Fi As Boolean, Caixa As Double, ColAux As String, AvisarA As String, sql As String
   
'Taules involucrades.....
' [V_Estadis_2016-01] Guardem els totals de vendes x dia i els estadistics
' [V_Oracul_2016-01]  Calcul de la previsió de vendes.


    ExecutaComandaSql "Delete " & nomTaulaOracul(D) & " Where Client= " & b & " And Producte = " & a & " And Day(data) = " & D
    
        n = 2
    
    ExecutaComandaSql "Insert Into " & nomTaulaOracul(D) & "(Tipus,Estat,Client,Producte,Data,Previsio) Values (1,1," & b & "," & a & "," & D & "," & n & ")"
    
nor:

End Sub




Sub RecalculaObjectiusDeClients()
   Dim RsU As rdoResultset, rs As rdoResultset, rs1 As rdoResultset, rs2 As rdoResultset, Hi As Date, Hf As Date
   Dim llicencia, botiga, HotaTall, Da1 As Date, Da2 As Date, StGoal As String, Goal, Colo, i1, i2, C1, C2
   Dim Avisat, CagadesSeguides, TexteAvis, Fi As Boolean, Caixa As Double, ColAux As String, AvisarA As String, sql As String
   Dim Botigues As String, b As Integer
   Dim botArr() As String
   
On Error GoTo nor
    
   If Hour(Now) >= 6 And Hour(Now) < 22 Then
        Informa "Calculant Objectius Horaris per Client"
        HotaTall = Now ' DateAdd("n", -5, Now)
        
        Botigues = "679,214"
        botArr = Split(Botigues, ",")
        
        For b = 0 To UBound(botArr)
            botiga = botArr(b)
            llicencia = botArr(b)
              
            ExecutaComandaSql ("Delete MissatgesPerLlicencia Where Accio = 'InformaEstatBotiga2' and Desti='" & botiga & "'")
            
            Hi = TimeSerial(0, 0, 0)
            Da1 = DateSerial(Year(HotaTall), Month(HotaTall), Day(HotaTall)) + Hi
                
            Set rs1 = Db.OpenResultset("select data from [" & NomTaulaMovi(Da1) & "] where Tipus_moviment='Z' and DAY(data) = " & Day(Da1) & " and Botiga = " & botiga & " order by Data desc ")
            If Not rs1.EOF Then If Not IsNull(rs1("Data")) Then Hi = TimeSerial(Hour(rs1("Data")), Minute(rs1("Data")), Second(rs1("Data")))
            Da1 = DateSerial(Year(HotaTall), Month(HotaTall), Day(HotaTall)) + Hi
                
            CreaTaulesDadesTpv Da1
            Da2 = HotaTall
    
            'NÚMERO DE CLIENTS ACTUAL
            Set rs1 = Db.OpenResultset("select count(distinct num_tick) C From [" & NomTaulaVentas(Da1) & "] Where Botiga = " & botiga & " and Data >= " & SqlDataMinute(Da1) & " And Data <= " & SqlDataMinute(Da2) & "  ")
            C1 = 0
            If Not rs1.EOF Then If Not IsNull(rs1("C")) Then C1 = rs1("C")
            
            'NÚMERO DE CLIENTS SETMANA ANTERIOR
            Da1 = DateAdd("d", -7, DateSerial(Year(HotaTall), Month(HotaTall), Day(HotaTall))) + Hi
            CreaTaulesDadesTpv Da1
            Da2 = DateAdd("d", -7, HotaTall)
            
            Set rs2 = Db.OpenResultset("select count(distinct num_tick) C From [" & NomTaulaVentas(Da1) & "] Where Botiga = " & botiga & " and Data >= " & SqlDataMinute(Da1) & " And Data <= " & SqlDataMinute(Da2) & "  ")
            C2 = 0
            If Not rs2.EOF Then If Not IsNull(rs2("C")) Then C2 = rs2("C")
            
            If C1 > 0 And C2 > 0 Then
                Goal = Round(C1 - C2, 2)
                Colo = "Red"
                If (Goal) > 0 Then Colo = "Green"
                StGoal = Goal & " clients "
                
                ExecutaComandaSql "Insert Into MissatgesPerLlicencia (Id,Accio,Desti,Origen,Param1,Param2,Param3,Param4,Texte) values (newid(),'InformaEstatBotiga2'," & llicencia & " ,'CalculsLlarcs', '" & StGoal & "','" & Colo & "', 0, 0, 'Objectiu horari per " & Format(Now, "dd-mm-yy hh:nn:ss") & " ') "
            End If
        Next
   End If
   
nor:

End Sub

Sub RecalculaObjectiusDeVenda2()
   Dim RsU As rdoResultset, rs As rdoResultset, rs1 As rdoResultset, rs2 As rdoResultset, Hi As Date, Hf As Date
   Dim llicencia, botiga, HotaTall, Da1 As Date, Da2 As Date, StGoal As String, Goal, Colo, i1, i2, C1, C2
   Dim Avisat, CagadesSeguides, TexteAvis, Fi As Boolean, Caixa As Double, ColAux As String, AvisarA As String, sql As String
   Dim periode As String
   
On Error GoTo nor
    
   If Hour(Now) >= 6 And Hour(Now) < 22 Then
       Informa "Calculant Objectius Horaris"
       HotaTall = Now ' DateAdd("n", -5, Now)
       
       Set rs = Db.OpenResultset("select c.Codi as botiga ,w.codi as llicencia from clients c join paramshw w on c.Codi = w.Valor1 Join ConstantsClient cc on cc.Codi = c.Codi and cc.Variable = 'Objetivo' and cc.Valor = 'Objetivo' ")
       If Not rs.EOF Then
          ExecutaComandaSql ("Delete MissatgesPerLlicencia Where Accio = 'InformaEstatBotiga'")
          ExecutaComandaSql "Delete " & PrevisionsVendes & " Where not day(Data) = " & Day(HotaTall)
       End If
            
       While Not rs.EOF
            botiga = rs("botiga")
            llicencia = rs("Llicencia")
            Hi = TimeSerial(0, 0, 0)
            Da1 = DateSerial(Year(HotaTall), Month(HotaTall), Day(HotaTall)) + Hi
            
            Set rs1 = Db.OpenResultset("select data from [" & NomTaulaMovi(Da1) & "] where Tipus_moviment='Z' and DAY(data) = " & Day(Da1) & " and Botiga = " & botiga & " order by Data desc ")
            If Not rs1.EOF Then If Not IsNull(rs1("Data")) Then Hi = TimeSerial(Hour(rs1("Data")), Minute(rs1("Data")), Second(rs1("Data")))
            Da1 = DateSerial(Year(HotaTall), Month(HotaTall), Day(HotaTall)) + Hi
            
            CreaTaulesDadesTpv Da1
            Da2 = HotaTall
            Set rs1 = Db.OpenResultset("select isnull(Sum(Import),0)  I From [" & NomTaulaVentas(Da1) & "] Where Botiga = " & botiga & " and Data >= " & SqlDataMinute(Da1) & " And Data <= " & SqlDataMinute(Da2) & "  ")
            
            sql = ""
            sql = sql & "select top 10 isnull(d1.C,-1) A1,isnull(D2.c,-1) A2, isnull(d1.I,0) - isnull(d2.i,0) Dif from articles a "
            sql = sql & "Left Join "
            sql = sql & "(select isnull(Sum(Import),0) I ,plu  C From [" & NomTaulaVentas(Da1) & "] "
            sql = sql & "Where Botiga = " & botiga & " and Data >= " & SqlDataMinute(Da1) & " And Data <= " & SqlDataMinute(Da2) & "  "
            sql = sql & "group by plu) D1 "
            sql = sql & "on a.Codi = d1.C "
            
            i1 = 0
            If Not rs1.EOF Then If Not IsNull(rs1("I")) Then i1 = rs1("I")
            Set rs1 = Db.OpenResultset("select count(distinct num_tick) C From [" & NomTaulaVentas(Da1) & "] Where Botiga = " & botiga & " and Data >= " & SqlDataMinute(Da1) & " And Data <= " & SqlDataMinute(Da2) & "  ")
            C1 = 0
            If Not rs1.EOF Then If Not IsNull(rs1("C")) Then C1 = rs1("C")
            
            'OBJECTIUS
            i2 = 0
            periode = "0"
            If Hour(HotaTall) > 13 Then periode = "1"
            Set rs2 = Db.OpenResultset("select isnull(Objectiu , 0) I from [" & NomTaulaObjectius(Da1) & "] where botiga='" & botiga & "' and day(data)=" & Day(Da1) & " and periode=" & periode)
            If Not rs2.EOF Then If Not IsNull(rs2("I")) Then i2 = rs2("I")
          
            Da1 = DateAdd("d", -7, DateSerial(Year(HotaTall), Month(HotaTall), Day(HotaTall))) + Hi
            CreaTaulesDadesTpv Da1
            Da2 = DateAdd("d", -7, HotaTall)
            Set rs2 = Db.OpenResultset("select count(distinct num_tick) C From [" & NomTaulaVentas(Da1) & "] Where Botiga = " & botiga & " and Data >= " & SqlDataMinute(Da1) & " And Data <= " & SqlDataMinute(Da2) & "  ")
            C2 = 0
            If Not rs2.EOF Then If Not IsNull(rs2("C")) Then C2 = rs2("C")
          
            sql = sql & "Left Join "
            sql = sql & "(select isnull(Sum(Import),0) I,plu C From [" & NomTaulaVentas(Da1) & "] "
            sql = sql & "Where Botiga = " & botiga & " and Data >= " & SqlDataMinute(Da1) & " And Data <= " & SqlDataMinute(Da2) & "   "
            sql = sql & "group by plu) d2 "
            sql = sql & "on  a.codi = D2.c "
            
            
            
            If i1 > 0 And i2 > 0 Then
                Dim M1, M2
                M1 = Round(i1 / C1, 2)
                M2 = Round(i2 / C2, 2)
                
                Goal = Round(M1 - M2, 2)
                Colo = "Red"
                Caixa = Round(i2 - i1, 2)
                If (Goal) > 0 Then Colo = "Green"
                StGoal = Format(Goal, "0.00") & " /c "  ' & Format(Caixa, "0")
                TexteAvis = ""
                
                If Goal > 0 Then
                   sql = sql & "where  isnull(d1.I,0) - isnull(d2.i,0) >0 order by isnull(d1.I,0) - isnull(d2.i,0)  desc  "
                Else
                   sql = sql & "where  isnull(d1.I,0) - isnull(d2.i,0) <0 order by isnull(d1.I,0) - isnull(d2.i,0)        "
                   Set RsU = Db.OpenResultset(sql)
                   While Not RsU.EOF
                      If CDbl(RsU("A1")) <> -1 Then TexteAvis = TexteAvis & ArticleCodiNom(RsU("A1")) & "  " & Format(RsU("Dif"), "0.00") & " <Br>"
                      If CDbl(RsU("A2")) <> -1 Then TexteAvis = TexteAvis & ArticleCodiNom(RsU("A2")) & "  " & Format(RsU("Dif"), "0.00") & " <Br>"
                      RsU.MoveNext
                   Wend
                   TexteAvis = TexteAvis
                End If
                
                AvisarA = ""
                Set RsU = Db.OpenResultset("select d.valor from ConstantsClient cc join dependentesextes d on d.id=cc.Valor   collate Modern_Spanish_CI_AS  and cc.Variable = 'userObjetivo' and cc.Codi = '" & botiga & "' and d.nom='EMAIL'")
                If Not RsU.EOF Then If Not IsNull(RsU(0)) Then AvisarA = RsU(0)
                               
                
                If Not AvisarA = "" Then
                    Set rs1 = Db.OpenResultset("select top 10 * from " & PrevisionsVendes & " where llicencia = '" & botiga & "' order by Data Desc ")
                    Avisat = "Guardat"
                    If Not rs1.EOF Then Avisat = rs1("Estat")
                
                    CagadesSeguides = 0
                    TexteAvis = TexteAvis & "<Table border=2><Tr>"
                    TexteAvis = TexteAvis & "<Td style='width:10%;'><b>Hora</b></Td>"
                    TexteAvis = TexteAvis & "<Td style='width:10%;'><b>Obj</b></Td>"
                    TexteAvis = TexteAvis & "<Td style='width:10%;'><b>Caja</b></Td>"
                    TexteAvis = TexteAvis & "<Td style='width:10%;'><b>Cli</b></Td>"
                    TexteAvis = TexteAvis & "<Td style='width:10%;'><b>Media</b></Td>"
                    TexteAvis = TexteAvis & "<Td style='width:10%;'><b>Diff Caja</b></Td>"
                    TexteAvis = TexteAvis & "</Tr>"
                
                    Fi = False
                    While Not rs1.EOF
                        ColAux = "Green"
                        If rs1("Aux6") < 0 Then ColAux = "Red"
                        TexteAvis = TexteAvis & "<Tr>"
                        TexteAvis = TexteAvis & "<Td>" & Format(rs1("Data"), "hh:nn") & "</Td>"
                        TexteAvis = TexteAvis & "<Td>" & rs1("Aux6") & "</Td>"
                        TexteAvis = TexteAvis & "<Td>" & Format(rs1("Aux3"), "0.00") & "</Td>"
                        TexteAvis = TexteAvis & "<Td>" & rs1("Aux4") & "</Td>"
                        TexteAvis = TexteAvis & "<Td>" & rs1("Aux5") & "</Td>"
                        TexteAvis = TexteAvis & "<Td>" & rs1("Aux7") & "</Td>"
'TexteAvis = TexteAvis & "<Td><font color='" & TriaColor(Rs1("Aux7")) & "'> " & Rs1("Aux7") & "</font></Td>"
                        TexteAvis = TexteAvis & "</Tr>"
                   
                        If rs1("Aux6") < 0 And Not Fi Then
                            CagadesSeguides = CagadesSeguides + 1
                        Else
                            Fi = True
                        End If
                        rs1.MoveNext
                        Wend
                        TexteAvis = TexteAvis & "</Table>"
                   
                        If Goal < 0 Then
                            If Avisat = "Guardat" And CagadesSeguides > 5 Then
                                sf_enviarMail "Secrehit@gmail.com", AvisarA, BotigaCodiNom(botiga) & " " & StGoal & " " & Format(HotaTall, "hh:nn"), TexteAvis, "", ""
                                Avisat = "Avisat"
                            End If
                        Else
                            If Avisat = "Avisat" Then
                                sf_enviarMail "Secrehit@gmail.com", AvisarA, BotigaCodiNom(botiga) & " " & StGoal & " " & Format(HotaTall, "hh:nn"), TexteAvis, "", ""
                                Avisat = "Guardat"
                            End If
                        End If
                End If
                
                ExecutaComandaSql "Insert Into " & PrevisionsVendes & " ([Llicencia],[data],[Tipus],Estat,[Aux1],[Aux2],[Aux3],[Aux4],[Aux5],[Aux6],[Aux7]) values (" & botiga & "," & SqlDataMinute(CVDate(HotaTall)) & ",'ImportVenta','" & Avisat & "','" & StGoal & "','" & Colo & "','" & i1 & "','" & C1 & "','" & M1 & "','" & Goal & "','" & Format(Caixa, "0") & "') "
                ExecutaComandaSql "Insert Into MissatgesPerLlicencia (Id,Accio,Desti,Origen,Param1,Param2,Param3,Param4,Texte) values (newid(),'InformaEstatBotiga'," & llicencia & " ,'CalculsLlarcs' ,'" & StGoal & "','" & Colo & "',0,0,'Objectiu horari per " & Format(Now, "dd-mm-yy hh:nn:ss") & " ') "
                
            End If
          
          rs.MoveNext
       Wend
   End If
   
nor:

End Sub


Sub FesFeinesPerFerAles23()
   InformaMiss "Feines de les 23h "
    
   If UCase(EmpresaActual) = UCase("Tena") Then RecalculaProveedores
   If UCase(EmpresaActual) = UCase("Tena") Then CalculEstimacio
   
   
End Sub


Sub FesFeinesPerFerAles15()
   InformaMiss "Feines de les 6h "

   'If UCase(EmpresaActual) = UCase("Tena") Then ModificaComandesSegonsInventaris
'   If UCase(EmpresaActual) = UCase("Pa Natural") Then ModificaComandesSegonsInventaris
   
End Sub
Sub FesFeinesPerFerAles22()
   InformaMiss "Feines de les 22h "

   If UCase(EmpresaActual) = UCase("Essenza") Then
        ExecutaComandaSql "Insert Into FeinesAFer (Tipus,Ciclica,Param1,Param2,Param3,Param4) Values ('EnviarReportBotiga',0,'[" & Format(DateAdd("d", 1, Now), "dd-mm-yy") & "]','716','MiriamMDm@HotMail.com','')  "
        'ExecutaComandaSql "Insert Into FeinesAFer (Tipus,Ciclica,Param1,Param2,Param3,Param4) Values ('EnviarReportBotiga',0,'[" & Format(DateAdd("d", 1, Now), "dd-mm-yy") & "]','717','MiriamMDm@HotMail.com','')  "
   End If
   
   'If UCase(EmpresaActual) = UCase("ElMoli") Then
   '     ExecutaComandaSql "Insert Into FeinesAFer (Tipus,Ciclica,Param1,Param2,Param3,Param4) Values ('EnviarReportBotigaHistoric',0,'[" & Format(DateAdd("d", 1, Now), "dd-mm-yy") & "]','562,719','MiriamMDm@HotMail.com;Jessenzagrup@gmail.com','')  "
   'End If

End Sub


Sub FesFeinesPerFerAles13()
   InformaMiss "Feines de les 13h "

   If UCase(EmpresaActual) = UCase("Tena") Then
'        ModificaComandesSegonsInventarisBotigaV2 189, Now, True
   End If
  
End Sub



Sub ImportaAlbarans(An, mes, DiaInici, DiaFi, HoraInici, HoraFi, botiga)
   Dim dia As Date, Da1 As Date, Da2 As Date, P As Integer, rs As rdoResultset, Q_Ins As rdoQuery, Q_Del As rdoQuery, sql As String, Q_Upd As rdoQuery
   
   dia = DateSerial(An, mes, DiaInici)
   P = InStr(HoraInici, ":")
   Da1 = DateSerial(An, mes, DiaInici) + TimeSerial(Left(HoraInici, P - 1), Right(HoraInici, Len(HoraInici) - P), 0)
   P = InStr(HoraFi, ":")
   Da2 = DateSerial(An, mes, DiaFi) + TimeSerial(Left(HoraFi, P - 1), Right(HoraFi, Len(HoraFi) - P), 0)
   
   CreaTaulesDadesTpv Da1
   Set Q_Ins = Db.CreateQuery("", "Insert Into [" & DonamNomTaulaServit(dia) & "] (Client,CodiArticle,QuantitatServida,QuantitatDemanada,Comentari,PluUtilitzat,Viatge,Equip,MotiuModificacio,Hora,TipusComanda,ComentariPer,Atribut) Values (?,?,?,?,?,'','','','',94,2,'',0)")
   Set Q_Del = Db.CreateQuery("", "Delete [" & DonamNomTaulaServit(dia) & "] Where Client = ? And Comentari like ? ")
   Set Q_Upd = Db.CreateQuery("", "Update [" & DonamNomTaulaServit(dia) & "] Set QuantitatServida = ?  Where Client = ? And Comentari = ? And CodiArticle = ? ")
   
   '*****************************************************************************************
   '*****************************************************************************************
   ' ANA
   ' 26/09/2012
   ' CAMBIOS POR FECHA
   ' Tenemos un albaran con con las 9:12:12 (con 12 segundos) la fecha viene con 9:12
   ' por lo tanto no encuentra el albaran
   ' CONSULTA ANTERIOR:
   'Sql = "Select Distinct Num_Tick,Otros From [" & NomTaulaAlbarans(dia) & "] Where Data >= " & SqlDataMinute(Da1) & " And Data <= " & SqlDataMinute(Da2) & " "
   'Cambiamos Data por CONVERT(datetime, left(data,17),3)
   'Cambiamos > y < por => y <=
   '*****************************************************************************************
   '*****************************************************************************************
   sql = "Select Distinct Num_Tick,Otros From [" & NomTaulaAlbarans(dia) & "] "
   sql = sql & "Where CONVERT(datetime, left(CONVERT(varchar,data,120),16),120) >= " & SqlDataMinute(Da1) & " "
   sql = sql & "And CONVERT(datetime, left(CONVERT(varchar,data,120),16),120) <= " & SqlDataMinute(Da2) & " "
   
   If botiga <> 0 Then sql = sql & " and Botiga = " & botiga & " "
   Set rs = Db.OpenResultset(sql)
   
   While Not rs.EOF
      If IsNumeric(rs("Otros")) Then
      
         Q_Del.rdoParameters(0) = rs("Otros")
         Q_Del.rdoParameters(1) = "%IdAlbaraBot:" & rs("Num_Tick") & "%"
         On Error GoTo Logaipassa
            Q_Del.Execute
         On Error GoTo 0
         
         Q_Del.rdoParameters(0) = rs("Otros")
         Q_Del.rdoParameters(1) = "%IdAlbara:" & rs("Num_Tick") & "%"
         On Error GoTo Logaipassa
            Q_Del.Execute
         On Error GoTo 0
      End If
      rs.MoveNext
   Wend
   rs.Close

   '*****************************************************************************************
   '*****************************************************************************************
   ' ANA
   ' 26/09/2012
   ' CAMBIOS POR FECHA
   ' Tenemos un albaran con con las 9:12:12 (con 12 segundos) la fecha viene con 9:12
   ' por lo tanto no encuentra el albaran
   ' CONSULTA ANTERIOR:
   'Sql = "Select * From [" & NomTaulaAlbarans(dia) & "] Where Data > " & SqlDataMinute(Da1) & " And Data < " & SqlDataMinute(Da2) & " "
   'Cambiamos Data por CONVERT(datetime, left(data,17),3)
   'Cambiamos > y < por => y <=
   '*****************************************************************************************
   '*****************************************************************************************
   sql = "Select * From [" & NomTaulaAlbarans(dia) & "] "
   sql = sql & "Where CONVERT(datetime, left(CONVERT(varchar,data,120),16),120) >= " & SqlDataMinute(Da1) & " "
   sql = sql & "And CONVERT(datetime, left(CONVERT(varchar,data,120),16),120) <= " & SqlDataMinute(Da2) & " "
   
   If botiga <> 0 Then sql = sql & " and Botiga = " & botiga & " "
   Set rs = Db.OpenResultset(sql)
   
   While Not rs.EOF
        If IsNumeric(rs("Otros")) Then
            Q_Ins.rdoParameters(0) = rs("Otros")
            Q_Ins.rdoParameters(1) = rs("Plu")
            Q_Ins.rdoParameters(2) = rs("Quantitat")
            Q_Ins.rdoParameters(3) = rs("Quantitat")
            Q_Ins.rdoParameters(4) = "[IdAlbaraBot:" & rs("Num_Tick") & "]" & "[IdAlbara:" & rs("Num_Tick") & "]"
            
            On Error GoTo Logaipassa
                Q_Ins.Execute
            On Error GoTo 0
        End If
        rs.MoveNext
   Wend
   rs.Close
   
Exit Sub

Logaipassa:
    LogaErr "Importa Albarans, error !! : " & err.Description
    Resume Next
    
End Sub


Sub DesempaquetaLlista(Sst As String, Arr() As Double)
    Dim L As String
    
    ReDim Arr(0)
    
    L = Trim(Car(Sst))
    While Len(L) > 0
        'If Not (L = "" Or L = "0" Or L = "00") Then
        If Not (L = "" Or L = "00") Then
            ReDim Preserve Arr(UBound(Arr) + 1)
            Arr(UBound(Arr)) = Val(L)
        End If
        L = Trim(Car(Sst))
    Wend

End Sub

Sub ModificaComandesSegonsInventaris()
    Dim Avui As Date, Boti() As Double, i As Integer
    
    Avui = Now
'    Avui = DateSerial(2007, 8, 26) + TimeSerial(11, 50, 0)
    'ModificaComandesSegonsInventarisBotiga 362, Avui
    
'    CarregaLlistaBotigues "384", Boti, Year(Avui), Month(Avui), 1, Day(Avui)
    CarregaLlistaBotigues "0", Boti, Year(Avui), Month(Avui), 1, Day(Avui)
    
    'For i = 1 To UBound(Boti)
    '    ModificaComandesSegonsInventarisBotiga Boti(i), Avui
    'Next
    
End Sub


Function HistoricComunicacions(D)
    Dim Str As String, strSQL As String
    
    Str = "HistoricComunicacions_" & Year(D) & "_" & Month(D)
'    ExecutaComandaSql "Drop Table [HistoricComunicacions_2009]"
'    ExecutaComandaSql "Drop Table [HistoricComunicacions_2010]"
    
'    ExecutaComandaSql "Drop table [HistoricComunicacions_2009] "
    If Not ExisteixTaula(Str) Then
        strSQL = "CREATE TABLE [" & Str & "] ( "
        strSQL = strSQL & " Ordre numeric PRIMARY KEY IDENTITY, "
        strSQL = strSQL & " [id]        [nvarchar] (255)   NULL Default (NEWID()),"
        strSQL = strSQL & " [TimeStamp] [datetime]         NULL DEFAULT (getdate()), "
        strSQL = strSQL & " [Llicencia] [numeric](18, 0) NULL, "
        strSQL = strSQL & " [Data] [datetime]   NULL, "
        strSQL = strSQL & " [Tipus] [nvarchar](255)  NULL, "
        strSQL = strSQL & " [Aux1] [nvarchar](255)  NULL, "
        strSQL = strSQL & " [Aux2] [nvarchar](255)  NULL, "
        strSQL = strSQL & " [Aux3] [nvarchar](255)  NULL, "
        strSQL = strSQL & " [Aux4] [nvarchar](255)  NULL "
        strSQL = strSQL & " ) ON [PRIMARY] "
        ExecutaComandaSql strSQL
    End If
    
    
    HistoricComunicacions = Str
End Function
Function HistoricComunicacionsReposicio(D)
    Dim Str As String, strSQL As String
    
    Str = "HistoricComunicacionsReposicio_" & Year(D) & "_" & Month(D)
    If Not ExisteixTaula(Str) Then
        strSQL = "CREATE TABLE [" & Str & "] ( "
        strSQL = strSQL & " Ordre numeric PRIMARY KEY IDENTITY, "
        strSQL = strSQL & " [id]        [nvarchar] (255)   NULL Default (NEWID()),"
        strSQL = strSQL & " [TimeStamp] [datetime]         NULL DEFAULT (getdate()), "
        strSQL = strSQL & " [Llicencia] [numeric](18, 0) NULL, "
        strSQL = strSQL & " [Data] [datetime]   NULL, "
        strSQL = strSQL & " [Tipus] [nvarchar](255)  NULL, "
        strSQL = strSQL & " [Aux1] [nvarchar](255)  NULL, "
        strSQL = strSQL & " [Aux2] [nvarchar](255)  NULL, "
        strSQL = strSQL & " [Aux3] [nvarchar](255)  NULL, "
        strSQL = strSQL & " [Aux4] [nvarchar](255)  NULL "
        strSQL = strSQL & " ) ON [PRIMARY] "
        ExecutaComandaSql strSQL
        ExecutaComandaSql "CREATE INDEX " & Str & " on " & Str & " (Llicencia, Data) "
    End If
    
    
    HistoricComunicacionsReposicio = Str
End Function



Function PrevisionsVendes()
    Dim Str As String, strSQL As String
    
    Str = "PrevisionsVendes"
    
    If Not ExisteixTaula(Str) Then
        strSQL = "CREATE TABLE [" & Str & "] ( "
        strSQL = strSQL & " [id]        [nvarchar] (255)   NULL Default (NEWID()),"
        strSQL = strSQL & " [TimeStamp] [datetime]         NULL DEFAULT (getdate()), "
        strSQL = strSQL & " [Llicencia] [numeric](18, 0) NULL, "
        strSQL = strSQL & " [Data] [datetime]   NULL, "
        strSQL = strSQL & " [Tipus] [nvarchar](255)  NULL, "
        strSQL = strSQL & " [Estat] [nvarchar](255)  NULL, "
        strSQL = strSQL & " [Aux1] [nvarchar](255)  NULL, "
        strSQL = strSQL & " [Aux2] [nvarchar](255)  NULL, "
        strSQL = strSQL & " [Aux3] [nvarchar](255)  NULL, "
        strSQL = strSQL & " [Aux4] [nvarchar](255)  NULL,"
        strSQL = strSQL & " [Aux5] [nvarchar](255)  NULL,"
        strSQL = strSQL & " [Aux6] [nvarchar](255)  NULL,"
        strSQL = strSQL & " [Aux7] [nvarchar](255)  NULL,"
        strSQL = strSQL & " [Aux8] [nvarchar](255)  NULL,"
        strSQL = strSQL & " [Aux9] [nvarchar](255)  NULL,"
        strSQL = strSQL & " ) ON [PRIMARY] "
        ExecutaComandaSql strSQL
    End If
    
    
    PrevisionsVendes = Str
End Function




Function ClientsSaldos(D As Date) As String
    Dim Str As String, strSQL As String
    
    Str = "ClientsSaldos_" & Year(D)
    
    If Not ExisteixTaula(Str) Then
        strSQL = "CREATE TABLE [" & Str & "] ( "
        strSQL = strSQL & " [id]        [nvarchar] (255)   NULL Default (NEWID()),"
        strSQL = strSQL & " [TmSt]      [datetime]         NULL DEFAULT (getdate()),"
        strSQL = strSQL & " [Client]    [nvarchar] (255) NULL ,"
        strSQL = strSQL & " [Tipo]      [nvarchar] (255) NULL ,"
        strSQL = strSQL & " [Origen]    [nvarchar] (255) NULL ,"
        strSQL = strSQL & " [Data]      [datetime]       NULL ,"
        strSQL = strSQL & " [Debe]      float NULL ,"
        strSQL = strSQL & " [Haber]     float NULL ,"
        strSQL = strSQL & " [Saldo]     float NULL ,"
        strSQL = strSQL & " [Auxi1] [nvarchar] (255) NULL ,"
        strSQL = strSQL & " [Auxi2] [nvarchar] (255) NULL ,"
        strSQL = strSQL & " [Auxi3] [nvarchar] (255) NULL ,"
        strSQL = strSQL & " [Auxi4] [nvarchar] (255) NULL ,"
        strSQL = strSQL & " [Auxi5] [nvarchar] (255) NULL"
        strSQL = strSQL & " ) ON [PRIMARY] "
        ExecutaComandaSql strSQL
    End If
    ClientsSaldos = Str
    
End Function



Sub ProgramaEnviarComandes()
    Dim rs As rdoResultset
    
   Set rs = Db.OpenResultset("Select Valor1 from ParamsHw where tipus = 1 ")
   While Not rs.EOF
      If Not IsNull(rs("Valor1")) Then
         If IsNumeric(rs("Valor1")) Then
            Missatges_CalEnviar "Comandes", "[" & rs("Valor1") & "]"
         End If
      End If
      rs.MoveNext
   Wend
   rs.Close
   
End Sub



Sub RealitzaCalculsTipus(Curts As Boolean, LLargs As Boolean, Emails As Boolean, SFtp As Boolean, empresa As String, Tipus As String)
   Dim CalBorrarArticles As Boolean, Files() As String, rs As rdoResultset, D As Date, Di As String, Df As String, iD() As String
   Dim i As Integer, Param() As String, Contingut As String, j As Integer, pt1, pt2, pt3
   Dim nom As String, Interesa As Integer, Esborrem As Integer, EsCfg As Boolean, ClientsGenerats As Boolean
   
   
     'If UCase(EmpresaActual) = UCase("TENA") And LLargs Then
      'ExecutaComandaSql "insert into [DEBUG_CAIXES] (botiga, nCaixes) select botiga, count(*) from [v_moviments_2019-11] where tipus_moviment='Z' and day(data)=27 group by botiga"
     'End If

     'If UCase(EmpresaActual) = UCase("Pa Natural") And LLargs Then CalculaDadesFichador


   ' If Not ExisteixTaula("FeinesAFer") Then Exit Sub
        ReDim iD(0)
    

       Set rs = Db.OpenResultset("Select * From FeinesAFer where Tipus = 'FeinesPerFerAlVespre' ")
       If rs.EOF Then ExecutaComandaSql "Insert Into FeinesAFer (Tipus,Ciclica,Param1,Param2,Param3,Param4) Values ('FeinesPerFerAlVespre',0,'[" & Format(Now, "dd-mm-yy") & "]','No " & Now() & "','','') "
    
       Set rs = Db.OpenResultset("Select * From FeinesAFer where Tipus = 'BuscarAlertasFacturacion' ")
       If rs.EOF Then ExecutaComandaSql "Insert Into FeinesAFer (Tipus,Ciclica,Param1,Param2,Param3,Param4) Values ('BuscarAlertasFacturacion',0,'[" & Format(Now, "dd-mm-yy") & "]','No " & Now() & "','','') "
    
       'Set rs = Db.OpenResultset("Select * From FeinesAFer where Tipus = 'FesNetejaBD' ")
       'If rs.EOF Then ExecutaComandaSql "Insert Into FeinesAFer (Tipus,Ciclica,Param1,Param2,Param3,Param4) Values ('FesNetejaBD',0,'[" & Format(Now, "dd-mm-yy") & "]','No " & Now() & "','','') "
    
       Set rs = Db.OpenResultset("Select * From FeinesAFer where Tipus = 'FeinesPerFerAles5' ")
       If rs.EOF Then ExecutaComandaSql "Insert Into FeinesAFer (Tipus,Ciclica,Param1,Param2,Param3,Param4) Values ('FeinesPerFerAles5',0,'[" & Format(Now, "dd-mm-yy") & "]','No " & Now() & "','','') "
       
       Set rs = Db.OpenResultset("Select * From FeinesAFer where Tipus = 'FeinesPerFerAles23' ")
       If rs.EOF Then ExecutaComandaSql "Insert Into FeinesAFer (Tipus,Ciclica,Param1,Param2,Param3,Param4) Values ('FeinesPerFerAles23',0,'[" & Format(Now, "dd-mm-yy") & "]','No " & Now() & "','','') "
       
       Set rs = Db.OpenResultset("Select * From FeinesAFer where Tipus = 'FeinesPerFerAles15' ")
       If rs.EOF Then ExecutaComandaSql "Insert Into FeinesAFer (Tipus,Ciclica,Param1,Param2,Param3,Param4) Values ('FeinesPerFerAles15',0,'[" & Format(Now, "dd-mm-yy") & "]','No " & Now() & "','','') "
       
       Set rs = Db.OpenResultset("Select * From FeinesAFer where Tipus = 'FeinesPerFerAles22' ")
       If rs.EOF Then ExecutaComandaSql "Insert Into FeinesAFer (Tipus,Ciclica,Param1,Param2,Param3,Param4) Values ('FeinesPerFerAles22',0,'[" & Format(Now, "dd-mm-yy") & "]','No " & Now() & "','','') "
       
       Set rs = Db.OpenResultset("Select * From FeinesAFer where Tipus = 'FeinesPerFerAles13' ")
       If rs.EOF Then ExecutaComandaSql "Insert Into FeinesAFer (Tipus,Ciclica,Param1,Param2,Param3,Param4) Values ('FeinesPerFerAles13',0,'[" & Format(Now, "dd-mm-yy") & "]','No " & Now() & "','','') "
       
       Set rs = Db.OpenResultset("Select * From FeinesAFer where Tipus = 'FeinesPerFerCada10Min' ")
       If rs.EOF Then ExecutaComandaSql "Insert Into FeinesAFer (Tipus,Ciclica,Param1,Param2,Param3,Param4) Values ('FeinesPerFerCada10Min',0,'[" & Now & "]','No " & Now() & "','','') "
       
       Set rs = Db.OpenResultset("Select * From FeinesAFer where Tipus = 'FeinesPerFerCadaHora' ")
       If rs.EOF Then ExecutaComandaSql "Insert Into FeinesAFer (Tipus,Ciclica,Param1,Param2,Param3,Param4) Values ('FeinesPerFerCadaHora',0,'[" & Now & "]','No " & Now() & "','','') "
       
       ExecutaComandaSql "Delete FeinesAFer where  Tipus = 'ImportaFitchers' "
       ExecutaComandaSql "Insert Into FeinesAFer (Tipus,Ciclica,Param1,Param2,Param3,Param4) Values ('ImportaFitchers',0,'[" & Format(Now, "dd-mm-yy") & "]','No " & Now() & "','','') "
       
       ExecutaComandaSql "Delete FeinesAFer where  Tipus = 'SecreAvisos' "
       ExecutaComandaSql "Insert Into FeinesAFer (Tipus,Ciclica,Param1,Param2,Param3,Param4) Values ('SecreAvisos',0,'[" & Format(Now, "dd-mm-yy") & "]','No " & Now() & "','','') "
       
       ExecutaComandaSql "Delete FeinesAFer where  Tipus = 'RecalculaProveedores' "
       ExecutaComandaSql "Insert Into FeinesAFer (Tipus,Ciclica,Param1,Param2,Param3,Param4) Values ('RecalculaProveedores',0,'[" & Format(Now, "dd-mm-yy") & "]','No " & Now() & "','','') "
   
   
   rs.Close
   
   
   ExecutaComandaSql "delete feinesafer where not id in (select max(id) from feinesafer where tipus = 'CalculaExcel' group by tipus,ciclica,param1,param2,param3,param4,param5 ) and tipus = 'CalculaExcel' "
   Set rs = Db.OpenResultset("Select * From FeinesAFer Order By Tipus desc, tmstmp")
   While Not rs.EOF
      ReDim Preserve iD(UBound(iD) + 1)
      iD(UBound(iD)) = NoNull(rs("id"))
      rs.MoveNext
   Wend
   rs.Close
   
   For i = 1 To UBound(iD)
      CalculaCalcul Curts, LLargs, Emails, SFtp, iD(i)
   Next
   
   InformaMiss ""
norR:

End Sub




Sub RealitzaCalculs(empresa As String, Tipus As String)
   
'If UCase(EmpresaActual) = UCase("Tena") Then PedidoCalcula "{001B7282-2654-49DA-A21D-3E7ACC1C2AA7}"
   
   Select Case FeinaAfer
      Case "Calculs"
         InformaMiss "Calculs"
         RealitzaCalculsTipus True, True, False, False, empresa, Tipus
      Case "CalculsResi"
         InformaMiss "Calculs Residencies"
         RealitzaCalculsTipus False, True, False, False, empresa, Tipus
      Case "CalculsLlargs"
         InformaMiss "Calculs Llargs"
         RealitzaCalculsTipus False, True, False, False, empresa, Tipus
         EnviaRecepcio
      Case "Emails"
         InformaMiss "Emails"
         RealitzaCalculsTipus False, False, True, False, empresa, Tipus
      Case "CalculsCurts"
         InformaMiss "Calculs Curts"
         RealitzaCalculsTipus True, False, False, False, empresa, Tipus
      Case "CalculsEspecials"
         InformaEmpresa empresa
         InformaMiss "Calculs Especials"
         RealitzaCalculsTipus False, False, False, False, empresa, Tipus
      Case "SFtp"
         InformaMiss "SFtp"
         RealitzaCalculsTipus False, False, False, True, empresa, Tipus
   End Select
   
End Sub
Sub FerComandes(Tipus As String, Dates As String, Botigues As String)
   Dim Di As Integer, Df As Integer, Mi As Integer, Mf As Integer, Ai As Integer, Af As Integer, D()   As String, m()  As String, a()  As String, P As Double, botiga() As String, L As String, i As Integer, k1 As Integer, k2 As Integer, k3 As Integer, dia As Date, K As Integer, Boti() As Double, ki, TipComanda() As String
   ReDim D(0):   ReDim m(0):   ReDim a(0):   ReDim botiga(0)
   
   Informa "Comandes " & Dates
   
   L = Car(Dates)
   While Len(L) > 0
      ReDim Preserve D(UBound(D) + 1)
      ReDim Preserve m(UBound(m) + 1)
      ReDim Preserve a(UBound(a) + 1)
      P = InStr(L, "-")
      D(UBound(D)) = "": a(UBound(a)) = "": m(UBound(m)) = ""
      If P > 0 Then
         D(UBound(D)) = Left(L, P - 1)
         L = Right(L, Len(L) - P)
         P = InStr(L, "-")
         If P > 0 Then
            m(UBound(m)) = Left(L, P - 1)
            L = Right(L, Len(L) - P)
            P = InStr(L, " de ")
            If P > 0 Then
               a(UBound(a)) = Left(L, P - 1)
            Else
               a(UBound(a)) = L
            End If
         End If
      End If
      L = Car(Dates)
   Wend
   
    CarregaLlistaBotiguesComandes Botigues, Boti, TipComanda

    For i = 1 To UBound(a)
        CalculaDesdeHasta D(i), Di, Df
        CalculaDesdeHasta m(i), Mi, Mf
        CalculaDesdeHasta a(i), Ai, Af
        For k1 = Ai To Af
            For k2 = Mi To Mf
                Informa "Comandes " & Dates & " (Index Per " & DateSerial(k1, k2, 1) & ")"
                CreaIndexosPerPrevisions DateSerial(k1, k2, 1)
                For k3 = Di To Df
                    dia = DateSerial(k1, k2, k3)
                    If Day(dia) = k3 And Month(dia) = k2 And Year(dia) = k1 Then
                        Informa "Comandes " & Dates & " (" & dia & ")"
                        For ki = 1 To UBound(Boti)
                            Informa "Comandes " & dia & " (" & ki & "/" & UBound(Boti) & ")"
                            CalculaComandes dia, CDbl(Boti(ki)), TipComanda(ki)
                        Next
                    End If
                Next
            Next
        Next
    Next
   
End Sub


Sub CopiaComandes(S_Di As String, S_Df As String, S_Cli As String, S_Viatge As String, Que_Copia As String)
   Dim Di As Date, Df As Date, Cli As Double
   Dim MySql As String, sql As String, LlistaCl As String, MySqlBk As String, Qui_Copia As String
   Dim rs As rdoResultset
   
   Informa "CopiaComandes " & S_Di & " A " & S_Df & " De " & S_Cli
   
   Qui_Copia = Mid(Split(Que_Copia, "]")(0), 2)
   If InStr(Que_Copia, "]") Then Que_Copia = Split(Que_Copia, "]")(1)
   
   Di = StData(Car(S_Di))
   Df = StData(Car(S_Df))
   
   S_Cli = Join(Split(S_Cli, "[0]"), "[-8]")
   
   ExecutaComandaSql "Drop Table Traspas"
   ExecutaComandaSql "UPDATE " & taulaServits(Di) & " Set TipusComanda = 1 Where not TipusComanda in(1,2,3) "
   
   sql = "CREATE TABLE [Traspas] ("
   sql = sql & "[Id]                [uniqueidentifier] Default (NEWID()),"
   sql = sql & "[TimeStamp]         [datetime]            ,"
   sql = sql & "[QuiStamp]          [nvarchar] (255)      ,"
   sql = sql & "[Client]            [float]          Null ,"
   sql = sql & "[CodiArticle]       [int]            Null ,"
   sql = sql & "[PluUtilitzat]      [nvarchar] (255) Null ,"
   sql = sql & "[Viatge]            [nvarchar] (255) Null ,"
   sql = sql & "[Equip]             [nvarchar] (255) Null ,"
   sql = sql & "[QuantitatDemanada] [float]                 Default (0),"
   sql = sql & "[QuantitatTornada]  [float]                 Default (0),"
   sql = sql & "[QuantitatServida]  [float]                 Default (0),"
   sql = sql & "[MotiuModificacio]  [nvarchar] (255) Null ,"
   sql = sql & "[Hora]              [float]          Null ,"
   sql = sql & "[TipusComanda]      [float]          Null ,"
   sql = sql & "[Comentari]         [nvarchar] (255) Null ,"
   sql = sql & "[ComentariPer]      [nvarchar] (255) Null ,"
   sql = sql & "[Atribut]           [Int]            Null ,"
   sql = sql & "[CitaDemanada]      [nvarchar] (255)        Default (''),"
   sql = sql & "[CitaServida]       [nvarchar] (255)        Default (''),"
   sql = sql & "[CitaTornada]       [nvarchar] (255)        Default ('') "
   sql = sql & ") ON [PRIMARY]"
   ExecutaComandaSql (sql)

   Cli = Val(Car(S_Cli))
   LlistaCl = ""
   While Cli <> 0
     '  If Machaca.Value = 1 Then     ExecutaComandaSql "Update [" & DonamNomTaulaServit(Df) & "] Set QuantitatDemanada = 0 WHERE Client = " & Cli & " AND TipusComanda <> 2 "
     MySql = "INSERT INTO [Traspas] "
     MySql = MySql & " (Client,Codiarticle,PluUtilitzat,Viatge,Equip,QuantitatDemanada,"
     If InStr(1, Que_Copia, "Servit") > 0 Then MySql = MySql & "QuantitatServida,"
     If InStr(1, Que_Copia, "Tornat") > 0 Then MySql = MySql & "QuantitatTornada,"
     MySql = MySql & "Hora,TipusComanda,Comentari,ComentariPer,Atribut) "
     MySql = MySql & " SELECT "
     MySql = MySql & " s.Client, s.Codiarticle, s.PluUtilitzat, s.Viatge, s.Equip, s.QuantitatDemanada, "
     If InStr(1, Que_Copia, "Servit") > 0 Then MySql = MySql & "s.QuantitatServida,"
     If InStr(1, Que_Copia, "Tornat") > 0 Then MySql = MySql & "s.QuantitatTornada,"
     MySql = MySql & " s.Hora, 3, isnull(s.Comentari,'') comentari, s.ComentariPer, s.Atribut "
     MySql = MySql & " From " & taulaServits(Di) & " s "
     MySql = MySql & " left join articlespropietats ap on s.codiarticle=ap.codiarticle and ap.variable='NoCopies' "
     MySql = MySql & " WHERE isnull(ap.valor, '') <> 'on' and isnull(comentari,'') not like '%Reposicio%'  "
     If InStr(1, Que_Copia, "Encargos") = 0 Then
        MySql = MySql & " and s.TipusComanda<>2 "
     End If
     If Len(S_Viatge) > 0 Then MySql = MySql & " and s.Viatge = '" & S_Viatge & "' "
     
     If Cli <> -1 Then
        MySql = MySql & " and s.Client = " & Cli & " "
        If Len(LlistaCl) > 0 Then LlistaCl = LlistaCl & ","
        LlistaCl = LlistaCl & Cli
     Else
        LlistaCl = "Tots"
     End If
'     MySql = MySql & " Group By Client,Codiarticle,Atribut,Viatge,Equip,Comentari,PluUtilitzat,ComentariPer "
     ExecutaComandaSql MySql
     Cli = Val(Car(S_Cli))
   Wend
     
     '  MySql = "UPDATE [Traspas] "
     '  MySql = MySql & "Set [" & Nomtaula & "].Viatge = Memotecnics.Viatge, "
     '  MySql = MySql & "[" & Nomtaula & "].Equip = Memotecnics.Equip, "
     '  MySql = MySql & "[" & Nomtaula & "].Atribut = Memotecnics.Atribut, "
     '  MySql = MySql & "[" & Nomtaula & "].CodiArticle = Memotecnics.Codi "
     '  MySql = MySql & "From [" & Nomtaula & "] Join Memotecnics On [" & Nomtaula & "].PluUtilitzat = Memotecnics.Memotecnic "
     '  ExecutaComandaSql MySql
   
     ExecutaComandaSql "Update [Traspas] Set TipusComanda = 3 "
     
     If Que_Copia = "" Then
        If Not (UCase(EmpresaActual) = UCase("Eurofleca") Or UCase(EmpresaActual) = UCase("armengol") Or UCase(EmpresaActual) = UCase("mariel")) Then
               ExecutaComandaSql "Update [Traspas] Set QuantitatServida = QuantitatDemanada Where QuantitatServida = 0  "
        End If
     End If
     
' 11/02/2011 Puesto por Jordi
' Modificado por Jorge para que no borre los que estan fijos en graella nuevo campo de productos
' *****************************************
     ExecutaComandaSql "DELETE [Traspas] WHERE QuantitatDemanada = 0 and QuantitatServida = 0 and CodiArticle not in (select CodiArticle from ArticlesPropietats where Variable = 'FixaGraella' and Valor = 'on')"
' *****************************************
     
     
     '  MySql = "DELETE Traspas "
     '  MySql = MySql & " FROM Traspas LEFT JOIN Memotecnics ON Traspas.PluUtilitzat = Memotecnics.Memotecnic "
     '  MySql = MySql & " WHERE Memotecnics.Memotecnic Is Null "
     '  ExecutaComandaSql MySql
    
    ExecutaComandaSql "UPDATE [Traspas] set comentari = RTRIM(LTRIM(Comentari))"
    
    Dim intentos
    Dim nRegs1
    Set rs = Db.OpenResultset("select count(*) nRegs from Traspas where Comentari like '%IdAlbara:%'")
    nRegs1 = rs("nRegs")
    intentos = 0
    While nRegs1 > 0 And intentos < 10
        MySql = "Update Traspas  "
        MySql = MySql & " Set Comentari = "
        MySql = MySql & " left (rtrim(Comentari),charindex('IdAlbara:',rtrim(Comentari))-2) + right(rtrim(Comentari),len(rtrim(Comentari))-charindex(']',rtrim(Comentari),charindex('IdAlbara:',rtrim(Comentari)))) "
        MySql = MySql & " where Comentari like '%IdAlbara:%' "
        ExecutaComandaSql MySql
        
        Set rs = Db.OpenResultset("select count(*) nRegs from Traspas where Comentari like '%IdAlbara:%'")
        nRegs1 = rs("nRegs")
        intentos = intentos + 1
    Wend
    
    Dim nRegs
    Set rs = Db.OpenResultset("select count(*) nRegs from Traspas where Comentari like '%Lote:%'")
    nRegs = rs("nRegs")
    intentos = 0
    While nRegs > 0 And intentos < 10
        MySql = "Update Traspas  "
        MySql = MySql & " Set Comentari = "
        MySql = MySql & " left (Comentari,charindex('Lote:',Comentari)-2) + right(Comentari,len(Comentari)-charindex(']',Comentari,charindex('Lote:',Comentari))) "
        MySql = MySql & " where Comentari like '%Lote:%' "
        ExecutaComandaSql MySql
        
        Set rs = Db.OpenResultset("select count(*) nRegs from Traspas where Comentari like '%Lote:%'")
        nRegs = rs("nRegs")
        intentos = intentos + 1
    Wend

    'TrigguerEsborraTimeStamp DonamNomTaulaServit(Df) '!!!!!!!!!!!!!!!
    PauseTrigger Df, True
   
    If InStr(1, Que_Copia, "NOSobreEscriure") = 0 Then
    
        If UCase(EmpresaActual) = UCase("Demo") Or UCase(EmpresaActual) = UCase("Panet") Or UCase(EmpresaActual) = UCase("Tena") Then
            MySqlBk = "insert into " & DonamNomTaulaHistoricServit(Now()) & " "
            MySqlBk = MySqlBk & "(IdServit, DataServit, Tipus, Desde, QuiStamp, Client, CodiArticle, Viatge, Equip, QuantitatDemanada, QuantitatTornada, QuantitatServida, TipusComanda, Comentari) "
            MySqlBk = MySqlBk & "select Id, '" & Df & "', 'DEL_C', 'SNC_C', '" & Qui_Copia & "', client, codiarticle, Viatge, Equip, "
            MySqlBk = MySqlBk & "       QuantitatDemanada, QuantitatTornada, QuantitatServida, Tipuscomanda, Comentari "
            MySqlBk = MySqlBk & "from " & taulaServits(Df) & " "
        End If
    
        MySql = "Delete " & taulaServits(Df) & " Where TipusComanda <> 2 "
        MySqlBk = MySqlBk & "Where TipusComanda <> 2 "
     
        If LlistaCl <> "Tots" Then
            MySql = MySql & " And Client in (" & LlistaCl & ")"
            MySqlBk = MySqlBk & " And Client in (" & LlistaCl & ")"
        End If
    
        If Len(S_Viatge) > 0 Then
            MySql = MySql & " And  Viatge = '" & S_Viatge & "' "
            MySqlBk = MySqlBk & " And  Viatge = '" & S_Viatge & "' "
        End If
    
        If UCase(EmpresaActual) = UCase("Demo") Or UCase(EmpresaActual) = UCase("Panet") Or UCase(EmpresaActual) = UCase("Tena") Then ExecutaComandaSql MySqlBk
        ExecutaComandaSql MySql
    End If
     
    MySql = "INSERT INTO " & taulaServits(Df) & " (id, QuantitatServida, Atribut, QuantitatDemanada, CodiArticle, Client, Hora, TipusComanda, Comentari, ComentariPer, Viatge, Equip, PluUtilitzat, QuantitatTornada ) "
    MySql = MySql & "SELECT max(cast(Traspas.id as nvarchar(255))), Sum(Traspas.QuantitatServida) AS QuantitatServida,Traspas.Atribut,Sum(Traspas.QuantitatDemanada) AS QuantitatDemanada, Traspas.CodiArticle, Traspas.Client, Traspas.Hora, Traspas.TipusComanda, Traspas.Comentari, Traspas.ComentariPer, Traspas.Viatge, Traspas.Equip, Traspas.PluUtilitzat,Sum(Traspas.QuantitatTornada) AS QuantitatTornada "
    MySql = MySql & "FROM Traspas INNER JOIN Articles ON Traspas.CodiArticle = Articles.Codi "
    MySql = MySql & "GROUP BY Traspas.Atribut, Traspas.CodiArticle, Traspas.Client, Traspas.Hora, Traspas.TipusComanda, Traspas.Comentari, Traspas.ComentariPer, Traspas.Viatge, Traspas.Equip, Traspas.PluUtilitzat  "
    ExecutaComandaSql MySql
    
    If UCase(EmpresaActual) = UCase("Demo") Or UCase(EmpresaActual) = UCase("Panet") Or UCase(EmpresaActual) = UCase("Tena") Then
         MySql = "insert into " & DonamNomTaulaHistoricServit(Now()) & " "
         MySql = MySql & "(IdServit, DataServit, Tipus, Desde, QuiStamp, Client, CodiArticle, Viatge, Equip, QuantitatDemanada, QuantitatTornada, QuantitatServida, TipusComanda, Comentari) "
         MySql = MySql & "select id, '" & Df & "', 'COPIA', 'SNC_C', '" & Qui_Copia & "', client, Codiarticle, Viatge, Equip, "
         MySql = MySql & "       QuantitatDemanada, QuantitatTornada, QuantitatServida, TipusComanda, Comentari "
         MySql = MySql & "from Traspas "
         ExecutaComandaSql MySql
    End If
   
    ExecutaComandaSql "UPDATE " & taulaServits(Df) & " Set QuantitatDemanada = 0 Where QuantitatDemanada is null"
    ExecutaComandaSql "UPDATE " & taulaServits(Df) & " Set QuantitatServida = 0 Where QuantitatDemanada is null"
    ExecutaComandaSql "UPDATE " & taulaServits(Df) & " Set QuantitatTornada = 0 Where QuantitatDemanada is null"
    ExecutaComandaSql "Drop Table Traspas"
    
   PauseTrigger Df, False
   
End Sub
Sub CopiaComandesOrigen(S_Di As String, S_Df As String, S_Cli As String, S_Viatge As String, Que_Copia As String)
   Dim Di As Date, Df As Date, Cli As Double, cliOrg As Double
   Dim MySql As String, sql As String, LlistaCl As String, MySqlBk As String, Qui_Copia As String
   Dim rs As rdoResultset
   
   S_Cli = Join(Split(S_Cli, "[0]"), "[-8]")
   
   cliOrg = Val(Car(S_Cli))
   
   Qui_Copia = Mid(Split(Que_Copia, "]")(0), 2)
   Que_Copia = Split(Que_Copia, "]")(1)
   
   Informa "CopiaComandes " & S_Di & " A " & S_Df & " De " & S_Cli
   
   Di = StData(Car(S_Di))
   Df = StData(Car(S_Df))
   
   ExecutaComandaSql "Drop Table Traspas"
   ExecutaComandaSql "UPDATE " & taulaServits(Di) & " Set TipusComanda = 1 Where not TipusComanda in(1,2,3) "
   
   sql = "CREATE TABLE [Traspas] ("
   sql = sql & "[Id]                [uniqueidentifier] Default (NEWID()),"
   sql = sql & "[TimeStamp]         [datetime]            ,"
   sql = sql & "[QuiStamp]          [nvarchar] (255)      ,"
   sql = sql & "[Client]            [float]          Null ,"
   sql = sql & "[CodiArticle]       [int]            Null ,"
   sql = sql & "[PluUtilitzat]      [nvarchar] (255) Null ,"
   sql = sql & "[Viatge]            [nvarchar] (255) Null ,"
   sql = sql & "[Equip]             [nvarchar] (255) Null ,"
   sql = sql & "[QuantitatDemanada] [float]                 Default (0),"
   sql = sql & "[QuantitatTornada]  [float]                 Default (0),"
   sql = sql & "[QuantitatServida]  [float]                 Default (0),"
   sql = sql & "[MotiuModificacio]  [nvarchar] (255) Null ,"
   sql = sql & "[Hora]              [float]          Null ,"
   sql = sql & "[TipusComanda]      [float]          Null ,"
   sql = sql & "[Comentari]         [nvarchar] (255) Null ,"
   sql = sql & "[ComentariPer]      [nvarchar] (255) Null ,"
   sql = sql & "[Atribut]           [Int]            Null ,"
   sql = sql & "[CitaDemanada]      [nvarchar] (255)        Default (''),"
   sql = sql & "[CitaServida]       [nvarchar] (255)        Default (''),"
   sql = sql & "[CitaTornada]       [nvarchar] (255)        Default ('') "
   sql = sql & ") ON [PRIMARY]"
   ExecutaComandaSql (sql)

   Cli = Val(Car(S_Cli))
   LlistaCl = ""
   While Cli <> 0
     '  If Machaca.Value = 1 Then     ExecutaComandaSql "Update [" & DonamNomTaulaServit(Df) & "] Set QuantitatDemanada = 0 WHERE Client = " & Cli & " AND TipusComanda <> 2 "
     MySql = "INSERT INTO [Traspas] "
     MySql = MySql & " (Client,Codiarticle,PluUtilitzat,Viatge,Equip,QuantitatDemanada,"
     If InStr(1, Que_Copia, "Servit") > 0 Then MySql = MySql & "QuantitatServida,"
     If InStr(1, Que_Copia, "Tornat") > 0 Then MySql = MySql & "QuantitatTornada,"
     MySql = MySql & "Hora,TipusComanda,Comentari,ComentariPer,Atribut) "
     MySql = MySql & " SELECT "
     MySql = MySql & Cli & " , s.Codiarticle, s.PluUtilitzat, s.Viatge, s.Equip, s.QuantitatDemanada, "
     If InStr(1, Que_Copia, "Servit") > 0 Then MySql = MySql & "s.QuantitatServida,"
     If InStr(1, Que_Copia, "Tornat") > 0 Then MySql = MySql & "s.QuantitatTornada,"
     MySql = MySql & "s.Hora, 3, isnull(s.Comentari,'') comentari, s.ComentariPer, s.Atribut "
     MySql = MySql & " From " & taulaServits(Di) & " s "
     MySql = MySql & " left join articlespropietats ap on s.codiarticle=ap.codiarticle and ap.variable='NoCopies' "
     MySql = MySql & " WHERE  isnull(ap.valor, '') <> 'on' and isnull(comentari,'') not like '%Reposicio%' "
     If InStr(1, Que_Copia, "Encargos") = 0 Then
        MySql = MySql & " and s.TipusComanda<>2 "
     End If

     If Len(S_Viatge) > 0 Then MySql = MySql & " and s.Viatge = '" & S_Viatge & "' "
     
     If Cli <> -1 Then
        MySql = MySql & " and s.Client = " & cliOrg & " "
        If Len(LlistaCl) > 0 Then LlistaCl = LlistaCl & ","
        LlistaCl = LlistaCl & Cli
     Else
        LlistaCl = "Tots"
     End If

     ExecutaComandaSql MySql
     Cli = Val(Car(S_Cli))
   Wend
     
   
    ExecutaComandaSql "Update [Traspas] Set TipusComanda = 3 "
    
    If Que_Copia = "" Then
        If Not (UCase(EmpresaActual) = UCase("Eurofleca") Or UCase(EmpresaActual) = UCase("mariel")) Then
            ExecutaComandaSql "Update [Traspas] Set QuantitatServida = QuantitatDemanada Where QuantitatServida = 0  "
        End If
    End If
     
    ExecutaComandaSql "DELETE [Traspas] WHERE QuantitatTornada = 0 and QuantitatDemanada = 0 and QuantitatServida = 0 and CodiArticle not in (select CodiArticle from ArticlesPropietats where Variable = 'FixaGraella' and Valor = 'on')"
    ExecutaComandaSql "UPDATE [Traspas] set comentari = RTRIM(LTRIM(Comentari))"

    Dim nRegs1
    Set rs = Db.OpenResultset("select count(*) nRegs from Traspas where Comentari like '%IdAlbara:%'")
    nRegs1 = rs("nRegs")
    Dim intentos
    intentos = 0
    While nRegs1 > 0 And intentos < 10
        MySql = "Update Traspas  "
        MySql = MySql & " Set Comentari = "
        MySql = MySql & " left (Comentari,charindex('IdAlbara:',Comentari)-2) + right(Comentari,len(Comentari)-charindex(']',Comentari,charindex('IdAlbara:',Comentari))) "
        MySql = MySql & " where Comentari like '%IdAlbara:%' "
        ExecutaComandaSql MySql
        
        Set rs = Db.OpenResultset("select count(*) nRegs from Traspas where Comentari like '%IdAlbara:%'")
        nRegs1 = rs("nRegs")
        intentos = intentos + 1
    Wend
    
    Dim nRegs
    Set rs = Db.OpenResultset("select count(*) nRegs from Traspas where Comentari like '%Lote:%'")
    nRegs = rs("nRegs")
    intentos = 0
    While nRegs > 0 And intentos < 10
        MySql = "Update Traspas  "
        MySql = MySql & " Set Comentari = "
        MySql = MySql & " left (Comentari,charindex('Lote:',Comentari)-2) + right(Comentari,len(Comentari)-charindex(']',Comentari,charindex('Lote:',Comentari))) "
        MySql = MySql & " where Comentari like '%Lote:%' "
        ExecutaComandaSql MySql
        
        Set rs = Db.OpenResultset("select count(*) nRegs from Traspas where Comentari like '%Lote:%'")
        nRegs = rs("nRegs")
        intentos = intentos + 1
    Wend

   'TrigguerEsborraTimeStamp DonamNomTaulaServit(Df)
    PauseTrigger Df, True
   
    If InStr(1, Que_Copia, "NOSobreEscriure") = 0 Then
        If UCase(EmpresaActual) = UCase("Demo") Or UCase(EmpresaActual) = UCase("Panet") Or UCase(EmpresaActual) = UCase("Tena") Then
            MySqlBk = "insert into " & DonamNomTaulaHistoricServit(Now()) & " "
            MySqlBk = MySqlBk & "(IdServit, DataServit, Tipus, Desde, QuiStamp, Client, CodiArticle, Viatge, Equip, QuantitatDemanada, QuantitatTornada, QuantitatServida, TipusComanda, Comentari) "
            MySqlBk = MySqlBk & "select Id, '" & Df & "', 'DEL_C', 'SNC_CO', '" & Qui_Copia & "', client, codiarticle, Viatge, Equip, "
            MySqlBk = MySqlBk & "       QuantitatDemanada, QuantitatTornada, QuantitatServida, Tipuscomanda, Comentari "
            MySqlBk = MySqlBk & "from " & taulaServits(Df) & " "
        End If
        
        MySql = "Delete " & taulaServits(Df) & " Where TipusComanda <> 2 "
        MySqlBk = MySqlBk & "Where TipusComanda <> 2 "
     
        If LlistaCl <> "Tots" Then
            MySql = MySql & " And Client in (" & LlistaCl & ")"
            MySqlBk = MySqlBk & " And Client in (" & LlistaCl & ")"
        End If
    
        If Len(S_Viatge) > 0 Then
            MySql = MySql & " And  Viatge = '" & S_Viatge & "' "
            MySqlBk = MySqlBk & " And  Viatge = '" & S_Viatge & "' "
        End If
    
        If UCase(EmpresaActual) = UCase("Demo") Or UCase(EmpresaActual) = UCase("Panet") Or UCase(EmpresaActual) = UCase("Tena") Then ExecutaComandaSql MySqlBk
        ExecutaComandaSql MySql
    End If
     
    MySql = "INSERT INTO " & taulaServits(Df) & " ( QuantitatServida,Atribut, QuantitatDemanada, CodiArticle, Client, Hora, TipusComanda, Comentari, ComentariPer, Viatge, Equip, PluUtilitzat, QuantitatTornada ) "
    MySql = MySql & "SELECT Sum(Traspas.QuantitatServida) AS QuantitatServida,Traspas.Atribut,Sum(Traspas.QuantitatDemanada) AS QuantitatDemanada, Traspas.CodiArticle, Traspas.Client, Traspas.Hora, Traspas.TipusComanda, Traspas.Comentari, Traspas.ComentariPer, Traspas.Viatge, Traspas.Equip, Traspas.PluUtilitzat, Sum(Traspas.QuantitatTornada) AS QuantitatTornada "
    MySql = MySql & "FROM Traspas INNER JOIN Articles ON Traspas.CodiArticle = Articles.Codi "
    MySql = MySql & "GROUP BY Traspas.Atribut, Traspas.CodiArticle, Traspas.Client, Traspas.Hora, Traspas.TipusComanda, Traspas.Comentari, Traspas.ComentariPer, Traspas.Viatge, Traspas.Equip, Traspas.PluUtilitzat  "
    ExecutaComandaSql MySql
  
    If UCase(EmpresaActual) = UCase("Demo") Or UCase(EmpresaActual) = UCase("Panet") Or UCase(EmpresaActual) = UCase("Tena") Then
         MySql = "insert into " & DonamNomTaulaHistoricServit(Now()) & " "
         MySql = MySql & "(IdServit, DataServit, Tipus, Desde, QuiStamp, Client, CodiArticle, Viatge, Equip, QuantitatDemanada, QuantitatTornada, QuantitatServida, TipusComanda, Comentari) "
         MySql = MySql & "select id, '" & Df & "', 'COPIA', 'SNC_CO', '" & Qui_Copia & "', client, Codiarticle, Viatge, Equip, "
         MySql = MySql & "       QuantitatDemanada, QuantitatTornada, QuantitatServida, TipusComanda, Comentari "
         MySql = MySql & "from Traspas "
         ExecutaComandaSql MySql
    End If
    
    ExecutaComandaSql "UPDATE " & taulaServits(Df) & " Set QuantitatDemanada = 0 Where QuantitatDemanada is null"
    ExecutaComandaSql "UPDATE " & taulaServits(Df) & " Set QuantitatServida = 0 Where QuantitatDemanada is null"
    ExecutaComandaSql "UPDATE " & taulaServits(Df) & " Set QuantitatTornada = 0 Where QuantitatDemanada is null"
    ExecutaComandaSql "Drop Table Traspas"
    
   PauseTrigger Df, False
   
End Sub

Sub CopiaComandesTraspas(S_Di As String, S_Df As String, S_Cli As String, S_Viatge As String, Que_Copia As String)
   Dim Di As Date, Df As Date, D As Date, Cli As Double, cliOrg As Double
   Dim sql As String, Qui_Copia As String
   
   S_Cli = Join(Split(S_Cli, "[0]"), "[-8]")
   
   cliOrg = Val(Car(S_Cli))
   
   Qui_Copia = Mid(Split(Que_Copia, "]")(0), 2)
'   Que_Copia = Split(Que_Copia, "]")(1) 'COPIA TODO
   
   Informa "CopiaComandesTraspas " & S_Di & " A " & S_Df & " De " & S_Cli
   
   Di = StData(Car(S_Di))
   Df = StData(Car(S_Df))
   
   Cli = Val(Car(S_Cli))
   
   For D = Di To Df
        sql = "update " & taulaServits(D) & " set client = " & Cli & ", QuiStamp='" & Qui_Copia & "' where isnull(motiuModificacio, '')='' and client = " & cliOrg
        ExecutaComandaSql sql
   Next
   
   
End Sub


Sub ComandaAutomatica(S_Di As String, S_Df As String, S_Cli As String)
   Dim Di As Date, Df As Date, Cli As Double, MySql As String, sql As String, LlistaCl As String
   Informa "CopiaComandes " & S_Di & " A " & S_Df & " De " & S_Cli
   
   Di = StData(Car(S_Di))
   Df = StData(Car(S_Df))
   ExecutaComandaSql "Drop Table Traspas"
'   ExecutaComandaSql "UPDATE [" & DonamNomTaulaServit(Di) & "] Set TipusComanda = 1 Where not TipusComanda in(1,2,3) "
   
   sql = "CREATE TABLE [Traspas] ("
   sql = sql & "[Id]                [uniqueidentifier] Default (NEWID()),"
   sql = sql & "[TimeStamp]         [datetime]            ,"
   sql = sql & "[QuiStamp]          [nvarchar] (255)      ,"
   sql = sql & "[Client]            [float]          Null ,"
   sql = sql & "[CodiArticle]       [int]            Null ,"
   sql = sql & "[PluUtilitzat]      [nvarchar] (255) Null ,"
   sql = sql & "[Viatge]            [nvarchar] (255) Null ,"
   sql = sql & "[Equip]             [nvarchar] (255) Null ,"
   sql = sql & "[QuantitatDemanada] [float]                 Default (0),"
   sql = sql & "[QuantitatTornada]  [float]                 Default (0),"
   sql = sql & "[QuantitatServida]  [float]                 Default (0),"
   sql = sql & "[MotiuModificacio]  [nvarchar] (255) Null ,"
   sql = sql & "[Hora]              [float]          Null ,"
   sql = sql & "[TipusComanda]      [float]          Null ,"
   sql = sql & "[Comentari]         [nvarchar] (255) Null ,"
   sql = sql & "[ComentariPer]      [nvarchar] (255) Null ,"
   sql = sql & "[Atribut]           [Int]            Null ,"
   sql = sql & "[CitaDemanada]      [nvarchar] (255)        Default (''),"
   sql = sql & "[CitaServida]       [nvarchar] (255)        Default (''),"
   sql = sql & "[CitaTornada]       [nvarchar] (255)        Default ('') "
   sql = sql & ") ON [PRIMARY]"
   ExecutaComandaSql (sql)

   Cli = Val(Car(S_Cli))
   LlistaCl = ""
   While Cli <> 0
     '  If Machaca.Value = 1 Then     ExecutaComandaSql "Update [" & DonamNomTaulaServit(Df) & "] Set QuantitatDemanada = 0 WHERE Client = " & Cli & " AND TipusComanda <> 2 "
     MySql = "INSERT INTO [Traspas] "
     MySql = MySql & " (Client,Codiarticle,PluUtilitzat,Viatge,Equip,QuantitatDemanada,Hora,TipusComanda,Comentari,ComentariPer,Atribut) "
     MySql = MySql & " SELECT "
     MySql = MySql & " Botiga,Plu,Plu,'Primer','Forners',sum(Quantitat),0,3,'','',0 "
     MySql = MySql & " From [" & NomTaulaVentas(Di) & "]"
     MySql = MySql & " WHERE Day(data) = " & Day(Di) & " And "
     If Cli <> -1 Then
        MySql = MySql & " Botiga = " & Cli & " "
        If Len(LlistaCl) > 0 Then LlistaCl = LlistaCl & ","
        LlistaCl = LlistaCl & Cli
     Else
        LlistaCl = "Tots"
     End If
     MySql = MySql & " Group By Plu,Botiga"
     ExecutaComandaSql MySql
     Cli = Val(Car(S_Cli))
   Wend
     
     '  MySql = "UPDATE [Traspas] "
     '  MySql = MySql & "Set [" & Nomtaula & "].Viatge = Memotecnics.Viatge, "
     '  MySql = MySql & "[" & Nomtaula & "].Equip = Memotecnics.Equip, "
     '  MySql = MySql & "[" & Nomtaula & "].Atribut = Memotecnics.Atribut, "
     '  MySql = MySql & "[" & Nomtaula & "].CodiArticle = Memotecnics.Codi "
     '  MySql = MySql & "From [" & Nomtaula & "] Join Memotecnics On [" & Nomtaula & "].PluUtilitzat = Memotecnics.Memotecnic "
     '  ExecutaComandaSql MySql
   
     ExecutaComandaSql "Update [Traspas] Set TipusComanda = 3 "
     ExecutaComandaSql "DELETE [Traspas] WHERE QuantitatDemanada <= 0"

     '  MySql = "DELETE Traspas "
     '  MySql = MySql & " FROM Traspas LEFT JOIN Memotecnics ON Traspas.PluUtilitzat = Memotecnics.Memotecnic "
     '  MySql = MySql & " WHERE Memotecnics.Memotecnic Is Null "
     '  ExecutaComandaSql MySql

   TrigguerEsborraTimeStamp DonamNomTaulaServit(Df)
   PauseTrigger Df, True
   
     MySql = "Delete [" & DonamNomTaulaServit(Df) & "] Where TipusComanda <> 2 "
     If LlistaCl <> "Tots" Then MySql = MySql & " And Client in (" & LlistaCl & ")"
     ExecutaComandaSql MySql
     
     MySql = "INSERT INTO [" & DonamNomTaulaServit(Df) & "] ( Atribut, QuantitatDemanada, CodiArticle, Client, Hora, TipusComanda, Comentari, ComentariPer, Viatge, Equip, PluUtilitzat ) "
     MySql = MySql & "SELECT Traspas.Atribut,Sum(Traspas.QuantitatDemanada) AS QuantitatDemanada, Traspas.CodiArticle, Traspas.Client, Traspas.Hora, Traspas.TipusComanda, Traspas.Comentari, Traspas.ComentariPer, Traspas.Viatge, Traspas.Equip, Traspas.PluUtilitzat "
     MySql = MySql & "FROM Traspas INNER JOIN Articles ON Traspas.CodiArticle = Articles.Codi "
     MySql = MySql & "GROUP BY Traspas.Atribut, Traspas.CodiArticle, Traspas.Client, Traspas.Hora, Traspas.TipusComanda, Traspas.Comentari, Traspas.ComentariPer, Traspas.Viatge, Traspas.Equip, Traspas.PluUtilitzat  "
     ExecutaComandaSql MySql
  
     ExecutaComandaSql "UPDATE [" & DonamNomTaulaServit(Df) & "] Set QuantitatDemanada = 0 Where QuantitatDemanada is null"
     ExecutaComandaSql "UPDATE [" & DonamNomTaulaServit(Df) & "] Set QuantitatServida = 0 Where QuantitatDemanada is null"
     ExecutaComandaSql "UPDATE [" & DonamNomTaulaServit(Df) & "] Set QuantitatTornada = 0 Where QuantitatDemanada is null"
     ExecutaComandaSql "Drop Table Traspas"
   PauseTrigger Df, False
   
End Sub

Sub ImportarTicketsAFacturacio(S_Di As String, S_Df As String, S_CliFi As String, S_Cli As String)
   Dim Di As Date, Df As Date, Cli As Double, MySql As String, CliFi As String, TaulaDesti As String
   
   Informa "ImportarTicketsAFacturacio " & S_Di & " A " & S_Df & " De " & S_CliFi & " A " & S_Cli
   
   Di = StData(Car(S_Di))
   Df = StData(Car(S_Df))
   Cli = Val(Car(S_Cli))
   CliFi = Car(S_CliFi)
      
   While Di <= Df
      
      MySql = "Delete [" & DonamNomTaulaServit(Di) & "]"
      MySql = MySql & "Where Client = " & Cli & " And Comentari In( "
      MySql = MySql & "Select '[Tick:' + cast([Num_Tick] as nvarchar) + ']' + '[V:' + [Tipus_venta] + ']' "
      MySql = MySql & "From [" & NomTaulaVentas(Di) & "] "
      MySql = MySql & "Where Otros Like '%" & CliFi & "%' And Day(Data) = " & Day(Di) & ") "
      ExecutaComandaSql MySql
      DoEvents
      MySql = "Insert Into [" & DonamNomTaulaServit(Di) & "]"
      MySql = MySql & "(TipusComanda,Client, CodiArticle, QuantitatServida, QuantitatDemanada, Comentari, ComentariPer) "
      MySql = MySql & "Select 2," & Cli & ", Plu, Quantitat, Quantitat,'[Tick:' + cast([Num_Tick] as nvarchar) + ']' + '[V:' + [Tipus_venta] + ']',Import "
      MySql = MySql & "From [" & NomTaulaVentas(Di) & "] "
      MySql = MySql & "Where Otros Like '%" & CliFi & "%' And Day(Data) = " & Day(Di) & " "
      ExecutaComandaSql MySql
      DoEvents
      Di = DateAdd("d", 1, Di)
   Wend
   
End Sub



Sub CalculaComandes(D As Date, bo As Double, TipComanda As String)
    Dim NomTaula As String, LlistaCamps As String, dd As Date, sql As String, i As Integer, TaunaEst As String
    Dim LlistaCamps2
    Dim Facto As Double, Acc As Double
    
    Missatges_CalEnviar "Comandes", "[" & bo & "][" & Format(D, "dd-mm-yyyy") & "]"
    Informa2 BotigaCodiNom(bo) & " -> " & TipComanda
    
    NomTaula = "[" & DonamNomTaulaServit(D) & "]"
    LlistaCamps2 = " [Client],[CodiArticle],[PluUtilitzat],[Viatge],[Equip],[QuantitatDemanada],[Comentari],[ComentariPer],[Atribut],[Hora]"
    
    ExecutaComandaSql "Delete " & NomTaula & " Where Client = " & bo & " And Hora = 91 "
    
    Select Case TipComanda
        Case "No", "1"
        Case "Copia", "3"
            ExecutaComandaSql "Insert Into " & NomTaula & " (" & LlistaCamps2 & ",TipusComanda) Select " & LlistaCamps2 & ",0 As TipusComanda From [" & DonamNomTaulaServit(DateAdd("d", -7, D)) & "] Where Client = " & bo & " And (TipusComanda = 0 or TipusComanda = 1) "
        Case "vell2 previsio"
'            Sql = ""
'            Dd = DateAdd("d", -7, D)
'            Acc = 0
'            Facto = 4
'            For i = 1 To 3
'                If i > 1 Then Sql = Sql & " Union All "
'                Sql = Sql & " Select (Sum(Quantitat)) As Q,plu As A From [" & NomTaulaVentas(Dd) & "] Where botiga = " & Bo & " And "
'                Sql = Sql & " Data > CONVERT(datetime,'" & Format(Dd, "dd/mm/yy") & "',3) And data < CONVERT(datetime,'" & Format(DateAdd("d", 1, Dd), "dd/mm/yy") & "',3) "
'                Sql = Sql & " Group by plu "
'
'                Acc = Acc + Facto
'                Facto = Int(Facto / 2)
'                Dd = DateAdd("d", -7, Dd)
'            Next
'
'            LlistaCamps = " " & Bo & " As [Client],A As [CodiArticle] ,'Auto' As [PluUtilitzat],'Auto' As [Viatge],'Auto' As [Equip],(CASE articles.essumable WHEN 1 THEN round(avg(Q),0) ELSE round(avg(Q),2) END) As [QuantitatDemanada],'' As [Comentari],'' As [ComentariPer],0 As [Atribut],91 as Hora"
'            Sql = "Insert Into " & Nomtaula & " (" & LlistaCamps2 & ") Select " & LlistaCamps & " From (" & Sql
'            Sql = Sql & ") As Aa Join Articles On Articles.Codi = Aa.a group By Aa.A,Articles.EsSumable "
'            Informa2 BotigaCodiNom(Bo) & " -> " & TipComanda & " a"
'            ExecutaComandaSql Sql
'
'            'Assignem Viatges i Equips
'            ' Primer Els Asignats per client
'            Sql = "Update " & Nomtaula & " Set  viatge=B.Viatge ,equip =B.Equip "
'            Sql = Sql & "From  " & Nomtaula & " As A ,ComandesMemotecnicPerClient As B "
'            Sql = Sql & "Where A.Client = b.Client And a.CodiArticle = b.CodiArticle And a.viatge='Auto' And a.equip ='Auto' "
'            Informa2 BotigaCodiNom(Bo) & " -> " & TipComanda & " b"
'            ExecutaComandaSql Sql
'
'            ' Creem els Memotecnics Nous
'            Sql = "Insert Into Memotecnics SELECT DISTINCT 0 AS Tpv, 'Auto' AS Memotecnic, CodiArticle AS AsCodi, "
'            Sql = Sql & "(SELECT TOP 1 Nom From Viatges ORDER BY Defecte DESC) AS Viatge,(SELECT TOP 1 Nom From EquipsDeTreball ORDER BY Defecte DESC) AS Equip, 0 AS atribut "
'            Sql = Sql & "From " & Nomtaula & " "
'            Sql = Sql & "WHERE Viatge = 'Auto' AND Equip = 'Auto' And Not CodiArticle In (Select Distinct Codi From Memotecnics)"
'            Informa2 BotigaCodiNom(Bo) & " -> " & TipComanda & " c"
'            ExecutaComandaSql Sql
'
'            ' Despres els de Memotecnics
'            Sql = "Update " & Nomtaula & " Set  viatge=B.Viatge ,equip =B.Equip "
'            Sql = Sql & "From  " & Nomtaula & " As A ,Memotecnics As B "
'            Sql = Sql & "Where A.codiarticle = b.Codi And a.viatge='Auto' and a.equip ='Auto'"
'            Informa2 BotigaCodiNom(Bo) & " -> " & TipComanda & " d"
'            ExecutaComandaSql Sql
            
        Case "Venut+Tornat", "4", "Previsio", "2"
            dd = DateAdd("d", -7, D)
            LlistaCamps = " " & bo & " As [Client],A As [CodiArticle] ,'Auto' As [PluUtilitzat],'Auto' As [Viatge],'Auto' As [Equip],(CASE articles.essumable WHEN 1 THEN round(avg(Q),0) ELSE round(avg(Q),2) END) As [QuantitatDemanada],'' As [Comentari],'' As [ComentariPer],0 As [Atribut],91 as Hora"
            
            sql = ""  'Insertem Les Ventes i  Devolucions De l'estadistic
            sql = "Select (Sum(Quantitat)) As Q,Producte As A From [" & nomTaulaEstadistic(dd) & "] Where Client = " & bo & " And  Dia = " & Day(dd) & " And (Tipus = 1 Or Tipus = 2) Group by Producte "
            sql = "Insert Into " & NomTaula & " (" & LlistaCamps2 & ") Select " & LlistaCamps & " From (" & sql
            sql = sql & ") As Aa Join Articles On Articles.Codi = Aa.a group By Aa.A,Articles.EsSumable "
            Informa2 BotigaCodiNom(bo) & " -> " & TipComanda & " a"
            ExecutaComandaSql sql
            
            sql = ""
            sql = sql & " UPDATE " & NomTaula & " "  'Compactem els compactables
            sql = sql & " SET  " & NomTaula & ".CodiArticle = ComandesParams.Valor From " & NomTaula & " INNER JOIN ComandesParams "
            sql = sql & " ON ComandesParams.Tipus = 3 AND " & NomTaula & ".CodiArticle = ComandesParams.Camp"
            sql = sql & " WHERE (" & NomTaula & ".Client = " & bo & " )"
            ExecutaComandaSql sql
            
            sql = ""
            sql = sql & " Delete " & NomTaula & " "  'Treiem els no previsibles
            sql = sql & " From " & NomTaula & " INNER JOIN ComandesParams "
            sql = sql & " ON ComandesParams.Tipus = 2 AND " & NomTaula & ".CodiArticle = ComandesParams.Camp And (Valor = 2 Or Valor = 3 Or Valor = 4 Or Valor = 5 Or Valor = 6 Or Valor = 7 Or Valor = 8 Or Valor = 9 Or Valor = 10) "
            sql = sql & " WHERE (" & NomTaula & ".Client = " & bo & " )"
            ExecutaComandaSql sql
            
            'Assignem Viatges i Equips
            ' Primer Els Asignats per client  !!!!!!!!!! Cal crear la taula ComandesMemotecnicPerClient
            sql = "Update " & NomTaula & " Set  viatge=B.Viatge ,equip =B.Equip "
            sql = sql & "From  " & NomTaula & " As A ,ComandesMemotecnicPerClient As B "
            sql = sql & "Where A.Client = b.Client And a.CodiArticle = b.CodiArticle And a.viatge='Auto' And a.equip ='Auto' "
            Informa2 BotigaCodiNom(bo) & " -> " & TipComanda & " b"
            ExecutaComandaSql sql
            
            ' Creem els Memotecnics Nous
            sql = "Insert Into Memotecnics SELECT DISTINCT 0 AS Tpv, 'Auto' AS Memotecnic, CodiArticle AS AsCodi, "
            sql = sql & "(SELECT TOP 1 Nom From Viatges ORDER BY Defecte DESC) AS Viatge,(SELECT TOP 1 Nom From EquipsDeTreball ORDER BY Defecte DESC) AS Equip, 0 AS atribut "
            sql = sql & "From " & NomTaula & " "
            sql = sql & "WHERE Viatge = 'Auto' AND Equip = 'Auto' And Not CodiArticle In (Select Distinct Codi From Memotecnics)"
            Informa2 BotigaCodiNom(bo) & " -> " & TipComanda & " c"
            ExecutaComandaSql sql
            
            ' Despres els de Memotecnics
            sql = "Update " & NomTaula & " Set  viatge=B.Viatge ,equip =B.Equip "
            sql = sql & "From  " & NomTaula & " As A ,Memotecnics As B "
            sql = sql & "Where A.codiarticle = b.Codi And a.viatge='Auto' and a.equip ='Auto'"
            Informa2 BotigaCodiNom(bo) & " -> " & TipComanda & " d"
            ExecutaComandaSql sql
            
    End Select

End Sub




Function nomTaulaEstadistic(data As Date) As String
   nomTaulaEstadistic = "V_Estadis_" & Format(data, "yyyy-mm")
   If Not ExisteixTaula(nomTaulaEstadistic) Then ExecutaComandaSql "CREATE TABLE [" & nomTaulaEstadistic & "] ([Tipus] [float] NULL ,[Data] [datetime] NULL ,[Dia] [float] NULL ,[Hora] [float] NULL ,[Client] [float] NULL ,[Producte] [float] NULL , [Quantitat] [float] NULL ) ON [PRIMARY]"
   
End Function


Function nomTaulaOracul(data As Date) As String
   
   nomTaulaOracul = "V_Oracul_" & Format(data, "yyyy-mm")
   If Not ExisteixTaula(nomTaulaOracul) Then ExecutaComandaSql "CREATE TABLE [" & nomTaulaOracul & "] ([Tipus] [float] NULL ,[Data] [datetime] NULL ,[Dia] [float] NULL ,[Hora] [float] NULL ,[Client] [float] NULL ,[Producte] [float] NULL , [Previsio] [float] NULL ) ON [PRIMARY]"
   
End Function



Function BotigaCodiNom(Codi)
    Dim rs As rdoResultset
    Dim cCodi
    
    cCodi = Codi
    If InStr(Codi, ",") > 0 Then cCodi = Left(Codi, InStr(Codi, ",") - 1)
    BotigaCodiNom = Codi
    Set rs = Db.OpenResultset("Select Nom From Clients where codi = " & cCodi)
    If Not rs.EOF Then
        If Not IsNull(rs(0)) Then BotigaCodiNom = rs(0)
        rs.Close
    End If
        
End Function


Function ProveedorCodiNom(Codi)
    Dim rs As rdoResultset
    
    ProveedorCodiNom = Codi
    Set rs = Db.OpenResultset("Select Nombre  From ccproveedores where Id = '" & Codi & "'")
    If Not rs.EOF Then If Not IsNull(rs(0)) Then ProveedorCodiNom = rs(0)
    rs.Close
        
End Function



Function DependentaCodiTelefon(Codi)
    Dim rs As rdoResultset

    DependentaCodiTelefon = ""
    Set rs = Db.OpenResultset("select isnull(valor,'') Valor from dependentesextes where nom = 'TLF_MOBIL'  and id = " & Codi)
    If Not rs.EOF Then DependentaCodiTelefon = rs("Valor")
    rs.Close
        
End Function


Function ClientCodiExternCodiIntern(Codi)
    Dim rs As rdoResultset
       
    ClientCodiExternCodiIntern = 0
    Set rs = Db.OpenResultset("select codi from constantsclient  where variable = 'CodiContable' and valor = " & Codi)
    If Not rs.EOF Then If Not IsNull(rs(0)) Then ClientCodiExternCodiIntern = rs(0)
    rs.Close
        
End Function



Function ArticleCodiNom(Codi)
    Dim rs As rdoResultset
       
    ArticleCodiNom = Codi
    Set rs = Db.OpenResultset("Select Nom From Articles where codi = " & Codi)
    If Not rs.EOF Then If Not IsNull(rs(0)) Then ArticleCodiNom = rs(0)
    rs.Close
        
End Function

Sub CreaIndexosPerPrevisions(D As Date)
    Dim Nontaula As String
    
    Nontaula = NomTaulaVentas(D)
    ExecutaComandaSql "CREATE NONCLUSTERED INDEX [" & Nontaula & "_Prev]  ON [" & Nontaula & "] ([Plu] ASC, [Botiga] ASC, [Data] ASC, [Quantitat] ASC )"
    ExecutaComandaSql "CREATE NONCLUSTERED INDEX [" & Nontaula & "_Prev2] ON [" & Nontaula & "] ([Plu] ASC )"

End Sub


Sub CalculaDesdeHasta(st, Pi, Pf)
   Dim P As Integer
   
   P = InStr(st, "..")
   If P > 0 Then
      Pi = Left(st, P - 1)
      Pf = Right(st, Len(st) - P - 1)
      Exit Sub
   End If
   
   P = InStr(st, "Al")
   If P > 0 Then
      Pi = Left(st, P - 1)
      Pf = Right(st, Len(st) - P - 1)
      Exit Sub
   End If
   
   P = InStr(st, " a ")
   If P > 0 Then
      Pi = Left(st, P - 1)
      Pf = Right(st, Len(st) - P - 1)
      Exit Sub
   End If
   
   If st = "0" Or st = "00" Or st = "000" Or st = "0000" Then
      Pi = 1
      Pf = 31
      Exit Sub
   End If
      
   Pi = st
   Pf = st
      
End Sub


Sub CarregaLlistaBotiguesComandes(Botigues As String, Boti() As Double, Tipus() As String)
    Dim L As String, P As Integer, p1 As Integer, P2 As Integer, i, K, rs As rdoResultset, dia As Date, Trobat As Boolean, sql As String
   
    If Not ExisteixTaula("ComandesParams") Then
      sql = "CREATE TABLE [ComandesParams] ("
      sql = sql & "[Tipus] [numeric](18, 0) NULL ,"
      sql = sql & "[Camp] [numeric](18, 0) NULL ,"
      sql = sql & "[Valor] [numeric](18, 0) NULL ,"
      sql = sql & "[Descripcio] [nvarchar] (255) NULL "
      sql = sql & ") ON [PRIMARY]"
      
      ExecutaComandaSql sql
'      ExecutaComandaSql "INSERT INTO ComandesParams Select Codi As Client,'Previsio' As Tipus From Clients "
    End If
    
    ReDim Tipus(0)
    ReDim Boti(0)
    
    L = Trim(Car(Botigues))
    While Len(L) > 0
        If Not (L = "" Or L = "0" Or L = "00") Then
            ReDim Preserve Boti(UBound(Boti) + 1)
            ReDim Preserve Tipus(UBound(Tipus) + 1)
        
            Boti(UBound(Boti)) = L
            Tipus(UBound(Tipus)) = "1"
            Set rs = Db.OpenResultset("Select Valor From ComandesParams Where Tipus = 1 And Camp = " & Boti(UBound(Boti)))
            If Not rs.EOF Then If Not IsNull(rs("Valor")) Then Tipus(UBound(Tipus)) = rs("Valor")
            rs.Close
        End If
        L = Trim(Car(Botigues))
    Wend
    
    If UBound(Boti) > 0 Then Exit Sub

    Set rs = Db.OpenResultset("Select Camp,Valor From ComandesParams Where Tipus = 1 ")
    While Not rs.EOF
        ReDim Preserve Boti(UBound(Boti) + 1)
        Boti(UBound(Boti)) = rs("Camp")
        
        ReDim Preserve Tipus(UBound(Tipus) + 1)
        Tipus(UBound(Tipus)) = rs("Valor")
        
        rs.MoveNext
    Wend
    rs.Close


End Sub




Sub RepassaDadesDelMes(diainicio As Date)
'    Dim Sql As String, Rs As rdoResultset
'
'    Sql = "select a.di di,a.botiga botiga from ( "
'    Sql = Sql & "select q.di di,q.df df,q.botiga botiga ,q.z z ,NumCaixes,sum(m.import) V from ( "
'    Sql = Sql & "select b Botiga,max(d1) Di,min(d2) Df,sum(z) z ,Sum(NumCaixes) NumCaixes from ( "
'    Sql = Sql & "select day(data) d,Botiga b,data D1,null D2,import Z ,1 NumCaixes from [" & NomTaulaMovi(diainicio) & "] where tipus_moviment = 'Z'  union "
'    Sql = Sql & "select day(data) d,Botiga b,null D1,data D2,0 Z,0 NumCaixes  from [" & NomTaulaMovi(diainicio) & "] where (tipus_moviment = 'Wi' and motiu = 'En : 1'))kk   group by b,d ) "
'    Sql = Sql & "q left join [" & NomTaulaVentas(diainicio) & "] m on q.botiga = m.botiga  and m.data <= q.di  and m.data >= q.df "
'    Sql = Sql & "group by q.di,q.df,q.botiga,q.z,NumCaixes "
'    Sql = Sql & ")a left join [" & NomTaulaHoraris(diainicio) & "] h on a.botiga = h.botiga  and day(h.data) = day(a.di) "
'    Sql = Sql & " where abs(z-v) > 0.01 and z>v group by a.di,a.botiga "
'
'    Set Rs = Db.OpenResultset(Sql)
'    While Not Rs.EOF
'        ExecutaComandaSql "Insert Into MissatgesAEnviar (Tipus,Param) Values ('reenviadia','" & Rs("botiga") & ":" & Day(Rs("di")) & "-" & Month(Rs("di")) & "-" & Year(Rs("di")) & "') "
'        Rs.MoveNext
'    Wend
'    Rs.Close
    
End Sub

Function StData(s As String) As Date
  Dim p1 As Integer, P2 As Integer, P3 As Integer
  
  p1 = InStr(s, "-")
  If p1 > 0 Then
     P2 = InStr(p1 + 1, s, "-")
     If P2 > 0 Then
        P3 = Len(s)
        If P3 > P2 Then
           StData = DateSerial(Mid(s, P2 + 1, P3 - P2), Mid(s, p1 + 1, P2 - p1 - 1), Mid(s, 1, p1 - 1))
        End If
     End If
  End If
  
End Function

Function tablaConstantsClient()
    tablaConstantsClient = "ConstantsClient"
End Function

Function TaulaStockSortides() As String
    Dim Str As String, strSQL As String
    
    Str = "ccStockSortides"

    If Not ExisteixTaula(Str) Then
    
        strSQL = "CREATE TABLE [" & Str & "] ( "
        strSQL = strSQL & "[Data] [datetime] NULL DEFAULT (getdate()), "
        strSQL = strSQL & "[IdStock] [nvarchar](255) NOT NULL, "
        strSQL = strSQL & "[IdServit] [nvarchar](255) NOT NULL, "
        strSQL = strSQL & "[TaulaServit] [nvarchar](20) NOT NULL, "
        strSQL = strSQL & "[Quantitat] [numeric] (18, 2) NULL, "
        strSQL = strSQL & "[Queden] [numeric] (18, 2) NULL "
        strSQL = strSQL & ") ON [PRIMARY]"
        ExecutaComandaSql strSQL

    End If
    
    TaulaStockSortides = Str
End Function

Function TaulaHistoricoMURANO(data As Date) As String
    Dim strSQL As String
    
    TaulaHistoricoMURANO = "HistoricoExportacionMURANO_" & Format(data, "yyyy")

    If Not ExisteixTaula(TaulaHistoricoMURANO) Then
        strSQL = "CREATE TABLE [" & TaulaHistoricoMURANO & "] ( "
        strSQL = strSQL & "[FechaGrabacion] [datetime] NULL, "
        strSQL = strSQL & "[CodigoEmpresa] [int] NULL, "
        strSQL = strSQL & "[FechaAsiento] [datetime] NULL, "
        strSQL = strSQL & "[Asiento] [int] NULL, "
        strSQL = strSQL & "[TipoExportacion] [nvarchar] (255) NULL, "
        strSQL = strSQL & "[Param1] [nvarchar] (255) NULL, "
        strSQL = strSQL & "[Param2] [nvarchar] (255) NULL, "
        strSQL = strSQL & "[Param3] [nvarchar] (255) NULL "
        strSQL = strSQL & ") ON [PRIMARY]"
        ExecutaComandaSql strSQL
    End If
End Function
Function TeAlbaransDeBotiga(client, Di, Df) As Boolean
    Dim D As Date, dd As Date, rs As rdoResultset
    
    TeAlbaransDeBotiga = False
    D = DateSerial(Year(Di), Month(Di), 1)
    dd = DateSerial(Year(Df), Month(Df), 1)
    
    While D <= dd And Not TeAlbaransDeBotiga
        CreaTaulesDadesTpv D
        Set rs = Db.OpenResultset("Select Count(*)  From [" & NomTaulaAlbarans(D) & "] where otros = " & client)
        If Not rs.EOF Then If Not IsNull(rs(0)) Then If rs(0) > 0 Then TeAlbaransDeBotiga = True
        D = DateAdd("m", 1, D)
    Wend
    
End Function

Function TriaColor(n) As String
   
   TriaColor = "Green"
   If n < 0 Then TriaColor = "Red"
    

End Function

Sub VigilarAlertes(Tipus As String, Dates As String, Botigues As String)
   Dim Di As Integer, Df As Integer, Mi As Integer, Mf As Integer, Ai As Integer, Af As Integer, D()   As String, m()  As String, a()  As String, Hi() As String, Hf() As String, P As Double, botiga() As String, L As String, i As Integer, k1 As Integer, k2 As Integer, k3 As Integer, dia As Date, K As Integer, Boti() As Double, ki
   
   ReDim D(0):   ReDim m(0):   ReDim a(0):   ReDim botiga(0): ReDim Hi(0): ReDim Hf(0)
   Informa "Alertes : " & Tipus
   
   L = Car(Dates)
   While Len(L) > 0
      ReDim Preserve Hi(UBound(Hi) + 1)
      ReDim Preserve Hf(UBound(Hf) + 1)
      ReDim Preserve D(UBound(D) + 1)
      ReDim Preserve m(UBound(m) + 1)
      ReDim Preserve a(UBound(a) + 1)
      P = InStr(L, "-")
      D(UBound(D)) = "": a(UBound(a)) = "": m(UBound(m)) = ""
      If P > 0 Then
         D(UBound(D)) = Left(L, P - 1)
         L = Right(L, Len(L) - P)
         P = InStr(L, "-")
         If P > 0 Then
            m(UBound(m)) = Left(L, P - 1)
            L = Right(L, Len(L) - P)
            P = InStr(L, " de ")
            If P > 0 Then
               a(UBound(a)) = Left(L, P - 1)
               L = Right(L, Len(L) - P - 3)
               P = InStr(L, " a ")
               If P > 0 Then
                  Hi(UBound(Hi)) = Left(L, P - 1)
                  Hf(UBound(Hf)) = Right(L, Len(L) - P - 2)
               End If
            Else
               a(UBound(a)) = L
               Hi(UBound(Hi)) = ""
               Hf(UBound(Hf)) = ""
            End If
         End If
      End If
      L = Car(Dates)
   Wend
   
   L = Car(Botigues)
   While Len(L) > 0
      ReDim Preserve botiga(UBound(botiga) + 1)
      botiga(UBound(botiga)) = L
      L = Car(Botigues)
   Wend

   For i = 1 To UBound(a)
      CalculaDesdeHasta D(i), Di, Df
      CalculaDesdeHasta m(i), Mi, Mf
      CalculaDesdeHasta a(i), Ai, Af
      For k1 = Ai To Af
         For k2 = Mi To Mf
            dia = DateSerial(k1, k2, Di)
            If Day(dia) = Di And Month(dia) = k2 And Year(dia) = k1 Then
               For K = 1 To UBound(botiga)
                  CarregaLlistaBotigues botiga(K), Boti, Ai, Mi, Di, Df
                  For ki = 1 To UBound(Boti)
                      CalculaIncidencies Tipus, Ai, Mi, Di, Df, Hi(i), Hf(i), Boti(ki)
                  Next
               Next
            End If
         Next
      Next
   Next
   
End Sub


Sub ActualitzaFacturat(StClients As String, StDates As String)
   Dim Di As Date, Df As Date, Mi As Integer, Mf As Integer, Ai As Integer, Af As Integer, D()   As String, m()  As String, a()  As String, Hi() As String, Hf() As String, P As Double, botiga() As String, L As String, i As Integer, k1 As Integer, k2 As Integer, k3 As Integer, dia As Date, K As Integer, Boti() As Double, ki

   ReDim D(0):   ReDim m(0):   ReDim a(0):   ReDim botiga(0): ReDim Hi(0): ReDim Hf(0)
   Informa "Repas De Facturat : "
   
   CarregaLlistaClients "0", Boti
'   L = Car(Dates)
'   CalculaDesdeHasta L, Di, Df
   'CalculaDesdeHasta M(i), Mi, Mf
   'CalculaDesdeHasta a(i), Ai, Af
On Error GoTo 0
    Di = DateSerial(2006, 1, 1)
    Df = DateSerial(2006, 4, 31)
    While Di <= Df
       Informa "Repas De Facturat : " & " " & Di
        For ki = 1 To UBound(Boti)
            ActualitzaFacturatClient Boti(ki), Di
        Next
        Di = DateAdd("d", 1, Di)
    Wend
   
End Sub



Sub ExportaHoresVell(Tipus As String, Dates As String, Botigues As String)
   Dim Di As Integer, Df As Integer, Mi As Integer, Mf As Integer, Ai As Integer, Af As Integer, D()   As String, m()  As String, a()  As String, Hi() As Date, Hf() As Date, P As Double, botiga() As String, L As String, i As Integer, k1 As Integer, k2 As Integer, k3 As Integer, dia As Date, K As Integer, Boti() As Double, ki, rs As rdoResultset
   Dim Cfg_Serv As String, Cfg_Db As String, Cfg_User As String, Cfg_Pswwd As String, Cfg_Emp As String, db3 As New rdoConnection, QIns As rdoQuery, Qdel As rdoQuery
   
   ReDim D(0):   ReDim m(0):   ReDim a(0):   ReDim botiga(0): ReDim Hi(0): ReDim Hf(0)
   Informa "Exportar Hores : " & Tipus
   Cfg_Serv = ""
   Cfg_Db = ""
   Cfg_User = ""
   Cfg_Pswwd = ""
   Cfg_Emp = ""
   Set rs = Db.OpenResultset("Select * from [" & DonamNomTaulaExportacio() & "] Where Tipus ='ExportarHoresDependentes'")
   If Not rs.EOF Then
      If Not IsNull(rs("Param1")) Then Cfg_Serv = rs("Param1")
      If Not IsNull(rs("Param2")) Then Cfg_Db = rs("Param2")
      If Not IsNull(rs("Param3")) Then Cfg_Emp = rs("Param3")
      If Not IsNull(rs("Param4")) Then Cfg_User = rs("Param4")
      If Not IsNull(rs("Param5")) Then Cfg_Pswwd = rs("Param5")
   End If
   rs.Close
   
   If Cfg_Emp = "" Or Cfg_Serv = "" Or Cfg_Db = "" Or Cfg_User = "" Or Cfg_Pswwd = "" Then Exit Sub
   db3.Connect = "WSID=ExportantHores_" & GetNomMaquina() & "_" & App.Title & ";UID=" & Cfg_User & ";PWD=" & Cfg_Pswwd & ";Database=" & Cfg_Db & ";Server=" & Cfg_Serv & ";Driver={SQL Server};DSN='';"
On Error GoTo norR
   db3.EstablishConnection rdDriverNoPrompt
   Set QIns = db3.CreateQuery("", "Insert Into [Emp_" & Cfg_Emp & "_Importat] (Botiga,Dependenta,Hora,Accio,Botiganom,DependentaNom) Values (?,?,?,?,?,?)")
   Set Qdel = db3.CreateQuery("", "Delete [Emp_" & Cfg_Emp & "_Importat] Where Botiga = ? And Dependenta = ? And Hora = ? And Accio = ?")
   

   'Emp_Daunis_Dades_Fichador
   
   L = Car(Dates)
   While Len(L) > 0
      ReDim Preserve Hi(UBound(Hi) + 1)
      ReDim Preserve Hf(UBound(Hf) + 1)
      ReDim Preserve D(UBound(D) + 1)
      ReDim Preserve m(UBound(m) + 1)
      ReDim Preserve a(UBound(a) + 1)
      P = InStr(L, "-")
      D(UBound(D)) = "": a(UBound(a)) = "": m(UBound(m)) = ""
      If P > 0 Then
         D(UBound(D)) = Left(L, P - 1)
         L = Right(L, Len(L) - P)
         P = InStr(L, "-")
         If P > 0 Then
            m(UBound(m)) = Left(L, P - 1)
            L = Right(L, Len(L) - P)
            P = InStr(L, " de ")
            If P > 0 Then
               a(UBound(a)) = Left(L, P - 1)
               L = Right(L, Len(L) - P - 3)
               P = InStr(L, " a ")
               If P > 0 Then
                  Hi(UBound(Hi)) = Left(L, P - 1)
                  Hf(UBound(Hf)) = Right(L, Len(L) - P - 2)
               End If
            Else
               a(UBound(a)) = L
               Hi(UBound(Hi)) = ""
               Hf(UBound(Hf)) = ""
            End If
         End If
      End If
      L = Car(Dates)
   Wend
   
   L = Car(Botigues)
   While Len(L) > 0
      ReDim Preserve botiga(UBound(botiga) + 1)
      botiga(UBound(botiga)) = L
      L = Car(Botigues)
   Wend

   For i = 1 To UBound(a)
      CalculaDesdeHasta D(i), Di, Df
      CalculaDesdeHasta m(i), Mi, Mf
      CalculaDesdeHasta a(i), Ai, Af
      For k1 = Ai To Af
         For k2 = Mi To Mf
            dia = DateSerial(k1, k2, Di)
            If Day(dia) = Di And Month(dia) = k2 And Year(dia) = k1 Then
               For K = 1 To UBound(botiga)
                  For ki = 1 To UBound(botiga)
                   ExportaHoresBotiga QIns, Qdel, CVDate(dia & " " & Hi(i)), CVDate(dia & " " & Hf(i)), botiga(ki)
                  Next
               Next
            End If
         Next
      Next
   Next
norR:
   
End Sub




Sub ExportaHores(Tipus As String, Dates As String, Botigues As String)
   Dim Di As Integer, Df As Integer, Mi As Integer, Mf As Integer, Ai As Integer, Af As Integer, D()   As String, m()  As String, a()  As String, Hi() As Date, Hf() As Date, P As Double, botiga() As Double, L As String, i As Integer, k1 As Integer, k2 As Integer, k3 As Integer, dia As Date, K As Integer, Boti() As Double, ki, rs As rdoResultset
   Dim Cfg_Serv As String, Cfg_Db As String, Cfg_User As String, Cfg_Pswwd As String, Cfg_Emp As String, db3 As New rdoConnection, QIns As rdoQuery, Qdel As rdoQuery
   
   ReDim D(0):   ReDim m(0):   ReDim a(0):   ReDim botiga(0): ReDim Hi(0): ReDim Hf(0)
   Informa "Exportar Hores : " & Tipus

On Error GoTo norR
   ExecutaComandaSql "CREATE TABLE [dbo].[cdpDadesFichador](    [id] [decimal](18, 0) NULL,    [tmst] [datetime] NULL,    [accio] [decimal](18, 0) NULL,    [usuari] [nvarchar](255) NULL,    [idr] [nvarchar](255) NULL DEFAULT (newid()),    [editor] [nvarchar](255) NULL,    [historial] [nvarchar](255) NULL,    [lloc] [nvarchar](255) NULL,    [comentari] [nvarchar](255) NULL) ON [PRIMARY] "
   ExecutaComandaSql "CREATE INDEX CdpDadesFichadorId  ON CdpDadesFichador ([Idr] ASC)"
   ExecutaComandaSql "CREATE INDEX CdpDadesFichadorUs  ON CdpDadesFichador ([Usuari] ASC)"
   ExecutaComandaSql "CREATE INDEX CdpDadesFichadorTm  ON CdpDadesFichador ([TmSt] ASC)"
   Set QIns = Db.CreateQuery("", "insert into CdpDadesFichador (Id,TmSt,Accio,Usuari,Idr,Lloc,Comentari) values (?,?,?,?,?,?,?)")
   Set Qdel = Db.CreateQuery("", "Delete CdpDadesFichador Where idr = ? ")
   
   L = Car(Dates)
   While Len(L) > 0
      ReDim Preserve Hi(UBound(Hi) + 1)
      ReDim Preserve Hf(UBound(Hf) + 1)
      ReDim Preserve D(UBound(D) + 1)
      ReDim Preserve m(UBound(m) + 1)
      ReDim Preserve a(UBound(a) + 1)
      P = InStr(L, "-")
      D(UBound(D)) = "": a(UBound(a)) = "": m(UBound(m)) = ""
      If P > 0 Then
         D(UBound(D)) = Left(L, P - 1)
         L = Right(L, Len(L) - P)
         P = InStr(L, "-")
         If P > 0 Then
            m(UBound(m)) = Left(L, P - 1)
            L = Right(L, Len(L) - P)
            P = InStr(L, " de ")
            If P > 0 Then
               a(UBound(a)) = Left(L, P - 1)
               L = Right(L, Len(L) - P - 3)
               P = InStr(L, " a ")
               If P > 0 Then
                  Hi(UBound(Hi)) = Left(L, P - 1)
                  Hf(UBound(Hf)) = Right(L, Len(L) - P - 2)
               End If
            Else
               a(UBound(a)) = L
               Hi(UBound(Hi)) = ""
               Hf(UBound(Hf)) = ""
            End If
         End If
      End If
      L = Car(Dates)
   Wend
   
   L = Car(Botigues)
   While Len(L) > 0
      ReDim Preserve botiga(UBound(botiga) + 1)
      botiga(UBound(botiga)) = L
      L = Car(Botigues)
   Wend
   
   
   For i = 1 To UBound(a)
      CalculaDesdeHasta D(i), Di, Df
      CalculaDesdeHasta m(i), Mi, Mf
      CalculaDesdeHasta a(i), Ai, Af
      If Mf > 12 Then Mf = 12
      For k1 = Ai To Af
         For k2 = Mi To Mf
            If UBound(botiga) = 1 And botiga(1) = 0 Then
               CarregaLlistaBotigues "0", botiga, Ai, Mi, Di, Df
            End If
            For k3 = Di To Df
               dia = DateSerial(k1, k2, k3)
               If Day(dia) = k3 And Year(dia) = k1 And Month(dia) = k2 Then
                  Informa "Exportar Hores : " & Tipus & " " & dia
                  For K = 1 To UBound(botiga)
                      ExportaHoresBotiga QIns, Qdel, CVDate(dia & " " & Hi(i)), CVDate(dia & " " & Hf(i)), botiga(K)
                  Next    'botiga
               End If
            Next      'dia
         Next   ' mes
      Next   ' any
   Next
norR:
   
End Sub





Sub ExportaAlbarans(Dates As String, Botigues As String)
   Dim Di As Integer, Df As Integer, Mi As Integer, Mf As Integer, Ai As Integer, Af As Integer, D()   As String, m()  As String, a()  As String, Hi() As String, Hf() As String, P As Double, botiga() As String, L As String, i As Integer, k1 As Integer, k2 As Integer, k3 As Integer, dia As Date, K As Integer, Boti() As Double, ki

On Error GoTo norrr
   ReDim D(0):   ReDim m(0):   ReDim a(0):   ReDim botiga(0): ReDim Hi(0): ReDim Hf(0)
   Informa "Albarans : " & Dates
   If Not ExisteixTaula("ComandesModificades") Then ExecutaComandaSql "CREATE TABLE [ComandesModificades] ([Id] [uniqueidentifier] NULL ,[TimeStamp] [datetime] NULL ,  [TaulaOrigen] [nvarchar] (255) NULL ) ON [PRIMARY] "
   
   
   L = Car(Dates)
   While Len(L) > 0
      ReDim Preserve Hi(UBound(Hi) + 1)
      ReDim Preserve Hf(UBound(Hf) + 1)
      ReDim Preserve D(UBound(D) + 1)
      ReDim Preserve m(UBound(m) + 1)
      ReDim Preserve a(UBound(a) + 1)
      P = InStr(L, "-")
      D(UBound(D)) = "": a(UBound(a)) = "": m(UBound(m)) = ""
      If P > 0 Then
         D(UBound(D)) = Left(L, P - 1)
         L = Right(L, Len(L) - P)
         P = InStr(L, "-")
         If P > 0 Then
            m(UBound(m)) = Left(L, P - 1)
            L = Right(L, Len(L) - P)
            P = InStr(L, " de ")
            If P > 0 Then
               a(UBound(a)) = Left(L, P - 1)
               L = Right(L, Len(L) - P - 3)
               P = InStr(L, " a ")
               If P > 0 Then
                  Hi(UBound(Hi)) = Left(L, P - 1)
                  Hf(UBound(Hf)) = Right(L, Len(L) - P - 2)
               End If
            Else
               a(UBound(a)) = L
               Hi(UBound(Hi)) = ""
               Hf(UBound(Hf)) = ""
            End If
         End If
      End If
      L = Car(Dates)
   Wend
   
   L = Car(Botigues)
   While Len(L) > 0
      ReDim Preserve botiga(UBound(botiga) + 1)
      botiga(UBound(botiga)) = L
      L = Car(Botigues)
   Wend

   For i = 1 To UBound(a)
      CalculaDesdeHasta D(i), Di, Df
      CalculaDesdeHasta m(i), Mi, Mf
      CalculaDesdeHasta a(i), Ai, Af
      For k1 = Ai To Af
         For k2 = Mi To Mf
            dia = DateSerial(k1, k2, Di)
            If Day(dia) = Di And Month(dia) = k2 And Year(dia) = k1 Then
               For K = 1 To UBound(botiga)
                  For ki = 1 To UBound(botiga)
                      ImportaAlbarans Ai, Mi, Di, Df, Hi(i), Hf(i), botiga(ki)
                  Next
               Next
            End If
         Next
      Next
   Next
Exit Sub
norrr:
Debug.Print "Err en albarans " & err.Description
Resume Next
End Sub



Sub RepasaCuotasHIT()
    Dim IpFtp As FTP

    If frmSplash.IpConexio Is Nothing Then Set frmSplash.IpConexio = New ConexioIp
    
    Set IpFtp = Nothing
    Set IpFtp = frmSplash.FTP1
   
    'IpFtp.RemotePort = 350
    IpFtp.WinsockLoaded = True
    'IpFtp.RemoteHost = "gdt.hiterp.com"
    'IpFtp.RemoteHost = "sincro.nubehit.com"
    IpFtp.RemoteHost = "hit-ts2.nubehit.com"
    IpFtp.User = "ftphiterp"
    IpFtp.Password = "ElPortillo034545"
    IpFtp.Passive = True
    
    Informa "Intentant Logon."
    If frmSplash.IpConexio.ExecutaAction(2) Then
        frmSplash.IpConexio.DescarregaFilesLLicencies
    End If
End Sub



Sub TractaInventaris(strData As String, StrBotiga As String, Quan As String)
    Dim data As Date, botiga As Double
    
    Informa "Tractant Inventaris : " & strData
    data = CVDate(Car(strData))
    botiga = Car(StrBotiga)
    
    'If Day(data) = Day(Now) And Month(data) = Month(Now) And Year(data) = Year(Now) Then
    '    ModificaComandesSegonsInventarisBotiga botiga, data
    'End If
    
   
End Sub



Sub CalculaIncidenciesAnulats(Da1, Da2, botiga)
   Dim rs As rdoResultset, Q As rdoQuery, NumTick As Double, Plu As Double, Sospitos As Boolean, dia As Date, P As Integer, Qa As rdoQuery, rs2 As rdoResultset, QIns As rdoQuery, Da As Date, SolsUn As Boolean
   
   dia = Da1
   
   Set Qa = Db.CreateQuery("", "SELECT * From [" & NomTaulaAnulats(dia) & "] WHERE Botiga = " & botiga & " And data >= ? And data <= ? ")
   Qa.rdoParameters(0) = Da1
   Qa.rdoParameters(1) = Da2
   Set rs = Qa.OpenResultset
   Set Q = Db.CreateQuery("", "SELECT Count(*) From [" & NomTaulaVentas(dia) & "] WHERE Botiga = " & botiga & " And data >= ? And data <= ? And (Plu = ? Or Quantitat = ?) ")
   
   Set QIns = Db.CreateQuery("", "Delete [" & NomTaulaAlertes(dia) & "] Where Data >= ? And Data <= ? And Param1 = ? And Param4 = 1 ")
   QIns.rdoParameters(0) = Da1
   QIns.rdoParameters(1) = Da2
   QIns.rdoParameters(2) = botiga
   QIns.Execute
   
   Set QIns = Db.CreateQuery("", "Insert Into [" & NomTaulaAlertes(dia) & "] (Data,Texte,Revisada,Param1,Param2,Param3,Param4) Values (?,?,?,?,?,?,?) ")
      
   Sospitos = True
   SolsUn = True
   NumTick = -1
   While Not rs.EOF
      If Not rs("Num_Tick") = NumTick Then
         If Not NumTick = -1 And Sospitos Then
            QIns.rdoParameters(0) = Da
            QIns.rdoParameters(1) = "Ticket Anulat Sospitos "
            If SolsUn Then QIns.rdoParameters(1) = "Ticket Anulat Poc Sospitos "
            QIns.rdoParameters(2) = 0
            QIns.rdoParameters(3) = botiga
            QIns.rdoParameters(4) = NumTick
            QIns.rdoParameters(5) = ""
            QIns.rdoParameters(6) = 1
            QIns.Execute
         End If
         NumTick = rs("Num_Tick")
         Da = rs("Data")
         Sospitos = True
         SolsUn = True
      End If
      
      If Sospitos Then
        Q.rdoParameters(0) = DateAdd("n", -5, rs("Data"))
        Q.rdoParameters(1) = DateAdd("n", 5, rs("Data"))
        Q.rdoParameters(2) = rs("Plu")
        Q.rdoParameters(3) = rs("Quantitat")
        If Q.rdoParameters(3) <> 1 Then SolsUn = False Else Q.rdoParameters(3) = 0
        Set rs2 = Q.OpenResultset
        If Not rs2.EOF Then If Not IsNull(rs2(0)) Then If rs2(0) > 0 Then Sospitos = False
        rs2.Close
      End If
      
      rs.MoveNext
      My_DoEvents
   Wend
   rs.Close
   
End Sub



Sub CalculaIncidenciesDescuadres(dia As Date, DiaFi As Date, botiga)
   Dim clients As Double, descuadre As Double, Caixa As Double, W As Double, Wi As Double, rs As rdoResultset, Q As rdoQuery, o As Double, a As Double, Motiu As Boolean, QIns As rdoQuery, Qa As rdoQuery, QInsDelete As rdoQuery, texte As String, dependenta As Double, Hora As Date, Txt, Movil, ImportDescuadre, K
   
   Set QIns = Db.CreateQuery("", "Insert Into [" & NomTaulaAlertes(dia) & "] (Data,Texte,Revisada,Param1,Param2,Param3,Param4) Values (?,?,?,?,?,?,?) ")
   QIns.rdoParameters(0) = dia
   QIns.rdoParameters(1) = "Explicacio Descuadre"
   QIns.rdoParameters(2) = 0
   QIns.rdoParameters(3) = botiga
   
   Set QInsDelete = Db.CreateQuery("", "Delete [" & NomTaulaAlertes(dia) & "] where Data = ? And Texte = ? And Revisada = ? And Param1 = ? And Param2 = ? And Param3 = ? And Param4 = ? ")
   QInsDelete.rdoParameters(0) = dia
   QInsDelete.rdoParameters(1) = "Explicacio Descuadre"
   QInsDelete.rdoParameters(2) = 0
   QInsDelete.rdoParameters(3) = botiga
   
   Set Qa = Db.CreateQuery("", "SELECT * From [" & NomTaulaMovi(dia) & "] WHERE Botiga = " & botiga & " And data > ? And data <= ? ")
   Qa.rdoParameters(0) = dia
   Qa.rdoParameters(1) = DateAdd("n", 1, DiaFi)
   Set rs = Qa.OpenResultset
   While Not rs.EOF
      If rs("Tipus_Moviment") = "G" Then clients = rs("Import")
      If rs("Tipus_Moviment") = "J" Then descuadre = rs("Import")
      If rs("Tipus_Moviment") = "Z" Then Caixa = rs("Import")
      If rs("Tipus_Moviment") = "Z" Then Hora = rs("data")
      If rs("Tipus_Moviment") = "G" Then dependenta = rs("Dependenta")
      rs.MoveNext
   Wend
   rs.Close
   
   If Abs(descuadre) > 3 Then
      Set rs = Qa.OpenResultset
      W = 0: Wi = 0: o = 0: a = 0: Motiu = False
      While Not rs.EOF
         If rs("Tipus_Moviment") = "W" Then W = W + rs("Import")
         If rs("Tipus_Moviment") = "Wi" Then Wi = Wi + rs("Import")
         If rs("Tipus_Moviment") = "O" Then o = o + rs("Import")
         If rs("Tipus_Moviment") = "A" Then a = a + rs("Import")
         rs.MoveNext
      Wend
      rs.Close
      
      If Caixa = 0 Then ' No s'ha venut res
         Motiu = True
         texte = "No S'ha venut res de " & Hour(dia) & ":" & Format(Minute(dia), "00") & " a " & Hour(DiaFi) & ":" & Format(Minute(DiaFi), "00")
         
         QInsDelete.rdoParameters(4) = texte
         QInsDelete.rdoParameters(5) = ""
         QInsDelete.rdoParameters(6) = 0
         QInsDelete.Execute
         
         QIns.rdoParameters(4) = texte
         QIns.rdoParameters(5) = ""
         QIns.rdoParameters(6) = 0
         QIns.Execute
      End If
      
      If descuadre > 0 And o = 0 And Caixa > 6 Then ' No s'ha fet la sortida
         Motiu = True
         texte = "No S'ha fet cap sortida de diners (Entrega) "
         
         QInsDelete.rdoParameters(4) = texte
         QInsDelete.rdoParameters(5) = ""
         QInsDelete.rdoParameters(6) = 0
         QInsDelete.Execute
         
         QIns.rdoParameters(4) = texte
         QIns.rdoParameters(5) = ""
         QIns.rdoParameters(6) = 0
         QIns.Execute
      End If
      
      If descuadre < 0 And a > 0 And (Abs(descuadre) - Abs(a)) < Abs(descuadre / 3) Then  ' S'han Ficat diners que realment no han entrat
         Motiu = True
         texte = "S'ha fet una entrada de diners sospitosa de  " & a & " Euros "
         
         QInsDelete.rdoParameters(4) = texte
         QInsDelete.rdoParameters(5) = ""
         QInsDelete.rdoParameters(6) = 0
         QInsDelete.Execute
         
         QIns.rdoParameters(4) = texte
         QIns.rdoParameters(5) = ""
         QIns.rdoParameters(6) = 0
         QIns.Execute
      End If
      
      If descuadre > 0 And Wi = 0 And W > 0 Then  ' Falta el canvi inicial
         Motiu = True
         texte = "No S'ha indicat el canvi inicial "
         QInsDelete.rdoParameters(4) = texte
         QInsDelete.rdoParameters(5) = ""
         QInsDelete.rdoParameters(6) = 0
         QInsDelete.Execute
         QIns.rdoParameters(4) = texte
         QIns.rdoParameters(5) = ""
         QIns.rdoParameters(6) = 0
         QIns.Execute
      End If
      
      If descuadre < 0 And W = 0 And Wi > 0 Then  ' Falta el canvi final
         Motiu = True
         texte = "No S'ha indicat el canvi final al plegar "
         
         QInsDelete.rdoParameters(4) = texte
         QInsDelete.rdoParameters(5) = ""
         QInsDelete.rdoParameters(6) = 0
         QInsDelete.Execute
         QIns.rdoParameters(4) = texte
         QIns.rdoParameters(5) = ""
         QIns.rdoParameters(6) = 0
         QIns.Execute
      End If
      
      If Not Motiu Then
         If descuadre > 0 Then ' Sobra
         
         Else                  ' Falta
         
         End If
      End If
   End If
   
   K = 0
   While AvisSms(Movil, ImportDescuadre, K)
        If Len(Movil) > 0 And Abs(descuadre) >= ImportDescuadre And UCase(EmpresaActual) = UCase("Enrich") And Day(Hora) = Day(Now) And Month(Hora) = Month(Now) And Year(Hora) = Year(Now) Then
            Txt = ""
            Txt = Txt & "Caixa " & BotigaCodiNom(botiga) & " " '& Chr(10) & Chr(13)
            Txt = Txt & " X : " & Format(Caixa, "0.00") & " " '& Chr(10) & Chr(13)
            Txt = Txt & " Err: " & Format(descuadre, "0.00") & " " '& Chr(10) & Chr(13)
            Txt = Txt & " Cli: " & clients & " " '& Chr(10) & Chr(13)
            Txt = Txt & " H.f: " & Format(DiaFi, "hh:nn") & " " '& Chr(10) & Chr(13)
            Txt = Txt & " H.i: " & Format(dia, "hh:nn") & " " '& Chr(10) & Chr(13)
            Txt = Txt & " Enc: " & DependentaCodiNom(dependenta) & " " '& Chr(10) & Chr(13)
            If Not DependentaCodiTelefon(dependenta) = "" Then Txt = Txt & " Tel : " & DependentaCodiTelefon(dependenta) & " " '& Chr(10) & Chr(13)
            EnviaSms Movil, Txt
        End If
       K = K + 1
   Wend
   
End Sub




Sub CalculaIncidenciesVentesNoTancades(D As Date, botiga)
   Dim DiaInici As Date, DiaFi As Date, DiaK As Date, rs As rdoResultset, Q As rdoQuery, QIns As rdoQuery, i As Integer
   Dim QInsDelete As rdoQuery
   Dim texte As String
   
On Error GoTo nor
   DiaInici = D
   DiaFi = D
   DiaK = DiaFi
   For i = 1 To 2
      CreaTaulesDadesTpv DiaK
      Set Q = Db.CreateQuery("", "Select Top 1 Tipus_Moviment,Data From [" & NomTaulaMovi(DiaK) & "] Where Data < ? And Botiga = " & botiga & " And Tipus_Moviment = 'W' Order By Data Desc ")
      Q.rdoParameters(0) = DiaInici
      Set rs = Q.OpenResultset
      If Not rs.EOF Then
         DiaFi = rs("Data")
         DiaK = DiaFi
         While DiaK <= DiaInici
            Set Q = Db.CreateQuery("", "SELECT Sum(Import),Max(data),Min(data) From [" & NomTaulaVentas(DiaK) & "] WHERE Botiga = " & botiga & " And data >= ? And data <= ?  ")
            Q.rdoParameters(0) = DiaFi
            Q.rdoParameters(1) = DiaInici
            Set rs = Q.OpenResultset
            If Not rs.EOF Then
               If Not IsNull(rs(0)) Then
                  If Not rs(0) = 0 Then
                     Set QIns = Db.CreateQuery("", "Insert Into [" & NomTaulaAlertes(DiaInici) & "] (Data,Texte,Revisada,Param1,Param2,Param3,Param4) Values (?,?,?,?,?,?,?) ")
                     Set QInsDelete = Db.CreateQuery("", "Delete [" & NomTaulaAlertes(DiaInici) & "] where Data = ? And Texte  = ? And Param1  = ? And Param2  = ? And Param3  = ? And Param4  = ? ")
                  
                     texte = "S'han venut " & Format(rs(0), "#########0.00") & " Euros Fora de tancament El dia  " & Format(DiaK, "dd-mm-yyyy") & " De " & Format(rs(1), "hh:mm:ss") & " Al " & Format(rs(2), "hh:mm:ss")
                     QInsDelete.rdoParameters(0) = DiaInici
                     QInsDelete.rdoParameters(1) = "Ventes No Tancades"
                     QInsDelete.rdoParameters(2) = botiga
                     QInsDelete.rdoParameters(3) = rs(0)
                     QInsDelete.rdoParameters(4) = texte
                     QInsDelete.rdoParameters(5) = 1
                     QInsDelete.Execute
                  
                     QIns.rdoParameters(0) = DiaInici
                     QIns.rdoParameters(1) = "Ventes No Tancades"
                     QIns.rdoParameters(2) = 0
                     QIns.rdoParameters(3) = botiga
                     QIns.rdoParameters(4) = rs(0)
                     QIns.rdoParameters(5) = texte
                     QIns.rdoParameters(6) = 1
                     QIns.Execute
                  End If
               End If
            End If
            rs.Close
            DiaK = DateAdd("d", 1, DiaK)
         Wend
         Exit For
      Else
         rs.Close
      End If
      DiaK = DateAdd("m", -1, DiaK)
   Next
nor:

End Sub




Function NomTaulaAlertes(data As Date) As String

   NomTaulaAlertes = "V_Alertes_" & Format(data, "yyyy-mm")
   
End Function

Sub AseguraExisteixTaulaAlertes(D As Date)
   
   If Not ExisteixTaula(NomTaulaAlertes(D)) Then
       ExecutaComandaSql "CREATE TABLE [" & NomTaulaAlertes(D) & "] (Id [uniqueidentifier] Default (NEWID()), Data [datetime] NULL , Texte  [nvarchar] (255) NULL, Revisada  [int] Default (0), Param1 [nvarchar] (255) NULL, Param2 [nvarchar] (255) NULL, Param3 [nvarchar] (255) NULL, Param4 [nvarchar] (255) NULL)"
   End If
   

End Sub

Function TaulaProductesPromocionats() As String
    Dim sql As String
   
    TaulaProductesPromocionats = "ProductesPromocionats"
   
   If Not ExisteixTaula(TaulaProductesPromocionats) Then
        sql = "CREATE TABLE [dbo].[" & TaulaProductesPromocionats & "] ("
        sql = sql & "[Id] [nvarchar](50) NULL,"
        sql = sql & "[Di] [datetime] NULL,"
        sql = sql & "[Df] [datetime] NULL,"
        sql = sql & "[D_Producte] [nvarchar](250) NULL,"
        sql = sql & "[D_Quantitat] [float] NULL,"
        sql = sql & "[S_Producte] [nvarchar](250) NULL,"
        sql = sql & "[S_Quantitat] [float] NULL,"
        sql = sql & "[S_Preu] [float] NULL,"
        sql = sql & "[Client] [nvarchar](50) NULL"
        sql = sql & ") ON [PRIMARY]"
   
       ExecutaComandaSql sql
   End If

End Function


Sub AseguraExisteixTaulaPrevisions(D As Date)

   If Not ExisteixTaula(NomTaulaVentasPrevistes(D)) Then
      ExecutaComandaSql "Create Table [" & NomTaulaVentasPrevistes(D) & "] (Botiga float,Data datetime,Dependenta float,Num_tick float,Estat [nvarchar] (25), Plu float, Quantitat float, Import float,Tipus_venta [nvarchar] (25),FormaMarcar [nvarchar] (255) Default (''),Otros [nvarchar] (255) Default ('')) "
   End If

End Sub




Sub CarregaLlistaBotigues(st As String, Boti() As Double, a, m, D1, D2)
   Dim P As Integer, p1 As Integer, P2 As Integer, i, K, rs As rdoResultset, dia As Date, Trobat As Boolean
   
   ReDim Boti(0)
   P = InStr(st, "..")
   If P > 0 Then
      p1 = Left(st, P - 1)
      P2 = Right(st, Len(st) - P - 1)
      ReDim Boti(P2 - p1)
      K = 1
      For i = p1 To P2
         Boti(K) = i
         K = K + 1
      Next
      Exit Sub
   End If
   
   
   P = InStr(st, ",")
   If P > 0 Then
      Dim bo()  As String
      bo = Split(st, ",")
      ReDim Boti(UBound(bo) + 1)
      For i = 0 To UBound(bo)
         Boti(i + 1) = bo(i)
      Next
      Exit Sub
   End If
   
   If st = "0" Or st = "00" Or st = "000" Or st = "0000" Then
      dia = DateSerial(a, m, D1)
      While dia <= DateSerial(a, m, D2)
         CreaTaulesDadesTpv dia
         Set rs = Db.OpenResultset("Select Distinct Botiga From [" & NomTaulaVentas(dia) & "] Where Day(data) >= " & D1 & " And Day(data) <= " & D2 & " ")
         While Not rs.EOF
            Trobat = False
            For i = 1 To UBound(Boti)
               If Boti(i) = rs(0) Then Trobat = True
            Next
            If Not Trobat Then
               ReDim Preserve Boti(UBound(Boti) + 1)
               Boti(UBound(Boti)) = rs(0)
            End If
            rs.MoveNext
         Wend
         rs.Close
         dia = DateAdd("m", 1, dia)
      Wend
      Exit Sub
   End If
   
   ReDim Boti(1)
   Boti(1) = st

End Sub


Sub CarregaLlistaClients(st As String, Boti() As Double)
   Dim P As Integer, p1 As Integer, P2 As Integer, i, K, rs As rdoResultset, dia As Date, Trobat As Boolean
   
   ReDim Boti(0)
   P = InStr(st, "..")
   If P > 0 Then
      p1 = Left(st, P - 1)
      P2 = Right(st, Len(st) - P - 1)
      ReDim Boti(P2 - p1)
      K = 1
      For i = p1 To P2
         Boti(K) = i
         K = K + 1
      Next
      Exit Sub
   End If
   
   
   P = InStr(st, ",")
   If P > 0 Then
      Dim bo()  As String
      bo = Split(st, ",")
      ReDim Boti(UBound(bo) + 1)
      For i = 0 To UBound(bo)
         Boti(i + 1) = bo(i)
      Next
      Exit Sub
   End If
   
   If st = "0" Or st = "00" Or st = "000" Or st = "0000" Then
      Set rs = Db.OpenResultset("Select Distinct Codi From Clients ")
      While Not rs.EOF
          ReDim Preserve Boti(UBound(Boti) + 1)
          Boti(UBound(Boti)) = rs(0)
          rs.MoveNext
      Wend
      rs.Close
      Exit Sub
   End If
   
   ReDim Boti(1)
   Boti(1) = st

End Sub



Sub CalcularPrevisions(Tipus As String, Dates As String, Botigues As String, ImportsFixes As String, BasesFixes As String)
   Dim Di As Integer, Df As Integer, Mi As Integer, Mf As Integer, Ai As Integer, Af As Integer, D()   As String, m()  As String, a()  As String, Hi() As String, Hf() As String, P As Double, botiga() As String, L As String, i As Integer, k1 As Integer, k2 As Integer, k3 As Integer, dia As Date, K As Integer, Boti() As Double, ki, ImportFixe As Double
   ReDim D(0):   ReDim m(0):   ReDim a(0):   ReDim botiga(0): ReDim Hi(0): ReDim Hf(0)
   Informa "Previsions "
   
   ImportFixe = -1
   ImportsFixes = Car(ImportsFixes)
   If Len(ImportsFixes) > 0 Then ImportFixe = Val(ImportsFixes)
   
   If Tipus = "Comandes" Then
      CalcularComandes
   Else
      Dim Base1 As Double, Base2 As Double, Base3 As Double
      Base1 = Base2 = Base3 = -1
      L = Car(BasesFixes)
      If Len(L) > 0 Then Base1 = L
      L = Car(BasesFixes)
      If Len(L) > 0 Then Base2 = L
      L = Car(BasesFixes)
      If Len(L) > 0 Then Base3 = L
      
      L = Car(Dates)
      While Len(L) > 0
         ReDim Preserve Hi(UBound(Hi) + 1)
         ReDim Preserve Hf(UBound(Hf) + 1)
         ReDim Preserve D(UBound(D) + 1)
         ReDim Preserve m(UBound(m) + 1)
         ReDim Preserve a(UBound(a) + 1)
         P = InStr(L, "-")
         D(UBound(D)) = "": a(UBound(a)) = "": m(UBound(m)) = ""
         If P > 0 Then
            D(UBound(D)) = Left(L, P - 1)
            L = Right(L, Len(L) - P)
            P = InStr(L, "-")
            If P > 0 Then
               m(UBound(m)) = Left(L, P - 1)
               L = Right(L, Len(L) - P)
               P = InStr(L, " de ")
               If P > 0 Then
                  a(UBound(a)) = Left(L, P - 1)
                  L = Right(L, Len(L) - P - 3)
                  P = InStr(L, " a ")
                  If P > 0 Then
                     Hi(UBound(Hi)) = Left(L, P - 1)
                     Hf(UBound(Hf)) = Right(L, Len(L) - P - 2)
                  End If
               Else
                  a(UBound(a)) = L
                  Hi(UBound(Hi)) = ""
                  Hf(UBound(Hf)) = ""
               End If
            End If
         End If
         L = Car(Dates)
      Wend

      L = Car(Botigues)
      While Len(L) > 0
         ReDim Preserve botiga(UBound(botiga) + 1)
         botiga(UBound(botiga)) = L
         L = Car(Botigues)
      Wend

      For i = 1 To UBound(a)
         CalculaDesdeHasta D(i), Di, Df
         CalculaDesdeHasta m(i), Mi, Mf
         CalculaDesdeHasta a(i), Ai, Af
      
         For k1 = Ai To Af
            For k2 = Mi To Mf
               dia = DateSerial(k1, k2, Di)
               If Day(dia) = Di And Month(dia) = k2 And Year(dia) = k1 Then
                  For K = 1 To UBound(botiga)
                     CarregaLlistaBotigues botiga(K), Boti, Ai, Mi, Di, Df
                     For ki = 1 To UBound(Boti)
                        If Tipus = "Ventes" Then
                           If Base1 > 0 Or Base2 > 0 Or Base3 > 0 Then
                              CalcularPrevisioVentes Ai, Mi, Di, Df, Hi(i), Hf(i), Boti(ki), Base1, 1
                              CalcularPrevisioVentes Ai, Mi, Di, Df, Hi(i), Hf(i), Boti(ki), Base2, 2
                              CalcularPrevisioVentes Ai, Mi, Di, Df, Hi(i), Hf(i), Boti(ki), Base3, 3
                           Else
                              CalcularPrevisioVentes Ai, Mi, Di, Df, Hi(i), Hf(i), Boti(ki), ImportFixe
                           End If
                        End If
                        DoEvents
                     Next
                  Next
               End If
            Next
         Next
      Next
   End If
   
End Sub
Sub CalcularObjectius(DateIni As String, DateFin As String, botiga As String)
    Dim IniObj As Date, FinObj As Date
    Dim IniVen As Date, FinVen As Date
    Dim sql As String
    
    'Setmana Objectius a calcular
    IniObj = paramToDate(DateIni)
    FinObj = paramToDate(DateFin)
    
    'Setmana Vendes
    IniVen = DateAdd("d", -7, IniObj)
    FinVen = DateAdd("d", -7, FinObj)
    
    botiga = Right(Left(botiga, Len(botiga) - 1), Len(Left(botiga, Len(botiga) - 1)) - 1)
    
    If Month(IniObj) <> Month(FinObj) Then
        ExecutaComandaSql "delete from [" & NomTaulaObjectius(IniObj) & "] where Botiga=" & botiga & " and (DAY(data)>=" & Day(IniObj) & " and DAY(data)<=" & Day(DateAdd("d", -1, "01/" & Month(FinObj) & "/" & Year(FinObj))) & ")"
        ExecutaComandaSql "delete from [" & NomTaulaObjectius(FinObj) & "] where Botiga=" & botiga & " and (DAY(data)>=" & 1 & " and DAY(data)<=" & Day(FinObj) & ")"
    
       'Mati mes 1
        sql = "insert into [" & NomTaulaObjectius(IniObj) & "] (Botiga, Data, Periode, Objectiu, Tipo) "
        sql = sql & "select botiga, convert(datetime, cast(day(dateadd(d,7,data)) as varchar) + '/' + cast(MONTH(dateadd(d,7,data)) as varchar) + '/' + cast(year(dateadd(d,7,data)) as varchar), 103), '0', SUM(import), 'SINCRO' "
        If Month(IniVen) <> Month(FinVen) Then
            sql = sql & "from (select * from [" & NomTaulaVentas(IniVen) & "] union all select * from  [" & NomTaulaVentas(FinVen) & "] ) v "
        Else
            sql = sql & "from [" & NomTaulaVentas(IniVen) & "] "
        End If
        sql = sql & " where Botiga=" & botiga & " and data between convert(datetime,'" & IniVen & "',103) and convert(datetime,'" & FinVen & "',103) +convert(datetime,'23:59:59',8) "
        sql = sql & " and DATEPART(hh, data)<13 and month(dateadd(d, 7, data)) = " & Month(IniObj)
        sql = sql & " group by BOTIGA, convert(datetime, cast(day(dateadd(d,7,data)) as varchar) + '/' + cast(MONTH(dateadd(d,7,data)) as varchar) + '/' + cast(year(dateadd(d,7,data)) as varchar), 103)"
        ExecutaComandaSql sql
        
        'Mati Mes 2
        sql = "insert into [" & NomTaulaObjectius(FinObj) & "] (Botiga, Data, Periode, Objectiu, Tipo) "
        sql = sql & "select botiga, convert(datetime, cast(day(dateadd(d,7,data)) as varchar) + '/' + cast(MONTH(dateadd(d,7,data)) as varchar) + '/' + cast(year(dateadd(d,7,data)) as varchar), 103), '0', SUM(import), 'SINCRO' "
        If Month(IniVen) <> Month(FinVen) Then
            sql = sql & "from (select * from [" & NomTaulaVentas(IniVen) & "] union all select * from  [" & NomTaulaVentas(FinVen) & "] ) v "
        Else
            sql = sql & "from [" & NomTaulaVentas(IniVen) & "] "
        End If
        sql = sql & " where Botiga=" & botiga & " and data between convert(datetime,'" & IniVen & "',103) and convert(datetime,'" & FinVen & "',103) +convert(datetime,'23:59:59',8) "
        sql = sql & " and DATEPART(hh, data)<13 and month(dateadd(d, 7, data)) = " & Month(FinObj)
        sql = sql & " group by BOTIGA, convert(datetime, cast(day(dateadd(d,7,data)) as varchar) + '/' + cast(MONTH(dateadd(d,7,data)) as varchar) + '/' + cast(year(dateadd(d,7,data)) as varchar), 103)"
        ExecutaComandaSql sql
        
        'Tarda mes 1
        sql = "insert into [" & NomTaulaObjectius(IniObj) & "] (Botiga, Data, Periode, Objectiu, Tipo) "
        sql = sql & "select botiga, convert(datetime, cast(day(dateadd(d,7,data)) as varchar) + '/' + cast(MONTH(dateadd(d,7,data)) as varchar) + '/' + cast(year(dateadd(d,7,data)) as varchar), 103), '1', SUM(import), 'SINCRO' "
        If Month(IniVen) <> Month(FinVen) Then
            sql = sql & "from (select * from [" & NomTaulaVentas(IniVen) & "] union all select * from  [" & NomTaulaVentas(FinVen) & "] ) v "
        Else
            sql = sql & "from [" & NomTaulaVentas(IniVen) & "] "
        End If
        sql = sql & " where Botiga=" & botiga & " and data between convert(datetime,'" & IniVen & "',103) and convert(datetime,'" & FinVen & "',103) +convert(datetime,'23:59:59',8) "
        sql = sql & " and DATEPART(hh, data)>=13 and month(dateadd(d, 7, data)) = " & Month(IniObj)
        sql = sql & " group by BOTIGA, convert(datetime, cast(day(dateadd(d,7,data)) as varchar) + '/' + cast(MONTH(dateadd(d,7,data)) as varchar) + '/' + cast(year(dateadd(d,7,data)) as varchar), 103)"
        ExecutaComandaSql sql

        'Tarda Mes 2
        sql = "insert into [" & NomTaulaObjectius(FinObj) & "] (Botiga, Data, Periode, Objectiu, Tipo) "
        sql = sql & "select botiga, convert(datetime, cast(day(dateadd(d,7,data)) as varchar) + '/' + cast(MONTH(dateadd(d,7,data)) as varchar) + '/' + cast(year(dateadd(d,7,data)) as varchar), 103), '1', SUM(import), 'SINCRO' "
        If Month(IniVen) <> Month(FinVen) Then
            sql = sql & "from (select * from [" & NomTaulaVentas(IniVen) & "] union all  select * from [" & NomTaulaVentas(FinVen) & "] ) v "
        Else
            sql = sql & "from [" & NomTaulaVentas(IniVen) & "] "
        End If
        sql = sql & " where Botiga=" & botiga & " and data between convert(datetime,'" & IniVen & "',103) and convert(datetime,'" & FinVen & "',103) +convert(datetime,'23:59:59',8) "
        sql = sql & " and DATEPART(hh, data)>=13 and month(dateadd(d, 7, data)) = " & Month(FinObj)
        sql = sql & " group by BOTIGA, convert(datetime, cast(day(dateadd(d,7,data)) as varchar) + '/' + cast(MONTH(dateadd(d,7,data)) as varchar) + '/' + cast(year(dateadd(d,7,data)) as varchar), 103)"
        ExecutaComandaSql sql
   Else
        ExecutaComandaSql "delete from [" & NomTaulaObjectius(IniObj) & "] where Botiga=" & botiga & " and (DAY(data)>=" & Day(IniObj) & " and DAY(data)<=" & Day(FinObj) & ")"
        
        'Mati
        sql = "insert into [" & NomTaulaObjectius(IniObj) & "] (Botiga, Data, Periode, Objectiu, Tipo) "
        sql = sql & "select botiga, convert(datetime, cast(day(dateadd(d,7,data)) as varchar) + '/' + cast(MONTH(dateadd(d,7,data)) as varchar) + '/' + cast(year(dateadd(d,7,data)) as varchar), 103), '0', SUM(import), 'SINCRO' "
        If Month(IniVen) <> Month(FinVen) Then
            sql = sql & "from (select * from [" & NomTaulaVentas(IniVen) & "] union all select * from [" & NomTaulaVentas(FinVen) & "] ) v "
        Else
            sql = sql & "from [" & NomTaulaVentas(IniVen) & "] "
        End If
        sql = sql & " where Botiga=" & botiga & " and data between convert(datetime,'" & IniVen & "',103) and convert(datetime,'" & FinVen & "',103) +convert(datetime,'23:59:59',8) "
        sql = sql & " and DATEPART(hh, data)<13 "
        sql = sql & "group by BOTIGA, convert(datetime, cast(day(dateadd(d,7,data)) as varchar) + '/' + cast(MONTH(dateadd(d,7,data)) as varchar) + '/' + cast(year(dateadd(d,7,data)) as varchar), 103) "
        ExecutaComandaSql sql
        
        'Tarda
        sql = "insert into [" & NomTaulaObjectius(IniObj) & "] (Botiga, Data, Periode, Objectiu, Tipo) "
        sql = sql & "select botiga, convert(datetime, cast(day(dateadd(d,7,data)) as varchar) + '/' + cast(MONTH(dateadd(d,7,data)) as varchar) + '/' + cast(year(dateadd(d,7,data)) as varchar), 103), '1', SUM(import), 'SINCRO' "
        If Month(IniVen) <> Month(FinVen) Then
            sql = sql & "from (select * from [" & NomTaulaVentas(IniVen) & "] union all select * from  [" & NomTaulaVentas(FinVen) & "] ) v "
        Else
            sql = sql & "from [" & NomTaulaVentas(IniVen) & "] "
        End If
        sql = sql & " where Botiga=" & botiga & " and data between convert(datetime,'" & IniVen & "',103) and convert(datetime,'" & FinVen & "',103) +convert(datetime,'23:59:59',8) "
        sql = sql & " and DATEPART(hh, data)>=13 "
        sql = sql & "group by BOTIGA, convert(datetime, cast(day(dateadd(d,7,data)) as varchar) + '/' + cast(MONTH(dateadd(d,7,data)) as varchar) + '/' + cast(year(dateadd(d,7,data)) as varchar), 103) "
        ExecutaComandaSql sql
    End If
   
End Sub

Sub AcumulaPunts(Dates As String, Botigues As String)
   Dim Di As Integer, Df As Integer, Mi As Integer, Mf As Integer, Ai As Integer, Af As Integer, D()   As String, m()  As String, a()  As String, Hi() As String, Hf() As String, P As Double, botiga() As String, L As String, i As Integer, k1 As Integer, k2 As Integer, k3 As Integer, dia As Date, K As Integer, Boti() As Double, ki
   ReDim D(0):   ReDim m(0):   ReDim a(0):   ReDim botiga(0): ReDim Hi(0): ReDim Hf(0)
   Informa "Calculant Punts "
   
   L = Car(Dates)
   While Len(L) > 0
      ReDim Preserve Hi(UBound(Hi) + 1)
      ReDim Preserve Hf(UBound(Hf) + 1)
      ReDim Preserve D(UBound(D) + 1)
      ReDim Preserve m(UBound(m) + 1)
      ReDim Preserve a(UBound(a) + 1)
      P = InStr(L, "-")
      D(UBound(D)) = "": a(UBound(a)) = "": m(UBound(m)) = ""
      If P > 0 Then
         D(UBound(D)) = Left(L, P - 1)
         L = Right(L, Len(L) - P)
         P = InStr(L, "-")
         If P > 0 Then
            m(UBound(m)) = Left(L, P - 1)
            L = Right(L, Len(L) - P)
            P = InStr(L, " de ")
            If P > 0 Then
               a(UBound(a)) = Left(L, P - 1)
               L = Right(L, Len(L) - P - 3)
               P = InStr(L, " a ")
               If P > 0 Then
                  Hi(UBound(Hi)) = Left(L, P - 1)
                  Hf(UBound(Hf)) = Right(L, Len(L) - P - 2)
               End If
            Else
               a(UBound(a)) = L
               Hi(UBound(Hi)) = ""
               Hf(UBound(Hf)) = ""
            End If
         End If
      End If
      L = Car(Dates)
   Wend

   L = Car(Botigues)
   While Len(L) > 0
      ReDim Preserve botiga(UBound(botiga) + 1)
      botiga(UBound(botiga)) = L
      L = Car(Botigues)
   Wend

   For i = 1 To UBound(a)
      CalculaDesdeHasta D(i), Di, Df
      CalculaDesdeHasta m(i), Mi, Mf
      CalculaDesdeHasta a(i), Ai, Af
      
      For k1 = Ai To Af
         For k2 = Mi To Mf
            dia = DateSerial(k1, k2, Di)
            If Day(dia) = Di And Month(dia) = k2 And Year(dia) = k1 Then
               For K = 1 To UBound(botiga)
                  CarregaLlistaBotigues botiga(K), Boti, Ai, Mi, Di, Df
                  For ki = 1 To UBound(Boti)
                     AcumulaPuntsBotiga Ai, Mi, Di, Df, Hi(i), Hf(i), Boti(ki)
                  Next
               Next
            End If
         Next
      Next
   Next
   
End Sub





Sub CalcularPrevisioVentesVell(a, m, D1, D2, Hi, Hf, botiga As Double, ImportFixes As Double)
   Dim rs As rdoResultset, rsP As rdoResultset, Percent As Double, AccReal As Double, AccNou As Double, Q As rdoQuery, QMin As Double, diff As Double, of As Double
   Dim bo, Da, de, Nu, Es, Pl, Qu, Im, Ti, Fo, Ot, Preu, Off As Double, dia As Date, Num_tick As Double
   Dim Spct As String, Da1 As Date, Da2 As Date, Qa As rdoQuery, P As Integer, llistaBlanca As String, NoImportaSiImpres As Boolean, offmin As Double
   
   NoImportaSiImpres = False
   llistaBlanca = CarregaLlistaBlanca()
   
   Set rsP = Db.OpenResultset("Select isnull(valor,'') valor From ConstantsEmpresa where camp='AplicarTotDPP'")
   If Not rsP.EOF Then
        If rsP("valor") = "on" Then NoImportaSiImpres = True
   End If
   If UCase(EmpresaActual) = UCase("Forn Ribera") Then NoImportaSiImpres = True
   If UCase(EmpresaActual) = UCase("Guix") Then NoImportaSiImpres = True
   If UCase(EmpresaActual) = UCase("diaz") Then NoImportaSiImpres = True
   If UCase(EmpresaActual) = UCase("Tena") Then NoImportaSiImpres = True
   If UCase(EmpresaActual) = UCase("padecava") Then NoImportaSiImpres = True
   If UCase(EmpresaActual) = UCase("ElRal") Then NoImportaSiImpres = True
   
   dia = DateSerial(a, m, D1)
   Percent = ClientCodiPercent(botiga)
   Percent = 1 - (Percent / 100)
   
   AjuntaTpvS Year(dia), Month(dia), Day(dia)
    
   'If Hi = "" Then
   Hi = "00:00"
   P = InStr(Hi, ":")
   Da1 = DateSerial(a, m, D1) + TimeSerial(Left(Hi, P - 1), Right(Hi, Len(Hi) - P), 0)
   'If Hf = "" Then
   Hf = "23:55"
   P = InStr(Hf, ":")
   Da2 = DateSerial(a, m, D2) + TimeSerial(Left(Hf, P - 1), Right(Hf, Len(Hf) - P), 0)
   
   Informa2 BotigaCodiNom(botiga) & "  " & dia & " De " & Da1 & ".." & Da2

   CreaTaulesDadesTpv dia
   If ImportFixes >= 0 Then
      Set Qa = Db.CreateQuery("", "Select Sum(Import) From [" & NomTaulaVentas(dia) & "] Where Botiga = " & botiga & " And data >= ? And data <= ? ")
      Qa.rdoParameters(0) = Da1
      Qa.rdoParameters(1) = Da2
      Set rs = Qa.OpenResultset
      If Not rs.EOF Then
         If Not IsNull(rs(0)) Then
            If rs(0) > 0 Then
               Percent = ImportFixes / rs(0)
            End If
         End If
      End If
   End If
   
   ExecutaComandaSql "CREATE INDEX [" & NomTaulaVentasPrevistes(dia) & "_BoDa]  ON [" & NomTaulaVentasPrevistes(dia) & "] ([Botiga] ASC, [Data] ASC) WITH (DATA_COMPRESSION = None)"
   Set Qa = Db.CreateQuery("", "Delete [" & NomTaulaVentasPrevistes(dia) & "] Where Botiga = " & botiga & " And Data >= ?  And data <= ?  ")
   Qa.rdoParameters(0) = Da1
   Qa.rdoParameters(1) = Da2
   Qa.Execute
   My_DoEvents
   
   If Percent = 1 Then
      ExecutaComandaSql "CREATE INDEX [" & NomTaulaVentasPrevistes(dia) & "_BoDa]  ON [" & NomTaulaVentasPrevistes(dia) & "] ([Botiga] ASC, [Data] ASC) WITH (DATA_COMPRESSION = None)"
      Set Qa = Db.CreateQuery("", "Insert Into [" & NomTaulaVentasPrevistes(dia) & "] Select * From [" & NomTaulaVentas(dia) & "] Where Botiga = " & botiga & " And data >= ? And data <= ? ")
      Qa.rdoParameters(0) = Da1
      Qa.rdoParameters(1) = Da2
      Qa.Execute
      My_DoEvents
      Informa2 BotigaCodiNom(botiga) & "  " & dia & " Tot."
      Exit Sub
   End If
   
   AccReal = 0
   AccNou = 0
   ExecutaComandaSql "CREATE INDEX [" & NomTaulaVentas(dia) & "_BoDa]  ON [" & NomTaulaVentas(dia) & "] ([Botiga] ASC, [Data] ASC) WITH (DATA_COMPRESSION = None) "
   Set Qa = Db.CreateQuery("", "Select * From [" & NomTaulaVentas(dia) & "] Where Botiga = " & botiga & " And data >= ? And data <= ? order by data,Num_tick")

   Qa.rdoParameters(0) = Da1
   Qa.rdoParameters(1) = Da2
   Set rs = Qa.OpenResultset
   Set Q = Db.CreateQuery("", "Insert Into [" & NomTaulaVentasPrevistes(dia) & "] (Botiga,Data,Dependenta,Num_tick,Estat,Plu,Quantitat,Import,Tipus_venta,FormaMarcar,Otros) Values(?,?,?,?,?,?,?,?,?,?,?) ")
   Num_tick = -1
   While Not rs.EOF
      Qu = rs("Quantitat")
      Im = rs("Import")
      AccReal = AccReal + Im
      
      'If InStr(llistaBlanca, "," & Rs("Plu") & ",") > 0 Then
'AccReal = AccReal
'      End If
      
      
      If InStr(llistaBlanca, "," & rs("Plu")) = 0 And (InStr(rs("Otros"), "[I]") = 0 Or NoImportaSiImpres) Then
         Off = 1
         offmin = Off
         If Qu <> Fix(Qu) Then Off = 0.01
         If Qu <> 0 Then
            Preu = Im / Qu
         Else
            Preu = 0
         End If
         QMin = 0.15
         If NoImportaSiImpres Or Num_tick = rs("Num_tick") Then
            QMin = 0
            offmin = 0
         End If
         '****************************************
         ' petido aqui 05/03/2012
         ' REVISAR
         ' PUESTO EL IF
         '***************************************
         If AccReal <> 0 Then
         
'Debug.Print Percent & " --> " & Round((AccNou + (Qu * Preu)) / (AccReal), 2) & " % "
        End If
                 '****************************************
         ' petido aqui 05/03/2012
         ' REVISAR
         '***************************************
         While (AccReal * Percent) < (AccNou + (Qu * Preu)) And Qu > offmin And Qu > QMin
            Qu = Qu - Off
         Wend
         If Qu < (0.01) Then Qu = 0
         Im = Round(Preu * Qu, 2)
      End If
      
      AccNou = AccNou + Im
      
      Num_tick = rs("Num_tick")
      If Qu > 0 And (Percent <> 0) Then
         Q.rdoParameters(0) = rs("Botiga")
         Q.rdoParameters(1) = rs("Data")
         Q.rdoParameters(2) = rs("Dependenta")
         Q.rdoParameters(3) = Num_tick
         Q.rdoParameters(4) = rs("Estat")
         Q.rdoParameters(5) = rs("Plu")
         Q.rdoParameters(6) = Qu
         Q.rdoParameters(7) = Im
         Q.rdoParameters(8) = rs("Tipus_venta")
         Q.rdoParameters(9) = rs("FormaMarcar")
         Q.rdoParameters(10) = rs("Otros")
         Q.Execute
      Else
         Im = Im
      End If
      
      rs.MoveNext
      My_DoEvents
   Wend
   rs.Close
   Spct = "0"
   
'   If ImportFixes > 0 Then
'      Set Qa = Db.CreateQuery("", "Select Sum(Import) From [" & NomTaulaVentasPrevistes(dia) & "] Where Botiga = " & Botiga & " And data >= ? And data <= ? ")
'      Qa.rdoParameters(0) = Da1
'      Qa.rdoParameters(1) = Da2
'      Set rs = Qa.OpenResultset
'      If Not rs.EOF Then If Not IsNull(rs(0)) Then AccNou = rs(0)
'   End If
   
   If AccNou > 0 And AccReal > 0 Then Spct = (1 - Round(AccNou / AccReal, 2))
   If ImportFixes > 0 Then
      diff = ImportFixes - AccNou
      If Abs(diff) >= 0.001 Then
         Set Qa = Db.CreateQuery("", "Select * from [" & NomTaulaVentasPrevistes(dia) & "] Where Botiga = " & botiga & " And data >= ? And data <= ? and Import > 0.02 order by import desc ")
         Qa.rdoParameters(0) = Da1
         Qa.rdoParameters(1) = Da2
         Set rs = Qa.OpenResultset
         While Not rs.EOF And Abs(diff) >= 0.001
            of = rs("Import") + diff
            If of < 0.01 Then of = 0.01
            If of > (3 * rs("Import")) Then of = (3 * rs("Import"))
            diff = diff - (of - rs("Import"))
            ExecutaComandaSql "Update [" & NomTaulaVentasPrevistes(dia) & "] Set import = " & of & " where Botiga = " & botiga & " And day(data) = " & Day(rs("Data")) & " And Num_Tick = " & rs("Num_Tick") & " And Import= " & rs("Import")
            rs.MoveNext
            My_DoEvents
         Wend
      End If
   End If

   Informa2 BotigaCodiNom(botiga) & "  " & dia & " De " & D1 & ".." & D2 & " % = " & Spct
   
End Sub

Sub CalcularPrevisioVentes(a, m, D1, D2, Hi, Hf, botiga As Double, ImportFixes As Double, Optional iva = -1)
   Dim rs As rdoResultset, rsP As rdoResultset, Percent As Double, AccReal As Double, AccNou As Double, Q As rdoQuery, QMin As Double, diff As Double, of As Double
   Dim bo, Da, de, Nu, Es, Pl, Qu, Im, Ti, Fo, Ot, Preu, Off As Double, dia As Date, Num_tick As Double
   Dim Spct As String, Da1 As Date, Da2 As Date, Qa As rdoQuery, P As Integer, llistaBlanca As String, NoImportaSiImpres As Boolean, offmin As Double
   
   NoImportaSiImpres = False
   llistaBlanca = CarregaLlistaBlanca()
   
   Set rsP = Db.OpenResultset("Select isnull(valor,'') valor From ConstantsEmpresa where camp='AplicarTotDPP'")
   If Not rsP.EOF Then
        If rsP("valor") = "on" Then NoImportaSiImpres = True
   End If
   
   If UCase(EmpresaActual) = UCase("Forn Ribera") Then NoImportaSiImpres = True
   If UCase(EmpresaActual) = UCase("Guix") Then NoImportaSiImpres = True
   If UCase(EmpresaActual) = UCase("diaz") Then NoImportaSiImpres = True
   If UCase(EmpresaActual) = UCase("Tena") Then NoImportaSiImpres = True
   If UCase(EmpresaActual) = UCase("padecava") Then NoImportaSiImpres = True
   If UCase(EmpresaActual) = UCase("ElRal") Then NoImportaSiImpres = True
      
   dia = DateSerial(a, m, D1)
   Percent = ClientCodiPercent(botiga)
   Percent = 1 - (Percent / 100)
   
   AjuntaTpvS Year(dia), Month(dia), Day(dia)
    
   'If Hi = "" Then
   Hi = "00:00"
   P = InStr(Hi, ":")
   Da1 = DateSerial(a, m, D1) + TimeSerial(Left(Hi, P - 1), Right(Hi, Len(Hi) - P), 0)
   'If Hf = "" Then
   Hf = "23:55"
   P = InStr(Hf, ":")
   Da2 = DateSerial(a, m, D2) + TimeSerial(Left(Hf, P - 1), Right(Hf, Len(Hf) - P), 0)
   
   Informa2 BotigaCodiNom(botiga) & "  " & dia & " De " & Da1 & ".." & Da2

   CreaTaulesDadesTpv dia
   If ImportFixes >= 0 Then
      If iva = -1 Then
         Set Qa = Db.CreateQuery("", "Select Sum(Import) From [" & NomTaulaVentas(dia) & "] Where Botiga = " & botiga & " And data >= ? And data <= ? ")
      Else
         Set Qa = Db.CreateQuery("", "Select Sum(Import) From [" & NomTaulaVentas(dia) & "] v join articles a on a.codi = v.plu Where Botiga = " & botiga & " And data >= ? And data <= ? and a.tipoiva = " & iva & " ")
      End If
      
      Qa.rdoParameters(0) = Da1
      Qa.rdoParameters(1) = Da2
      Set rs = Qa.OpenResultset
      If Not rs.EOF Then
         If Not IsNull(rs(0)) Then
            If rs(0) > 0 Then
               Percent = ImportFixes / rs(0)
            End If
         End If
      End If
   End If
   
   ExecutaComandaSql "CREATE INDEX [" & NomTaulaVentasPrevistes(dia) & "_BoDa]  ON [" & NomTaulaVentasPrevistes(dia) & "] ([Botiga] ASC, [Data] ASC) WITH (DATA_COMPRESSION = None)"
   If iva = -1 Or iva = 1 Then
        Set Qa = Db.CreateQuery("", "Delete [" & NomTaulaVentasPrevistes(dia) & "] Where Botiga = " & botiga & " And Data >= ?  And data <= ?  ")
   Else
        Set Qa = Db.CreateQuery("", "Delete [" & NomTaulaVentasPrevistes(dia) & "] From [" & NomTaulaVentasPrevistes(dia) & "] v join articles a on a.codi = v.plu  Where Botiga = " & botiga & " And Data >= ?  And data <= ?  and a.tipoiva = " & iva)
   End If
   Qa.rdoParameters(0) = Da1
   Qa.rdoParameters(1) = Da2
   Qa.Execute
   My_DoEvents
   
   If Percent = 1 Then
      ExecutaComandaSql "CREATE INDEX [" & NomTaulaVentasPrevistes(dia) & "_BoDa]  ON [" & NomTaulaVentasPrevistes(dia) & "] ([Botiga] ASC, [Data] ASC) WITH (DATA_COMPRESSION = None)"
      If iva = -1 Then
          Set Qa = Db.CreateQuery("", "Insert Into [" & NomTaulaVentasPrevistes(dia) & "] Select * From [" & NomTaulaVentas(dia) & "] Where Botiga = " & botiga & " And data >= ? And data <= ? ")
      Else
          Set Qa = Db.CreateQuery("", "Insert Into [" & NomTaulaVentasPrevistes(dia) & "] Select v.* From [" & NomTaulaVentas(dia) & "] v join articles a on a.codi = v.plu Where v.Botiga = " & botiga & " And data >= ? And data <= ? and a.tipoiva = " & iva)
      End If
      Qa.rdoParameters(0) = Da1
      Qa.rdoParameters(1) = Da2
      Qa.Execute
      My_DoEvents
      Informa2 BotigaCodiNom(botiga) & "  " & dia & " Tot."
      Exit Sub
   End If
   
   AccReal = 0
   AccNou = 0
   ExecutaComandaSql "CREATE INDEX [" & NomTaulaVentas(dia) & "_BoDa]  ON [" & NomTaulaVentas(dia) & "] ([Botiga] ASC, [Data] ASC) WITH (DATA_COMPRESSION = None)"
   If iva = -1 Then
        Set Qa = Db.CreateQuery("", "Select * From [" & NomTaulaVentas(dia) & "] Where Botiga = " & botiga & " And data >= ? And data <= ? order by data,Num_tick")
   Else
        Set Qa = Db.CreateQuery("", "Select * From [" & NomTaulaVentas(dia) & "]  v join articles a on a.codi = v.plu   Where Botiga = " & botiga & " And data >= ? And data <= ?   and a.tipoiva = " & iva & " order by data,Num_tick")
   End If
   
   Qa.rdoParameters(0) = Da1
   Qa.rdoParameters(1) = Da2
   Set rs = Qa.OpenResultset
   Set Q = Db.CreateQuery("", "Insert Into [" & NomTaulaVentasPrevistes(dia) & "] (Botiga,Data,Dependenta,Num_tick,Estat,Plu,Quantitat,Import,Tipus_venta,FormaMarcar,Otros) Values(?,?,?,?,?,?,?,?,?,?,?) ")
   Num_tick = -1
   While Not rs.EOF
      Qu = rs("Quantitat")
      Im = rs("Import")
      AccReal = AccReal + Im
      
      'If InStr(llistaBlanca, "," & Rs("Plu") & ",") > 0 Then
'AccReal = AccReal
'      End If
      
      
      If InStr(llistaBlanca, "," & rs("Plu")) = 0 And (InStr(rs("Otros"), "[I]") = 0 Or NoImportaSiImpres) Then
         Off = 1
         offmin = Off
         If Qu <> Fix(Qu) Then Off = 0.01
         If Qu <> 0 Then
            Preu = Im / Qu
         Else
            Preu = 0
         End If
         QMin = 0.15
         If NoImportaSiImpres Or Num_tick = rs("Num_tick") Then
            QMin = 0
            offmin = 0
         End If
         '****************************************
         ' petido aqui 05/03/2012
         ' REVISAR
         ' PUESTO EL IF
         '***************************************
         If AccReal <> 0 Then
         
'Debug.Print Percent & " --> " & Round((AccNou + (Qu * Preu)) / (AccReal), 2) & " % "
        End If
                 '****************************************
         ' petido aqui 05/03/2012
         ' REVISAR
         '***************************************
         While (AccReal * Percent) < (AccNou + (Qu * Preu)) And Qu > offmin And Qu > QMin
            Qu = Qu - Off
         Wend
         If Qu < (0.01) Then Qu = 0
         Im = Round(Preu * Qu, 2)
      End If
      
      AccNou = AccNou + Im
      
      Num_tick = rs("Num_tick")
      If Qu > 0 And (Percent <> 0) Then
         Q.rdoParameters(0) = rs("Botiga")
         Q.rdoParameters(1) = rs("Data")
         Q.rdoParameters(2) = rs("Dependenta")
         Q.rdoParameters(3) = Num_tick
         Q.rdoParameters(4) = rs("Estat")
         Q.rdoParameters(5) = rs("Plu")
         Q.rdoParameters(6) = Qu
         Q.rdoParameters(7) = Im
         Q.rdoParameters(8) = rs("Tipus_venta")
         Q.rdoParameters(9) = rs("FormaMarcar")
         Q.rdoParameters(10) = rs("Otros")
         Q.Execute
      Else
         Im = Im
      End If
      
      rs.MoveNext
      My_DoEvents
   Wend
   rs.Close
   Spct = "0"
   
'   If ImportFixes > 0 Then
'      Set Qa = Db.CreateQuery("", "Select Sum(Import) From [" & NomTaulaVentasPrevistes(dia) & "] Where Botiga = " & Botiga & " And data >= ? And data <= ? ")
'      Qa.rdoParameters(0) = Da1
'      Qa.rdoParameters(1) = Da2
'      Set rs = Qa.OpenResultset
'      If Not rs.EOF Then If Not IsNull(rs(0)) Then AccNou = rs(0)
'   End If
   
   If AccNou > 0 And AccReal > 0 Then Spct = (1 - Round(AccNou / AccReal, 2))
   If ImportFixes > 0 Then
      diff = ImportFixes - AccNou
      If Abs(diff) >= 0.001 Then
         If iva = -1 Then
            Set Qa = Db.CreateQuery("", "Select * from [" & NomTaulaVentasPrevistes(dia) & "] Where Botiga = " & botiga & " And data >= ? And data <= ? and Import > 0.02 order by import desc ")
         Else
            Set Qa = Db.CreateQuery("", "Select * from [" & NomTaulaVentasPrevistes(dia) & "] v join articles a on a.codi = v.plu  Where Botiga = " & botiga & " And data >= ? And data <= ? and Import > 0.02 and a.tipoiva = " & iva & " order by import desc ")
         End If
         Qa.rdoParameters(0) = Da1
         Qa.rdoParameters(1) = Da2
         Set rs = Qa.OpenResultset
         While Not rs.EOF And Abs(diff) >= 0.001
            of = rs("Import") + diff
            If of < 0.01 Then of = 0.01
            If of > (3 * rs("Import")) Then of = (3 * rs("Import"))
            diff = diff - (of - rs("Import"))
            ExecutaComandaSql "Update [" & NomTaulaVentasPrevistes(dia) & "] Set import = " & of & " where Botiga = " & botiga & " And day(data) = " & Day(rs("Data")) & " And Num_Tick = " & rs("Num_Tick") & "   And Plu = " & rs("Plu") & " And Import= " & rs("Import")
            rs.MoveNext
            My_DoEvents
         Wend
      End If
   End If

   Informa2 BotigaCodiNom(botiga) & "  " & dia & " De " & D1 & ".." & D2 & " % = " & Spct
   
End Sub


Sub RecalcularTiquetsPromocions(dataInici As Date, dataFi As Date, botiga As String)
    Dim rsVendesACero As rdoResultset, rsTiquet As rdoResultset, rsPromo As rdoResultset, rsVenut As rdoResultset, rsPreu As rdoResultset, rsTick As rdoResultset, rsTickPromo As rdoResultset
    Dim prodPromo1 As String, prodPromo2 As String
    Dim NumTick As String
    Dim totalImport As Double
    Dim preuReal1 As Double, preuReal2 As Double, importProd1 As Double, importProd2 As Double
    Dim dtePromo As Double
    Dim t As Integer

On Error GoTo nor

    NumTick = ""
    
    Set rsVendesACero = Db.OpenResultset("select * from [" & NomTaulaVentas(dataInici) & "] where botiga = " & botiga & " and data between convert(datetime, '" & dataInici & "', 103) and convert(datetime, '" & dataFi & "', 103) and import=0 and tipus_venta='V' order by num_tick")
    While Not rsVendesACero.EOF
        If NumTick <> rsVendesACero("num_tick") And NumTick <> "" Then
            'TRASPASAMOS AL VENUT DEFINITIVO--------------------------------------------------------------------
            ExecutaComandaSql "insert into Venut_PROMO_TMP select * from [" & NomTaulaVentas(dataInici) & "] where botiga = " & botiga & " and num_tick='" & NumTick & "'" 'COPIA, POR SI ACASO
            ExecutaComandaSql "delete from [" & NomTaulaVentas(dataInici) & "] where botiga = " & botiga & " and num_tick='" & NumTick & "'" 'BORRAMOS EL TIQUET DEL VENUT
            ExecutaComandaSql "insert into [" & NomTaulaVentas(dataInici) & "] select * from [" & NomTaulaVentasPromo(dataInici) & "] where botiga= " & botiga & " and num_tick = '" & NumTick & "'" 'INSERTAMOS EL TIQUET MODIFICADO
        End If
        
        NumTick = rsVendesACero("num_tick")
        
        'Me guardo el ticket entero
        Set rsTickPromo = Db.OpenResultset("select * from [" & NomTaulaVentasPromo(dataInici) & "] where botiga = " & botiga & " and num_tick='" & NumTick & "' and day(data)=" & Day(dataInici))
        If rsTickPromo.EOF Then
            t = 1
            Set rsTick = Db.OpenResultset("select * from [" & NomTaulaVentas(dataInici) & "] where botiga = " & botiga & " and num_tick='" & NumTick & "' and day(data)=" & Day(dataInici))
            While Not rsTick.EOF
                ExecutaComandaSql "insert into [" & NomTaulaVentasPromo(dataInici) & "] values (" & rsTick("Botiga") & ", '" & rsTick("Data") & "', " & rsTick("Dependenta") & ", " & rsTick("Num_tick") & ", '" & rsTick("Estat") & "', " & rsTick("Plu") & ", " & rsTick("Quantitat") & ", " & rsTick("import") & ", '" & rsTick("Tipus_venta") & "_" & t & "', '" & rsTick("FormaMarcar") & "', '" & rsTick("Otros") & "' )"
                t = t + 1
                rsTick.MoveNext
            Wend
        End If
        
        'Producto de la promoción que viene con precio 0
        prodPromo1 = rsVendesACero("plu")
        importProd1 = 0
        
        'If NumTick = "105387" Then
        'NumTick = NumTick
        'End If
        
        prodPromo2 = ""
        'Buscar los productos que tienen promoción con prodPromo1
        Set rsPromo = Db.OpenResultset("select * from productespromocionats where client=" & botiga & " and S_Producte<>'-1' and (D_Producte='" & prodPromo1 & "' or D_Producte='F_' + (select familia from articles where codi=" & prodPromo1 & "))")
        While Not rsPromo.EOF And prodPromo2 = ""
            'Mirar si estan en el tiquet
            If Left(rsPromo("S_Producte"), 2) = "F_" Then 'FAMILIA
                Set rsVenut = Db.OpenResultset("select * from [" & NomTaulaVentasPromo(dataInici) & "] where botiga=" & botiga & " and day(data)= " & Day(rsVendesACero("data")) & " and num_tick='" & NumTick & "' and plu in (select codi from articles where familia='" & Mid(rsPromo("S_Producte"), 3) & "') and tipus_venta<>'Promo'")
            Else
                Set rsVenut = Db.OpenResultset("select * from [" & NomTaulaVentasPromo(dataInici) & "] where botiga=" & botiga & " and day(data)=" & Day(rsVendesACero("data")) & " and num_tick='" & NumTick & "' and plu = " & rsPromo("S_Producte") & " and tipus_venta<>'Promo'")
            End If
            
            If Not rsVenut.EOF Then
                prodPromo2 = rsVenut("plu")
                totalImport = rsVenut("Import")
                
                'Producto que está a cero
                Set rsPreu = Db.OpenResultset("select isnull(te.preu, a.preu) preu from articles a left join tarifesespecials te on a.codi=te.Codi and te.tarifacodi=(select [desconte 5] from clients where codi=" & botiga & ") Where a.Codi = " & prodPromo1)
                If Not rsPreu.EOF Then preuReal1 = rsPreu("preu")
                
                'Producto que se ha llevado todo el importe de la promo
                Set rsPreu = Db.OpenResultset("select isnull(te.preu, a.preu) preu from articles a left join tarifesespecials te on a.codi=te.Codi and te.tarifacodi=(select [desconte 5] from clients where codi=" & botiga & ") Where a.Codi = " & prodPromo2)
                If Not rsPreu.EOF Then preuReal2 = rsPreu("preu")
                
                'Miramos que no coincida el precio para asegurarnos de que es este el producto promocionado (puede ser que en el mismo tiquet haya un producto que va con la promoción y otro que podría ir, pero no va)
                If preuReal2 <> totalImport Then
                    dtePromo = 1 - (totalImport / (preuReal1 + preuReal2))
                    
                    importProd1 = Round(preuReal1 - (preuReal1 * dtePromo), 2)
                    
                    importProd2 = Round(preuReal2 - (preuReal2 * dtePromo), 2)
                    
                Else
                    prodPromo2 = ""
                End If
                
            End If
            
            rsPromo.MoveNext
        Wend
                
        'Modificamos importes
        If prodPromo1 <> "" Then
            Set rsTick = Db.OpenResultset("select top 1 * from [" & NomTaulaVentasPromo(dataInici) & "] where botiga = " & botiga & " and num_tick='" & NumTick & "' and day(data)=" & Day(dataInici) & " and plu=" & prodPromo1 & " and import=0")
            ExecutaComandaSql "update [" & NomTaulaVentasPromo(dataInici) & "] set import = " & importProd1 & ", tipus_venta='Promo' where botiga = " & botiga & " and num_tick='" & NumTick & "' and day(data)=" & Day(dataInici) & " and plu=" & prodPromo1 & " and import=0 and tipus_venta = '" & rsTick("tipus_venta") & "'"
            prodPromo1 = ""
        End If
        
        If prodPromo2 <> "" Then
            Set rsTick = Db.OpenResultset("select top 1 * from [" & NomTaulaVentasPromo(dataInici) & "] where botiga = " & botiga & " and num_tick='" & NumTick & "' and day(data)=" & Day(dataInici) & " and plu=" & prodPromo2 & " and import=" & totalImport)
            ExecutaComandaSql "update [" & NomTaulaVentasPromo(dataInici) & "] set import = " & importProd2 & ", tipus_venta='Promo' where botiga = " & botiga & " and num_tick='" & NumTick & "' and day(data)=" & Day(dataInici) & " and plu=" & prodPromo2 & " and import=" & totalImport & " and tipus_venta = '" & rsTick("tipus_venta") & "'"
            prodPromo2 = ""
        End If
        
        rsVendesACero.MoveNext
    Wend
    
    If NumTick <> "" Then
        'TRASPASAMOS AL VENUT DEFINITIVO--------------------------------------------------------------------
        ExecutaComandaSql "insert into Venut_PROMO_TMP select * from [" & NomTaulaVentas(dataInici) & "] where botiga = " & botiga & " and num_tick='" & NumTick & "'" 'COPIA, POR SI ACASO
        ExecutaComandaSql "delete from [" & NomTaulaVentas(dataInici) & "] where botiga = " & botiga & " and num_tick='" & NumTick & "'" 'BORRAMOS EL TIQUET DEL VENUT
        ExecutaComandaSql "insert into [" & NomTaulaVentas(dataInici) & "] select * from [" & NomTaulaVentasPromo(dataInici) & "] where botiga= " & botiga & " and num_tick = '" & NumTick & "'" 'INSERTAMOS EL TIQUET MODIFICADO
    End If

nor:

End Sub



Sub AcumulaPuntsBotiga(a, m, D1, D2, Hi, Hf, botiga As Double)
   Dim rs As rdoResultset, Percent As Double, AccReal As Double, AccNou As Double, Q As rdoQuery, QMin As Double
   Dim bo, Da, de, Nu, Es, Pl, Qu, Im, Ti, Fo, Ot, Preu, Off As Double, dia As Date, Num_tick As Double
   Dim Spct As String, Da1 As Date, Da2 As Date, Qa As rdoQuery, P As Integer
   Dim NoImportaSiImpres As Boolean, TaulaPunts As String
   Dim offmin As Double
   
   dia = DateSerial(a, m, D1)
   If Hi = "" Then Hi = "00:00"
   P = InStr(Hi, ":")
   Da1 = DateSerial(a, m, D1) + TimeSerial(Left(Hi, P - 1), Right(Hi, Len(Hi) - P), 0)
   If Hf = "" Then Hf = "23:55"
   P = InStr(Hf, ":")
   Da2 = DateSerial(a, m, D2) + TimeSerial(Left(Hf, P - 1), Right(Hf, Len(Hf) - P), 0)
   
   Informa2 BotigaCodiNom(botiga) & "  " & dia ' & " De " & Da1 & ".." & Da2
   
   NomTaulaPunts
   CreaTaulesDadesTpv dia
   Set Qa = Db.CreateQuery("", "Delete PuntsAcumulats Where Botiga = " & botiga & " And Data >= ?  And data <= ?  ")
   Qa.rdoParameters(0) = Da1
   Qa.rdoParameters(1) = Da2
   Qa.Execute
   My_DoEvents
   
'Posem punts acumulats
'   If UCase(EmpresaActual) = UCase("enrich") Then
'      Set Qa = Db.CreateQuery("", "Insert into PuntsAcumulats (Client,Botiga,Dependenta,Num_tick,Article,Data,Import,Punts) SELECT substring(Otros,CHARINDEX('[Id:', otros)+4,CHARINDEX(']', otros,CHARINDEX('[Id:', otros))-CHARINDEX('[Id:', otros)-4) As Client ,botiga,dependenta,num_tick,Plu,data,sum(import) as Import,round(sum(import) / 0.015,0,1) as Punts From [" & NomTaulaVentas(dia) & "] Where Botiga = " & Botiga & " And data >= ? And data <= ? And otros like '%Id:CliBoti[_]2[_]%' and not otros like '%PagatPerPunts:%' group by botiga,dependenta,num_tick,Plu,data,Otros  ")
'      Qa.rdoParameters(0) = Da1
'      Qa.rdoParameters(1) = Da2
'      Set Rs = Qa.OpenResultset
'
'      Set Qa = Db.CreateQuery("", "Insert into PuntsAcumulats (Client,Botiga,Dependenta,Num_tick,Article,Data,Import,Punts) SELECT substring(Otros,CHARINDEX('[Id:', otros)+4,CHARINDEX(']', otros,CHARINDEX('[Id:', otros))-CHARINDEX('[Id:', otros)-4) As Client ,botiga,dependenta,num_tick,Plu,data,sum(import) as Import,round(sum(import) / 0.03,0,1) as Punts From [" & NomTaulaVentas(dia) & "] Where Botiga = " & Botiga & " And data >= ? And data <= ? And otros like '%Id:CliBoti_%'  And not otros like '%Id:CliBoti[_]2[_]%' and not otros like '%PagatPerPunts:%' group by botiga,dependenta,num_tick,Plu,data,Otros  ")
'      Qa.rdoParameters(0) = Da1
'      Qa.rdoParameters(1) = Da2
'      Set Rs = Qa.OpenResultset
'   Else
      Set Qa = Db.CreateQuery("", "Insert into PuntsAcumulats (Client,Botiga,Dependenta,Num_tick,Article,Data,Import,Punts) SELECT substring(Otros,CHARINDEX('[Id:', otros)+4,CHARINDEX(']', otros,CHARINDEX('[Id:', otros))-CHARINDEX('[Id:', otros)-4) As Client ,botiga,dependenta,num_tick,Plu,data,sum(import) as Import,round(sum(import) / 0.03,0,1) as Punts From [" & NomTaulaVentas(dia) & "] Where Botiga = " & botiga & " And data >= ? And data <= ? And otros like '%Id:CliBoti_%' and Tipus_venta = 'V' And not otros like '%PagatPerPunts:%' and Plu not in (select CodiArticle from ArticlesPropietats where variable='NoSumaPunts' and valor='on') group by botiga, dependenta, num_tick, Plu, data, Otros")
      Qa.rdoParameters(0) = Da1
      Qa.rdoParameters(1) = Da2
      Set rs = Qa.OpenResultset
'   End If
   
'Posem punts gastats
   Set Qa = Db.CreateQuery("", "Insert into PuntsAcumulats (Client,Botiga,Dependenta,Num_tick,Article,Data,Import,Punts) SELECT substring(Otros,CHARINDEX('[Id:', otros)+4,CHARINDEX(']', otros,CHARINDEX('[Id:', otros))-CHARINDEX('[Id:', otros)-4) As Client ,botiga,dependenta,num_tick,Plu,data,sum(import) as Import,substring(Otros,CHARINDEX('[PagatPerPunts:', otros)+15,CHARINDEX(']', otros,CHARINDEX('[PagatPerPunts:', otros))-CHARINDEX('[PagatPerPunts:', otros)-15) * -1 as Punts From [" & NomTaulaVentas(dia) & "] Where Botiga = " & botiga & " And data >= ? And data <= ? And otros like '%PagatPerPunts%' and not otros like '%PagatPerPunts:Si%' and otros like '%Id:CliBoti%'  group by botiga,dependenta,num_tick,Plu,data,Otros  ")
   Qa.rdoParameters(0) = Da1
   Qa.rdoParameters(1) = Da2
   Set rs = Qa.OpenResultset
   
   
End Sub


Function NomTaulaVentasPrevistes(data As Date) As String

   NomTaulaVentasPrevistes = "V_Venut_Previsio_" & Format(data, "yyyy-mm")

End Function



Function NomTaulaPunts() As String

   NomTaulaPunts = "PuntsAcumulats"
   
    If Not ExisteixTaula("PuntsAcumulats") Then ExecutaComandaSql "CREATE TABLE [PuntsAcumulats] ([Client] [nvarchar] (255) NULL ,[Botiga] [float],Dependenta float,Num_tick float,Article float,[Data] [datetime] NULL,Import float,Punts Float )"
    If Not ExisteixCamp("PuntsAcumulats", "Article") Then ExecutaComandaSql "Alter TABLE PuntsAcumulats Add Article float NULL "

End Function




Function ClientCodiPercent(c) As Double
   Dim rs As rdoResultset
   
   ClientCodiPercent = 0
   Set rs = Db.OpenResultset("Select [Desconte ProntoPago]  From Clients Where codi = " & c & " ")
   If Not rs.EOF Then If Not IsNull(rs(0)) Then ClientCodiPercent = rs(0)
   rs.Close
'   If ClientCodiPercent = 0 Then
'      Set Rs = Db.OpenResultset("Select [Desconte 4]  From Clients Where codi = " & c & " ")
'      If Not Rs.EOF Then If Not IsNull(Rs(0)) Then ClientCodiPercent = Rs(0)
'      Rs.Close
'   End If
'   ClientCodiPercent = 20
   
End Function



Sub CalcularComandes()
   Dim rs As rdoResultset, Di As Date, Tipus As String, client As Double
   
   If Not ExisteixTaula("ParamsComandes") Then
      ExecutaComandaSql "CREATE TABLE [ParamsComandes] ([Client] [nvarchar] (255) NULL ,[Tipus] [nvarchar] (255) NULL ,[LastData] [datetime] NULL )"
      Exit Sub
   End If
   
   Set rs = Db.OpenResultset("SELECT * FROM ParamsComandes")
   While Not rs.EOF
      Di = rs("LastData")
      Tipus = rs("Tipus")
      client = rs("Client")
      Select Case Tipus
         Case "Copia"
            While Di < Now
            Informa2 "Comandes Copia"
               CalcularComandesCopia client, Di
               Di = DateAdd("d", 1, Di)
            Wend
         Case "Previsio"
            While Di < Now
Informa2 "previsions previsio"
               CalcularComandesPrevisio client, Di
               
               Di = DateAdd("d", 1, Di)
            Wend
      End Select
      
      rs.MoveNext
   Wend
   
End Sub


Sub CalcularComandesPrevisio(client As Double, D As Date)
   Dim TaulaDesti  As String, TaulaOrigen As String, Llista As String, dd As Date
   
   D = DateAdd("d", 3, Now)
Informa2 "comandes previsio pas 1"
   CreaTaulaEstadistic D
Informa2 "Comandes previsio pas 2 "
   CreaComandaBase D, client
Informa2 "comandes previsio Ok."
   
   
End Sub



Sub CreaComandaBase(D As Date, client As Double)
   
   Dim NomTaula As String, dd As Date, NomTaulaOrigen As String, i As Integer, rs As rdoResultset
   
   NomTaula = DonamNomTaulaServit(D)
   
   ExecutaComandaSql "Delete [" & NomTaula & "] Where Client = " & client & " "
   dd = DateAdd("d", -7, D)
   NomTaulaOrigen = ""
   For i = 1 To 5
      Set rs = Db.OpenResultset("Select count(*) From [" & DonamNomTaulaServit(D) & "] Where Client = " & client & "  And TipusComanda <>3  ")
      If Not IsNull(rs(0)) Then
         If rs(0) > 0 Then
            NomTaulaOrigen = DonamNomTaulaServit(D)
            Exit For
         End If
      End If
   Next
   
   If NomTaulaOrigen = "" Then
      'ExecutaComandaSql "Insert Into [" & Nomtaula & "] (Client,CodiArticle,QuantitatDemanada,TipusComanda) Select " & Client & ",Plu,CEILING(Avg(Venut)),2 from [##TmpPrevisio] join articles on articles.codi = plu Where botiga = " & Client & " And Articles.EsSumable = 1 Group by Plu"
      ExecutaComandaSql "Insert Into [" & NomTaula & "] (Client,CodiArticle,QuantitatDemanada,TipusComanda) Select " & client & ",Plu,CEILING(Avg(Venut)),2 from [##TmpPrevisio] Where botiga = " & client & " Group by Plu"
   Else
      ExecutaComandaSql "Insert Into [" & NomTaula & "] Select * From  [" & NomTaulaOrigen & "] Where Client = " & client & " And TipusComanda <>3 "
   End If
   
End Sub



Sub CreaTaulaEstadistic(dd As Date)
   Dim TaulaDesti  As String, TaulaOrigen As String, Llista As String, D As Date, m As Double, i As Integer
   
   ExecutaComandaSql "Drop Table [##TmpPrevisio]"
   ExecutaComandaSql "CREATE TABLE [##TmpPrevisio] ([dia] [int] NULL ,[Botiga] [float] NULL ,[Plu] [float] NULL ,[venut] [float] NULL) ON [PRIMARY]"
   
   D = dd
   D = DateAdd("d", -7, D)
'   For i = 1 To 5
      ExecutaComandaSql "Insert Into [##TmpPrevisio] Select " & i & " As Dia ,Botiga,Plu,Sum(Quantitat) As Venut  From [" & NomTaulaVentas(D) & "] Where Day(Data) = " & Day(D) & " Group By Day(Data),Plu ,Botiga"
      D = DateAdd("d", -7, D)
'   Next

End Sub



Sub CalcularComandesCopia(client As Double, D As Date)
   Dim TaulaDesti  As String, TaulaOrigen As String
   
   TaulaDesti = DonamNomTaulaServit(D)
   TaulaOrigen = DonamNomTaulaServit(DateAdd("d", -7, D))
   
   ExecutaComandaSql "Insert Into [" & TaulaDesti & "] Select * From [" & TaulaOrigen & "] Where Client = " & client & "  And TipusComanda <> 3 "
   

End Sub


Function NoNull(P) As String
   If IsNull(P) Then NoNull = "" Else NoNull = P
End Function



